# Comparing `tmp/clinicadl-1.6.0.tar.gz` & `tmp/clinicadl-1.6.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "clinicadl-1.6.0.tar", max compression
+gzip compressed data, was "clinicadl-1.6.1.tar", max compression
```

## Comparing `clinicadl-1.6.0.tar` & `clinicadl-1.6.1.tar`

### file list

```diff
@@ -1,168 +1,168 @@
--rw-r--r--   0        0        0     1093 2024-02-16 17:57:24.124921 clinicadl-1.6.0/LICENSE.txt
--rwxr-xr-x   0        0        0     3737 2024-02-16 17:57:24.124921 clinicadl-1.6.0/README.md
--rw-r--r--   0        0        0      162 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/__init__.py
--rw-r--r--   0        0        0     1918 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/cmdline.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/__init__.py
--rw-r--r--   0        0        0    29596 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate.py
--rw-r--r--   0        0        0     2620 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_artifacts_cli.py
--rw-r--r--   0        0        0      922 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_cli.py
--rw-r--r--   0        0        0     1760 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_hypometabolic_cli.py
--rw-r--r--   0        0        0     1629 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_random_cli.py
--rw-r--r--   0        0        0     1697 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_shepplogan_cli.py
--rw-r--r--   0        0        0     1819 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_trivial_cli.py
--rwxr-xr-x   0        0        0     9860 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/generate/generate_utils.py
--rw-r--r--   0        0        0     7855 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/hugging_face/hugging_face.py
--rw-r--r--   0        0        0      320 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/hugging_face/hugging_face_cli.py
--rw-r--r--   0        0        0      631 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/hugging_face/pull_cli.py
--rw-r--r--   0        0        0      583 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/hugging_face/push_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/interpret/__init__.py
--rw-r--r--   0        0        0     4462 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/interpret/gradients.py
--rw-r--r--   0        0        0     3643 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/interpret/interpret.py
--rw-r--r--   0        0        0     3823 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/interpret/interpret_cli.py
--rw-r--r--   0        0        0     2816 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/mlflow_test.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/predict/__init__.py
--rw-r--r--   0        0        0     3433 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/predict/predict.py
--rw-r--r--   0        0        0     4079 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/predict/predict_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/prepare_data/__init__.py
--rw-r--r--   0        0        0     8019 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/prepare_data/prepare_data.py
--rw-r--r--   0        0        0     9236 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_cli.py
--rw-r--r--   0        0        0     9120 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_from_bids_cli.py
--rw-r--r--   0        0        0    18460 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_utils.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/__init__.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/pet_linear/__init__.py
--rw-r--r--   0        0        0     1504 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/pet_linear/cli.py
--rw-r--r--   0        0        0     4449 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/pet_linear/quality_check.py
--rw-r--r--   0        0        0     1040 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/pet_linear/utils.py
--rw-r--r--   0        0        0      747 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/qc_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_linear/__init__.py
--rwxr-xr-x   0        0        0     1835 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_linear/cli.py
--rw-r--r--   0        0        0    22989 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_linear/models.py
--rwxr-xr-x   0        0        0     5952 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_linear/quality_check.py
--rwxr-xr-x   0        0        0     8233 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_linear/utils.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_volume/__init__.py
--rw-r--r--   0        0        0      842 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_volume/cli.py
--rw-r--r--   0        0        0     1855 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_volume/quality_check.py
--rw-r--r--   0        0        0     4739 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/quality_check/t1_volume/utils.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/random_search/__init__.py
--rwxr-xr-x   0        0        0      724 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/random_search/random_search.py
--rw-r--r--   0        0        0      628 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/random_search/random_search_cli.py
--rw-r--r--   0        0        0     6590 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/random_search/random_search_utils.py
--rw-r--r--   0        0        0     1689 2024-02-16 17:57:24.124921 clinicadl-1.6.0/clinicadl/resources/config/train_config.toml
--rw-r--r--   0        0        0      101 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/resources/masks/README.md
--rwxr-xr-x   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/resources/masks/__init__.py
--rw-r--r--   0        0        0      117 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/resources/models/README.md
--rwxr-xr-x   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/resources/models/__init__.py
--rwxr-xr-x   0        0        0       25 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/__init__.py
--rw-r--r--   0        0        0     1251 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/from_json_cli.py
--rw-r--r--   0        0        0      773 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/list_models_cli.py
--rw-r--r--   0        0        0     2057 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/resume.py
--rw-r--r--   0        0        0      536 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/resume_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/tasks/__init__.py
--rw-r--r--   0        0        0     2764 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/tasks/classification_cli.py
--rw-r--r--   0        0        0     2600 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/tasks/reconstruction_cli.py
--rw-r--r--   0        0        0     2613 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/tasks/regression_cli.py
--rw-r--r--   0        0        0     5050 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/tasks/task_utils.py
--rw-r--r--   0        0        0      377 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/train.py
--rw-r--r--   0        0        0      707 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/train_cli.py
--rw-r--r--   0        0        0     6139 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/train/train_utils.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/__init__.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/adapt/__init__.py
--rw-r--r--   0        0        0     3787 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/adapt/adapt.py
--rw-r--r--   0        0        0     1136 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/adapt/adapt_cli.py
--rw-r--r--   0        0        0       44 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/analysis/__init__.py
--rw-r--r--   0        0        0     7885 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/analysis/analysis.py
--rw-r--r--   0        0        0      670 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/analysis/analysis_cli.py
--rw-r--r--   0        0        0     1247 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/cli.py
--rw-r--r--   0        0        0       60 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_labels/__init__.py
--rw-r--r--   0        0        0    15245 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_labels/get_labels.py
--rw-r--r--   0        0        0     2572 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_labels/get_labels_cli.py
--rw-r--r--   0        0        0     2601 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_labels/old_get_labels_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_metadata/__init__.py
--rw-r--r--   0        0        0     2465 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_metadata/get_metadata.py
--rw-r--r--   0        0        0      964 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_metadata/get_metadata_cli.py
--rw-r--r--   0        0        0       45 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_progression/__init__.py
--rw-r--r--   0        0        0     7525 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_progression/get_progression.py
--rw-r--r--   0        0        0      811 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/get_progression/get_progression_cli.py
--rw-r--r--   0        0        0    23300 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/getlabels/getlabels.py
--rw-r--r--   0        0        0       35 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/kfold/__init__.py
--rw-r--r--   0        0        0     6369 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/kfold/kfold.py
--rw-r--r--   0        0        0     1170 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/kfold/kfold_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/prepare_experiment/__init__.py
--rw-r--r--   0        0        0     3997 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/prepare_experiment/prepare_experiment_cli.py
--rw-r--r--   0        0        0       35 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/split/__init__.py
--rw-r--r--   0        0        0    12736 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/split/split.py
--rw-r--r--   0        0        0     2470 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/tsvtools/split/split_cli.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/__init__.py
--rw-r--r--   0        0        0     6943 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/callbacks/callbacks.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/caps_dataset/__init__.py
--rw-r--r--   0        0        0    43861 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/caps_dataset/data.py
--rw-r--r--   0        0        0       45 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cli_param/__init__.py
--rw-r--r--   0        0        0     1855 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cli_param/argument.py
--rw-r--r--   0        0        0     6369 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cli_param/option.py
--rw-r--r--   0        0        0     1030 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cli_param/option_group.py
--rw-r--r--   0        0        0    11578 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cli_param/train_option.py
--rw-r--r--   0        0        0    38726 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/clinica_utils.py
--rw-r--r--   0        0        0      264 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/cmdline_utils.py
--rw-r--r--   0        0        0      803 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/descriptors.py
--rw-r--r--   0        0        0     1264 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/early_stopping.py
--rw-r--r--   0        0        0      945 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/exceptions.py
--rw-r--r--   0        0        0     3326 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/logger.py
--rw-r--r--   0        0        0      192 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/__init__.py
--rw-r--r--   0        0        0      404 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/__init__.py
--rw-r--r--   0        0        0      293 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/__init__.py
--rw-r--r--   0        0        0     1638 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/auto_master_addr_port.py
--rw-r--r--   0        0        0     2277 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/base.py
--rw-r--r--   0        0        0     1517 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/default.py
--rw-r--r--   0        0        0     1447 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/slurm.py
--rw-r--r--   0        0        0     1584 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/torchelastic.py
--rw-r--r--   0        0        0      978 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/config.py
--rw-r--r--   0        0        0     6863 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/interface.py
--rw-r--r--   0        0        0       82 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/profiler/__init__.py
--rw-r--r--   0        0        0     2811 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/profiler/patch_kineto.py
--rw-r--r--   0        0        0     2513 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/utils.py
--rw-r--r--   0        0        0     6109 2024-02-16 17:57:24.128921 clinicadl-1.6.0/clinicadl/utils/maps_manager/ddp.py
--rw-r--r--   0        0        0    11591 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/maps_manager/iotools.py
--rw-r--r--   0        0        0     4560 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/maps_manager/logwriter.py
--rw-r--r--   0        0        0   123290 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/maps_manager/maps_manager.py
--rw-r--r--   0        0        0     8807 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/maps_manager/maps_manager_utils.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/meta_maps/__init__.py
--rw-r--r--   0        0        0     2413 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/meta_maps/getter.py
--rw-r--r--   0        0        0    17750 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/metric_module.py
--rw-r--r--   0        0        0      535 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/__init__.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/autoencoder/__init__.py
--rw-r--r--   0        0        0     4751 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/autoencoder/cnn_transformer.py
--rw-r--r--   0        0        0     2718 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/autoencoder/models.py
--rw-r--r--   0        0        0     4468 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/SECNN.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/__init__.py
--rw-r--r--   0        0        0    12962 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/models.py
--rw-r--r--   0        0        0     8632 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/random.py
--rw-r--r--   0        0        0     2394 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/resnet.py
--rw-r--r--   0        0        0     3010 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/cnn/resnet3D.py
--rw-r--r--   0        0        0     2822 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/network.py
--rw-r--r--   0        0        0     5453 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/network_utils.py
--rw-r--r--   0        0        0     8854 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/sub_network.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/unet/__init__.py
--rw-r--r--   0        0        0     3401 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/unet/unet.py
--rw-r--r--   0        0        0        0 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/__init__.py
--rw-r--r--   0        0        0     5716 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/advanced_CVAE.py
--rw-r--r--   0        0        0     2359 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/base_vae.py
--rw-r--r--   0        0        0    11673 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/convolutional_VAE.py
--rw-r--r--   0        0        0    10563 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/vae_layers.py
--rw-r--r--   0        0        0     2886 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/vae_utils.py
--rw-r--r--   0        0        0    12406 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/network/vae/vanilla_vae.py
--rw-r--r--   0        0        0     1272 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/preprocessing.py
--rw-r--r--   0        0        0     5941 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/pytorch_ssim.py
--rw-r--r--   0        0        0     3661 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/seed.py
--rw-r--r--   0        0        0       68 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/split_manager/__init__.py
--rw-r--r--   0        0        0     1229 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/split_manager/kfold.py
--rw-r--r--   0        0        0      866 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/split_manager/single_split.py
--rw-r--r--   0        0        0     9928 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/split_manager/split_manager.py
--rw-r--r--   0        0        0      142 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/task_manager/__init__.py
--rw-r--r--   0        0        0     8976 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/task_manager/classification.py
--rw-r--r--   0        0        0     6027 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/task_manager/reconstruction.py
--rw-r--r--   0        0        0     6102 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/task_manager/regression.py
--rw-r--r--   0        0        0    10711 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/task_manager/task_manager.py
--rw-r--r--   0        0        0     4685 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/tracking_exp.py
--rw-r--r--   0        0        0     9396 2024-02-16 17:57:24.132921 clinicadl-1.6.0/clinicadl/utils/tsvtools_utils.py
--rw-r--r--   0        0        0     2254 2024-02-16 17:57:24.140921 clinicadl-1.6.0/pyproject.toml
--rw-r--r--   0        0        0     5483 1970-01-01 00:00:00.000000 clinicadl-1.6.0/PKG-INFO
+-rw-r--r--   0        0        0     1093 2024-04-05 11:42:33.703864 clinicadl-1.6.1/LICENSE.txt
+-rwxr-xr-x   0        0        0     3737 2024-04-05 11:42:33.703864 clinicadl-1.6.1/README.md
+-rw-r--r--   0        0        0      162 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/__init__.py
+-rw-r--r--   0        0        0     1838 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/cmdline.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/generate/__init__.py
+-rw-r--r--   0        0        0    29926 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/generate/generate.py
+-rw-r--r--   0        0        0     2620 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/generate/generate_artifacts_cli.py
+-rw-r--r--   0        0        0      922 2024-04-05 11:42:33.703864 clinicadl-1.6.1/clinicadl/generate/generate_cli.py
+-rw-r--r--   0        0        0     1760 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/generate/generate_hypometabolic_cli.py
+-rw-r--r--   0        0        0     1629 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/generate/generate_random_cli.py
+-rw-r--r--   0        0        0     1697 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/generate/generate_shepplogan_cli.py
+-rw-r--r--   0        0        0     1819 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/generate/generate_trivial_cli.py
+-rwxr-xr-x   0        0        0     9909 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/generate/generate_utils.py
+-rw-r--r--   0        0        0     7710 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/hugging_face/hugging_face.py
+-rw-r--r--   0        0        0      320 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/hugging_face/hugging_face_cli.py
+-rw-r--r--   0        0        0      631 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/hugging_face/pull_cli.py
+-rw-r--r--   0        0        0      583 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/hugging_face/push_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/interpret/__init__.py
+-rw-r--r--   0        0        0     4484 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/interpret/gradients.py
+-rw-r--r--   0        0        0     3643 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/interpret/interpret.py
+-rw-r--r--   0        0        0     3823 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/interpret/interpret_cli.py
+-rw-r--r--   0        0        0     2816 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/mlflow_test.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/predict/__init__.py
+-rw-r--r--   0        0        0     3433 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/predict/predict.py
+-rw-r--r--   0        0        0     4079 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/predict/predict_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/prepare_data/__init__.py
+-rw-r--r--   0        0        0     8440 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/prepare_data/prepare_data.py
+-rw-r--r--   0        0        0     9236 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_cli.py
+-rw-r--r--   0        0        0     9120 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_from_bids_cli.py
+-rw-r--r--   0        0        0    18703 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_utils.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/__init__.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/pet_linear/__init__.py
+-rw-r--r--   0        0        0     1501 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/pet_linear/cli.py
+-rw-r--r--   0        0        0     4449 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/pet_linear/quality_check.py
+-rw-r--r--   0        0        0     1040 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/pet_linear/utils.py
+-rw-r--r--   0        0        0      747 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/qc_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_linear/__init__.py
+-rwxr-xr-x   0        0        0     1835 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_linear/cli.py
+-rw-r--r--   0        0        0    22991 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_linear/models.py
+-rwxr-xr-x   0        0        0     5952 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_linear/quality_check.py
+-rwxr-xr-x   0        0        0     8233 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_linear/utils.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_volume/__init__.py
+-rw-r--r--   0        0        0      842 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_volume/cli.py
+-rw-r--r--   0        0        0     1855 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_volume/quality_check.py
+-rw-r--r--   0        0        0     4739 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/quality_check/t1_volume/utils.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/random_search/__init__.py
+-rwxr-xr-x   0        0        0      724 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/random_search/random_search.py
+-rw-r--r--   0        0        0      628 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/random_search/random_search_cli.py
+-rw-r--r--   0        0        0     6422 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/random_search/random_search_utils.py
+-rw-r--r--   0        0        0     1719 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/resources/config/train_config.toml
+-rw-r--r--   0        0        0      101 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/resources/masks/README.md
+-rwxr-xr-x   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/resources/masks/__init__.py
+-rw-r--r--   0        0        0      117 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/resources/models/README.md
+-rwxr-xr-x   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/resources/models/__init__.py
+-rwxr-xr-x   0        0        0       25 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/__init__.py
+-rw-r--r--   0        0        0     1251 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/from_json_cli.py
+-rw-r--r--   0        0        0      773 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/list_models_cli.py
+-rw-r--r--   0        0        0     2057 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/resume.py
+-rw-r--r--   0        0        0      536 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/resume_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/tasks/__init__.py
+-rw-r--r--   0        0        0     2796 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/tasks/classification_cli.py
+-rw-r--r--   0        0        0     2632 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/tasks/reconstruction_cli.py
+-rw-r--r--   0        0        0     2645 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/tasks/regression_cli.py
+-rw-r--r--   0        0        0     5080 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/tasks/task_utils.py
+-rw-r--r--   0        0        0      377 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/train.py
+-rw-r--r--   0        0        0      707 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/train_cli.py
+-rw-r--r--   0        0        0     6027 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/train/train_utils.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/__init__.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/adapt/__init__.py
+-rw-r--r--   0        0        0     3787 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/adapt/adapt.py
+-rw-r--r--   0        0        0     1111 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/adapt/adapt_cli.py
+-rw-r--r--   0        0        0       44 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/analysis/__init__.py
+-rw-r--r--   0        0        0     7885 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/analysis/analysis.py
+-rw-r--r--   0        0        0      670 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/analysis/analysis_cli.py
+-rw-r--r--   0        0        0     1247 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/cli.py
+-rw-r--r--   0        0        0       60 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_labels/__init__.py
+-rw-r--r--   0        0        0    15520 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_labels/get_labels.py
+-rw-r--r--   0        0        0     2572 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_labels/get_labels_cli.py
+-rw-r--r--   0        0        0     2601 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_labels/old_get_labels_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_metadata/__init__.py
+-rw-r--r--   0        0        0     2446 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_metadata/get_metadata.py
+-rw-r--r--   0        0        0      964 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_metadata/get_metadata_cli.py
+-rw-r--r--   0        0        0       45 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_progression/__init__.py
+-rw-r--r--   0        0        0     7527 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_progression/get_progression.py
+-rw-r--r--   0        0        0      786 2024-04-05 11:42:33.707864 clinicadl-1.6.1/clinicadl/tsvtools/get_progression/get_progression_cli.py
+-rw-r--r--   0        0        0    23296 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/getlabels/getlabels.py
+-rw-r--r--   0        0        0       35 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/kfold/__init__.py
+-rw-r--r--   0        0        0     6832 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/kfold/kfold.py
+-rw-r--r--   0        0        0     1278 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/kfold/kfold_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/prepare_experiment/__init__.py
+-rw-r--r--   0        0        0     4102 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/prepare_experiment/prepare_experiment_cli.py
+-rw-r--r--   0        0        0       35 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/split/__init__.py
+-rw-r--r--   0        0        0    12658 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/split/split.py
+-rw-r--r--   0        0        0     2340 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/tsvtools/split/split_cli.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/__init__.py
+-rw-r--r--   0        0        0     6943 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/callbacks/callbacks.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/caps_dataset/__init__.py
+-rw-r--r--   0        0        0    43861 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/caps_dataset/data.py
+-rw-r--r--   0        0        0       45 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cli_param/__init__.py
+-rw-r--r--   0        0        0     1855 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cli_param/argument.py
+-rw-r--r--   0        0        0     6595 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cli_param/option.py
+-rw-r--r--   0        0        0     1029 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cli_param/option_group.py
+-rw-r--r--   0        0        0    11832 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cli_param/train_option.py
+-rw-r--r--   0        0        0    38721 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/clinica_utils.py
+-rw-r--r--   0        0        0      264 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/cmdline_utils.py
+-rw-r--r--   0        0        0      803 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/descriptors.py
+-rw-r--r--   0        0        0     1264 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/early_stopping.py
+-rw-r--r--   0        0        0      945 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/exceptions.py
+-rw-r--r--   0        0        0     3351 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/logger.py
+-rw-r--r--   0        0        0      192 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/__init__.py
+-rw-r--r--   0        0        0      404 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/__init__.py
+-rw-r--r--   0        0        0      293 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/__init__.py
+-rw-r--r--   0        0        0     1638 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/auto_master_addr_port.py
+-rw-r--r--   0        0        0     2277 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/base.py
+-rw-r--r--   0        0        0     1517 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/default.py
+-rw-r--r--   0        0        0     1447 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/slurm.py
+-rw-r--r--   0        0        0     1584 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/torchelastic.py
+-rw-r--r--   0        0        0      978 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/config.py
+-rw-r--r--   0        0        0     6863 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/interface.py
+-rw-r--r--   0        0        0       82 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/profiler/__init__.py
+-rw-r--r--   0        0        0     2811 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/profiler/patch_kineto.py
+-rw-r--r--   0        0        0     2513 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/utils.py
+-rw-r--r--   0        0        0    10180 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/ddp.py
+-rw-r--r--   0        0        0    11628 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/iotools.py
+-rw-r--r--   0        0        0     4560 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/logwriter.py
+-rw-r--r--   0        0        0   124915 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/maps_manager.py
+-rw-r--r--   0        0        0     5731 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/maps_manager/maps_manager_utils.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/meta_maps/__init__.py
+-rw-r--r--   0        0        0     2413 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/meta_maps/getter.py
+-rw-r--r--   0        0        0    17750 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/metric_module.py
+-rw-r--r--   0        0        0      535 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/__init__.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/autoencoder/__init__.py
+-rw-r--r--   0        0        0     4751 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/autoencoder/cnn_transformer.py
+-rw-r--r--   0        0        0     2718 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/autoencoder/models.py
+-rw-r--r--   0        0        0     4468 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/SECNN.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/__init__.py
+-rw-r--r--   0        0        0    12962 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/models.py
+-rw-r--r--   0        0        0     8632 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/random.py
+-rw-r--r--   0        0        0     2394 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/resnet.py
+-rw-r--r--   0        0        0     3010 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/cnn/resnet3D.py
+-rw-r--r--   0        0        0     2798 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/network.py
+-rw-r--r--   0        0        0     5453 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/network_utils.py
+-rw-r--r--   0        0        0     8884 2024-04-05 11:42:33.711864 clinicadl-1.6.1/clinicadl/utils/network/sub_network.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/unet/__init__.py
+-rw-r--r--   0        0        0     3401 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/unet/unet.py
+-rw-r--r--   0        0        0        0 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/__init__.py
+-rw-r--r--   0        0        0     5716 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/advanced_CVAE.py
+-rw-r--r--   0        0        0     2359 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/base_vae.py
+-rw-r--r--   0        0        0    11609 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/convolutional_VAE.py
+-rw-r--r--   0        0        0    10563 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/vae_layers.py
+-rw-r--r--   0        0        0     2887 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/vae_utils.py
+-rw-r--r--   0        0        0    12406 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/network/vae/vanilla_vae.py
+-rw-r--r--   0        0        0     3717 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/preprocessing.py
+-rw-r--r--   0        0        0     5941 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/pytorch_ssim.py
+-rw-r--r--   0        0        0     3661 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/seed.py
+-rw-r--r--   0        0        0       68 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/split_manager/__init__.py
+-rw-r--r--   0        0        0     1295 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/split_manager/kfold.py
+-rw-r--r--   0        0        0      932 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/split_manager/single_split.py
+-rw-r--r--   0        0        0    10215 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/split_manager/split_manager.py
+-rw-r--r--   0        0        0      142 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/task_manager/__init__.py
+-rw-r--r--   0        0        0     8929 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/task_manager/classification.py
+-rw-r--r--   0        0        0     6027 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/task_manager/reconstruction.py
+-rw-r--r--   0        0        0     6102 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/task_manager/regression.py
+-rw-r--r--   0        0        0    10869 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/task_manager/task_manager.py
+-rw-r--r--   0        0        0     4684 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/tracking_exp.py
+-rw-r--r--   0        0        0     9662 2024-04-05 11:42:33.715864 clinicadl-1.6.1/clinicadl/utils/tsvtools_utils.py
+-rw-r--r--   0        0        0     2275 2024-04-05 11:42:33.723864 clinicadl-1.6.1/pyproject.toml
+-rw-r--r--   0        0        0     5483 1970-01-01 00:00:00.000000 clinicadl-1.6.1/PKG-INFO
```

### Comparing `clinicadl-1.6.0/LICENSE.txt` & `clinicadl-1.6.1/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/README.md` & `clinicadl-1.6.1/README.md`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/cmdline.py` & `clinicadl-1.6.1/clinicadl/cmdline.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,11 +1,8 @@
 # coding: utf8
-
-from typing import List
-
 import click
 
 from clinicadl.generate.generate_cli import cli as generate_cli
 from clinicadl.hugging_face.hugging_face_cli import cli as hf_cli
 from clinicadl.interpret.interpret_cli import cli as interpret_cli
 from clinicadl.predict.predict_cli import cli as predict_cli
 from clinicadl.prepare_data.prepare_data_cli import cli as prepare_data_cli
@@ -21,16 +18,14 @@
 CONTEXT_SETTINGS = dict(
     # Extend content width to avoid shortening of pipeline help.
     max_content_width=160,
     # Display help string with -h, in addition to --help.
     help_option_names=["-h", "--help"],
 )
 
-level_list: List[str] = ["warning", "info", "debug"]
-
 
 @click.group(context_settings=CONTEXT_SETTINGS, no_args_is_help=True)
 @click.version_option()
 @click.option("-v", "--verbose", is_flag=True, help="Verbosity mode.")
 def cli(verbose):
     """ClinicaDL command line.
```

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate.py` & `clinicadl-1.6.1/clinicadl/generate/generate.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 # coding: utf8
 
 """
 This file generates data for trivial or intractable (random) data for binary classification.
 """
+
 import tarfile
-from collections import namedtuple
 from logging import getLogger
 from pathlib import Path
 from typing import Dict, List, Optional, Tuple
 
 import nibabel as nib
 import numpy as np
 import pandas as pd
@@ -66,14 +66,16 @@
     ----------
     caps_directory: Path
         Path to the (input) CAPS directory.
     output_dir: Path
         Folder containing the synthetic dataset in CAPS format.
     n_subjects: int
         Number of subjects in each class of the synthetic dataset
+    n_proc: int
+        Number of cores used during the task.
     tsv_path: Path
         Path to tsv file of list of subjects/sessions.
     mean: float
         Mean of the gaussian noise
     sigma: float
         Standard deviation of the gaussian noise
     preprocessing: str
@@ -102,15 +104,15 @@
             "n_subjects": n_subjects,
             "n_proc": n_proc,
             "mean": mean,
             "sigma": sigma,
         }
     )
 
-    SESSION_ID = "ses-M00"
+    SESSION_ID = "ses-M000"
     AGE_BL_DEFAULT = 60
     SEX_DEFAULT = "F"
 
     # Transform caps_directory in dict
     caps_dict = CapsDataset.create_caps_dict(caps_directory, multi_cohort=multi_cohort)
 
     # Read DataFrame
@@ -125,43 +127,36 @@
     cohort = data_df.loc[0, "cohort"]
 
     # Find appropriate preprocessing file type
     file_type = find_file_type(
         preprocessing, uncropped_image, tracer, suvr_reference_region
     )
 
-    image_path = Path(
-        clinicadl_file_reader(
-            [participant_id], [session_id], caps_dict[cohort], file_type
-        )[0][0]
+    image_paths = clinicadl_file_reader(
+        [participant_id], [session_id], caps_dict[cohort], file_type
     )
-    image_nii = nib.load(image_path)
+    image_nii = nib.load(image_paths[0][0])
     image = image_nii.get_fdata()
 
-    # Create output tsv file
-    participant_id_list = [f"sub-RAND{i}" for i in range(2 * n_subjects)]
-    session_id_list = ["ses-M00"] * 2 * n_subjects
-    diagnosis_list = ["AD"] * n_subjects + ["CN"] * n_subjects
-
     output_df = pd.DataFrame(
         {
-            "participant_id": participant_id_list,
-            "session_id": session_id_list,
-            "diagnosis": diagnosis_list,
+            "participant_id": [f"sub-RAND{i}" for i in range(2 * n_subjects)],
+            "session_id": [SESSION_ID] * 2 * n_subjects,
+            "diagnosis": ["AD"] * n_subjects + ["CN"] * n_subjects,
+            "age_bl": AGE_BL_DEFAULT,
+            "sex": SEX_DEFAULT,
         }
     )
 
-    output_df["age_bl"] = AGE_BL_DEFAULT
-    output_df["sex"] = SEX_DEFAULT
     output_df.to_csv(output_dir / "data.tsv", sep="\t", index=False)
 
-    input_filename = image_path.name
-    filename_pattern = "_".join(input_filename.split("_")[2::])
+    input_filename = Path(image_paths[0][0]).name
+    filename_pattern = "_".join(input_filename.split("_")[2:])
 
-    def create_random_image(subject_id):
+    def create_random_image(subject_id: int) -> None:
         gauss = np.random.normal(mean, sigma, image.shape)
         participant_id = f"sub-RAND{subject_id}"
         noisy_image = image + gauss
         noisy_image_nii = nib.Nifti1Image(
             noisy_image, header=image_nii.header, affine=image_nii.affine
         )
         noisy_image_nii_path = (
@@ -189,15 +184,15 @@
     preprocessing: str = "t1-linear",
     mask_path: Optional[Path] = None,
     atrophy_percent: float = 60,
     multi_cohort: bool = False,
     uncropped_image: bool = False,
     tracer: str = "fdg",
     suvr_reference_region: str = "pons",
-):
+) -> None:
     """
     Generates a fully separable dataset.
 
     Generates a dataset, based on the images of the CAPS directory, where a
     half of the image is processed using a mask to occlude a specific region.
     This procedure creates a dataset fully separable (images with half-right
     processed and image with half-left processed)
@@ -206,14 +201,16 @@
     ----------
     caps_directory: Path
         Path to the CAPS directory.
     output_dir: Path
         Folder containing the synthetic dataset in CAPS format.
     n_subjects: int
         Number of subjects in each class of the synthetic dataset.
+    n_proc: int
+        Number of cores used during the task.
     tsv_path: Path
         Path to tsv file of list of subjects/sessions.
     preprocessing: str
         Preprocessing performed. Must be in ['linear', 'extensive'].
     mask_path: Path
         Path to the extracted masks to generate the two labels.
     atrophy_percent: float
@@ -258,30 +255,29 @@
     if n_subjects > len(data_df):
         raise IndexError(
             f"The number of subjects {n_subjects} cannot be higher "
             f"than the number of subjects in the baseline dataset of size {len(data_df)}"
         )
 
     if mask_path is None:
-        home = Path.home()
-        cache_clinicadl = home / ".cache" / "clinicadl" / "ressources" / "masks"
+        cache_clinicadl = Path.home() / ".cache" / "clinicadl" / "ressources" / "masks"  # noqa (typo in resources)
         url_aramis = "https://aramislab.paris.inria.fr/files/data/masks/"
         FILE1 = RemoteFileStructure(
             filename="AAL2.tar.gz",
             url=url_aramis,
             checksum="89427970921674792481bffd2de095c8fbf49509d615e7e09e4bc6f0e0564471",
         )
         cache_clinicadl.mkdir(parents=True, exist_ok=True)
 
         if not (cache_clinicadl / "AAL2").is_dir():
             print("Downloading AAL2 masks...")
             try:
                 mask_path_tar = fetch_file(FILE1, cache_clinicadl)
                 tar_file = tarfile.open(mask_path_tar)
-                print("File: " + mask_path_tar)
+                print(f"File: {mask_path_tar}")
                 try:
                     tar_file.extractall(cache_clinicadl)
                     tar_file.close()
                     mask_path = cache_clinicadl / "AAL2"
                 except RuntimeError:
                     print("Unable to extract downloaded files.")
             except IOError as err:
@@ -303,15 +299,15 @@
     diagnosis_list = ["AD", "CN"]
 
     # Find appropriate preprocessing file type
     file_type = find_file_type(
         preprocessing, uncropped_image, tracer, suvr_reference_region
     )
 
-    def create_trivial_image(subject_id, output_df):
+    def create_trivial_image(subject_id: int, output_df: pd.DataFrame) -> pd.DataFrame:
         data_idx = subject_id // 2
         label = subject_id % 2
 
         participant_id = data_df.loc[data_idx, "participant_id"]
         session_id = data_df.loc[data_idx, "session_id"]
         cohort = data_df.loc[data_idx, "cohort"]
         image_path = Path(
@@ -378,26 +374,40 @@
     output_dir: Path,
     img_size: int,
     n_proc: int,
     labels_distribution: Dict[str, Tuple[float, float, float]],
     extract_json: str = None,
     samples: int = 100,
     smoothing: bool = True,
-):
+) -> None:
     """
     Creates a CAPS data set of synthetic data based on Shepp-Logan phantom.
     Source NifTi files are not extracted, but directly the slices as tensors.
 
-    Args:
-        output_dir: path to the CAPS created.
-        img_size: size of the square image.
-        labels_distribution: gives the proportions of the three subtypes (ordered in a tuple) for each label.
-        extract_json: name of the JSON file in which generation details are stored.
-        samples: number of samples generated per class.
-        smoothing: if True, an additional random smoothing is performed on top of all operations on each image.
+    Parameters
+    ----------
+    output_dir: Path
+        Path to the CAPS created.
+    img_size: int
+        Size of the square image.
+    n_proc: int
+        Number of cores used during the task.
+    labels_distribution: dictionary
+        Gives the proportions of the three subtypes (ordered in a tuple) for each label.
+    extract_json: str
+        Name of the JSON file in which generation details are stored.
+    samples: int
+        Number of samples generated per class.
+    smoothing: bool
+        If True, an additional random smoothing is performed on top of all operations on each image.
+
+    Returns
+    -------
+        Folder structure where images are stored in CAPS format.
+
     """
 
     check_and_clean(output_dir / "subjects")
     commandline_to_json(
         {
             "output_dir": output_dir,
             "img_size": img_size,
@@ -407,18 +417,20 @@
         }
     )
     columns = ["participant_id", "session_id", "diagnosis", "subtype"]
     data_df = pd.DataFrame(columns=columns)
 
     for label_id, label in enumerate(labels_distribution.keys()):
 
-        def create_shepplogan_image(subject_id, data_df):
+        def create_shepplogan_image(
+            subject_id: int, data_df: pd.DataFrame
+        ) -> pd.DataFrame:
             # for j in range(samples):
             participant_id = f"sub-CLNC{label_id}{subject_id:04d}"
-            session_id = "ses-M00"
+            session_id = "ses-M000"
             subtype = np.random.choice(
                 np.arange(len(labels_distribution[label])), p=labels_distribution[label]
             )
             row_df = pd.DataFrame(
                 [[participant_id, session_id, label, subtype]], columns=columns
             )
             data_df = pd.concat([data_df, row_df])
@@ -499,15 +511,15 @@
     n_proc: int,
     tsv_path: Optional[Path] = None,
     preprocessing: str = "pet-linear",
     pathology: str = "ad",
     anomaly_degree: float = 30,
     sigma: int = 5,
     uncropped_image: bool = False,
-):
+) -> None:
     """
     Generates a dataset, based on the images of the CAPS directory, where all
     the images are processed using a mask to generate a specific pathology.
 
     Parameters
     ----------
     caps_directory: Path
@@ -570,28 +582,28 @@
         "bvftd": "5a0ad28dff649c84761aa64f6e99da882141a56caa46675b8bf538a09fce4f81",
         "lvppa": "1099f5051c79d5b4fdae25226d97b0e92f958006f6545f498d4b600f3f8a422e",
         "nfvppa": "9512a4d4dc0003003c4c7526bf2d0ddbee65f1c79357f5819898453ef7271033",
         "pca": "ace36356b57f4db73e17c421a7cfd7ae056a1b258b8126534cf65d8d0be9527a",
         "svppa": "44f2e00bf2d2d09b532cb53e3ba61d6087b4114768cc8ae3330ea84c4b7e0e6a",
     }
     home = Path.home()
-    cache_clinicadl = home / ".cache" / "clinicadl" / "ressources" / "masks_hypo"
+    cache_clinicadl = home / ".cache" / "clinicadl" / "ressources" / "masks_hypo"  # noqa (typo in resources)
     url_aramis = "https://aramislab.paris.inria.fr/files/data/masks/hypo/"
     FILE1 = RemoteFileStructure(
         filename=f"mask_hypo_{pathology}.nii",
         url=url_aramis,
         checksum=checksum_dir[pathology],
     )
     cache_clinicadl.mkdir(parents=True, exist_ok=True)
     if not (cache_clinicadl / f"mask_hypo_{pathology}.nii").is_file():
         logger.info(f"Downloading {pathology} masks...")
         # mask_path = fetch_file(FILE1, cache_clinicadl)
         try:
             mask_path = fetch_file(FILE1, cache_clinicadl)
-        except:
+        except Exception:
             DownloadError(
                 """Unable to download masks, please download them
                 manually at https://aramislab.paris.inria.fr/files/data/masks/
                 and provide a valid path."""
             )
 
     else:
@@ -618,15 +630,17 @@
     mask = mask_resample_nii.get_fdata()
 
     mask = mask_processing(mask, anomaly_degree, sigma)
 
     # Create subjects dir
     (output_dir / "subjects").mkdir(parents=True, exist_ok=True)
 
-    def generate_hypometabolic_image(subject_id, output_df):
+    def generate_hypometabolic_image(
+        subject_id: int, output_df: pd.DataFrame
+    ) -> pd.DataFrame:
         image_path = Path(images_paths[subject_id])
         image_nii = nib.load(image_path)
         image = image_nii.get_fdata()
         if image_path.suffix == ".gz":
             input_filename = Path(image_path.stem).stem
         else:
             input_filename = image_path.stem
@@ -691,48 +705,51 @@
     gamma: List = [-0.2, -0.05],
     motion: bool = False,
     translation: List = [2, 4],
     rotation: List = [2, 4],
     num_transforms: int = 2,
     noise: bool = False,
     noise_std: List = [5, 15],
-):
+) -> None:
     """
     Generates a dataset, based on the images of the CAPS directory, where
     all the images are corrupted with a combination of motion, contrast and
     noise artefacts using torchio simulations.
-    Args:
-        caps_directory:  Path
-            Path to the CAPS directory.
-        output_dir: Path
-            Folder containing the synthetic dataset in CAPS format.
-        n_proc: int
-            Number of cores used during the task.
-        tsv_path: Path
-            Path to tsv file of list of subjects/sessions.
-        preprocessing: str
-            Preprocessing performed. Must be in ['linear', 'extensive'].
-        multi_cohort: bool
-            If True caps_directory is the path to a TSV file linking cohort names and paths.
-        uncropped_image: bool
-            If True the uncropped image of `t1-linear` or `pet-linear` will be used.
-        tracer: str
-            Name of the tracer when using `pet-linear` preprocessing.
-        suvr_reference_region: str
-            Name of the reference region when using `pet-linear` preprocessing.
-        translation: List
-            Translation range in mm of simulated movements.
-        rotation : List
-            Rotation range in degree of simulated movement.
-        num_transformes: int
-            Number of simulated movements.
-        gamma: List
-            Gamma range of simulated contrast.
-        noise_std: List
-            Stadndard deviation of simulated noise.
+
+    Parameters
+    ----------
+    caps_directory:  Path
+        Path to the CAPS directory.
+    output_dir: Path
+        Folder containing the synthetic dataset in CAPS format.
+    n_proc: int
+        Number of cores used during the task.
+    tsv_path: Path
+        Path to tsv file of list of subjects/sessions.
+    preprocessing: str
+        Preprocessing performed. Must be in ['linear', 'extensive'].
+    multi_cohort: bool
+        If True caps_directory is the path to a TSV file linking cohort names and paths.
+    uncropped_image: bool
+        If True the uncropped image of `t1-linear` or `pet-linear` will be used.
+    tracer: str
+        Name of the tracer when using `pet-linear` preprocessing.
+    suvr_reference_region: str
+        Name of the reference region when using `pet-linear` preprocessing.
+    translation: List
+        Translation range in mm of simulated movements.
+    rotation : List
+        Rotation range in degree of simulated movement.
+    num_transformes: int
+        Number of simulated movements.
+    gamma: List
+        Gamma range of simulated contrast.
+    noise_std: List
+        Stadndard deviation of simulated noise.
+
     Returns:
         Folder structure where images are stored in CAPS format.
     """
 
     commandline_to_json(
         {
             "output_dir": output_dir,
@@ -760,15 +777,15 @@
     if motion:
         artifacts_list.append("motion")
     if contrast:
         artifacts_list.append("contrast")
     if noise:
         artifacts_list.append("noise")
 
-    def create_artifacts_image(data_idx, output_df):
+    def create_artifacts_image(data_idx: int, output_df: pd.DataFrame) -> pd.DataFrame:
         participant_id = data_df.loc[data_idx, "participant_id"]
         session_id = data_df.loc[data_idx, "session_id"]
         cohort = data_df.loc[data_idx, "cohort"]
         image_path = Path(
             clinicadl_file_reader(
                 [participant_id], [session_id], caps_dict[cohort], file_type
             )[0][0]
```

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_artifacts_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_artifacts_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_hypometabolic_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_hypometabolic_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_random_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_random_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_shepplogan_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_shepplogan_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_trivial_cli.py` & `clinicadl-1.6.1/clinicadl/generate/generate_trivial_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/generate/generate_utils.py` & `clinicadl-1.6.1/clinicadl/generate/generate_utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -38,15 +38,15 @@
         raise NotImplementedError(
             f"Generation of synthetic data is not implemented for preprocessing {preprocessing}"
         )
 
     return file_type
 
 
-def write_missing_mods(output_dir: Path, output_df: pd.DataFrame):
+def write_missing_mods(output_dir: Path, output_df: pd.DataFrame) -> None:
     missing_path = output_dir / "missing_mods"
     missing_path.mkdir(parents=True, exist_ok=True)
 
     sessions = output_df.session_id.unique()
     for session in sessions:
         session_df = output_df[output_df.session_id == session]
         out_df = copy(session_df[["participant_id"]])
@@ -55,15 +55,14 @@
             missing_path / f"missing_mods_{session}.tsv", sep="\t", index=False
         )
 
 
 def load_and_check_tsv(
     tsv_path: Path, caps_dict: Dict[str, Path], output_path: Path
 ) -> pd.DataFrame:
-
     if tsv_path is not None:
         if len(caps_dict) == 1:
             df = pd.read_csv(tsv_path, sep="\t")
             if ("session_id" not in list(df.columns.values)) or (
                 "participant_id" not in list(df.columns.values)
             ):
                 raise Exception(
@@ -151,15 +150,15 @@
 
     im_with_loss_gm_roi = normal_region + gm_loss
 
     return im_with_loss_gm_roi
 
 
 # Generate SheppLogan
-def generate_scales(size):
+def generate_scales(size: str) -> tuple[float, float]:
     if size == "large":
         return random.uniform(1, 1.2), random.uniform(1, 1.2)
     elif size == "small":
         return random.uniform(0.8, 0.9), random.uniform(0.8, 0.9)
     else:
         raise NotImplementedError(
             f"Size {size} was not implemented for variable sizes."
@@ -315,12 +314,12 @@
         img = gaussian_filter(img, sigma * img_size / 100.0)  # smoothing of data
 
     img.clip(0, 1)
 
     return img
 
 
-def mask_processing(mask, percentage, sigma):
+def mask_processing(mask, percentage: float, sigma: float):
     inverse_mask = 1 - mask
     inverse_mask[inverse_mask == 0] = 1 - percentage / 100
     gaussian_mask = gaussian_filter(inverse_mask, sigma=sigma)
     return gaussian_mask
```

### Comparing `clinicadl-1.6.0/clinicadl/hugging_face/hugging_face.py` & `clinicadl-1.6.1/clinicadl/hugging_face/hugging_face.py`

 * *Files 6% similar despite different names*

```diff
@@ -3,15 +3,14 @@
 from logging import getLogger
 from pathlib import Path
 
 import toml
 
 from clinicadl.utils.exceptions import ClinicaDLArgumentError
 from clinicadl.utils.maps_manager.maps_manager_utils import (
-    change_str_to_path,
     read_json,
     remove_unused_tasks,
 )
 
 logger = getLogger("clinicadl")
 
 
@@ -104,15 +103,15 @@
             commit_message=f"Uploading {model_name} in {maps_dir}",
             repo_id=id_,
             operations=hf_operations,
             private=True,
         )
         logger.info(f"Successfully uploaded {model_name} to {maps_dir} repo in HF hub!")
 
-    except:
+    except Exception:
         from huggingface_hub import create_repo
 
         repo_name = maps_dir.name
         logger.info(f"Creating {repo_name} in the HF hub since it does not exist...")
         create_repo(repo_id=id_)
         logger.info(f"Successfully created {repo_name} in the HF hub!")
 
@@ -128,27 +127,23 @@
 
 def create_readme(
     config_file: Path = None, model_name: str = "test", model_card: str = None
 ):
     if not config_file.is_file():
         raise ClinicaDLArgumentError("There is no maps.json file in your repository.")
 
-    clinicadl_root_dir = (Path(__file__) / "../..").resolve()
-    config_path = (
-        Path(clinicadl_root_dir) / "resources" / "config" / "train_config.toml"
-    )
+    clinicadl_root_dir = Path(__file__).parents[1]
+    config_path = clinicadl_root_dir / "resources" / "config" / "train_config.toml"
     config_dict = toml.load(config_path)
 
     train_dict = read_json(config_file)
-    train_dict = change_str_to_path(train_dict)
 
     task = train_dict["network_task"]
 
     config_dict = remove_unused_tasks(config_dict, task)
-    config_dict = change_str_to_path(config_dict)
 
     file = open("tmp_README.md", "w")
     list_lines = []
     list_lines.append(model_card)
     list_lines.append(f"# Model Card for {model_name}  \n")
     list_lines.append(
         f"This model was trained with ClinicaDL. You can find here all the information.\n"
```

### Comparing `clinicadl-1.6.0/clinicadl/hugging_face/pull_cli.py` & `clinicadl-1.6.1/clinicadl/hugging_face/pull_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/hugging_face/push_cli.py` & `clinicadl-1.6.1/clinicadl/hugging_face/push_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/interpret/gradients.py` & `clinicadl-1.6.1/clinicadl/interpret/gradients.py`

 * *Files 2% similar despite different names*

```diff
@@ -10,15 +10,17 @@
     """
 
     def __init__(self, model):
         self.model = model
         self.model.eval()
         self.device = next(model.parameters()).device
 
-    def generate_gradients(self, input_batch, target_class, amp=False, **kwargs):
+    def generate_gradients(
+        self, input_batch, target_class, amp: bool = False, **kwargs
+    ):
         # Forward
         input_batch = input_batch.to(self.device)
         input_batch.requires_grad = True
         with autocast(enabled=amp):
             if hasattr(self.model, "variational") and self.model.variational:
                 _, _, _, model_output = self.model(input_batch)
             else:
```

### Comparing `clinicadl-1.6.0/clinicadl/interpret/interpret.py` & `clinicadl-1.6.1/clinicadl/interpret/interpret.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/interpret/interpret_cli.py` & `clinicadl-1.6.1/clinicadl/interpret/interpret_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/mlflow_test.py` & `clinicadl-1.6.1/clinicadl/mlflow_test.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/predict/predict.py` & `clinicadl-1.6.1/clinicadl/predict/predict.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/predict/predict_cli.py` & `clinicadl-1.6.1/clinicadl/predict/predict_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/prepare_data/prepare_data.py` & `clinicadl-1.6.1/clinicadl/prepare_data/prepare_data.py`

 * *Files 8% similar despite different names*

```diff
@@ -5,15 +5,14 @@
 def DeepLearningPrepareData(
     caps_directory: Path,
     tsv_file: Path,
     n_proc: int,
     parameters: dict,
     from_bids: str = None,
 ):
-
     from joblib import Parallel, delayed
     from torch import save as save_tensor
 
     from clinicadl.utils.clinica_utils import (
         check_caps_folder,
         clinicadl_file_reader,
         container_from_filename,
@@ -98,110 +97,119 @@
             subfolder = "image_based"
             output_mode = extract_images(Path(file))
             logger.debug(f"Image extracted.")
             write_output_imgs(output_mode, container, subfolder)
 
         Parallel(n_jobs=n_proc)(delayed(prepare_image)(file) for file in input_files)
 
-    elif parameters["prepare_dl"] and parameters["mode"] == "slice":
+    elif parameters["prepare_dl"]:
+        if parameters["mode"] == "slice":
 
-        def prepare_slice(file):
-            from .prepare_data_utils import extract_slices
+            def prepare_slice(file):
+                from .prepare_data_utils import extract_slices
 
-            logger.debug(f"  Processing of {file}.")
-            container = container_from_filename(file)
-            subfolder = "slice_based"
-            output_mode = extract_slices(
-                Path(file),
-                slice_direction=parameters["slice_direction"],
-                slice_mode=parameters["slice_mode"],
-                discarded_slices=parameters["discarded_slices"],
+                logger.debug(f"  Processing of {file}.")
+                container = container_from_filename(file)
+                subfolder = "slice_based"
+                output_mode = extract_slices(
+                    Path(file),
+                    slice_direction=parameters["slice_direction"],
+                    slice_mode=parameters["slice_mode"],
+                    discarded_slices=parameters["discarded_slices"],
+                )
+                logger.debug(f"    {len(output_mode)} slices extracted.")
+                write_output_imgs(output_mode, container, subfolder)
+
+            Parallel(n_jobs=n_proc)(
+                delayed(prepare_slice)(file) for file in input_files
             )
-            logger.debug(f"    {len(output_mode)} slices extracted.")
-            write_output_imgs(output_mode, container, subfolder)
 
-        Parallel(n_jobs=n_proc)(delayed(prepare_slice)(file) for file in input_files)
+        elif parameters["mode"] == "patch":
 
-    elif parameters["prepare_dl"] and parameters["mode"] == "patch":
+            def prepare_patch(file):
+                from .prepare_data_utils import extract_patches
 
-        def prepare_patch(file):
-            from .prepare_data_utils import extract_patches
+                logger.debug(f"  Processing of {file}.")
+                container = container_from_filename(file)
+                subfolder = "patch_based"
+                output_mode = extract_patches(
+                    Path(file),
+                    patch_size=parameters["patch_size"],
+                    stride_size=parameters["stride_size"],
+                )
+                logger.debug(f"    {len(output_mode)} patches extracted.")
+                write_output_imgs(output_mode, container, subfolder)
 
-            logger.debug(f"  Processing of {file}.")
-            container = container_from_filename(file)
-            subfolder = "patch_based"
-            output_mode = extract_patches(
-                Path(file),
-                patch_size=parameters["patch_size"],
-                stride_size=parameters["stride_size"],
+            Parallel(n_jobs=n_proc)(
+                delayed(prepare_patch)(file) for file in input_files
             )
-            logger.debug(f"    {len(output_mode)} patches extracted.")
-            write_output_imgs(output_mode, container, subfolder)
 
-        Parallel(n_jobs=n_proc)(delayed(prepare_patch)(file) for file in input_files)
+        elif parameters["mode"] == "roi":
 
-    elif parameters["prepare_dl"] and parameters["mode"] == "roi":
+            def prepare_roi(file):
+                from .prepare_data_utils import extract_roi
 
-        def prepare_roi(file):
-            from .prepare_data_utils import extract_roi
+                logger.debug(f"  Processing of {file}.")
+                container = container_from_filename(file)
+                subfolder = "roi_based"
+                if parameters["preprocessing"] == "custom":
+                    if not parameters["roi_custom_template"]:
+                        raise ClinicaDLArgumentError(
+                            "A custom template must be defined when the modality is set to custom."
+                        )
+                    parameters["roi_template"] = parameters["roi_custom_template"]
+                    parameters["roi_mask_pattern"] = parameters[
+                        "roi_custom_mask_pattern"
+                    ]
+                else:
+                    from .prepare_data_utils import PATTERN_DICT, TEMPLATE_DICT
+
+                    parameters["roi_template"] = TEMPLATE_DICT[
+                        parameters["preprocessing"]
+                    ]
+                    parameters["roi_mask_pattern"] = PATTERN_DICT[
+                        parameters["preprocessing"]
+                    ]
 
-            logger.debug(f"  Processing of {file}.")
-            container = container_from_filename(file)
-            subfolder = "roi_based"
-            if parameters["preprocessing"] == "custom":
-                if not parameters["roi_custom_template"]:
+                parameters["masks_location"] = (
+                    input_directory / "masks" / f"tpl-{parameters['roi_template']}"
+                )
+
+                if len(parameters["roi_list"]) == 0:
                     raise ClinicaDLArgumentError(
-                        "A custom template must be defined when the modality is set to custom."
+                        "A list of regions of interest must be given."
+                    )
+                else:
+                    check_mask_list(
+                        parameters["masks_location"],
+                        parameters["roi_list"],
+                        parameters["roi_mask_pattern"],
+                        (
+                            None
+                            if parameters["use_uncropped_image"] is None
+                            else not parameters["use_uncropped_image"]
+                        ),
                     )
-                parameters["roi_template"] = parameters["roi_custom_template"]
-                parameters["roi_mask_pattern"] = parameters["roi_custom_mask_pattern"]
-            else:
-                from .prepare_data_utils import PATTERN_DICT, TEMPLATE_DICT
-
-                parameters["roi_template"] = TEMPLATE_DICT[parameters["preprocessing"]]
-                parameters["roi_mask_pattern"] = PATTERN_DICT[
-                    parameters["preprocessing"]
-                ]
-
-            parameters["masks_location"] = (
-                input_directory / "masks" / f"tpl-{parameters['roi_template']}"
-            )
 
-            if len(parameters["roi_list"]) == 0:
-                raise ClinicaDLArgumentError(
-                    "A list of regions of interest must be given."
-                )
-            else:
-                check_mask_list(
-                    parameters["masks_location"],
-                    parameters["roi_list"],
-                    parameters["roi_mask_pattern"],
-                    (
+                output_mode = extract_roi(
+                    Path(file),
+                    masks_location=parameters["masks_location"],
+                    mask_pattern=parameters["roi_mask_pattern"],
+                    cropped_input=(
                         None
                         if parameters["use_uncropped_image"] is None
                         else not parameters["use_uncropped_image"]
                     ),
+                    roi_names=parameters["roi_list"],
+                    uncrop_output=parameters["uncropped_roi"],
                 )
+                logger.debug(f"    ROI extracted.")
+                write_output_imgs(output_mode, container, subfolder)
 
-            output_mode = extract_roi(
-                Path(file),
-                masks_location=parameters["masks_location"],
-                mask_pattern=parameters["roi_mask_pattern"],
-                cropped_input=(
-                    None
-                    if parameters["use_uncropped_image"] is None
-                    else not parameters["use_uncropped_image"]
-                ),
-                roi_names=parameters["roi_list"],
-                uncrop_output=parameters["uncropped_roi"],
-            )
-            logger.debug(f"    ROI extracted.")
-            write_output_imgs(output_mode, container, subfolder)
-
-        Parallel(n_jobs=n_proc)(delayed(prepare_roi)(file) for file in input_files)
+            Parallel(n_jobs=n_proc)(delayed(prepare_roi)(file) for file in input_files)
 
     else:
         raise NotImplementedError(
             f"Extraction is not implemented for mode {parameters['mode']}."
         )
 
     # Save parameters dictionary
```

### Comparing `clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_cli.py` & `clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_from_bids_cli.py` & `clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_from_bids_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/prepare_data/prepare_data_utils.py` & `clinicadl-1.6.1/clinicadl/prepare_data/prepare_data_utils.py`

 * *Files 6% similar despite different names*

```diff
@@ -48,18 +48,18 @@
         "mode": extract_method,
         "use_uncropped_image": use_uncropped_image,
         "prepare_dl": save_features,
     }
 
     if modality == "custom":
         parameters["custom_suffix"] = custom_suffix
-    if modality == "pet-linear":
+    elif modality == "pet-linear":
         parameters["tracer"] = tracer
         parameters["suvr_reference_region"] = suvr_reference_region
-    if modality == "dwi-dti":
+    elif modality == "dwi-dti":
         parameters["dti_space"] = dti_space
         parameters["dti_measure"] = dti_measure
 
     parameters["extract_json"] = compute_extract_json(extract_json)
 
     return parameters
 
@@ -347,15 +347,17 @@
 
     return [output_file]
 
 
 ############
 # ROI    #
 ############
-def check_mask_list(masks_location: Path, roi_list, mask_pattern, cropping):
+def check_mask_list(
+    masks_location: Path, roi_list: List[str], mask_pattern: str, cropping: bool
+) -> None:
     import nibabel as nib
     import numpy as np
 
     for roi in roi_list:
         roi_path, desc = find_mask_path(masks_location, roi, mask_pattern, cropping)
         if roi_path is None:
             raise FileNotFoundError(
@@ -371,21 +373,27 @@
 
 def find_mask_path(
     masks_location: Path, roi: str, mask_pattern: str, cropping: bool
 ) -> Tuple[str, str]:
     """
     Finds masks corresponding to the pattern asked and containing the adequate cropping description
 
-    Args:
-        masks_location: directory containing the masks.
-        roi: name of the region.
-        mask_pattern: pattern which should be found in the filename of the mask.
-        cropping: if True the original image should contain the substring 'desc-Crop'.
+    Parameters
+    ----------
+    masks_location: Path
+        Directory containing the masks.
+    roi: str
+        Name of the region.
+    mask_pattern: str
+        Pattern which should be found in the filename of the mask.
+    cropping: bool
+        If True the original image should contain the substring 'desc-Crop'.
 
-    Returns:
+    Returns
+    -------
         path of the mask or None if nothing was found.
         a human-friendly description of the pattern looked for.
     """
 
     # Check that pattern begins and ends with _ to avoid mixing keys
     if mask_pattern is None:
         mask_pattern = ""
@@ -406,21 +414,26 @@
 
     if len(candidates2) == 0:
         return None, desc
     else:
         return min(candidates2), desc
 
 
-def compute_output_pattern(mask_path: Path, crop_output):
+def compute_output_pattern(mask_path: Path, crop_output: bool):
     """
     Computes the output pattern of the region cropped (without the source file prefix)
-    Args:
-        mask_path: path to the masks
-        crop_output: If True the output is cropped, and the descriptor CropRoi must exist
-    Returns:
+    Parameters
+    ----------
+    mask_path: Path
+        Path to the masks
+    crop_output: bool
+        If True the output is cropped, and the descriptor CropRoi must exist
+
+    Returns
+    -------
         the output pattern
     """
 
     mask_filename = mask_path.name
     template_id = mask_filename.split("_")[0].split("-")[1]
     mask_descriptors = mask_filename.split("_")[1:-2:]
     roi_id = mask_filename.split("_")[-2].split("-")[1]
@@ -452,25 +465,35 @@
     cropped_input: bool,
     roi_names: List[str],
     uncrop_output: bool,
 ) -> List[Tuple[str, torch.Tensor]]:
     """Extracts regions of interest defined by masks
     This function extracts regions of interest from preprocessed nifti images.
     The regions are defined using binary masks that must be located in the CAPS
-    at `masks/tpl-<template>`.
-    Args:
-        nii_path: path to the NifTi input image.
-        masks_location: path to the masks
-        mask_pattern: pattern to identify the masks
-        cropped_input: if the input is cropped or not (contains desc-Crop)
-        roi_names: list of the names of the regions that will be extracted.
-        uncrop_output: if True, the final region is not cropped.
-    Returns:
-        list of tuples containing the path to the extracted ROI
-            and the tensor of the corresponding ROI.
+    at `masks/tpl-<template>`
+
+    Parameters
+    ----------
+    nii_path: Path
+        Path to the NifTi input image.
+    masks_location: Path
+        Path to the masks
+    mask_pattern: str
+        Pattern to identify the masks
+    cropped_input: bool
+        If the input is cropped or not (contains desc-Crop)
+    roi_names: List[str]
+        List of the names of the regions that will be extracted.
+    uncrop_output: bool
+        If True, the final region is not cropped.
+
+    Returns
+    -------
+    list of tuples containing the path to the extracted ROI
+        and the tensor of the corresponding ROI.
     """
     import nibabel as nib
 
     image_array = nib.load(nii_path).get_fdata(dtype="float32")
     image_tensor = torch.from_numpy(image_array).unsqueeze(0).float()
 
     roi_list = []
```

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/pet_linear/cli.py` & `clinicadl-1.6.1/clinicadl/quality_check/pet_linear/cli.py`

 * *Files 8% similar despite different names*

```diff
@@ -39,15 +39,15 @@
 ):
     """Performs quality check on pet-linear pipeline.
 
     CAPS_DIRECTORY is the CAPS folder where pet-linear outputs are stored.
 
     OUTPUT_TSV is the path to TSV output file.
 
-    ACQ_LABEL is the label given to the PET acquisition, specifying the tracer used (trc-<tracer>).
+    TRACER is the label given to the PET acquisition, specifying the tracer used (trc-<tracer>).
 
     SUVR_REFERENCE_REGION is the reference region used to perform intensity normalization {pons|cerebellumPons|pons2|cerebellumPons2}.
     """
     from .quality_check import quality_check as pet_linear_qc
 
     pet_linear_qc(
         caps_directory,
```

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/pet_linear/quality_check.py` & `clinicadl-1.6.1/clinicadl/quality_check/pet_linear/quality_check.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/pet_linear/utils.py` & `clinicadl-1.6.1/clinicadl/quality_check/pet_linear/utils.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/qc_cli.py` & `clinicadl-1.6.1/clinicadl/quality_check/qc_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_linear/cli.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_linear/cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_linear/models.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_linear/models.py`

 * *Files 1% similar despite different names*

```diff
@@ -324,15 +324,15 @@
         # first load all standard items
         own_state = self.state_dict()
         for name, param in std_model.state_dict().items():
             if name == "conv1.weight":
                 if isinstance(param, Parameter):
                     param = param.data
                 # convert to mono weight
-                # collaps parameters along second dimension, emulating grayscale feature
+                # collapse parameters along second dimension, emulating grayscale feature
                 mono_param = param.sum(1, keepdim=True)
                 if self.use_ref:
                     own_state[name].copy_(torch.cat((mono_param, mono_param), 1))
                 else:
                     own_state[name].copy_(mono_param)
                 pass
             elif (
@@ -595,15 +595,15 @@
         # first load all standard items
         own_state = self.state_dict()
         for name, param in std_model.state_dict().items():
             if name == "features.0.weight":
                 if isinstance(param, Parameter):
                     param = param.data
                 # convert to mono weight
-                # collaps parameters along second dimension, emulating grayscale feature
+                # collapse parameters along second dimension, emulating grayscale feature
                 mono_param = param.sum(1, keepdim=True)
                 if self.use_ref:
                     own_state[name].copy_(torch.cat((mono_param, mono_param), 1))
                 else:
                     own_state[name].copy_(mono_param)
                 pass
             elif name == "classifier.1.weight" or name == "classifier.1.bias":
```

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_linear/quality_check.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_linear/quality_check.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_linear/utils.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_linear/utils.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_volume/cli.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_volume/cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_volume/quality_check.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_volume/quality_check.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/quality_check/t1_volume/utils.py` & `clinicadl-1.6.1/clinicadl/quality_check/t1_volume/utils.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/random_search/random_search.py` & `clinicadl-1.6.1/clinicadl/random_search/random_search.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/random_search/random_search_cli.py` & `clinicadl-1.6.1/clinicadl/random_search/random_search_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/random_search/random_search_utils.py` & `clinicadl-1.6.1/clinicadl/random_search/random_search_utils.py`

 * *Files 5% similar despite different names*

```diff
@@ -2,16 +2,15 @@
 from pathlib import Path
 from typing import Any, Dict, Tuple
 
 import toml
 
 from clinicadl.train.train_utils import build_train_dict
 from clinicadl.utils.exceptions import ClinicaDLConfigurationError
-from clinicadl.utils.maps_manager.maps_manager_utils import change_str_to_path
-from clinicadl.utils.preprocessing import read_preprocessing
+from clinicadl.utils.preprocessing import path_decoder, read_preprocessing
 
 
 def get_space_dict(launch_directory: Path) -> Dict[str, Any]:
     """Transforms the TOML dictionary in one dimension dictionary."""
     toml_path = launch_directory / "random_search.toml"
     toml_options = toml.load(toml_path)
 
@@ -21,15 +20,15 @@
             "All random search arguments AND options must be defined in this category."
         )
 
     space_dict = dict()
     for key in toml_options["Random_Search"]:
         space_dict[key] = toml_options["Random_Search"][key]
 
-    space_dict = change_str_to_path(space_dict)
+    space_dict = path_decoder(space_dict)
     # Check presence of mandatory arguments
     mandatory_arguments = [
         "network_task",
         "tsv_path",
         "caps_directory",
         "preprocessing_json",
         "n_convblocks",
@@ -40,25 +39,19 @@
     for argument in mandatory_arguments:
         if argument not in space_dict:
             raise ClinicaDLConfigurationError(
                 f"The argument {argument} must be specified in the random_search.toml file (Random_Search category)."
             )
 
     # Default of specific options of random search
-    random_search_specific_options = {
-        "d_reduction": "MaxPooling",
-        "network_normalization": "BatchNorm",
-        "channels_limit": 512,
-        "n_conv": 1,
-        "wd_bool": True,
-    }
-
-    for option, value in random_search_specific_options.items():
-        if option not in space_dict:
-            space_dict[option] = value
+    space_dict.setdefault("d_reduction", "MaxPooling")
+    space_dict.setdefault("network_normalization", "BatchNorm")
+    space_dict.setdefault("channels_limit", 512)
+    space_dict.setdefault("n_conv", 1)
+    space_dict.setdefault("wd_bool", True)
 
     train_default = build_train_dict(toml_path, space_dict["network_task"])
 
     # Mode and preprocessing
     preprocessing_json = (
         space_dict["caps_directory"]
         / "tensor_extraction"
```

### Comparing `clinicadl-1.6.0/clinicadl/resources/config/train_config.toml` & `clinicadl-1.6.1/clinicadl/resources/config/train_config.toml`

 * *Files 3% similar despite different names*

```diff
@@ -46,26 +46,27 @@
 [Reproducibility]
 seed = 0
 deterministic = false
 compensation = "memory" # Only used if deterministic = true
 track_exp = ""
 
 [Transfer_learning]
-transfer_path = ""
+transfer_path = false
 transfer_selection_metric = "loss"
 nb_unfrozen_layer = 0
 
 [Mode]
 # require to manually generate preprocessing json
 use_extracted_features = false
 
 [Data]
 multi_cohort = false
 diagnoses = ["AD", "CN"]
 baseline = false
+valid_longitudinal = false
 normalize = true
 data_augmentation = false
 sampler = "random"
 size_reduction=false
 size_reduction_factor=2
 caps_target = ""
 tsv_target_lab = ""
```

### Comparing `clinicadl-1.6.0/clinicadl/train/from_json_cli.py` & `clinicadl-1.6.1/clinicadl/train/from_json_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/train/list_models_cli.py` & `clinicadl-1.6.1/clinicadl/train/list_models_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/train/resume.py` & `clinicadl-1.6.1/clinicadl/train/resume.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/train/resume_cli.py` & `clinicadl-1.6.1/clinicadl/train/resume_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/train/tasks/classification_cli.py` & `clinicadl-1.6.1/clinicadl/train/tasks/classification_cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -29,14 +29,15 @@
 @train_option.architecture
 @train_option.multi_network
 @train_option.ssda_network
 # Data
 @train_option.multi_cohort
 @train_option.diagnoses
 @train_option.baseline
+@train_option.valid_longitudinal
 @train_option.normalize
 @train_option.data_augmentation
 @train_option.sampler
 @train_option.caps_target
 @train_option.tsv_target_lab
 @train_option.tsv_target_unlab
 @train_option.preprocessing_dict_target
@@ -60,15 +61,15 @@
 @train_option.transfer_selection_metric
 @train_option.nb_unfrozen_layer
 # Task-related
 @train_option.label
 @train_option.selection_metrics
 @train_option.selection_threshold
 @train_option.classification_loss
-# informations
+# information
 @train_option.emissions_calculator
 def cli(**kwargs):
     """
     Train a deep learning model to learn a classification task on neuroimaging data.
 
     CAPS_DIRECTORY is the CAPS folder from where tensors will be loaded.
```

### Comparing `clinicadl-1.6.0/clinicadl/train/tasks/reconstruction_cli.py` & `clinicadl-1.6.1/clinicadl/train/tasks/reconstruction_cli.py`

 * *Files 1% similar despite different names*

```diff
@@ -29,14 +29,15 @@
 @train_option.architecture
 @train_option.multi_network
 @train_option.ssda_network
 # Data
 @train_option.multi_cohort
 @train_option.diagnoses
 @train_option.baseline
+@train_option.valid_longitudinal
 @train_option.normalize
 @train_option.data_augmentation
 @train_option.sampler
 @train_option.caps_target
 @train_option.tsv_target_lab
 @train_option.tsv_target_unlab
 @train_option.preprocessing_dict_target
@@ -58,15 +59,15 @@
 # transfer learning
 @train_option.transfer_path
 @train_option.transfer_selection_metric
 @train_option.nb_unfrozen_layer
 # Task-related
 @train_option.selection_metrics
 @train_option.reconstruction_loss
-# informations
+# information
 @train_option.emissions_calculator
 def cli(**kwargs):
     """
     Train a deep learning model to learn a reconstruction task on neuroimaging data.
 
     CAPS_DIRECTORY is the CAPS folder from where tensors will be loaded.
```

### Comparing `clinicadl-1.6.0/clinicadl/train/tasks/regression_cli.py` & `clinicadl-1.6.1/clinicadl/train/tasks/regression_cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -29,14 +29,15 @@
 @train_option.architecture
 @train_option.multi_network
 @train_option.ssda_network
 # Data
 @train_option.multi_cohort
 @train_option.diagnoses
 @train_option.baseline
+@train_option.valid_longitudinal
 @train_option.normalize
 @train_option.data_augmentation
 @train_option.sampler
 @train_option.caps_target
 @train_option.tsv_target_lab
 @train_option.tsv_target_unlab
 @train_option.preprocessing_dict_target
@@ -59,15 +60,15 @@
 @train_option.transfer_path
 @train_option.transfer_selection_metric
 @train_option.nb_unfrozen_layer
 # Task-related
 @train_option.label
 @train_option.selection_metrics
 @train_option.regression_loss
-# informations
+# information
 @train_option.emissions_calculator
 def cli(**kwargs):
     """
     Train a deep learning model to learn a regression task on neuroimaging data.
 
     CAPS_DIRECTORY is the CAPS folder from where tensors will be loaded.
```

### Comparing `clinicadl-1.6.0/clinicadl/train/tasks/task_utils.py` & `clinicadl-1.6.1/clinicadl/train/tasks/task_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -59,14 +59,15 @@
         "optimizer",
         "patience",
         "profiler",
         "tolerance",
         "track_exp",
         "transfer_path",
         "transfer_selection_metric",
+        "valid_longitudinal",
         "weight_decay",
         "sampler",
         "save_all_models",
         "seed",
         "split",
         "caps_target",
         "tsv_target_lab",
```

### Comparing `clinicadl-1.6.0/clinicadl/train/train_cli.py` & `clinicadl-1.6.1/clinicadl/train/train_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/train/train_utils.py` & `clinicadl-1.6.1/clinicadl/train/train_utils.py`

 * *Files 7% similar despite different names*

```diff
@@ -4,59 +4,55 @@
 import toml
 
 from clinicadl.utils.exceptions import (
     ClinicaDLArgumentError,
     ClinicaDLConfigurationError,
 )
 from clinicadl.utils.maps_manager.maps_manager_utils import (
-    change_str_to_path,
     read_json,
     remove_unused_tasks,
 )
+from clinicadl.utils.preprocessing import path_decoder
 
 
 def build_train_dict(config_file: Path, task: str) -> Dict[str, Any]:
     """
     Read the configuration file given by the user.
     If it is a TOML file, ensures that the format corresponds to the one in resources.
     Args:
         config_file: path to a configuration file (JSON of TOML).
         task: task learnt by the network (example: classification, regression, reconstruction...).
     Returns:
         dictionary of values ready to use for the MapsManager
     """
     if config_file is None:
         # read default values
-        clinicadl_root_dir = (Path(__file__) / "../..").resolve()
-        config_path = (
-            Path(clinicadl_root_dir) / "resources" / "config" / "train_config.toml"
-        )
+        clinicadl_root_dir = Path(__file__).parents[1]
+        config_path = clinicadl_root_dir / "resources" / "config" / "train_config.toml"
         config_dict = toml.load(config_path)
         config_dict = remove_unused_tasks(config_dict, task)
-        config_dict = change_str_to_path(config_dict)
+        config_dict = path_decoder(config_dict)
         train_dict = dict()
         # Fill train_dict from TOML files arguments
         for config_section in config_dict:
             for key in config_dict[config_section]:
                 train_dict[key] = config_dict[config_section][key]
 
     elif config_file.suffix == ".toml":
         user_dict = toml.load(config_file)
         if "Random_Search" in user_dict:
             del user_dict["Random_Search"]
 
         # read default values
-        clinicadl_root_dir = (Path(__file__) / "../..").resolve()
-        config_path = (
-            Path(clinicadl_root_dir) / "resources" / "config" / "train_config.toml"
-        )
+        clinicadl_root_dir = Path(__file__).parents[1]
+        config_path = clinicadl_root_dir / "resources" / "config" / "train_config.toml"
         config_dict = toml.load(config_path)
         # Check that TOML file has the same format as the one in clinicadl/resources/config/train_config.toml
         if user_dict is not None:
-            user_dict = change_str_to_path(user_dict)
+            user_dict = path_decoder(user_dict)
             for section_name in user_dict:
                 if section_name not in config_dict:
                     raise ClinicaDLConfigurationError(
                         f"{section_name} section is not valid in TOML configuration file. "
                         f"Please see the documentation to see the list of option in TOML configuration file."
                     )
                 for key in user_dict[section_name]:
@@ -75,15 +71,14 @@
         # Fill train_dict from TOML files arguments
         for config_section in config_dict:
             for key in config_dict[config_section]:
                 train_dict[key] = config_dict[config_section][key]
 
     elif config_file.suffix == ".json":
         train_dict = read_json(config_file)
-        train_dict = change_str_to_path(train_dict)
 
     else:
         raise ClinicaDLConfigurationError(
             f"config_file {config_file} should be a TOML or a JSON file."
         )
     return train_dict
 
@@ -128,15 +123,15 @@
         if dimension == "2D":
             shape_str = "C@HxW,"
         elif dimension == "3D":
             shape_str = "C@DxHxW,"
         elif dimension == "2D or 3D":
             shape_str = "C@HxW or C@DxHxW,"
 
-        shape_str = f"\n\tThe input must be in the shape {shape_str}".expandtabs(4)
+        shape_str = f"\n\t The input must be in the shape {shape_str}".expandtabs(4)
         input_size_str = f" for example input_size can be {input_size}."
 
         task_str = f"\n\tThis model can be used for {' or '.join(model_class.get_task())}.\n".expandtabs(
             4
         )
 
         print(
@@ -145,18 +140,18 @@
             + dimension_str
             + shape_str
             + input_size_str
             + task_str
         )
 
         if model_layers:
-            chanel, shape_list = input_size.split("@")
+            channel, shape_list = input_size.split("@")
             args.remove("self")
             kwargs = dict()
-            kwargs["input_size"] = [int(chanel)] + [
+            kwargs["input_size"] = [int(channel)] + [
                 int(x) for x in shape_list.split("x")
             ]
             kwargs["gpu"] = False
 
             model = model_class(**kwargs)
 
             print(f"Input size: {input_size}")
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/adapt/adapt.py` & `clinicadl-1.6.1/clinicadl/tsvtools/adapt/adapt.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/adapt/adapt_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/adapt/adapt_cli.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,9 +1,7 @@
-from typing import List
-
 import click
 
 from clinicadl.utils import cli_param
 
 
 @click.command(name="adapt", no_args_is_help=True)
 @cli_param.argument.old_tsv_dir
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/analysis/analysis.py` & `clinicadl-1.6.1/clinicadl/tsvtools/analysis/analysis.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/analysis/analysis_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/analysis/analysis_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_labels/get_labels.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_labels/get_labels.py`

 * *Files 2% similar despite different names*

```diff
@@ -6,14 +6,15 @@
  - clinica iotools check-missing-modalities
 To download Clinica follow the instructions at http://www.clinica.run/doc/#installation
 
 NB: Other preprocessing may be needed on the merged file obtained: for example the selection of subjects older than 62
 in the OASIS dataset is not done in this script. Moreover a quality check may be needed at the end of preprocessing
 pipelines, leading to the removal of some subjects.
 """
+
 from copy import copy
 from logging import getLogger
 from pathlib import Path
 from typing import Dict, List
 
 import numpy as np
 import pandas as pd
@@ -35,68 +36,59 @@
     """
     Deduce the diagnosis when missing from previous and following sessions of the subject. If not identical, the session
     is dropped. Sessions with no diagnosis are also dropped when there are the last sessions of the follow-up.
 
     Parameters
     ----------
     bids_df: DataFrame
-        Columns including ['participant_id', 'session_id', 'diagnosis'].
+        Columns including ['participant_id', 'session_index', 'diagnosis'].
 
     Returns
     -------
     bids_copy_df: DataFrame
         Cleaned copy of the input bids_df.
     """
     bids_copy_df = copy(bids_df)
     found_diag_interpol = 0
     nb_drop = 0
 
     for subject, subject_df in bids_df.groupby(level=0):
-        session_list = []
-        for _, session in subject_df.index.values:
-            x = session[5::]
-            if not x.isdigit():
-                subject_df.drop((subject, session), axis=0, inplace=True)
-                bids_copy_df.drop((subject, session), axis=0, inplace=True)
-                nb_drop += 1
-
         session_list = [session for _, session in subject_df.index.values]
 
         for _, session in subject_df.index.values:
             diagnosis = subject_df.loc[(subject, session), "diagnosis"]
-            session_nb = session
 
             if isinstance(diagnosis, float):
                 if session == last_session(session_list):
                     bids_copy_df.drop(index=(_, session), axis=0, inplace=True)
                     nb_drop += 1
                 else:
-                    prev_session = neighbour_session(session_nb, session_list, -1)
+                    prev_session = neighbour_session(session, session_list, -1)
                     prev_diagnosis = bids_df.loc[(subject, prev_session), "diagnosis"]
                     while isinstance(
                         prev_diagnosis, float
                     ) and prev_session != first_session(subject_df):
                         prev_session = neighbour_session(prev_session, session_list, -1)
                         prev_diagnosis = bids_df.loc[
                             (subject, prev_session), "diagnosis"
                         ]
-                    post_session = neighbour_session(session_nb, session_list, +1)
+                    post_session = neighbour_session(session, session_list, +1)
                     post_diagnosis = bids_df.loc[(subject, post_session), "diagnosis"]
                     while isinstance(
                         post_diagnosis, float
                     ) and post_session != last_session(session_list):
                         post_session = neighbour_session(post_session, session_list, +1)
                         post_diagnosis = bids_df.loc[
                             (subject, post_session), "diagnosis"
                         ]
                     if prev_diagnosis == post_diagnosis:
                         found_diag_interpol += 1
-                        bids_copy_df.loc[(subject, session), "diagnosis"] = (
-                            prev_diagnosis
-                        )
+                        bids_copy_df.loc[
+                            (subject, session), "diagnosis"
+                        ] = prev_diagnosis
                     else:
                         bids_copy_df.drop((subject, session), inplace=True)
                         nb_drop += 1
 
     logger.info(f"Inferred diagnosis: {found_diag_interpol}")
     logger.info(f"Dropped subjects (inferred diagnosis): {nb_drop}")
 
@@ -124,15 +116,17 @@
         Cleaned copy of the input bids_df
     """
     bids_copy_df = copy(bids_df)
     nb_subjects = 0
     if mod is not None:
         for subject, session in bids_df.index.values:
             try:
-                mod_present = missing_mods_dict[session].loc[subject, mod]
+                mod_present = missing_mods_dict[
+                    bids_copy_df.loc[(subject, session), "session_id"]
+                ].loc[subject, mod]
                 if not mod_present:
                     bids_copy_df.drop((subject, session), inplace=True)
                     nb_subjects += 1
             except KeyError:
                 bids_copy_df.drop((subject, session), inplace=True)
                 nb_subjects += 1
     logger.info(f"Dropped sessions (mod selection): {nb_subjects}")
@@ -221,15 +215,18 @@
     nb_subjects = 0
     if restriction_path is not None:
         restriction_df = pd.read_csv(restriction_path, sep="\t")
 
         for subject, session in bids_df.index.values:
             subject_qc_df = restriction_df[
                 (restriction_df.participant_id == subject)
-                & (restriction_df.session_id == session)
+                & (
+                    restriction_df.session_id
+                    == bids_copy_df.loc[(subject, session), "session_id"]
+                )
             ]
             if len(subject_qc_df) != 1:
                 bids_copy_df.drop((subject, session), inplace=True)
                 nb_subjects += 1
     logger.info(f"Dropped subjects (apply restriction): {nb_subjects}")
     return bids_copy_df
 
@@ -320,23 +317,34 @@
             logger.warning(
                 f"A merged_tsv file already exists at {merged_tsv}. It will be used to run the command."
             )
         else:
             raise ValueError(
                 "We can't find any merged tsv files, please give another path."
             )
-
-    logger.info(f"output of clinica iotools merge-tsv: {merged_tsv}")
-
-    # Reading files
-    if not merged_tsv.is_file():
+    elif not merged_tsv.is_file():
         raise ClinicaDLTSVError(f"{merged_tsv} file was not found. ")
+
     bids_df = pd.read_csv(merged_tsv, sep="\t", low_memory=False)
-    bids_df.set_index(["participant_id", "session_id"], inplace=True)
-    variables_list = []
+
+    nb_drop_bad_session = 0
+    for index, row in bids_df.iterrows():
+        if not row["session_id"].startswith("ses-M"):
+            bids_df.drop(index, axis=0, inplace=True)
+            nb_drop_bad_session += 1
+    logger.info(
+        f"Dropped subjects (bad session name, example ses-Nv): {nb_drop_bad_session}"
+    )
+
+    bids_df["session_index"] = (
+        bids_df["session_id"].str.replace("ses-M", "").astype("int")
+    )
+
+    bids_df.set_index(["participant_id", "session_index"], inplace=True)
+    variables_list = ["session_id"]
 
     if "dx1" in bids_df.columns:
         bids_df.rename(columns={"dx1": "diagnosis"}, inplace=True)
 
     try:
         variables_list.append(find_label(bids_df.columns.values, "age"))
         variables_list.append(find_label(bids_df.columns.values, "sex"))
@@ -399,18 +407,20 @@
     variables_list.append("baseline_diagnosis")
 
     bids_df = bids_df[variables_list]
     if remove_unique_session_:
         bids_df = remove_unique_session(bids_df)
 
     variables_list.remove("baseline_diagnosis")
+
     output_df = bids_df[variables_list]
     output_df = infer_or_drop_diagnosis(output_df)
     output_df = diagnosis_removal(output_df, diagnoses)
     output_df = mod_selection(output_df, missing_mods_dict, modality)
     output_df = apply_restriction(output_df, restriction_path)
 
-    output_df.reset_index()
-    output_df.sort_values(by=["participant_id", "session_id"], inplace=True)
-    output_df.to_csv(output_tsv, sep="\t")
+    output_df.reset_index(inplace=True)
+    output_df.sort_values(by=["participant_id", "session_index"], inplace=True)
+    output_df.drop("session_index", axis=1, inplace=True)
+    output_df.to_csv(output_tsv, sep="\t", index=False)
 
     logger.info(f"Results are stored in {output_dir}.")
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_labels/get_labels_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_labels/get_labels_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_labels/old_get_labels_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_labels/old_get_labels_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_metadata/get_metadata.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_metadata/get_metadata.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from logging import getLogger
 from pathlib import Path
 
 import numpy as np
 import pandas as pd
 
-from clinicadl.utils.exceptions import ClinicaDLArgumentError, ClinicaDLTSVError
+from clinicadl.utils.exceptions import ClinicaDLArgumentError
 from clinicadl.utils.tsvtools_utils import merged_tsv_reader
 
 logger = getLogger("clinicadl.tsvtools.get_metadata")
 
 
 def get_metadata(
     data_tsv: Path, merged_tsv: Path, variables_of_interest=None
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_metadata/get_metadata_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_metadata/get_metadata_cli.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_progression/get_progression.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_progression/get_progression.py`

 * *Files 1% similar despite different names*

```diff
@@ -23,19 +23,19 @@
     """
     A method to get the progression for each sessions, depending on their stability on the time horizon
     Outputs are written in data_tsv
 
     Parameters
     ----------
     data_tsv: str (path)
-        Path to a tsv file with columns including ["participants_id", "session_id", "dignosis"]
+        Path to a tsv file with columns including ["participants_id", "session_id", "diagnosis"]
     horizon_time: int
         Time horizon in months
     stability_dict: dict
-        Dictionnary explaining the progression of the disease. If None, it uses the Alzheimer's one : {CN: 0, MCI: 1, AD: 2}
+        Dictionary explaining the progression of the disease. If None, it uses the Alzheimer's one : {CN: 0, MCI: 1, AD: 2}
 
     """
 
     # Reading files
     bids_df = merged_tsv_reader(data_tsv)
 
     if "diagnosis" not in bids_df.columns:
@@ -52,15 +52,15 @@
             )
         if "dx1" in bids_df.columns:
             bids_df.rename(columns={"dx1": "diagnosis"}, inplace=True)
 
     bids_df.set_index(["participant_id", "session_id"], inplace=True)
     bids_df = infer_or_drop_diagnosis(bids_df)
 
-    # Check possible double change in diagnosis in time or if ther is only one session for a subject
+    # Check possible double change in diagnosis in time or if there is only one session for a subject
     # This subjects were removed in the old getlabels.
     # We can add an option to remove them, or remove them all the time or never remove them
     # We can also give two file.stv, one with unknown and unstable subjects and one without
 
     stability_dict = {"CN": 0, "MCI": 1, "AD": 2, "Dementia": 2}
     nb_subjects = 0
     # if "group" is in bids_df.columns.values :
@@ -114,15 +114,15 @@
                 if last_diagnosis_dict > diagnosis_dict:
                     update_diagnosis = "p"
                 elif last_diagnosis_dict < diagnosis_dict:
                     update_diagnosis = "r"
                 elif last_diagnosis_dict == diagnosis_dict:
                     update_diagnosis = "s"
 
-            # CASE 3 : if the session after 'horizon_time' months doesn't exist but ther are sessions before and after this time.
+            # CASE 3 : if the session after 'horizon_time' months doesn't exist but there are sessions before and after this time.
             else:
                 prev_session = neighbour_session(horizon_session, session_list, -1)
                 post_session = neighbour_session(horizon_session, session_list, +1)
 
                 prev_diagnosis = subject_df.loc[(subject, prev_session), "diagnosis"]
                 prev_diagnosis_dict = stability_dict[prev_diagnosis]
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/get_progression/get_progression_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/get_progression/get_progression_cli.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,9 +1,7 @@
-from typing import List
-
 import click
 
 from clinicadl.utils import cli_param
 
 
 @click.command(name="get-progression", no_args_is_help=True)
 @cli_param.argument.data_tsv
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/getlabels/getlabels.py` & `clinicadl-1.6.1/clinicadl/tsvtools/getlabels/getlabels.py`

 * *Files 1% similar despite different names*

```diff
@@ -6,14 +6,15 @@
  - clinica iotools check-missing-modalities
 To download Clinica follow the instructions at http://www.clinica.run/doc/#installation
 
 NB: Other preprocessing may be needed on the merged file obtained: for example the selection of subjects older than 62
 in the OASIS dataset is not done in this script. Moreover a quality check may be needed at the end of preprocessing
 pipelines, leading to the removal of some subjects.
 """
+
 import os
 from copy import copy
 from logging import getLogger
 from os import path
 from typing import Dict, List
 
 import numpy as np
@@ -133,17 +134,17 @@
                             int(post_session[5::]), session_list, +1
                         )
                         post_diagnosis = bids_df.loc[
                             (subject, post_session), "diagnosis"
                         ]
                     if prev_diagnosis == post_diagnosis:
                         found_diag_interpol += 1
-                        bids_copy_df.loc[(subject, session), "diagnosis"] = (
-                            prev_diagnosis
-                        )
+                        bids_copy_df.loc[
+                            (subject, session), "diagnosis"
+                        ] = prev_diagnosis
                     else:
                         bids_copy_df.drop((subject, session), inplace=True)
 
     logger.debug(f"Inferred diagnosis: {found_diag_interpol}")
 
     return bids_copy_df
 
@@ -193,15 +194,15 @@
 
     # Drop if not stable
     bids_copy_df = copy(bids_df)
     n_subjects = 0
     for subject, subject_df in bids_df.groupby(level=0):
         subject_drop = False
         try:
-            diagnosis_bl = subject_df.loc[(subject, "ses-M00"), "baseline_diagnosis"]
+            diagnosis_bl = subject_df.loc[(subject, "ses-M000"), "baseline_diagnosis"]
         except KeyError:
             raise KeyError(
                 f"The baseline session is necessary for labels selection. It is missing for subject {subject}."
             )
         diagnosis_values = subject_df.diagnosis.values
         for diagnosis in diagnosis_values:
             if not isinstance(diagnosis, float):
@@ -303,17 +304,17 @@
                             (subject, last_session(session_list)), "diagnosis"
                         ]
                         # This section must be discussed --> removed in Jorge's paper
                         if last_diagnosis != "MCI":
                             update_diagnosis = stability_dict[last_diagnosis] + "MCI"
                         else:
                             update_diagnosis = "uMCI"
-                        bids_copy_df.loc[(subject, session), "diagnosis"] = (
-                            update_diagnosis
-                        )
+                        bids_copy_df.loc[
+                            (subject, session), "diagnosis"
+                        ] = update_diagnosis
 
                     else:
                         prev_session = neighbour_session(
                             horizon_session_nb, session_list, -1
                         )
                         post_session = neighbour_session(
                             horizon_session_nb, session_list, +1
@@ -327,17 +328,17 @@
                             post_diagnosis = subject_df.loc[
                                 (subject, post_session), "diagnosis"
                             ]
                             if post_diagnosis != "MCI":
                                 update_diagnosis = "uMCI"
                             else:
                                 update_diagnosis = "sMCI"
-                        bids_copy_df.loc[(subject, session), "diagnosis"] = (
-                            update_diagnosis
-                        )
+                        bids_copy_df.loc[
+                            (subject, session), "diagnosis"
+                        ] = update_diagnosis
 
     return bids_copy_df
 
 
 def diagnosis_removal(MCI_df: pd.DataFrame, diagnosis_list: List[str]) -> pd.DataFrame:
     """
     Removes subjects whom last diagnosis is in the list provided (avoid to keep rMCI and pMCI in sMCI lists).
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/kfold/kfold.py` & `clinicadl-1.6.1/clinicadl/tsvtools/kfold/kfold.py`

 * *Files 5% similar despite different names*

```diff
@@ -17,14 +17,15 @@
 
 def write_splits(
     diagnosis_df: pd.DataFrame,
     split_label: str,
     n_splits: int,
     subset_name: str,
     results_directory: Path,
+    valid_longitudinal: bool = False,
 ):
     """
     Split data at the subject-level in training and test to have equivalent distributions in split_label.
     Writes test and train Dataframes.
 
     Parameters
     ----------
@@ -53,20 +54,19 @@
         y = np.array([unique.index(x) for x in stratification_list])
 
     splits = StratifiedKFold(n_splits=int(n_splits), shuffle=True, random_state=2)
 
     for i, indices in enumerate(splits.split(np.zeros(len(y)), y)):
         train_index, test_index = indices
 
-        test_df = baseline_df.iloc[test_index]
         train_df = baseline_df.iloc[train_index]
         long_train_df = retrieve_longitudinal(train_df, diagnosis_df)
-
         train_df.reset_index(inplace=True, drop=True)
-        test_df.reset_index(inplace=True, drop=True)
+
+        test_df = baseline_df.iloc[test_index]
 
         # train_df = train_df[["participant_id", "session_id"]]
         # test_df = test_df[["participant_id", "session_id"]]
         # long_train_df = long_train_df[["participant_id", "session_id"]]
 
         (results_directory / f"split-{i}").mkdir(parents=True)
 
@@ -82,22 +82,32 @@
         )
 
         long_train_df.to_csv(
             results_directory / f"split-{i}" / "train.tsv",
             sep="\t",
             index=False,
         )
+        if valid_longitudinal:
+            long_test_df = retrieve_longitudinal(test_df, diagnosis_df)
+            test_df.reset_index(inplace=True, drop=True)
+
+            long_test_df.to_csv(
+                results_directory / f"split-{i}" / f"{subset_name}.tsv",
+                sep="\t",
+                index=False,
+            )
 
 
 def split_diagnoses(
     data_tsv: Path,
     n_splits: int = 5,
     subset_name: str = None,
     stratification: str = None,
     merged_tsv: Path = None,
+    valid_longitudinal: bool = False,
 ):
     """
     Performs a k-fold split for each label independently on the subject level.
     The output (the tsv file) will have two new columns :
         - split, with the number of the split the subject is in.
         - datagroup, with the name of the group (train or subset_name) the subject is in.
 
@@ -156,15 +166,15 @@
                 labels_df = pd.read_csv(parents_path / "labels.tsv", sep="\t")
                 diagnosis_df = pd.merge(
                     diagnosis_df,
                     labels_df,
                     how="inner",
                     on=["participant_id", "session_id"],
                 )
-            except:
+            except Exception:
                 raise ClinicaDLTSVError(
                     f"Your tsv file doesn't contain one of these columns : age, sex, diagnosis "
                     "and the pipeline wasn't able to find the output of clinicadl get-labels to get it."
                     "Before running this pipeline again, please run the command clinicadl get-metadata to get the missing columns"
                     "or add the the flag --ignore_demographics to split without trying to balance age or sex distributions."
                     "or add the option --merged-tsv to give the path the output of clinica merge-tsv"
                 )
@@ -172,10 +182,17 @@
             labels_df = pd.read_csv(merged_tsv, sep="\t")
             diagnosis_df = pd.merge(
                 diagnosis_df,
                 labels_df,
                 how="inner",
                 on=["participant_id", "session_id"],
             )
-    write_splits(diagnosis_df, stratification, n_splits, subset_name, results_directory)
+    write_splits(
+        diagnosis_df,
+        stratification,
+        n_splits,
+        subset_name,
+        results_directory,
+        valid_longitudinal=valid_longitudinal,
+    )
 
     logger.info(f"K-fold split is done.")
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/kfold/kfold_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/kfold/kfold_cli.py`

 * *Files 16% similar despite different names*

```diff
@@ -22,20 +22,22 @@
 )
 @click.option(
     "--merged-tsv",
     help="Path to the merged.tsv file.",
     type=str,
     default=None,
 )
+@cli_param.option.valid_longitudinal
 def cli(
     data_tsv,
     n_splits,
     subset_name,
     stratification,
     merged_tsv,
+    valid_longitudinal,
 ):
     """Performs a k-fold split to prepare training.
 
     DATA_TSV is the path to the output of tsvtool getlabels command.
 
     N_SPLITS is k, the number of folds of the k-fold.
     """
@@ -43,12 +45,13 @@
 
     split_diagnoses(
         data_tsv,
         n_splits=n_splits,
         subset_name=subset_name,
         stratification=stratification,
         merged_tsv=merged_tsv,
+        valid_longitudinal=valid_longitudinal,
     )
 
 
 if __name__ == "__main__":
     cli()
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/prepare_experiment/prepare_experiment_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/prepare_experiment/prepare_experiment_cli.py`

 * *Files 11% similar despite different names*

```diff
@@ -54,24 +54,24 @@
     """
 
     from clinicadl.tsvtools.split import split_diagnoses
 
     p_age_threshold = 0.80
     p_sex_threshold = 0.80
     ignore_demographics = False
-    flag_not_baseline = False
+    valid_longitudinal = False
     split_diagnoses(
         data_tsv,
         n_test=n_test,
         subset_name="test",
         p_age_threshold=p_age_threshold,
         p_sex_threshold=p_sex_threshold,
         ignore_demographics=ignore_demographics,
         categorical_split_variable=None,
-        not_only_baseline=flag_not_baseline,
+        valid_longitudinal=valid_longitudinal,
     )
 
     parents_path = data_tsv.parents[0]
     split_numero = 1
     folder_name = "split"
 
     while (parents_path / folder_name).is_dir():
@@ -106,22 +106,24 @@
             train_tsv,
             n_test=n_validation,
             subset_name="validation",
             p_age_threshold=p_age_threshold,
             p_sex_threshold=p_sex_threshold,
             ignore_demographics=ignore_demographics,
             categorical_split_variable=None,
+            valid_longitudinal=valid_longitudinal,
         )
 
     elif validation_type == "kfold":
         from clinicadl.tsvtools.kfold import split_diagnoses as kfold_diagnoses
 
         kfold_diagnoses(
             train_tsv,
             n_splits=int(n_validation),
             subset_name="validation",
             stratification=None,
+            valid_longitudinal=valid_longitudinal,
         )
 
 
 if __name__ == "__main__":
     cli()
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/split/split.py` & `clinicadl-1.6.1/clinicadl/tsvtools/split/split.py`

 * *Files 3% similar despite different names*

```diff
@@ -208,17 +208,16 @@
     data_tsv: Path,
     n_test=100,
     subset_name="test",
     p_age_threshold=0.80,
     p_sex_threshold=0.80,
     categorical_split_variable=None,
     ignore_demographics=False,
-    verbose=0,
-    not_only_baseline=True,
     multi_diagnoses=False,
+    valid_longitudinal=False,
 ):
     """
     Performs a single split for each label independently on the subject level.
     There will be two TSV file for the train set (baseline and longitudinal),
     whereas there will only be one TSV file for the test set (baseline sessions).
 
     The age and sex distributions between the two sets must be non-significant (according to T-test and chi-square).
@@ -241,16 +240,16 @@
         Name of a categorical variable to perform a stratified split.
     ignore_demographics: bool
         If True the diagnoses are split without taking into account the demographics
         distributions (age, sex).
     verbose: int
         Level of verbosity.
 
-    Informations
-    ------------
+    Information
+    -----------
     writes three files per <label>.tsv file present in data_tsv:
         - data_tsv/train/<label>.tsv
         - data_tsv/train/<label>_baseline.tsv
         - data_tsv/<subset_name>/<label>_baseline.tsv
     """
 
     parents_path = data_tsv.parents[0]
@@ -293,18 +292,17 @@
 
         train_df = extract_baseline(train)
         test_df = extract_baseline(test)
 
         name = f"{subset_name}_baseline.tsv"
         df_to_tsv(name, results_path, test_df, baseline=True)
 
-        if not_only_baseline:
+        if valid_longitudinal:
             long_test_df = retrieve_longitudinal(test_df, diagnosis_df)
             name = f"{subset_name}.tsv"
-            # long_test_df = long_test_df[["participant_id", "session_id"]]
             df_to_tsv(name, results_path, long_test_df)
 
     elif n_test > 0:
         if (
             "diagnosis" not in list_columns
             or ("age" not in list_columns and "age_bl" not in list_columns)
             or "sex" not in list_columns
@@ -318,15 +316,15 @@
                 labels_df = pd.read_csv(parents_path / "labels.tsv", sep="\t")
                 diagnosis_df = pd.merge(
                     diagnosis_df,
                     labels_df,
                     how="inner",
                     on=["participant_id", "session_id"],
                 )
-            except:
+            except Exception:
                 raise ClinicaDLTSVError(
                     f"The column 'age', 'sex' or 'diagnosis' is missing and the pipeline was not able to find "
                     "the output of clinicadl get-labels to get it."
                     "Please run clinicadl get-metadata to get these columns or add the the flag --ignore_demographics "
                     "to split without trying to balance age or sex distributions."
                 )
 
@@ -341,24 +339,24 @@
 
         # train_df= train_df[["participant_id", "session_id"]]
         # test_df= test_df[["participant_id", "session_id"]]
 
         name = f"{subset_name}_baseline.tsv"
         df_to_tsv(name, results_path, test_df, baseline=True)
 
-        if not_only_baseline:
+        if valid_longitudinal:
             name = f"{subset_name}.tsv"
             long_test_df = retrieve_longitudinal(test_df, diagnosis_df)
             # long_test_df = long_test_df[["participant_id", "session_id"]]
             df_to_tsv(name, results_path, long_test_df)
 
     else:
         train_df = extract_baseline(diagnosis_df)
         # train_df = train_df[["participant_id", "session_id"]]
-        if not_only_baseline:
+        if valid_longitudinal:
             long_train_df = diagnosis_df
 
     name = "train_baseline.tsv"
     df_to_tsv(name, results_path, train_df, baseline=True)
 
     long_train_df = retrieve_longitudinal(train_df, diagnosis_df)
     # long_train_df = long_train_df[["participant_id", "session_id"]]
```

### Comparing `clinicadl-1.6.0/clinicadl/tsvtools/split/split_cli.py` & `clinicadl-1.6.1/clinicadl/tsvtools/split/split_cli.py`

 * *Files 12% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 
 from clinicadl.utils import cli_param
 
 
 @click.command(name="split", no_args_is_help=True)
 @cli_param.argument.data_tsv
 @cli_param.option.subset_name
+@cli_param.option.valid_longitudinal
 @click.option(
     "--n_test",
     help="- If >= 1, number of subjects to put in set with name 'subset_name'.\n\n "
     "- If < 1, proportion of subjects to put set with name 'subset_name'.\n\n "
     "- If 0, no training set is created and the whole dataset is considered as one set with name 'subset_name'.",
     type=float,
     default=100.0,
@@ -40,36 +41,29 @@
     "--categorical_split_variable",
     help="Name of a categorical variable used for a stratified shuffle split "
     "(in addition to age, sex and group selection).",
     default=None,
     type=str,
 )
 @click.option(
-    "--not_only_keep_baseline",
-    help="If given will store the file with all subjects",
-    default=False,
-    is_flag=True,
-    type=bool,
-)
-@click.option(
     "--multi-diagnoses",
     help="If given, all columns are used to balance the split, not only age and sex",
     default=False,
     is_flag=True,
     type=bool,
 )
 def cli(
     data_tsv,
     subset_name,
+    valid_longitudinal,
     n_test,
     p_sex_threshold,
     p_age_threshold,
     ignore_demographics,
     categorical_split_variable,
-    not_only_keep_baseline,
     multi_diagnoses,
 ):
     """Performs a single split to prepare training.
 
     DATA_TSV is the path to the tsv file where the outputs of tsvtool getlabels command are stored.
 
     The split is done with respect to age, sex and group distribution.
@@ -80,14 +74,14 @@
         data_tsv,
         n_test=n_test,
         subset_name=subset_name,
         p_age_threshold=p_age_threshold,
         p_sex_threshold=p_sex_threshold,
         ignore_demographics=ignore_demographics,
         categorical_split_variable=categorical_split_variable,
-        not_only_baseline=not_only_keep_baseline,
         multi_diagnoses=multi_diagnoses,
+        valid_longitudinal=valid_longitudinal,
     )
 
 
 if __name__ == "__main__":
     cli()
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/callbacks/callbacks.py` & `clinicadl-1.6.1/clinicadl/utils/callbacks/callbacks.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/caps_dataset/data.py` & `clinicadl-1.6.1/clinicadl/utils/caps_dataset/data.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/cli_param/argument.py` & `clinicadl-1.6.1/clinicadl/utils/cli_param/argument.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/cli_param/option.py` & `clinicadl-1.6.1/clinicadl/utils/cli_param/option.py`

 * *Files 1% similar despite different names*

```diff
@@ -61,14 +61,20 @@
 ssda_network = click.option(
     "--ssda_network",
     type=bool,
     default=False,
     show_default=True,
     help="ssda training.",
 )
+valid_longitudinal = click.option(
+    "--valid_longitudinal/--valid_baseline",
+    type=bool,
+    default=None,
+    help="If provided, not only the baseline sessions are used for validation (careful with this bad habit).",
+)
 # GENERATE
 participant_list = click.option(
     "--participants_tsv",
     type=click.Path(exists=True, path_type=Path),
     help="Path to a TSV file including a list of participants/sessions.",
 )
 n_subjects = click.option(
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/cli_param/option_group.py` & `clinicadl-1.6.1/clinicadl/utils/cli_param/option_group.py`

 * *Files 1% similar despite different names*

```diff
@@ -20,9 +20,9 @@
     "Transfer learning", help="Allow to choose a source MAPS."
 )
 task_group = OptionGroup(
     "Task specific options", help="Options specific to the task learnt by the network."
 )
 informations_group = OptionGroup(
     "Informative options",
-    help=" Allow to get some more informations during the training.",
+    help=" Allow to get some more information during the training.",
 )
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/cli_param/train_option.py` & `clinicadl-1.6.1/clinicadl/utils/cli_param/train_option.py`

 * *Files 1% similar despite different names*

```diff
@@ -179,14 +179,20 @@
 )
 baseline = cli_param.option_group.data_group.option(
     "--baseline/--longitudinal",
     type=bool,
     default=None,
     help="If provided, only the baseline sessions are used for training.",
 )
+valid_longitudinal = cli_param.option_group.data_group.option(
+    "--valid_longitudinal/--valid_baseline",
+    type=bool,
+    default=None,
+    help="If provided, not only the baseline sessions are used for validation (careful with this bad habit).",
+)
 normalize = cli_param.option_group.data_group.option(
     "--normalize/--unnormalize",
     type=bool,
     default=None,
     help="Disable default MinMaxNormalization.",
 )
 data_augmentation = cli_param.option_group.data_group.option(
@@ -240,15 +246,15 @@
     help="TSV of unllabeled target data.",
 )
 preprocessing_dict_target = cli_param.option_group.data_group.option(
     "--preprocessing_dict_target",
     "-d",
     type=str,
     default=None,
-    help="Path to json taget.",
+    help="Path to json target.",
 )
 # Cross validation
 n_splits = cli_param.option_group.cross_validation.option(
     "--n_splits",
     type=int,
     # default=0,
     help="If a value is given for k will load data of a k-fold CV. "
@@ -371,14 +377,14 @@
 nb_unfrozen_layer = cli_param.option_group.transfer_learning_group.option(
     "-nul",
     "--nb_unfrozen_layer",
     type=int,
     default=0,
     help="Number of layer that will be retrain during training. For example, if it is 2, the last two layers of the model will not be freezed.",
 )
-# informations
+# information
 emissions_calculator = cli_param.option_group.informations_group.option(
     "--calculate_emissions/--dont_calculate_emissions",
     type=bool,
     default=None,
     help="Flag to allow calculate the carbon emissions during training.",
 )
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/clinica_utils.py` & `clinicadl-1.6.1/clinicadl/utils/clinica_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -76,15 +76,14 @@
     elif modality == "flair":
         return {"pattern": "sub-*_ses-*_flair.nii*", "description": "FLAIR T2w MRI"}
     elif modality == "dwi":
         return {"pattern": "dwi/sub-*_ses-*_dwi.nii*", "description": "DWI NIfTI"}
 
 
 def linear_nii(modality: str, uncropped_image: bool) -> dict:
-
     if modality not in ("T1w", "T2w", "flair"):
         raise ClinicaDLArgumentError(
             f"ClinicaDL is Unable to read this modality ({modality}) of images"
         )
     elif modality == "T1w":
         needed_pipeline = "t1-linear"
     elif modality == "T2w":
@@ -95,15 +94,15 @@
     if uncropped_image:
         desc_crop = ""
     else:
         desc_crop = "_desc-Crop"
 
     information = {
         "pattern": f"*space-MNI152NLin2009cSym{desc_crop}_res-1x1x1_{modality}.nii.gz",
-        "description": f"{modality} Image registred in MNI152NLin2009cSym space using {needed_pipeline} pipeline "
+        "description": f"{modality} Image registered in MNI152NLin2009cSym space using {needed_pipeline} pipeline "
         + (
             ""
             if uncropped_image
             else "and cropped (matrix size 169208179, 1 mm isotropic voxels)"
         ),
         "needed_pipeline": needed_pipeline,
     }
@@ -143,26 +142,25 @@
         "pattern": f"dwi/dti_based_processing/*/*_space-{space}_{measure.value}.nii.gz",
         "description": f"DTI-based {measure.value} in space {space}.",
         "needed_pipeline": "dwi_dti",
     }
 
 
 def pet_linear_nii(
-    acq_label: str, suvr_reference_region: str, uncropped_image: bool
+    tracer: str, suvr_reference_region: str, uncropped_image: bool
 ) -> dict:
-
     if uncropped_image:
         description = ""
     else:
         description = "_desc-Crop"
 
     information = {
         "pattern": str(
             Path("pet_linear")
-            / f"*_trc-{acq_label}_pet_space-MNI152NLin2009cSym{description}_res-1x1x1_suvr-{suvr_reference_region}_pet.nii.gz"
+            / f"*_trc-{tracer}_space-MNI152NLin2009cSym{description}_res-1x1x1_suvr-{suvr_reference_region}_pet.nii.gz"
         ),
         "description": "",
         "needed_pipeline": "pet-linear",
     }
     return information
 
 
@@ -431,15 +429,14 @@
     subjects_sub_folders = _list_subjects_sub_folders(dir_to_look, groups_dir)
     if subjects_dir.is_dir():
         return False
     return len(subjects_sub_folders) > 0
 
 
 def _list_subjects_sub_folders(root_dir: Path, groups_dir: Path) -> List[Path]:
-
     warning_msg = (
         f"Could not determine if {groups_dir.parent} is a CAPS or BIDS directory. "
         "Clinica will assume this is a CAPS directory."
     )
     folder_content = [f for f in root_dir.iterdir()]
     subjects_sub_folders = [
         sub for sub in folder_content if (sub.name.startswith("sub-") and sub.is_dir())
@@ -589,15 +586,15 @@
             `check_bids_directory` or `check_caps_directory`, and that
             the flag `is_bids` has been set accordingly.
 
     subject : str
         Name given to the folder of a participant (ex: sub-ADNI002S0295).
 
     session : str
-        Name given to the folder of a session (ex: ses-M00).
+        Name given to the folder of a session (ex: ses-M000).
 
     error_encountered : List
         List to which errors encountered in this function are added.
 
     results : List
         List to which the output path corresponding to subject, session
         and pattern is added.
@@ -793,15 +790,14 @@
 
 
 def _get_extension(filename: Path) -> str:
     return "".join(filename.suffixes)
 
 
 def _get_suffix(filename: Path) -> str:
-
     return f"_{get_filename_no_ext(filename.name).split('_')[-1]}"
 
 
 _check_common_parent_path = partial(
     _check_common_properties_of_files,
     property_name="parent path",
     property_extractor=_get_parent_path,
@@ -983,69 +979,69 @@
 
     Examples
     --------
     The paths are shortened for readability.
 
     You have the full name of a file.
 
-    File `orig_nu.mgz` from FreeSurfer of subject `sub-ADNI011S4105`, session `ses-M00`
+    File `orig_nu.mgz` from FreeSurfer of subject `sub-ADNI011S4105`, session `ses-M000`
     located in mri folder of FreeSurfer output :
 
     >>> clinicadl_file_reader(
             ['sub-ADNI011S4105'],
-            ['ses-M00'],
+            ['ses-M000'],
             caps_directory,
             {
                 'pattern': 'freesurfer_cross_sectional/sub-*_ses-*/mri/orig_nu.mgz',
                 'description': 'freesurfer file orig_nu.mgz',
                 'needed_pipeline': 't1-freesurfer'
             }
         )
-    ['/caps/subjects/sub-ADNI011S4105/ses-M00/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M00/mri/orig_nu.mgz']
+    ['/caps/subjects/sub-ADNI011S4105/ses-M000/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M000/mri/orig_nu.mgz']
 
     You have a partial name of the file.
 
-    File `sub-ADNI011S4105_ses-M00_trc-18FFDG_pet.nii.gz` in BIDS directory.
+    File `sub-ADNI011S4105_ses-M000_trc-18FFDG_pet.nii.gz` in BIDS directory.
     Here, filename depends on subject and session name :
 
     >>> clinicadl_file_reader(
             ['sub-ADNI011S4105'],
-            ['ses-M00'],
+            ['ses-M000'],
             bids_directory,
             {
                 'pattern': '*18FFDG_pet.nii*',
                 'description': 'FDG PET data'
             }
         )
-    ['/bids/sub-ADNI011S4105/ses-M00/pet/sub-ADNI011S4105_ses-M00_trc-18FFDG_pet.nii.gz']
+    ['/bids/sub-ADNI011S4105/ses-M000/pet/sub-ADNI011S4105_ses-M000_trc-18FFDG_pet.nii.gz']
 
     Tricky example.
 
     Get the file `rh.white` from FreeSurfer :
 
     This will fail :
 
     >>> clinicadl_file_reader(
             ['sub-ADNI011S4105'],
-            ['ses-M00'],
+            ['ses-M000'],
             caps,
             {
                 'pattern': 'rh.white',
                 'description': 'right hemisphere of outer cortical surface.',
                 'needed_pipeline': 't1-freesurfer'
             }
         )
     * More than 1 file found::
-            /caps/subjects/sub-ADNI011S4105/ses-M00/t1/freesurfer_cross_sectional/fsaverage/surf/rh.white
-            /caps/subjects/sub-ADNI011S4105/ses-M00/t1/freesurfer_cross_sectional/rh.EC_average/surf/rh.white
-            /caps/subjects/sub-ADNI011S4105/ses-M00/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M00/surf/rh.white
+            /caps/subjects/sub-ADNI011S4105/ses-M000/t1/freesurfer_cross_sectional/fsaverage/surf/rh.white
+            /caps/subjects/sub-ADNI011S4105/ses-M000/t1/freesurfer_cross_sectional/rh.EC_average/surf/rh.white
+            /caps/subjects/sub-ADNI011S4105/ses-M000/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M000/surf/rh.white
 
     Correct usage (e.g. in pet-surface): pattern string must be 'sub-*_ses-*/surf/rh.white',
     or even more precise: 't1/freesurfer_cross_sectional/sub-*_ses-*/surf/rh.white'
-    It then gives: ['/caps/subjects/sub-ADNI011S4105/ses-M00/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M00/surf/rh.white']
+    It then gives: ['/caps/subjects/sub-ADNI011S4105/ses-M000/t1/freesurfer_cross_sectional/sub-ADNI011S4105_ses-M000/surf/rh.white']
     """
     from clinicadl.utils.exceptions import ClinicaDLBIDSError, ClinicaDLCAPSError
 
     _check_information(information)
     pattern = information["pattern"]
     is_bids = determine_caps_or_bids(input_directory)
     if is_bids:
@@ -1134,28 +1130,28 @@
             buffer = f.read(chunk_size)
             if not buffer:
                 break
             sha256hash.update(buffer)
     return sha256hash.hexdigest()
 
 
-def fetch_file(remote: RemoteFileStructure, dirname: Optional[Path]) -> Path:
+def fetch_file(remote: RemoteFileStructure, dirname: Path) -> Path:
     """Download a specific file and save it into the resources folder of the package.
 
     Parameters
     ----------
     remote : RemoteFileStructure
         Structure containing url, filename and checksum.
 
-    dirname : str
+    dirname : Path
         Absolute path where the file will be downloaded.
 
     Returns
     -------
-    file_path : str
+    file_path : Path
         Absolute file path.
     """
 
     if not dirname.exists():
         cprint(msg="Path to the file does not exist", lvl="warning")
         cprint(msg="Stop Clinica and handle this error", lvl="warning")
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/descriptors.py` & `clinicadl-1.6.1/clinicadl/utils/descriptors.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/early_stopping.py` & `clinicadl-1.6.1/clinicadl/utils/early_stopping.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/exceptions.py` & `clinicadl-1.6.1/clinicadl/utils/exceptions.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/logger.py` & `clinicadl-1.6.1/clinicadl/utils/logger.py`

 * *Files 1% similar despite different names*

```diff
@@ -52,14 +52,15 @@
     err_formatter = logging.Formatter(
         "%(asctime)s - %(name)s - %(levelname)s: %(message)s", "%Y-%m-%d %H:%M:%S"
     )
     err_handler = logging.StreamHandler(stream=sys.stderr)
     err_handler.addFilter(StdLevelFilter(err=True))
     err_handler.setFormatter(err_formatter)
 
+    logger.handlers = []
     logger.addHandler(console_handler)
     logger.addHandler(err_handler)
 
     # Create file handler for debug mode with its own formatter and add it to the logger
     if verbose:
         debug_file_formatter = logging.Formatter(
             "%(asctime)s - %(name)s - %(levelname)s: %(message)s", "%Y-%m-%d %H:%M:%S"
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/auto_master_addr_port.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/auto_master_addr_port.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/base.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/base.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/default.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/default.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/slurm.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/slurm.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/api/torchelastic.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/api/torchelastic.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/config.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/config.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/interface.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/interface.py`

 * *Files 0% similar despite different names*

```diff
@@ -170,12 +170,12 @@
 
         Args:
             module (Any): Module which will be crawled to find any acceptable API object.
         """
         for obj_name in dir(module):
             obj = getattr(module, obj_name)
             if isclass(obj) and issubclass(obj, API) and obj is not API:
-                # obj is the class so we instanciate it
+                # obj is the class so we instantiate it
                 self.register_API(obj())
             elif isinstance(obj, API) and obj.__class__ is not API:
                 # obj is already the instance
                 self.register_API(obj)
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/profiler/patch_kineto.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/profiler/patch_kineto.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/cluster/utils.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/cluster/utils.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/iotools.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/iotools.py`

 * *Files 0% similar despite different names*

```diff
@@ -248,14 +248,15 @@
         "seed": None,
         "selection_metrics": ["loss"],
         "tolerance": 0.0,
         "deterministic": False,
         "transfer_learning_path": "",
         "transfer_learning_selection": "best_loss",
         "gpu": True,
+        "valid_longitudinal": False,
         "wd_bool": True,
         "weight_decay": 4,
         "sampler": "random",
     }
     mode_default_values = {
         "patch": {
             "patch_size": 50,
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/logwriter.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/logwriter.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/maps_manager.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/maps_manager.py`

 * *Files 2% similar despite different names*

```diff
@@ -50,7657 +50,7759 @@
 00000310: 6144 4c41 7267 756d 656e 7445 7272 6f72  aDLArgumentError
 00000320: 2c0a 2020 2020 436c 696e 6963 6144 4c43  ,.    ClinicaDLC
 00000330: 6f6e 6669 6775 7261 7469 6f6e 4572 726f  onfigurationErro
 00000340: 722c 0a20 2020 2043 6c69 6e69 6361 444c  r,.    ClinicaDL
 00000350: 4461 7461 4c65 616b 6167 6545 7272 6f72  DataLeakageError
 00000360: 2c0a 2020 2020 4d41 5053 4572 726f 722c  ,.    MAPSError,
 00000370: 0a29 0a66 726f 6d20 636c 696e 6963 6164  .).from clinicad
-00000380: 6c2e 7574 696c 732e 6c6f 6767 6572 2069  l.utils.logger i
-00000390: 6d70 6f72 7420 7365 7475 705f 6c6f 6767  mport setup_logg
-000003a0: 696e 670a 6672 6f6d 2063 6c69 6e69 6361  ing.from clinica
-000003b0: 646c 2e75 7469 6c73 2e6d 6170 735f 6d61  dl.utils.maps_ma
-000003c0: 6e61 6765 722e 6464 7020 696d 706f 7274  nager.ddp import
-000003d0: 2044 4450 2c20 636c 7573 7465 722c 2069   DDP, cluster, i
-000003e0: 6e69 745f 6464 700a 6672 6f6d 2063 6c69  nit_ddp.from cli
-000003f0: 6e69 6361 646c 2e75 7469 6c73 2e6d 6170  nicadl.utils.map
-00000400: 735f 6d61 6e61 6765 722e 6c6f 6777 7269  s_manager.logwri
-00000410: 7465 7220 696d 706f 7274 204c 6f67 5772  ter import LogWr
-00000420: 6974 6572 0a66 726f 6d20 636c 696e 6963  iter.from clinic
-00000430: 6164 6c2e 7574 696c 732e 6d61 7073 5f6d  adl.utils.maps_m
-00000440: 616e 6167 6572 2e6d 6170 735f 6d61 6e61  anager.maps_mana
-00000450: 6765 725f 7574 696c 7320 696d 706f 7274  ger_utils import
-00000460: 2028 0a20 2020 2061 6464 5f64 6566 6175   (.    add_defau
-00000470: 6c74 5f76 616c 7565 732c 0a20 2020 2063  lt_values,.    c
-00000480: 6861 6e67 655f 7061 7468 5f74 6f5f 7374  hange_path_to_st
-00000490: 722c 0a20 2020 2063 6861 6e67 655f 7374  r,.    change_st
-000004a0: 725f 746f 5f70 6174 682c 0a20 2020 2072  r_to_path,.    r
-000004b0: 6561 645f 6a73 6f6e 2c0a 290a 6672 6f6d  ead_json,.).from
-000004c0: 2063 6c69 6e69 6361 646c 2e75 7469 6c73   clinicadl.utils
-000004d0: 2e6d 6574 7269 635f 6d6f 6475 6c65 2069  .metric_module i
-000004e0: 6d70 6f72 7420 5265 7461 696e 4265 7374  mport RetainBest
-000004f0: 0a66 726f 6d20 636c 696e 6963 6164 6c2e  .from clinicadl.
-00000500: 7574 696c 732e 6e65 7477 6f72 6b2e 6e65  utils.network.ne
-00000510: 7477 6f72 6b20 696d 706f 7274 204e 6574  twork import Net
-00000520: 776f 726b 0a66 726f 6d20 636c 696e 6963  work.from clinic
-00000530: 6164 6c2e 7574 696c 732e 7365 6564 2069  adl.utils.seed i
-00000540: 6d70 6f72 7420 6765 745f 7365 6564 2c20  mport get_seed, 
-00000550: 706c 5f77 6f72 6b65 725f 696e 6974 5f66  pl_worker_init_f
-00000560: 756e 6374 696f 6e2c 2073 6565 645f 6576  unction, seed_ev
-00000570: 6572 7974 6869 6e67 0a0a 6c6f 6767 6572  erything..logger
-00000580: 203d 2067 6574 4c6f 6767 6572 2822 636c   = getLogger("cl
-00000590: 696e 6963 6164 6c2e 6d61 7073 5f6d 616e  inicadl.maps_man
-000005a0: 6167 6572 2229 0a6c 6576 656c 5f6c 6973  ager").level_lis
-000005b0: 743a 204c 6973 745b 7374 725d 203d 205b  t: List[str] = [
-000005c0: 2277 6172 6e69 6e67 222c 2022 696e 666f  "warning", "info
-000005d0: 222c 2022 6465 6275 6722 5d0a 0a0a 2320  ", "debug"]...# 
-000005e0: 544f 444f 2073 6176 6520 7765 6967 6874  TODO save weight
-000005f0: 7320 6f6e 2043 5055 2066 6f72 2062 6574  s on CPU for bet
-00000600: 7465 7220 636f 6d70 6174 6962 696c 6974  ter compatibilit
-00000610: 790a 0a0a 636c 6173 7320 4d61 7073 4d61  y...class MapsMa
-00000620: 6e61 6765 723a 0a20 2020 2064 6566 205f  nager:.    def _
-00000630: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
-00000640: 2073 656c 662c 0a20 2020 2020 2020 206d   self,.        m
-00000650: 6170 735f 7061 7468 3a20 5061 7468 2c0a  aps_path: Path,.
-00000660: 2020 2020 2020 2020 7061 7261 6d65 7465          paramete
-00000670: 7273 3a20 4469 6374 5b73 7472 2c20 416e  rs: Dict[str, An
-00000680: 795d 203d 204e 6f6e 652c 0a20 2020 2020  y] = None,.     
-00000690: 2020 2076 6572 626f 7365 3a20 7374 7220     verbose: str 
-000006a0: 3d20 2269 6e66 6f22 2c0a 2020 2020 293a  = "info",.    ):
-000006b0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-000006c0: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-000006d0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-000006e0: 2d2d 2d0a 2020 2020 2020 2020 6d61 7073  ---.        maps
-000006f0: 5f70 6174 683a 2073 7472 2028 7061 7468  _path: str (path
-00000700: 290a 2020 2020 2020 2020 2020 2020 5061  ).            Pa
-00000710: 7468 206f 6620 7468 6520 4d41 5053 0a20  th of the MAPS. 
-00000720: 2020 2020 2020 2070 6172 616d 6574 6572         parameter
-00000730: 733a 2044 6963 745b 7374 722c 2041 6e79  s: Dict[str, Any
-00000740: 5d0a 2020 2020 2020 2020 2020 2020 5061  ].            Pa
-00000750: 7261 6d65 7465 7273 206f 6620 7468 6520  rameters of the 
-00000760: 7472 6169 6e69 6e67 2073 7465 702e 2049  training step. I
-00000770: 6620 6769 7665 6e20 6120 6e65 7720 4d41  f given a new MA
-00000780: 5053 2069 7320 6372 6561 7465 642e 0a20  PS is created.. 
-00000790: 2020 2020 2020 2076 6572 626f 7365 3a20         verbose: 
-000007a0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-000007b0: 4c6f 6767 696e 6720 6c65 7665 6c20 2822  Logging level ("
-000007c0: 6465 6275 6722 2c20 2269 6e66 6f22 2c20  debug", "info", 
-000007d0: 2277 6172 6e69 6e67 2229 0a20 2020 2020  "warning").     
-000007e0: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-000007f0: 656c 662e 6d61 7073 5f70 6174 6820 3d20  elf.maps_path = 
-00000800: 6d61 7073 5f70 6174 682e 7265 736f 6c76  maps_path.resolv
-00000810: 6528 290a 0a20 2020 2020 2020 2023 2045  e()..        # E
-00000820: 7869 7374 696e 6720 4d41 5053 0a20 2020  xisting MAPS.   
-00000830: 2020 2020 2069 6620 7061 7261 6d65 7465       if paramete
-00000840: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
-00000850: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
-00000860: 6d61 7073 5f70 6174 6820 2f20 226d 6170  maps_path / "map
-00000870: 732e 6a73 6f6e 2229 2e69 735f 6669 6c65  s.json").is_file
-00000880: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00000890: 2020 2020 7261 6973 6520 4d41 5053 4572      raise MAPSEr
-000008a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000008b0: 2020 2020 2020 2020 2066 224d 4150 5320           f"MAPS 
-000008c0: 7761 7320 6e6f 7420 666f 756e 6420 6174  was not found at
-000008d0: 207b 6d61 7073 5f70 6174 687d 2e22 0a20   {maps_path}.". 
-000008e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000008f0: 2020 2066 2254 6f20 696e 6974 6961 7465     f"To initiate
-00000900: 2061 206e 6577 204d 4150 5320 706c 6561   a new MAPS plea
-00000910: 7365 2067 6976 6520 6120 7472 6169 6e5f  se give a train_
-00000920: 6469 6374 2e22 0a20 2020 2020 2020 2020  dict.".         
-00000930: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00000940: 2020 2020 2074 6573 745f 7061 7261 6d65       test_parame
-00000950: 7465 7273 203d 2073 656c 662e 6765 745f  ters = self.get_
-00000960: 7061 7261 6d65 7465 7273 2829 0a20 2020  parameters().   
-00000970: 2020 2020 2020 2020 2074 6573 745f 7061           test_pa
-00000980: 7261 6d65 7465 7273 203d 2063 6861 6e67  rameters = chang
-00000990: 655f 7374 725f 746f 5f70 6174 6828 7465  e_str_to_path(te
-000009a0: 7374 5f70 6172 616d 6574 6572 7329 0a20  st_parameters). 
-000009b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000009c0: 7061 7261 6d65 7465 7273 203d 2061 6464  parameters = add
-000009d0: 5f64 6566 6175 6c74 5f76 616c 7565 7328  _default_values(
-000009e0: 7465 7374 5f70 6172 616d 6574 6572 7329  test_parameters)
-000009f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00000a00: 662e 7373 6461 5f6e 6574 776f 726b 203d  f.ssda_network =
-00000a10: 2046 616c 7365 2020 2320 4120 4d4f 4449   False  # A MODI
-00000a20: 4649 4552 0a20 2020 2020 2020 2020 2020  FIER.           
-00000a30: 2073 656c 662e 7361 7665 5f61 6c6c 5f6d   self.save_all_m
-00000a40: 6f64 656c 7320 3d20 7365 6c66 2e70 6172  odels = self.par
-00000a50: 616d 6574 6572 735b 2273 6176 655f 616c  ameters["save_al
-00000a60: 6c5f 6d6f 6465 6c73 225d 0a20 2020 2020  l_models"].     
-00000a70: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-00000a80: 5f6d 616e 6167 6572 203d 2073 656c 662e  _manager = self.
-00000a90: 5f69 6e69 745f 7461 736b 5f6d 616e 6167  _init_task_manag
-00000aa0: 6572 286e 5f63 6c61 7373 6573 3d73 656c  er(n_classes=sel
-00000ab0: 662e 6f75 7470 7574 5f73 697a 6529 0a20  f.output_size). 
-00000ac0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000ad0: 7370 6c69 745f 6e61 6d65 203d 2028 0a20  split_name = (. 
-00000ae0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00000af0: 656c 662e 5f63 6865 636b 5f73 706c 6974  elf._check_split
-00000b00: 5f77 6f72 6469 6e67 2829 0a20 2020 2020  _wording().     
-00000b10: 2020 2020 2020 2029 2020 2320 5573 6564         )  # Used
-00000b20: 206f 6e6c 7920 666f 7220 7265 7472 6f2d   only for retro-
-00000b30: 636f 6d70 6174 6962 696c 6974 790a 0a20  compatibility.. 
-00000b40: 2020 2020 2020 2023 2049 6e69 7469 6174         # Initiat
-00000b50: 6520 4d41 5053 0a20 2020 2020 2020 2065  e MAPS.        e
-00000b60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00000b70: 2073 656c 662e 5f63 6865 636b 5f61 7267   self._check_arg
-00000b80: 7328 7061 7261 6d65 7465 7273 290a 2020  s(parameters).  
-00000b90: 2020 2020 2020 2020 2020 7061 7261 6d65            parame
-00000ba0: 7465 7273 5b22 7473 765f 7061 7468 225d  ters["tsv_path"]
-00000bb0: 203d 2050 6174 6828 7061 7261 6d65 7465   = Path(paramete
-00000bc0: 7273 5b22 7473 765f 7061 7468 225d 290a  rs["tsv_path"]).
-00000bd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00000be0: 662e 7370 6c69 745f 6e61 6d65 203d 2022  f.split_name = "
-00000bf0: 7370 6c69 7422 2020 2320 5573 6564 206f  split"  # Used o
-00000c00: 6e6c 7920 666f 7220 7265 7472 6f2d 636f  nly for retro-co
-00000c10: 6d70 6174 6962 696c 6974 790a 2020 2020  mpatibility.    
-00000c20: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
-00000c30: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
-00000c40: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
-00000c50: 6170 735f 7061 7468 2e69 735f 6469 7228  aps_path.is_dir(
-00000c60: 2920 616e 6420 6d61 7073 5f70 6174 682e  ) and maps_path.
-00000c70: 6973 5f66 696c 6528 2929 206f 7220 2820  is_file()) or ( 
-00000c80: 2023 204e 6f6e 2d66 6f6c 6465 7220 6669   # Non-folder fi
-00000c90: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-00000ca0: 2020 2020 2020 206d 6170 735f 7061 7468         maps_path
-00000cb0: 2e69 735f 6469 7228 2920 616e 6420 6c69  .is_dir() and li
-00000cc0: 7374 286d 6170 735f 7061 7468 2e69 7465  st(maps_path.ite
-00000cd0: 7264 6972 2829 2920 2023 204e 6f6e 2065  rdir())  # Non e
-00000ce0: 6d70 7479 2066 6f6c 6465 720a 2020 2020  mpty folder.    
-00000cf0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-00000d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000d10: 2020 2072 6169 7365 204d 4150 5345 7272     raise MAPSErr
-00000d20: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00000d30: 2020 2020 2020 2020 2020 2020 6622 596f              f"Yo
-00000d40: 7520 6172 6520 7472 7969 6e67 2074 6f20  u are trying to 
-00000d50: 6372 6561 7465 2061 206e 6577 204d 4150  create a new MAP
-00000d60: 5320 6174 207b 6d61 7073 5f70 6174 687d  S at {maps_path}
-00000d70: 2062 7574 2022 0a20 2020 2020 2020 2020   but ".         
-00000d80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00000d90: 2274 6869 7320 616c 7265 6164 7920 636f  "this already co
-00000da0: 7272 6573 706f 6e64 7320 746f 2061 2066  rresponds to a f
-00000db0: 696c 6520 6f72 2061 206e 6f6e 2d65 6d70  ile or a non-emp
-00000dc0: 7479 2066 6f6c 6465 722e 205c 6e22 0a20  ty folder. \n". 
-00000dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000de0: 2020 2020 2020 2066 2250 6c65 6173 6520         f"Please 
-00000df0: 7265 6d6f 7665 2069 7420 6f72 2063 686f  remove it or cho
-00000e00: 6f73 6520 616e 6f74 6865 7220 6c6f 6361  ose another loca
-00000e10: 7469 6f6e 2e22 0a20 2020 2020 2020 2020  tion.".         
-00000e20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00000e30: 2020 2020 2020 2020 2020 2020 2028 6d61               (ma
-00000e40: 7073 5f70 6174 6820 2f20 2267 726f 7570  ps_path / "group
-00000e50: 7322 292e 6d6b 6469 7228 7061 7265 6e74  s").mkdir(parent
-00000e60: 733d 5472 7565 290a 0a20 2020 2020 2020  s=True)..       
-00000e70: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00000e80: 696e 666f 2866 2241 206e 6577 204d 4150  info(f"A new MAP
-00000e90: 5320 7761 7320 6372 6561 7465 6420 6174  S was created at
-00000ea0: 207b 6d61 7073 5f70 6174 687d 2229 0a0a   {maps_path}")..
-00000eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ec0: 7365 6c66 2e77 7269 7465 5f70 6172 616d  self.write_param
-00000ed0: 6574 6572 7328 7365 6c66 2e6d 6170 735f  eters(self.maps_
-00000ee0: 7061 7468 2c20 7365 6c66 2e70 6172 616d  path, self.param
-00000ef0: 6574 6572 7329 0a20 2020 2020 2020 2020  eters).         
-00000f00: 2020 2020 2020 2073 656c 662e 5f77 7269         self._wri
-00000f10: 7465 5f72 6571 7569 7265 6d65 6e74 735f  te_requirements_
-00000f20: 7665 7273 696f 6e28 290a 2020 2020 2020  version().      
-00000f30: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00000f40: 7772 6974 655f 7472 6169 6e69 6e67 5f64  write_training_d
-00000f50: 6174 6128 290a 2020 2020 2020 2020 2020  ata().          
-00000f60: 2020 2020 2020 7365 6c66 2e5f 7772 6974        self._writ
-00000f70: 655f 7472 6169 6e5f 7661 6c5f 6772 6f75  e_train_val_grou
-00000f80: 7073 2829 0a20 2020 2020 2020 2020 2020  ps().           
-00000f90: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
-00000fa0: 5f69 6e66 6f72 6d61 7469 6f6e 2829 0a0a  _information()..
-00000fb0: 2020 2020 2020 2020 696e 6974 5f64 6470          init_ddp
-00000fc0: 2867 7075 3d73 656c 662e 7061 7261 6d65  (gpu=self.parame
-00000fd0: 7465 7273 5b22 6770 7522 5d2c 206c 6f67  ters["gpu"], log
-00000fe0: 6765 723d 6c6f 6767 6572 290a 0a20 2020  ger=logger)..   
-00000ff0: 2064 6566 205f 5f67 6574 6174 7472 5f5f   def __getattr__
-00001000: 2873 656c 662c 206e 616d 6529 3a0a 2020  (self, name):.  
-00001010: 2020 2020 2020 2222 2241 6c6c 6f77 2074        """Allow t
-00001020: 6f20 6469 7265 6374 6c79 2067 6574 2074  o directly get t
-00001030: 6865 2076 616c 7565 7320 696e 2070 6172  he values in par
-00001040: 616d 6574 6572 7320 6174 7472 6962 7574  ameters attribut
-00001050: 6522 2222 0a20 2020 2020 2020 2069 6620  e""".        if 
-00001060: 6e61 6d65 2069 6e20 7365 6c66 2e70 6172  name in self.par
-00001070: 616d 6574 6572 733a 0a20 2020 2020 2020  ameters:.       
-00001080: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00001090: 2e70 6172 616d 6574 6572 735b 6e61 6d65  .parameters[name
-000010a0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-000010b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000010c0: 6520 4174 7472 6962 7574 6545 7272 6f72  e AttributeError
-000010d0: 2866 2227 4d61 7073 4d61 6e61 6765 7227  (f"'MapsManager'
-000010e0: 206f 626a 6563 7420 6861 7320 6e6f 2061   object has no a
-000010f0: 7474 7269 6275 7465 2027 7b6e 616d 657d  ttribute '{name}
-00001100: 2722 290a 0a20 2020 2064 6566 2074 7261  '")..    def tra
-00001110: 696e 2873 656c 662c 2073 706c 6974 5f6c  in(self, split_l
-00001120: 6973 743a 204c 6973 745b 696e 745d 203d  ist: List[int] =
-00001130: 204e 6f6e 652c 206f 7665 7277 7269 7465   None, overwrite
-00001140: 3a20 626f 6f6c 203d 2046 616c 7365 293a  : bool = False):
-00001150: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00001160: 2020 2020 2050 6572 666f 726d 7320 7468       Performs th
-00001170: 6520 7472 6169 6e69 6e67 2074 6173 6b20  e training task 
-00001180: 666f 7220 6120 6465 6669 6e65 6420 6c69  for a defined li
-00001190: 7374 206f 6620 7370 6c69 7473 0a0a 2020  st of splits..  
-000011a0: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-000011b0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-000011c0: 2d2d 2d0a 2020 2020 2020 2020 7370 6c69  ---.        spli
-000011d0: 745f 6c69 7374 3a20 4c69 7374 5b69 6e74  t_list: List[int
-000011e0: 5d0a 2020 2020 2020 2020 2020 2020 6c69  ].            li
-000011f0: 7374 206f 6620 7370 6c69 7473 206f 6e20  st of splits on 
-00001200: 7768 6963 6820 7468 6520 7472 6169 6e69  which the traini
-00001210: 6e67 2074 6173 6b20 6973 2070 6572 666f  ng task is perfo
-00001220: 726d 6564 2e0a 2020 2020 2020 2020 2020  rmed..          
-00001230: 2020 4465 6661 756c 7420 7472 6169 6e73    Default trains
-00001240: 2061 6c6c 2073 706c 6974 7320 6f66 2074   all splits of t
-00001250: 6865 2063 726f 7373 2d76 616c 6964 6174  he cross-validat
-00001260: 696f 6e2e 0a20 2020 2020 2020 206f 7665  ion..        ove
-00001270: 7277 7269 7465 3a20 626f 6f6c 0a20 2020  rwrite: bool.   
-00001280: 2020 2020 2020 2020 2049 6620 5472 7565           If True
-00001290: 2070 7265 7669 6f75 736c 7920 7472 6169   previously trai
-000012a0: 6e65 6420 7370 6c69 7473 2074 6861 7420  ned splits that 
-000012b0: 6172 6520 676f 696e 6720 746f 2062 6520  are going to be 
-000012c0: 7472 6169 6e65 6420 6172 6520 6572 6173  trained are eras
-000012d0: 6564 2e0a 0a20 2020 2020 2020 2052 6169  ed...        Rai
-000012e0: 7365 730a 2020 2020 2020 2020 2d2d 2d2d  ses.        ----
-000012f0: 2d2d 0a20 2020 2020 2020 2052 6169 7365  --.        Raise
-00001300: 7320 4d41 5053 4572 726f 722c 2069 6620  s MAPSError, if 
-00001310: 7370 6c69 7473 2073 7065 6369 6669 6564  splits specified
-00001320: 2069 6e20 696e 7075 7420 616c 7265 6164   in input alread
-00001330: 7920 6578 6973 7420 616e 6420 6f76 6572  y exist and over
-00001340: 7772 6974 6520 6973 2046 616c 7365 2e0a  write is False..
-00001350: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00001360: 2020 2020 6578 6973 7469 6e67 5f73 706c      existing_spl
-00001370: 6974 7320 3d20 5b5d 0a0a 2020 2020 2020  its = []..      
-00001380: 2020 7370 6c69 745f 6d61 6e61 6765 7220    split_manager 
-00001390: 3d20 7365 6c66 2e5f 696e 6974 5f73 706c  = self._init_spl
-000013a0: 6974 5f6d 616e 6167 6572 2873 706c 6974  it_manager(split
-000013b0: 5f6c 6973 7429 0a20 2020 2020 2020 2066  _list).        f
-000013c0: 6f72 2073 706c 6974 2069 6e20 7370 6c69  or split in spli
-000013d0: 745f 6d61 6e61 6765 722e 7370 6c69 745f  t_manager.split_
-000013e0: 6974 6572 6174 6f72 2829 3a0a 2020 2020  iterator():.    
-000013f0: 2020 2020 2020 2020 7370 6c69 745f 7061          split_pa
-00001400: 7468 203d 2073 656c 662e 6d61 7073 5f70  th = self.maps_p
-00001410: 6174 6820 2f20 6622 7b73 656c 662e 7370  ath / f"{self.sp
-00001420: 6c69 745f 6e61 6d65 7d2d 7b73 706c 6974  lit_name}-{split
-00001430: 7d22 0a20 2020 2020 2020 2020 2020 2069  }".            i
-00001440: 6620 7370 6c69 745f 7061 7468 2e69 735f  f split_path.is_
-00001450: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
-00001460: 2020 2020 2020 2069 6620 6f76 6572 7772         if overwr
-00001470: 6974 653a 0a20 2020 2020 2020 2020 2020  ite:.           
-00001480: 2020 2020 2020 2020 2069 6620 636c 7573           if clus
-00001490: 7465 722e 6d61 7374 6572 3a0a 2020 2020  ter.master:.    
-000014a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014b0: 2020 2020 7368 7574 696c 2e72 6d74 7265      shutil.rmtre
-000014c0: 6528 7370 6c69 745f 7061 7468 290a 2020  e(split_path).  
-000014d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000014e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000014f0: 2020 2020 2020 2020 6578 6973 7469 6e67          existing
-00001500: 5f73 706c 6974 732e 6170 7065 6e64 2873  _splits.append(s
-00001510: 706c 6974 290a 0a20 2020 2020 2020 2069  plit)..        i
-00001520: 6620 6c65 6e28 6578 6973 7469 6e67 5f73  f len(existing_s
-00001530: 706c 6974 7329 203e 2030 3a0a 2020 2020  plits) > 0:.    
-00001540: 2020 2020 2020 2020 7261 6973 6520 4d41          raise MA
-00001550: 5053 4572 726f 7228 0a20 2020 2020 2020  PSError(.       
-00001560: 2020 2020 2020 2020 2066 2253 706c 6974           f"Split
-00001570: 7320 7b65 7869 7374 696e 675f 7370 6c69  s {existing_spli
-00001580: 7473 7d20 616c 7265 6164 7920 6578 6973  ts} already exis
-00001590: 742e 2050 6c65 6173 6520 220a 2020 2020  t. Please ".    
-000015a0: 2020 2020 2020 2020 2020 2020 6622 7370              f"sp
-000015b0: 6563 6966 7920 6120 6c69 7374 206f 6620  ecify a list of 
-000015c0: 7370 6c69 7473 206e 6f74 2069 6e74 6572  splits not inter
-000015d0: 7365 6374 696e 6720 7468 6520 7072 6576  secting the prev
-000015e0: 696f 7573 206c 6973 742c 2022 0a20 2020  ious list, ".   
-000015f0: 2020 2020 2020 2020 2020 2020 2066 226f               f"o
-00001600: 7220 7573 6520 6f76 6572 7772 6974 6520  r use overwrite 
-00001610: 746f 2065 7261 7365 2070 7265 7669 6f75  to erase previou
-00001620: 736c 7920 7472 6169 6e65 6420 7370 6c69  sly trained spli
-00001630: 7473 2e22 0a20 2020 2020 2020 2020 2020  ts.".           
-00001640: 2029 0a0a 2020 2020 2020 2020 6966 2073   )..        if s
-00001650: 656c 662e 6d75 6c74 695f 6e65 7477 6f72  elf.multi_networ
-00001660: 6b3a 0a20 2020 2020 2020 2020 2020 2073  k:.            s
-00001670: 656c 662e 5f74 7261 696e 5f6d 756c 7469  elf._train_multi
-00001680: 2873 706c 6974 5f6c 6973 742c 2072 6573  (split_list, res
-00001690: 756d 653d 4661 6c73 6529 0a20 2020 2020  ume=False).     
-000016a0: 2020 2065 6c69 6620 7365 6c66 2e73 7364     elif self.ssd
-000016b0: 615f 6e65 7477 6f72 6b3a 0a20 2020 2020  a_network:.     
-000016c0: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
-000016d0: 696e 5f73 7364 6128 7370 6c69 745f 6c69  in_ssda(split_li
-000016e0: 7374 2c20 7265 7375 6d65 3d46 616c 7365  st, resume=False
-000016f0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00001700: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00001710: 2e5f 7472 6169 6e5f 7369 6e67 6c65 2873  ._train_single(s
-00001720: 706c 6974 5f6c 6973 742c 2072 6573 756d  plit_list, resum
-00001730: 653d 4661 6c73 6529 0a0a 2020 2020 6465  e=False)..    de
-00001740: 6620 7265 7375 6d65 2873 656c 662c 2073  f resume(self, s
-00001750: 706c 6974 5f6c 6973 743a 204c 6973 745b  plit_list: List[
-00001760: 696e 745d 203d 204e 6f6e 6529 3a0a 2020  int] = None):.  
-00001770: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00001780: 2020 5265 7375 6d65 7320 7468 6520 7472    Resumes the tr
-00001790: 6169 6e69 6e67 2074 6173 6b20 666f 7220  aining task for 
-000017a0: 6120 6465 6669 6e65 6420 6c69 7374 206f  a defined list o
-000017b0: 6620 7370 6c69 7473 2e0a 0a20 2020 2020  f splits...     
-000017c0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000017d0: 2020 2020 2073 706c 6974 5f6c 6973 743a       split_list:
-000017e0: 206c 6973 7420 6f66 2073 706c 6974 7320   list of splits 
-000017f0: 6f6e 2077 6869 6368 2074 6865 2074 7261  on which the tra
-00001800: 696e 696e 6720 7461 736b 2069 7320 7065  ining task is pe
-00001810: 7266 6f72 6d65 642e 0a20 2020 2020 2020  rformed..       
-00001820: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-00001830: 2074 7261 696e 7320 616c 6c20 7370 6c69   trains all spli
-00001840: 7473 2e0a 0a20 2020 2020 2020 2052 6169  ts...        Rai
-00001850: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-00001860: 204d 4150 5345 7272 6f72 3a20 4966 2073   MAPSError: If s
-00001870: 706c 6974 7320 7370 6563 6966 6965 6420  plits specified 
-00001880: 696e 2069 6e70 7574 2064 6f20 6e6f 7420  in input do not 
-00001890: 6578 6973 742e 0a20 2020 2020 2020 2022  exist..        "
-000018a0: 2222 0a20 2020 2020 2020 206d 6973 7369  "".        missi
-000018b0: 6e67 5f73 706c 6974 7320 3d20 5b5d 0a20  ng_splits = []. 
-000018c0: 2020 2020 2020 2073 706c 6974 5f6d 616e         split_man
-000018d0: 6167 6572 203d 2073 656c 662e 5f69 6e69  ager = self._ini
-000018e0: 745f 7370 6c69 745f 6d61 6e61 6765 7228  t_split_manager(
-000018f0: 7370 6c69 745f 6c69 7374 290a 0a20 2020  split_list)..   
-00001900: 2020 2020 2066 6f72 2073 706c 6974 2069       for split i
-00001910: 6e20 7370 6c69 745f 6d61 6e61 6765 722e  n split_manager.
-00001920: 7370 6c69 745f 6974 6572 6174 6f72 2829  split_iterator()
-00001930: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00001940: 206e 6f74 2028 7365 6c66 2e6d 6170 735f   not (self.maps_
-00001950: 7061 7468 202f 2066 227b 7365 6c66 2e73  path / f"{self.s
-00001960: 706c 6974 5f6e 616d 657d 2d7b 7370 6c69  plit_name}-{spli
-00001970: 747d 2220 2f20 2274 6d70 2229 2e69 735f  t}" / "tmp").is_
-00001980: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
-00001990: 2020 2020 2020 206d 6973 7369 6e67 5f73         missing_s
-000019a0: 706c 6974 732e 6170 7065 6e64 2873 706c  plits.append(spl
-000019b0: 6974 290a 0a20 2020 2020 2020 2069 6620  it)..        if 
-000019c0: 6c65 6e28 6d69 7373 696e 675f 7370 6c69  len(missing_spli
-000019d0: 7473 2920 3e20 303a 0a20 2020 2020 2020  ts) > 0:.       
-000019e0: 2020 2020 2072 6169 7365 204d 4150 5345       raise MAPSE
-000019f0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00001a00: 2020 2020 2020 6622 5370 6c69 7473 207b        f"Splits {
-00001a10: 6d69 7373 696e 675f 7370 6c69 7473 7d20  missing_splits} 
-00001a20: 7765 7265 206e 6f74 2069 6e69 7469 616c  were not initial
-00001a30: 697a 6564 2e20 220a 2020 2020 2020 2020  ized. ".        
-00001a40: 2020 2020 2020 2020 6622 506c 6561 7365          f"Please
-00001a50: 2074 7279 2074 7261 696e 2063 6f6d 6d61   try train comma
-00001a60: 6e64 206f 6e20 7468 6573 6520 7370 6c69  nd on these spli
-00001a70: 7473 2061 6e64 2072 6573 756d 6520 6f6e  ts and resume on
-00001a80: 6c79 206f 7468 6572 732e 220a 2020 2020  ly others.".    
-00001a90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00001aa0: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-00001ab0: 5f6e 6574 776f 726b 3a0a 2020 2020 2020  _network:.      
-00001ac0: 2020 2020 2020 7365 6c66 2e5f 7472 6169        self._trai
-00001ad0: 6e5f 6d75 6c74 6928 7370 6c69 745f 6c69  n_multi(split_li
-00001ae0: 7374 2c20 7265 7375 6d65 3d54 7275 6529  st, resume=True)
-00001af0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-00001b00: 6c66 2e73 7364 615f 6e65 7477 6f72 6b3a  lf.ssda_network:
-00001b10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001b20: 662e 5f74 7261 696e 5f73 7364 6128 7370  f._train_ssda(sp
-00001b30: 6c69 745f 6c69 7374 2c20 7265 7375 6d65  lit_list, resume
-00001b40: 3d54 7275 6529 0a20 2020 2020 2020 2065  =True).        e
-00001b50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00001b60: 2073 656c 662e 5f74 7261 696e 5f73 696e   self._train_sin
-00001b70: 676c 6528 7370 6c69 745f 6c69 7374 2c20  gle(split_list, 
-00001b80: 7265 7375 6d65 3d54 7275 6529 0a0a 2020  resume=True)..  
-00001b90: 2020 6465 6620 7072 6564 6963 7428 0a20    def predict(. 
-00001ba0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00001bb0: 2020 2020 2064 6174 615f 6772 6f75 703a       data_group:
-00001bc0: 2073 7472 2c0a 2020 2020 2020 2020 6361   str,.        ca
-00001bd0: 7073 5f64 6972 6563 746f 7279 3a20 5061  ps_directory: Pa
-00001be0: 7468 203d 204e 6f6e 652c 0a20 2020 2020  th = None,.     
-00001bf0: 2020 2074 7376 5f70 6174 683a 2050 6174     tsv_path: Pat
-00001c00: 6820 3d20 4e6f 6e65 2c0a 2020 2020 2020  h = None,.      
-00001c10: 2020 7370 6c69 745f 6c69 7374 3a20 4c69    split_list: Li
-00001c20: 7374 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a  st[int] = None,.
-00001c30: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
-00001c40: 6e5f 6d65 7472 6963 733a 204c 6973 745b  n_metrics: List[
-00001c50: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-00001c60: 2020 2020 206d 756c 7469 5f63 6f68 6f72       multi_cohor
-00001c70: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
-00001c80: 0a20 2020 2020 2020 2064 6961 676e 6f73  .        diagnos
-00001c90: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
-00001ca0: 2829 2c0a 2020 2020 2020 2020 7573 655f  (),.        use_
-00001cb0: 6c61 6265 6c73 3a20 626f 6f6c 203d 2054  labels: bool = T
-00001cc0: 7275 652c 0a20 2020 2020 2020 2062 6174  rue,.        bat
-00001cd0: 6368 5f73 697a 653a 2069 6e74 203d 204e  ch_size: int = N
-00001ce0: 6f6e 652c 0a20 2020 2020 2020 206e 5f70  one,.        n_p
-00001cf0: 726f 633a 2069 6e74 203d 204e 6f6e 652c  roc: int = None,
-00001d00: 0a20 2020 2020 2020 2067 7075 3a20 626f  .        gpu: bo
-00001d10: 6f6c 203d 204e 6f6e 652c 0a20 2020 2020  ol = None,.     
-00001d20: 2020 2061 6d70 3a20 626f 6f6c 203d 2046     amp: bool = F
-00001d30: 616c 7365 2c0a 2020 2020 2020 2020 6f76  alse,.        ov
-00001d40: 6572 7772 6974 653a 2062 6f6f 6c20 3d20  erwrite: bool = 
-00001d50: 4661 6c73 652c 0a20 2020 2020 2020 206c  False,.        l
-00001d60: 6162 656c 3a20 7374 7220 3d20 4e6f 6e65  abel: str = None
-00001d70: 2c0a 2020 2020 2020 2020 6c61 6265 6c5f  ,.        label_
-00001d80: 636f 6465 3a20 4f70 7469 6f6e 616c 5b44  code: Optional[D
-00001d90: 6963 745b 7374 722c 2069 6e74 5d5d 203d  ict[str, int]] =
-00001da0: 2022 6465 6661 756c 7422 2c0a 2020 2020   "default",.    
-00001db0: 2020 2020 7361 7665 5f74 656e 736f 723a      save_tensor:
-00001dc0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00001dd0: 2020 2020 2020 2073 6176 655f 6e69 6674         save_nift
-00001de0: 693a 2062 6f6f 6c20 3d20 4661 6c73 652c  i: bool = False,
-00001df0: 0a20 2020 2020 2020 2073 6176 655f 6c61  .        save_la
-00001e00: 7465 6e74 5f74 656e 736f 723a 2062 6f6f  tent_tensor: boo
-00001e10: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00001e20: 2020 2073 6b69 705f 6c65 616b 5f63 6865     skip_leak_che
-00001e30: 636b 3a20 626f 6f6c 203d 2046 616c 7365  ck: bool = False
-00001e40: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00001e50: 2022 2222 0a20 2020 2020 2020 2050 6572   """.        Per
-00001e60: 666f 726d 7320 7468 6520 7072 6564 6963  forms the predic
-00001e70: 7469 6f6e 2074 6173 6b20 6f6e 2061 2073  tion task on a s
-00001e80: 7562 7365 7420 6f66 2063 6170 735f 6469  ubset of caps_di
-00001e90: 7265 6374 6f72 7920 6465 6669 6e65 6420  rectory defined 
-00001ea0: 696e 2061 2054 5356 2066 696c 652e 0a0a  in a TSV file...
-00001eb0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00001ec0: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00001ed0: 726f 7570 3a20 6e61 6d65 206f 6620 7468  roup: name of th
-00001ee0: 6520 6461 7461 2067 726f 7570 2074 6573  e data group tes
-00001ef0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-00001f00: 2063 6170 735f 6469 7265 6374 6f72 793a   caps_directory:
-00001f10: 2070 6174 6820 746f 2074 6865 2043 4150   path to the CAP
-00001f20: 5320 666f 6c64 6572 2e20 466f 7220 6d6f  S folder. For mo
-00001f30: 7265 2069 6e66 6f72 6d61 7469 6f6e 2070  re information p
-00001f40: 6c65 6173 6520 7265 6665 7220 746f 0a20  lease refer to. 
-00001f50: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00001f60: 636c 696e 6963 6120 646f 6375 6d65 6e74  clinica document
-00001f70: 6174 696f 6e5d 2868 7474 7073 3a2f 2f61  ation](https://a
-00001f80: 7261 6d69 736c 6162 2e70 6172 6973 2e69  ramislab.paris.i
-00001f90: 6e72 6961 2e66 722f 636c 696e 6963 612f  nria.fr/clinica/
-00001fa0: 646f 6373 2f70 7562 6c69 632f 6c61 7465  docs/public/late
-00001fb0: 7374 2f43 4150 532f 496e 7472 6f64 7563  st/CAPS/Introduc
-00001fc0: 7469 6f6e 2f29 2e0a 2020 2020 2020 2020  tion/)..        
-00001fd0: 2020 2020 2020 2020 4465 6661 756c 7420          Default 
-00001fe0: 7769 6c6c 206c 6f61 6420 7468 6520 7661  will load the va
-00001ff0: 6c75 6520 6f66 2061 6e20 6578 6973 7469  lue of an existi
-00002000: 6e67 2064 6174 6120 6772 6f75 700a 2020  ng data group.  
-00002010: 2020 2020 2020 2020 2020 7473 765f 7061            tsv_pa
-00002020: 7468 3a20 7061 7468 2074 6f20 6120 5453  th: path to a TS
-00002030: 5620 6669 6c65 2063 6f6e 7461 696e 696e  V file containin
-00002040: 6720 7468 6520 6c69 7374 206f 6620 7061  g the list of pa
-00002050: 7274 6963 6970 616e 7473 2061 6e64 2073  rticipants and s
-00002060: 6573 7369 6f6e 7320 746f 2074 6573 742e  essions to test.
-00002070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002080: 2044 6566 6175 6c74 2077 696c 6c20 6c6f   Default will lo
-00002090: 6164 2074 6865 2044 6174 6146 7261 6d65  ad the DataFrame
-000020a0: 206f 6620 616e 2065 7869 7374 696e 6720   of an existing 
-000020b0: 6461 7461 2067 726f 7570 0a20 2020 2020  data group.     
-000020c0: 2020 2020 2020 2073 706c 6974 5f6c 6973         split_lis
-000020d0: 743a 206c 6973 7420 6f66 2073 706c 6974  t: list of split
-000020e0: 7320 746f 2074 6573 742e 2044 6566 6175  s to test. Defau
-000020f0: 6c74 2070 6572 666f 726d 2070 7265 6469  lt perform predi
-00002100: 6374 696f 6e20 6f6e 2061 6c6c 2073 706c  ction on all spl
-00002110: 6974 7320 6176 6169 6c61 626c 652e 0a20  its available.. 
-00002120: 2020 2020 2020 2020 2020 2073 656c 6563             selec
-00002130: 7469 6f6e 5f6d 6574 7269 6373 2028 6c69  tion_metrics (li
-00002140: 7374 5b73 7472 5d29 3a20 6c69 7374 206f  st[str]): list o
-00002150: 6620 7365 6c65 6374 696f 6e20 6d65 7472  f selection metr
-00002160: 6963 7320 746f 2074 6573 742e 0a20 2020  ics to test..   
-00002170: 2020 2020 2020 2020 2020 2020 2044 6566               Def
-00002180: 6175 6c74 2070 6572 666f 726d 7320 7468  ault performs th
-00002190: 6520 7072 6564 6963 7469 6f6e 206f 6e20  e prediction on 
-000021a0: 616c 6c20 7365 6c65 6374 696f 6e20 6d65  all selection me
-000021b0: 7472 6963 7320 6176 6169 6c61 626c 652e  trics available.
-000021c0: 0a20 2020 2020 2020 2020 2020 206d 756c  .            mul
-000021d0: 7469 5f63 6f68 6f72 743a 2049 6620 5472  ti_cohort: If Tr
-000021e0: 7565 2063 6f6e 7369 6465 7273 2074 6861  ue considers tha
-000021f0: 7420 7473 765f 7061 7468 2069 7320 7468  t tsv_path is th
-00002200: 6520 7061 7468 2074 6f20 6120 6d75 6c74  e path to a mult
-00002210: 692d 636f 686f 7274 2054 5356 2e0a 2020  i-cohort TSV..  
-00002220: 2020 2020 2020 2020 2020 6469 6167 6e6f            diagno
-00002230: 7365 733a 204c 6973 7420 6f66 2064 6961  ses: List of dia
-00002240: 676e 6f73 6573 2074 6f20 6c6f 6164 2069  gnoses to load i
-00002250: 6620 7473 765f 7061 7468 2069 7320 6120  f tsv_path is a 
-00002260: 7370 6c69 745f 6469 7265 6374 6f72 792e  split_directory.
-00002270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002280: 2044 6566 6175 6c74 2075 7365 7320 7468   Default uses th
-00002290: 6520 7361 6d65 2061 7320 696e 2074 7261  e same as in tra
-000022a0: 696e 696e 6720 7374 6570 2e0a 2020 2020  ining step..    
-000022b0: 2020 2020 2020 2020 7573 655f 6c61 6265          use_labe
-000022c0: 6c73 3a20 4966 2054 7275 652c 2074 6865  ls: If True, the
-000022d0: 206c 6162 656c 7320 6d75 7374 2065 7869   labels must exi
-000022e0: 7374 2069 6e20 7465 7374 206d 6574 612d  st in test meta-
-000022f0: 6461 7461 2061 6e64 206d 6574 7269 6373  data and metrics
-00002300: 2061 7265 2063 6f6d 7075 7465 642e 0a20   are computed.. 
-00002310: 2020 2020 2020 2020 2020 2062 6174 6368             batch
-00002320: 5f73 697a 653a 2049 6620 6769 7665 6e2c  _size: If given,
-00002330: 2073 6574 7320 7468 6520 7661 6c75 6520   sets the value 
-00002340: 6f66 2062 6174 6368 5f73 697a 652c 2065  of batch_size, e
-00002350: 6c73 6520 7573 6520 7468 6520 7361 6d65  lse use the same
-00002360: 2061 7320 696e 2074 7261 696e 696e 6720   as in training 
-00002370: 7374 6570 2e0a 2020 2020 2020 2020 2020  step..          
-00002380: 2020 6e5f 7072 6f63 3a20 4966 2067 6976    n_proc: If giv
-00002390: 656e 2c20 7365 7473 2074 6865 2076 616c  en, sets the val
-000023a0: 7565 206f 6620 6e75 6d5f 776f 726b 6572  ue of num_worker
-000023b0: 732c 2065 6c73 6520 7573 6520 7468 6520  s, else use the 
-000023c0: 7361 6d65 2061 7320 696e 2074 7261 696e  same as in train
-000023d0: 696e 6720 7374 6570 2e0a 2020 2020 2020  ing step..      
-000023e0: 2020 2020 2020 6770 753a 2049 6620 6769        gpu: If gi
-000023f0: 7665 6e2c 2061 206e 6577 2076 616c 7565  ven, a new value
-00002400: 2066 6f72 2074 6865 2064 6576 6963 6520   for the device 
-00002410: 6f66 2074 6865 206d 6f64 656c 2077 696c  of the model wil
-00002420: 6c20 6265 2063 6f6d 7075 7465 642e 0a20  l be computed.. 
-00002430: 2020 2020 2020 2020 2020 2061 6d70 3a20             amp: 
-00002440: 4966 2065 6e61 626c 6564 2c20 7573 6573  If enabled, uses
-00002450: 2041 7574 6f6d 6174 6963 204d 6978 6564   Automatic Mixed
-00002460: 2050 7265 6369 7369 6f6e 2028 7265 7175   Precision (requ
-00002470: 6972 6573 2047 5055 2075 7361 6765 292e  ires GPU usage).
-00002480: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
-00002490: 7277 7269 7465 3a20 4966 2054 7275 6520  rwrite: If True 
-000024a0: 6572 6173 6520 7468 6520 6f63 6375 7272  erase the occurr
-000024b0: 656e 6365 7320 6f66 2064 6174 615f 6772  ences of data_gr
-000024c0: 6f75 702e 0a20 2020 2020 2020 2020 2020  oup..           
-000024d0: 206c 6162 656c 3a20 5461 7267 6574 206c   label: Target l
-000024e0: 6162 656c 2075 7365 6420 666f 7220 7472  abel used for tr
-000024f0: 6169 6e69 6e67 2028 6966 206e 6574 776f  aining (if netwo
-00002500: 726b 5f74 6173 6b20 696e 205b 6072 6567  rk_task in [`reg
-00002510: 7265 7373 696f 6e60 2c20 6063 6c61 7373  ression`, `class
-00002520: 6966 6963 6174 696f 6e60 5d29 2e0a 2020  ification`])..  
-00002530: 2020 2020 2020 2020 2020 6c61 6265 6c5f            label_
-00002540: 636f 6465 3a20 6469 6374 696f 6e61 7279  code: dictionary
-00002550: 206c 696e 6b69 6e67 2074 6865 2074 6172   linking the tar
-00002560: 6765 7420 7661 6c75 6573 2074 6f20 6120  get values to a 
-00002570: 6e6f 6465 206e 756d 6265 722e 0a20 2020  node number..   
-00002580: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00002590: 2069 6620 6e6f 7420 7370 6c69 745f 6c69   if not split_li
-000025a0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-000025b0: 7370 6c69 745f 6c69 7374 203d 2073 656c  split_list = sel
-000025c0: 662e 5f66 696e 645f 7370 6c69 7473 2829  f._find_splits()
-000025d0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-000025e0: 6465 6275 6728 6622 4c69 7374 206f 6620  debug(f"List of 
-000025f0: 7370 6c69 7473 207b 7370 6c69 745f 6c69  splits {split_li
-00002600: 7374 7d22 290a 0a20 2020 2020 2020 205f  st}")..        _
-00002610: 2c20 616c 6c5f 7472 616e 7366 6f72 6d73  , all_transforms
-00002620: 203d 2067 6574 5f74 7261 6e73 666f 726d   = get_transform
-00002630: 7328 0a20 2020 2020 2020 2020 2020 206e  s(.            n
-00002640: 6f72 6d61 6c69 7a65 3d73 656c 662e 6e6f  ormalize=self.no
-00002650: 726d 616c 697a 652c 0a20 2020 2020 2020  rmalize,.       
-00002660: 2020 2020 2064 6174 615f 6175 676d 656e       data_augmen
-00002670: 7461 7469 6f6e 3d73 656c 662e 6461 7461  tation=self.data
-00002680: 5f61 7567 6d65 6e74 6174 696f 6e2c 0a20  _augmentation,. 
-00002690: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-000026a0: 7265 6475 6374 696f 6e3d 7365 6c66 2e73  reduction=self.s
-000026b0: 697a 655f 7265 6475 6374 696f 6e2c 0a20  ize_reduction,. 
-000026c0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-000026d0: 7265 6475 6374 696f 6e5f 6661 6374 6f72  reduction_factor
-000026e0: 3d73 656c 662e 7369 7a65 5f72 6564 7563  =self.size_reduc
-000026f0: 7469 6f6e 5f66 6163 746f 722c 0a20 2020  tion_factor,.   
-00002700: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00002710: 6772 6f75 705f 6466 203d 204e 6f6e 650a  group_df = None.
-00002720: 2020 2020 2020 2020 6966 2074 7376 5f70          if tsv_p
-00002730: 6174 6820 6973 206e 6f74 204e 6f6e 653a  ath is not None:
-00002740: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
-00002750: 7570 5f64 6620 3d20 6c6f 6164 5f64 6174  up_df = load_dat
-00002760: 615f 7465 7374 280a 2020 2020 2020 2020  a_test(.        
-00002770: 2020 2020 2020 2020 7473 765f 7061 7468          tsv_path
-00002780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002790: 2020 6469 6167 6e6f 7365 7320 6966 206c    diagnoses if l
-000027a0: 656e 2864 6961 676e 6f73 6573 2920 213d  en(diagnoses) !=
-000027b0: 2030 2065 6c73 6520 7365 6c66 2e64 6961   0 else self.dia
-000027c0: 676e 6f73 6573 2c0a 2020 2020 2020 2020  gnoses,.        
-000027d0: 2020 2020 2020 2020 6d75 6c74 695f 636f          multi_co
-000027e0: 686f 7274 3d6d 756c 7469 5f63 6f68 6f72  hort=multi_cohor
-000027f0: 742c 0a20 2020 2020 2020 2020 2020 2029  t,.            )
-00002800: 0a20 2020 2020 2020 2063 7269 7465 7269  .        criteri
-00002810: 6f6e 203d 2073 656c 662e 7461 736b 5f6d  on = self.task_m
-00002820: 616e 6167 6572 2e67 6574 5f63 7269 7465  anager.get_crite
-00002830: 7269 6f6e 2873 656c 662e 6c6f 7373 290a  rion(self.loss).
-00002840: 2020 2020 2020 2020 7365 6c66 2e5f 6368          self._ch
-00002850: 6563 6b5f 6461 7461 5f67 726f 7570 280a  eck_data_group(.
-00002860: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00002870: 5f67 726f 7570 2c0a 2020 2020 2020 2020  _group,.        
-00002880: 2020 2020 6361 7073 5f64 6972 6563 746f      caps_directo
-00002890: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-000028a0: 6772 6f75 705f 6466 2c0a 2020 2020 2020  group_df,.      
-000028b0: 2020 2020 2020 6d75 6c74 695f 636f 686f        multi_coho
-000028c0: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
-000028d0: 6f76 6572 7772 6974 652c 0a20 2020 2020  overwrite,.     
-000028e0: 2020 2020 2020 206c 6162 656c 3d6c 6162         label=lab
-000028f0: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-00002900: 7370 6c69 745f 6c69 7374 3d73 706c 6974  split_list=split
-00002910: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
-00002920: 2020 2073 6b69 705f 6c65 616b 5f63 6865     skip_leak_che
-00002930: 636b 3d73 6b69 705f 6c65 616b 5f63 6865  ck=skip_leak_che
-00002940: 636b 2c0a 2020 2020 2020 2020 290a 2020  ck,.        ).  
-00002950: 2020 2020 2020 666f 7220 7370 6c69 7420        for split 
-00002960: 696e 2073 706c 6974 5f6c 6973 743a 0a20  in split_list:. 
-00002970: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00002980: 722e 696e 666f 2866 2250 7265 6469 6374  r.info(f"Predict
-00002990: 696f 6e20 6f66 2073 706c 6974 207b 7370  ion of split {sp
-000029a0: 6c69 747d 2229 0a20 2020 2020 2020 2020  lit}").         
-000029b0: 2020 2067 726f 7570 5f64 662c 2067 726f     group_df, gro
-000029c0: 7570 5f70 6172 616d 6574 6572 7320 3d20  up_parameters = 
-000029d0: 7365 6c66 2e67 6574 5f67 726f 7570 5f69  self.get_group_i
-000029e0: 6e66 6f28 6461 7461 5f67 726f 7570 2c20  nfo(data_group, 
-000029f0: 7370 6c69 7429 0a20 2020 2020 2020 2020  split).         
-00002a00: 2020 2023 2046 696e 6420 6c61 6265 6c20     # Find label 
-00002a10: 636f 6465 2069 6620 6e6f 7420 6769 7665  code if not give
-00002a20: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-00002a30: 206c 6162 656c 2069 7320 6e6f 7420 4e6f   label is not No
-00002a40: 6e65 2061 6e64 206c 6162 656c 2021 3d20  ne and label != 
-00002a50: 7365 6c66 2e6c 6162 656c 2061 6e64 206c  self.label and l
-00002a60: 6162 656c 5f63 6f64 6520 3d3d 2022 6465  abel_code == "de
-00002a70: 6661 756c 7422 3a0a 2020 2020 2020 2020  fault":.        
-00002a80: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-00002a90: 6b5f 6d61 6e61 6765 722e 6765 6e65 7261  k_manager.genera
-00002aa0: 7465 5f6c 6162 656c 5f63 6f64 6528 6772  te_label_code(gr
-00002ab0: 6f75 705f 6466 2c20 6c61 6265 6c29 0a0a  oup_df, label)..
-00002ac0: 2020 2020 2020 2020 2020 2020 2320 4572              # Er
-00002ad0: 6173 6520 7072 6576 696f 7573 2054 5356  ase previous TSV
-00002ae0: 2066 696c 6573 206f 6e20 6d61 7374 6572   files on master
-00002af0: 2070 726f 6365 7373 0a20 2020 2020 2020   process.       
-00002b00: 2020 2020 2069 6620 6e6f 7420 7365 6c65       if not sele
-00002b10: 6374 696f 6e5f 6d65 7472 6963 733a 0a20  ction_metrics:. 
-00002b20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00002b30: 706c 6974 5f73 656c 6563 7469 6f6e 5f6d  plit_selection_m
-00002b40: 6574 7269 6373 203d 2073 656c 662e 5f66  etrics = self._f
-00002b50: 696e 645f 7365 6c65 6374 696f 6e5f 6d65  ind_selection_me
-00002b60: 7472 6963 7328 7370 6c69 7429 0a20 2020  trics(split).   
-00002b70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00002b80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00002b90: 706c 6974 5f73 656c 6563 7469 6f6e 5f6d  plit_selection_m
-00002ba0: 6574 7269 6373 203d 2073 656c 6563 7469  etrics = selecti
-00002bb0: 6f6e 5f6d 6574 7269 6373 0a20 2020 2020  on_metrics.     
-00002bc0: 2020 2020 2020 2066 6f72 2073 656c 6563         for selec
-00002bd0: 7469 6f6e 2069 6e20 7370 6c69 745f 7365  tion in split_se
-00002be0: 6c65 6374 696f 6e5f 6d65 7472 6963 733a  lection_metrics:
-00002bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c00: 2074 7376 5f64 6972 203d 2028 0a20 2020   tsv_dir = (.   
-00002c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c20: 2073 656c 662e 6d61 7073 5f70 6174 680a   self.maps_path.
-00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c40: 2020 2020 2f20 6622 7b73 656c 662e 7370      / f"{self.sp
-00002c50: 6c69 745f 6e61 6d65 7d2d 7b73 706c 6974  lit_name}-{split
-00002c60: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00002c70: 2020 2020 2020 202f 2066 2262 6573 742d         / f"best-
-00002c80: 7b73 656c 6563 7469 6f6e 7d22 0a20 2020  {selection}".   
-00002c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ca0: 202f 2064 6174 615f 6772 6f75 700a 2020   / data_group.  
-00002cb0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00002cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002cd0: 2074 7376 5f70 6174 7465 726e 203d 2066   tsv_pattern = f
-00002ce0: 227b 6461 7461 5f67 726f 7570 7d2a 2e74  "{data_group}*.t
-00002cf0: 7376 220a 0a20 2020 2020 2020 2020 2020  sv"..           
-00002d00: 2020 2020 2066 6f72 2074 7376 5f66 696c       for tsv_fil
-00002d10: 6520 696e 2074 7376 5f64 6972 2e67 6c6f  e in tsv_dir.glo
-00002d20: 6228 7473 765f 7061 7474 6572 6e29 3a0a  b(tsv_pattern):.
-00002d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d40: 2020 2020 7473 765f 6669 6c65 2e75 6e6c      tsv_file.unl
-00002d50: 696e 6b28 290a 0a20 2020 2020 2020 2020  ink()..         
-00002d60: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-00002d70: 5f6e 6574 776f 726b 3a0a 2020 2020 2020  _network:.      
-00002d80: 2020 2020 2020 2020 2020 666f 7220 6e65            for ne
-00002d90: 7477 6f72 6b20 696e 2072 616e 6765 2873  twork in range(s
-00002da0: 656c 662e 6e75 6d5f 6e65 7477 6f72 6b73  elf.num_networks
-00002db0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00002dc0: 2020 2020 2020 2064 6174 615f 7465 7374         data_test
-00002dd0: 203d 2072 6574 7572 6e5f 6461 7461 7365   = return_datase
-00002de0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00002df0: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00002e00: 5f70 6172 616d 6574 6572 735b 2263 6170  _parameters["cap
-00002e10: 735f 6469 7265 6374 6f72 7922 5d2c 0a20  s_directory"],. 
-00002e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e30: 2020 2020 2020 2067 726f 7570 5f64 662c         group_df,
-00002e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002e50: 2020 2020 2020 2020 2073 656c 662e 7072           self.pr
-00002e60: 6570 726f 6365 7373 696e 675f 6469 6374  eprocessing_dict
-00002e70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002e80: 2020 2020 2020 2020 2020 616c 6c5f 7472            all_tr
-00002e90: 616e 7366 6f72 6d61 7469 6f6e 733d 616c  ansformations=al
-00002ea0: 6c5f 7472 616e 7366 6f72 6d73 2c0a 2020  l_transforms,.  
-00002eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ec0: 2020 2020 2020 6d75 6c74 695f 636f 686f        multi_coho
-00002ed0: 7274 3d67 726f 7570 5f70 6172 616d 6574  rt=group_paramet
-00002ee0: 6572 735b 226d 756c 7469 5f63 6f68 6f72  ers["multi_cohor
-00002ef0: 7422 5d2c 0a20 2020 2020 2020 2020 2020  t"],.           
-00002f00: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-00002f10: 656c 5f70 7265 7365 6e63 653d 7573 655f  el_presence=use_
-00002f20: 6c61 6265 6c73 2c0a 2020 2020 2020 2020  labels,.        
-00002f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f40: 6c61 6265 6c3d 7365 6c66 2e6c 6162 656c  label=self.label
-00002f50: 2069 6620 6c61 6265 6c20 6973 204e 6f6e   if label is Non
-00002f60: 6520 656c 7365 206c 6162 656c 2c0a 2020  e else label,.  
-00002f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f80: 2020 2020 2020 6c61 6265 6c5f 636f 6465        label_code
-00002f90: 3d28 0a20 2020 2020 2020 2020 2020 2020  =(.             
-00002fa0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00002fb0: 656c 662e 6c61 6265 6c5f 636f 6465 2069  elf.label_code i
-00002fc0: 6620 6c61 6265 6c5f 636f 6465 203d 3d20  f label_code == 
-00002fd0: 2264 6566 6175 6c74 2220 656c 7365 206c  "default" else l
-00002fe0: 6162 656c 5f63 6f64 650a 2020 2020 2020  abel_code.      
-00002ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003000: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00003010: 2020 2020 2020 2020 2020 2020 2063 6e6e               cnn
-00003020: 5f69 6e64 6578 3d6e 6574 776f 726b 2c0a  _index=network,.
-00003030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003040: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00003050: 2020 2020 2020 2020 2020 7465 7374 5f6c            test_l
-00003060: 6f61 6465 7220 3d20 4461 7461 4c6f 6164  oader = DataLoad
-00003070: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00003080: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00003090: 5f74 6573 742c 0a20 2020 2020 2020 2020  _test,.         
-000030a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000030b0: 6174 6368 5f73 697a 653d 280a 2020 2020  atch_size=(.    
-000030c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030d0: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
-000030e0: 7a65 2069 6620 6261 7463 685f 7369 7a65  ze if batch_size
-000030f0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-00003100: 6520 7365 6c66 2e62 6174 6368 5f73 697a  e self.batch_siz
-00003110: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00003120: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00000380: 6c2e 7574 696c 732e 6d61 7073 5f6d 616e  l.utils.maps_man
+00000390: 6167 6572 2e64 6470 2069 6d70 6f72 7420  ager.ddp import 
+000003a0: 4444 502c 2063 6c75 7374 6572 2c20 696e  DDP, cluster, in
+000003b0: 6974 5f64 6470 0a66 726f 6d20 636c 696e  it_ddp.from clin
+000003c0: 6963 6164 6c2e 7574 696c 732e 6d61 7073  icadl.utils.maps
+000003d0: 5f6d 616e 6167 6572 2e6c 6f67 7772 6974  _manager.logwrit
+000003e0: 6572 2069 6d70 6f72 7420 4c6f 6757 7269  er import LogWri
+000003f0: 7465 720a 6672 6f6d 2063 6c69 6e69 6361  ter.from clinica
+00000400: 646c 2e75 7469 6c73 2e6d 6170 735f 6d61  dl.utils.maps_ma
+00000410: 6e61 6765 722e 6d61 7073 5f6d 616e 6167  nager.maps_manag
+00000420: 6572 5f75 7469 6c73 2069 6d70 6f72 7420  er_utils import 
+00000430: 280a 2020 2020 6164 645f 6465 6661 756c  (.    add_defaul
+00000440: 745f 7661 6c75 6573 2c0a 2020 2020 7265  t_values,.    re
+00000450: 6164 5f6a 736f 6e2c 0a29 0a66 726f 6d20  ad_json,.).from 
+00000460: 636c 696e 6963 6164 6c2e 7574 696c 732e  clinicadl.utils.
+00000470: 6d65 7472 6963 5f6d 6f64 756c 6520 696d  metric_module im
+00000480: 706f 7274 2052 6574 6169 6e42 6573 740a  port RetainBest.
+00000490: 6672 6f6d 2063 6c69 6e69 6361 646c 2e75  from clinicadl.u
+000004a0: 7469 6c73 2e6e 6574 776f 726b 2e6e 6574  tils.network.net
+000004b0: 776f 726b 2069 6d70 6f72 7420 4e65 7477  work import Netw
+000004c0: 6f72 6b0a 6672 6f6d 2063 6c69 6e69 6361  ork.from clinica
+000004d0: 646c 2e75 7469 6c73 2e70 7265 7072 6f63  dl.utils.preproc
+000004e0: 6573 7369 6e67 2069 6d70 6f72 7420 7061  essing import pa
+000004f0: 7468 5f64 6563 6f64 6572 2c20 7061 7468  th_decoder, path
+00000500: 5f65 6e63 6f64 6572 0a66 726f 6d20 636c  _encoder.from cl
+00000510: 696e 6963 6164 6c2e 7574 696c 732e 7365  inicadl.utils.se
+00000520: 6564 2069 6d70 6f72 7420 6765 745f 7365  ed import get_se
+00000530: 6564 2c20 706c 5f77 6f72 6b65 725f 696e  ed, pl_worker_in
+00000540: 6974 5f66 756e 6374 696f 6e2c 2073 6565  it_function, see
+00000550: 645f 6576 6572 7974 6869 6e67 0a0a 6c6f  d_everything..lo
+00000560: 6767 6572 203d 2067 6574 4c6f 6767 6572  gger = getLogger
+00000570: 2822 636c 696e 6963 6164 6c2e 6d61 7073  ("clinicadl.maps
+00000580: 5f6d 616e 6167 6572 2229 0a6c 6576 656c  _manager").level
+00000590: 5f6c 6973 743a 204c 6973 745b 7374 725d  _list: List[str]
+000005a0: 203d 205b 2277 6172 6e69 6e67 222c 2022   = ["warning", "
+000005b0: 696e 666f 222c 2022 6465 6275 6722 5d0a  info", "debug"].
+000005c0: 0a0a 2320 544f 444f 2073 6176 6520 7765  ..# TODO save we
+000005d0: 6967 6874 7320 6f6e 2043 5055 2066 6f72  ights on CPU for
+000005e0: 2062 6574 7465 7220 636f 6d70 6174 6962   better compatib
+000005f0: 696c 6974 790a 0a0a 636c 6173 7320 4d61  ility...class Ma
+00000600: 7073 4d61 6e61 6765 723a 0a20 2020 2064  psManager:.    d
+00000610: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00000620: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00000630: 2020 206d 6170 735f 7061 7468 3a20 5061     maps_path: Pa
+00000640: 7468 2c0a 2020 2020 2020 2020 7061 7261  th,.        para
+00000650: 6d65 7465 7273 3a20 4469 6374 5b73 7472  meters: Dict[str
+00000660: 2c20 416e 795d 203d 204e 6f6e 652c 0a20  , Any] = None,. 
+00000670: 2020 2020 2020 2076 6572 626f 7365 3a20         verbose: 
+00000680: 7374 7220 3d20 2269 6e66 6f22 2c0a 2020  str = "info",.  
+00000690: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+000006a0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+000006b0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+000006c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+000006d0: 6d61 7073 5f70 6174 683a 2073 7472 2028  maps_path: str (
+000006e0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+000006f0: 2020 5061 7468 206f 6620 7468 6520 4d41    Path of the MA
+00000700: 5053 0a20 2020 2020 2020 2070 6172 616d  PS.        param
+00000710: 6574 6572 733a 2044 6963 745b 7374 722c  eters: Dict[str,
+00000720: 2041 6e79 5d0a 2020 2020 2020 2020 2020   Any].          
+00000730: 2020 5061 7261 6d65 7465 7273 206f 6620    Parameters of 
+00000740: 7468 6520 7472 6169 6e69 6e67 2073 7465  the training ste
+00000750: 702e 2049 6620 6769 7665 6e20 6120 6e65  p. If given a ne
+00000760: 7720 4d41 5053 2069 7320 6372 6561 7465  w MAPS is create
+00000770: 642e 0a20 2020 2020 2020 2076 6572 626f  d..        verbo
+00000780: 7365 3a20 7374 720a 2020 2020 2020 2020  se: str.        
+00000790: 2020 2020 4c6f 6767 696e 6720 6c65 7665      Logging leve
+000007a0: 6c20 2822 6465 6275 6722 2c20 2269 6e66  l ("debug", "inf
+000007b0: 6f22 2c20 2277 6172 6e69 6e67 2229 0a20  o", "warning"). 
+000007c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000007d0: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
+000007e0: 6820 3d20 6d61 7073 5f70 6174 682e 7265  h = maps_path.re
+000007f0: 736f 6c76 6528 290a 0a20 2020 2020 2020  solve()..       
+00000800: 2023 2045 7869 7374 696e 6720 4d41 5053   # Existing MAPS
+00000810: 0a20 2020 2020 2020 2069 6620 7061 7261  .        if para
+00000820: 6d65 7465 7273 2069 7320 4e6f 6e65 3a0a  meters is None:.
+00000830: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00000840: 6f74 2028 6d61 7073 5f70 6174 6820 2f20  ot (maps_path / 
+00000850: 226d 6170 732e 6a73 6f6e 2229 2e69 735f  "maps.json").is_
+00000860: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
+00000870: 2020 2020 2020 2020 7261 6973 6520 4d41          raise MA
+00000880: 5053 4572 726f 7228 0a20 2020 2020 2020  PSError(.       
+00000890: 2020 2020 2020 2020 2020 2020 2066 224d               f"M
+000008a0: 4150 5320 7761 7320 6e6f 7420 666f 756e  APS was not foun
+000008b0: 6420 6174 207b 6d61 7073 5f70 6174 687d  d at {maps_path}
+000008c0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+000008d0: 2020 2020 2020 2066 2254 6f20 696e 6974         f"To init
+000008e0: 6961 7465 2061 206e 6577 204d 4150 5320  iate a new MAPS 
+000008f0: 706c 6561 7365 2067 6976 6520 6120 7472  please give a tr
+00000900: 6169 6e5f 6469 6374 2e22 0a20 2020 2020  ain_dict.".     
+00000910: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00000920: 2020 2020 2020 2020 2074 6573 745f 7061           test_pa
+00000930: 7261 6d65 7465 7273 203d 2073 656c 662e  rameters = self.
+00000940: 6765 745f 7061 7261 6d65 7465 7273 2829  get_parameters()
+00000950: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00000960: 6573 745f 7061 7261 6d65 7465 7273 203d  est_parameters =
+00000970: 2070 6174 685f 6465 636f 6465 7228 7465   path_decoder(te
+00000980: 7374 5f70 6172 616d 6574 6572 7329 0a20  st_parameters). 
+00000990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000009a0: 7061 7261 6d65 7465 7273 203d 2061 6464  parameters = add
+000009b0: 5f64 6566 6175 6c74 5f76 616c 7565 7328  _default_values(
+000009c0: 7465 7374 5f70 6172 616d 6574 6572 7329  test_parameters)
+000009d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000009e0: 662e 7373 6461 5f6e 6574 776f 726b 203d  f.ssda_network =
+000009f0: 2046 616c 7365 2020 2320 4120 4d4f 4449   False  # A MODI
+00000a00: 4649 4552 0a20 2020 2020 2020 2020 2020  FIER.           
+00000a10: 2073 656c 662e 7361 7665 5f61 6c6c 5f6d   self.save_all_m
+00000a20: 6f64 656c 7320 3d20 7365 6c66 2e70 6172  odels = self.par
+00000a30: 616d 6574 6572 735b 2273 6176 655f 616c  ameters["save_al
+00000a40: 6c5f 6d6f 6465 6c73 225d 0a20 2020 2020  l_models"].     
+00000a50: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+00000a60: 5f6d 616e 6167 6572 203d 2073 656c 662e  _manager = self.
+00000a70: 5f69 6e69 745f 7461 736b 5f6d 616e 6167  _init_task_manag
+00000a80: 6572 286e 5f63 6c61 7373 6573 3d73 656c  er(n_classes=sel
+00000a90: 662e 6f75 7470 7574 5f73 697a 6529 0a20  f.output_size). 
+00000aa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000ab0: 7370 6c69 745f 6e61 6d65 203d 2028 0a20  split_name = (. 
+00000ac0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00000ad0: 656c 662e 5f63 6865 636b 5f73 706c 6974  elf._check_split
+00000ae0: 5f77 6f72 6469 6e67 2829 0a20 2020 2020  _wording().     
+00000af0: 2020 2020 2020 2029 2020 2320 5573 6564         )  # Used
+00000b00: 206f 6e6c 7920 666f 7220 7265 7472 6f2d   only for retro-
+00000b10: 636f 6d70 6174 6962 696c 6974 790a 0a20  compatibility.. 
+00000b20: 2020 2020 2020 2023 2049 6e69 7469 6174         # Initiat
+00000b30: 6520 4d41 5053 0a20 2020 2020 2020 2065  e MAPS.        e
+00000b40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00000b50: 2073 656c 662e 5f63 6865 636b 5f61 7267   self._check_arg
+00000b60: 7328 7061 7261 6d65 7465 7273 290a 2020  s(parameters).  
+00000b70: 2020 2020 2020 2020 2020 7061 7261 6d65            parame
+00000b80: 7465 7273 5b22 7473 765f 7061 7468 225d  ters["tsv_path"]
+00000b90: 203d 2050 6174 6828 7061 7261 6d65 7465   = Path(paramete
+00000ba0: 7273 5b22 7473 765f 7061 7468 225d 290a  rs["tsv_path"]).
+00000bb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00000bc0: 662e 7370 6c69 745f 6e61 6d65 203d 2022  f.split_name = "
+00000bd0: 7370 6c69 7422 2020 2320 5573 6564 206f  split"  # Used o
+00000be0: 6e6c 7920 666f 7220 7265 7472 6f2d 636f  nly for retro-co
+00000bf0: 6d70 6174 6962 696c 6974 790a 2020 2020  mpatibility.    
+00000c00: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
+00000c10: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
+00000c20: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
+00000c30: 6170 735f 7061 7468 2e69 735f 6469 7228  aps_path.is_dir(
+00000c40: 2920 616e 6420 6d61 7073 5f70 6174 682e  ) and maps_path.
+00000c50: 6973 5f66 696c 6528 2929 206f 7220 2820  is_file()) or ( 
+00000c60: 2023 204e 6f6e 2d66 6f6c 6465 7220 6669   # Non-folder fi
+00000c70: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+00000c80: 2020 2020 2020 206d 6170 735f 7061 7468         maps_path
+00000c90: 2e69 735f 6469 7228 2920 616e 6420 6c69  .is_dir() and li
+00000ca0: 7374 286d 6170 735f 7061 7468 2e69 7465  st(maps_path.ite
+00000cb0: 7264 6972 2829 2920 2023 204e 6f6e 2065  rdir())  # Non e
+00000cc0: 6d70 7479 2066 6f6c 6465 720a 2020 2020  mpty folder.    
+00000cd0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+00000ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000cf0: 2020 2072 6169 7365 204d 4150 5345 7272     raise MAPSErr
+00000d00: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00000d10: 2020 2020 2020 2020 2020 2020 6622 596f              f"Yo
+00000d20: 7520 6172 6520 7472 7969 6e67 2074 6f20  u are trying to 
+00000d30: 6372 6561 7465 2061 206e 6577 204d 4150  create a new MAP
+00000d40: 5320 6174 207b 6d61 7073 5f70 6174 687d  S at {maps_path}
+00000d50: 2062 7574 2022 0a20 2020 2020 2020 2020   but ".         
+00000d60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00000d70: 2274 6869 7320 616c 7265 6164 7920 636f  "this already co
+00000d80: 7272 6573 706f 6e64 7320 746f 2061 2066  rresponds to a f
+00000d90: 696c 6520 6f72 2061 206e 6f6e 2d65 6d70  ile or a non-emp
+00000da0: 7479 2066 6f6c 6465 722e 205c 6e22 0a20  ty folder. \n". 
+00000db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000dc0: 2020 2020 2020 2066 2250 6c65 6173 6520         f"Please 
+00000dd0: 7265 6d6f 7665 2069 7420 6f72 2063 686f  remove it or cho
+00000de0: 6f73 6520 616e 6f74 6865 7220 6c6f 6361  ose another loca
+00000df0: 7469 6f6e 2e22 0a20 2020 2020 2020 2020  tion.".         
+00000e00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00000e10: 2020 2020 2020 2020 2020 2020 2028 6d61               (ma
+00000e20: 7073 5f70 6174 6820 2f20 2267 726f 7570  ps_path / "group
+00000e30: 7322 292e 6d6b 6469 7228 7061 7265 6e74  s").mkdir(parent
+00000e40: 733d 5472 7565 290a 0a20 2020 2020 2020  s=True)..       
+00000e50: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00000e60: 696e 666f 2866 2241 206e 6577 204d 4150  info(f"A new MAP
+00000e70: 5320 7761 7320 6372 6561 7465 6420 6174  S was created at
+00000e80: 207b 6d61 7073 5f70 6174 687d 2229 0a20   {maps_path}"). 
+00000e90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00000ea0: 656c 662e 7772 6974 655f 7061 7261 6d65  elf.write_parame
+00000eb0: 7465 7273 2873 656c 662e 6d61 7073 5f70  ters(self.maps_p
+00000ec0: 6174 682c 2073 656c 662e 7061 7261 6d65  ath, self.parame
+00000ed0: 7465 7273 290a 2020 2020 2020 2020 2020  ters).          
+00000ee0: 2020 2020 2020 7365 6c66 2e5f 7772 6974        self._writ
+00000ef0: 655f 7265 7175 6972 656d 656e 7473 5f76  e_requirements_v
+00000f00: 6572 7369 6f6e 2829 0a20 2020 2020 2020  ersion().       
+00000f10: 2020 2020 2020 2020 2073 656c 662e 5f77           self._w
+00000f20: 7269 7465 5f74 7261 696e 696e 675f 6461  rite_training_da
+00000f30: 7461 2829 0a20 2020 2020 2020 2020 2020  ta().           
+00000f40: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
+00000f50: 5f74 7261 696e 5f76 616c 5f67 726f 7570  _train_val_group
+00000f60: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00000f70: 2020 2020 7365 6c66 2e5f 7772 6974 655f      self._write_
+00000f80: 696e 666f 726d 6174 696f 6e28 290a 0a20  information().. 
+00000f90: 2020 2020 2020 2069 6e69 745f 6464 7028         init_ddp(
+00000fa0: 6770 753d 7365 6c66 2e70 6172 616d 6574  gpu=self.paramet
+00000fb0: 6572 735b 2267 7075 225d 2c20 6c6f 6767  ers["gpu"], logg
+00000fc0: 6572 3d6c 6f67 6765 7229 0a0a 2020 2020  er=logger)..    
+00000fd0: 6465 6620 5f5f 6765 7461 7474 725f 5f28  def __getattr__(
+00000fe0: 7365 6c66 2c20 6e61 6d65 293a 0a20 2020  self, name):.   
+00000ff0: 2020 2020 2022 2222 416c 6c6f 7720 746f       """Allow to
+00001000: 2064 6972 6563 746c 7920 6765 7420 7468   directly get th
+00001010: 6520 7661 6c75 6573 2069 6e20 7061 7261  e values in para
+00001020: 6d65 7465 7273 2061 7474 7269 6275 7465  meters attribute
+00001030: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+00001040: 616d 6520 696e 2073 656c 662e 7061 7261  ame in self.para
+00001050: 6d65 7465 7273 3a0a 2020 2020 2020 2020  meters:.        
+00001060: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00001070: 7061 7261 6d65 7465 7273 5b6e 616d 655d  parameters[name]
+00001080: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00001090: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000010a0: 2041 7474 7269 6275 7465 4572 726f 7228   AttributeError(
+000010b0: 6622 274d 6170 734d 616e 6167 6572 2720  f"'MapsManager' 
+000010c0: 6f62 6a65 6374 2068 6173 206e 6f20 6174  object has no at
+000010d0: 7472 6962 7574 6520 277b 6e61 6d65 7d27  tribute '{name}'
+000010e0: 2229 0a0a 2020 2020 6465 6620 7472 6169  ")..    def trai
+000010f0: 6e28 7365 6c66 2c20 7370 6c69 745f 6c69  n(self, split_li
+00001100: 7374 3a20 4c69 7374 5b69 6e74 5d20 3d20  st: List[int] = 
+00001110: 4e6f 6e65 2c20 6f76 6572 7772 6974 653a  None, overwrite:
+00001120: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
+00001130: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00001140: 2020 2020 5065 7266 6f72 6d73 2074 6865      Performs the
+00001150: 2074 7261 696e 696e 6720 7461 736b 2066   training task f
+00001160: 6f72 2061 2064 6566 696e 6564 206c 6973  or a defined lis
+00001170: 7420 6f66 2073 706c 6974 730a 0a20 2020  t of splits..   
+00001180: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+00001190: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000011a0: 2d2d 0a20 2020 2020 2020 2073 706c 6974  --.        split
+000011b0: 5f6c 6973 743a 204c 6973 745b 696e 745d  _list: List[int]
+000011c0: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
+000011d0: 7420 6f66 2073 706c 6974 7320 6f6e 2077  t of splits on w
+000011e0: 6869 6368 2074 6865 2074 7261 696e 696e  hich the trainin
+000011f0: 6720 7461 736b 2069 7320 7065 7266 6f72  g task is perfor
+00001200: 6d65 642e 0a20 2020 2020 2020 2020 2020  med..           
+00001210: 2044 6566 6175 6c74 2074 7261 696e 7320   Default trains 
+00001220: 616c 6c20 7370 6c69 7473 206f 6620 7468  all splits of th
+00001230: 6520 6372 6f73 732d 7661 6c69 6461 7469  e cross-validati
+00001240: 6f6e 2e0a 2020 2020 2020 2020 6f76 6572  on..        over
+00001250: 7772 6974 653a 2062 6f6f 6c0a 2020 2020  write: bool.    
+00001260: 2020 2020 2020 2020 4966 2054 7275 6520          If True 
+00001270: 7072 6576 696f 7573 6c79 2074 7261 696e  previously train
+00001280: 6564 2073 706c 6974 7320 7468 6174 2061  ed splits that a
+00001290: 7265 2067 6f69 6e67 2074 6f20 6265 2074  re going to be t
+000012a0: 7261 696e 6564 2061 7265 2065 7261 7365  rained are erase
+000012b0: 642e 0a0a 2020 2020 2020 2020 5261 6973  d...        Rais
+000012c0: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
+000012d0: 2d0a 2020 2020 2020 2020 5261 6973 6573  -.        Raises
+000012e0: 204d 4150 5345 7272 6f72 2c20 6966 2073   MAPSError, if s
+000012f0: 706c 6974 7320 7370 6563 6966 6965 6420  plits specified 
+00001300: 696e 2069 6e70 7574 2061 6c72 6561 6479  in input already
+00001310: 2065 7869 7374 2061 6e64 206f 7665 7277   exist and overw
+00001320: 7269 7465 2069 7320 4661 6c73 652e 0a20  rite is False.. 
+00001330: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00001340: 2020 2065 7869 7374 696e 675f 7370 6c69     existing_spli
+00001350: 7473 203d 205b 5d0a 0a20 2020 2020 2020  ts = []..       
+00001360: 2073 706c 6974 5f6d 616e 6167 6572 203d   split_manager =
+00001370: 2073 656c 662e 5f69 6e69 745f 7370 6c69   self._init_spli
+00001380: 745f 6d61 6e61 6765 7228 7370 6c69 745f  t_manager(split_
+00001390: 6c69 7374 290a 2020 2020 2020 2020 666f  list).        fo
+000013a0: 7220 7370 6c69 7420 696e 2073 706c 6974  r split in split
+000013b0: 5f6d 616e 6167 6572 2e73 706c 6974 5f69  _manager.split_i
+000013c0: 7465 7261 746f 7228 293a 0a20 2020 2020  terator():.     
+000013d0: 2020 2020 2020 2073 706c 6974 5f70 6174         split_pat
+000013e0: 6820 3d20 7365 6c66 2e6d 6170 735f 7061  h = self.maps_pa
+000013f0: 7468 202f 2066 227b 7365 6c66 2e73 706c  th / f"{self.spl
+00001400: 6974 5f6e 616d 657d 2d7b 7370 6c69 747d  it_name}-{split}
+00001410: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
+00001420: 2073 706c 6974 5f70 6174 682e 6973 5f64   split_path.is_d
+00001430: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+00001440: 2020 2020 2020 6966 206f 7665 7277 7269        if overwri
+00001450: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00001460: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
+00001470: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
+00001480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001490: 2020 2073 6875 7469 6c2e 726d 7472 6565     shutil.rmtree
+000014a0: 2873 706c 6974 5f70 6174 6829 0a20 2020  (split_path).   
+000014b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000014c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000014d0: 2020 2020 2020 2065 7869 7374 696e 675f         existing_
+000014e0: 7370 6c69 7473 2e61 7070 656e 6428 7370  splits.append(sp
+000014f0: 6c69 7429 0a0a 2020 2020 2020 2020 6966  lit)..        if
+00001500: 206c 656e 2865 7869 7374 696e 675f 7370   len(existing_sp
+00001510: 6c69 7473 2920 3e20 303a 0a20 2020 2020  lits) > 0:.     
+00001520: 2020 2020 2020 2072 6169 7365 204d 4150         raise MAP
+00001530: 5345 7272 6f72 280a 2020 2020 2020 2020  SError(.        
+00001540: 2020 2020 2020 2020 6622 5370 6c69 7473          f"Splits
+00001550: 207b 6578 6973 7469 6e67 5f73 706c 6974   {existing_split
+00001560: 737d 2061 6c72 6561 6479 2065 7869 7374  s} already exist
+00001570: 2e20 506c 6561 7365 2022 0a20 2020 2020  . Please ".     
+00001580: 2020 2020 2020 2020 2020 2066 2273 7065             f"spe
+00001590: 6369 6679 2061 206c 6973 7420 6f66 2073  cify a list of s
+000015a0: 706c 6974 7320 6e6f 7420 696e 7465 7273  plits not inters
+000015b0: 6563 7469 6e67 2074 6865 2070 7265 7669  ecting the previ
+000015c0: 6f75 7320 6c69 7374 2c20 220a 2020 2020  ous list, ".    
+000015d0: 2020 2020 2020 2020 2020 2020 6622 6f72              f"or
+000015e0: 2075 7365 206f 7665 7277 7269 7465 2074   use overwrite t
+000015f0: 6f20 6572 6173 6520 7072 6576 696f 7573  o erase previous
+00001600: 6c79 2074 7261 696e 6564 2073 706c 6974  ly trained split
+00001610: 732e 220a 2020 2020 2020 2020 2020 2020  s.".            
+00001620: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00001630: 6c66 2e6d 756c 7469 5f6e 6574 776f 726b  lf.multi_network
+00001640: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00001650: 6c66 2e5f 7472 6169 6e5f 6d75 6c74 6928  lf._train_multi(
+00001660: 7370 6c69 745f 6c69 7374 2c20 7265 7375  split_list, resu
+00001670: 6d65 3d46 616c 7365 290a 2020 2020 2020  me=False).      
+00001680: 2020 656c 6966 2073 656c 662e 7373 6461    elif self.ssda
+00001690: 5f6e 6574 776f 726b 3a0a 2020 2020 2020  _network:.      
+000016a0: 2020 2020 2020 7365 6c66 2e5f 7472 6169        self._trai
+000016b0: 6e5f 7373 6461 2873 706c 6974 5f6c 6973  n_ssda(split_lis
+000016c0: 742c 2072 6573 756d 653d 4661 6c73 6529  t, resume=False)
+000016d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000016e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000016f0: 5f74 7261 696e 5f73 696e 676c 6528 7370  _train_single(sp
+00001700: 6c69 745f 6c69 7374 2c20 7265 7375 6d65  lit_list, resume
+00001710: 3d46 616c 7365 290a 0a20 2020 2064 6566  =False)..    def
+00001720: 2072 6573 756d 6528 7365 6c66 2c20 7370   resume(self, sp
+00001730: 6c69 745f 6c69 7374 3a20 4c69 7374 5b69  lit_list: List[i
+00001740: 6e74 5d20 3d20 4e6f 6e65 293a 0a20 2020  nt] = None):.   
+00001750: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00001760: 2052 6573 756d 6573 2074 6865 2074 7261   Resumes the tra
+00001770: 696e 696e 6720 7461 736b 2066 6f72 2061  ining task for a
+00001780: 2064 6566 696e 6564 206c 6973 7420 6f66   defined list of
+00001790: 2073 706c 6974 732e 0a0a 2020 2020 2020   splits...      
+000017a0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+000017b0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+000017c0: 2020 2020 2020 2020 7370 6c69 745f 6c69          split_li
+000017d0: 7374 3a20 4c69 7374 0a20 2020 2020 2020  st: List.       
+000017e0: 2020 2020 206c 6973 7420 6f66 2073 706c       list of spl
+000017f0: 6974 7320 6f6e 2077 6869 6368 2074 6865  its on which the
+00001800: 2074 7261 696e 696e 6720 7461 736b 2069   training task i
+00001810: 7320 7065 7266 6f72 6d65 642e 0a20 2020  s performed..   
+00001820: 2020 2020 2020 2020 2020 2020 2044 6566               Def
+00001830: 6175 6c74 2074 7261 696e 7320 616c 6c20  ault trains all 
+00001840: 7370 6c69 7473 2e0a 0a20 2020 2020 2020  splits...       
+00001850: 2052 6169 7365 730a 2020 2020 2020 2020   Raises.        
+00001860: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 204d  ------.        M
+00001870: 4150 5345 7272 6f72 3a0a 2020 2020 2020  APSError:.      
+00001880: 2020 2020 2020 4966 2073 706c 6974 7320        If splits 
+00001890: 7370 6563 6966 6965 6420 696e 2069 6e70  specified in inp
+000018a0: 7574 2064 6f20 6e6f 7420 6578 6973 742e  ut do not exist.
+000018b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000018c0: 2020 2020 206d 6973 7369 6e67 5f73 706c       missing_spl
+000018d0: 6974 7320 3d20 5b5d 0a20 2020 2020 2020  its = [].       
+000018e0: 2073 706c 6974 5f6d 616e 6167 6572 203d   split_manager =
+000018f0: 2073 656c 662e 5f69 6e69 745f 7370 6c69   self._init_spli
+00001900: 745f 6d61 6e61 6765 7228 7370 6c69 745f  t_manager(split_
+00001910: 6c69 7374 290a 0a20 2020 2020 2020 2066  list)..        f
+00001920: 6f72 2073 706c 6974 2069 6e20 7370 6c69  or split in spli
+00001930: 745f 6d61 6e61 6765 722e 7370 6c69 745f  t_manager.split_
+00001940: 6974 6572 6174 6f72 2829 3a0a 2020 2020  iterator():.    
+00001950: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+00001960: 7365 6c66 2e6d 6170 735f 7061 7468 202f  self.maps_path /
+00001970: 2066 227b 7365 6c66 2e73 706c 6974 5f6e   f"{self.split_n
+00001980: 616d 657d 2d7b 7370 6c69 747d 2220 2f20  ame}-{split}" / 
+00001990: 2274 6d70 2229 2e69 735f 6469 7228 293a  "tmp").is_dir():
+000019a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000019b0: 206d 6973 7369 6e67 5f73 706c 6974 732e   missing_splits.
+000019c0: 6170 7065 6e64 2873 706c 6974 290a 0a20  append(split).. 
+000019d0: 2020 2020 2020 2069 6620 6c65 6e28 6d69         if len(mi
+000019e0: 7373 696e 675f 7370 6c69 7473 2920 3e20  ssing_splits) > 
+000019f0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00001a00: 6169 7365 204d 4150 5345 7272 6f72 280a  aise MAPSError(.
+00001a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a20: 6622 5370 6c69 7473 207b 6d69 7373 696e  f"Splits {missin
+00001a30: 675f 7370 6c69 7473 7d20 7765 7265 206e  g_splits} were n
+00001a40: 6f74 2069 6e69 7469 616c 697a 6564 2e20  ot initialized. 
+00001a50: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00001a60: 2020 6622 506c 6561 7365 2074 7279 2074    f"Please try t
+00001a70: 7261 696e 2063 6f6d 6d61 6e64 206f 6e20  rain command on 
+00001a80: 7468 6573 6520 7370 6c69 7473 2061 6e64  these splits and
+00001a90: 2072 6573 756d 6520 6f6e 6c79 206f 7468   resume only oth
+00001aa0: 6572 732e 220a 2020 2020 2020 2020 2020  ers.".          
+00001ab0: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+00001ac0: 7365 6c66 2e6d 756c 7469 5f6e 6574 776f  self.multi_netwo
+00001ad0: 726b 3a0a 2020 2020 2020 2020 2020 2020  rk:.            
+00001ae0: 7365 6c66 2e5f 7472 6169 6e5f 6d75 6c74  self._train_mult
+00001af0: 6928 7370 6c69 745f 6c69 7374 2c20 7265  i(split_list, re
+00001b00: 7375 6d65 3d54 7275 6529 0a20 2020 2020  sume=True).     
+00001b10: 2020 2065 6c69 6620 7365 6c66 2e73 7364     elif self.ssd
+00001b20: 615f 6e65 7477 6f72 6b3a 0a20 2020 2020  a_network:.     
+00001b30: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
+00001b40: 696e 5f73 7364 6128 7370 6c69 745f 6c69  in_ssda(split_li
+00001b50: 7374 2c20 7265 7375 6d65 3d54 7275 6529  st, resume=True)
+00001b60: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00001b70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00001b80: 5f74 7261 696e 5f73 696e 676c 6528 7370  _train_single(sp
+00001b90: 6c69 745f 6c69 7374 2c20 7265 7375 6d65  lit_list, resume
+00001ba0: 3d54 7275 6529 0a0a 2020 2020 6465 6620  =True)..    def 
+00001bb0: 7072 6564 6963 7428 0a20 2020 2020 2020  predict(.       
+00001bc0: 2073 656c 662c 0a20 2020 2020 2020 2064   self,.        d
+00001bd0: 6174 615f 6772 6f75 703a 2073 7472 2c0a  ata_group: str,.
+00001be0: 2020 2020 2020 2020 6361 7073 5f64 6972          caps_dir
+00001bf0: 6563 746f 7279 3a20 5061 7468 203d 204e  ectory: Path = N
+00001c00: 6f6e 652c 0a20 2020 2020 2020 2074 7376  one,.        tsv
+00001c10: 5f70 6174 683a 2050 6174 6820 3d20 4e6f  _path: Path = No
+00001c20: 6e65 2c0a 2020 2020 2020 2020 7370 6c69  ne,.        spli
+00001c30: 745f 6c69 7374 3a20 4c69 7374 5b69 6e74  t_list: List[int
+00001c40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00001c50: 2020 7365 6c65 6374 696f 6e5f 6d65 7472    selection_metr
+00001c60: 6963 733a 204c 6973 745b 7374 725d 203d  ics: List[str] =
+00001c70: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00001c80: 756c 7469 5f63 6f68 6f72 743a 2062 6f6f  ulti_cohort: boo
+00001c90: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00001ca0: 2020 2064 6961 676e 6f73 6573 3a20 4c69     diagnoses: Li
+00001cb0: 7374 5b73 7472 5d20 3d20 2829 2c0a 2020  st[str] = (),.  
+00001cc0: 2020 2020 2020 7573 655f 6c61 6265 6c73        use_labels
+00001cd0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00001ce0: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
+00001cf0: 653a 2069 6e74 203d 204e 6f6e 652c 0a20  e: int = None,. 
+00001d00: 2020 2020 2020 206e 5f70 726f 633a 2069         n_proc: i
+00001d10: 6e74 203d 204e 6f6e 652c 0a20 2020 2020  nt = None,.     
+00001d20: 2020 2067 7075 3a20 626f 6f6c 203d 204e     gpu: bool = N
+00001d30: 6f6e 652c 0a20 2020 2020 2020 2061 6d70  one,.        amp
+00001d40: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00001d50: 2020 2020 2020 2020 6f76 6572 7772 6974          overwrit
+00001d60: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+00001d70: 0a20 2020 2020 2020 206c 6162 656c 3a20  .        label: 
+00001d80: 7374 7220 3d20 4e6f 6e65 2c0a 2020 2020  str = None,.    
+00001d90: 2020 2020 6c61 6265 6c5f 636f 6465 3a20      label_code: 
+00001da0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+00001db0: 722c 2069 6e74 5d5d 203d 2022 6465 6661  r, int]] = "defa
+00001dc0: 756c 7422 2c0a 2020 2020 2020 2020 7361  ult",.        sa
+00001dd0: 7665 5f74 656e 736f 723a 2062 6f6f 6c20  ve_tensor: bool 
+00001de0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00001df0: 2073 6176 655f 6e69 6674 693a 2062 6f6f   save_nifti: boo
+00001e00: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00001e10: 2020 2073 6176 655f 6c61 7465 6e74 5f74     save_latent_t
+00001e20: 656e 736f 723a 2062 6f6f 6c20 3d20 4661  ensor: bool = Fa
+00001e30: 6c73 652c 0a20 2020 2020 2020 2073 6b69  lse,.        ski
+00001e40: 705f 6c65 616b 5f63 6865 636b 3a20 626f  p_leak_check: bo
+00001e50: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00001e60: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00001e70: 2020 2020 2020 2050 6572 666f 726d 7320         Performs 
+00001e80: 7468 6520 7072 6564 6963 7469 6f6e 2074  the prediction t
+00001e90: 6173 6b20 6f6e 2061 2073 7562 7365 7420  ask on a subset 
+00001ea0: 6f66 2063 6170 735f 6469 7265 6374 6f72  of caps_director
+00001eb0: 7920 6465 6669 6e65 6420 696e 2061 2054  y defined in a T
+00001ec0: 5356 2066 696c 652e 0a0a 2020 2020 2020  SV file...      
+00001ed0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00001ee0: 2020 2020 6461 7461 5f67 726f 7570 3a20      data_group: 
+00001ef0: 6e61 6d65 206f 6620 7468 6520 6461 7461  name of the data
+00001f00: 2067 726f 7570 2074 6573 7465 642e 0a20   group tested.. 
+00001f10: 2020 2020 2020 2020 2020 2063 6170 735f             caps_
+00001f20: 6469 7265 6374 6f72 793a 2070 6174 6820  directory: path 
+00001f30: 746f 2074 6865 2043 4150 5320 666f 6c64  to the CAPS fold
+00001f40: 6572 2e20 466f 7220 6d6f 7265 2069 6e66  er. For more inf
+00001f50: 6f72 6d61 7469 6f6e 2070 6c65 6173 6520  ormation please 
+00001f60: 7265 6665 7220 746f 0a20 2020 2020 2020  refer to.       
+00001f70: 2020 2020 2020 2020 205b 636c 696e 6963           [clinic
+00001f80: 6120 646f 6375 6d65 6e74 6174 696f 6e5d  a documentation]
+00001f90: 2868 7474 7073 3a2f 2f61 7261 6d69 736c  (https://aramisl
+00001fa0: 6162 2e70 6172 6973 2e69 6e72 6961 2e66  ab.paris.inria.f
+00001fb0: 722f 636c 696e 6963 612f 646f 6373 2f70  r/clinica/docs/p
+00001fc0: 7562 6c69 632f 6c61 7465 7374 2f43 4150  ublic/latest/CAP
+00001fd0: 532f 496e 7472 6f64 7563 7469 6f6e 2f29  S/Introduction/)
+00001fe0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00001ff0: 2020 4465 6661 756c 7420 7769 6c6c 206c    Default will l
+00002000: 6f61 6420 7468 6520 7661 6c75 6520 6f66  oad the value of
+00002010: 2061 6e20 6578 6973 7469 6e67 2064 6174   an existing dat
+00002020: 6120 6772 6f75 700a 2020 2020 2020 2020  a group.        
+00002030: 2020 2020 7473 765f 7061 7468 3a20 7061      tsv_path: pa
+00002040: 7468 2074 6f20 6120 5453 5620 6669 6c65  th to a TSV file
+00002050: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
+00002060: 6c69 7374 206f 6620 7061 7274 6963 6970  list of particip
+00002070: 616e 7473 2061 6e64 2073 6573 7369 6f6e  ants and session
+00002080: 7320 746f 2074 6573 742e 0a20 2020 2020  s to test..     
+00002090: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
+000020a0: 6c74 2077 696c 6c20 6c6f 6164 2074 6865  lt will load the
+000020b0: 2044 6174 6146 7261 6d65 206f 6620 616e   DataFrame of an
+000020c0: 2065 7869 7374 696e 6720 6461 7461 2067   existing data g
+000020d0: 726f 7570 0a20 2020 2020 2020 2020 2020  roup.           
+000020e0: 2073 706c 6974 5f6c 6973 743a 206c 6973   split_list: lis
+000020f0: 7420 6f66 2073 706c 6974 7320 746f 2074  t of splits to t
+00002100: 6573 742e 2044 6566 6175 6c74 2070 6572  est. Default per
+00002110: 666f 726d 2070 7265 6469 6374 696f 6e20  form prediction 
+00002120: 6f6e 2061 6c6c 2073 706c 6974 7320 6176  on all splits av
+00002130: 6169 6c61 626c 652e 0a20 2020 2020 2020  ailable..       
+00002140: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
+00002150: 6574 7269 6373 2028 6c69 7374 5b73 7472  etrics (list[str
+00002160: 5d29 3a20 6c69 7374 206f 6620 7365 6c65  ]): list of sele
+00002170: 6374 696f 6e20 6d65 7472 6963 7320 746f  ction metrics to
+00002180: 2074 6573 742e 0a20 2020 2020 2020 2020   test..         
+00002190: 2020 2020 2020 2044 6566 6175 6c74 2070         Default p
+000021a0: 6572 666f 726d 7320 7468 6520 7072 6564  erforms the pred
+000021b0: 6963 7469 6f6e 206f 6e20 616c 6c20 7365  iction on all se
+000021c0: 6c65 6374 696f 6e20 6d65 7472 6963 7320  lection metrics 
+000021d0: 6176 6169 6c61 626c 652e 0a20 2020 2020  available..     
+000021e0: 2020 2020 2020 206d 756c 7469 5f63 6f68         multi_coh
+000021f0: 6f72 743a 2049 6620 5472 7565 2063 6f6e  ort: If True con
+00002200: 7369 6465 7273 2074 6861 7420 7473 765f  siders that tsv_
+00002210: 7061 7468 2069 7320 7468 6520 7061 7468  path is the path
+00002220: 2074 6f20 6120 6d75 6c74 692d 636f 686f   to a multi-coho
+00002230: 7274 2054 5356 2e0a 2020 2020 2020 2020  rt TSV..        
+00002240: 2020 2020 6469 6167 6e6f 7365 733a 204c      diagnoses: L
+00002250: 6973 7420 6f66 2064 6961 676e 6f73 6573  ist of diagnoses
+00002260: 2074 6f20 6c6f 6164 2069 6620 7473 765f   to load if tsv_
+00002270: 7061 7468 2069 7320 6120 7370 6c69 745f  path is a split_
+00002280: 6469 7265 6374 6f72 792e 0a20 2020 2020  directory..     
+00002290: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
+000022a0: 6c74 2075 7365 7320 7468 6520 7361 6d65  lt uses the same
+000022b0: 2061 7320 696e 2074 7261 696e 696e 6720   as in training 
+000022c0: 7374 6570 2e0a 2020 2020 2020 2020 2020  step..          
+000022d0: 2020 7573 655f 6c61 6265 6c73 3a20 4966    use_labels: If
+000022e0: 2054 7275 652c 2074 6865 206c 6162 656c   True, the label
+000022f0: 7320 6d75 7374 2065 7869 7374 2069 6e20  s must exist in 
+00002300: 7465 7374 206d 6574 612d 6461 7461 2061  test meta-data a
+00002310: 6e64 206d 6574 7269 6373 2061 7265 2063  nd metrics are c
+00002320: 6f6d 7075 7465 642e 0a20 2020 2020 2020  omputed..       
+00002330: 2020 2020 2062 6174 6368 5f73 697a 653a       batch_size:
+00002340: 2049 6620 6769 7665 6e2c 2073 6574 7320   If given, sets 
+00002350: 7468 6520 7661 6c75 6520 6f66 2062 6174  the value of bat
+00002360: 6368 5f73 697a 652c 2065 6c73 6520 7573  ch_size, else us
+00002370: 6520 7468 6520 7361 6d65 2061 7320 696e  e the same as in
+00002380: 2074 7261 696e 696e 6720 7374 6570 2e0a   training step..
+00002390: 2020 2020 2020 2020 2020 2020 6e5f 7072              n_pr
+000023a0: 6f63 3a20 4966 2067 6976 656e 2c20 7365  oc: If given, se
+000023b0: 7473 2074 6865 2076 616c 7565 206f 6620  ts the value of 
+000023c0: 6e75 6d5f 776f 726b 6572 732c 2065 6c73  num_workers, els
+000023d0: 6520 7573 6520 7468 6520 7361 6d65 2061  e use the same a
+000023e0: 7320 696e 2074 7261 696e 696e 6720 7374  s in training st
+000023f0: 6570 2e0a 2020 2020 2020 2020 2020 2020  ep..            
+00002400: 6770 753a 2049 6620 6769 7665 6e2c 2061  gpu: If given, a
+00002410: 206e 6577 2076 616c 7565 2066 6f72 2074   new value for t
+00002420: 6865 2064 6576 6963 6520 6f66 2074 6865  he device of the
+00002430: 206d 6f64 656c 2077 696c 6c20 6265 2063   model will be c
+00002440: 6f6d 7075 7465 642e 0a20 2020 2020 2020  omputed..       
+00002450: 2020 2020 2061 6d70 3a20 4966 2065 6e61       amp: If ena
+00002460: 626c 6564 2c20 7573 6573 2041 7574 6f6d  bled, uses Autom
+00002470: 6174 6963 204d 6978 6564 2050 7265 6369  atic Mixed Preci
+00002480: 7369 6f6e 2028 7265 7175 6972 6573 2047  sion (requires G
+00002490: 5055 2075 7361 6765 292e 0a20 2020 2020  PU usage)..     
+000024a0: 2020 2020 2020 206f 7665 7277 7269 7465         overwrite
+000024b0: 3a20 4966 2054 7275 6520 6572 6173 6520  : If True erase 
+000024c0: 7468 6520 6f63 6375 7272 656e 6365 7320  the occurrences 
+000024d0: 6f66 2064 6174 615f 6772 6f75 702e 0a20  of data_group.. 
+000024e0: 2020 2020 2020 2020 2020 206c 6162 656c             label
+000024f0: 3a20 5461 7267 6574 206c 6162 656c 2075  : Target label u
+00002500: 7365 6420 666f 7220 7472 6169 6e69 6e67  sed for training
+00002510: 2028 6966 206e 6574 776f 726b 5f74 6173   (if network_tas
+00002520: 6b20 696e 205b 6072 6567 7265 7373 696f  k in [`regressio
+00002530: 6e60 2c20 6063 6c61 7373 6966 6963 6174  n`, `classificat
+00002540: 696f 6e60 5d29 2e0a 2020 2020 2020 2020  ion`])..        
+00002550: 2020 2020 6c61 6265 6c5f 636f 6465 3a20      label_code: 
+00002560: 6469 6374 696f 6e61 7279 206c 696e 6b69  dictionary linki
+00002570: 6e67 2074 6865 2074 6172 6765 7420 7661  ng the target va
+00002580: 6c75 6573 2074 6f20 6120 6e6f 6465 206e  lues to a node n
+00002590: 756d 6265 722e 0a20 2020 2020 2020 2022  umber..        "
+000025a0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+000025b0: 7420 7370 6c69 745f 6c69 7374 3a0a 2020  t split_list:.  
+000025c0: 2020 2020 2020 2020 2020 7370 6c69 745f            split_
+000025d0: 6c69 7374 203d 2073 656c 662e 5f66 696e  list = self._fin
+000025e0: 645f 7370 6c69 7473 2829 0a20 2020 2020  d_splits().     
+000025f0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00002600: 6622 4c69 7374 206f 6620 7370 6c69 7473  f"List of splits
+00002610: 207b 7370 6c69 745f 6c69 7374 7d22 290a   {split_list}").
+00002620: 0a20 2020 2020 2020 205f 2c20 616c 6c5f  .        _, all_
+00002630: 7472 616e 7366 6f72 6d73 203d 2067 6574  transforms = get
+00002640: 5f74 7261 6e73 666f 726d 7328 0a20 2020  _transforms(.   
+00002650: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
+00002660: 7a65 3d73 656c 662e 6e6f 726d 616c 697a  ze=self.normaliz
+00002670: 652c 0a20 2020 2020 2020 2020 2020 2064  e,.            d
+00002680: 6174 615f 6175 676d 656e 7461 7469 6f6e  ata_augmentation
+00002690: 3d73 656c 662e 6461 7461 5f61 7567 6d65  =self.data_augme
+000026a0: 6e74 6174 696f 6e2c 0a20 2020 2020 2020  ntation,.       
+000026b0: 2020 2020 2073 697a 655f 7265 6475 6374       size_reduct
+000026c0: 696f 6e3d 7365 6c66 2e73 697a 655f 7265  ion=self.size_re
+000026d0: 6475 6374 696f 6e2c 0a20 2020 2020 2020  duction,.       
+000026e0: 2020 2020 2073 697a 655f 7265 6475 6374       size_reduct
+000026f0: 696f 6e5f 6661 6374 6f72 3d73 656c 662e  ion_factor=self.
+00002700: 7369 7a65 5f72 6564 7563 7469 6f6e 5f66  size_reduction_f
+00002710: 6163 746f 722c 0a20 2020 2020 2020 2029  actor,.        )
+00002720: 0a0a 2020 2020 2020 2020 6772 6f75 705f  ..        group_
+00002730: 6466 203d 204e 6f6e 650a 2020 2020 2020  df = None.      
+00002740: 2020 6966 2074 7376 5f70 6174 6820 6973    if tsv_path is
+00002750: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00002760: 2020 2020 2020 2067 726f 7570 5f64 6620         group_df 
+00002770: 3d20 6c6f 6164 5f64 6174 615f 7465 7374  = load_data_test
+00002780: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002790: 2020 7473 765f 7061 7468 2c0a 2020 2020    tsv_path,.    
+000027a0: 2020 2020 2020 2020 2020 2020 6469 6167              diag
+000027b0: 6e6f 7365 7320 6966 206c 656e 2864 6961  noses if len(dia
+000027c0: 676e 6f73 6573 2920 213d 2030 2065 6c73  gnoses) != 0 els
+000027d0: 6520 7365 6c66 2e64 6961 676e 6f73 6573  e self.diagnoses
+000027e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000027f0: 2020 6d75 6c74 695f 636f 686f 7274 3d6d    multi_cohort=m
+00002800: 756c 7469 5f63 6f68 6f72 742c 0a20 2020  ulti_cohort,.   
+00002810: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00002820: 2020 2063 7269 7465 7269 6f6e 203d 2073     criterion = s
+00002830: 656c 662e 7461 736b 5f6d 616e 6167 6572  elf.task_manager
+00002840: 2e67 6574 5f63 7269 7465 7269 6f6e 2873  .get_criterion(s
+00002850: 656c 662e 6c6f 7373 290a 2020 2020 2020  elf.loss).      
+00002860: 2020 7365 6c66 2e5f 6368 6563 6b5f 6461    self._check_da
+00002870: 7461 5f67 726f 7570 280a 2020 2020 2020  ta_group(.      
+00002880: 2020 2020 2020 6461 7461 5f67 726f 7570        data_group
+00002890: 2c0a 2020 2020 2020 2020 2020 2020 6361  ,.            ca
+000028a0: 7073 5f64 6972 6563 746f 7279 2c0a 2020  ps_directory,.  
+000028b0: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+000028c0: 6466 2c0a 2020 2020 2020 2020 2020 2020  df,.            
+000028d0: 6d75 6c74 695f 636f 686f 7274 2c0a 2020  multi_cohort,.  
+000028e0: 2020 2020 2020 2020 2020 6f76 6572 7772            overwr
+000028f0: 6974 652c 0a20 2020 2020 2020 2020 2020  ite,.           
+00002900: 206c 6162 656c 3d6c 6162 656c 2c0a 2020   label=label,.  
+00002910: 2020 2020 2020 2020 2020 7370 6c69 745f            split_
+00002920: 6c69 7374 3d73 706c 6974 5f6c 6973 742c  list=split_list,
+00002930: 0a20 2020 2020 2020 2020 2020 2073 6b69  .            ski
+00002940: 705f 6c65 616b 5f63 6865 636b 3d73 6b69  p_leak_check=ski
+00002950: 705f 6c65 616b 5f63 6865 636b 2c0a 2020  p_leak_check,.  
+00002960: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00002970: 666f 7220 7370 6c69 7420 696e 2073 706c  for split in spl
+00002980: 6974 5f6c 6973 743a 0a20 2020 2020 2020  it_list:.       
+00002990: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000029a0: 2866 2250 7265 6469 6374 696f 6e20 6f66  (f"Prediction of
+000029b0: 2073 706c 6974 207b 7370 6c69 747d 2229   split {split}")
+000029c0: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
+000029d0: 7570 5f64 662c 2067 726f 7570 5f70 6172  up_df, group_par
+000029e0: 616d 6574 6572 7320 3d20 7365 6c66 2e67  ameters = self.g
+000029f0: 6574 5f67 726f 7570 5f69 6e66 6f28 6461  et_group_info(da
+00002a00: 7461 5f67 726f 7570 2c20 7370 6c69 7429  ta_group, split)
+00002a10: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00002a20: 696e 6420 6c61 6265 6c20 636f 6465 2069  ind label code i
+00002a30: 6620 6e6f 7420 6769 7665 6e0a 2020 2020  f not given.    
+00002a40: 2020 2020 2020 2020 6966 206c 6162 656c          if label
+00002a50: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00002a60: 206c 6162 656c 2021 3d20 7365 6c66 2e6c   label != self.l
+00002a70: 6162 656c 2061 6e64 206c 6162 656c 5f63  abel and label_c
+00002a80: 6f64 6520 3d3d 2022 6465 6661 756c 7422  ode == "default"
+00002a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002aa0: 2020 7365 6c66 2e74 6173 6b5f 6d61 6e61    self.task_mana
+00002ab0: 6765 722e 6765 6e65 7261 7465 5f6c 6162  ger.generate_lab
+00002ac0: 656c 5f63 6f64 6528 6772 6f75 705f 6466  el_code(group_df
+00002ad0: 2c20 6c61 6265 6c29 0a0a 2020 2020 2020  , label)..      
+00002ae0: 2020 2020 2020 2320 4572 6173 6520 7072        # Erase pr
+00002af0: 6576 696f 7573 2054 5356 2066 696c 6573  evious TSV files
+00002b00: 206f 6e20 6d61 7374 6572 2070 726f 6365   on master proce
+00002b10: 7373 0a20 2020 2020 2020 2020 2020 2069  ss.            i
+00002b20: 6620 6e6f 7420 7365 6c65 6374 696f 6e5f  f not selection_
+00002b30: 6d65 7472 6963 733a 0a20 2020 2020 2020  metrics:.       
+00002b40: 2020 2020 2020 2020 2073 706c 6974 5f73           split_s
+00002b50: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+00002b60: 203d 2073 656c 662e 5f66 696e 645f 7365   = self._find_se
+00002b70: 6c65 6374 696f 6e5f 6d65 7472 6963 7328  lection_metrics(
+00002b80: 7370 6c69 7429 0a20 2020 2020 2020 2020  split).         
+00002b90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00002ba0: 2020 2020 2020 2020 2073 706c 6974 5f73           split_s
+00002bb0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+00002bc0: 203d 2073 656c 6563 7469 6f6e 5f6d 6574   = selection_met
+00002bd0: 7269 6373 0a20 2020 2020 2020 2020 2020  rics.           
+00002be0: 2066 6f72 2073 656c 6563 7469 6f6e 2069   for selection i
+00002bf0: 6e20 7370 6c69 745f 7365 6c65 6374 696f  n split_selectio
+00002c00: 6e5f 6d65 7472 6963 733a 0a20 2020 2020  n_metrics:.     
+00002c10: 2020 2020 2020 2020 2020 2074 7376 5f64             tsv_d
+00002c20: 6972 203d 2028 0a20 2020 2020 2020 2020  ir = (.         
+00002c30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00002c40: 6d61 7073 5f70 6174 680a 2020 2020 2020  maps_path.      
+00002c50: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+00002c60: 6622 7b73 656c 662e 7370 6c69 745f 6e61  f"{self.split_na
+00002c70: 6d65 7d2d 7b73 706c 6974 7d22 0a20 2020  me}-{split}".   
+00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c90: 202f 2066 2262 6573 742d 7b73 656c 6563   / f"best-{selec
+00002ca0: 7469 6f6e 7d22 0a20 2020 2020 2020 2020  tion}".         
+00002cb0: 2020 2020 2020 2020 2020 202f 2064 6174             / dat
+00002cc0: 615f 6772 6f75 700a 2020 2020 2020 2020  a_group.        
+00002cd0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00002ce0: 2020 2020 2020 2020 2020 2074 7376 5f70             tsv_p
+00002cf0: 6174 7465 726e 203d 2066 227b 6461 7461  attern = f"{data
+00002d00: 5f67 726f 7570 7d2a 2e74 7376 220a 0a20  _group}*.tsv".. 
+00002d10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00002d20: 6f72 2074 7376 5f66 696c 6520 696e 2074  or tsv_file in t
+00002d30: 7376 5f64 6972 2e67 6c6f 6228 7473 765f  sv_dir.glob(tsv_
+00002d40: 7061 7474 6572 6e29 3a0a 2020 2020 2020  pattern):.      
+00002d50: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00002d60: 765f 6669 6c65 2e75 6e6c 696e 6b28 290a  v_file.unlink().
+00002d70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00002d80: 7365 6c66 2e6d 756c 7469 5f6e 6574 776f  self.multi_netwo
+00002d90: 726b 3a0a 2020 2020 2020 2020 2020 2020  rk:.            
+00002da0: 2020 2020 666f 7220 6e65 7477 6f72 6b20      for network 
+00002db0: 696e 2072 616e 6765 2873 656c 662e 6e75  in range(self.nu
+00002dc0: 6d5f 6e65 7477 6f72 6b73 293a 0a20 2020  m_networks):.   
+00002dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002de0: 2064 6174 615f 7465 7374 203d 2072 6574   data_test = ret
+00002df0: 7572 6e5f 6461 7461 7365 7428 0a20 2020  urn_dataset(.   
+00002e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e10: 2020 2020 2067 726f 7570 5f70 6172 616d       group_param
+00002e20: 6574 6572 735b 2263 6170 735f 6469 7265  eters["caps_dire
+00002e30: 6374 6f72 7922 5d2c 0a20 2020 2020 2020  ctory"],.       
+00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e50: 2067 726f 7570 5f64 662c 0a20 2020 2020   group_df,.     
+00002e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e70: 2020 2073 656c 662e 7072 6570 726f 6365     self.preproce
+00002e80: 7373 696e 675f 6469 6374 2c0a 2020 2020  ssing_dict,.    
+00002e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ea0: 2020 2020 616c 6c5f 7472 616e 7366 6f72      all_transfor
+00002eb0: 6d61 7469 6f6e 733d 616c 6c5f 7472 616e  mations=all_tran
+00002ec0: 7366 6f72 6d73 2c0a 2020 2020 2020 2020  sforms,.        
+00002ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ee0: 6d75 6c74 695f 636f 686f 7274 3d67 726f  multi_cohort=gro
+00002ef0: 7570 5f70 6172 616d 6574 6572 735b 226d  up_parameters["m
+00002f00: 756c 7469 5f63 6f68 6f72 7422 5d2c 0a20  ulti_cohort"],. 
+00002f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f20: 2020 2020 2020 206c 6162 656c 5f70 7265         label_pre
+00002f30: 7365 6e63 653d 7573 655f 6c61 6265 6c73  sence=use_labels
+00002f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002f50: 2020 2020 2020 2020 2020 6c61 6265 6c3d            label=
+00002f60: 7365 6c66 2e6c 6162 656c 2069 6620 6c61  self.label if la
+00002f70: 6265 6c20 6973 204e 6f6e 6520 656c 7365  bel is None else
+00002f80: 206c 6162 656c 2c0a 2020 2020 2020 2020   label,.        
+00002f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fa0: 6c61 6265 6c5f 636f 6465 3d28 0a20 2020  label_code=(.   
+00002fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fc0: 2020 2020 2020 2020 2073 656c 662e 6c61           self.la
+00002fd0: 6265 6c5f 636f 6465 2069 6620 6c61 6265  bel_code if labe
+00002fe0: 6c5f 636f 6465 203d 3d20 2264 6566 6175  l_code == "defau
+00002ff0: 6c74 2220 656c 7365 206c 6162 656c 5f63  lt" else label_c
+00003000: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
+00003010: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00003020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003030: 2020 2020 2020 2063 6e6e 5f69 6e64 6578         cnn_index
+00003040: 3d6e 6574 776f 726b 2c0a 2020 2020 2020  =network,.      
+00003050: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00003060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003070: 2020 2020 7465 7374 5f6c 6f61 6465 7220      test_loader 
+00003080: 3d20 4461 7461 4c6f 6164 6572 280a 2020  = DataLoader(.  
+00003090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030a0: 2020 2020 2020 6461 7461 5f74 6573 742c        data_test,
+000030b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000030c0: 2020 2020 2020 2020 2062 6174 6368 5f73           batch_s
+000030d0: 697a 653d 280a 2020 2020 2020 2020 2020  ize=(.          
+000030e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030f0: 2020 6261 7463 685f 7369 7a65 2069 6620    batch_size if 
+00003100: 6261 7463 685f 7369 7a65 2069 7320 6e6f  batch_size is no
+00003110: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+00003120: 2e62 6174 6368 5f73 697a 650a 2020 2020  .batch_size.    
 00003130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003140: 2020 2020 2073 6875 6666 6c65 3d46 616c       shuffle=Fal
-00003150: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00003160: 2020 2020 2020 2020 2020 2020 7361 6d70              samp
-00003170: 6c65 723d 4469 7374 7269 6275 7465 6453  ler=DistributedS
-00003180: 616d 706c 6572 280a 2020 2020 2020 2020  ampler(.        
-00003190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000031a0: 2020 2020 6461 7461 5f74 6573 742c 0a20      data_test,. 
-000031b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000031c0: 2020 2020 2020 2020 2020 206e 756d 5f72             num_r
-000031d0: 6570 6c69 6361 733d 636c 7573 7465 722e  eplicas=cluster.
-000031e0: 776f 726c 645f 7369 7a65 2c0a 2020 2020  world_size,.    
-000031f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003200: 2020 2020 2020 2020 7261 6e6b 3d63 6c75          rank=clu
-00003210: 7374 6572 2e72 616e 6b2c 0a20 2020 2020  ster.rank,.     
-00003220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003230: 2020 2020 2020 2073 6875 6666 6c65 3d46         shuffle=F
-00003240: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00003250: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00003260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003270: 2020 2020 2020 2020 206e 756d 5f77 6f72           num_wor
-00003280: 6b65 7273 3d6e 5f70 726f 6320 6966 206e  kers=n_proc if n
-00003290: 5f70 726f 6320 6973 206e 6f74 204e 6f6e  _proc is not Non
-000032a0: 6520 656c 7365 2073 656c 662e 6e5f 7072  e else self.n_pr
-000032b0: 6f63 2c0a 2020 2020 2020 2020 2020 2020  oc,.            
-000032c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000032d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000032e0: 6c66 2e5f 7465 7374 5f6c 6f61 6465 7228  lf._test_loader(
-000032f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003300: 2020 2020 2020 2020 2074 6573 745f 6c6f           test_lo
-00003310: 6164 6572 2c0a 2020 2020 2020 2020 2020  ader,.          
-00003320: 2020 2020 2020 2020 2020 2020 2020 6372                cr
-00003330: 6974 6572 696f 6e2c 0a20 2020 2020 2020  iterion,.       
-00003340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003350: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
-00003360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003370: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-00003380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003390: 2020 2020 7370 6c69 745f 7365 6c65 6374      split_select
-000033a0: 696f 6e5f 6d65 7472 6963 732c 0a20 2020  ion_metrics,.   
-000033b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000033c0: 2020 2020 2075 7365 5f6c 6162 656c 733d       use_labels=
-000033d0: 7573 655f 6c61 6265 6c73 2c0a 2020 2020  use_labels,.    
-000033e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000033f0: 2020 2020 6770 753d 6770 752c 0a20 2020      gpu=gpu,.   
-00003400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003410: 2020 2020 2061 6d70 3d61 6d70 2c0a 2020       amp=amp,.  
-00003420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003430: 2020 2020 2020 6e65 7477 6f72 6b3d 6e65        network=ne
-00003440: 7477 6f72 6b2c 0a20 2020 2020 2020 2020  twork,.         
-00003450: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00003460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003470: 2069 6620 7361 7665 5f74 656e 736f 723a   if save_tensor:
-00003480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003490: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000034a0: 6465 6275 6728 2253 6176 696e 6720 7465  debug("Saving te
-000034b0: 6e73 6f72 7322 290a 2020 2020 2020 2020  nsors").        
-000034c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034d0: 7365 6c66 2e5f 636f 6d70 7574 655f 6f75  self._compute_ou
-000034e0: 7470 7574 5f74 656e 736f 7273 280a 2020  tput_tensors(.  
-000034f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003500: 2020 2020 2020 2020 2020 6461 7461 5f74            data_t
-00003510: 6573 742c 0a20 2020 2020 2020 2020 2020  est,.           
-00003520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003530: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
-00003540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003550: 2020 2020 2020 2020 2073 706c 6974 2c0a           split,.
+00003140: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00003150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003160: 6875 6666 6c65 3d46 616c 7365 2c0a 2020  huffle=False,.  
+00003170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003180: 2020 2020 2020 7361 6d70 6c65 723d 4469        sampler=Di
+00003190: 7374 7269 6275 7465 6453 616d 706c 6572  stributedSampler
+000031a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000031b0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+000031c0: 7461 5f74 6573 742c 0a20 2020 2020 2020  ta_test,.       
+000031d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000031e0: 2020 2020 206e 756d 5f72 6570 6c69 6361       num_replica
+000031f0: 733d 636c 7573 7465 722e 776f 726c 645f  s=cluster.world_
+00003200: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00003210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003220: 2020 7261 6e6b 3d63 6c75 7374 6572 2e72    rank=cluster.r
+00003230: 616e 6b2c 0a20 2020 2020 2020 2020 2020  ank,.           
+00003240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003250: 2073 6875 6666 6c65 3d46 616c 7365 2c0a   shuffle=False,.
+00003260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003270: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00003280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003290: 2020 206e 756d 5f77 6f72 6b65 7273 3d6e     num_workers=n
+000032a0: 5f70 726f 6320 6966 206e 5f70 726f 6320  _proc if n_proc 
+000032b0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+000032c0: 2073 656c 662e 6e5f 7072 6f63 2c0a 2020   self.n_proc,.  
+000032d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000032f0: 2020 2020 2020 2020 7365 6c66 2e5f 7465          self._te
+00003300: 7374 5f6c 6f61 6465 7228 0a20 2020 2020  st_loader(.     
+00003310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003320: 2020 2074 6573 745f 6c6f 6164 6572 2c0a     test_loader,.
+00003330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003340: 2020 2020 2020 2020 6372 6974 6572 696f          criterio
+00003350: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00003360: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00003370: 6772 6f75 702c 0a20 2020 2020 2020 2020  group,.         
+00003380: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003390: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+000033a0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+000033b0: 6c69 745f 7365 6c65 6374 696f 6e5f 6d65  lit_selection_me
+000033c0: 7472 6963 732c 0a20 2020 2020 2020 2020  trics,.         
+000033d0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+000033e0: 7365 5f6c 6162 656c 733d 7573 655f 6c61  se_labels=use_la
+000033f0: 6265 6c73 2c0a 2020 2020 2020 2020 2020  bels,.          
+00003400: 2020 2020 2020 2020 2020 2020 2020 6770                gp
+00003410: 753d 6770 752c 0a20 2020 2020 2020 2020  u=gpu,.         
+00003420: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00003430: 6d70 3d61 6d70 2c0a 2020 2020 2020 2020  mp=amp,.        
+00003440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003450: 6e65 7477 6f72 6b3d 6e65 7477 6f72 6b2c  network=network,
+00003460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003470: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00003480: 2020 2020 2020 2020 2020 2069 6620 7361             if sa
+00003490: 7665 5f74 656e 736f 723a 0a20 2020 2020  ve_tensor:.     
+000034a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000034b0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+000034c0: 2253 6176 696e 6720 7465 6e73 6f72 7322  "Saving tensors"
+000034d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000034e0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000034f0: 636f 6d70 7574 655f 6f75 7470 7574 5f74  compute_output_t
+00003500: 656e 736f 7273 280a 2020 2020 2020 2020  ensors(.        
+00003510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003520: 2020 2020 6461 7461 5f74 6573 742c 0a20      data_test,. 
+00003530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003540: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00003550: 6772 6f75 702c 0a20 2020 2020 2020 2020  group,.         
 00003560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003570: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-00003580: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
-00003590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035a0: 2020 2020 2020 2020 2020 2067 7075 3d67             gpu=g
-000035b0: 7075 2c0a 2020 2020 2020 2020 2020 2020  pu,.            
-000035c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035d0: 6e65 7477 6f72 6b3d 6e65 7477 6f72 6b2c  network=network,
-000035e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000035f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00003600: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003610: 6620 7361 7665 5f6e 6966 7469 3a0a 2020  f save_nifti:.  
-00003620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003630: 2020 2020 2020 7365 6c66 2e5f 636f 6d70        self._comp
-00003640: 7574 655f 6f75 7470 7574 5f6e 6966 7469  ute_output_nifti
-00003650: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00003660: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00003670: 7461 5f74 6573 742c 0a20 2020 2020 2020  ta_test,.       
-00003680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003690: 2020 2020 2064 6174 615f 6772 6f75 702c       data_group,
-000036a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000036b0: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-000036c0: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-000036d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036e0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-000036f0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00003700: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00003710: 7075 3d67 7075 2c0a 2020 2020 2020 2020  pu=gpu,.        
-00003720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003730: 2020 2020 6e65 7477 6f72 6b3d 6e65 7477      network=netw
-00003740: 6f72 6b2c 0a20 2020 2020 2020 2020 2020  ork,.           
-00003750: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00003570: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
+00003580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003590: 2020 2020 2020 7365 6c65 6374 696f 6e5f        selection_
+000035a0: 6d65 7472 6963 732c 0a20 2020 2020 2020  metrics,.       
+000035b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035c0: 2020 2020 2067 7075 3d67 7075 2c0a 2020       gpu=gpu,.  
+000035d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035e0: 2020 2020 2020 2020 2020 6e65 7477 6f72            networ
+000035f0: 6b3d 6e65 7477 6f72 6b2c 0a20 2020 2020  k=network,.     
+00003600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003610: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00003620: 2020 2020 2020 2020 2069 6620 7361 7665           if save
+00003630: 5f6e 6966 7469 3a0a 2020 2020 2020 2020  _nifti:.        
+00003640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003650: 7365 6c66 2e5f 636f 6d70 7574 655f 6f75  self._compute_ou
+00003660: 7470 7574 5f6e 6966 7469 280a 2020 2020  tput_nifti(.    
+00003670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003680: 2020 2020 2020 2020 6461 7461 5f74 6573          data_tes
+00003690: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000036a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000036b0: 6174 615f 6772 6f75 702c 0a20 2020 2020  ata_group,.     
+000036c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000036d0: 2020 2020 2020 2073 706c 6974 2c0a 2020         split,.  
+000036e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000036f0: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+00003700: 696f 6e5f 6d65 7472 6963 732c 0a20 2020  ion_metrics,.   
+00003710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003720: 2020 2020 2020 2020 2067 7075 3d67 7075           gpu=gpu
+00003730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003740: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00003750: 7477 6f72 6b3d 6e65 7477 6f72 6b2c 0a20  twork=network,. 
 00003760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003770: 2020 2069 6620 7361 7665 5f6c 6174 656e     if save_laten
-00003780: 745f 7465 6e73 6f72 3a0a 2020 2020 2020  t_tensor:.      
-00003790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037a0: 2020 7365 6c66 2e5f 636f 6d70 7574 655f    self._compute_
-000037b0: 6c61 7465 6e74 5f74 656e 736f 7273 280a  latent_tensors(.
-000037c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037d0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000037e0: 5f74 6573 742c 0a20 2020 2020 2020 2020  _test,.         
-000037f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003800: 2020 2064 6174 615f 6772 6f75 702c 0a20     data_group,. 
-00003810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003820: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00003830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003840: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00003850: 6c65 6374 696f 6e5f 6d65 7472 6963 732c  lection_metrics,
-00003860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003870: 2020 2020 2020 2020 2020 2020 2067 7075               gpu
-00003880: 3d67 7075 2c0a 2020 2020 2020 2020 2020  =gpu,.          
-00003890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038a0: 2020 6e65 7477 6f72 6b3d 6e65 7477 6f72    network=networ
-000038b0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-000038c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000038d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000038e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000038f0: 6174 615f 7465 7374 203d 2072 6574 7572  ata_test = retur
-00003900: 6e5f 6461 7461 7365 7428 0a20 2020 2020  n_dataset(.     
-00003910: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00003920: 726f 7570 5f70 6172 616d 6574 6572 735b  roup_parameters[
-00003930: 2263 6170 735f 6469 7265 6374 6f72 7922  "caps_directory"
-00003940: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00003950: 2020 2020 2020 2067 726f 7570 5f64 662c         group_df,
-00003960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003970: 2020 2020 2073 656c 662e 7072 6570 726f       self.prepro
-00003980: 6365 7373 696e 675f 6469 6374 2c0a 2020  cessing_dict,.  
-00003990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039a0: 2020 616c 6c5f 7472 616e 7366 6f72 6d61    all_transforma
-000039b0: 7469 6f6e 733d 616c 6c5f 7472 616e 7366  tions=all_transf
-000039c0: 6f72 6d73 2c0a 2020 2020 2020 2020 2020  orms,.          
-000039d0: 2020 2020 2020 2020 2020 6d75 6c74 695f            multi_
-000039e0: 636f 686f 7274 3d67 726f 7570 5f70 6172  cohort=group_par
-000039f0: 616d 6574 6572 735b 226d 756c 7469 5f63  ameters["multi_c
-00003a00: 6f68 6f72 7422 5d2c 0a20 2020 2020 2020  ohort"],.       
-00003a10: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-00003a20: 656c 5f70 7265 7365 6e63 653d 7573 655f  el_presence=use_
-00003a30: 6c61 6265 6c73 2c0a 2020 2020 2020 2020  labels,.        
-00003a40: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
-00003a50: 6c3d 7365 6c66 2e6c 6162 656c 2069 6620  l=self.label if 
-00003a60: 6c61 6265 6c20 6973 204e 6f6e 6520 656c  label is None el
-00003a70: 7365 206c 6162 656c 2c0a 2020 2020 2020  se label,.      
-00003a80: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00003a90: 6265 6c5f 636f 6465 3d28 0a20 2020 2020  bel_code=(.     
-00003aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ab0: 2020 2073 656c 662e 6c61 6265 6c5f 636f     self.label_co
-00003ac0: 6465 2069 6620 6c61 6265 6c5f 636f 6465  de if label_code
-00003ad0: 203d 3d20 2264 6566 6175 6c74 2220 656c   == "default" el
-00003ae0: 7365 206c 6162 656c 5f63 6f64 650a 2020  se label_code.  
-00003af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b00: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00003b10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00003b20: 2020 2020 2020 2020 7465 7374 5f6c 6f61          test_loa
-00003b30: 6465 7220 3d20 4461 7461 4c6f 6164 6572  der = DataLoader
-00003b40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00003b50: 2020 2020 2020 6461 7461 5f74 6573 742c        data_test,
-00003b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003b70: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
-00003b80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00003b90: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
-00003ba0: 7369 7a65 2069 6620 6261 7463 685f 7369  size if batch_si
-00003bb0: 7a65 2069 7320 6e6f 7420 4e6f 6e65 2065  ze is not None e
-00003bc0: 6c73 6520 7365 6c66 2e62 6174 6368 5f73  lse self.batch_s
-00003bd0: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-00003be0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-00003bf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00003c00: 6875 6666 6c65 3d46 616c 7365 2c0a 2020  huffle=False,.  
-00003c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c20: 2020 7361 6d70 6c65 723d 4469 7374 7269    sampler=Distri
-00003c30: 6275 7465 6453 616d 706c 6572 280a 2020  butedSampler(.  
-00003c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c50: 2020 2020 2020 6461 7461 5f74 6573 742c        data_test,
-00003c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003c70: 2020 2020 2020 2020 206e 756d 5f72 6570           num_rep
-00003c80: 6c69 6361 733d 636c 7573 7465 722e 776f  licas=cluster.wo
-00003c90: 726c 645f 7369 7a65 2c0a 2020 2020 2020  rld_size,.      
-00003ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003cb0: 2020 7261 6e6b 3d63 6c75 7374 6572 2e72    rank=cluster.r
-00003cc0: 616e 6b2c 0a20 2020 2020 2020 2020 2020  ank,.           
-00003cd0: 2020 2020 2020 2020 2020 2020 2073 6875               shu
-00003ce0: 6666 6c65 3d46 616c 7365 2c0a 2020 2020  ffle=False,.    
-00003cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d00: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00003d10: 2020 2020 2020 206e 756d 5f77 6f72 6b65         num_worke
-00003d20: 7273 3d6e 5f70 726f 6320 6966 206e 5f70  rs=n_proc if n_p
-00003d30: 726f 6320 6973 206e 6f74 204e 6f6e 6520  roc is not None 
-00003d40: 656c 7365 2073 656c 662e 6e5f 7072 6f63  else self.n_proc
-00003d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003d60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00003d70: 2020 2020 7365 6c66 2e5f 7465 7374 5f6c      self._test_l
-00003d80: 6f61 6465 7228 0a20 2020 2020 2020 2020  oader(.         
-00003d90: 2020 2020 2020 2020 2020 2074 6573 745f             test_
-00003da0: 6c6f 6164 6572 2c0a 2020 2020 2020 2020  loader,.        
-00003db0: 2020 2020 2020 2020 2020 2020 6372 6974              crit
-00003dc0: 6572 696f 6e2c 0a20 2020 2020 2020 2020  erion,.         
-00003dd0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00003de0: 6772 6f75 702c 0a20 2020 2020 2020 2020  group,.         
-00003df0: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00003e00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003e10: 2020 2020 2020 7370 6c69 745f 7365 6c65        split_sele
-00003e20: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
-00003e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e40: 2020 2075 7365 5f6c 6162 656c 733d 7573     use_labels=us
-00003e50: 655f 6c61 6265 6c73 2c0a 2020 2020 2020  e_labels,.      
-00003e60: 2020 2020 2020 2020 2020 2020 2020 6770                gp
-00003e70: 753d 6770 752c 0a20 2020 2020 2020 2020  u=gpu,.         
-00003e80: 2020 2020 2020 2020 2020 2061 6d70 3d61             amp=a
-00003e90: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
-00003ea0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00003eb0: 2020 2020 2020 6966 2073 6176 655f 7465        if save_te
-00003ec0: 6e73 6f72 3a0a 2020 2020 2020 2020 2020  nsor:.          
-00003ed0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00003ee0: 2e64 6562 7567 2822 5361 7669 6e67 2074  .debug("Saving t
-00003ef0: 656e 736f 7273 2229 0a20 2020 2020 2020  ensors").       
-00003f00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00003f10: 662e 5f63 6f6d 7075 7465 5f6f 7574 7075  f._compute_outpu
-00003f20: 745f 7465 6e73 6f72 7328 0a20 2020 2020  t_tensors(.     
-00003f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f40: 2020 2064 6174 615f 7465 7374 2c0a 2020     data_test,.  
-00003f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f60: 2020 2020 2020 6461 7461 5f67 726f 7570        data_group
-00003f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003f80: 2020 2020 2020 2020 2020 7370 6c69 742c            split,
-00003f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003fa0: 2020 2020 2020 2020 2073 656c 6563 7469           selecti
-00003fb0: 6f6e 5f6d 6574 7269 6373 2c0a 2020 2020  on_metrics,.    
-00003fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003fd0: 2020 2020 6770 753d 6770 752c 0a20 2020      gpu=gpu,.   
-00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ff0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00004000: 2020 2069 6620 7361 7665 5f6e 6966 7469     if save_nifti
-00004010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004020: 2020 2020 2020 7365 6c66 2e5f 636f 6d70        self._comp
-00004030: 7574 655f 6f75 7470 7574 5f6e 6966 7469  ute_output_nifti
-00004040: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00004050: 2020 2020 2020 2020 2020 6461 7461 5f74            data_t
-00004060: 6573 742c 0a20 2020 2020 2020 2020 2020  est,.           
-00004070: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00004080: 615f 6772 6f75 702c 0a20 2020 2020 2020  a_group,.       
-00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040a0: 2073 706c 6974 2c0a 2020 2020 2020 2020   split,.        
-000040b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040c0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-000040d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-000040e0: 2020 2020 2020 2020 2020 2067 7075 3d67             gpu=g
-000040f0: 7075 2c0a 2020 2020 2020 2020 2020 2020  pu,.            
-00004100: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00004110: 2020 2020 2020 2020 2020 6966 2073 6176            if sav
-00004120: 655f 6c61 7465 6e74 5f74 656e 736f 723a  e_latent_tensor:
-00004130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004140: 2020 2020 2073 656c 662e 5f63 6f6d 7075       self._compu
-00004150: 7465 5f6c 6174 656e 745f 7465 6e73 6f72  te_latent_tensor
-00004160: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00004170: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00004180: 7465 7374 2c0a 2020 2020 2020 2020 2020  test,.          
-00004190: 2020 2020 2020 2020 2020 2020 2020 6461                da
-000041a0: 7461 5f67 726f 7570 2c0a 2020 2020 2020  ta_group,.      
-000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041c0: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
-000041d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041e0: 2073 656c 6563 7469 6f6e 5f6d 6574 7269   selection_metri
-000041f0: 6373 2c0a 2020 2020 2020 2020 2020 2020  cs,.            
-00004200: 2020 2020 2020 2020 2020 2020 6770 753d              gpu=
-00004210: 6770 752c 0a20 2020 2020 2020 2020 2020  gpu,.           
-00004220: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00004230: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
-00004240: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
-00004250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00004260: 5f65 6e73 656d 626c 655f 7072 6564 6963  _ensemble_predic
-00004270: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00004280: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00004290: 726f 7570 2c20 7370 6c69 742c 2073 656c  roup, split, sel
-000042a0: 6563 7469 6f6e 5f6d 6574 7269 6373 2c20  ection_metrics, 
-000042b0: 7573 655f 6c61 6265 6c73 2c20 736b 6970  use_labels, skip
-000042c0: 5f6c 6561 6b5f 6368 6563 6b0a 2020 2020  _leak_check.    
-000042d0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-000042e0: 2020 2064 6566 2069 6e74 6572 7072 6574     def interpret
-000042f0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00004300: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
-00004310: 7570 2c0a 2020 2020 2020 2020 6e61 6d65  up,.        name
-00004320: 2c0a 2020 2020 2020 2020 6d65 7468 6f64  ,.        method
-00004330: 2c0a 2020 2020 2020 2020 6361 7073 5f64  ,.        caps_d
-00004340: 6972 6563 746f 7279 3a20 5061 7468 203d  irectory: Path =
-00004350: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
-00004360: 7376 5f70 6174 683a 2050 6174 6820 3d20  sv_path: Path = 
-00004370: 4e6f 6e65 2c0a 2020 2020 2020 2020 7370  None,.        sp
-00004380: 6c69 745f 6c69 7374 3d4e 6f6e 652c 0a20  lit_list=None,. 
-00004390: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
-000043a0: 5f6d 6574 7269 6373 3d4e 6f6e 652c 0a20  _metrics=None,. 
-000043b0: 2020 2020 2020 206d 756c 7469 5f63 6f68         multi_coh
-000043c0: 6f72 743d 4661 6c73 652c 0a20 2020 2020  ort=False,.     
-000043d0: 2020 2064 6961 676e 6f73 6573 3d28 292c     diagnoses=(),
-000043e0: 0a20 2020 2020 2020 2074 6172 6765 745f  .        target_
-000043f0: 6e6f 6465 3d30 2c0a 2020 2020 2020 2020  node=0,.        
-00004400: 7361 7665 5f69 6e64 6976 6964 7561 6c3d  save_individual=
-00004410: 4661 6c73 652c 0a20 2020 2020 2020 2062  False,.        b
-00004420: 6174 6368 5f73 697a 653d 4e6f 6e65 2c0a  atch_size=None,.
-00004430: 2020 2020 2020 2020 6e5f 7072 6f63 3d4e          n_proc=N
-00004440: 6f6e 652c 0a20 2020 2020 2020 2067 7075  one,.        gpu
-00004450: 3d4e 6f6e 652c 0a20 2020 2020 2020 2061  =None,.        a
-00004460: 6d70 3d46 616c 7365 2c0a 2020 2020 2020  mp=False,.      
-00004470: 2020 6f76 6572 7772 6974 653d 4661 6c73    overwrite=Fals
-00004480: 652c 0a20 2020 2020 2020 206f 7665 7277  e,.        overw
-00004490: 7269 7465 5f6e 616d 653d 4661 6c73 652c  rite_name=False,
-000044a0: 0a20 2020 2020 2020 206c 6576 656c 3d4e  .        level=N
-000044b0: 6f6e 652c 0a20 2020 2020 2020 2073 6176  one,.        sav
-000044c0: 655f 6e69 6674 693d 4661 6c73 652c 0a20  e_nifti=False,. 
-000044d0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-000044e0: 220a 2020 2020 2020 2020 5065 7266 6f72  ".        Perfor
-000044f0: 6d73 2074 6865 2069 6e74 6572 7072 6574  ms the interpret
-00004500: 6174 696f 6e20 7461 736b 206f 6e20 6120  ation task on a 
-00004510: 7375 6273 6574 206f 6620 6361 7073 5f64  subset of caps_d
-00004520: 6972 6563 746f 7279 2064 6566 696e 6564  irectory defined
-00004530: 2069 6e20 6120 5453 5620 6669 6c65 2e0a   in a TSV file..
-00004540: 2020 2020 2020 2020 5468 6520 6d65 616e          The mean
-00004550: 2069 6e74 6572 7072 6574 6174 696f 6e20   interpretation 
-00004560: 6973 2061 6c77 6179 7320 7361 7665 642c  is always saved,
-00004570: 2074 6f20 7361 7665 2074 6865 2069 6e64   to save the ind
-00004580: 6976 6964 7561 6c20 696e 7465 7270 7265  ividual interpre
-00004590: 7461 7469 6f6e 7320 7365 7420 7361 7665  tations set save
-000045a0: 5f69 6e64 6976 6964 7561 6c20 746f 2054  _individual to T
-000045b0: 7275 652e 0a0a 2020 2020 2020 2020 5061  rue...        Pa
-000045c0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-000045d0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000045e0: 2020 2020 6461 7461 5f67 726f 7570 3a20      data_group: 
-000045f0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-00004600: 4e61 6d65 206f 6620 7468 6520 6461 7461  Name of the data
-00004610: 2067 726f 7570 2069 6e74 6572 7072 6574   group interpret
-00004620: 6564 2e0a 2020 2020 2020 2020 6e61 6d65  ed..        name
-00004630: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
-00004640: 2020 4e61 6d65 206f 6620 7468 6520 696e    Name of the in
-00004650: 7465 7270 7265 7461 7469 6f6e 2070 726f  terpretation pro
-00004660: 6365 6475 7265 2e0a 2020 2020 2020 2020  cedure..        
-00004670: 6d65 7468 6f64 3a20 7374 720a 2020 2020  method: str.    
-00004680: 2020 2020 2020 2020 4d65 7468 6f64 2075          Method u
-00004690: 7365 6420 666f 7220 6578 7472 6163 7469  sed for extracti
-000046a0: 6f6e 2028 6578 3a20 6772 6164 6965 6e74  on (ex: gradient
-000046b0: 732c 2067 7261 642d 6361 6d2e 2e2e 292e  s, grad-cam...).
-000046c0: 0a20 2020 2020 2020 2063 6170 735f 6469  .        caps_di
-000046d0: 7265 6374 6f72 793a 2073 7472 2028 5061  rectory: str (Pa
-000046e0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-000046f0: 5061 7468 2074 6f20 7468 6520 4341 5053  Path to the CAPS
-00004700: 2066 6f6c 6465 722e 2046 6f72 206d 6f72   folder. For mor
-00004710: 6520 696e 666f 726d 6174 696f 6e20 706c  e information pl
-00004720: 6561 7365 2072 6566 6572 2074 6f0a 2020  ease refer to.  
-00004730: 2020 2020 2020 2020 2020 5b63 6c69 6e69            [clini
-00004740: 6361 2064 6f63 756d 656e 7461 7469 6f6e  ca documentation
-00004750: 5d28 6874 7470 733a 2f2f 6172 616d 6973  ](https://aramis
-00004760: 6c61 622e 7061 7269 732e 696e 7269 612e  lab.paris.inria.
-00004770: 6672 2f63 6c69 6e69 6361 2f64 6f63 732f  fr/clinica/docs/
-00004780: 7075 626c 6963 2f6c 6174 6573 742f 4341  public/latest/CA
-00004790: 5053 2f49 6e74 726f 6475 6374 696f 6e2f  PS/Introduction/
-000047a0: 292e 0a20 2020 2020 2020 2020 2020 2044  )..            D
-000047b0: 6566 6175 6c74 2077 696c 6c20 6c6f 6164  efault will load
-000047c0: 2074 6865 2076 616c 7565 206f 6620 616e   the value of an
-000047d0: 2065 7869 7374 696e 6720 6461 7461 2067   existing data g
-000047e0: 726f 7570 2e0a 2020 2020 2020 2020 7473  roup..        ts
-000047f0: 765f 7061 7468 3a20 7374 7220 2850 6174  v_path: str (Pat
-00004800: 6829 0a20 2020 2020 2020 2020 2020 2050  h).            P
-00004810: 6174 6820 746f 2061 2054 5356 2066 696c  ath to a TSV fil
-00004820: 6520 636f 6e74 6169 6e69 6e67 2074 6865  e containing the
-00004830: 206c 6973 7420 6f66 2070 6172 7469 6369   list of partici
-00004840: 7061 6e74 7320 616e 6420 7365 7373 696f  pants and sessio
-00004850: 6e73 2074 6f20 7465 7374 2e0a 2020 2020  ns to test..    
-00004860: 2020 2020 2020 2020 4465 6661 756c 7420          Default 
-00004870: 7769 6c6c 206c 6f61 6420 7468 6520 4461  will load the Da
-00004880: 7461 4672 616d 6520 6f66 2061 6e20 6578  taFrame of an ex
-00004890: 6973 7469 6e67 2064 6174 6120 6772 6f75  isting data grou
-000048a0: 702e 0a20 2020 2020 2020 2073 706c 6974  p..        split
-000048b0: 5f6c 6973 743a 206c 6973 7420 6f66 2069  _list: list of i
-000048c0: 6e74 0a20 2020 2020 2020 2020 2020 204c  nt.            L
-000048d0: 6973 7420 6f66 2073 706c 6974 7320 746f  ist of splits to
-000048e0: 2069 6e74 6572 7072 6574 2e20 4465 6661   interpret. Defa
-000048f0: 756c 7420 7065 7266 6f72 6d20 696e 7465  ult perform inte
-00004900: 7270 7265 7461 7469 6f6e 206f 6e20 616c  rpretation on al
-00004910: 6c20 7370 6c69 7473 2061 7661 696c 6162  l splits availab
-00004920: 6c65 2e0a 2020 2020 2020 2020 7365 6c65  le..        sele
-00004930: 6374 696f 6e5f 6d65 7472 6963 733a 206c  ction_metrics: l
-00004940: 6973 7420 6f66 2073 7472 0a20 2020 2020  ist of str.     
-00004950: 2020 2020 2020 204c 6973 7420 6f66 2073         List of s
-00004960: 656c 6563 7469 6f6e 206d 6574 7269 6373  election metrics
-00004970: 2074 6f20 696e 7465 7270 7265 742e 0a20   to interpret.. 
-00004980: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-00004990: 6c74 2070 6572 666f 726d 7320 7468 6520  lt performs the 
-000049a0: 696e 7465 7270 7265 7461 7469 6f6e 206f  interpretation o
-000049b0: 6e20 616c 6c20 7365 6c65 6374 696f 6e20  n all selection 
-000049c0: 6d65 7472 6963 7320 6176 6169 6c61 626c  metrics availabl
-000049d0: 652e 0a20 2020 2020 2020 206d 756c 7469  e..        multi
-000049e0: 5f63 6f68 6f72 743a 2062 6f6f 6c0a 2020  _cohort: bool.  
-000049f0: 2020 2020 2020 2020 2020 4966 2054 7275            If Tru
-00004a00: 6520 636f 6e73 6964 6572 7320 7468 6174  e considers that
-00004a10: 2074 7376 5f70 6174 6820 6973 2074 6865   tsv_path is the
-00004a20: 2070 6174 6820 746f 2061 206d 756c 7469   path to a multi
-00004a30: 2d63 6f68 6f72 7420 5453 562e 0a20 2020  -cohort TSV..   
-00004a40: 2020 2020 2064 6961 676e 6f73 6573 3a20       diagnoses: 
-00004a50: 6c69 7374 206f 6620 7374 720a 2020 2020  list of str.    
-00004a60: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
-00004a70: 6469 6167 6e6f 7365 7320 746f 206c 6f61  diagnoses to loa
-00004a80: 6420 6966 2074 7376 5f70 6174 6820 6973  d if tsv_path is
-00004a90: 2061 2073 706c 6974 5f64 6972 6563 746f   a split_directo
-00004aa0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
-00004ab0: 4465 6661 756c 7420 7573 6573 2074 6865  Default uses the
-00004ac0: 2073 616d 6520 6173 2069 6e20 7472 6169   same as in trai
-00004ad0: 6e69 6e67 2073 7465 702e 0a20 2020 2020  ning step..     
-00004ae0: 2020 2074 6172 6765 745f 6e6f 6465 3a20     target_node: 
-00004af0: 696e 740a 2020 2020 2020 2020 2020 2020  int.            
-00004b00: 4e6f 6465 2066 726f 6d20 7768 6963 6820  Node from which 
-00004b10: 7468 6520 696e 7465 7270 7265 7461 7469  the interpretati
-00004b20: 6f6e 2069 7320 636f 6d70 7574 6564 2e0a  on is computed..
-00004b30: 2020 2020 2020 2020 7361 7665 5f69 6e64          save_ind
-00004b40: 6976 6964 7561 6c3a 2062 6f6f 6c0a 2020  ividual: bool.  
-00004b50: 2020 2020 2020 2020 2020 4966 2054 7275            If Tru
-00004b60: 6520 7361 7665 7320 7468 6520 696e 6469  e saves the indi
-00004b70: 7669 6475 616c 206d 6170 206f 6620 6561  vidual map of ea
-00004b80: 6368 2070 6172 7469 6369 7061 6e74 202f  ch participant /
-00004b90: 2073 6573 7369 6f6e 2063 6f75 706c 652e   session couple.
-00004ba0: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
-00004bb0: 697a 653a 2069 6e74 0a20 2020 2020 2020  ize: int.       
-00004bc0: 2020 2020 2049 6620 6769 7665 6e2c 2073       If given, s
-00004bd0: 6574 7320 7468 6520 7661 6c75 6520 6f66  ets the value of
-00004be0: 2062 6174 6368 5f73 697a 652c 2065 6c73   batch_size, els
-00004bf0: 6520 7573 6520 7468 6520 7361 6d65 2061  e use the same a
-00004c00: 7320 696e 2074 7261 696e 696e 6720 7374  s in training st
-00004c10: 6570 2e0a 2020 2020 2020 2020 6e5f 7072  ep..        n_pr
-00004c20: 6f63 3a20 696e 740a 2020 2020 2020 2020  oc: int.        
-00004c30: 2020 2020 4966 2067 6976 656e 2c20 7365      If given, se
-00004c40: 7473 2074 6865 2076 616c 7565 206f 6620  ts the value of 
-00004c50: 6e75 6d5f 776f 726b 6572 732c 2065 6c73  num_workers, els
-00004c60: 6520 7573 6520 7468 6520 7361 6d65 2061  e use the same a
-00004c70: 7320 696e 2074 7261 696e 696e 6720 7374  s in training st
-00004c80: 6570 2e0a 2020 2020 2020 2020 6770 753a  ep..        gpu:
-00004c90: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
-00004ca0: 2020 4966 2067 6976 656e 2c20 6120 6e65    If given, a ne
-00004cb0: 7720 7661 6c75 6520 666f 7220 7468 6520  w value for the 
-00004cc0: 6465 7669 6365 206f 6620 7468 6520 6d6f  device of the mo
-00004cd0: 6465 6c20 7769 6c6c 2062 6520 636f 6d70  del will be comp
-00004ce0: 7574 6564 2e0a 2020 2020 2020 2020 616d  uted..        am
-00004cf0: 703a 2062 6f6f 6c0a 2020 2020 2020 2020  p: bool.        
-00004d00: 2020 2020 4966 2065 6e61 626c 6564 2c20      If enabled, 
-00004d10: 7573 6573 2041 7574 6f6d 6174 6963 204d  uses Automatic M
-00004d20: 6978 6564 2050 7265 6369 7369 6f6e 2028  ixed Precision (
-00004d30: 7265 7175 6972 6573 2047 5055 2075 7361  requires GPU usa
-00004d40: 6765 292e 0a20 2020 2020 2020 206f 7665  ge)..        ove
-00004d50: 7277 7269 7465 3a20 626f 6f6c 0a20 2020  rwrite: bool.   
-00004d60: 2020 2020 2020 2020 2049 6620 5472 7565           If True
-00004d70: 2065 7261 7365 2074 6865 206f 6363 7572   erase the occur
-00004d80: 7265 6e63 6573 206f 6620 6461 7461 5f67  rences of data_g
-00004d90: 726f 7570 2e0a 2020 2020 2020 2020 6f76  roup..        ov
-00004da0: 6572 7772 6974 655f 6e61 6d65 3a20 626f  erwrite_name: bo
-00004db0: 6f6c 0a20 2020 2020 2020 2020 2020 2049  ol.            I
-00004dc0: 6620 5472 7565 2065 7261 7365 2074 6865  f True erase the
-00004dd0: 206f 6363 7572 7265 6e63 6573 206f 6620   occurrences of 
-00004de0: 6e61 6d65 2e0a 2020 2020 2020 2020 6c65  name..        le
-00004df0: 7665 6c3a 2069 6e74 0a20 2020 2020 2020  vel: int.       
-00004e00: 2020 2020 204c 6179 6572 206e 756d 6265       Layer numbe
-00004e10: 7220 696e 2074 6865 2063 6f6e 766f 6c75  r in the convolu
-00004e20: 7469 6f6e 616c 2070 6172 7420 6166 7465  tional part afte
-00004e30: 7220 7768 6963 6820 7468 6520 6665 6174  r which the feat
-00004e40: 7572 6520 6d61 7020 6973 2063 686f 7365  ure map is chose
-00004e50: 6e2e 0a20 2020 2020 2020 2073 6176 655f  n..        save_
-00004e60: 6e69 6669 203a 2062 6f6f 6c0a 2020 2020  nifi : bool.    
-00004e70: 2020 2020 2020 2020 4966 2054 7275 652c          If True,
-00004e80: 2073 6176 6520 7468 6520 696e 7465 7270   save the interp
-00004e90: 7265 7461 7469 6f6e 206d 6170 2069 6e20  retation map in 
-00004ea0: 6e69 6674 6920 666f 726d 6174 2e0a 2020  nifti format..  
-00004eb0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00004ec0: 2020 2066 726f 6d20 636c 696e 6963 6164     from clinicad
-00004ed0: 6c2e 696e 7465 7270 7265 742e 6772 6164  l.interpret.grad
-00004ee0: 6965 6e74 7320 696d 706f 7274 206d 6574  ients import met
-00004ef0: 686f 645f 6469 6374 0a0a 2020 2020 2020  hod_dict..      
-00004f00: 2020 6966 206d 6574 686f 6420 6e6f 7420    if method not 
-00004f10: 696e 206d 6574 686f 645f 6469 6374 2e6b  in method_dict.k
-00004f20: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-00004f30: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-00004f40: 656d 656e 7465 6445 7272 6f72 280a 2020  ementedError(.  
-00004f50: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00004f60: 496e 7465 7270 7265 7461 7469 6f6e 206d  Interpretation m
-00004f70: 6574 686f 6420 7b6d 6574 686f 647d 2069  ethod {method} i
-00004f80: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-00004f90: 642e 2022 0a20 2020 2020 2020 2020 2020  d. ".           
-00004fa0: 2020 2020 2066 2250 6c65 6173 6520 6368       f"Please ch
-00004fb0: 6f6f 7365 2069 6e20 7b6d 6574 686f 645f  oose in {method_
-00004fc0: 6469 6374 2e6b 6579 7328 297d 220a 2020  dict.keys()}".  
-00004fd0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00004fe0: 2020 2020 2069 6620 6e6f 7420 7370 6c69       if not spli
-00004ff0: 745f 6c69 7374 3a0a 2020 2020 2020 2020  t_list:.        
-00005000: 2020 2020 7370 6c69 745f 6c69 7374 203d      split_list =
-00005010: 2073 656c 662e 5f66 696e 645f 7370 6c69   self._find_spli
-00005020: 7473 2829 0a20 2020 2020 2020 206c 6f67  ts().        log
-00005030: 6765 722e 6465 6275 6728 6622 4c69 7374  ger.debug(f"List
-00005040: 206f 6620 7370 6c69 7473 207b 7370 6c69   of splits {spli
-00005050: 745f 6c69 7374 7d22 290a 0a20 2020 2020  t_list}")..     
-00005060: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-00005070: 5f6e 6574 776f 726b 3a0a 2020 2020 2020  _network:.      
-00005080: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-00005090: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-000050a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000050b0: 2022 5468 6520 696e 7465 7270 7265 7461   "The interpreta
-000050c0: 7469 6f6e 206f 6620 6d75 6c74 692d 6e65  tion of multi-ne
-000050d0: 7477 6f72 6b20 6672 616d 6577 6f72 6b20  twork framework 
-000050e0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-000050f0: 6564 2e22 0a20 2020 2020 2020 2020 2020  ed.".           
-00005100: 2029 0a0a 2020 2020 2020 2020 5f2c 2061   )..        _, a
-00005110: 6c6c 5f74 7261 6e73 666f 726d 7320 3d20  ll_transforms = 
-00005120: 6765 745f 7472 616e 7366 6f72 6d73 280a  get_transforms(.
-00005130: 2020 2020 2020 2020 2020 2020 6e6f 726d              norm
-00005140: 616c 697a 653d 7365 6c66 2e6e 6f72 6d61  alize=self.norma
-00005150: 6c69 7a65 2c0a 2020 2020 2020 2020 2020  lize,.          
-00005160: 2020 6461 7461 5f61 7567 6d65 6e74 6174    data_augmentat
-00005170: 696f 6e3d 7365 6c66 2e64 6174 615f 6175  ion=self.data_au
-00005180: 676d 656e 7461 7469 6f6e 2c0a 2020 2020  gmentation,.    
-00005190: 2020 2020 2020 2020 7369 7a65 5f72 6564          size_red
-000051a0: 7563 7469 6f6e 3d73 656c 662e 7369 7a65  uction=self.size
-000051b0: 5f72 6564 7563 7469 6f6e 2c0a 2020 2020  _reduction,.    
-000051c0: 2020 2020 2020 2020 7369 7a65 5f72 6564          size_red
-000051d0: 7563 7469 6f6e 5f66 6163 746f 723d 7365  uction_factor=se
-000051e0: 6c66 2e73 697a 655f 7265 6475 6374 696f  lf.size_reductio
-000051f0: 6e5f 6661 6374 6f72 2c0a 2020 2020 2020  n_factor,.      
-00005200: 2020 290a 0a20 2020 2020 2020 2067 726f    )..        gro
-00005210: 7570 5f64 6620 3d20 4e6f 6e65 0a20 2020  up_df = None.   
-00005220: 2020 2020 2069 6620 7473 765f 7061 7468       if tsv_path
-00005230: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00005240: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-00005250: 6466 203d 206c 6f61 645f 6461 7461 5f74  df = load_data_t
-00005260: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
-00005270: 2020 2020 2074 7376 5f70 6174 682c 0a20       tsv_path,. 
-00005280: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00005290: 6961 676e 6f73 6573 2069 6620 6c65 6e28  iagnoses if len(
-000052a0: 6469 6167 6e6f 7365 7329 2021 3d20 3020  diagnoses) != 0 
-000052b0: 656c 7365 2073 656c 662e 6469 6167 6e6f  else self.diagno
-000052c0: 7365 732c 0a20 2020 2020 2020 2020 2020  ses,.           
-000052d0: 2020 2020 206d 756c 7469 5f63 6f68 6f72       multi_cohor
-000052e0: 743d 6d75 6c74 695f 636f 686f 7274 2c0a  t=multi_cohort,.
-000052f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00005300: 2020 2020 2020 7365 6c66 2e5f 6368 6563        self._chec
-00005310: 6b5f 6461 7461 5f67 726f 7570 280a 2020  k_data_group(.  
-00005320: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00005330: 726f 7570 2c20 6361 7073 5f64 6972 6563  roup, caps_direc
-00005340: 746f 7279 2c20 6772 6f75 705f 6466 2c20  tory, group_df, 
-00005350: 6d75 6c74 695f 636f 686f 7274 2c20 6f76  multi_cohort, ov
-00005360: 6572 7772 6974 650a 2020 2020 2020 2020  erwrite.        
-00005370: 290a 0a20 2020 2020 2020 2066 6f72 2073  )..        for s
-00005380: 706c 6974 2069 6e20 7370 6c69 745f 6c69  plit in split_li
-00005390: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-000053a0: 6c6f 6767 6572 2e69 6e66 6f28 6622 496e  logger.info(f"In
-000053b0: 7465 7270 7265 7461 7469 6f6e 206f 6620  terpretation of 
-000053c0: 7370 6c69 7420 7b73 706c 6974 7d22 290a  split {split}").
-000053d0: 2020 2020 2020 2020 2020 2020 6466 5f67              df_g
-000053e0: 726f 7570 2c20 7061 7261 6d65 7465 7273  roup, parameters
-000053f0: 5f67 726f 7570 203d 2073 656c 662e 6765  _group = self.ge
-00005400: 745f 6772 6f75 705f 696e 666f 2864 6174  t_group_info(dat
-00005410: 615f 6772 6f75 702c 2073 706c 6974 290a  a_group, split).
-00005420: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00005430: 615f 7465 7374 203d 2072 6574 7572 6e5f  a_test = return_
-00005440: 6461 7461 7365 7428 0a20 2020 2020 2020  dataset(.       
-00005450: 2020 2020 2020 2020 2070 6172 616d 6574           paramet
-00005460: 6572 735f 6772 6f75 705b 2263 6170 735f  ers_group["caps_
-00005470: 6469 7265 6374 6f72 7922 5d2c 0a20 2020  directory"],.   
-00005480: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00005490: 6772 6f75 702c 0a20 2020 2020 2020 2020  group,.         
-000054a0: 2020 2020 2020 2073 656c 662e 7072 6570         self.prep
-000054b0: 726f 6365 7373 696e 675f 6469 6374 2c0a  rocessing_dict,.
-000054c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054d0: 616c 6c5f 7472 616e 7366 6f72 6d61 7469  all_transformati
-000054e0: 6f6e 733d 616c 6c5f 7472 616e 7366 6f72  ons=all_transfor
-000054f0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00005500: 2020 2020 6d75 6c74 695f 636f 686f 7274      multi_cohort
-00005510: 3d70 6172 616d 6574 6572 735f 6772 6f75  =parameters_grou
-00005520: 705b 226d 756c 7469 5f63 6f68 6f72 7422  p["multi_cohort"
-00005530: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00005540: 2020 206c 6162 656c 5f70 7265 7365 6e63     label_presenc
-00005550: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-00005560: 2020 2020 2020 2020 206c 6162 656c 5f63           label_c
-00005570: 6f64 653d 7365 6c66 2e6c 6162 656c 5f63  ode=self.label_c
-00005580: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
-00005590: 2020 2020 206c 6162 656c 3d73 656c 662e       label=self.
-000055a0: 6c61 6265 6c2c 0a20 2020 2020 2020 2020  label,.         
-000055b0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-000055c0: 2020 7465 7374 5f6c 6f61 6465 7220 3d20    test_loader = 
-000055d0: 4461 7461 4c6f 6164 6572 280a 2020 2020  DataLoader(.    
-000055e0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000055f0: 5f74 6573 742c 0a20 2020 2020 2020 2020  _test,.         
-00005600: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
-00005610: 653d 6261 7463 685f 7369 7a65 2069 6620  e=batch_size if 
-00005620: 6261 7463 685f 7369 7a65 2069 7320 6e6f  batch_size is no
-00005630: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
-00005640: 2e62 6174 6368 5f73 697a 652c 0a20 2020  .batch_size,.   
-00005650: 2020 2020 2020 2020 2020 2020 2073 6875               shu
-00005660: 6666 6c65 3d46 616c 7365 2c0a 2020 2020  ffle=False,.    
-00005670: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-00005680: 776f 726b 6572 733d 6e5f 7072 6f63 2069  workers=n_proc i
-00005690: 6620 6e5f 7072 6f63 2069 7320 6e6f 7420  f n_proc is not 
-000056a0: 4e6f 6e65 2065 6c73 6520 7365 6c66 2e6e  None else self.n
-000056b0: 5f70 726f 632c 0a20 2020 2020 2020 2020  _proc,.         
-000056c0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-000056d0: 2020 6966 206e 6f74 2073 656c 6563 7469    if not selecti
-000056e0: 6f6e 5f6d 6574 7269 6373 3a0a 2020 2020  on_metrics:.    
-000056f0: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-00005700: 6374 696f 6e5f 6d65 7472 6963 7320 3d20  ction_metrics = 
-00005710: 7365 6c66 2e5f 6669 6e64 5f73 656c 6563  self._find_selec
-00005720: 7469 6f6e 5f6d 6574 7269 6373 2873 706c  tion_metrics(spl
-00005730: 6974 290a 0a20 2020 2020 2020 2020 2020  it)..           
-00005740: 2066 6f72 2073 656c 6563 7469 6f6e 5f6d   for selection_m
-00005750: 6574 7269 6320 696e 2073 656c 6563 7469  etric in selecti
-00005760: 6f6e 5f6d 6574 7269 6373 3a0a 2020 2020  on_metrics:.    
-00005770: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00005780: 6572 2e69 6e66 6f28 6622 496e 7465 7270  er.info(f"Interp
-00005790: 7265 7461 7469 6f6e 206f 6620 6d65 7472  retation of metr
-000057a0: 6963 207b 7365 6c65 6374 696f 6e5f 6d65  ic {selection_me
-000057b0: 7472 6963 7d22 290a 2020 2020 2020 2020  tric}").        
-000057c0: 2020 2020 2020 2020 7265 7375 6c74 735f          results_
-000057d0: 7061 7468 203d 2028 0a20 2020 2020 2020  path = (.       
-000057e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000057f0: 662e 6d61 7073 5f70 6174 680a 2020 2020  f.maps_path.    
-00005800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005810: 2f20 6622 7b73 656c 662e 7370 6c69 745f  / f"{self.split_
-00005820: 6e61 6d65 7d2d 7b73 706c 6974 7d22 0a20  name}-{split}". 
-00005830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005840: 2020 202f 2066 2262 6573 742d 7b73 656c     / f"best-{sel
-00005850: 6563 7469 6f6e 5f6d 6574 7269 637d 220a  ection_metric}".
-00005860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005870: 2020 2020 2f20 6461 7461 5f67 726f 7570      / data_group
-00005880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005890: 2020 2020 202f 2066 2269 6e74 6572 7072       / f"interpr
-000058a0: 6574 2d7b 6e61 6d65 7d22 0a20 2020 2020  et-{name}".     
-000058b0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000058c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000058d0: 2028 7265 7375 6c74 735f 7061 7468 292e   (results_path).
-000058e0: 6973 5f64 6972 2829 3a0a 2020 2020 2020  is_dir():.      
-000058f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00005900: 206f 7665 7277 7269 7465 5f6e 616d 653a   overwrite_name:
-00005910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005920: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-00005930: 726d 7472 6565 2872 6573 756c 7473 5f70  rmtree(results_p
-00005940: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00005950: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00003770: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003780: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00003790: 7361 7665 5f6c 6174 656e 745f 7465 6e73  save_latent_tens
+000037a0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+000037b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000037c0: 2e5f 636f 6d70 7574 655f 6c61 7465 6e74  ._compute_latent
+000037d0: 5f74 656e 736f 7273 280a 2020 2020 2020  _tensors(.      
+000037e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037f0: 2020 2020 2020 6461 7461 5f74 6573 742c        data_test,
+00003800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003810: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00003820: 615f 6772 6f75 702c 0a20 2020 2020 2020  a_group,.       
+00003830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003840: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
+00003850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003860: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
+00003870: 6e5f 6d65 7472 6963 732c 0a20 2020 2020  n_metrics,.     
+00003880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003890: 2020 2020 2020 2067 7075 3d67 7075 2c0a         gpu=gpu,.
+000038a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038b0: 2020 2020 2020 2020 2020 2020 6e65 7477              netw
+000038c0: 6f72 6b3d 6e65 7477 6f72 6b2c 0a20 2020  ork=network,.   
+000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000038f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003900: 2020 2020 2020 2020 2064 6174 615f 7465           data_te
+00003910: 7374 203d 2072 6574 7572 6e5f 6461 7461  st = return_data
+00003920: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
+00003930: 2020 2020 2020 2020 2067 726f 7570 5f70           group_p
+00003940: 6172 616d 6574 6572 735b 2263 6170 735f  arameters["caps_
+00003950: 6469 7265 6374 6f72 7922 5d2c 0a20 2020  directory"],.   
+00003960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003970: 2067 726f 7570 5f64 662c 0a20 2020 2020   group_df,.     
+00003980: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003990: 656c 662e 7072 6570 726f 6365 7373 696e  elf.preprocessin
+000039a0: 675f 6469 6374 2c0a 2020 2020 2020 2020  g_dict,.        
+000039b0: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+000039c0: 7472 616e 7366 6f72 6d61 7469 6f6e 733d  transformations=
+000039d0: 616c 6c5f 7472 616e 7366 6f72 6d73 2c0a  all_transforms,.
+000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000039f0: 2020 2020 6d75 6c74 695f 636f 686f 7274      multi_cohort
+00003a00: 3d67 726f 7570 5f70 6172 616d 6574 6572  =group_parameter
+00003a10: 735b 226d 756c 7469 5f63 6f68 6f72 7422  s["multi_cohort"
+00003a20: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00003a30: 2020 2020 2020 206c 6162 656c 5f70 7265         label_pre
+00003a40: 7365 6e63 653d 7573 655f 6c61 6265 6c73  sence=use_labels
+00003a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003a60: 2020 2020 2020 6c61 6265 6c3d 7365 6c66        label=self
+00003a70: 2e6c 6162 656c 2069 6620 6c61 6265 6c20  .label if label 
+00003a80: 6973 204e 6f6e 6520 656c 7365 206c 6162  is None else lab
+00003a90: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
+00003aa0: 2020 2020 2020 2020 6c61 6265 6c5f 636f          label_co
+00003ab0: 6465 3d28 0a20 2020 2020 2020 2020 2020  de=(.           
+00003ac0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00003ad0: 662e 6c61 6265 6c5f 636f 6465 2069 6620  f.label_code if 
+00003ae0: 6c61 6265 6c5f 636f 6465 203d 3d20 2264  label_code == "d
+00003af0: 6566 6175 6c74 2220 656c 7365 206c 6162  efault" else lab
+00003b00: 656c 5f63 6f64 650a 2020 2020 2020 2020  el_code.        
+00003b10: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00003b20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00003b30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003b40: 2020 7465 7374 5f6c 6f61 6465 7220 3d20    test_loader = 
+00003b50: 4461 7461 4c6f 6164 6572 280a 2020 2020  DataLoader(.    
+00003b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b70: 6461 7461 5f74 6573 742c 0a20 2020 2020  data_test,.     
+00003b80: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00003b90: 6174 6368 5f73 697a 653d 280a 2020 2020  atch_size=(.    
+00003ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003bb0: 2020 2020 6261 7463 685f 7369 7a65 2069      batch_size i
+00003bc0: 6620 6261 7463 685f 7369 7a65 2069 7320  f batch_size is 
+00003bd0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+00003be0: 6c66 2e62 6174 6368 5f73 697a 650a 2020  lf.batch_size.  
+00003bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c00: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00003c10: 2020 2020 2020 2020 2073 6875 6666 6c65           shuffle
+00003c20: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00003c30: 2020 2020 2020 2020 2020 2020 7361 6d70              samp
+00003c40: 6c65 723d 4469 7374 7269 6275 7465 6453  ler=DistributedS
+00003c50: 616d 706c 6572 280a 2020 2020 2020 2020  ampler(.        
+00003c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c70: 6461 7461 5f74 6573 742c 0a20 2020 2020  data_test,.     
+00003c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c90: 2020 206e 756d 5f72 6570 6c69 6361 733d     num_replicas=
+00003ca0: 636c 7573 7465 722e 776f 726c 645f 7369  cluster.world_si
+00003cb0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+00003cc0: 2020 2020 2020 2020 2020 2020 7261 6e6b              rank
+00003cd0: 3d63 6c75 7374 6572 2e72 616e 6b2c 0a20  =cluster.rank,. 
+00003ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003cf0: 2020 2020 2020 2073 6875 6666 6c65 3d46         shuffle=F
+00003d00: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00003d10: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00003d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d30: 206e 756d 5f77 6f72 6b65 7273 3d6e 5f70   num_workers=n_p
+00003d40: 726f 6320 6966 206e 5f70 726f 6320 6973  roc if n_proc is
+00003d50: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+00003d60: 656c 662e 6e5f 7072 6f63 2c0a 2020 2020  elf.n_proc,.    
+00003d70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00003d80: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00003d90: 6c66 2e5f 7465 7374 5f6c 6f61 6465 7228  lf._test_loader(
+00003da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003db0: 2020 2020 2074 6573 745f 6c6f 6164 6572       test_loader
+00003dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003dd0: 2020 2020 2020 6372 6974 6572 696f 6e2c        criterion,
+00003de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003df0: 2020 2020 2064 6174 615f 6772 6f75 702c       data_group,
+00003e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e10: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
+00003e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e30: 7370 6c69 745f 7365 6c65 6374 696f 6e5f  split_selection_
+00003e40: 6d65 7472 6963 732c 0a20 2020 2020 2020  metrics,.       
+00003e50: 2020 2020 2020 2020 2020 2020 2075 7365               use
+00003e60: 5f6c 6162 656c 733d 7573 655f 6c61 6265  _labels=use_labe
+00003e70: 6c73 2c0a 2020 2020 2020 2020 2020 2020  ls,.            
+00003e80: 2020 2020 2020 2020 6770 753d 6770 752c          gpu=gpu,
+00003e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ea0: 2020 2020 2061 6d70 3d61 6d70 2c0a 2020       amp=amp,.  
+00003eb0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00003ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ed0: 6966 2073 6176 655f 7465 6e73 6f72 3a0a  if save_tensor:.
+00003ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ef0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00003f00: 2822 5361 7669 6e67 2074 656e 736f 7273  ("Saving tensors
+00003f10: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00003f20: 2020 2020 2020 2073 656c 662e 5f63 6f6d         self._com
+00003f30: 7075 7465 5f6f 7574 7075 745f 7465 6e73  pute_output_tens
+00003f40: 6f72 7328 0a20 2020 2020 2020 2020 2020  ors(.           
+00003f50: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00003f60: 615f 7465 7374 2c0a 2020 2020 2020 2020  a_test,.        
+00003f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f80: 6461 7461 5f67 726f 7570 2c0a 2020 2020  data_group,.    
+00003f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fa0: 2020 2020 7370 6c69 742c 0a20 2020 2020      split,.     
+00003fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fc0: 2020 2073 656c 6563 7469 6f6e 5f6d 6574     selection_met
+00003fd0: 7269 6373 2c0a 2020 2020 2020 2020 2020  rics,.          
+00003fe0: 2020 2020 2020 2020 2020 2020 2020 6770                gp
+00003ff0: 753d 6770 752c 0a20 2020 2020 2020 2020  u=gpu,.         
+00004000: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00004020: 7361 7665 5f6e 6966 7469 3a0a 2020 2020  save_nifti:.    
+00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004040: 7365 6c66 2e5f 636f 6d70 7574 655f 6f75  self._compute_ou
+00004050: 7470 7574 5f6e 6966 7469 280a 2020 2020  tput_nifti(.    
+00004060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004070: 2020 2020 6461 7461 5f74 6573 742c 0a20      data_test,. 
+00004080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004090: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
+000040a0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+000040b0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+000040c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000040d0: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+000040e0: 696f 6e5f 6d65 7472 6963 732c 0a20 2020  ion_metrics,.   
+000040f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004100: 2020 2020 2067 7075 3d67 7075 2c0a 2020       gpu=gpu,.  
+00004110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004120: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00004130: 2020 2020 6966 2073 6176 655f 6c61 7465      if save_late
+00004140: 6e74 5f74 656e 736f 723a 0a20 2020 2020  nt_tensor:.     
+00004150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00004160: 656c 662e 5f63 6f6d 7075 7465 5f6c 6174  elf._compute_lat
+00004170: 656e 745f 7465 6e73 6f72 7328 0a20 2020  ent_tensors(.   
+00004180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004190: 2020 2020 2064 6174 615f 7465 7374 2c0a       data_test,.
+000041a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041b0: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
+000041c0: 7570 2c0a 2020 2020 2020 2020 2020 2020  up,.            
+000041d0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+000041e0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000041f0: 2020 2020 2020 2020 2020 2073 656c 6563             selec
+00004200: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
+00004210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004220: 2020 2020 2020 6770 753d 6770 752c 0a20        gpu=gpu,. 
+00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004240: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00004250: 2020 6966 2063 6c75 7374 6572 2e6d 6173    if cluster.mas
+00004260: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+00004270: 2020 2020 2073 656c 662e 5f65 6e73 656d       self._ensem
+00004280: 626c 655f 7072 6564 6963 7469 6f6e 280a  ble_prediction(.
+00004290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042a0: 2020 2020 6461 7461 5f67 726f 7570 2c20      data_group, 
+000042b0: 7370 6c69 742c 2073 656c 6563 7469 6f6e  split, selection
+000042c0: 5f6d 6574 7269 6373 2c20 7573 655f 6c61  _metrics, use_la
+000042d0: 6265 6c73 2c20 736b 6970 5f6c 6561 6b5f  bels, skip_leak_
+000042e0: 6368 6563 6b0a 2020 2020 2020 2020 2020  check.          
+000042f0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00004300: 2069 6e74 6572 7072 6574 280a 2020 2020   interpret(.    
+00004310: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00004320: 2020 6461 7461 5f67 726f 7570 2c0a 2020    data_group,.  
+00004330: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
+00004340: 2020 2020 6d65 7468 6f64 2c0a 2020 2020      method,.    
+00004350: 2020 2020 6361 7073 5f64 6972 6563 746f      caps_directo
+00004360: 7279 3a20 5061 7468 203d 204e 6f6e 652c  ry: Path = None,
+00004370: 0a20 2020 2020 2020 2074 7376 5f70 6174  .        tsv_pat
+00004380: 683a 2050 6174 6820 3d20 4e6f 6e65 2c0a  h: Path = None,.
+00004390: 2020 2020 2020 2020 7370 6c69 745f 6c69          split_li
+000043a0: 7374 3d4e 6f6e 652c 0a20 2020 2020 2020  st=None,.       
+000043b0: 2073 656c 6563 7469 6f6e 5f6d 6574 7269   selection_metri
+000043c0: 6373 3d4e 6f6e 652c 0a20 2020 2020 2020  cs=None,.       
+000043d0: 206d 756c 7469 5f63 6f68 6f72 743d 4661   multi_cohort=Fa
+000043e0: 6c73 652c 0a20 2020 2020 2020 2064 6961  lse,.        dia
+000043f0: 676e 6f73 6573 3d28 292c 0a20 2020 2020  gnoses=(),.     
+00004400: 2020 2074 6172 6765 745f 6e6f 6465 3d30     target_node=0
+00004410: 2c0a 2020 2020 2020 2020 7361 7665 5f69  ,.        save_i
+00004420: 6e64 6976 6964 7561 6c3d 4661 6c73 652c  ndividual=False,
+00004430: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
+00004440: 697a 653d 4e6f 6e65 2c0a 2020 2020 2020  ize=None,.      
+00004450: 2020 6e5f 7072 6f63 3d4e 6f6e 652c 0a20    n_proc=None,. 
+00004460: 2020 2020 2020 2067 7075 3d4e 6f6e 652c         gpu=None,
+00004470: 0a20 2020 2020 2020 2061 6d70 3d46 616c  .        amp=Fal
+00004480: 7365 2c0a 2020 2020 2020 2020 6f76 6572  se,.        over
+00004490: 7772 6974 653d 4661 6c73 652c 0a20 2020  write=False,.   
+000044a0: 2020 2020 206f 7665 7277 7269 7465 5f6e       overwrite_n
+000044b0: 616d 653d 4661 6c73 652c 0a20 2020 2020  ame=False,.     
+000044c0: 2020 206c 6576 656c 3d4e 6f6e 652c 0a20     level=None,. 
+000044d0: 2020 2020 2020 2073 6176 655f 6e69 6674         save_nift
+000044e0: 693d 4661 6c73 652c 0a20 2020 2029 3a0a  i=False,.    ):.
+000044f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00004500: 2020 2020 5065 7266 6f72 6d73 2074 6865      Performs the
+00004510: 2069 6e74 6572 7072 6574 6174 696f 6e20   interpretation 
+00004520: 7461 736b 206f 6e20 6120 7375 6273 6574  task on a subset
+00004530: 206f 6620 6361 7073 5f64 6972 6563 746f   of caps_directo
+00004540: 7279 2064 6566 696e 6564 2069 6e20 6120  ry defined in a 
+00004550: 5453 5620 6669 6c65 2e0a 2020 2020 2020  TSV file..      
+00004560: 2020 5468 6520 6d65 616e 2069 6e74 6572    The mean inter
+00004570: 7072 6574 6174 696f 6e20 6973 2061 6c77  pretation is alw
+00004580: 6179 7320 7361 7665 642c 2074 6f20 7361  ays saved, to sa
+00004590: 7665 2074 6865 2069 6e64 6976 6964 7561  ve the individua
+000045a0: 6c20 696e 7465 7270 7265 7461 7469 6f6e  l interpretation
+000045b0: 7320 7365 7420 7361 7665 5f69 6e64 6976  s set save_indiv
+000045c0: 6964 7561 6c20 746f 2054 7275 652e 0a0a  idual to True...
+000045d0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+000045e0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+000045f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6461  -----.        da
+00004600: 7461 5f67 726f 7570 3a20 7374 720a 2020  ta_group: str.  
+00004610: 2020 2020 2020 2020 2020 4e61 6d65 206f            Name o
+00004620: 6620 7468 6520 6461 7461 2067 726f 7570  f the data group
+00004630: 2069 6e74 6572 7072 6574 6564 2e0a 2020   interpreted..  
+00004640: 2020 2020 2020 6e61 6d65 3a20 7374 720a        name: str.
+00004650: 2020 2020 2020 2020 2020 2020 4e61 6d65              Name
+00004660: 206f 6620 7468 6520 696e 7465 7270 7265   of the interpre
+00004670: 7461 7469 6f6e 2070 726f 6365 6475 7265  tation procedure
+00004680: 2e0a 2020 2020 2020 2020 6d65 7468 6f64  ..        method
+00004690: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
+000046a0: 2020 4d65 7468 6f64 2075 7365 6420 666f    Method used fo
+000046b0: 7220 6578 7472 6163 7469 6f6e 2028 6578  r extraction (ex
+000046c0: 3a20 6772 6164 6965 6e74 732c 2067 7261  : gradients, gra
+000046d0: 642d 6361 6d2e 2e2e 292e 0a20 2020 2020  d-cam...)..     
+000046e0: 2020 2063 6170 735f 6469 7265 6374 6f72     caps_director
+000046f0: 793a 2073 7472 2028 5061 7468 290a 2020  y: str (Path).  
+00004700: 2020 2020 2020 2020 2020 5061 7468 2074            Path t
+00004710: 6f20 7468 6520 4341 5053 2066 6f6c 6465  o the CAPS folde
+00004720: 722e 2046 6f72 206d 6f72 6520 696e 666f  r. For more info
+00004730: 726d 6174 696f 6e20 706c 6561 7365 2072  rmation please r
+00004740: 6566 6572 2074 6f0a 2020 2020 2020 2020  efer to.        
+00004750: 2020 2020 5b63 6c69 6e69 6361 2064 6f63      [clinica doc
+00004760: 756d 656e 7461 7469 6f6e 5d28 6874 7470  umentation](http
+00004770: 733a 2f2f 6172 616d 6973 6c61 622e 7061  s://aramislab.pa
+00004780: 7269 732e 696e 7269 612e 6672 2f63 6c69  ris.inria.fr/cli
+00004790: 6e69 6361 2f64 6f63 732f 7075 626c 6963  nica/docs/public
+000047a0: 2f6c 6174 6573 742f 4341 5053 2f49 6e74  /latest/CAPS/Int
+000047b0: 726f 6475 6374 696f 6e2f 292e 0a20 2020  roduction/)..   
+000047c0: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
+000047d0: 2077 696c 6c20 6c6f 6164 2074 6865 2076   will load the v
+000047e0: 616c 7565 206f 6620 616e 2065 7869 7374  alue of an exist
+000047f0: 696e 6720 6461 7461 2067 726f 7570 2e0a  ing data group..
+00004800: 2020 2020 2020 2020 7473 765f 7061 7468          tsv_path
+00004810: 3a20 7374 7220 2850 6174 6829 0a20 2020  : str (Path).   
+00004820: 2020 2020 2020 2020 2050 6174 6820 746f           Path to
+00004830: 2061 2054 5356 2066 696c 6520 636f 6e74   a TSV file cont
+00004840: 6169 6e69 6e67 2074 6865 206c 6973 7420  aining the list 
+00004850: 6f66 2070 6172 7469 6369 7061 6e74 7320  of participants 
+00004860: 616e 6420 7365 7373 696f 6e73 2074 6f20  and sessions to 
+00004870: 7465 7374 2e0a 2020 2020 2020 2020 2020  test..          
+00004880: 2020 4465 6661 756c 7420 7769 6c6c 206c    Default will l
+00004890: 6f61 6420 7468 6520 4461 7461 4672 616d  oad the DataFram
+000048a0: 6520 6f66 2061 6e20 6578 6973 7469 6e67  e of an existing
+000048b0: 2064 6174 6120 6772 6f75 702e 0a20 2020   data group..   
+000048c0: 2020 2020 2073 706c 6974 5f6c 6973 743a       split_list:
+000048d0: 206c 6973 7420 6f66 2069 6e74 0a20 2020   list of int.   
+000048e0: 2020 2020 2020 2020 204c 6973 7420 6f66           List of
+000048f0: 2073 706c 6974 7320 746f 2069 6e74 6572   splits to inter
+00004900: 7072 6574 2e20 4465 6661 756c 7420 7065  pret. Default pe
+00004910: 7266 6f72 6d20 696e 7465 7270 7265 7461  rform interpreta
+00004920: 7469 6f6e 206f 6e20 616c 6c20 7370 6c69  tion on all spli
+00004930: 7473 2061 7661 696c 6162 6c65 2e0a 2020  ts available..  
+00004940: 2020 2020 2020 7365 6c65 6374 696f 6e5f        selection_
+00004950: 6d65 7472 6963 733a 206c 6973 7420 6f66  metrics: list of
+00004960: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00004970: 204c 6973 7420 6f66 2073 656c 6563 7469   List of selecti
+00004980: 6f6e 206d 6574 7269 6373 2074 6f20 696e  on metrics to in
+00004990: 7465 7270 7265 742e 0a20 2020 2020 2020  terpret..       
+000049a0: 2020 2020 2044 6566 6175 6c74 2070 6572       Default per
+000049b0: 666f 726d 7320 7468 6520 696e 7465 7270  forms the interp
+000049c0: 7265 7461 7469 6f6e 206f 6e20 616c 6c20  retation on all 
+000049d0: 7365 6c65 6374 696f 6e20 6d65 7472 6963  selection metric
+000049e0: 7320 6176 6169 6c61 626c 652e 0a20 2020  s available..   
+000049f0: 2020 2020 206d 756c 7469 5f63 6f68 6f72       multi_cohor
+00004a00: 743a 2062 6f6f 6c0a 2020 2020 2020 2020  t: bool.        
+00004a10: 2020 2020 4966 2054 7275 6520 636f 6e73      If True cons
+00004a20: 6964 6572 7320 7468 6174 2074 7376 5f70  iders that tsv_p
+00004a30: 6174 6820 6973 2074 6865 2070 6174 6820  ath is the path 
+00004a40: 746f 2061 206d 756c 7469 2d63 6f68 6f72  to a multi-cohor
+00004a50: 7420 5453 562e 0a20 2020 2020 2020 2064  t TSV..        d
+00004a60: 6961 676e 6f73 6573 3a20 6c69 7374 206f  iagnoses: list o
+00004a70: 6620 7374 720a 2020 2020 2020 2020 2020  f str.          
+00004a80: 2020 4c69 7374 206f 6620 6469 6167 6e6f    List of diagno
+00004a90: 7365 7320 746f 206c 6f61 6420 6966 2074  ses to load if t
+00004aa0: 7376 5f70 6174 6820 6973 2061 2073 706c  sv_path is a spl
+00004ab0: 6974 5f64 6972 6563 746f 7279 2e0a 2020  it_directory..  
+00004ac0: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
+00004ad0: 7420 7573 6573 2074 6865 2073 616d 6520  t uses the same 
+00004ae0: 6173 2069 6e20 7472 6169 6e69 6e67 2073  as in training s
+00004af0: 7465 702e 0a20 2020 2020 2020 2074 6172  tep..        tar
+00004b00: 6765 745f 6e6f 6465 3a20 696e 740a 2020  get_node: int.  
+00004b10: 2020 2020 2020 2020 2020 4e6f 6465 2066            Node f
+00004b20: 726f 6d20 7768 6963 6820 7468 6520 696e  rom which the in
+00004b30: 7465 7270 7265 7461 7469 6f6e 2069 7320  terpretation is 
+00004b40: 636f 6d70 7574 6564 2e0a 2020 2020 2020  computed..      
+00004b50: 2020 7361 7665 5f69 6e64 6976 6964 7561    save_individua
+00004b60: 6c3a 2062 6f6f 6c0a 2020 2020 2020 2020  l: bool.        
+00004b70: 2020 2020 4966 2054 7275 6520 7361 7665      If True save
+00004b80: 7320 7468 6520 696e 6469 7669 6475 616c  s the individual
+00004b90: 206d 6170 206f 6620 6561 6368 2070 6172   map of each par
+00004ba0: 7469 6369 7061 6e74 202f 2073 6573 7369  ticipant / sessi
+00004bb0: 6f6e 2063 6f75 706c 652e 0a20 2020 2020  on couple..     
+00004bc0: 2020 2062 6174 6368 5f73 697a 653a 2069     batch_size: i
+00004bd0: 6e74 0a20 2020 2020 2020 2020 2020 2049  nt.            I
+00004be0: 6620 6769 7665 6e2c 2073 6574 7320 7468  f given, sets th
+00004bf0: 6520 7661 6c75 6520 6f66 2062 6174 6368  e value of batch
+00004c00: 5f73 697a 652c 2065 6c73 6520 7573 6520  _size, else use 
+00004c10: 7468 6520 7361 6d65 2061 7320 696e 2074  the same as in t
+00004c20: 7261 696e 696e 6720 7374 6570 2e0a 2020  raining step..  
+00004c30: 2020 2020 2020 6e5f 7072 6f63 3a20 696e        n_proc: in
+00004c40: 740a 2020 2020 2020 2020 2020 2020 4966  t.            If
+00004c50: 2067 6976 656e 2c20 7365 7473 2074 6865   given, sets the
+00004c60: 2076 616c 7565 206f 6620 6e75 6d5f 776f   value of num_wo
+00004c70: 726b 6572 732c 2065 6c73 6520 7573 6520  rkers, else use 
+00004c80: 7468 6520 7361 6d65 2061 7320 696e 2074  the same as in t
+00004c90: 7261 696e 696e 6720 7374 6570 2e0a 2020  raining step..  
+00004ca0: 2020 2020 2020 6770 753a 2062 6f6f 6c0a        gpu: bool.
+00004cb0: 2020 2020 2020 2020 2020 2020 4966 2067              If g
+00004cc0: 6976 656e 2c20 6120 6e65 7720 7661 6c75  iven, a new valu
+00004cd0: 6520 666f 7220 7468 6520 6465 7669 6365  e for the device
+00004ce0: 206f 6620 7468 6520 6d6f 6465 6c20 7769   of the model wi
+00004cf0: 6c6c 2062 6520 636f 6d70 7574 6564 2e0a  ll be computed..
+00004d00: 2020 2020 2020 2020 616d 703a 2062 6f6f          amp: boo
+00004d10: 6c0a 2020 2020 2020 2020 2020 2020 4966  l.            If
+00004d20: 2065 6e61 626c 6564 2c20 7573 6573 2041   enabled, uses A
+00004d30: 7574 6f6d 6174 6963 204d 6978 6564 2050  utomatic Mixed P
+00004d40: 7265 6369 7369 6f6e 2028 7265 7175 6972  recision (requir
+00004d50: 6573 2047 5055 2075 7361 6765 292e 0a20  es GPU usage).. 
+00004d60: 2020 2020 2020 206f 7665 7277 7269 7465         overwrite
+00004d70: 3a20 626f 6f6c 0a20 2020 2020 2020 2020  : bool.         
+00004d80: 2020 2049 6620 5472 7565 2065 7261 7365     If True erase
+00004d90: 2074 6865 206f 6363 7572 7265 6e63 6573   the occurrences
+00004da0: 206f 6620 6461 7461 5f67 726f 7570 2e0a   of data_group..
+00004db0: 2020 2020 2020 2020 6f76 6572 7772 6974          overwrit
+00004dc0: 655f 6e61 6d65 3a20 626f 6f6c 0a20 2020  e_name: bool.   
+00004dd0: 2020 2020 2020 2020 2049 6620 5472 7565           If True
+00004de0: 2065 7261 7365 2074 6865 206f 6363 7572   erase the occur
+00004df0: 7265 6e63 6573 206f 6620 6e61 6d65 2e0a  rences of name..
+00004e00: 2020 2020 2020 2020 6c65 7665 6c3a 2069          level: i
+00004e10: 6e74 0a20 2020 2020 2020 2020 2020 204c  nt.            L
+00004e20: 6179 6572 206e 756d 6265 7220 696e 2074  ayer number in t
+00004e30: 6865 2063 6f6e 766f 6c75 7469 6f6e 616c  he convolutional
+00004e40: 2070 6172 7420 6166 7465 7220 7768 6963   part after whic
+00004e50: 6820 7468 6520 6665 6174 7572 6520 6d61  h the feature ma
+00004e60: 7020 6973 2063 686f 7365 6e2e 0a20 2020  p is chosen..   
+00004e70: 2020 2020 2073 6176 655f 6e69 6669 203a       save_nifi :
+00004e80: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
+00004e90: 2020 4966 2054 7275 652c 2073 6176 6520    If True, save 
+00004ea0: 7468 6520 696e 7465 7270 7265 7461 7469  the interpretati
+00004eb0: 6f6e 206d 6170 2069 6e20 6e69 6674 6920  on map in nifti 
+00004ec0: 666f 726d 6174 2e0a 2020 2020 2020 2020  format..        
+00004ed0: 2222 220a 0a20 2020 2020 2020 2066 726f  """..        fro
+00004ee0: 6d20 636c 696e 6963 6164 6c2e 696e 7465  m clinicadl.inte
+00004ef0: 7270 7265 742e 6772 6164 6965 6e74 7320  rpret.gradients 
+00004f00: 696d 706f 7274 206d 6574 686f 645f 6469  import method_di
+00004f10: 6374 0a0a 2020 2020 2020 2020 6966 206d  ct..        if m
+00004f20: 6574 686f 6420 6e6f 7420 696e 206d 6574  ethod not in met
+00004f30: 686f 645f 6469 6374 2e6b 6579 7328 293a  hod_dict.keys():
+00004f40: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00004f50: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+00004f60: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
+00004f70: 2020 2020 2020 2020 6622 496e 7465 7270          f"Interp
+00004f80: 7265 7461 7469 6f6e 206d 6574 686f 6420  retation method 
+00004f90: 7b6d 6574 686f 647d 2069 7320 6e6f 7420  {method} is not 
+00004fa0: 696d 706c 656d 656e 7465 642e 2022 0a20  implemented. ". 
+00004fb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00004fc0: 2250 6c65 6173 6520 6368 6f6f 7365 2069  "Please choose i
+00004fd0: 6e20 7b6d 6574 686f 645f 6469 6374 2e6b  n {method_dict.k
+00004fe0: 6579 7328 297d 220a 2020 2020 2020 2020  eys()}".        
+00004ff0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+00005000: 6620 6e6f 7420 7370 6c69 745f 6c69 7374  f not split_list
+00005010: 3a0a 2020 2020 2020 2020 2020 2020 7370  :.            sp
+00005020: 6c69 745f 6c69 7374 203d 2073 656c 662e  lit_list = self.
+00005030: 5f66 696e 645f 7370 6c69 7473 2829 0a20  _find_splits(). 
+00005040: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00005050: 6275 6728 6622 4c69 7374 206f 6620 7370  bug(f"List of sp
+00005060: 6c69 7473 207b 7370 6c69 745f 6c69 7374  lits {split_list
+00005070: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
+00005080: 7365 6c66 2e6d 756c 7469 5f6e 6574 776f  self.multi_netwo
+00005090: 726b 3a0a 2020 2020 2020 2020 2020 2020  rk:.            
+000050a0: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+000050b0: 6e74 6564 4572 726f 7228 0a20 2020 2020  ntedError(.     
+000050c0: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
+000050d0: 696e 7465 7270 7265 7461 7469 6f6e 206f  interpretation o
+000050e0: 6620 6d75 6c74 692d 6e65 7477 6f72 6b20  f multi-network 
+000050f0: 6672 616d 6577 6f72 6b20 6973 206e 6f74  framework is not
+00005100: 2069 6d70 6c65 6d65 6e74 6564 2e22 0a20   implemented.". 
+00005110: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00005120: 2020 2020 2020 5f2c 2061 6c6c 5f74 7261        _, all_tra
+00005130: 6e73 666f 726d 7320 3d20 6765 745f 7472  nsforms = get_tr
+00005140: 616e 7366 6f72 6d73 280a 2020 2020 2020  ansforms(.      
+00005150: 2020 2020 2020 6e6f 726d 616c 697a 653d        normalize=
+00005160: 7365 6c66 2e6e 6f72 6d61 6c69 7a65 2c0a  self.normalize,.
+00005170: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00005180: 5f61 7567 6d65 6e74 6174 696f 6e3d 7365  _augmentation=se
+00005190: 6c66 2e64 6174 615f 6175 676d 656e 7461  lf.data_augmenta
+000051a0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000051b0: 2020 7369 7a65 5f72 6564 7563 7469 6f6e    size_reduction
+000051c0: 3d73 656c 662e 7369 7a65 5f72 6564 7563  =self.size_reduc
+000051d0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000051e0: 2020 7369 7a65 5f72 6564 7563 7469 6f6e    size_reduction
+000051f0: 5f66 6163 746f 723d 7365 6c66 2e73 697a  _factor=self.siz
+00005200: 655f 7265 6475 6374 696f 6e5f 6661 6374  e_reduction_fact
+00005210: 6f72 2c0a 2020 2020 2020 2020 290a 0a20  or,.        ).. 
+00005220: 2020 2020 2020 2067 726f 7570 5f64 6620         group_df 
+00005230: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
+00005240: 6620 7473 765f 7061 7468 2069 7320 6e6f  f tsv_path is no
+00005250: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00005260: 2020 2020 6772 6f75 705f 6466 203d 206c      group_df = l
+00005270: 6f61 645f 6461 7461 5f74 6573 7428 0a20  oad_data_test(. 
+00005280: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00005290: 7376 5f70 6174 682c 0a20 2020 2020 2020  sv_path,.       
+000052a0: 2020 2020 2020 2020 2064 6961 676e 6f73           diagnos
+000052b0: 6573 2069 6620 6c65 6e28 6469 6167 6e6f  es if len(diagno
+000052c0: 7365 7329 2021 3d20 3020 656c 7365 2073  ses) != 0 else s
+000052d0: 656c 662e 6469 6167 6e6f 7365 732c 0a20  elf.diagnoses,. 
+000052e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000052f0: 756c 7469 5f63 6f68 6f72 743d 6d75 6c74  ulti_cohort=mult
+00005300: 695f 636f 686f 7274 2c0a 2020 2020 2020  i_cohort,.      
+00005310: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00005320: 7365 6c66 2e5f 6368 6563 6b5f 6461 7461  self._check_data
+00005330: 5f67 726f 7570 280a 2020 2020 2020 2020  _group(.        
+00005340: 2020 2020 6461 7461 5f67 726f 7570 2c20      data_group, 
+00005350: 6361 7073 5f64 6972 6563 746f 7279 2c20  caps_directory, 
+00005360: 6772 6f75 705f 6466 2c20 6d75 6c74 695f  group_df, multi_
+00005370: 636f 686f 7274 2c20 6f76 6572 7772 6974  cohort, overwrit
+00005380: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
+00005390: 2020 2020 2066 6f72 2073 706c 6974 2069       for split i
+000053a0: 6e20 7370 6c69 745f 6c69 7374 3a0a 2020  n split_list:.  
+000053b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000053c0: 2e69 6e66 6f28 6622 496e 7465 7270 7265  .info(f"Interpre
+000053d0: 7461 7469 6f6e 206f 6620 7370 6c69 7420  tation of split 
+000053e0: 7b73 706c 6974 7d22 290a 2020 2020 2020  {split}").      
+000053f0: 2020 2020 2020 6466 5f67 726f 7570 2c20        df_group, 
+00005400: 7061 7261 6d65 7465 7273 5f67 726f 7570  parameters_group
+00005410: 203d 2073 656c 662e 6765 745f 6772 6f75   = self.get_grou
+00005420: 705f 696e 666f 2864 6174 615f 6772 6f75  p_info(data_grou
+00005430: 702c 2073 706c 6974 290a 0a20 2020 2020  p, split)..     
+00005440: 2020 2020 2020 2064 6174 615f 7465 7374         data_test
+00005450: 203d 2072 6574 7572 6e5f 6461 7461 7365   = return_datase
+00005460: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00005470: 2020 2070 6172 616d 6574 6572 735f 6772     parameters_gr
+00005480: 6f75 705b 2263 6170 735f 6469 7265 6374  oup["caps_direct
+00005490: 6f72 7922 5d2c 0a20 2020 2020 2020 2020  ory"],.         
+000054a0: 2020 2020 2020 2064 665f 6772 6f75 702c         df_group,
+000054b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000054c0: 2073 656c 662e 7072 6570 726f 6365 7373   self.preprocess
+000054d0: 696e 675f 6469 6374 2c0a 2020 2020 2020  ing_dict,.      
+000054e0: 2020 2020 2020 2020 2020 616c 6c5f 7472            all_tr
+000054f0: 616e 7366 6f72 6d61 7469 6f6e 733d 616c  ansformations=al
+00005500: 6c5f 7472 616e 7366 6f72 6d73 2c0a 2020  l_transforms,.  
+00005510: 2020 2020 2020 2020 2020 2020 2020 6d75                mu
+00005520: 6c74 695f 636f 686f 7274 3d70 6172 616d  lti_cohort=param
+00005530: 6574 6572 735f 6772 6f75 705b 226d 756c  eters_group["mul
+00005540: 7469 5f63 6f68 6f72 7422 5d2c 0a20 2020  ti_cohort"],.   
+00005550: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+00005560: 656c 5f70 7265 7365 6e63 653d 4661 6c73  el_presence=Fals
+00005570: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00005580: 2020 206c 6162 656c 5f63 6f64 653d 7365     label_code=se
+00005590: 6c66 2e6c 6162 656c 5f63 6f64 652c 0a20  lf.label_code,. 
+000055a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000055b0: 6162 656c 3d73 656c 662e 6c61 6265 6c2c  abel=self.label,
+000055c0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000055d0: 2020 2020 2020 2020 2020 2020 7465 7374              test
+000055e0: 5f6c 6f61 6465 7220 3d20 4461 7461 4c6f  _loader = DataLo
+000055f0: 6164 6572 280a 2020 2020 2020 2020 2020  ader(.          
+00005600: 2020 2020 2020 6461 7461 5f74 6573 742c        data_test,
+00005610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005620: 2062 6174 6368 5f73 697a 653d 6261 7463   batch_size=batc
+00005630: 685f 7369 7a65 2069 6620 6261 7463 685f  h_size if batch_
+00005640: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
+00005650: 2065 6c73 6520 7365 6c66 2e62 6174 6368   else self.batch
+00005660: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
+00005670: 2020 2020 2020 2073 6875 6666 6c65 3d46         shuffle=F
+00005680: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00005690: 2020 2020 2020 6e75 6d5f 776f 726b 6572        num_worker
+000056a0: 733d 6e5f 7072 6f63 2069 6620 6e5f 7072  s=n_proc if n_pr
+000056b0: 6f63 2069 7320 6e6f 7420 4e6f 6e65 2065  oc is not None e
+000056c0: 6c73 6520 7365 6c66 2e6e 5f70 726f 632c  lse self.n_proc,
+000056d0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000056e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000056f0: 6f74 2073 656c 6563 7469 6f6e 5f6d 6574  ot selection_met
+00005700: 7269 6373 3a0a 2020 2020 2020 2020 2020  rics:.          
+00005710: 2020 2020 2020 7365 6c65 6374 696f 6e5f        selection_
+00005720: 6d65 7472 6963 7320 3d20 7365 6c66 2e5f  metrics = self._
+00005730: 6669 6e64 5f73 656c 6563 7469 6f6e 5f6d  find_selection_m
+00005740: 6574 7269 6373 2873 706c 6974 290a 0a20  etrics(split).. 
+00005750: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+00005760: 656c 6563 7469 6f6e 5f6d 6574 7269 6320  election_metric 
+00005770: 696e 2073 656c 6563 7469 6f6e 5f6d 6574  in selection_met
+00005780: 7269 6373 3a0a 2020 2020 2020 2020 2020  rics:.          
+00005790: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+000057a0: 6f28 6622 496e 7465 7270 7265 7461 7469  o(f"Interpretati
+000057b0: 6f6e 206f 6620 6d65 7472 6963 207b 7365  on of metric {se
+000057c0: 6c65 6374 696f 6e5f 6d65 7472 6963 7d22  lection_metric}"
+000057d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000057e0: 2020 7265 7375 6c74 735f 7061 7468 203d    results_path =
+000057f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00005800: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
+00005810: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
+00005820: 2020 2020 2020 2020 2020 2f20 6622 7b73            / f"{s
+00005830: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
+00005840: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
+00005850: 2020 2020 2020 2020 2020 2020 202f 2066               / f
+00005860: 2262 6573 742d 7b73 656c 6563 7469 6f6e  "best-{selection
+00005870: 5f6d 6574 7269 637d 220a 2020 2020 2020  _metric}".      
+00005880: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+00005890: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
+000058a0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+000058b0: 2066 2269 6e74 6572 7072 6574 2d7b 6e61   f"interpret-{na
+000058c0: 6d65 7d22 0a20 2020 2020 2020 2020 2020  me}".           
+000058d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000058e0: 2020 2020 2020 2020 6966 2028 7265 7375          if (resu
+000058f0: 6c74 735f 7061 7468 292e 6973 5f64 6972  lts_path).is_dir
+00005900: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00005910: 2020 2020 2020 2020 6966 206f 7665 7277          if overw
+00005920: 7269 7465 5f6e 616d 653a 0a20 2020 2020  rite_name:.     
+00005930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005940: 2020 2073 6875 7469 6c2e 726d 7472 6565     shutil.rmtree
+00005950: 2872 6573 756c 7473 5f70 6174 6829 0a20  (results_path). 
 00005960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005970: 2020 2020 2020 2072 6169 7365 204d 4150         raise MAP
-00005980: 5345 7272 6f72 280a 2020 2020 2020 2020  SError(.        
-00005990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059a0: 2020 2020 6622 496e 7465 7270 7265 7461      f"Interpreta
-000059b0: 7469 6f6e 206e 616d 6520 7b6e 616d 657d  tion name {name}
-000059c0: 2069 7320 616c 7265 6164 7920 7772 6974   is already writ
-000059d0: 7465 6e2e 2022 0a20 2020 2020 2020 2020  ten. ".         
-000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059f0: 2020 2066 2250 6c65 6173 6520 6368 6f6f     f"Please choo
-00005a00: 7365 2061 6e6f 7468 6572 206e 616d 6520  se another name 
-00005a10: 6f72 2073 6574 206f 7665 7277 7269 7465  or set overwrite
-00005a20: 5f6e 616d 6520 746f 2054 7275 652e 220a  _name to True.".
-00005a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00005a50: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00005a60: 735f 7061 7468 2e6d 6b64 6972 2870 6172  s_path.mkdir(par
-00005a70: 656e 7473 3d54 7275 6529 0a0a 2020 2020  ents=True)..    
-00005a80: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00005a90: 6c2c 205f 203d 2073 656c 662e 5f69 6e69  l, _ = self._ini
-00005aa0: 745f 6d6f 6465 6c28 0a20 2020 2020 2020  t_model(.       
-00005ab0: 2020 2020 2020 2020 2020 2020 2074 7261               tra
-00005ac0: 6e73 6665 725f 7061 7468 3d73 656c 662e  nsfer_path=self.
-00005ad0: 6d61 7073 5f70 6174 682c 0a20 2020 2020  maps_path,.     
-00005ae0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00005af0: 706c 6974 3d73 706c 6974 2c0a 2020 2020  plit=split,.    
-00005b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b10: 7472 616e 7366 6572 5f73 656c 6563 7469  transfer_selecti
-00005b20: 6f6e 3d73 656c 6563 7469 6f6e 5f6d 6574  on=selection_met
-00005b30: 7269 632c 0a20 2020 2020 2020 2020 2020  ric,.           
-00005b40: 2020 2020 2020 2020 2067 7075 3d67 7075           gpu=gpu
-00005b50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005b60: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00005b70: 2020 2020 2069 6e74 6572 7072 6574 6572       interpreter
-00005b80: 203d 206d 6574 686f 645f 6469 6374 5b6d   = method_dict[m
-00005b90: 6574 686f 645d 286d 6f64 656c 290a 0a20  ethod](model).. 
-00005ba0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00005bb0: 756d 5f6d 6170 7320 3d20 5b30 5d20 2a20  um_maps = [0] * 
-00005bc0: 6461 7461 5f74 6573 742e 656c 656d 5f70  data_test.elem_p
-00005bd0: 6572 5f69 6d61 6765 0a20 2020 2020 2020  er_image.       
-00005be0: 2020 2020 2020 2020 2066 6f72 2064 6174           for dat
-00005bf0: 6120 696e 2074 6573 745f 6c6f 6164 6572  a in test_loader
-00005c00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005c10: 2020 2020 2020 696d 6167 6573 203d 2064        images = d
-00005c20: 6174 615b 2269 6d61 6765 225d 2e74 6f28  ata["image"].to(
-00005c30: 6d6f 6465 6c2e 6465 7669 6365 290a 0a20  model.device).. 
-00005c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c50: 2020 206d 6170 5f70 7420 3d20 696e 7465     map_pt = inte
-00005c60: 7270 7265 7465 722e 6765 6e65 7261 7465  rpreter.generate
-00005c70: 5f67 7261 6469 656e 7473 280a 2020 2020  _gradients(.    
-00005c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c90: 2020 2020 696d 6167 6573 2c20 7461 7267      images, targ
-00005ca0: 6574 5f6e 6f64 652c 206c 6576 656c 3d6c  et_node, level=l
-00005cb0: 6576 656c 2c20 616d 703d 616d 700a 2020  evel, amp=amp.  
-00005cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cd0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00005ce0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00005cf0: 2072 616e 6765 286c 656e 2864 6174 615b   range(len(data[
-00005d00: 2270 6172 7469 6369 7061 6e74 5f69 6422  "participant_id"
-00005d10: 5d29 293a 0a20 2020 2020 2020 2020 2020  ])):.           
-00005d20: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00005d30: 655f 6964 203d 2064 6174 615b 6622 7b73  e_id = data[f"{s
-00005d40: 656c 662e 6d6f 6465 7d5f 6964 225d 5b69  elf.mode}_id"][i
-00005d50: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00005d60: 2020 2020 2020 2020 2020 6375 6d5f 6d61            cum_ma
-00005d70: 7073 5b6d 6f64 655f 6964 5d20 2b3d 206d  ps[mode_id] += m
-00005d80: 6170 5f70 745b 695d 0a20 2020 2020 2020  ap_pt[i].       
-00005d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005da0: 2069 6620 7361 7665 5f69 6e64 6976 6964   if save_individ
-00005db0: 7561 6c3a 0a20 2020 2020 2020 2020 2020  ual:.           
-00005dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005dd0: 2073 696e 676c 655f 7061 7468 203d 2028   single_path = (
-00005de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e00: 2072 6573 756c 7473 5f70 6174 680a 2020   results_path.  
-00005e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e20: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-00005e30: 6622 7b64 6174 615b 2770 6172 7469 6369  f"{data['partici
-00005e40: 7061 6e74 5f69 6427 5d5b 695d 7d5f 7b64  pant_id'][i]}_{d
-00005e50: 6174 615b 2773 6573 7369 6f6e 5f69 6427  ata['session_id'
-00005e60: 5d5b 695d 7d5f 7b73 656c 662e 6d6f 6465  ][i]}_{self.mode
-00005e70: 7d2d 7b64 6174 615b 6627 7b73 656c 662e  }-{data[f'{self.
-00005e80: 6d6f 6465 7d5f 6964 275d 5b69 5d7d 5f6d  mode}_id'][i]}_m
-00005e90: 6170 2e70 7422 0a20 2020 2020 2020 2020  ap.pt".         
-00005ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005eb0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00005ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ed0: 2074 6f72 6368 2e73 6176 6528 6d61 705f   torch.save(map_
-00005ee0: 7074 5b69 5d2c 2073 696e 676c 655f 7061  pt[i], single_pa
-00005ef0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00005f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f10: 6966 2073 6176 655f 6e69 6674 693a 0a20  if save_nifti:. 
-00005f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00005f40: 6d70 6f72 7420 6e69 6261 6265 6c20 6173  mport nibabel as
-00005f50: 206e 6962 0a20 2020 2020 2020 2020 2020   nib.           
-00005f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f70: 2020 2020 2066 726f 6d20 6e75 6d70 7920       from numpy 
-00005f80: 696d 706f 7274 2065 7965 0a0a 2020 2020  import eye..    
-00005f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fa0: 2020 2020 2020 2020 2020 2020 7369 6e67              sing
-00005fb0: 6c65 5f6e 6966 7469 5f70 6174 6820 3d20  le_nifti_path = 
-00005fc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00005fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fe0: 2020 2020 2020 7265 7375 6c74 735f 7061        results_pa
-00005ff0: 7468 0a20 2020 2020 2020 2020 2020 2020  th.             
-00006000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006010: 2020 2020 2020 202f 2066 227b 6461 7461         / f"{data
-00006020: 5b27 7061 7274 6963 6970 616e 745f 6964  ['participant_id
-00006030: 275d 5b69 5d7d 5f7b 6461 7461 5b27 7365  '][i]}_{data['se
-00006040: 7373 696f 6e5f 6964 275d 5b69 5d7d 5f7b  ssion_id'][i]}_{
-00006050: 7365 6c66 2e6d 6f64 657d 2d7b 6461 7461  self.mode}-{data
-00006060: 5b66 277b 7365 6c66 2e6d 6f64 657d 5f69  [f'{self.mode}_i
-00006070: 6427 5d5b 695d 7d5f 6d61 702e 6e69 692e  d'][i]}_map.nii.
-00006080: 677a 220a 2020 2020 2020 2020 2020 2020  gz".            
-00006090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060a0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-000060b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060c0: 2020 2020 2020 206f 7574 7075 745f 6e69         output_ni
-000060d0: 6920 3d20 6e69 622e 4e69 6674 6931 496d  i = nib.Nifti1Im
-000060e0: 6167 6528 6d61 705f 7074 5b69 5d2e 6e75  age(map_pt[i].nu
-000060f0: 6d70 7928 292c 2065 7965 2834 2929 0a20  mpy(), eye(4)). 
-00006100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006110: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006120: 6962 2e73 6176 6528 6f75 7470 7574 5f6e  ib.save(output_n
-00006130: 6969 2c20 7369 6e67 6c65 5f6e 6966 7469  ii, single_nifti
-00006140: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00006150: 2020 2020 2020 2020 666f 7220 692c 206d          for i, m
-00006160: 6f64 655f 6d61 7020 696e 2065 6e75 6d65  ode_map in enume
-00006170: 7261 7465 2863 756d 5f6d 6170 7329 3a0a  rate(cum_maps):.
-00006180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006190: 2020 2020 6d6f 6465 5f6d 6170 202f 3d20      mode_map /= 
-000061a0: 6c65 6e28 6461 7461 5f74 6573 7429 0a0a  len(data_test)..
-000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061c0: 2020 2020 746f 7263 682e 7361 7665 280a      torch.save(.
-000061d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061e0: 2020 2020 2020 2020 6d6f 6465 5f6d 6170          mode_map
-000061f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006200: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00006210: 735f 7061 7468 202f 2066 226d 6561 6e5f  s_path / f"mean_
-00006220: 7b73 656c 662e 6d6f 6465 7d2d 7b69 7d5f  {self.mode}-{i}_
-00006230: 6d61 702e 7074 222c 0a20 2020 2020 2020  map.pt",.       
-00006240: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00006250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006260: 2020 2069 6620 7361 7665 5f6e 6966 7469     if save_nifti
-00006270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006280: 2020 2020 2020 2020 2020 696d 706f 7274            import
-00006290: 206e 6962 6162 656c 2061 7320 6e69 620a   nibabel as nib.
-000062a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062b0: 2020 2020 2020 2020 6672 6f6d 206e 756d          from num
-000062c0: 7079 2069 6d70 6f72 7420 6579 650a 0a20  py import eye.. 
-000062d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062e0: 2020 2020 2020 206f 7574 7075 745f 6e69         output_ni
-000062f0: 6920 3d20 6e69 622e 4e69 6674 6931 496d  i = nib.Nifti1Im
-00006300: 6167 6528 6d6f 6465 5f6d 6170 2c20 6579  age(mode_map, ey
-00006310: 6528 3429 290a 2020 2020 2020 2020 2020  e(4)).          
-00006320: 2020 2020 2020 2020 2020 2020 2020 6e69                ni
-00006330: 622e 7361 7665 280a 2020 2020 2020 2020  b.save(.        
+00005970: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00005980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005990: 2072 6169 7365 204d 4150 5345 7272 6f72   raise MAPSError
+000059a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000059b0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000059c0: 496e 7465 7270 7265 7461 7469 6f6e 206e  Interpretation n
+000059d0: 616d 6520 7b6e 616d 657d 2069 7320 616c  ame {name} is al
+000059e0: 7265 6164 7920 7772 6974 7465 6e2e 2022  ready written. "
+000059f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005a00: 2020 2020 2020 2020 2020 2020 2066 2250               f"P
+00005a10: 6c65 6173 6520 6368 6f6f 7365 2061 6e6f  lease choose ano
+00005a20: 7468 6572 206e 616d 6520 6f72 2073 6574  ther name or set
+00005a30: 206f 7665 7277 7269 7465 5f6e 616d 6520   overwrite_name 
+00005a40: 746f 2054 7275 652e 220a 2020 2020 2020  to True.".      
+00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00005a70: 2020 2020 7265 7375 6c74 735f 7061 7468      results_path
+00005a80: 2e6d 6b64 6972 2870 6172 656e 7473 3d54  .mkdir(parents=T
+00005a90: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
+00005aa0: 2020 2020 2020 6d6f 6465 6c2c 205f 203d        model, _ =
+00005ab0: 2073 656c 662e 5f69 6e69 745f 6d6f 6465   self._init_mode
+00005ac0: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00005ad0: 2020 2020 2020 2074 7261 6e73 6665 725f         transfer_
+00005ae0: 7061 7468 3d73 656c 662e 6d61 7073 5f70  path=self.maps_p
+00005af0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00005b00: 2020 2020 2020 2020 2073 706c 6974 3d73           split=s
+00005b10: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+00005b20: 2020 2020 2020 2020 2020 7472 616e 7366            transf
+00005b30: 6572 5f73 656c 6563 7469 6f6e 3d73 656c  er_selection=sel
+00005b40: 6563 7469 6f6e 5f6d 6574 7269 632c 0a20  ection_metric,. 
+00005b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b60: 2020 2067 7075 3d67 7075 2c0a 2020 2020     gpu=gpu,.    
+00005b70: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00005b80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00005b90: 6e74 6572 7072 6574 6572 203d 206d 6574  nterpreter = met
+00005ba0: 686f 645f 6469 6374 5b6d 6574 686f 645d  hod_dict[method]
+00005bb0: 286d 6f64 656c 290a 0a20 2020 2020 2020  (model)..       
+00005bc0: 2020 2020 2020 2020 2063 756d 5f6d 6170           cum_map
+00005bd0: 7320 3d20 5b30 5d20 2a20 6461 7461 5f74  s = [0] * data_t
+00005be0: 6573 742e 656c 656d 5f70 6572 5f69 6d61  est.elem_per_ima
+00005bf0: 6765 0a20 2020 2020 2020 2020 2020 2020  ge.             
+00005c00: 2020 2066 6f72 2064 6174 6120 696e 2074     for data in t
+00005c10: 6573 745f 6c6f 6164 6572 3a0a 2020 2020  est_loader:.    
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c30: 696d 6167 6573 203d 2064 6174 615b 2269  images = data["i
+00005c40: 6d61 6765 225d 2e74 6f28 6d6f 6465 6c2e  mage"].to(model.
+00005c50: 6465 7669 6365 290a 0a20 2020 2020 2020  device)..       
+00005c60: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00005c70: 5f70 7420 3d20 696e 7465 7270 7265 7465  _pt = interprete
+00005c80: 722e 6765 6e65 7261 7465 5f67 7261 6469  r.generate_gradi
+00005c90: 656e 7473 280a 2020 2020 2020 2020 2020  ents(.          
+00005ca0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00005cb0: 6167 6573 2c20 7461 7267 6574 5f6e 6f64  ages, target_nod
+00005cc0: 652c 206c 6576 656c 3d6c 6576 656c 2c20  e, level=level, 
+00005cd0: 616d 703d 616d 700a 2020 2020 2020 2020  amp=amp.        
+00005ce0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00005cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d00: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00005d10: 286c 656e 2864 6174 615b 2270 6172 7469  (len(data["parti
+00005d20: 6369 7061 6e74 5f69 6422 5d29 293a 0a20  cipant_id"])):. 
+00005d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d40: 2020 2020 2020 206d 6f64 655f 6964 203d         mode_id =
+00005d50: 2064 6174 615b 6622 7b73 656c 662e 6d6f   data[f"{self.mo
+00005d60: 6465 7d5f 6964 225d 5b69 5d0a 2020 2020  de}_id"][i].    
+00005d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d80: 2020 2020 6375 6d5f 6d61 7073 5b6d 6f64      cum_maps[mod
+00005d90: 655f 6964 5d20 2b3d 206d 6170 5f70 745b  e_id] += map_pt[
+00005da0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00005db0: 2020 2020 2020 2020 2020 2069 6620 7361             if sa
+00005dc0: 7665 5f69 6e64 6976 6964 7561 6c3a 0a20  ve_individual:. 
+00005dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005de0: 2020 2020 2020 2020 2020 2073 696e 676c             singl
+00005df0: 655f 7061 7468 203d 2028 0a20 2020 2020  e_path = (.     
+00005e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e10: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00005e20: 7473 5f70 6174 680a 2020 2020 2020 2020  ts_path.        
+00005e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e40: 2020 2020 2020 2020 2f20 6622 7b64 6174          / f"{dat
+00005e50: 615b 2770 6172 7469 6369 7061 6e74 5f69  a['participant_i
+00005e60: 6427 5d5b 695d 7d5f 7b64 6174 615b 2773  d'][i]}_{data['s
+00005e70: 6573 7369 6f6e 5f69 6427 5d5b 695d 7d5f  ession_id'][i]}_
+00005e80: 7b73 656c 662e 6d6f 6465 7d2d 7b64 6174  {self.mode}-{dat
+00005e90: 615b 6627 7b73 656c 662e 6d6f 6465 7d5f  a[f'{self.mode}_
+00005ea0: 6964 275d 5b69 5d7d 5f6d 6170 2e70 7422  id'][i]}_map.pt"
+00005eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ec0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00005ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ee0: 2020 2020 2020 2020 2020 2074 6f72 6368             torch
+00005ef0: 2e73 6176 6528 6d61 705f 7074 5b69 5d2c  .save(map_pt[i],
+00005f00: 2073 696e 676c 655f 7061 7468 290a 2020   single_path).  
+00005f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f20: 2020 2020 2020 2020 2020 6966 2073 6176            if sav
+00005f30: 655f 6e69 6674 693a 0a20 2020 2020 2020  e_nifti:.       
+00005f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f50: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+00005f60: 6e69 6261 6265 6c20 6173 206e 6962 0a20  nibabel as nib. 
+00005f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00005f90: 726f 6d20 6e75 6d70 7920 696d 706f 7274  rom numpy import
+00005fa0: 2065 7965 0a0a 2020 2020 2020 2020 2020   eye..          
+00005fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fc0: 2020 2020 2020 7369 6e67 6c65 5f6e 6966        single_nif
+00005fd0: 7469 5f70 6174 6820 3d20 280a 2020 2020  ti_path = (.    
+00005fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006000: 7265 7375 6c74 735f 7061 7468 0a20 2020  results_path.   
+00006010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006030: 202f 2066 227b 6461 7461 5b27 7061 7274   / f"{data['part
+00006040: 6963 6970 616e 745f 6964 275d 5b69 5d7d  icipant_id'][i]}
+00006050: 5f7b 6461 7461 5b27 7365 7373 696f 6e5f  _{data['session_
+00006060: 6964 275d 5b69 5d7d 5f7b 7365 6c66 2e6d  id'][i]}_{self.m
+00006070: 6f64 657d 2d7b 6461 7461 5b66 277b 7365  ode}-{data[f'{se
+00006080: 6c66 2e6d 6f64 657d 5f69 6427 5d5b 695d  lf.mode}_id'][i]
+00006090: 7d5f 6d61 702e 6e69 692e 677a 220a 2020  }_map.nii.gz".  
+000060a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000060c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000060d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060e0: 206f 7574 7075 745f 6e69 6920 3d20 6e69   output_nii = ni
+000060f0: 622e 4e69 6674 6931 496d 6167 6528 6d61  b.Nifti1Image(ma
+00006100: 705f 7074 5b69 5d2e 6e75 6d70 7928 292c  p_pt[i].numpy(),
+00006110: 2065 7965 2834 2929 0a20 2020 2020 2020   eye(4)).       
+00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006130: 2020 2020 2020 2020 206e 6962 2e73 6176           nib.sav
+00006140: 6528 6f75 7470 7574 5f6e 6969 2c20 7369  e(output_nii, si
+00006150: 6e67 6c65 5f6e 6966 7469 5f70 6174 6829  ngle_nifti_path)
+00006160: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006170: 2020 666f 7220 692c 206d 6f64 655f 6d61    for i, mode_ma
+00006180: 7020 696e 2065 6e75 6d65 7261 7465 2863  p in enumerate(c
+00006190: 756d 5f6d 6170 7329 3a0a 2020 2020 2020  um_maps):.      
+000061a0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+000061b0: 6465 5f6d 6170 202f 3d20 6c65 6e28 6461  de_map /= len(da
+000061c0: 7461 5f74 6573 7429 0a0a 2020 2020 2020  ta_test)..      
+000061d0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000061e0: 7263 682e 7361 7665 280a 2020 2020 2020  rch.save(.      
+000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006200: 2020 6d6f 6465 5f6d 6170 2c0a 2020 2020    mode_map,.    
+00006210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006220: 2020 2020 7265 7375 6c74 735f 7061 7468      results_path
+00006230: 202f 2066 226d 6561 6e5f 7b73 656c 662e   / f"mean_{self.
+00006240: 6d6f 6465 7d2d 7b69 7d5f 6d61 702e 7074  mode}-{i}_map.pt
+00006250: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00006260: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006270: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00006280: 7361 7665 5f6e 6966 7469 3a0a 2020 2020  save_nifti:.    
+00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062a0: 2020 2020 696d 706f 7274 206e 6962 6162      import nibab
+000062b0: 656c 2061 7320 6e69 620a 2020 2020 2020  el as nib.      
+000062c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062d0: 2020 6672 6f6d 206e 756d 7079 2069 6d70    from numpy imp
+000062e0: 6f72 7420 6579 650a 0a20 2020 2020 2020  ort eye..       
+000062f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006300: 206f 7574 7075 745f 6e69 6920 3d20 6e69   output_nii = ni
+00006310: 622e 4e69 6674 6931 496d 6167 6528 6d6f  b.Nifti1Image(mo
+00006320: 6465 5f6d 6170 2e6e 756d 7079 2829 2c20  de_map.numpy(), 
+00006330: 6579 6528 3429 290a 2020 2020 2020 2020  eye(4)).        
 00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006350: 2020 2020 6f75 7470 7574 5f6e 6969 2c0a      output_nii,.
+00006350: 6e69 622e 7361 7665 280a 2020 2020 2020  nib.save(.      
 00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006370: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00006380: 6c74 735f 7061 7468 202f 2066 226d 6561  lts_path / f"mea
-00006390: 6e5f 7b73 656c 662e 6d6f 6465 7d2d 7b69  n_{self.mode}-{i
-000063a0: 7d5f 6d61 702e 6e69 692e 677a 222c 0a20  }_map.nii.gz",. 
-000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063c0: 2020 2020 2020 2029 0a0a 2020 2020 2323         )..    ##
-000063d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000063e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000063f0: 230a 2020 2020 2320 4869 6768 2d6c 6576  #.    # High-lev
-00006400: 656c 2066 756e 6374 696f 6e73 2074 656d  el functions tem
-00006410: 706c 6174 6573 2020 230a 2020 2020 2323  plates  #.    ##
-00006420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00006430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00006440: 230a 2020 2020 6465 6620 5f74 7261 696e  #.    def _train
-00006450: 5f73 696e 676c 6528 7365 6c66 2c20 7370  _single(self, sp
-00006460: 6c69 745f 6c69 7374 3d4e 6f6e 652c 2072  lit_list=None, r
-00006470: 6573 756d 653d 4661 6c73 6529 3a0a 2020  esume=False):.  
-00006480: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00006490: 2020 5472 6169 6e73 2061 2073 696e 676c    Trains a singl
-000064a0: 6520 434e 4e20 666f 7220 616c 6c20 696e  e CNN for all in
-000064b0: 7075 7473 2e0a 0a20 2020 2020 2020 2041  puts...        A
-000064c0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-000064d0: 2073 706c 6974 5f6c 6973 7420 286c 6973   split_list (lis
-000064e0: 745b 696e 745d 293a 206c 6973 7420 6f66  t[int]): list of
-000064f0: 2073 706c 6974 7320 7468 6174 2061 7265   splits that are
-00006500: 2074 7261 696e 6564 2e0a 2020 2020 2020   trained..      
-00006510: 2020 2020 2020 7265 7375 6d65 2028 626f        resume (bo
-00006520: 6f6c 293a 2049 6620 5472 7565 2074 6865  ol): If True the
-00006530: 206a 6f62 2069 7320 7265 7375 6d65 6420   job is resumed 
-00006540: 6672 6f6d 2063 6865 636b 706f 696e 742e  from checkpoint.
-00006550: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006560: 2020 2020 2074 7261 696e 5f74 7261 6e73       train_trans
-00006570: 666f 726d 732c 2061 6c6c 5f74 7261 6e73  forms, all_trans
-00006580: 666f 726d 7320 3d20 6765 745f 7472 616e  forms = get_tran
-00006590: 7366 6f72 6d73 280a 2020 2020 2020 2020  sforms(.        
-000065a0: 2020 2020 6e6f 726d 616c 697a 653d 7365      normalize=se
-000065b0: 6c66 2e6e 6f72 6d61 6c69 7a65 2c0a 2020  lf.normalize,.  
-000065c0: 2020 2020 2020 2020 2020 6461 7461 5f61            data_a
-000065d0: 7567 6d65 6e74 6174 696f 6e3d 7365 6c66  ugmentation=self
-000065e0: 2e64 6174 615f 6175 676d 656e 7461 7469  .data_augmentati
-000065f0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00006600: 7369 7a65 5f72 6564 7563 7469 6f6e 3d73  size_reduction=s
-00006610: 656c 662e 7369 7a65 5f72 6564 7563 7469  elf.size_reducti
-00006620: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00006630: 7369 7a65 5f72 6564 7563 7469 6f6e 5f66  size_reduction_f
-00006640: 6163 746f 723d 7365 6c66 2e73 697a 655f  actor=self.size_
-00006650: 7265 6475 6374 696f 6e5f 6661 6374 6f72  reduction_factor
-00006660: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00006670: 2020 2020 7370 6c69 745f 6d61 6e61 6765      split_manage
-00006680: 7220 3d20 7365 6c66 2e5f 696e 6974 5f73  r = self._init_s
-00006690: 706c 6974 5f6d 616e 6167 6572 2873 706c  plit_manager(spl
-000066a0: 6974 5f6c 6973 7429 0a20 2020 2020 2020  it_list).       
-000066b0: 2066 6f72 2073 706c 6974 2069 6e20 7370   for split in sp
-000066c0: 6c69 745f 6d61 6e61 6765 722e 7370 6c69  lit_manager.spli
-000066d0: 745f 6974 6572 6174 6f72 2829 3a0a 2020  t_iterator():.  
-000066e0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000066f0: 2e69 6e66 6f28 6622 5472 6169 6e69 6e67  .info(f"Training
-00006700: 2073 706c 6974 207b 7370 6c69 747d 2229   split {split}")
-00006710: 0a20 2020 2020 2020 2020 2020 2073 6565  .            see
-00006720: 645f 6576 6572 7974 6869 6e67 2873 656c  d_everything(sel
-00006730: 662e 7365 6564 2c20 7365 6c66 2e64 6574  f.seed, self.det
-00006740: 6572 6d69 6e69 7374 6963 2c20 7365 6c66  erministic, self
-00006750: 2e63 6f6d 7065 6e73 6174 696f 6e29 0a0a  .compensation)..
-00006760: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
-00006770: 745f 6466 5f64 6963 7420 3d20 7370 6c69  t_df_dict = spli
-00006780: 745f 6d61 6e61 6765 725b 7370 6c69 745d  t_manager[split]
-00006790: 0a0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
-000067a0: 6767 6572 2e64 6562 7567 2822 4c6f 6164  gger.debug("Load
-000067b0: 696e 6720 7472 6169 6e69 6e67 2064 6174  ing training dat
-000067c0: 612e 2e2e 2229 0a20 2020 2020 2020 2020  a...").         
-000067d0: 2020 2064 6174 615f 7472 6169 6e20 3d20     data_train = 
-000067e0: 7265 7475 726e 5f64 6174 6173 6574 280a  return_dataset(.
-000067f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006800: 7365 6c66 2e63 6170 735f 6469 7265 6374  self.caps_direct
-00006810: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
-00006820: 2020 2020 2073 706c 6974 5f64 665f 6469       split_df_di
-00006830: 6374 5b22 7472 6169 6e22 5d2c 0a20 2020  ct["train"],.   
-00006840: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006850: 662e 7072 6570 726f 6365 7373 696e 675f  f.preprocessing_
-00006860: 6469 6374 2c0a 2020 2020 2020 2020 2020  dict,.          
-00006870: 2020 2020 2020 7472 6169 6e5f 7472 616e        train_tran
-00006880: 7366 6f72 6d61 7469 6f6e 733d 7472 6169  sformations=trai
-00006890: 6e5f 7472 616e 7366 6f72 6d73 2c0a 2020  n_transforms,.  
-000068a0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-000068b0: 6c5f 7472 616e 7366 6f72 6d61 7469 6f6e  l_transformation
-000068c0: 733d 616c 6c5f 7472 616e 7366 6f72 6d73  s=all_transforms
-000068d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000068e0: 2020 6d75 6c74 695f 636f 686f 7274 3d73    multi_cohort=s
-000068f0: 656c 662e 6d75 6c74 695f 636f 686f 7274  elf.multi_cohort
-00006900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006910: 2020 6c61 6265 6c3d 7365 6c66 2e6c 6162    label=self.lab
-00006920: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-00006930: 2020 2020 6c61 6265 6c5f 636f 6465 3d73      label_code=s
-00006940: 656c 662e 6c61 6265 6c5f 636f 6465 2c0a  elf.label_code,.
-00006950: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00006960: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00006970: 2e64 6562 7567 2822 4c6f 6164 696e 6720  .debug("Loading 
-00006980: 7661 6c69 6461 7469 6f6e 2064 6174 612e  validation data.
-00006990: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
-000069a0: 2064 6174 615f 7661 6c69 6420 3d20 7265   data_valid = re
-000069b0: 7475 726e 5f64 6174 6173 6574 280a 2020  turn_dataset(.  
-000069c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000069d0: 6c66 2e63 6170 735f 6469 7265 6374 6f72  lf.caps_director
-000069e0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-000069f0: 2020 2073 706c 6974 5f64 665f 6469 6374     split_df_dict
-00006a00: 5b22 7661 6c69 6461 7469 6f6e 225d 2c0a  ["validation"],.
-00006a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a20: 7365 6c66 2e70 7265 7072 6f63 6573 7369  self.preprocessi
-00006a30: 6e67 5f64 6963 742c 0a20 2020 2020 2020  ng_dict,.       
-00006a40: 2020 2020 2020 2020 2074 7261 696e 5f74           train_t
-00006a50: 7261 6e73 666f 726d 6174 696f 6e73 3d74  ransformations=t
-00006a60: 7261 696e 5f74 7261 6e73 666f 726d 732c  rain_transforms,
-00006a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006a80: 2061 6c6c 5f74 7261 6e73 666f 726d 6174   all_transformat
-00006a90: 696f 6e73 3d61 6c6c 5f74 7261 6e73 666f  ions=all_transfo
-00006aa0: 726d 732c 0a20 2020 2020 2020 2020 2020  rms,.           
-00006ab0: 2020 2020 206d 756c 7469 5f63 6f68 6f72       multi_cohor
-00006ac0: 743d 7365 6c66 2e6d 756c 7469 5f63 6f68  t=self.multi_coh
-00006ad0: 6f72 742c 0a20 2020 2020 2020 2020 2020  ort,.           
-00006ae0: 2020 2020 206c 6162 656c 3d73 656c 662e       label=self.
-00006af0: 6c61 6265 6c2c 0a20 2020 2020 2020 2020  label,.         
-00006b00: 2020 2020 2020 206c 6162 656c 5f63 6f64         label_cod
-00006b10: 653d 7365 6c66 2e6c 6162 656c 5f63 6f64  e=self.label_cod
-00006b20: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-00006b30: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
-00006b40: 696e 5f73 616d 706c 6572 203d 2073 656c  in_sampler = sel
-00006b50: 662e 7461 736b 5f6d 616e 6167 6572 2e67  f.task_manager.g
-00006b60: 656e 6572 6174 655f 7361 6d70 6c65 7228  enerate_sampler(
-00006b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b80: 2064 6174 615f 7472 6169 6e2c 0a20 2020   data_train,.   
-00006b90: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006ba0: 662e 7361 6d70 6c65 722c 0a20 2020 2020  f.sampler,.     
-00006bb0: 2020 2020 2020 2020 2020 2064 705f 6465             dp_de
-00006bc0: 6772 6565 3d63 6c75 7374 6572 2e77 6f72  gree=cluster.wor
-00006bd0: 6c64 5f73 697a 652c 0a20 2020 2020 2020  ld_size,.       
-00006be0: 2020 2020 2020 2020 2072 616e 6b3d 636c           rank=cl
-00006bf0: 7573 7465 722e 7261 6e6b 2c0a 2020 2020  uster.rank,.    
-00006c00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00006c10: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-00006c20: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00006c30: 2020 2020 6622 4765 7474 696e 6720 7472      f"Getting tr
-00006c40: 6169 6e20 616e 6420 7661 6c69 6461 7469  ain and validati
-00006c50: 6f6e 206c 6f61 6465 7220 7769 7468 2062  on loader with b
-00006c60: 6174 6368 2073 697a 6520 7b73 656c 662e  atch size {self.
-00006c70: 6261 7463 685f 7369 7a65 7d22 0a20 2020  batch_size}".   
-00006c80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00006c90: 2020 2020 2020 2074 7261 696e 5f6c 6f61         train_loa
-00006ca0: 6465 7220 3d20 4461 7461 4c6f 6164 6572  der = DataLoader
-00006cb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006cc0: 2020 6461 7461 5f74 7261 696e 2c0a 2020    data_train,.  
-00006cd0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00006ce0: 7463 685f 7369 7a65 3d73 656c 662e 6261  tch_size=self.ba
-00006cf0: 7463 685f 7369 7a65 2c0a 2020 2020 2020  tch_size,.      
-00006d00: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
-00006d10: 723d 7472 6169 6e5f 7361 6d70 6c65 722c  r=train_sampler,
-00006d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006d30: 206e 756d 5f77 6f72 6b65 7273 3d73 656c   num_workers=sel
-00006d40: 662e 6e5f 7072 6f63 2c0a 2020 2020 2020  f.n_proc,.      
-00006d50: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00006d60: 5f69 6e69 745f 666e 3d70 6c5f 776f 726b  _init_fn=pl_work
-00006d70: 6572 5f69 6e69 745f 6675 6e63 7469 6f6e  er_init_function
-00006d80: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00006d90: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00006da0: 6572 2e64 6562 7567 2866 2254 7261 696e  er.debug(f"Train
-00006db0: 206c 6f61 6465 7220 7369 7a65 2069 7320   loader size is 
-00006dc0: 7b6c 656e 2874 7261 696e 5f6c 6f61 6465  {len(train_loade
-00006dd0: 7229 7d22 290a 2020 2020 2020 2020 2020  r)}").          
-00006de0: 2020 7661 6c69 645f 7361 6d70 6c65 7220    valid_sampler 
-00006df0: 3d20 4469 7374 7269 6275 7465 6453 616d  = DistributedSam
-00006e00: 706c 6572 280a 2020 2020 2020 2020 2020  pler(.          
-00006e10: 2020 2020 2020 6461 7461 5f76 616c 6964        data_valid
-00006e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006e30: 2020 6e75 6d5f 7265 706c 6963 6173 3d63    num_replicas=c
-00006e40: 6c75 7374 6572 2e77 6f72 6c64 5f73 697a  luster.world_siz
-00006e50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00006e60: 2020 2072 616e 6b3d 636c 7573 7465 722e     rank=cluster.
-00006e70: 7261 6e6b 2c0a 2020 2020 2020 2020 2020  rank,.          
-00006e80: 2020 2020 2020 7368 7566 666c 653d 4661        shuffle=Fa
-00006e90: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00006ea0: 2029 0a20 2020 2020 2020 2020 2020 2076   ).            v
-00006eb0: 616c 6964 5f6c 6f61 6465 7220 3d20 4461  alid_loader = Da
-00006ec0: 7461 4c6f 6164 6572 280a 2020 2020 2020  taLoader(.      
-00006ed0: 2020 2020 2020 2020 2020 6461 7461 5f76            data_v
-00006ee0: 616c 6964 2c0a 2020 2020 2020 2020 2020  alid,.          
-00006ef0: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
-00006f00: 3d73 656c 662e 6261 7463 685f 7369 7a65  =self.batch_size
-00006f10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006f20: 2020 7368 7566 666c 653d 4661 6c73 652c    shuffle=False,
-00006f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006f40: 206e 756d 5f77 6f72 6b65 7273 3d73 656c   num_workers=sel
-00006f50: 662e 6e5f 7072 6f63 2c0a 2020 2020 2020  f.n_proc,.      
-00006f60: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
-00006f70: 723d 7661 6c69 645f 7361 6d70 6c65 722c  r=valid_sampler,
-00006f80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00006f90: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00006fa0: 722e 6465 6275 6728 6622 5661 6c69 6461  r.debug(f"Valida
-00006fb0: 7469 6f6e 206c 6f61 6465 7220 7369 7a65  tion loader size
-00006fc0: 2069 7320 7b6c 656e 2876 616c 6964 5f6c   is {len(valid_l
-00006fd0: 6f61 6465 7229 7d22 290a 2020 2020 2020  oader)}").      
-00006fe0: 2020 2020 2020 6672 6f6d 2063 6c69 6e69        from clini
-00006ff0: 6361 646c 2e75 7469 6c73 2e63 616c 6c62  cadl.utils.callb
-00007000: 6163 6b73 2e63 616c 6c62 6163 6b73 2069  acks.callbacks i
-00007010: 6d70 6f72 7420 436f 6465 4361 7262 6f6e  mport CodeCarbon
-00007020: 5472 6163 6b65 720a 0a20 2020 2020 2020  Tracker..       
-00007030: 2020 2020 2073 656c 662e 5f74 7261 696e       self._train
-00007040: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00007050: 2020 7472 6169 6e5f 6c6f 6164 6572 2c0a    train_loader,.
-00007060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007070: 7661 6c69 645f 6c6f 6164 6572 2c0a 2020  valid_loader,.  
-00007080: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-00007090: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
-000070a0: 2020 2020 2072 6573 756d 653d 7265 7375       resume=resu
-000070b0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-000070c0: 2020 2020 6361 6c6c 6261 636b 733d 5b43      callbacks=[C
-000070d0: 6f64 6543 6172 626f 6e54 7261 636b 6572  odeCarbonTracker
-000070e0: 5d2c 0a20 2020 2020 2020 2020 2020 2029  ],.            )
-000070f0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00007100: 2063 6c75 7374 6572 2e6d 6173 7465 723a   cluster.master:
-00007110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007120: 2073 656c 662e 5f65 6e73 656d 626c 655f   self._ensemble_
-00007130: 7072 6564 6963 7469 6f6e 280a 2020 2020  prediction(.    
-00007140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007150: 2274 7261 696e 222c 0a20 2020 2020 2020  "train",.       
-00007160: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-00007170: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-00007180: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
-00007190: 6563 7469 6f6e 5f6d 6574 7269 6373 2c0a  ection_metrics,.
-000071a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000071c0: 2020 7365 6c66 2e5f 656e 7365 6d62 6c65    self._ensemble
-000071d0: 5f70 7265 6469 6374 696f 6e28 0a20 2020  _prediction(.   
-000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071f0: 2022 7661 6c69 6461 7469 6f6e 222c 0a20   "validation",. 
-00007200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007210: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
-00007220: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00007230: 6c66 2e73 656c 6563 7469 6f6e 5f6d 6574  lf.selection_met
-00007240: 7269 6373 2c0a 2020 2020 2020 2020 2020  rics,.          
-00007250: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00007260: 2020 2020 2020 2020 2073 656c 662e 5f65           self._e
-00007270: 7261 7365 5f74 6d70 2873 706c 6974 290a  rase_tmp(split).
-00007280: 0a20 2020 2064 6566 205f 7472 6169 6e5f  .    def _train_
-00007290: 6d75 6c74 6928 7365 6c66 2c20 7370 6c69  multi(self, spli
-000072a0: 745f 6c69 7374 3a20 4c69 7374 5b69 6e74  t_list: List[int
-000072b0: 5d20 3d20 4e6f 6e65 2c20 7265 7375 6d65  ] = None, resume
-000072c0: 3a20 626f 6f6c 203d 2046 616c 7365 293a  : bool = False):
-000072d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000072e0: 2020 2020 2054 7261 696e 7320 6120 7369       Trains a si
-000072f0: 6e67 6c65 2043 4e4e 2070 6572 2065 6c65  ngle CNN per ele
-00007300: 6d65 6e74 2069 6e20 7468 6520 696d 6167  ment in the imag
-00007310: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
-00007320: 3a0a 2020 2020 2020 2020 2020 2020 7370  :.            sp
-00007330: 6c69 745f 6c69 7374 3a20 6c69 7374 206f  lit_list: list o
-00007340: 6620 7370 6c69 7473 2074 6861 7420 6172  f splits that ar
-00007350: 6520 7472 6169 6e65 642e 0a20 2020 2020  e trained..     
-00007360: 2020 2020 2020 2072 6573 756d 653a 2049         resume: I
-00007370: 6620 5472 7565 2074 6865 206a 6f62 2069  f True the job i
-00007380: 7320 7265 7375 6d65 6420 6672 6f6d 2063  s resumed from c
-00007390: 6865 636b 706f 696e 742e 0a20 2020 2020  heckpoint..     
-000073a0: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-000073b0: 7261 696e 5f74 7261 6e73 666f 726d 732c  rain_transforms,
-000073c0: 2061 6c6c 5f74 7261 6e73 666f 726d 7320   all_transforms 
-000073d0: 3d20 6765 745f 7472 616e 7366 6f72 6d73  = get_transforms
-000073e0: 280a 2020 2020 2020 2020 2020 2020 6e6f  (.            no
-000073f0: 726d 616c 697a 653d 7365 6c66 2e6e 6f72  rmalize=self.nor
-00007400: 6d61 6c69 7a65 2c0a 2020 2020 2020 2020  malize,.        
-00007410: 2020 2020 6461 7461 5f61 7567 6d65 6e74      data_augment
-00007420: 6174 696f 6e3d 7365 6c66 2e64 6174 615f  ation=self.data_
-00007430: 6175 676d 656e 7461 7469 6f6e 2c0a 2020  augmentation,.  
-00007440: 2020 2020 2020 2020 2020 7369 7a65 5f72            size_r
-00007450: 6564 7563 7469 6f6e 3d73 656c 662e 7369  eduction=self.si
-00007460: 7a65 5f72 6564 7563 7469 6f6e 2c0a 2020  ze_reduction,.  
-00007470: 2020 2020 2020 2020 2020 7369 7a65 5f72            size_r
-00007480: 6564 7563 7469 6f6e 5f66 6163 746f 723d  eduction_factor=
-00007490: 7365 6c66 2e73 697a 655f 7265 6475 6374  self.size_reduct
-000074a0: 696f 6e5f 6661 6374 6f72 2c0a 2020 2020  ion_factor,.    
-000074b0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-000074c0: 706c 6974 5f6d 616e 6167 6572 203d 2073  plit_manager = s
-000074d0: 656c 662e 5f69 6e69 745f 7370 6c69 745f  elf._init_split_
-000074e0: 6d61 6e61 6765 7228 7370 6c69 745f 6c69  manager(split_li
-000074f0: 7374 290a 2020 2020 2020 2020 666f 7220  st).        for 
-00007500: 7370 6c69 7420 696e 2073 706c 6974 5f6d  split in split_m
-00007510: 616e 6167 6572 2e73 706c 6974 5f69 7465  anager.split_ite
-00007520: 7261 746f 7228 293a 0a20 2020 2020 2020  rator():.       
-00007530: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00007540: 2866 2254 7261 696e 696e 6720 7370 6c69  (f"Training spli
-00007550: 7420 7b73 706c 6974 7d22 290a 2020 2020  t {split}").    
-00007560: 2020 2020 2020 2020 7365 6564 5f65 7665          seed_eve
-00007570: 7279 7468 696e 6728 7365 6c66 2e73 6565  rything(self.see
-00007580: 642c 2073 656c 662e 6465 7465 726d 696e  d, self.determin
-00007590: 6973 7469 632c 2073 656c 662e 636f 6d70  istic, self.comp
-000075a0: 656e 7361 7469 6f6e 290a 0a20 2020 2020  ensation)..     
-000075b0: 2020 2020 2020 2073 706c 6974 5f64 665f         split_df_
-000075c0: 6469 6374 203d 2073 706c 6974 5f6d 616e  dict = split_man
-000075d0: 6167 6572 5b73 706c 6974 5d0a 0a20 2020  ager[split]..   
-000075e0: 2020 2020 2020 2020 2066 6972 7374 5f6e           first_n
-000075f0: 6574 776f 726b 203d 2030 0a20 2020 2020  etwork = 0.     
-00007600: 2020 2020 2020 2069 6620 7265 7375 6d65         if resume
-00007610: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007620: 2020 7472 6169 6e69 6e67 5f6c 6f67 7320    training_logs 
-00007630: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00007640: 2020 2020 2020 2020 696e 7428 6e65 7477          int(netw
-00007650: 6f72 6b5f 666f 6c64 6572 2e73 706c 6974  ork_folder.split
-00007660: 2822 2d22 295b 315d 290a 2020 2020 2020  ("-")[1]).      
-00007670: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00007680: 7220 6e65 7477 6f72 6b5f 666f 6c64 6572  r network_folder
-00007690: 2069 6e20 6c69 7374 280a 2020 2020 2020   in list(.      
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
-000076c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076d0: 7365 6c66 2e6d 6170 735f 7061 7468 0a20  self.maps_path. 
-000076e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076f0: 2020 2020 2020 2020 2020 202f 2066 227b             / f"{
-00007700: 7365 6c66 2e73 706c 6974 5f6e 616d 657d  self.split_name}
-00007710: 2d7b 7370 6c69 747d 220a 2020 2020 2020  -{split}".      
-00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007730: 2020 2020 2020 2f20 2274 7261 696e 696e        / "trainin
-00007740: 675f 6c6f 6773 220a 2020 2020 2020 2020  g_logs".        
-00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007760: 292e 6974 6572 6469 7228 290a 2020 2020  ).iterdir().    
+00006370: 2020 2020 2020 6f75 7470 7574 5f6e 6969        output_nii
+00006380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006390: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000063a0: 7375 6c74 735f 7061 7468 202f 2066 226d  sults_path / f"m
+000063b0: 6561 6e5f 7b73 656c 662e 6d6f 6465 7d2d  ean_{self.mode}-
+000063c0: 7b69 7d5f 6d61 702e 6e69 692e 677a 222c  {i}_map.nii.gz",
+000063d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000063e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000063f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00006400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00006410: 2323 230a 2020 2020 2320 4869 6768 2d6c  ###.    # High-l
+00006420: 6576 656c 2066 756e 6374 696f 6e73 2074  evel functions t
+00006430: 656d 706c 6174 6573 2020 230a 2020 2020  emplates  #.    
+00006440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00006450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00006460: 2323 230a 2020 2020 6465 6620 5f74 7261  ###.    def _tra
+00006470: 696e 5f73 696e 676c 6528 0a20 2020 2020  in_single(.     
+00006480: 2020 2073 656c 662c 2073 706c 6974 5f6c     self, split_l
+00006490: 6973 743a 204f 7074 696f 6e61 6c5b 4c69  ist: Optional[Li
+000064a0: 7374 5b69 6e74 5d5d 203d 204e 6f6e 652c  st[int]] = None,
+000064b0: 2072 6573 756d 653a 2062 6f6f 6c20 3d20   resume: bool = 
+000064c0: 4661 6c73 650a 2020 2020 293a 0a20 2020  False.    ):.   
+000064d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000064e0: 2054 7261 696e 7320 6120 7369 6e67 6c65   Trains a single
+000064f0: 2043 4e4e 2066 6f72 2061 6c6c 2069 6e70   CNN for all inp
+00006500: 7574 732e 0a0a 2020 2020 2020 2020 4172  uts...        Ar
+00006510: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00006520: 7370 6c69 745f 6c69 7374 2028 6c69 7374  split_list (list
+00006530: 5b69 6e74 5d29 3a20 6c69 7374 206f 6620  [int]): list of 
+00006540: 7370 6c69 7473 2074 6861 7420 6172 6520  splits that are 
+00006550: 7472 6169 6e65 642e 0a20 2020 2020 2020  trained..       
+00006560: 2020 2020 2072 6573 756d 6520 2862 6f6f       resume (boo
+00006570: 6c29 3a20 4966 2054 7275 6520 7468 6520  l): If True the 
+00006580: 6a6f 6220 6973 2072 6573 756d 6564 2066  job is resumed f
+00006590: 726f 6d20 6368 6563 6b70 6f69 6e74 2e0a  rom checkpoint..
+000065a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000065b0: 2020 2020 7472 6169 6e5f 7472 616e 7366      train_transf
+000065c0: 6f72 6d73 2c20 616c 6c5f 7472 616e 7366  orms, all_transf
+000065d0: 6f72 6d73 203d 2067 6574 5f74 7261 6e73  orms = get_trans
+000065e0: 666f 726d 7328 0a20 2020 2020 2020 2020  forms(.         
+000065f0: 2020 206e 6f72 6d61 6c69 7a65 3d73 656c     normalize=sel
+00006600: 662e 6e6f 726d 616c 697a 652c 0a20 2020  f.normalize,.   
+00006610: 2020 2020 2020 2020 2064 6174 615f 6175           data_au
+00006620: 676d 656e 7461 7469 6f6e 3d73 656c 662e  gmentation=self.
+00006630: 6461 7461 5f61 7567 6d65 6e74 6174 696f  data_augmentatio
+00006640: 6e2c 0a20 2020 2020 2020 2020 2020 2073  n,.            s
+00006650: 697a 655f 7265 6475 6374 696f 6e3d 7365  ize_reduction=se
+00006660: 6c66 2e73 697a 655f 7265 6475 6374 696f  lf.size_reductio
+00006670: 6e2c 0a20 2020 2020 2020 2020 2020 2073  n,.            s
+00006680: 697a 655f 7265 6475 6374 696f 6e5f 6661  ize_reduction_fa
+00006690: 6374 6f72 3d73 656c 662e 7369 7a65 5f72  ctor=self.size_r
+000066a0: 6564 7563 7469 6f6e 5f66 6163 746f 722c  eduction_factor,
+000066b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000066c0: 2020 2073 706c 6974 5f6d 616e 6167 6572     split_manager
+000066d0: 203d 2073 656c 662e 5f69 6e69 745f 7370   = self._init_sp
+000066e0: 6c69 745f 6d61 6e61 6765 7228 7370 6c69  lit_manager(spli
+000066f0: 745f 6c69 7374 290a 2020 2020 2020 2020  t_list).        
+00006700: 666f 7220 7370 6c69 7420 696e 2073 706c  for split in spl
+00006710: 6974 5f6d 616e 6167 6572 2e73 706c 6974  it_manager.split
+00006720: 5f69 7465 7261 746f 7228 293a 0a20 2020  _iterator():.   
+00006730: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00006740: 696e 666f 2866 2254 7261 696e 696e 6720  info(f"Training 
+00006750: 7370 6c69 7420 7b73 706c 6974 7d22 290a  split {split}").
+00006760: 2020 2020 2020 2020 2020 2020 7365 6564              seed
+00006770: 5f65 7665 7279 7468 696e 6728 7365 6c66  _everything(self
+00006780: 2e73 6565 642c 2073 656c 662e 6465 7465  .seed, self.dete
+00006790: 726d 696e 6973 7469 632c 2073 656c 662e  rministic, self.
+000067a0: 636f 6d70 656e 7361 7469 6f6e 290a 0a20  compensation).. 
+000067b0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+000067c0: 5f64 665f 6469 6374 203d 2073 706c 6974  _df_dict = split
+000067d0: 5f6d 616e 6167 6572 5b73 706c 6974 5d0a  _manager[split].
+000067e0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000067f0: 6765 722e 6465 6275 6728 224c 6f61 6469  ger.debug("Loadi
+00006800: 6e67 2074 7261 696e 696e 6720 6461 7461  ng training data
+00006810: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
+00006820: 2020 6461 7461 5f74 7261 696e 203d 2072    data_train = r
+00006830: 6574 7572 6e5f 6461 7461 7365 7428 0a20  eturn_dataset(. 
+00006840: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00006850: 656c 662e 6361 7073 5f64 6972 6563 746f  elf.caps_directo
+00006860: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+00006870: 2020 2020 7370 6c69 745f 6466 5f64 6963      split_df_dic
+00006880: 745b 2274 7261 696e 225d 2c0a 2020 2020  t["train"],.    
+00006890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000068a0: 2e70 7265 7072 6f63 6573 7369 6e67 5f64  .preprocessing_d
+000068b0: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
+000068c0: 2020 2020 2074 7261 696e 5f74 7261 6e73       train_trans
+000068d0: 666f 726d 6174 696f 6e73 3d74 7261 696e  formations=train
+000068e0: 5f74 7261 6e73 666f 726d 732c 0a20 2020  _transforms,.   
+000068f0: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+00006900: 5f74 7261 6e73 666f 726d 6174 696f 6e73  _transformations
+00006910: 3d61 6c6c 5f74 7261 6e73 666f 726d 732c  =all_transforms,
+00006920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006930: 206d 756c 7469 5f63 6f68 6f72 743d 7365   multi_cohort=se
+00006940: 6c66 2e6d 756c 7469 5f63 6f68 6f72 742c  lf.multi_cohort,
+00006950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006960: 206c 6162 656c 3d73 656c 662e 6c61 6265   label=self.labe
+00006970: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00006980: 2020 206c 6162 656c 5f63 6f64 653d 7365     label_code=se
+00006990: 6c66 2e6c 6162 656c 5f63 6f64 652c 0a20  lf.label_code,. 
+000069a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000069b0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+000069c0: 6465 6275 6728 224c 6f61 6469 6e67 2076  debug("Loading v
+000069d0: 616c 6964 6174 696f 6e20 6461 7461 2e2e  alidation data..
+000069e0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000069f0: 6461 7461 5f76 616c 6964 203d 2072 6574  data_valid = ret
+00006a00: 7572 6e5f 6461 7461 7365 7428 0a20 2020  urn_dataset(.   
+00006a10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00006a20: 662e 6361 7073 5f64 6972 6563 746f 7279  f.caps_directory
+00006a30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006a40: 2020 7370 6c69 745f 6466 5f64 6963 745b    split_df_dict[
+00006a50: 2276 616c 6964 6174 696f 6e22 5d2c 0a20  "validation"],. 
+00006a60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00006a70: 656c 662e 7072 6570 726f 6365 7373 696e  elf.preprocessin
+00006a80: 675f 6469 6374 2c0a 2020 2020 2020 2020  g_dict,.        
+00006a90: 2020 2020 2020 2020 7472 6169 6e5f 7472          train_tr
+00006aa0: 616e 7366 6f72 6d61 7469 6f6e 733d 7472  ansformations=tr
+00006ab0: 6169 6e5f 7472 616e 7366 6f72 6d73 2c0a  ain_transforms,.
+00006ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ad0: 616c 6c5f 7472 616e 7366 6f72 6d61 7469  all_transformati
+00006ae0: 6f6e 733d 616c 6c5f 7472 616e 7366 6f72  ons=all_transfor
+00006af0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00006b00: 2020 2020 6d75 6c74 695f 636f 686f 7274      multi_cohort
+00006b10: 3d73 656c 662e 6d75 6c74 695f 636f 686f  =self.multi_coho
+00006b20: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
+00006b30: 2020 2020 6c61 6265 6c3d 7365 6c66 2e6c      label=self.l
+00006b40: 6162 656c 2c0a 2020 2020 2020 2020 2020  abel,.          
+00006b50: 2020 2020 2020 6c61 6265 6c5f 636f 6465        label_code
+00006b60: 3d73 656c 662e 6c61 6265 6c5f 636f 6465  =self.label_code
+00006b70: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00006b80: 2020 2020 2020 2020 2020 2020 7472 6169              trai
+00006b90: 6e5f 7361 6d70 6c65 7220 3d20 7365 6c66  n_sampler = self
+00006ba0: 2e74 6173 6b5f 6d61 6e61 6765 722e 6765  .task_manager.ge
+00006bb0: 6e65 7261 7465 5f73 616d 706c 6572 280a  nerate_sampler(.
+00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bd0: 6461 7461 5f74 7261 696e 2c0a 2020 2020  data_train,.    
+00006be0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006bf0: 2e73 616d 706c 6572 2c0a 2020 2020 2020  .sampler,.      
+00006c00: 2020 2020 2020 2020 2020 6470 5f64 6567            dp_deg
+00006c10: 7265 653d 636c 7573 7465 722e 776f 726c  ree=cluster.worl
+00006c20: 645f 7369 7a65 2c0a 2020 2020 2020 2020  d_size,.        
+00006c30: 2020 2020 2020 2020 7261 6e6b 3d63 6c75          rank=clu
+00006c40: 7374 6572 2e72 616e 6b2c 0a20 2020 2020  ster.rank,.     
+00006c50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006c60: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+00006c70: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00006c80: 2020 2066 2247 6574 7469 6e67 2074 7261     f"Getting tra
+00006c90: 696e 2061 6e64 2076 616c 6964 6174 696f  in and validatio
+00006ca0: 6e20 6c6f 6164 6572 2077 6974 6820 6261  n loader with ba
+00006cb0: 7463 6820 7369 7a65 207b 7365 6c66 2e62  tch size {self.b
+00006cc0: 6174 6368 5f73 697a 657d 220a 2020 2020  atch_size}".    
+00006cd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006ce0: 2020 2020 2020 7472 6169 6e5f 6c6f 6164        train_load
+00006cf0: 6572 203d 2044 6174 614c 6f61 6465 7228  er = DataLoader(
+00006d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006d10: 2064 6174 615f 7472 6169 6e2c 0a20 2020   data_train,.   
+00006d20: 2020 2020 2020 2020 2020 2020 2062 6174               bat
+00006d30: 6368 5f73 697a 653d 7365 6c66 2e62 6174  ch_size=self.bat
+00006d40: 6368 5f73 697a 652c 0a20 2020 2020 2020  ch_size,.       
+00006d50: 2020 2020 2020 2020 2073 616d 706c 6572           sampler
+00006d60: 3d74 7261 696e 5f73 616d 706c 6572 2c0a  =train_sampler,.
+00006d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d80: 6e75 6d5f 776f 726b 6572 733d 7365 6c66  num_workers=self
+00006d90: 2e6e 5f70 726f 632c 0a20 2020 2020 2020  .n_proc,.       
+00006da0: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+00006db0: 696e 6974 5f66 6e3d 706c 5f77 6f72 6b65  init_fn=pl_worke
+00006dc0: 725f 696e 6974 5f66 756e 6374 696f 6e2c  r_init_function,
+00006dd0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00006de0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00006df0: 722e 6465 6275 6728 6622 5472 6169 6e20  r.debug(f"Train 
+00006e00: 6c6f 6164 6572 2073 697a 6520 6973 207b  loader size is {
+00006e10: 6c65 6e28 7472 6169 6e5f 6c6f 6164 6572  len(train_loader
+00006e20: 297d 2229 0a20 2020 2020 2020 2020 2020  )}").           
+00006e30: 2076 616c 6964 5f73 616d 706c 6572 203d   valid_sampler =
+00006e40: 2044 6973 7472 6962 7574 6564 5361 6d70   DistributedSamp
+00006e50: 6c65 7228 0a20 2020 2020 2020 2020 2020  ler(.           
+00006e60: 2020 2020 2064 6174 615f 7661 6c69 642c       data_valid,
+00006e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006e80: 206e 756d 5f72 6570 6c69 6361 733d 636c   num_replicas=cl
+00006e90: 7573 7465 722e 776f 726c 645f 7369 7a65  uster.world_size
+00006ea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006eb0: 2020 7261 6e6b 3d63 6c75 7374 6572 2e72    rank=cluster.r
+00006ec0: 616e 6b2c 0a20 2020 2020 2020 2020 2020  ank,.           
+00006ed0: 2020 2020 2073 6875 6666 6c65 3d46 616c       shuffle=Fal
+00006ee0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00006ef0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
+00006f00: 6c69 645f 6c6f 6164 6572 203d 2044 6174  lid_loader = Dat
+00006f10: 614c 6f61 6465 7228 0a20 2020 2020 2020  aLoader(.       
+00006f20: 2020 2020 2020 2020 2064 6174 615f 7661           data_va
+00006f30: 6c69 642c 0a20 2020 2020 2020 2020 2020  lid,.           
+00006f40: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
+00006f50: 7365 6c66 2e62 6174 6368 5f73 697a 652c  self.batch_size,
+00006f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006f70: 2073 6875 6666 6c65 3d46 616c 7365 2c0a   shuffle=False,.
+00006f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f90: 6e75 6d5f 776f 726b 6572 733d 7365 6c66  num_workers=self
+00006fa0: 2e6e 5f70 726f 632c 0a20 2020 2020 2020  .n_proc,.       
+00006fb0: 2020 2020 2020 2020 2073 616d 706c 6572           sampler
+00006fc0: 3d76 616c 6964 5f73 616d 706c 6572 2c0a  =valid_sampler,.
+00006fd0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00006fe0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00006ff0: 2e64 6562 7567 2866 2256 616c 6964 6174  .debug(f"Validat
+00007000: 696f 6e20 6c6f 6164 6572 2073 697a 6520  ion loader size 
+00007010: 6973 207b 6c65 6e28 7661 6c69 645f 6c6f  is {len(valid_lo
+00007020: 6164 6572 297d 2229 0a20 2020 2020 2020  ader)}").       
+00007030: 2020 2020 2066 726f 6d20 636c 696e 6963       from clinic
+00007040: 6164 6c2e 7574 696c 732e 6361 6c6c 6261  adl.utils.callba
+00007050: 636b 732e 6361 6c6c 6261 636b 7320 696d  cks.callbacks im
+00007060: 706f 7274 2043 6f64 6543 6172 626f 6e54  port CodeCarbonT
+00007070: 7261 636b 6572 0a0a 2020 2020 2020 2020  racker..        
+00007080: 2020 2020 7365 6c66 2e5f 7472 6169 6e28      self._train(
+00007090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000070a0: 2074 7261 696e 5f6c 6f61 6465 722c 0a20   train_loader,. 
+000070b0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000070c0: 616c 6964 5f6c 6f61 6465 722c 0a20 2020  alid_loader,.   
+000070d0: 2020 2020 2020 2020 2020 2020 2073 706c               spl
+000070e0: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+000070f0: 2020 2020 7265 7375 6d65 3d72 6573 756d      resume=resum
+00007100: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00007110: 2020 2063 616c 6c62 6163 6b73 3d5b 436f     callbacks=[Co
+00007120: 6465 4361 7262 6f6e 5472 6163 6b65 725d  deCarbonTracker]
+00007130: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00007140: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00007150: 636c 7573 7465 722e 6d61 7374 6572 3a0a  cluster.master:.
+00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007170: 7365 6c66 2e5f 656e 7365 6d62 6c65 5f70  self._ensemble_p
+00007180: 7265 6469 6374 696f 6e28 0a20 2020 2020  rediction(.     
+00007190: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000071a0: 7472 6169 6e22 2c0a 2020 2020 2020 2020  train",.        
+000071b0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+000071c0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000071d0: 2020 2020 2020 2073 656c 662e 7365 6c65         self.sele
+000071e0: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
+000071f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00007200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007210: 2073 656c 662e 5f65 6e73 656d 626c 655f   self._ensemble_
+00007220: 7072 6564 6963 7469 6f6e 280a 2020 2020  prediction(.    
+00007230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007240: 2276 616c 6964 6174 696f 6e22 2c0a 2020  "validation",.  
+00007250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007260: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
+00007270: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00007280: 662e 7365 6c65 6374 696f 6e5f 6d65 7472  f.selection_metr
+00007290: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
+000072a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000072b0: 2020 2020 2020 2020 7365 6c66 2e5f 6572          self._er
+000072c0: 6173 655f 746d 7028 7370 6c69 7429 0a0a  ase_tmp(split)..
+000072d0: 2020 2020 6465 6620 5f74 7261 696e 5f6d      def _train_m
+000072e0: 756c 7469 2873 656c 662c 2073 706c 6974  ulti(self, split
+000072f0: 5f6c 6973 743a 204c 6973 745b 696e 745d  _list: List[int]
+00007300: 203d 204e 6f6e 652c 2072 6573 756d 653a   = None, resume:
+00007310: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
+00007320: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00007330: 2020 2020 5472 6169 6e73 2061 2073 696e      Trains a sin
+00007340: 676c 6520 434e 4e20 7065 7220 656c 656d  gle CNN per elem
+00007350: 656e 7420 696e 2074 6865 2069 6d61 6765  ent in the image
+00007360: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00007370: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
+00007380: 6974 5f6c 6973 743a 206c 6973 7420 6f66  it_list: list of
+00007390: 2073 706c 6974 7320 7468 6174 2061 7265   splits that are
+000073a0: 2074 7261 696e 6564 2e0a 2020 2020 2020   trained..      
+000073b0: 2020 2020 2020 7265 7375 6d65 3a20 4966        resume: If
+000073c0: 2054 7275 6520 7468 6520 6a6f 6220 6973   True the job is
+000073d0: 2072 6573 756d 6564 2066 726f 6d20 6368   resumed from ch
+000073e0: 6563 6b70 6f69 6e74 2e0a 2020 2020 2020  eckpoint..      
+000073f0: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
+00007400: 6169 6e5f 7472 616e 7366 6f72 6d73 2c20  ain_transforms, 
+00007410: 616c 6c5f 7472 616e 7366 6f72 6d73 203d  all_transforms =
+00007420: 2067 6574 5f74 7261 6e73 666f 726d 7328   get_transforms(
+00007430: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00007440: 6d61 6c69 7a65 3d73 656c 662e 6e6f 726d  malize=self.norm
+00007450: 616c 697a 652c 0a20 2020 2020 2020 2020  alize,.         
+00007460: 2020 2064 6174 615f 6175 676d 656e 7461     data_augmenta
+00007470: 7469 6f6e 3d73 656c 662e 6461 7461 5f61  tion=self.data_a
+00007480: 7567 6d65 6e74 6174 696f 6e2c 0a20 2020  ugmentation,.   
+00007490: 2020 2020 2020 2020 2073 697a 655f 7265           size_re
+000074a0: 6475 6374 696f 6e3d 7365 6c66 2e73 697a  duction=self.siz
+000074b0: 655f 7265 6475 6374 696f 6e2c 0a20 2020  e_reduction,.   
+000074c0: 2020 2020 2020 2020 2073 697a 655f 7265           size_re
+000074d0: 6475 6374 696f 6e5f 6661 6374 6f72 3d73  duction_factor=s
+000074e0: 656c 662e 7369 7a65 5f72 6564 7563 7469  elf.size_reducti
+000074f0: 6f6e 5f66 6163 746f 722c 0a20 2020 2020  on_factor,.     
+00007500: 2020 2029 0a0a 2020 2020 2020 2020 7370     )..        sp
+00007510: 6c69 745f 6d61 6e61 6765 7220 3d20 7365  lit_manager = se
+00007520: 6c66 2e5f 696e 6974 5f73 706c 6974 5f6d  lf._init_split_m
+00007530: 616e 6167 6572 2873 706c 6974 5f6c 6973  anager(split_lis
+00007540: 7429 0a20 2020 2020 2020 2066 6f72 2073  t).        for s
+00007550: 706c 6974 2069 6e20 7370 6c69 745f 6d61  plit in split_ma
+00007560: 6e61 6765 722e 7370 6c69 745f 6974 6572  nager.split_iter
+00007570: 6174 6f72 2829 3a0a 2020 2020 2020 2020  ator():.        
+00007580: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00007590: 6622 5472 6169 6e69 6e67 2073 706c 6974  f"Training split
+000075a0: 207b 7370 6c69 747d 2229 0a20 2020 2020   {split}").     
+000075b0: 2020 2020 2020 2073 6565 645f 6576 6572         seed_ever
+000075c0: 7974 6869 6e67 2873 656c 662e 7365 6564  ything(self.seed
+000075d0: 2c20 7365 6c66 2e64 6574 6572 6d69 6e69  , self.determini
+000075e0: 7374 6963 2c20 7365 6c66 2e63 6f6d 7065  stic, self.compe
+000075f0: 6e73 6174 696f 6e29 0a0a 2020 2020 2020  nsation)..      
+00007600: 2020 2020 2020 7370 6c69 745f 6466 5f64        split_df_d
+00007610: 6963 7420 3d20 7370 6c69 745f 6d61 6e61  ict = split_mana
+00007620: 6765 725b 7370 6c69 745d 0a0a 2020 2020  ger[split]..    
+00007630: 2020 2020 2020 2020 6669 7273 745f 6e65          first_ne
+00007640: 7477 6f72 6b20 3d20 300a 2020 2020 2020  twork = 0.      
+00007650: 2020 2020 2020 6966 2072 6573 756d 653a        if resume:
+00007660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007670: 2074 7261 696e 696e 675f 6c6f 6773 203d   training_logs =
+00007680: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00007690: 2020 2020 2020 2069 6e74 286e 6574 776f         int(netwo
+000076a0: 726b 5f66 6f6c 6465 722e 7370 6c69 7428  rk_folder.split(
+000076b0: 222d 2229 5b31 5d29 0a20 2020 2020 2020  "-")[1]).       
+000076c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000076d0: 206e 6574 776f 726b 5f66 6f6c 6465 7220   network_folder 
+000076e0: 696e 206c 6973 7428 0a20 2020 2020 2020  in list(.       
+000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007700: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00007710: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00007720: 656c 662e 6d61 7073 5f70 6174 680a 2020  elf.maps_path.  
+00007730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007740: 2020 2020 2020 2020 2020 2f20 6622 7b73            / f"{s
+00007750: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
+00007760: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
 00007770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007780: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007790: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-000077a0: 2020 2020 6669 7273 745f 6e65 7477 6f72      first_networ
-000077b0: 6b20 3d20 6d61 7828 7472 6169 6e69 6e67  k = max(training
-000077c0: 5f6c 6f67 7329 0a20 2020 2020 2020 2020  _logs).         
-000077d0: 2020 2020 2020 2069 6620 6e6f 7420 2873         if not (s
-000077e0: 656c 662e 6d61 7073 5f70 6174 6820 2f20  elf.maps_path / 
-000077f0: 2274 6d70 2229 2e69 735f 6469 7228 293a  "tmp").is_dir():
-00007800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007810: 2020 2020 2066 6972 7374 5f6e 6574 776f       first_netwo
-00007820: 726b 202b 3d20 310a 2020 2020 2020 2020  rk += 1.        
-00007830: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00007840: 6d65 203d 2046 616c 7365 0a0a 2020 2020  me = False..    
-00007850: 2020 2020 2020 2020 666f 7220 6e65 7477          for netw
-00007860: 6f72 6b20 696e 2072 616e 6765 2866 6972  ork in range(fir
-00007870: 7374 5f6e 6574 776f 726b 2c20 7365 6c66  st_network, self
-00007880: 2e6e 756d 5f6e 6574 776f 726b 7329 3a0a  .num_networks):.
-00007890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078a0: 6c6f 6767 6572 2e69 6e66 6f28 6622 5472  logger.info(f"Tr
-000078b0: 6169 6e20 6e65 7477 6f72 6b20 7b6e 6574  ain network {net
-000078c0: 776f 726b 7d22 290a 0a20 2020 2020 2020  work}")..       
-000078d0: 2020 2020 2020 2020 2064 6174 615f 7472           data_tr
-000078e0: 6169 6e20 3d20 7265 7475 726e 5f64 6174  ain = return_dat
-000078f0: 6173 6574 280a 2020 2020 2020 2020 2020  aset(.          
-00007900: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00007910: 6170 735f 6469 7265 6374 6f72 792c 0a20  aps_directory,. 
-00007920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007930: 2020 2073 706c 6974 5f64 665f 6469 6374     split_df_dict
-00007940: 5b22 7472 6169 6e22 5d2c 0a20 2020 2020  ["train"],.     
-00007950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007960: 656c 662e 7072 6570 726f 6365 7373 696e  elf.preprocessin
-00007970: 675f 6469 6374 2c0a 2020 2020 2020 2020  g_dict,.        
-00007980: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-00007990: 6e5f 7472 616e 7366 6f72 6d61 7469 6f6e  n_transformation
-000079a0: 733d 7472 6169 6e5f 7472 616e 7366 6f72  s=train_transfor
-000079b0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-000079c0: 2020 2020 2020 2020 616c 6c5f 7472 616e          all_tran
-000079d0: 7366 6f72 6d61 7469 6f6e 733d 616c 6c5f  sformations=all_
-000079e0: 7472 616e 7366 6f72 6d73 2c0a 2020 2020  transforms,.    
-000079f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a00: 6d75 6c74 695f 636f 686f 7274 3d73 656c  multi_cohort=sel
-00007a10: 662e 6d75 6c74 695f 636f 686f 7274 2c0a  f.multi_cohort,.
-00007a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a30: 2020 2020 6c61 6265 6c3d 7365 6c66 2e6c      label=self.l
-00007a40: 6162 656c 2c0a 2020 2020 2020 2020 2020  abel,.          
-00007a50: 2020 2020 2020 2020 2020 6c61 6265 6c5f            label_
-00007a60: 636f 6465 3d73 656c 662e 6c61 6265 6c5f  code=self.label_
-00007a70: 636f 6465 2c0a 2020 2020 2020 2020 2020  code,.          
-00007a80: 2020 2020 2020 2020 2020 636e 6e5f 696e            cnn_in
-00007a90: 6465 783d 6e65 7477 6f72 6b2c 0a20 2020  dex=network,.   
-00007aa0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00007ab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00007ac0: 6174 615f 7661 6c69 6420 3d20 7265 7475  ata_valid = retu
-00007ad0: 726e 5f64 6174 6173 6574 280a 2020 2020  rn_dataset(.    
-00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007af0: 7365 6c66 2e63 6170 735f 6469 7265 6374  self.caps_direct
-00007b00: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
-00007b10: 2020 2020 2020 2020 2073 706c 6974 5f64           split_d
-00007b20: 665f 6469 6374 5b22 7661 6c69 6461 7469  f_dict["validati
-00007b30: 6f6e 225d 2c0a 2020 2020 2020 2020 2020  on"],.          
-00007b40: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00007b50: 7265 7072 6f63 6573 7369 6e67 5f64 6963  reprocessing_dic
-00007b60: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00007b70: 2020 2020 2020 2074 7261 696e 5f74 7261         train_tra
-00007b80: 6e73 666f 726d 6174 696f 6e73 3d74 7261  nsformations=tra
-00007b90: 696e 5f74 7261 6e73 666f 726d 732c 0a20  in_transforms,. 
-00007ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bb0: 2020 2061 6c6c 5f74 7261 6e73 666f 726d     all_transform
-00007bc0: 6174 696f 6e73 3d61 6c6c 5f74 7261 6e73  ations=all_trans
-00007bd0: 666f 726d 732c 0a20 2020 2020 2020 2020  forms,.         
-00007be0: 2020 2020 2020 2020 2020 206d 756c 7469             multi
-00007bf0: 5f63 6f68 6f72 743d 7365 6c66 2e6d 756c  _cohort=self.mul
-00007c00: 7469 5f63 6f68 6f72 742c 0a20 2020 2020  ti_cohort,.     
-00007c10: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00007c20: 6162 656c 3d73 656c 662e 6c61 6265 6c2c  abel=self.label,
-00007c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007c40: 2020 2020 206c 6162 656c 5f63 6f64 653d       label_code=
-00007c50: 7365 6c66 2e6c 6162 656c 5f63 6f64 652c  self.label_code,
-00007c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007c70: 2020 2020 2063 6e6e 5f69 6e64 6578 3d6e       cnn_index=n
-00007c80: 6574 776f 726b 2c0a 2020 2020 2020 2020  etwork,.        
-00007c90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00007ca0: 2020 2020 2020 2020 2020 2074 7261 696e             train
-00007cb0: 5f73 616d 706c 6572 203d 2073 656c 662e  _sampler = self.
-00007cc0: 7461 736b 5f6d 616e 6167 6572 2e67 656e  task_manager.gen
-00007cd0: 6572 6174 655f 7361 6d70 6c65 7228 0a20  erate_sampler(. 
-00007ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cf0: 2020 2064 6174 615f 7472 6169 6e2c 0a20     data_train,. 
-00007d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d10: 2020 2073 656c 662e 7361 6d70 6c65 722c     self.sampler,
-00007d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007d30: 2020 2020 2064 705f 6465 6772 6565 3d63       dp_degree=c
-00007d40: 6c75 7374 6572 2e77 6f72 6c64 5f73 697a  luster.world_siz
-00007d50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00007d60: 2020 2020 2020 2072 616e 6b3d 636c 7573         rank=clus
-00007d70: 7465 722e 7261 6e6b 2c0a 2020 2020 2020  ter.rank,.      
-00007d80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00007d90: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-00007da0: 6e5f 6c6f 6164 6572 203d 2044 6174 614c  n_loader = DataL
-00007db0: 6f61 6465 7228 0a20 2020 2020 2020 2020  oader(.         
-00007dc0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00007dd0: 7472 6169 6e2c 0a20 2020 2020 2020 2020  train,.         
-00007de0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
-00007df0: 5f73 697a 653d 7365 6c66 2e62 6174 6368  _size=self.batch
-00007e00: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
-00007e10: 2020 2020 2020 2020 2020 2073 616d 706c             sampl
-00007e20: 6572 3d74 7261 696e 5f73 616d 706c 6572  er=train_sampler
-00007e30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007e40: 2020 2020 2020 6e75 6d5f 776f 726b 6572        num_worker
-00007e50: 733d 7365 6c66 2e6e 5f70 726f 632c 0a20  s=self.n_proc,. 
-00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e70: 2020 2077 6f72 6b65 725f 696e 6974 5f66     worker_init_f
-00007e80: 6e3d 706c 5f77 6f72 6b65 725f 696e 6974  n=pl_worker_init
-00007e90: 5f66 756e 6374 696f 6e2c 0a20 2020 2020  _function,.     
-00007ea0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00007eb0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00007ec0: 6c69 645f 7361 6d70 6c65 7220 3d20 4469  lid_sampler = Di
-00007ed0: 7374 7269 6275 7465 6453 616d 706c 6572  stributedSampler
-00007ee0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00007ef0: 2020 2020 2020 6461 7461 5f76 616c 6964        data_valid
-00007f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007f10: 2020 2020 2020 6e75 6d5f 7265 706c 6963        num_replic
-00007f20: 6173 3d63 6c75 7374 6572 2e77 6f72 6c64  as=cluster.world
-00007f30: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
-00007f40: 2020 2020 2020 2020 2020 2072 616e 6b3d             rank=
-00007f50: 636c 7573 7465 722e 7261 6e6b 2c0a 2020  cluster.rank,.  
-00007f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f70: 2020 7368 7566 666c 653d 4661 6c73 652c    shuffle=False,
-00007f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007f90: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00007fa0: 2020 2076 616c 6964 5f6c 6f61 6465 7220     valid_loader 
-00007fb0: 3d20 4461 7461 4c6f 6164 6572 280a 2020  = DataLoader(.  
-00007fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fd0: 2020 6461 7461 5f76 616c 6964 2c0a 2020    data_valid,.  
-00007fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ff0: 2020 6261 7463 685f 7369 7a65 3d73 656c    batch_size=sel
-00008000: 662e 6261 7463 685f 7369 7a65 2c0a 2020  f.batch_size,.  
+00007780: 2020 2020 202f 2022 7472 6169 6e69 6e67       / "training
+00007790: 5f6c 6f67 7322 0a20 2020 2020 2020 2020  _logs".         
+000077a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000077b0: 2e69 7465 7264 6972 2829 0a20 2020 2020  .iterdir().     
+000077c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000077d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000077e0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+000077f0: 2020 2066 6972 7374 5f6e 6574 776f 726b     first_network
+00007800: 203d 206d 6178 2874 7261 696e 696e 675f   = max(training_
+00007810: 6c6f 6773 290a 2020 2020 2020 2020 2020  logs).          
+00007820: 2020 2020 2020 6966 206e 6f74 2028 7365        if not (se
+00007830: 6c66 2e6d 6170 735f 7061 7468 202f 2022  lf.maps_path / "
+00007840: 746d 7022 292e 6973 5f64 6972 2829 3a0a  tmp").is_dir():.
+00007850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007860: 2020 2020 6669 7273 745f 6e65 7477 6f72      first_networ
+00007870: 6b20 2b3d 2031 0a20 2020 2020 2020 2020  k += 1.         
+00007880: 2020 2020 2020 2020 2020 2072 6573 756d             resum
+00007890: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+000078a0: 2020 2020 2020 2066 6f72 206e 6574 776f         for netwo
+000078b0: 726b 2069 6e20 7261 6e67 6528 6669 7273  rk in range(firs
+000078c0: 745f 6e65 7477 6f72 6b2c 2073 656c 662e  t_network, self.
+000078d0: 6e75 6d5f 6e65 7477 6f72 6b73 293a 0a20  num_networks):. 
+000078e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000078f0: 6f67 6765 722e 696e 666f 2866 2254 7261  ogger.info(f"Tra
+00007900: 696e 206e 6574 776f 726b 207b 6e65 7477  in network {netw
+00007910: 6f72 6b7d 2229 0a0a 2020 2020 2020 2020  ork}")..        
+00007920: 2020 2020 2020 2020 6461 7461 5f74 7261          data_tra
+00007930: 696e 203d 2072 6574 7572 6e5f 6461 7461  in = return_data
+00007940: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
+00007950: 2020 2020 2020 2020 2073 656c 662e 6361           self.ca
+00007960: 7073 5f64 6972 6563 746f 7279 2c0a 2020  ps_directory,.  
+00007970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007980: 2020 7370 6c69 745f 6466 5f64 6963 745b    split_df_dict[
+00007990: 2274 7261 696e 225d 2c0a 2020 2020 2020  "train"],.      
+000079a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000079b0: 6c66 2e70 7265 7072 6f63 6573 7369 6e67  lf.preprocessing
+000079c0: 5f64 6963 742c 0a20 2020 2020 2020 2020  _dict,.         
+000079d0: 2020 2020 2020 2020 2020 2074 7261 696e             train
+000079e0: 5f74 7261 6e73 666f 726d 6174 696f 6e73  _transformations
+000079f0: 3d74 7261 696e 5f74 7261 6e73 666f 726d  =train_transform
+00007a00: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00007a10: 2020 2020 2020 2061 6c6c 5f74 7261 6e73         all_trans
+00007a20: 666f 726d 6174 696f 6e73 3d61 6c6c 5f74  formations=all_t
+00007a30: 7261 6e73 666f 726d 732c 0a20 2020 2020  ransforms,.     
+00007a40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00007a50: 756c 7469 5f63 6f68 6f72 743d 7365 6c66  ulti_cohort=self
+00007a60: 2e6d 756c 7469 5f63 6f68 6f72 742c 0a20  .multi_cohort,. 
+00007a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a80: 2020 206c 6162 656c 3d73 656c 662e 6c61     label=self.la
+00007a90: 6265 6c2c 0a20 2020 2020 2020 2020 2020  bel,.           
+00007aa0: 2020 2020 2020 2020 206c 6162 656c 5f63           label_c
+00007ab0: 6f64 653d 7365 6c66 2e6c 6162 656c 5f63  ode=self.label_c
+00007ac0: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
+00007ad0: 2020 2020 2020 2020 2063 6e6e 5f69 6e64           cnn_ind
+00007ae0: 6578 3d6e 6574 776f 726b 2c0a 2020 2020  ex=network,.    
+00007af0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00007b00: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00007b10: 7461 5f76 616c 6964 203d 2072 6574 7572  ta_valid = retur
+00007b20: 6e5f 6461 7461 7365 7428 0a20 2020 2020  n_dataset(.     
+00007b30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00007b40: 656c 662e 6361 7073 5f64 6972 6563 746f  elf.caps_directo
+00007b50: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+00007b60: 2020 2020 2020 2020 7370 6c69 745f 6466          split_df
+00007b70: 5f64 6963 745b 2276 616c 6964 6174 696f  _dict["validatio
+00007b80: 6e22 5d2c 0a20 2020 2020 2020 2020 2020  n"],.           
+00007b90: 2020 2020 2020 2020 2073 656c 662e 7072           self.pr
+00007ba0: 6570 726f 6365 7373 696e 675f 6469 6374  eprocessing_dict
+00007bb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007bc0: 2020 2020 2020 7472 6169 6e5f 7472 616e        train_tran
+00007bd0: 7366 6f72 6d61 7469 6f6e 733d 7472 6169  sformations=trai
+00007be0: 6e5f 7472 616e 7366 6f72 6d73 2c0a 2020  n_transforms,.  
+00007bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c00: 2020 616c 6c5f 7472 616e 7366 6f72 6d61    all_transforma
+00007c10: 7469 6f6e 733d 616c 6c5f 7472 616e 7366  tions=all_transf
+00007c20: 6f72 6d73 2c0a 2020 2020 2020 2020 2020  orms,.          
+00007c30: 2020 2020 2020 2020 2020 6d75 6c74 695f            multi_
+00007c40: 636f 686f 7274 3d73 656c 662e 6d75 6c74  cohort=self.mult
+00007c50: 695f 636f 686f 7274 2c0a 2020 2020 2020  i_cohort,.      
+00007c60: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00007c70: 6265 6c3d 7365 6c66 2e6c 6162 656c 2c0a  bel=self.label,.
+00007c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c90: 2020 2020 6c61 6265 6c5f 636f 6465 3d73      label_code=s
+00007ca0: 656c 662e 6c61 6265 6c5f 636f 6465 2c0a  elf.label_code,.
+00007cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cc0: 2020 2020 636e 6e5f 696e 6465 783d 6e65      cnn_index=ne
+00007cd0: 7477 6f72 6b2c 0a20 2020 2020 2020 2020  twork,.         
+00007ce0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00007cf0: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
+00007d00: 7361 6d70 6c65 7220 3d20 7365 6c66 2e74  sampler = self.t
+00007d10: 6173 6b5f 6d61 6e61 6765 722e 6765 6e65  ask_manager.gene
+00007d20: 7261 7465 5f73 616d 706c 6572 280a 2020  rate_sampler(.  
+00007d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d40: 2020 6461 7461 5f74 7261 696e 2c0a 2020    data_train,.  
+00007d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d60: 2020 7365 6c66 2e73 616d 706c 6572 2c0a    self.sampler,.
+00007d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d80: 2020 2020 6470 5f64 6567 7265 653d 636c      dp_degree=cl
+00007d90: 7573 7465 722e 776f 726c 645f 7369 7a65  uster.world_size
+00007da0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007db0: 2020 2020 2020 7261 6e6b 3d63 6c75 7374        rank=clust
+00007dc0: 6572 2e72 616e 6b2c 0a20 2020 2020 2020  er.rank,.       
+00007dd0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00007de0: 2020 2020 2020 2020 2020 2074 7261 696e             train
+00007df0: 5f6c 6f61 6465 7220 3d20 4461 7461 4c6f  _loader = DataLo
+00007e00: 6164 6572 280a 2020 2020 2020 2020 2020  ader(.          
+00007e10: 2020 2020 2020 2020 2020 6461 7461 5f74            data_t
+00007e20: 7261 696e 2c0a 2020 2020 2020 2020 2020  rain,.          
+00007e30: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
+00007e40: 7369 7a65 3d73 656c 662e 6261 7463 685f  size=self.batch_
+00007e50: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00007e60: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
+00007e70: 723d 7472 6169 6e5f 7361 6d70 6c65 722c  r=train_sampler,
+00007e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007e90: 2020 2020 206e 756d 5f77 6f72 6b65 7273       num_workers
+00007ea0: 3d73 656c 662e 6e5f 7072 6f63 2c0a 2020  =self.n_proc,.  
+00007eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ec0: 2020 776f 726b 6572 5f69 6e69 745f 666e    worker_init_fn
+00007ed0: 3d70 6c5f 776f 726b 6572 5f69 6e69 745f  =pl_worker_init_
+00007ee0: 6675 6e63 7469 6f6e 2c0a 2020 2020 2020  function,.      
+00007ef0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00007f00: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00007f10: 6964 5f73 616d 706c 6572 203d 2044 6973  id_sampler = Dis
+00007f20: 7472 6962 7574 6564 5361 6d70 6c65 7228  tributedSampler(
+00007f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007f40: 2020 2020 2064 6174 615f 7661 6c69 642c       data_valid,
+00007f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007f60: 2020 2020 206e 756d 5f72 6570 6c69 6361       num_replica
+00007f70: 733d 636c 7573 7465 722e 776f 726c 645f  s=cluster.world_
+00007f80: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00007f90: 2020 2020 2020 2020 2020 7261 6e6b 3d63            rank=c
+00007fa0: 6c75 7374 6572 2e72 616e 6b2c 0a20 2020  luster.rank,.   
+00007fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fc0: 2073 6875 6666 6c65 3d46 616c 7365 2c0a   shuffle=False,.
+00007fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fe0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00007ff0: 2020 7661 6c69 645f 6c6f 6164 6572 203d    valid_loader =
+00008000: 2044 6174 614c 6f61 6465 7228 0a20 2020   DataLoader(.   
 00008010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008020: 2020 7368 7566 666c 653d 4661 6c73 652c    shuffle=False,
-00008030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008040: 2020 2020 206e 756d 5f77 6f72 6b65 7273       num_workers
-00008050: 3d73 656c 662e 6e5f 7072 6f63 2c0a 2020  =self.n_proc,.  
+00008020: 2064 6174 615f 7661 6c69 642c 0a20 2020   data_valid,.   
+00008030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008040: 2062 6174 6368 5f73 697a 653d 7365 6c66   batch_size=self
+00008050: 2e62 6174 6368 5f73 697a 652c 0a20 2020  .batch_size,.   
 00008060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008070: 2020 7361 6d70 6c65 723d 7661 6c69 645f    sampler=valid_
-00008080: 7361 6d70 6c65 722c 0a20 2020 2020 2020  sampler,.       
-00008090: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000080a0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-000080b0: 636c 696e 6963 6164 6c2e 7574 696c 732e  clinicadl.utils.
-000080c0: 6361 6c6c 6261 636b 732e 6361 6c6c 6261  callbacks.callba
-000080d0: 636b 7320 696d 706f 7274 2043 6f64 6543  cks import CodeC
-000080e0: 6172 626f 6e54 7261 636b 6572 0a0a 2020  arbonTracker..  
-000080f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00008100: 6c66 2e5f 7472 6169 6e28 0a20 2020 2020  lf._train(.     
-00008110: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00008120: 7261 696e 5f6c 6f61 6465 722c 0a20 2020  rain_loader,.   
-00008130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008140: 2076 616c 6964 5f6c 6f61 6465 722c 0a20   valid_loader,. 
-00008150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008160: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
-00008170: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00008180: 7477 6f72 6b2c 0a20 2020 2020 2020 2020  twork,.         
-00008190: 2020 2020 2020 2020 2020 2072 6573 756d             resum
-000081a0: 653d 7265 7375 6d65 2c0a 2020 2020 2020  e=resume,.      
-000081b0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000081c0: 6c6c 6261 636b 733d 5b43 6f64 6543 6172  llbacks=[CodeCar
-000081d0: 626f 6e54 7261 636b 6572 5d2c 0a20 2020  bonTracker],.   
-000081e0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000081f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00008200: 6573 756d 6520 3d20 4661 6c73 650a 0a20  esume = False.. 
-00008210: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
-00008220: 7573 7465 722e 6d61 7374 6572 3a0a 2020  uster.master:.  
-00008230: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00008240: 6c66 2e5f 656e 7365 6d62 6c65 5f70 7265  lf._ensemble_pre
-00008250: 6469 6374 696f 6e28 0a20 2020 2020 2020  diction(.       
-00008260: 2020 2020 2020 2020 2020 2020 2022 7472               "tr
-00008270: 6169 6e22 2c0a 2020 2020 2020 2020 2020  ain",.          
-00008280: 2020 2020 2020 2020 2020 7370 6c69 742c            split,
-00008290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000082a0: 2020 2020 2073 656c 662e 7365 6c65 6374       self.select
-000082b0: 696f 6e5f 6d65 7472 6963 732c 0a20 2020  ion_metrics,.   
-000082c0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000082d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000082e0: 656c 662e 5f65 6e73 656d 626c 655f 7072  elf._ensemble_pr
-000082f0: 6564 6963 7469 6f6e 280a 2020 2020 2020  ediction(.      
-00008300: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-00008310: 616c 6964 6174 696f 6e22 2c0a 2020 2020  alidation",.    
-00008320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008330: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
-00008340: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00008350: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-00008360: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00008370: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00008380: 2020 2020 2020 7365 6c66 2e5f 6572 6173        self._eras
-00008390: 655f 746d 7028 7370 6c69 7429 0a0a 2020  e_tmp(split)..  
-000083a0: 2020 6465 6620 5f74 7261 696e 5f73 7364    def _train_ssd
-000083b0: 6128 7365 6c66 2c20 7370 6c69 745f 6c69  a(self, split_li
-000083c0: 7374 3d4e 6f6e 652c 2072 6573 756d 653d  st=None, resume=
-000083d0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-000083e0: 2222 220a 2020 2020 2020 2020 5472 6169  """.        Trai
-000083f0: 6e73 2061 2073 696e 676c 6520 434e 4e20  ns a single CNN 
-00008400: 666f 7220 6120 736f 7572 6365 2061 6e64  for a source and
-00008410: 2074 6172 6765 7420 646f 6d61 696e 2075   target domain u
-00008420: 7369 6e67 2073 656d 692d 7375 7065 7276  sing semi-superv
-00008430: 6973 6564 2064 6f6d 6169 6e20 6164 6170  ised domain adap
-00008440: 7461 7469 6f6e 2e0a 0a20 2020 2020 2020  tation...       
-00008450: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-00008460: 2020 2073 706c 6974 5f6c 6973 7420 286c     split_list (l
-00008470: 6973 745b 696e 745d 293a 206c 6973 7420  ist[int]): list 
-00008480: 6f66 2073 706c 6974 7320 7468 6174 2061  of splits that a
-00008490: 7265 2074 7261 696e 6564 2e0a 2020 2020  re trained..    
-000084a0: 2020 2020 2020 2020 7265 7375 6d65 2028          resume (
-000084b0: 626f 6f6c 293a 2049 6620 5472 7565 2074  bool): If True t
-000084c0: 6865 206a 6f62 2069 7320 7265 7375 6d65  he job is resume
-000084d0: 6420 6672 6f6d 2063 6865 636b 706f 696e  d from checkpoin
-000084e0: 742e 0a20 2020 2020 2020 2022 2222 0a20  t..        """. 
-000084f0: 2020 2020 2020 2066 726f 6d20 746f 7263         from torc
-00008500: 682e 7574 696c 732e 6461 7461 2069 6d70  h.utils.data imp
-00008510: 6f72 7420 4461 7461 4c6f 6164 6572 0a0a  ort DataLoader..
-00008520: 2020 2020 2020 2020 7472 6169 6e5f 7472          train_tr
-00008530: 616e 7366 6f72 6d73 2c20 616c 6c5f 7472  ansforms, all_tr
-00008540: 616e 7366 6f72 6d73 203d 2067 6574 5f74  ansforms = get_t
-00008550: 7261 6e73 666f 726d 7328 0a20 2020 2020  ransforms(.     
-00008560: 2020 2020 2020 206e 6f72 6d61 6c69 7a65         normalize
-00008570: 3d73 656c 662e 6e6f 726d 616c 697a 652c  =self.normalize,
-00008580: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00008590: 615f 6175 676d 656e 7461 7469 6f6e 3d73  a_augmentation=s
-000085a0: 656c 662e 6461 7461 5f61 7567 6d65 6e74  elf.data_augment
-000085b0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
-000085c0: 2020 2073 697a 655f 7265 6475 6374 696f     size_reductio
-000085d0: 6e3d 7365 6c66 2e73 697a 655f 7265 6475  n=self.size_redu
-000085e0: 6374 696f 6e2c 0a20 2020 2020 2020 2020  ction,.         
-000085f0: 2020 2073 697a 655f 7265 6475 6374 696f     size_reductio
-00008600: 6e5f 6661 6374 6f72 3d73 656c 662e 7369  n_factor=self.si
-00008610: 7a65 5f72 6564 7563 7469 6f6e 5f66 6163  ze_reduction_fac
-00008620: 746f 722c 0a20 2020 2020 2020 2029 0a0a  tor,.        )..
-00008630: 2020 2020 2020 2020 7370 6c69 745f 6d61          split_ma
-00008640: 6e61 6765 7220 3d20 7365 6c66 2e5f 696e  nager = self._in
-00008650: 6974 5f73 706c 6974 5f6d 616e 6167 6572  it_split_manager
-00008660: 2873 706c 6974 5f6c 6973 7429 0a0a 2020  (split_list)..  
-00008670: 2020 2020 2020 7370 6c69 745f 6d61 6e61        split_mana
-00008680: 6765 725f 7461 7267 6574 5f6c 6162 203d  ger_target_lab =
-00008690: 2073 656c 662e 5f69 6e69 745f 7370 6c69   self._init_spli
-000086a0: 745f 6d61 6e61 6765 725f 7373 6461 280a  t_manager_ssda(.
-000086b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000086c0: 2e63 6170 735f 7461 7267 6574 2c20 7365  .caps_target, se
-000086d0: 6c66 2e74 7376 5f74 6172 6765 745f 6c61  lf.tsv_target_la
-000086e0: 622c 2073 706c 6974 5f6c 6973 740a 2020  b, split_list.  
-000086f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00008700: 2066 6f72 2073 706c 6974 2069 6e20 7370   for split in sp
-00008710: 6c69 745f 6d61 6e61 6765 722e 7370 6c69  lit_manager.spli
-00008720: 745f 6974 6572 6174 6f72 2829 3a0a 2020  t_iterator():.  
-00008730: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00008740: 2e69 6e66 6f28 6622 5472 6169 6e69 6e67  .info(f"Training
-00008750: 2073 706c 6974 207b 7370 6c69 747d 2229   split {split}")
-00008760: 0a20 2020 2020 2020 2020 2020 2073 6565  .            see
-00008770: 645f 6576 6572 7974 6869 6e67 2873 656c  d_everything(sel
-00008780: 662e 7365 6564 2c20 7365 6c66 2e64 6574  f.seed, self.det
-00008790: 6572 6d69 6e69 7374 6963 2c20 7365 6c66  erministic, self
-000087a0: 2e63 6f6d 7065 6e73 6174 696f 6e29 0a0a  .compensation)..
-000087b0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
-000087c0: 745f 6466 5f64 6963 7420 3d20 7370 6c69  t_df_dict = spli
-000087d0: 745f 6d61 6e61 6765 725b 7370 6c69 745d  t_manager[split]
-000087e0: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
-000087f0: 6974 5f64 665f 6469 6374 5f74 6172 6765  it_df_dict_targe
-00008800: 745f 6c61 6220 3d20 7370 6c69 745f 6d61  t_lab = split_ma
-00008810: 6e61 6765 725f 7461 7267 6574 5f6c 6162  nager_target_lab
-00008820: 5b73 706c 6974 5d0a 0a20 2020 2020 2020  [split]..       
-00008830: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00008840: 6728 224c 6f61 6469 6e67 2073 6f75 7263  g("Loading sourc
-00008850: 6520 7472 6169 6e69 6e67 2064 6174 612e  e training data.
-00008860: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
-00008870: 2064 6174 615f 7472 6169 6e5f 736f 7572   data_train_sour
-00008880: 6365 203d 2072 6574 7572 6e5f 6461 7461  ce = return_data
-00008890: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
-000088a0: 2020 2020 2073 656c 662e 6361 7073 5f64       self.caps_d
-000088b0: 6972 6563 746f 7279 2c0a 2020 2020 2020  irectory,.      
-000088c0: 2020 2020 2020 2020 2020 7370 6c69 745f            split_
-000088d0: 6466 5f64 6963 745b 2274 7261 696e 225d  df_dict["train"]
-000088e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000088f0: 2020 7365 6c66 2e70 7265 7072 6f63 6573    self.preproces
-00008900: 7369 6e67 5f64 6963 742c 0a20 2020 2020  sing_dict,.     
-00008910: 2020 2020 2020 2020 2020 2074 7261 696e             train
-00008920: 5f74 7261 6e73 666f 726d 6174 696f 6e73  _transformations
-00008930: 3d74 7261 696e 5f74 7261 6e73 666f 726d  =train_transform
-00008940: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00008950: 2020 2061 6c6c 5f74 7261 6e73 666f 726d     all_transform
-00008960: 6174 696f 6e73 3d61 6c6c 5f74 7261 6e73  ations=all_trans
-00008970: 666f 726d 732c 0a20 2020 2020 2020 2020  forms,.         
-00008980: 2020 2020 2020 206d 756c 7469 5f63 6f68         multi_coh
-00008990: 6f72 743d 7365 6c66 2e6d 756c 7469 5f63  ort=self.multi_c
-000089a0: 6f68 6f72 742c 0a20 2020 2020 2020 2020  ohort,.         
-000089b0: 2020 2020 2020 206c 6162 656c 3d73 656c         label=sel
-000089c0: 662e 6c61 6265 6c2c 0a20 2020 2020 2020  f.label,.       
-000089d0: 2020 2020 2020 2020 206c 6162 656c 5f63           label_c
-000089e0: 6f64 653d 7365 6c66 2e6c 6162 656c 5f63  ode=self.label_c
-000089f0: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
-00008a00: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00008a10: 6c6f 6767 6572 2e64 6562 7567 2822 4c6f  logger.debug("Lo
-00008a20: 6164 696e 6720 7461 7267 6574 206c 6162  ading target lab
-00008a30: 656c 6c65 6420 7472 6169 6e69 6e67 2064  elled training d
-00008a40: 6174 612e 2e2e 2229 0a20 2020 2020 2020  ata...").       
-00008a50: 2020 2020 2064 6174 615f 7472 6169 6e5f       data_train_
-00008a60: 7461 7267 6574 5f6c 6162 656c 6564 203d  target_labeled =
-00008a70: 2072 6574 7572 6e5f 6461 7461 7365 7428   return_dataset(
-00008a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008a90: 2050 6174 6828 7365 6c66 2e63 6170 735f   Path(self.caps_
-00008aa0: 7461 7267 6574 292c 2020 2320 544f 2043  target),  # TO C
-00008ab0: 4845 434b 0a20 2020 2020 2020 2020 2020  HECK.           
-00008ac0: 2020 2020 2073 706c 6974 5f64 665f 6469       split_df_di
-00008ad0: 6374 5f74 6172 6765 745f 6c61 625b 2274  ct_target_lab["t
-00008ae0: 7261 696e 225d 2c0a 2020 2020 2020 2020  rain"],.        
-00008af0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
-00008b00: 7072 6f63 6573 7369 6e67 5f64 6963 745f  processing_dict_
-00008b10: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
-00008b20: 2020 2020 2020 2020 7472 6169 6e5f 7472          train_tr
-00008b30: 616e 7366 6f72 6d61 7469 6f6e 733d 7472  ansformations=tr
-00008b40: 6169 6e5f 7472 616e 7366 6f72 6d73 2c0a  ain_transforms,.
-00008b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b60: 616c 6c5f 7472 616e 7366 6f72 6d61 7469  all_transformati
-00008b70: 6f6e 733d 616c 6c5f 7472 616e 7366 6f72  ons=all_transfor
-00008b80: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00008b90: 2020 2020 6d75 6c74 695f 636f 686f 7274      multi_cohort
-00008ba0: 3d46 616c 7365 2c20 2023 2041 2063 6865  =False,  # A che
-00008bb0: 636b 6572 0a20 2020 2020 2020 2020 2020  cker.           
-00008bc0: 2020 2020 206c 6162 656c 3d73 656c 662e       label=self.
-00008bd0: 6c61 6265 6c2c 0a20 2020 2020 2020 2020  label,.         
-00008be0: 2020 2020 2020 206c 6162 656c 5f63 6f64         label_cod
-00008bf0: 653d 7365 6c66 2e6c 6162 656c 5f63 6f64  e=self.label_cod
-00008c00: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-00008c10: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00008c20: 6d20 746f 7263 682e 7574 696c 732e 6461  m torch.utils.da
-00008c30: 7461 2069 6d70 6f72 7420 436f 6e63 6174  ta import Concat
-00008c40: 4461 7461 7365 742c 2044 6174 614c 6f61  Dataset, DataLoa
-00008c50: 6465 720a 0a20 2020 2020 2020 2020 2020  der..           
-00008c60: 2063 6f6d 6269 6e65 645f 6461 7461 7365   combined_datase
-00008c70: 7420 3d20 436f 6e63 6174 4461 7461 7365  t = ConcatDatase
-00008c80: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00008c90: 2020 205b 6461 7461 5f74 7261 696e 5f73     [data_train_s
-00008ca0: 6f75 7263 652c 2064 6174 615f 7472 6169  ource, data_trai
-00008cb0: 6e5f 7461 7267 6574 5f6c 6162 656c 6564  n_target_labeled
-00008cc0: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
-00008cd0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00008ce0: 6765 722e 6465 6275 6728 224c 6f61 6469  ger.debug("Loadi
-00008cf0: 6e67 2074 6172 6765 7420 756e 6c61 6265  ng target unlabe
-00008d00: 6c6c 6564 2074 7261 696e 696e 6720 6461  lled training da
-00008d10: 7461 2e2e 2e22 290a 2020 2020 2020 2020  ta...").        
-00008d20: 2020 2020 6461 7461 5f74 6172 6765 745f      data_target_
-00008d30: 756e 6c61 6265 6c65 6420 3d20 7265 7475  unlabeled = retu
-00008d40: 726e 5f64 6174 6173 6574 280a 2020 2020  rn_dataset(.    
-00008d50: 2020 2020 2020 2020 2020 2020 5061 7468              Path
-00008d60: 2873 656c 662e 6361 7073 5f74 6172 6765  (self.caps_targe
-00008d70: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-00008d80: 2020 2020 7064 2e72 6561 645f 6373 7628      pd.read_csv(
-00008d90: 7365 6c66 2e74 7376 5f74 6172 6765 745f  self.tsv_target_
-00008da0: 756e 6c61 622c 2073 6570 3d22 5c74 2229  unlab, sep="\t")
-00008db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008dc0: 2020 7365 6c66 2e70 7265 7072 6f63 6573    self.preproces
-00008dd0: 7369 6e67 5f64 6963 745f 7461 7267 6574  sing_dict_target
-00008de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008df0: 2020 7472 6169 6e5f 7472 616e 7366 6f72    train_transfor
-00008e00: 6d61 7469 6f6e 733d 7472 6169 6e5f 7472  mations=train_tr
-00008e10: 616e 7366 6f72 6d73 2c0a 2020 2020 2020  ansforms,.      
-00008e20: 2020 2020 2020 2020 2020 616c 6c5f 7472            all_tr
-00008e30: 616e 7366 6f72 6d61 7469 6f6e 733d 616c  ansformations=al
-00008e40: 6c5f 7472 616e 7366 6f72 6d73 2c0a 2020  l_transforms,.  
-00008e50: 2020 2020 2020 2020 2020 2020 2020 6d75                mu
-00008e60: 6c74 695f 636f 686f 7274 3d46 616c 7365  lti_cohort=False
-00008e70: 2c20 2023 2041 2063 6865 636b 6572 0a20  ,  # A checker. 
-00008e80: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00008e90: 6162 656c 3d73 656c 662e 6c61 6265 6c2c  abel=self.label,
-00008ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008eb0: 206c 6162 656c 5f63 6f64 653d 7365 6c66   label_code=self
-00008ec0: 2e6c 6162 656c 5f63 6f64 652c 0a20 2020  .label_code,.   
-00008ed0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00008ee0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00008ef0: 6562 7567 2822 4c6f 6164 696e 6720 7661  ebug("Loading va
-00008f00: 6c69 6461 7469 6f6e 2073 6f75 7263 6520  lidation source 
-00008f10: 6461 7461 2e2e 2e22 290a 2020 2020 2020  data...").      
-00008f20: 2020 2020 2020 6461 7461 5f76 616c 6964        data_valid
-00008f30: 5f73 6f75 7263 6520 3d20 7265 7475 726e  _source = return
-00008f40: 5f64 6174 6173 6574 280a 2020 2020 2020  _dataset(.      
-00008f50: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00008f60: 6170 735f 6469 7265 6374 6f72 792c 0a20  aps_directory,. 
-00008f70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00008f80: 706c 6974 5f64 665f 6469 6374 5b22 7661  plit_df_dict["va
-00008f90: 6c69 6461 7469 6f6e 225d 2c0a 2020 2020  lidation"],.    
-00008fa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00008fb0: 2e70 7265 7072 6f63 6573 7369 6e67 5f64  .preprocessing_d
-00008fc0: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
-00008fd0: 2020 2020 2074 7261 696e 5f74 7261 6e73       train_trans
-00008fe0: 666f 726d 6174 696f 6e73 3d74 7261 696e  formations=train
-00008ff0: 5f74 7261 6e73 666f 726d 732c 0a20 2020  _transforms,.   
-00009000: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-00009010: 5f74 7261 6e73 666f 726d 6174 696f 6e73  _transformations
-00009020: 3d61 6c6c 5f74 7261 6e73 666f 726d 732c  =all_transforms,
-00009030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009040: 206d 756c 7469 5f63 6f68 6f72 743d 7365   multi_cohort=se
-00009050: 6c66 2e6d 756c 7469 5f63 6f68 6f72 742c  lf.multi_cohort,
-00009060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009070: 206c 6162 656c 3d73 656c 662e 6c61 6265   label=self.labe
-00009080: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-00009090: 2020 206c 6162 656c 5f63 6f64 653d 7365     label_code=se
-000090a0: 6c66 2e6c 6162 656c 5f63 6f64 652c 0a20  lf.label_code,. 
-000090b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000090c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000090d0: 6465 6275 6728 224c 6f61 6469 6e67 2076  debug("Loading v
-000090e0: 616c 6964 6174 696f 6e20 7461 7267 6574  alidation target
-000090f0: 206c 6162 656c 6c65 6420 6461 7461 2e2e   labelled data..
-00009100: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00009110: 6461 7461 5f76 616c 6964 5f74 6172 6765  data_valid_targe
-00009120: 745f 6c61 6265 6c65 6420 3d20 7265 7475  t_labeled = retu
-00009130: 726e 5f64 6174 6173 6574 280a 2020 2020  rn_dataset(.    
-00009140: 2020 2020 2020 2020 2020 2020 5061 7468              Path
-00009150: 2873 656c 662e 6361 7073 5f74 6172 6765  (self.caps_targe
-00009160: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-00009170: 2020 2020 7370 6c69 745f 6466 5f64 6963      split_df_dic
-00009180: 745f 7461 7267 6574 5f6c 6162 5b22 7661  t_target_lab["va
-00009190: 6c69 6461 7469 6f6e 225d 2c0a 2020 2020  lidation"],.    
-000091a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000091b0: 2e70 7265 7072 6f63 6573 7369 6e67 5f64  .preprocessing_d
-000091c0: 6963 745f 7461 7267 6574 2c0a 2020 2020  ict_target,.    
-000091d0: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-000091e0: 6e5f 7472 616e 7366 6f72 6d61 7469 6f6e  n_transformation
-000091f0: 733d 7472 6169 6e5f 7472 616e 7366 6f72  s=train_transfor
-00009200: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00009210: 2020 2020 616c 6c5f 7472 616e 7366 6f72      all_transfor
-00009220: 6d61 7469 6f6e 733d 616c 6c5f 7472 616e  mations=all_tran
-00009230: 7366 6f72 6d73 2c0a 2020 2020 2020 2020  sforms,.        
-00009240: 2020 2020 2020 2020 6d75 6c74 695f 636f          multi_co
-00009250: 686f 7274 3d46 616c 7365 2c0a 2020 2020  hort=False,.    
-00009260: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
-00009270: 6c3d 7365 6c66 2e6c 6162 656c 2c0a 2020  l=self.label,.  
-00009280: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00009290: 6265 6c5f 636f 6465 3d73 656c 662e 6c61  bel_code=self.la
-000092a0: 6265 6c5f 636f 6465 2c0a 2020 2020 2020  bel_code,.      
-000092b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000092c0: 2020 2020 7472 6169 6e5f 736f 7572 6365      train_source
-000092d0: 5f73 616d 706c 6572 203d 2073 656c 662e  _sampler = self.
-000092e0: 7461 736b 5f6d 616e 6167 6572 2e67 656e  task_manager.gen
-000092f0: 6572 6174 655f 7361 6d70 6c65 7228 0a20  erate_sampler(. 
-00009300: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009310: 6174 615f 7472 6169 6e5f 736f 7572 6365  ata_train_source
-00009320: 2c20 7365 6c66 2e73 616d 706c 6572 0a20  , self.sampler. 
-00009330: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00009340: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00009350: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00009360: 2020 2020 2020 2066 2247 6574 7469 6e67         f"Getting
-00009370: 2074 7261 696e 2061 6e64 2076 616c 6964   train and valid
-00009380: 6174 696f 6e20 6c6f 6164 6572 2077 6974  ation loader wit
-00009390: 6820 6261 7463 6820 7369 7a65 207b 7365  h batch size {se
-000093a0: 6c66 2e62 6174 6368 5f73 697a 657d 220a  lf.batch_size}".
-000093b0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-000093c0: 2020 2020 2020 2020 2020 2023 2320 4f76             ## Ov
-000093d0: 6572 7361 6d70 6c69 6e67 206f 6620 7468  ersampling of th
-000093e0: 6520 7461 7267 6574 2064 6174 6173 6574  e target dataset
-000093f0: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00009400: 6d20 746f 7263 682e 7574 696c 732e 6461  m torch.utils.da
-00009410: 7461 2069 6d70 6f72 7420 5375 6273 6574  ta import Subset
-00009420: 5261 6e64 6f6d 5361 6d70 6c65 720a 0a20  RandomSampler.. 
-00009430: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-00009440: 6174 6520 696e 6465 7820 6c69 7374 7320  ate index lists 
-00009450: 666f 7220 7461 7267 6574 206c 6162 656c  for target label
-00009460: 6564 2064 6174 6173 6574 0a20 2020 2020  ed dataset.     
-00009470: 2020 2020 2020 206c 6162 656c 6564 5f69         labeled_i
-00009480: 6e64 6963 6573 203d 206c 6973 7428 7261  ndices = list(ra
-00009490: 6e67 6528 6c65 6e28 6461 7461 5f74 7261  nge(len(data_tra
-000094a0: 696e 5f74 6172 6765 745f 6c61 6265 6c65  in_target_labele
-000094b0: 6429 2929 0a0a 2020 2020 2020 2020 2020  d)))..          
-000094c0: 2020 2320 4f76 6572 7361 6d70 6c65 2074    # Oversample t
-000094d0: 6865 2069 6e64 6963 6573 2066 6f72 2074  he indices for t
-000094e0: 6865 2074 6172 6765 7420 6c61 6265 6c64  he target labeld
-000094f0: 2064 6174 6173 6574 2074 6f20 6d61 7463   dataset to matc
-00009500: 6820 7468 6520 7369 7a65 206f 6620 7468  h the size of th
-00009510: 6520 6c61 6265 6c65 6420 736f 7572 6365  e labeled source
-00009520: 2064 6174 6173 6574 0a20 2020 2020 2020   dataset.       
-00009530: 2020 2020 2064 6174 615f 7472 6169 6e5f       data_train_
-00009540: 736f 7572 6365 5f73 697a 6520 3d20 6c65  source_size = le
-00009550: 6e28 6461 7461 5f74 7261 696e 5f73 6f75  n(data_train_sou
-00009560: 7263 6529 202f 2f20 7365 6c66 2e62 6174  rce) // self.bat
-00009570: 6368 5f73 697a 650a 2020 2020 2020 2020  ch_size.        
-00009580: 2020 2020 6c61 6265 6c65 645f 6f76 6572      labeled_over
-00009590: 7361 6d70 6c65 645f 696e 6469 6365 7320  sampled_indices 
-000095a0: 3d20 6c61 6265 6c65 645f 696e 6469 6365  = labeled_indice
-000095b0: 7320 2a20 280a 2020 2020 2020 2020 2020  s * (.          
-000095c0: 2020 2020 2020 6461 7461 5f74 7261 696e        data_train
-000095d0: 5f73 6f75 7263 655f 7369 7a65 202f 2f20  _source_size // 
-000095e0: 6c65 6e28 6c61 6265 6c65 645f 696e 6469  len(labeled_indi
-000095f0: 6365 7329 0a20 2020 2020 2020 2020 2020  ces).           
-00009600: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00009610: 2320 4170 7065 6e64 2072 656d 6169 6e69  # Append remaini
-00009620: 6e67 2069 6e64 6963 6573 2074 6f20 6d61  ng indices to ma
-00009630: 7463 6820 7468 6520 7369 7a65 206f 6620  tch the size of 
-00009640: 7468 6520 6c61 7267 6573 7420 6461 7461  the largest data
-00009650: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
-00009660: 6c61 6265 6c65 645f 6f76 6572 7361 6d70  labeled_oversamp
-00009670: 6c65 645f 696e 6469 6365 7320 2b3d 206c  led_indices += l
-00009680: 6162 656c 6564 5f69 6e64 6963 6573 5b0a  abeled_indices[.
-00009690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096a0: 3a20 6461 7461 5f74 7261 696e 5f73 6f75  : data_train_sou
-000096b0: 7263 655f 7369 7a65 2025 206c 656e 286c  rce_size % len(l
-000096c0: 6162 656c 6564 5f69 6e64 6963 6573 290a  abeled_indices).
-000096d0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
-000096e0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-000096f0: 6174 6520 5375 6273 6574 5261 6e64 6f6d  ate SubsetRandom
-00009700: 5361 6d70 6c65 7273 2075 7369 6e67 2074  Samplers using t
-00009710: 6865 206f 7665 7273 616d 706c 6564 2069  he oversampled i
-00009720: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-00009730: 2020 206c 6162 656c 6564 5f73 616d 706c     labeled_sampl
-00009740: 6572 203d 2053 7562 7365 7452 616e 646f  er = SubsetRando
-00009750: 6d53 616d 706c 6572 286c 6162 656c 6564  mSampler(labeled
-00009760: 5f6f 7665 7273 616d 706c 6564 5f69 6e64  _oversampled_ind
-00009770: 6963 6573 290a 0a20 2020 2020 2020 2020  ices)..         
-00009780: 2020 2074 7261 696e 5f73 6f75 7263 655f     train_source_
-00009790: 6c6f 6164 6572 203d 2044 6174 614c 6f61  loader = DataLoa
-000097a0: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
-000097b0: 2020 2020 2064 6174 615f 7472 6169 6e5f       data_train_
-000097c0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-000097d0: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
-000097e0: 7a65 3d73 656c 662e 6261 7463 685f 7369  ze=self.batch_si
-000097f0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
-00009800: 2020 2020 7361 6d70 6c65 723d 7472 6169      sampler=trai
-00009810: 6e5f 736f 7572 6365 5f73 616d 706c 6572  n_source_sampler
-00009820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009830: 2020 2320 7368 7566 666c 653d 5472 7565    # shuffle=True
-00009840: 2c20 2023 206c 656e 2864 6174 615f 7472  ,  # len(data_tr
-00009850: 6169 6e5f 736f 7572 6365 2920 3c20 6c65  ain_source) < le
-00009860: 6e28 6461 7461 5f74 7261 696e 5f74 6172  n(data_train_tar
-00009870: 6765 745f 6c61 6265 6c65 6429 2c0a 2020  get_labeled),.  
-00009880: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-00009890: 6d5f 776f 726b 6572 733d 7365 6c66 2e6e  m_workers=self.n
-000098a0: 5f70 726f 632c 0a20 2020 2020 2020 2020  _proc,.         
-000098b0: 2020 2020 2020 2077 6f72 6b65 725f 696e         worker_in
-000098c0: 6974 5f66 6e3d 706c 5f77 6f72 6b65 725f  it_fn=pl_worker_
-000098d0: 696e 6974 5f66 756e 6374 696f 6e2c 0a20  init_function,. 
-000098e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000098f0: 726f 705f 6c61 7374 3d54 7275 652c 0a20  rop_last=True,. 
-00009900: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009910: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00009920: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00009930: 2020 2020 2020 6622 5472 6169 6e20 736f        f"Train so
-00009940: 7572 6365 206c 6f61 6465 7220 7369 7a65  urce loader size
-00009950: 2069 7320 7b6c 656e 2874 7261 696e 5f73   is {len(train_s
-00009960: 6f75 7263 655f 6c6f 6164 6572 292a 7365  ource_loader)*se
-00009970: 6c66 2e62 6174 6368 5f73 697a 657d 220a  lf.batch_size}".
-00009980: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00009990: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-000099a0: 7461 7267 6574 5f6c 6f61 6465 7220 3d20  target_loader = 
-000099b0: 4461 7461 4c6f 6164 6572 280a 2020 2020  DataLoader(.    
-000099c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000099d0: 5f74 7261 696e 5f74 6172 6765 745f 6c61  _train_target_la
-000099e0: 6265 6c65 642c 0a20 2020 2020 2020 2020  beled,.         
-000099f0: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
-00009a00: 653d 312c 2020 2320 546f 206c 696d 6974  e=1,  # To limit
-00009a10: 2074 6865 206e 6565 6420 6f66 206f 7665   the need of ove
-00009a20: 7273 616d 706c 696e 670a 2020 2020 2020  rsampling.      
-00009a30: 2020 2020 2020 2020 2020 2320 7361 6d70            # samp
-00009a40: 6c65 723d 7472 6169 6e5f 7461 7267 6574  ler=train_target
-00009a50: 5f73 616d 706c 6572 2c0a 2020 2020 2020  _sampler,.      
-00009a60: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
-00009a70: 723d 6c61 6265 6c65 645f 7361 6d70 6c65  r=labeled_sample
-00009a80: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00009a90: 2020 206e 756d 5f77 6f72 6b65 7273 3d73     num_workers=s
-00009aa0: 656c 662e 6e5f 7072 6f63 2c0a 2020 2020  elf.n_proc,.    
-00009ab0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00009ac0: 6572 5f69 6e69 745f 666e 3d70 6c5f 776f  er_init_fn=pl_wo
-00009ad0: 726b 6572 5f69 6e69 745f 6675 6e63 7469  rker_init_functi
-00009ae0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00009af0: 2020 2020 2320 7368 7566 666c 653d 5472      # shuffle=Tr
-00009b00: 7565 2c20 2023 206c 656e 2864 6174 615f  ue,  # len(data_
-00009b10: 7472 6169 6e5f 7461 7267 6574 5f6c 6162  train_target_lab
-00009b20: 656c 6564 2920 3c20 6c65 6e28 6461 7461  eled) < len(data
-00009b30: 5f74 7261 696e 5f73 6f75 7263 6529 2c0a  _train_source),.
-00009b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b50: 6472 6f70 5f6c 6173 743d 5472 7565 2c0a  drop_last=True,.
-00009b60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00009b70: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00009b80: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00009b90: 2020 2020 2020 2066 2254 7261 696e 2074         f"Train t
-00009ba0: 6172 6765 7420 6c61 6265 6c65 6420 6c6f  arget labeled lo
-00009bb0: 6164 6572 2073 697a 6520 6f76 6572 7361  ader size oversa
-00009bc0: 6d70 6c65 2069 7320 7b6c 656e 2874 7261  mple is {len(tra
-00009bd0: 696e 5f74 6172 6765 745f 6c6f 6164 6572  in_target_loader
-00009be0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00009bf0: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
-00009c00: 6174 615f 7472 6169 6e5f 7461 7267 6574  ata_train_target
-00009c10: 5f6c 6162 656c 6564 2e64 6620 3d20 6461  _labeled.df = da
-00009c20: 7461 5f74 7261 696e 5f74 6172 6765 745f  ta_train_target_
-00009c30: 6c61 6265 6c65 642e 6466 5b0a 2020 2020  labeled.df[.    
-00009c40: 2020 2020 2020 2020 2020 2020 5b22 7061              ["pa
-00009c50: 7274 6963 6970 616e 745f 6964 222c 2022  rticipant_id", "
-00009c60: 7365 7373 696f 6e5f 6964 222c 2022 6469  session_id", "di
-00009c70: 6167 6e6f 7369 7322 2c20 2263 6f68 6f72  agnosis", "cohor
-00009c80: 7422 2c20 2264 6f6d 6169 6e22 5d0a 2020  t", "domain"].  
-00009c90: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
-00009ca0: 2020 2020 2020 2020 2074 7261 696e 5f74           train_t
-00009cb0: 6172 6765 745f 756e 6c5f 6c6f 6164 6572  arget_unl_loader
-00009cc0: 203d 2044 6174 614c 6f61 6465 7228 0a20   = DataLoader(. 
-00009cd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009ce0: 6174 615f 7461 7267 6574 5f75 6e6c 6162  ata_target_unlab
-00009cf0: 656c 6564 2c0a 2020 2020 2020 2020 2020  eled,.          
-00009d00: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
-00009d10: 3d73 656c 662e 6261 7463 685f 7369 7a65  =self.batch_size
-00009d20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009d30: 2020 6e75 6d5f 776f 726b 6572 733d 7365    num_workers=se
-00009d40: 6c66 2e6e 5f70 726f 632c 0a20 2020 2020  lf.n_proc,.     
-00009d50: 2020 2020 2020 2020 2020 2023 2073 616d             # sam
-00009d60: 706c 6572 3d75 6e6c 6162 656c 6564 5f73  pler=unlabeled_s
-00009d70: 616d 706c 6572 2c0a 2020 2020 2020 2020  ampler,.        
-00009d80: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
-00009d90: 6e69 745f 666e 3d70 6c5f 776f 726b 6572  nit_fn=pl_worker
-00009da0: 5f69 6e69 745f 6675 6e63 7469 6f6e 2c0a  _init_function,.
-00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009dc0: 7368 7566 666c 653d 5472 7565 2c0a 2020  shuffle=True,.  
-00009dd0: 2020 2020 2020 2020 2020 2020 2020 6472                dr
-00009de0: 6f70 5f6c 6173 743d 5472 7565 2c0a 2020  op_last=True,.  
-00009df0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00009e00: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00009e10: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00009e20: 2020 2020 2020 6622 5472 6169 6e20 7461        f"Train ta
-00009e30: 7267 6574 2075 6e6c 6162 656c 6564 206c  rget unlabeled l
-00009e40: 6f61 6465 7220 7369 7a65 2069 7320 7b6c  oader size is {l
-00009e50: 656e 2874 7261 696e 5f74 6172 6765 745f  en(train_target_
-00009e60: 756e 6c5f 6c6f 6164 6572 292a 7365 6c66  unl_loader)*self
-00009e70: 2e62 6174 6368 5f73 697a 657d 220a 2020  .batch_size}".  
-00009e80: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00009e90: 2020 2020 2020 2020 2076 616c 6964 5f6c           valid_l
-00009ea0: 6f61 6465 725f 736f 7572 6365 203d 2044  oader_source = D
-00009eb0: 6174 614c 6f61 6465 7228 0a20 2020 2020  ataLoader(.     
-00009ec0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00009ed0: 7661 6c69 645f 736f 7572 6365 2c0a 2020  valid_source,.  
-00009ee0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00009ef0: 7463 685f 7369 7a65 3d73 656c 662e 6261  tch_size=self.ba
-00009f00: 7463 685f 7369 7a65 2c0a 2020 2020 2020  tch_size,.      
-00009f10: 2020 2020 2020 2020 2020 7368 7566 666c            shuffl
-00009f20: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-00009f30: 2020 2020 2020 2020 206e 756d 5f77 6f72           num_wor
-00009f40: 6b65 7273 3d73 656c 662e 6e5f 7072 6f63  kers=self.n_proc
-00009f50: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00009f60: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00009f70: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-00009f80: 2020 2020 2020 2020 2066 2256 616c 6964           f"Valid
-00009f90: 6174 696f 6e20 6c6f 6164 6572 2073 6f75  ation loader sou
-00009fa0: 7263 6520 7369 7a65 2069 7320 7b6c 656e  rce size is {len
-00009fb0: 2876 616c 6964 5f6c 6f61 6465 725f 736f  (valid_loader_so
-00009fc0: 7572 6365 292a 7365 6c66 2e62 6174 6368  urce)*self.batch
-00009fd0: 5f73 697a 657d 220a 2020 2020 2020 2020  _size}".        
-00009fe0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00009ff0: 2020 2076 616c 6964 5f6c 6f61 6465 725f     valid_loader_
-0000a000: 7461 7267 6574 203d 2044 6174 614c 6f61  target = DataLoa
-0000a010: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
-0000a020: 2020 2020 2064 6174 615f 7661 6c69 645f       data_valid_
-0000a030: 7461 7267 6574 5f6c 6162 656c 6564 2c0a  target_labeled,.
-0000a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a050: 6261 7463 685f 7369 7a65 3d73 656c 662e  batch_size=self.
-0000a060: 6261 7463 685f 7369 7a65 2c20 2023 2054  batch_size,  # T
-0000a070: 6f20 6368 6563 6b0a 2020 2020 2020 2020  o check.        
-0000a080: 2020 2020 2020 2020 7368 7566 666c 653d          shuffle=
-0000a090: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-0000a0a0: 2020 2020 2020 206e 756d 5f77 6f72 6b65         num_worke
-0000a0b0: 7273 3d73 656c 662e 6e5f 7072 6f63 2c0a  rs=self.n_proc,.
-0000a0c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000a0d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000a0e0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-0000a0f0: 2020 2020 2020 2066 2256 616c 6964 6174         f"Validat
-0000a100: 696f 6e20 6c6f 6164 6572 2074 6172 6765  ion loader targe
-0000a110: 7420 7369 7a65 2069 7320 7b6c 656e 2876  t size is {len(v
-0000a120: 616c 6964 5f6c 6f61 6465 725f 7461 7267  alid_loader_targ
-0000a130: 6574 292a 7365 6c66 2e62 6174 6368 5f73  et)*self.batch_s
-0000a140: 697a 657d 220a 2020 2020 2020 2020 2020  ize}".          
-0000a150: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0000a160: 2073 656c 662e 5f74 7261 696e 5f73 7364   self._train_ssd
-0000a170: 616e 6e28 0a20 2020 2020 2020 2020 2020  ann(.           
-0000a180: 2020 2020 2074 7261 696e 5f73 6f75 7263       train_sourc
-0000a190: 655f 6c6f 6164 6572 2c0a 2020 2020 2020  e_loader,.      
-0000a1a0: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-0000a1b0: 7461 7267 6574 5f6c 6f61 6465 722c 0a20  target_loader,. 
-0000a1c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000a1d0: 7261 696e 5f74 6172 6765 745f 756e 6c5f  rain_target_unl_
-0000a1e0: 6c6f 6164 6572 2c0a 2020 2020 2020 2020  loader,.        
-0000a1f0: 2020 2020 2020 2020 7661 6c69 645f 6c6f          valid_lo
-0000a200: 6164 6572 5f74 6172 6765 742c 0a20 2020  ader_target,.   
-0000a210: 2020 2020 2020 2020 2020 2020 2076 616c               val
-0000a220: 6964 5f6c 6f61 6465 725f 736f 7572 6365  id_loader_source
-0000a230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a240: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
-0000a250: 2020 2020 2020 2020 2072 6573 756d 653d           resume=
-0000a260: 7265 7375 6d65 2c0a 2020 2020 2020 2020  resume,.        
-0000a270: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000a280: 2020 2073 656c 662e 5f65 6e73 656d 626c     self._ensembl
-0000a290: 655f 7072 6564 6963 7469 6f6e 280a 2020  e_prediction(.  
-0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0000a2b0: 7261 696e 222c 0a20 2020 2020 2020 2020  rain",.         
-0000a2c0: 2020 2020 2020 2073 706c 6974 2c0a 2020         split,.  
-0000a2d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000a2e0: 6c66 2e73 656c 6563 7469 6f6e 5f6d 6574  lf.selection_met
-0000a2f0: 7269 6373 2c0a 2020 2020 2020 2020 2020  rics,.          
-0000a300: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000a310: 7365 6c66 2e5f 656e 7365 6d62 6c65 5f70  self._ensemble_p
-0000a320: 7265 6469 6374 696f 6e28 0a20 2020 2020  rediction(.     
-0000a330: 2020 2020 2020 2020 2020 2022 7661 6c69             "vali
-0000a340: 6461 7469 6f6e 222c 0a20 2020 2020 2020  dation",.       
-0000a350: 2020 2020 2020 2020 2073 706c 6974 2c0a           split,.
-0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a370: 7365 6c66 2e73 656c 6563 7469 6f6e 5f6d  self.selection_m
-0000a380: 6574 7269 6373 2c0a 2020 2020 2020 2020  etrics,.        
-0000a390: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000a3a0: 2020 2073 656c 662e 5f65 7261 7365 5f74     self._erase_t
-0000a3b0: 6d70 2873 706c 6974 290a 0a20 2020 2064  mp(split)..    d
-0000a3c0: 6566 205f 7472 6169 6e28 0a20 2020 2020  ef _train(.     
-0000a3d0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0000a3e0: 2074 7261 696e 5f6c 6f61 6465 722c 0a20   train_loader,. 
-0000a3f0: 2020 2020 2020 2076 616c 6964 5f6c 6f61         valid_loa
-0000a400: 6465 722c 0a20 2020 2020 2020 2073 706c  der,.        spl
-0000a410: 6974 2c0a 2020 2020 2020 2020 6e65 7477  it,.        netw
-0000a420: 6f72 6b3d 4e6f 6e65 2c0a 2020 2020 2020  ork=None,.      
-0000a430: 2020 7265 7375 6d65 3d46 616c 7365 2c0a    resume=False,.
-0000a440: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
-0000a450: 733d 5b5d 2c0a 2020 2020 293a 0a20 2020  s=[],.    ):.   
-0000a460: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000a470: 2043 6f72 6520 6675 6e63 7469 6f6e 2073   Core function s
-0000a480: 6861 7265 6420 6279 2074 7261 696e 2061  hared by train a
-0000a490: 6e64 2072 6573 756d 652e 0a0a 2020 2020  nd resume...    
-0000a4a0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000a4b0: 2020 2020 2020 7472 6169 6e5f 6c6f 6164        train_load
-0000a4c0: 6572 2028 746f 7263 682e 7574 696c 732e  er (torch.utils.
-0000a4d0: 6461 7461 2e44 6174 614c 6f61 6465 7229  data.DataLoader)
-0000a4e0: 3a20 4461 7461 4c6f 6164 6572 2077 7261  : DataLoader wra
-0000a4f0: 7070 696e 6720 7468 6520 7472 6169 6e69  pping the traini
-0000a500: 6e67 2073 6574 2e0a 2020 2020 2020 2020  ng set..        
-0000a510: 2020 2020 7661 6c69 645f 6c6f 6164 6572      valid_loader
-0000a520: 2028 746f 7263 682e 7574 696c 732e 6461   (torch.utils.da
-0000a530: 7461 2e44 6174 614c 6f61 6465 7229 3a20  ta.DataLoader): 
-0000a540: 4461 7461 4c6f 6164 6572 2077 7261 7070  DataLoader wrapp
-0000a550: 696e 6720 7468 6520 7661 6c69 6461 7469  ing the validati
-0000a560: 6f6e 2073 6574 2e0a 2020 2020 2020 2020  on set..        
-0000a570: 2020 2020 7370 6c69 7420 2869 6e74 293a      split (int):
-0000a580: 2049 6e64 6578 206f 6620 7468 6520 7370   Index of the sp
-0000a590: 6c69 7420 7472 6169 6e65 642e 0a20 2020  lit trained..   
-0000a5a0: 2020 2020 2020 2020 206e 6574 776f 726b           network
-0000a5b0: 2028 696e 7429 3a20 496e 6465 7820 6f66   (int): Index of
-0000a5c0: 2074 6865 206e 6574 776f 726b 2074 7261   the network tra
-0000a5d0: 696e 6564 2028 7573 6564 2069 6e20 6d75  ined (used in mu
-0000a5e0: 6c74 692d 6e65 7477 6f72 6b20 7365 7474  lti-network sett
-0000a5f0: 696e 6720 6f6e 6c79 292e 0a20 2020 2020  ing only)..     
-0000a600: 2020 2020 2020 2072 6573 756d 6520 2862         resume (b
-0000a610: 6f6f 6c29 3a20 4966 2054 7275 6520 7468  ool): If True th
-0000a620: 6520 6a6f 6220 6973 2072 6573 756d 6564  e job is resumed
-0000a630: 2066 726f 6d20 7468 6520 6368 6563 6b70   from the checkp
-0000a640: 6f69 6e74 2e0a 2020 2020 2020 2020 2222  oint..        ""
-0000a650: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
-0000a660: 696e 6974 5f63 616c 6c62 6163 6b73 2829  init_callbacks()
-0000a670: 0a20 2020 2020 2020 206d 6f64 656c 2c20  .        model, 
-0000a680: 6265 6769 6e6e 696e 675f 6570 6f63 6820  beginning_epoch 
-0000a690: 3d20 7365 6c66 2e5f 696e 6974 5f6d 6f64  = self._init_mod
-0000a6a0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-0000a6b0: 7370 6c69 743d 7370 6c69 742c 0a20 2020  split=split,.   
-0000a6c0: 2020 2020 2020 2020 2072 6573 756d 653d           resume=
-0000a6d0: 7265 7375 6d65 2c0a 2020 2020 2020 2020  resume,.        
-0000a6e0: 2020 2020 7472 616e 7366 6572 5f70 6174      transfer_pat
-0000a6f0: 683d 7365 6c66 2e74 7261 6e73 6665 725f  h=self.transfer_
-0000a700: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000a710: 2020 7472 616e 7366 6572 5f73 656c 6563    transfer_selec
-0000a720: 7469 6f6e 3d73 656c 662e 7472 616e 7366  tion=self.transf
-0000a730: 6572 5f73 656c 6563 7469 6f6e 5f6d 6574  er_selection_met
-0000a740: 7269 632c 0a20 2020 2020 2020 2020 2020  ric,.           
-0000a750: 206e 625f 756e 6672 6f7a 656e 5f6c 6179   nb_unfrozen_lay
-0000a760: 6572 3d73 656c 662e 6e62 5f75 6e66 726f  er=self.nb_unfro
-0000a770: 7a65 6e5f 6c61 7965 722c 0a20 2020 2020  zen_layer,.     
-0000a780: 2020 2029 0a20 2020 2020 2020 206d 6f64     ).        mod
-0000a790: 656c 203d 2044 4450 286d 6f64 656c 290a  el = DDP(model).
-0000a7a0: 2020 2020 2020 2020 6372 6974 6572 696f          criterio
-0000a7b0: 6e20 3d20 7365 6c66 2e74 6173 6b5f 6d61  n = self.task_ma
-0000a7c0: 6e61 6765 722e 6765 745f 6372 6974 6572  nager.get_criter
-0000a7d0: 696f 6e28 7365 6c66 2e6c 6f73 7329 0a0a  ion(self.loss)..
-0000a7e0: 2020 2020 2020 2020 6f70 7469 6d69 7a65          optimize
-0000a7f0: 7220 3d20 7365 6c66 2e5f 696e 6974 5f6f  r = self._init_o
-0000a800: 7074 696d 697a 6572 286d 6f64 656c 2c20  ptimizer(model, 
-0000a810: 7370 6c69 743d 7370 6c69 742c 2072 6573  split=split, res
-0000a820: 756d 653d 7265 7375 6d65 290a 2020 2020  ume=resume).    
-0000a830: 2020 2020 7365 6c66 2e63 616c 6c62 6163      self.callbac
-0000a840: 6b5f 6861 6e64 6c65 722e 6f6e 5f74 7261  k_handler.on_tra
-0000a850: 696e 5f62 6567 696e 280a 2020 2020 2020  in_begin(.      
-0000a860: 2020 2020 2020 7365 6c66 2e70 6172 616d        self.param
-0000a870: 6574 6572 732c 0a20 2020 2020 2020 2020  eters,.         
-0000a880: 2020 2063 7269 7465 7269 6f6e 3d63 7269     criterion=cri
-0000a890: 7465 7269 6f6e 2c0a 2020 2020 2020 2020  terion,.        
-0000a8a0: 2020 2020 6f70 7469 6d69 7a65 723d 6f70      optimizer=op
-0000a8b0: 7469 6d69 7a65 722c 0a20 2020 2020 2020  timizer,.       
-0000a8c0: 2020 2020 2073 706c 6974 3d73 706c 6974       split=split
-0000a8d0: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
-0000a8e0: 7073 5f70 6174 683d 7365 6c66 2e6d 6170  ps_path=self.map
-0000a8f0: 735f 7061 7468 2c0a 2020 2020 2020 2020  s_path,.        
-0000a900: 290a 0a20 2020 2020 2020 206d 6f64 656c  )..        model
-0000a910: 2e74 7261 696e 2829 0a20 2020 2020 2020  .train().       
-0000a920: 2074 7261 696e 5f6c 6f61 6465 722e 6461   train_loader.da
-0000a930: 7461 7365 742e 7472 6169 6e28 290a 0a20  taset.train().. 
-0000a940: 2020 2020 2020 2065 6172 6c79 5f73 746f         early_sto
-0000a950: 7070 696e 6720 3d20 4561 726c 7953 746f  pping = EarlySto
-0000a960: 7070 696e 6728 0a20 2020 2020 2020 2020  pping(.         
-0000a970: 2020 2022 6d69 6e22 2c20 6d69 6e5f 6465     "min", min_de
-0000a980: 6c74 613d 7365 6c66 2e74 6f6c 6572 616e  lta=self.toleran
-0000a990: 6365 2c20 7061 7469 656e 6365 3d73 656c  ce, patience=sel
-0000a9a0: 662e 7061 7469 656e 6365 0a20 2020 2020  f.patience.     
-0000a9b0: 2020 2029 0a20 2020 2020 2020 206d 6574     ).        met
-0000a9c0: 7269 6373 5f76 616c 6964 203d 207b 226c  rics_valid = {"l
-0000a9d0: 6f73 7322 3a20 4e6f 6e65 7d0a 0a20 2020  oss": None}..   
-0000a9e0: 2020 2020 2069 6620 636c 7573 7465 722e       if cluster.
-0000a9f0: 6d61 7374 6572 3a0a 2020 2020 2020 2020  master:.        
-0000aa00: 2020 2020 6c6f 675f 7772 6974 6572 203d      log_writer =
-0000aa10: 204c 6f67 5772 6974 6572 280a 2020 2020   LogWriter(.    
-0000aa20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000aa30: 2e6d 6170 735f 7061 7468 2c0a 2020 2020  .maps_path,.    
-0000aa40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000aa50: 2e74 6173 6b5f 6d61 6e61 6765 722e 6576  .task_manager.ev
-0000aa60: 616c 7561 7469 6f6e 5f6d 6574 7269 6373  aluation_metrics
-0000aa70: 202b 205b 226c 6f73 7322 5d2c 0a20 2020   + ["loss"],.   
-0000aa80: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-0000aa90: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-0000aaa0: 2020 2020 7265 7375 6d65 3d72 6573 756d      resume=resum
-0000aab0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000aac0: 2020 2062 6567 696e 6e69 6e67 5f65 706f     beginning_epo
-0000aad0: 6368 3d62 6567 696e 6e69 6e67 5f65 706f  ch=beginning_epo
-0000aae0: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
-0000aaf0: 2020 2020 6e65 7477 6f72 6b3d 6e65 7477      network=netw
-0000ab00: 6f72 6b2c 0a20 2020 2020 2020 2020 2020  ork,.           
-0000ab10: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
-0000ab20: 6574 6169 6e5f 6265 7374 203d 2052 6574  etain_best = Ret
-0000ab30: 6169 6e42 6573 7428 7365 6c65 6374 696f  ainBest(selectio
-0000ab40: 6e5f 6d65 7472 6963 733d 6c69 7374 2873  n_metrics=list(s
-0000ab50: 656c 662e 7365 6c65 6374 696f 6e5f 6d65  elf.selection_me
-0000ab60: 7472 6963 7329 290a 2020 2020 2020 2020  trics)).        
-0000ab70: 6570 6f63 6820 3d20 6265 6769 6e6e 696e  epoch = beginnin
-0000ab80: 675f 6570 6f63 680a 0a20 2020 2020 2020  g_epoch..       
-0000ab90: 2072 6574 6169 6e5f 6265 7374 203d 2052   retain_best = R
-0000aba0: 6574 6169 6e42 6573 7428 7365 6c65 6374  etainBest(select
-0000abb0: 696f 6e5f 6d65 7472 6963 733d 6c69 7374  ion_metrics=list
-0000abc0: 2873 656c 662e 7365 6c65 6374 696f 6e5f  (self.selection_
-0000abd0: 6d65 7472 6963 7329 290a 0a20 2020 2020  metrics))..     
-0000abe0: 2020 2069 6620 7365 6c66 2e70 6172 616d     if self.param
-0000abf0: 6574 6572 735b 2261 6461 7074 6976 655f  eters["adaptive_
-0000ac00: 6c65 6172 6e69 6e67 5f72 6174 6522 5d3a  learning_rate"]:
-0000ac10: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-0000ac20: 6d20 746f 7263 682e 6f70 7469 6d2e 6c72  m torch.optim.lr
-0000ac30: 5f73 6368 6564 756c 6572 2069 6d70 6f72  _scheduler impor
-0000ac40: 7420 5265 6475 6365 4c52 4f6e 506c 6174  t ReduceLROnPlat
-0000ac50: 6561 750a 0a20 2020 2020 2020 2020 2020  eau..           
-0000ac60: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
-0000ac70: 6520 5265 6475 6365 4c52 4f6e 506c 6174  e ReduceLROnPlat
-0000ac80: 6561 7520 7363 6865 6475 6c65 720a 2020  eau scheduler.  
-0000ac90: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
-0000aca0: 6c65 7220 3d20 5265 6475 6365 4c52 4f6e  ler = ReduceLROn
-0000acb0: 506c 6174 6561 7528 0a20 2020 2020 2020  Plateau(.       
-0000acc0: 2020 2020 2020 2020 206f 7074 696d 697a           optimiz
-0000acd0: 6572 2c20 6d6f 6465 3d22 6d69 6e22 2c20  er, mode="min", 
-0000ace0: 6661 6374 6f72 3d30 2e31 2c20 7665 7262  factor=0.1, verb
-0000acf0: 6f73 653d 5472 7565 0a20 2020 2020 2020  ose=True.       
-0000ad00: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000ad10: 7363 616c 6572 203d 2047 7261 6453 6361  scaler = GradSca
-0000ad20: 6c65 7228 656e 6162 6c65 643d 7365 6c66  ler(enabled=self
-0000ad30: 2e61 6d70 290a 2020 2020 2020 2020 7072  .amp).        pr
-0000ad40: 6f66 696c 6572 203d 2073 656c 662e 5f69  ofiler = self._i
-0000ad50: 6e69 745f 7072 6f66 696c 6572 2829 0a0a  nit_profiler()..
-0000ad60: 2020 2020 2020 2020 7768 696c 6520 6570          while ep
-0000ad70: 6f63 6820 3c20 7365 6c66 2e65 706f 6368  och < self.epoch
-0000ad80: 7320 616e 6420 6e6f 7420 6561 726c 795f  s and not early_
-0000ad90: 7374 6f70 7069 6e67 2e73 7465 7028 6d65  stopping.step(me
-0000ada0: 7472 6963 735f 7661 6c69 645b 226c 6f73  trics_valid["los
-0000adb0: 7322 5d29 3a0a 2020 2020 2020 2020 2020  s"]):.          
-0000adc0: 2020 2320 7365 6c66 2e63 616c 6c62 6163    # self.callbac
-0000add0: 6b5f 6861 6e64 6c65 722e 6f6e 5f65 706f  k_handler.on_epo
-0000ade0: 6368 5f62 6567 696e 2873 656c 662e 7061  ch_begin(self.pa
-0000adf0: 7261 6d65 7465 7273 2c20 6570 6f63 6820  rameters, epoch 
-0000ae00: 3d20 6570 6f63 6829 0a0a 2020 2020 2020  = epoch)..      
-0000ae10: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000ae20: 6e63 6528 7472 6169 6e5f 6c6f 6164 6572  nce(train_loader
-0000ae30: 2e73 616d 706c 6572 2c20 4469 7374 7269  .sampler, Distri
-0000ae40: 6275 7465 6453 616d 706c 6572 293a 0a20  butedSampler):. 
-0000ae50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000ae60: 2049 7420 7368 6f75 6c64 2061 6c77 6179   It should alway
-0000ae70: 7320 6265 2074 7275 6520 666f 7220 6120  s be true for a 
-0000ae80: 7261 6e64 6f6d 2073 616d 706c 6572 2e20  random sampler. 
-0000ae90: 4275 7420 6a75 7374 2069 6e20 6361 7365  But just in case
-0000aea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aeb0: 2023 2077 6520 6765 7420 6120 5765 6967   # we get a Weig
-0000aec0: 6874 6564 5261 6e64 6f6d 5361 6d70 6c65  htedRandomSample
-0000aed0: 7220 6f72 2061 2066 6f72 676f 7474 656e  r or a forgotten
-0000aee0: 2052 616e 646f 6d53 616d 706c 6572 2c0a   RandomSampler,.
-0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af00: 2320 7765 2064 6f20 6e6f 7420 7761 6e74  # we do not want
-0000af10: 2074 6f20 6578 6563 7574 6520 7468 6973   to execute this
-0000af20: 206c 696e 652e 0a20 2020 2020 2020 2020   line..         
-0000af30: 2020 2020 2020 2074 7261 696e 5f6c 6f61         train_loa
-0000af40: 6465 722e 7361 6d70 6c65 722e 7365 745f  der.sampler.set_
-0000af50: 6570 6f63 6828 6570 6f63 6829 0a0a 2020  epoch(epoch)..  
-0000af60: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
-0000af70: 7a65 726f 5f67 7261 6428 7365 745f 746f  zero_grad(set_to
-0000af80: 5f6e 6f6e 653d 5472 7565 290a 2020 2020  _none=True).    
-0000af90: 2020 2020 2020 2020 6576 616c 7561 7469          evaluati
-0000afa0: 6f6e 5f66 6c61 672c 2073 7465 705f 666c  on_flag, step_fl
-0000afb0: 6167 203d 2054 7275 652c 2054 7275 650a  ag = True, True.
-0000afc0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0000afd0: 6820 7072 6f66 696c 6572 3a0a 2020 2020  h profiler:.    
-0000afe0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000aff0: 692c 2064 6174 6120 696e 2065 6e75 6d65  i, data in enume
-0000b000: 7261 7465 2874 7261 696e 5f6c 6f61 6465  rate(train_loade
-0000b010: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000b020: 2020 2020 2020 2020 7570 6461 7465 3a20          update: 
-0000b030: 626f 6f6c 203d 2028 6920 2b20 3129 2025  bool = (i + 1) %
-0000b040: 2073 656c 662e 6163 6375 6d75 6c61 7469   self.accumulati
-0000b050: 6f6e 5f73 7465 7073 203d 3d20 300a 2020  on_steps == 0.  
-0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b070: 2020 7379 6e63 203d 206e 756c 6c63 6f6e    sync = nullcon
-0000b080: 7465 7874 2829 2069 6620 7570 6461 7465  text() if update
-0000b090: 2065 6c73 6520 6d6f 6465 6c2e 6e6f 5f73   else model.no_s
-0000b0a0: 796e 6328 290a 2020 2020 2020 2020 2020  ync().          
-0000b0b0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-0000b0c0: 796e 633a 0a20 2020 2020 2020 2020 2020  ync:.           
-0000b0d0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
-0000b0e0: 6820 6175 746f 6361 7374 2865 6e61 626c  h autocast(enabl
-0000b0f0: 6564 3d73 656c 662e 616d 7029 3a0a 2020  ed=self.amp):.  
-0000b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b110: 2020 2020 2020 2020 2020 5f2c 206c 6f73            _, los
-0000b120: 735f 6469 6374 203d 206d 6f64 656c 2864  s_dict = model(d
-0000b130: 6174 612c 2063 7269 7465 7269 6f6e 290a  ata, criterion).
-0000b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b150: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-0000b160: 6562 7567 2866 2254 7261 696e 206c 6f73  ebug(f"Train los
-0000b170: 7320 6469 6374 696f 6e6e 6172 7920 7b6c  s dictionnary {l
-0000b180: 6f73 735f 6469 6374 7d22 290a 2020 2020  oss_dict}").    
-0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1a0: 2020 2020 6c6f 7373 203d 206c 6f73 735f      loss = loss_
-0000b1b0: 6469 6374 5b22 6c6f 7373 225d 0a20 2020  dict["loss"].   
-0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1d0: 2020 2020 2073 6361 6c65 722e 7363 616c       scaler.scal
-0000b1e0: 6528 6c6f 7373 292e 6261 636b 7761 7264  e(loss).backward
-0000b1f0: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-0000b200: 2020 2020 2020 2020 6966 2075 7064 6174          if updat
-0000b210: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000b220: 2020 2020 2020 2020 2020 2073 7465 705f             step_
-0000b230: 666c 6167 203d 2046 616c 7365 0a20 2020  flag = False.   
-0000b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b250: 2020 2020 2073 6361 6c65 722e 7374 6570       scaler.step
-0000b260: 286f 7074 696d 697a 6572 290a 2020 2020  (optimizer).    
-0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b280: 2020 2020 7363 616c 6572 2e75 7064 6174      scaler.updat
-0000b290: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0000b2a0: 2020 2020 2020 2020 2020 2020 6f70 7469              opti
-0000b2b0: 6d69 7a65 722e 7a65 726f 5f67 7261 6428  mizer.zero_grad(
-0000b2c0: 7365 745f 746f 5f6e 6f6e 653d 5472 7565  set_to_none=True
-0000b2d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000b2e0: 2020 2020 2020 2020 2020 2064 656c 206c             del l
-0000b2f0: 6f73 730a 0a20 2020 2020 2020 2020 2020  oss..           
-0000b300: 2020 2020 2020 2020 2020 2020 2023 2045               # E
-0000b310: 7661 6c75 6174 6520 7468 6520 6d6f 6465  valuate the mode
-0000b320: 6c20 6f6e 6c79 2077 6865 6e20 6e6f 2067  l only when no g
-0000b330: 7261 6469 656e 7473 2061 7265 2061 6363  radients are acc
-0000b340: 756d 756c 6174 6564 0a20 2020 2020 2020  umulated.       
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-0000b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b380: 2020 7365 6c66 2e65 7661 6c75 6174 696f    self.evaluatio
-0000b390: 6e5f 7374 6570 7320 213d 2030 0a20 2020  n_steps != 0.   
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 2020 2020 2020 2061 6e64 2028 6920           and (i 
-0000b3c0: 2b20 3129 2025 2073 656c 662e 6576 616c  + 1) % self.eval
-0000b3d0: 7561 7469 6f6e 5f73 7465 7073 203d 3d20  uation_steps == 
-0000b3e0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0000b3f0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
-0000b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b410: 2020 2020 2020 2020 2065 7661 6c75 6174           evaluat
-0000b420: 696f 6e5f 666c 6167 203d 2046 616c 7365  ion_flag = False
-0000b430: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000b440: 2020 2020 2020 2020 2020 2020 2020 5f2c                _,
-0000b450: 206d 6574 7269 6373 5f74 7261 696e 203d   metrics_train =
-0000b460: 2073 656c 662e 7461 736b 5f6d 616e 6167   self.task_manag
-0000b470: 6572 2e74 6573 7428 0a20 2020 2020 2020  er.test(.       
-0000b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b490: 2020 2020 2020 2020 206d 6f64 656c 2c20           model, 
-0000b4a0: 7472 6169 6e5f 6c6f 6164 6572 2c20 6372  train_loader, cr
-0000b4b0: 6974 6572 696f 6e2c 2061 6d70 3d73 656c  iterion, amp=sel
-0000b4c0: 662e 616d 700a 2020 2020 2020 2020 2020  f.amp.          
-0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b500: 5f2c 206d 6574 7269 6373 5f76 616c 6964  _, metrics_valid
-0000b510: 203d 2073 656c 662e 7461 736b 5f6d 616e   = self.task_man
-0000b520: 6167 6572 2e74 6573 7428 0a20 2020 2020  ager.test(.     
-0000b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b540: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0000b550: 2c20 7661 6c69 645f 6c6f 6164 6572 2c20  , valid_loader, 
-0000b560: 6372 6974 6572 696f 6e2c 2061 6d70 3d73  criterion, amp=s
-0000b570: 656c 662e 616d 700a 2020 2020 2020 2020  elf.amp.        
-0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b590: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00008070: 2073 6875 6666 6c65 3d46 616c 7365 2c0a   shuffle=False,.
+00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008090: 2020 2020 6e75 6d5f 776f 726b 6572 733d      num_workers=
+000080a0: 7365 6c66 2e6e 5f70 726f 632c 0a20 2020  self.n_proc,.   
+000080b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080c0: 2073 616d 706c 6572 3d76 616c 6964 5f73   sampler=valid_s
+000080d0: 616d 706c 6572 2c0a 2020 2020 2020 2020  ampler,.        
+000080e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000080f0: 2020 2020 2020 2020 2020 6672 6f6d 2063            from c
+00008100: 6c69 6e69 6361 646c 2e75 7469 6c73 2e63  linicadl.utils.c
+00008110: 616c 6c62 6163 6b73 2e63 616c 6c62 6163  allbacks.callbac
+00008120: 6b73 2069 6d70 6f72 7420 436f 6465 4361  ks import CodeCa
+00008130: 7262 6f6e 5472 6163 6b65 720a 0a20 2020  rbonTracker..   
+00008140: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00008150: 662e 5f74 7261 696e 280a 2020 2020 2020  f._train(.      
+00008160: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00008170: 6169 6e5f 6c6f 6164 6572 2c0a 2020 2020  ain_loader,.    
+00008180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008190: 7661 6c69 645f 6c6f 6164 6572 2c0a 2020  valid_loader,.  
+000081a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081b0: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
+000081c0: 2020 2020 2020 2020 2020 2020 206e 6574               net
+000081d0: 776f 726b 2c0a 2020 2020 2020 2020 2020  work,.          
+000081e0: 2020 2020 2020 2020 2020 7265 7375 6d65            resume
+000081f0: 3d72 6573 756d 652c 0a20 2020 2020 2020  =resume,.       
+00008200: 2020 2020 2020 2020 2020 2020 2063 616c               cal
+00008210: 6c62 6163 6b73 3d5b 436f 6465 4361 7262  lbacks=[CodeCarb
+00008220: 6f6e 5472 6163 6b65 725d 2c0a 2020 2020  onTracker],.    
+00008230: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00008240: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00008250: 7375 6d65 203d 2046 616c 7365 0a0a 2020  sume = False..  
+00008260: 2020 2020 2020 2020 2020 6966 2063 6c75            if clu
+00008270: 7374 6572 2e6d 6173 7465 723a 0a20 2020  ster.master:.   
+00008280: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00008290: 662e 5f65 6e73 656d 626c 655f 7072 6564  f._ensemble_pred
+000082a0: 6963 7469 6f6e 280a 2020 2020 2020 2020  iction(.        
+000082b0: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+000082c0: 696e 222c 0a20 2020 2020 2020 2020 2020  in",.           
+000082d0: 2020 2020 2020 2020 2073 706c 6974 2c0a           split,.
+000082e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082f0: 2020 2020 7365 6c66 2e73 656c 6563 7469      self.selecti
+00008300: 6f6e 5f6d 6574 7269 6373 2c0a 2020 2020  on_metrics,.    
+00008310: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00008320: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008330: 6c66 2e5f 656e 7365 6d62 6c65 5f70 7265  lf._ensemble_pre
+00008340: 6469 6374 696f 6e28 0a20 2020 2020 2020  diction(.       
+00008350: 2020 2020 2020 2020 2020 2020 2022 7661               "va
+00008360: 6c69 6461 7469 6f6e 222c 0a20 2020 2020  lidation",.     
+00008370: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008380: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+00008390: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+000083a0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+000083b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000083c0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000083d0: 2020 2020 2073 656c 662e 5f65 7261 7365       self._erase
+000083e0: 5f74 6d70 2873 706c 6974 290a 0a20 2020  _tmp(split)..   
+000083f0: 2064 6566 205f 7472 6169 6e5f 7373 6461   def _train_ssda
+00008400: 2873 656c 662c 2073 706c 6974 5f6c 6973  (self, split_lis
+00008410: 743d 4e6f 6e65 2c20 7265 7375 6d65 3d46  t=None, resume=F
+00008420: 616c 7365 293a 0a20 2020 2020 2020 2022  alse):.        "
+00008430: 2222 0a20 2020 2020 2020 2054 7261 696e  "".        Train
+00008440: 7320 6120 7369 6e67 6c65 2043 4e4e 2066  s a single CNN f
+00008450: 6f72 2061 2073 6f75 7263 6520 616e 6420  or a source and 
+00008460: 7461 7267 6574 2064 6f6d 6169 6e20 7573  target domain us
+00008470: 696e 6720 7365 6d69 2d73 7570 6572 7669  ing semi-supervi
+00008480: 7365 6420 646f 6d61 696e 2061 6461 7074  sed domain adapt
+00008490: 6174 696f 6e2e 0a0a 2020 2020 2020 2020  ation...        
+000084a0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+000084b0: 2020 7370 6c69 745f 6c69 7374 2028 6c69    split_list (li
+000084c0: 7374 5b69 6e74 5d29 3a20 6c69 7374 206f  st[int]): list o
+000084d0: 6620 7370 6c69 7473 2074 6861 7420 6172  f splits that ar
+000084e0: 6520 7472 6169 6e65 642e 0a20 2020 2020  e trained..     
+000084f0: 2020 2020 2020 2072 6573 756d 6520 2862         resume (b
+00008500: 6f6f 6c29 3a20 4966 2054 7275 6520 7468  ool): If True th
+00008510: 6520 6a6f 6220 6973 2072 6573 756d 6564  e job is resumed
+00008520: 2066 726f 6d20 6368 6563 6b70 6f69 6e74   from checkpoint
+00008530: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00008540: 2020 2020 2020 6672 6f6d 2074 6f72 6368        from torch
+00008550: 2e75 7469 6c73 2e64 6174 6120 696d 706f  .utils.data impo
+00008560: 7274 2044 6174 614c 6f61 6465 720a 0a20  rt DataLoader.. 
+00008570: 2020 2020 2020 2074 7261 696e 5f74 7261         train_tra
+00008580: 6e73 666f 726d 732c 2061 6c6c 5f74 7261  nsforms, all_tra
+00008590: 6e73 666f 726d 7320 3d20 6765 745f 7472  nsforms = get_tr
+000085a0: 616e 7366 6f72 6d73 280a 2020 2020 2020  ansforms(.      
+000085b0: 2020 2020 2020 6e6f 726d 616c 697a 653d        normalize=
+000085c0: 7365 6c66 2e6e 6f72 6d61 6c69 7a65 2c0a  self.normalize,.
+000085d0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000085e0: 5f61 7567 6d65 6e74 6174 696f 6e3d 7365  _augmentation=se
+000085f0: 6c66 2e64 6174 615f 6175 676d 656e 7461  lf.data_augmenta
+00008600: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00008610: 2020 7369 7a65 5f72 6564 7563 7469 6f6e    size_reduction
+00008620: 3d73 656c 662e 7369 7a65 5f72 6564 7563  =self.size_reduc
+00008630: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00008640: 2020 7369 7a65 5f72 6564 7563 7469 6f6e    size_reduction
+00008650: 5f66 6163 746f 723d 7365 6c66 2e73 697a  _factor=self.siz
+00008660: 655f 7265 6475 6374 696f 6e5f 6661 6374  e_reduction_fact
+00008670: 6f72 2c0a 2020 2020 2020 2020 290a 0a20  or,.        ).. 
+00008680: 2020 2020 2020 2073 706c 6974 5f6d 616e         split_man
+00008690: 6167 6572 203d 2073 656c 662e 5f69 6e69  ager = self._ini
+000086a0: 745f 7370 6c69 745f 6d61 6e61 6765 7228  t_split_manager(
+000086b0: 7370 6c69 745f 6c69 7374 290a 2020 2020  split_list).    
+000086c0: 2020 2020 7370 6c69 745f 6d61 6e61 6765      split_manage
+000086d0: 725f 7461 7267 6574 5f6c 6162 203d 2073  r_target_lab = s
+000086e0: 656c 662e 5f69 6e69 745f 7370 6c69 745f  elf._init_split_
+000086f0: 6d61 6e61 6765 7228 7370 6c69 745f 6c69  manager(split_li
+00008700: 7374 2c20 5472 7565 290a 0a20 2020 2020  st, True)..     
+00008710: 2020 2066 6f72 2073 706c 6974 2069 6e20     for split in 
+00008720: 7370 6c69 745f 6d61 6e61 6765 722e 7370  split_manager.sp
+00008730: 6c69 745f 6974 6572 6174 6f72 2829 3a0a  lit_iterator():.
+00008740: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00008750: 6572 2e69 6e66 6f28 6622 5472 6169 6e69  er.info(f"Traini
+00008760: 6e67 2073 706c 6974 207b 7370 6c69 747d  ng split {split}
+00008770: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
+00008780: 6565 645f 6576 6572 7974 6869 6e67 2873  eed_everything(s
+00008790: 656c 662e 7365 6564 2c20 7365 6c66 2e64  elf.seed, self.d
+000087a0: 6574 6572 6d69 6e69 7374 6963 2c20 7365  eterministic, se
+000087b0: 6c66 2e63 6f6d 7065 6e73 6174 696f 6e29  lf.compensation)
+000087c0: 0a0a 2020 2020 2020 2020 2020 2020 7370  ..            sp
+000087d0: 6c69 745f 6466 5f64 6963 7420 3d20 7370  lit_df_dict = sp
+000087e0: 6c69 745f 6d61 6e61 6765 725b 7370 6c69  lit_manager[spli
+000087f0: 745d 0a20 2020 2020 2020 2020 2020 2073  t].            s
+00008800: 706c 6974 5f64 665f 6469 6374 5f74 6172  plit_df_dict_tar
+00008810: 6765 745f 6c61 6220 3d20 7370 6c69 745f  get_lab = split_
+00008820: 6d61 6e61 6765 725f 7461 7267 6574 5f6c  manager_target_l
+00008830: 6162 5b73 706c 6974 5d0a 0a20 2020 2020  ab[split]..     
+00008840: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00008850: 6275 6728 224c 6f61 6469 6e67 2073 6f75  bug("Loading sou
+00008860: 7263 6520 7472 6169 6e69 6e67 2064 6174  rce training dat
+00008870: 612e 2e2e 2229 0a20 2020 2020 2020 2020  a...").         
+00008880: 2020 2064 6174 615f 7472 6169 6e5f 736f     data_train_so
+00008890: 7572 6365 203d 2072 6574 7572 6e5f 6461  urce = return_da
+000088a0: 7461 7365 7428 0a20 2020 2020 2020 2020  taset(.         
+000088b0: 2020 2020 2020 2073 656c 662e 6361 7073         self.caps
+000088c0: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
+000088d0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+000088e0: 745f 6466 5f64 6963 745b 2274 7261 696e  t_df_dict["train
+000088f0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00008900: 2020 2020 7365 6c66 2e70 7265 7072 6f63      self.preproc
+00008910: 6573 7369 6e67 5f64 6963 742c 0a20 2020  essing_dict,.   
+00008920: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+00008930: 696e 5f74 7261 6e73 666f 726d 6174 696f  in_transformatio
+00008940: 6e73 3d74 7261 696e 5f74 7261 6e73 666f  ns=train_transfo
+00008950: 726d 732c 0a20 2020 2020 2020 2020 2020  rms,.           
+00008960: 2020 2020 2061 6c6c 5f74 7261 6e73 666f       all_transfo
+00008970: 726d 6174 696f 6e73 3d61 6c6c 5f74 7261  rmations=all_tra
+00008980: 6e73 666f 726d 732c 0a20 2020 2020 2020  nsforms,.       
+00008990: 2020 2020 2020 2020 206d 756c 7469 5f63           multi_c
+000089a0: 6f68 6f72 743d 7365 6c66 2e6d 756c 7469  ohort=self.multi
+000089b0: 5f63 6f68 6f72 742c 0a20 2020 2020 2020  _cohort,.       
+000089c0: 2020 2020 2020 2020 206c 6162 656c 3d73           label=s
+000089d0: 656c 662e 6c61 6265 6c2c 0a20 2020 2020  elf.label,.     
+000089e0: 2020 2020 2020 2020 2020 206c 6162 656c             label
+000089f0: 5f63 6f64 653d 7365 6c66 2e6c 6162 656c  _code=self.label
+00008a00: 5f63 6f64 652c 0a20 2020 2020 2020 2020  _code,.         
+00008a10: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00008a20: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+00008a30: 4c6f 6164 696e 6720 7461 7267 6574 206c  Loading target l
+00008a40: 6162 656c 6c65 6420 7472 6169 6e69 6e67  abelled training
+00008a50: 2064 6174 612e 2e2e 2229 0a20 2020 2020   data...").     
+00008a60: 2020 2020 2020 2064 6174 615f 7472 6169         data_trai
+00008a70: 6e5f 7461 7267 6574 5f6c 6162 656c 6564  n_target_labeled
+00008a80: 203d 2072 6574 7572 6e5f 6461 7461 7365   = return_datase
+00008a90: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00008aa0: 2020 2050 6174 6828 7365 6c66 2e63 6170     Path(self.cap
+00008ab0: 735f 7461 7267 6574 292c 2020 2320 544f  s_target),  # TO
+00008ac0: 2043 4845 434b 0a20 2020 2020 2020 2020   CHECK.         
+00008ad0: 2020 2020 2020 2073 706c 6974 5f64 665f         split_df_
+00008ae0: 6469 6374 5f74 6172 6765 745f 6c61 625b  dict_target_lab[
+00008af0: 2274 7261 696e 225d 2c0a 2020 2020 2020  "train"],.      
+00008b00: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+00008b10: 7265 7072 6f63 6573 7369 6e67 5f64 6963  reprocessing_dic
+00008b20: 745f 7461 7267 6574 2c0a 2020 2020 2020  t_target,.      
+00008b30: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
+00008b40: 7472 616e 7366 6f72 6d61 7469 6f6e 733d  transformations=
+00008b50: 7472 6169 6e5f 7472 616e 7366 6f72 6d73  train_transforms
+00008b60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008b70: 2020 616c 6c5f 7472 616e 7366 6f72 6d61    all_transforma
+00008b80: 7469 6f6e 733d 616c 6c5f 7472 616e 7366  tions=all_transf
+00008b90: 6f72 6d73 2c0a 2020 2020 2020 2020 2020  orms,.          
+00008ba0: 2020 2020 2020 6d75 6c74 695f 636f 686f        multi_coho
+00008bb0: 7274 3d46 616c 7365 2c20 2023 2041 2063  rt=False,  # A c
+00008bc0: 6865 636b 6572 0a20 2020 2020 2020 2020  hecker.         
+00008bd0: 2020 2020 2020 206c 6162 656c 3d73 656c         label=sel
+00008be0: 662e 6c61 6265 6c2c 0a20 2020 2020 2020  f.label,.       
+00008bf0: 2020 2020 2020 2020 206c 6162 656c 5f63           label_c
+00008c00: 6f64 653d 7365 6c66 2e6c 6162 656c 5f63  ode=self.label_c
+00008c10: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
+00008c20: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
+00008c30: 726f 6d20 746f 7263 682e 7574 696c 732e  rom torch.utils.
+00008c40: 6461 7461 2069 6d70 6f72 7420 436f 6e63  data import Conc
+00008c50: 6174 4461 7461 7365 742c 2044 6174 614c  atDataset, DataL
+00008c60: 6f61 6465 720a 0a20 2020 2020 2020 2020  oader..         
+00008c70: 2020 2063 6f6d 6269 6e65 645f 6461 7461     combined_data
+00008c80: 7365 7420 3d20 436f 6e63 6174 4461 7461  set = ConcatData
+00008c90: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
+00008ca0: 2020 2020 205b 6461 7461 5f74 7261 696e       [data_train
+00008cb0: 5f73 6f75 7263 652c 2064 6174 615f 7472  _source, data_tr
+00008cc0: 6169 6e5f 7461 7267 6574 5f6c 6162 656c  ain_target_label
+00008cd0: 6564 5d0a 2020 2020 2020 2020 2020 2020  ed].            
+00008ce0: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
+00008cf0: 6f67 6765 722e 6465 6275 6728 224c 6f61  ogger.debug("Loa
+00008d00: 6469 6e67 2074 6172 6765 7420 756e 6c61  ding target unla
+00008d10: 6265 6c6c 6564 2074 7261 696e 696e 6720  belled training 
+00008d20: 6461 7461 2e2e 2e22 290a 2020 2020 2020  data...").      
+00008d30: 2020 2020 2020 6461 7461 5f74 6172 6765        data_targe
+00008d40: 745f 756e 6c61 6265 6c65 6420 3d20 7265  t_unlabeled = re
+00008d50: 7475 726e 5f64 6174 6173 6574 280a 2020  turn_dataset(.  
+00008d60: 2020 2020 2020 2020 2020 2020 2020 5061                Pa
+00008d70: 7468 2873 656c 662e 6361 7073 5f74 6172  th(self.caps_tar
+00008d80: 6765 7429 2c0a 2020 2020 2020 2020 2020  get),.          
+00008d90: 2020 2020 2020 7064 2e72 6561 645f 6373        pd.read_cs
+00008da0: 7628 7365 6c66 2e74 7376 5f74 6172 6765  v(self.tsv_targe
+00008db0: 745f 756e 6c61 622c 2073 6570 3d22 5c74  t_unlab, sep="\t
+00008dc0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00008dd0: 2020 2020 7365 6c66 2e70 7265 7072 6f63      self.preproc
+00008de0: 6573 7369 6e67 5f64 6963 745f 7461 7267  essing_dict_targ
+00008df0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00008e00: 2020 2020 7472 6169 6e5f 7472 616e 7366      train_transf
+00008e10: 6f72 6d61 7469 6f6e 733d 7472 6169 6e5f  ormations=train_
+00008e20: 7472 616e 7366 6f72 6d73 2c0a 2020 2020  transforms,.    
+00008e30: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00008e40: 7472 616e 7366 6f72 6d61 7469 6f6e 733d  transformations=
+00008e50: 616c 6c5f 7472 616e 7366 6f72 6d73 2c0a  all_transforms,.
+00008e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e70: 6d75 6c74 695f 636f 686f 7274 3d46 616c  multi_cohort=Fal
+00008e80: 7365 2c20 2023 2041 2063 6865 636b 6572  se,  # A checker
+00008e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ea0: 206c 6162 656c 3d73 656c 662e 6c61 6265   label=self.labe
+00008eb0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00008ec0: 2020 206c 6162 656c 5f63 6f64 653d 7365     label_code=se
+00008ed0: 6c66 2e6c 6162 656c 5f63 6f64 652c 0a20  lf.label_code,. 
+00008ee0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00008ef0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00008f00: 2e64 6562 7567 2822 4c6f 6164 696e 6720  .debug("Loading 
+00008f10: 7661 6c69 6461 7469 6f6e 2073 6f75 7263  validation sourc
+00008f20: 6520 6461 7461 2e2e 2e22 290a 2020 2020  e data...").    
+00008f30: 2020 2020 2020 2020 6461 7461 5f76 616c          data_val
+00008f40: 6964 5f73 6f75 7263 6520 3d20 7265 7475  id_source = retu
+00008f50: 726e 5f64 6174 6173 6574 280a 2020 2020  rn_dataset(.    
+00008f60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008f70: 2e63 6170 735f 6469 7265 6374 6f72 792c  .caps_directory,
+00008f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008f90: 2073 706c 6974 5f64 665f 6469 6374 5b22   split_df_dict["
+00008fa0: 7661 6c69 6461 7469 6f6e 225d 2c0a 2020  validation"],.  
+00008fb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008fc0: 6c66 2e70 7265 7072 6f63 6573 7369 6e67  lf.preprocessing
+00008fd0: 5f64 6963 742c 0a20 2020 2020 2020 2020  _dict,.         
+00008fe0: 2020 2020 2020 2074 7261 696e 5f74 7261         train_tra
+00008ff0: 6e73 666f 726d 6174 696f 6e73 3d74 7261  nsformations=tra
+00009000: 696e 5f74 7261 6e73 666f 726d 732c 0a20  in_transforms,. 
+00009010: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00009020: 6c6c 5f74 7261 6e73 666f 726d 6174 696f  ll_transformatio
+00009030: 6e73 3d61 6c6c 5f74 7261 6e73 666f 726d  ns=all_transform
+00009040: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00009050: 2020 206d 756c 7469 5f63 6f68 6f72 743d     multi_cohort=
+00009060: 7365 6c66 2e6d 756c 7469 5f63 6f68 6f72  self.multi_cohor
+00009070: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00009080: 2020 206c 6162 656c 3d73 656c 662e 6c61     label=self.la
+00009090: 6265 6c2c 0a20 2020 2020 2020 2020 2020  bel,.           
+000090a0: 2020 2020 206c 6162 656c 5f63 6f64 653d       label_code=
+000090b0: 7365 6c66 2e6c 6162 656c 5f63 6f64 652c  self.label_code,
+000090c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000090d0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000090e0: 722e 6465 6275 6728 224c 6f61 6469 6e67  r.debug("Loading
+000090f0: 2076 616c 6964 6174 696f 6e20 7461 7267   validation targ
+00009100: 6574 206c 6162 656c 6c65 6420 6461 7461  et labelled data
+00009110: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
+00009120: 2020 6461 7461 5f76 616c 6964 5f74 6172    data_valid_tar
+00009130: 6765 745f 6c61 6265 6c65 6420 3d20 7265  get_labeled = re
+00009140: 7475 726e 5f64 6174 6173 6574 280a 2020  turn_dataset(.  
+00009150: 2020 2020 2020 2020 2020 2020 2020 5061                Pa
+00009160: 7468 2873 656c 662e 6361 7073 5f74 6172  th(self.caps_tar
+00009170: 6765 7429 2c0a 2020 2020 2020 2020 2020  get),.          
+00009180: 2020 2020 2020 7370 6c69 745f 6466 5f64        split_df_d
+00009190: 6963 745f 7461 7267 6574 5f6c 6162 5b22  ict_target_lab["
+000091a0: 7661 6c69 6461 7469 6f6e 225d 2c0a 2020  validation"],.  
+000091b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000091c0: 6c66 2e70 7265 7072 6f63 6573 7369 6e67  lf.preprocessing
+000091d0: 5f64 6963 745f 7461 7267 6574 2c0a 2020  _dict_target,.  
+000091e0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+000091f0: 6169 6e5f 7472 616e 7366 6f72 6d61 7469  ain_transformati
+00009200: 6f6e 733d 7472 6169 6e5f 7472 616e 7366  ons=train_transf
+00009210: 6f72 6d73 2c0a 2020 2020 2020 2020 2020  orms,.          
+00009220: 2020 2020 2020 616c 6c5f 7472 616e 7366        all_transf
+00009230: 6f72 6d61 7469 6f6e 733d 616c 6c5f 7472  ormations=all_tr
+00009240: 616e 7366 6f72 6d73 2c0a 2020 2020 2020  ansforms,.      
+00009250: 2020 2020 2020 2020 2020 6d75 6c74 695f            multi_
+00009260: 636f 686f 7274 3d46 616c 7365 2c0a 2020  cohort=False,.  
+00009270: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00009280: 6265 6c3d 7365 6c66 2e6c 6162 656c 2c0a  bel=self.label,.
+00009290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092a0: 6c61 6265 6c5f 636f 6465 3d73 656c 662e  label_code=self.
+000092b0: 6c61 6265 6c5f 636f 6465 2c0a 2020 2020  label_code,.    
+000092c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000092d0: 2020 2020 2020 7472 6169 6e5f 736f 7572        train_sour
+000092e0: 6365 5f73 616d 706c 6572 203d 2073 656c  ce_sampler = sel
+000092f0: 662e 7461 736b 5f6d 616e 6167 6572 2e67  f.task_manager.g
+00009300: 656e 6572 6174 655f 7361 6d70 6c65 7228  enerate_sampler(
+00009310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009320: 2064 6174 615f 7472 6169 6e5f 736f 7572   data_train_sour
+00009330: 6365 2c20 7365 6c66 2e73 616d 706c 6572  ce, self.sampler
+00009340: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00009350: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00009360: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+00009370: 2020 2020 2020 2020 2066 2247 6574 7469           f"Getti
+00009380: 6e67 2074 7261 696e 2061 6e64 2076 616c  ng train and val
+00009390: 6964 6174 696f 6e20 6c6f 6164 6572 2077  idation loader w
+000093a0: 6974 6820 6261 7463 6820 7369 7a65 207b  ith batch size {
+000093b0: 7365 6c66 2e62 6174 6368 5f73 697a 657d  self.batch_size}
+000093c0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+000093d0: 0a20 2020 2020 2020 2020 2020 2023 2320  .            ## 
+000093e0: 4f76 6572 7361 6d70 6c69 6e67 206f 6620  Oversampling of 
+000093f0: 7468 6520 7461 7267 6574 2064 6174 6173  the target datas
+00009400: 6574 0a20 2020 2020 2020 2020 2020 2066  et.            f
+00009410: 726f 6d20 746f 7263 682e 7574 696c 732e  rom torch.utils.
+00009420: 6461 7461 2069 6d70 6f72 7420 5375 6273  data import Subs
+00009430: 6574 5261 6e64 6f6d 5361 6d70 6c65 720a  etRandomSampler.
+00009440: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+00009450: 7265 6174 6520 696e 6465 7820 6c69 7374  reate index list
+00009460: 7320 666f 7220 7461 7267 6574 206c 6162  s for target lab
+00009470: 656c 6564 2064 6174 6173 6574 0a20 2020  eled dataset.   
+00009480: 2020 2020 2020 2020 206c 6162 656c 6564           labeled
+00009490: 5f69 6e64 6963 6573 203d 206c 6973 7428  _indices = list(
+000094a0: 7261 6e67 6528 6c65 6e28 6461 7461 5f74  range(len(data_t
+000094b0: 7261 696e 5f74 6172 6765 745f 6c61 6265  rain_target_labe
+000094c0: 6c65 6429 2929 0a0a 2020 2020 2020 2020  led)))..        
+000094d0: 2020 2020 2320 4f76 6572 7361 6d70 6c65      # Oversample
+000094e0: 2074 6865 2069 6e64 6963 6573 2066 6f72   the indices for
+000094f0: 2074 6865 2074 6172 6765 7420 6c61 6265   the target labe
+00009500: 6c6c 6564 2064 6174 6173 6574 2074 6f20  lled dataset to 
+00009510: 6d61 7463 6820 7468 6520 7369 7a65 206f  match the size o
+00009520: 6620 7468 6520 6c61 6265 6c65 6420 736f  f the labeled so
+00009530: 7572 6365 2064 6174 6173 6574 0a20 2020  urce dataset.   
+00009540: 2020 2020 2020 2020 2064 6174 615f 7472           data_tr
+00009550: 6169 6e5f 736f 7572 6365 5f73 697a 6520  ain_source_size 
+00009560: 3d20 6c65 6e28 6461 7461 5f74 7261 696e  = len(data_train
+00009570: 5f73 6f75 7263 6529 202f 2f20 7365 6c66  _source) // self
+00009580: 2e62 6174 6368 5f73 697a 650a 2020 2020  .batch_size.    
+00009590: 2020 2020 2020 2020 6c61 6265 6c65 645f          labeled_
+000095a0: 6f76 6572 7361 6d70 6c65 645f 696e 6469  oversampled_indi
+000095b0: 6365 7320 3d20 6c61 6265 6c65 645f 696e  ces = labeled_in
+000095c0: 6469 6365 7320 2a20 280a 2020 2020 2020  dices * (.      
+000095d0: 2020 2020 2020 2020 2020 6461 7461 5f74            data_t
+000095e0: 7261 696e 5f73 6f75 7263 655f 7369 7a65  rain_source_size
+000095f0: 202f 2f20 6c65 6e28 6c61 6265 6c65 645f   // len(labeled_
+00009600: 696e 6469 6365 7329 0a20 2020 2020 2020  indices).       
+00009610: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009620: 2020 2020 2320 4170 7065 6e64 2072 656d      # Append rem
+00009630: 6169 6e69 6e67 2069 6e64 6963 6573 2074  aining indices t
+00009640: 6f20 6d61 7463 6820 7468 6520 7369 7a65  o match the size
+00009650: 206f 6620 7468 6520 6c61 7267 6573 7420   of the largest 
+00009660: 6461 7461 7365 740a 2020 2020 2020 2020  dataset.        
+00009670: 2020 2020 6c61 6265 6c65 645f 6f76 6572      labeled_over
+00009680: 7361 6d70 6c65 645f 696e 6469 6365 7320  sampled_indices 
+00009690: 2b3d 206c 6162 656c 6564 5f69 6e64 6963  += labeled_indic
+000096a0: 6573 5b0a 2020 2020 2020 2020 2020 2020  es[.            
+000096b0: 2020 2020 3a20 6461 7461 5f74 7261 696e      : data_train
+000096c0: 5f73 6f75 7263 655f 7369 7a65 2025 206c  _source_size % l
+000096d0: 656e 286c 6162 656c 6564 5f69 6e64 6963  en(labeled_indic
+000096e0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000096f0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+00009700: 2043 7265 6174 6520 5375 6273 6574 5261   Create SubsetRa
+00009710: 6e64 6f6d 5361 6d70 6c65 7273 2075 7369  ndomSamplers usi
+00009720: 6e67 2074 6865 206f 7665 7273 616d 706c  ng the oversampl
+00009730: 6564 2069 6e64 6963 6573 0a20 2020 2020  ed indices.     
+00009740: 2020 2020 2020 206c 6162 656c 6564 5f73         labeled_s
+00009750: 616d 706c 6572 203d 2053 7562 7365 7452  ampler = SubsetR
+00009760: 616e 646f 6d53 616d 706c 6572 286c 6162  andomSampler(lab
+00009770: 656c 6564 5f6f 7665 7273 616d 706c 6564  eled_oversampled
+00009780: 5f69 6e64 6963 6573 290a 0a20 2020 2020  _indices)..     
+00009790: 2020 2020 2020 2074 7261 696e 5f73 6f75         train_sou
+000097a0: 7263 655f 6c6f 6164 6572 203d 2044 6174  rce_loader = Dat
+000097b0: 614c 6f61 6465 7228 0a20 2020 2020 2020  aLoader(.       
+000097c0: 2020 2020 2020 2020 2064 6174 615f 7472           data_tr
+000097d0: 6169 6e5f 736f 7572 6365 2c0a 2020 2020  ain_source,.    
+000097e0: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+000097f0: 685f 7369 7a65 3d73 656c 662e 6261 7463  h_size=self.batc
+00009800: 685f 7369 7a65 2c0a 2020 2020 2020 2020  h_size,.        
+00009810: 2020 2020 2020 2020 7361 6d70 6c65 723d          sampler=
+00009820: 7472 6169 6e5f 736f 7572 6365 5f73 616d  train_source_sam
+00009830: 706c 6572 2c0a 2020 2020 2020 2020 2020  pler,.          
+00009840: 2020 2020 2020 2320 7368 7566 666c 653d        # shuffle=
+00009850: 5472 7565 2c20 2023 206c 656e 2864 6174  True,  # len(dat
+00009860: 615f 7472 6169 6e5f 736f 7572 6365 2920  a_train_source) 
+00009870: 3c20 6c65 6e28 6461 7461 5f74 7261 696e  < len(data_train
+00009880: 5f74 6172 6765 745f 6c61 6265 6c65 6429  _target_labeled)
+00009890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000098a0: 2020 6e75 6d5f 776f 726b 6572 733d 7365    num_workers=se
+000098b0: 6c66 2e6e 5f70 726f 632c 0a20 2020 2020  lf.n_proc,.     
+000098c0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+000098d0: 725f 696e 6974 5f66 6e3d 706c 5f77 6f72  r_init_fn=pl_wor
+000098e0: 6b65 725f 696e 6974 5f66 756e 6374 696f  ker_init_functio
+000098f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00009900: 2020 2064 726f 705f 6c61 7374 3d54 7275     drop_last=Tru
+00009910: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00009920: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00009930: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+00009940: 2020 2020 2020 2020 2020 6622 5472 6169            f"Trai
+00009950: 6e20 736f 7572 6365 206c 6f61 6465 7220  n source loader 
+00009960: 7369 7a65 2069 7320 7b6c 656e 2874 7261  size is {len(tra
+00009970: 696e 5f73 6f75 7263 655f 6c6f 6164 6572  in_source_loader
+00009980: 292a 7365 6c66 2e62 6174 6368 5f73 697a  )*self.batch_siz
+00009990: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
+000099a0: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
+000099b0: 6169 6e5f 7461 7267 6574 5f6c 6f61 6465  ain_target_loade
+000099c0: 7220 3d20 4461 7461 4c6f 6164 6572 280a  r = DataLoader(.
+000099d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099e0: 6461 7461 5f74 7261 696e 5f74 6172 6765  data_train_targe
+000099f0: 745f 6c61 6265 6c65 642c 0a20 2020 2020  t_labeled,.     
+00009a00: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+00009a10: 5f73 697a 653d 312c 2020 2320 546f 206c  _size=1,  # To l
+00009a20: 696d 6974 2074 6865 206e 6565 6420 6f66  imit the need of
+00009a30: 206f 7665 7273 616d 706c 696e 670a 2020   oversampling.  
+00009a40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009a50: 7361 6d70 6c65 723d 7472 6169 6e5f 7461  sampler=train_ta
+00009a60: 7267 6574 5f73 616d 706c 6572 2c0a 2020  rget_sampler,.  
+00009a70: 2020 2020 2020 2020 2020 2020 2020 7361                sa
+00009a80: 6d70 6c65 723d 6c61 6265 6c65 645f 7361  mpler=labeled_sa
+00009a90: 6d70 6c65 722c 0a20 2020 2020 2020 2020  mpler,.         
+00009aa0: 2020 2020 2020 206e 756d 5f77 6f72 6b65         num_worke
+00009ab0: 7273 3d73 656c 662e 6e5f 7072 6f63 2c0a  rs=self.n_proc,.
+00009ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ad0: 776f 726b 6572 5f69 6e69 745f 666e 3d70  worker_init_fn=p
+00009ae0: 6c5f 776f 726b 6572 5f69 6e69 745f 6675  l_worker_init_fu
+00009af0: 6e63 7469 6f6e 2c0a 2020 2020 2020 2020  nction,.        
+00009b00: 2020 2020 2020 2020 2320 7368 7566 666c          # shuffl
+00009b10: 653d 5472 7565 2c20 2023 206c 656e 2864  e=True,  # len(d
+00009b20: 6174 615f 7472 6169 6e5f 7461 7267 6574  ata_train_target
+00009b30: 5f6c 6162 656c 6564 2920 3c20 6c65 6e28  _labeled) < len(
+00009b40: 6461 7461 5f74 7261 696e 5f73 6f75 7263  data_train_sourc
+00009b50: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00009b60: 2020 2020 6472 6f70 5f6c 6173 743d 5472      drop_last=Tr
+00009b70: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00009b80: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+00009b90: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
+00009ba0: 2020 2020 2020 2020 2020 2066 2254 7261             f"Tra
+00009bb0: 696e 2074 6172 6765 7420 6c61 6265 6c65  in target labele
+00009bc0: 6420 6c6f 6164 6572 2073 697a 6520 6f76  d loader size ov
+00009bd0: 6572 7361 6d70 6c65 2069 7320 7b6c 656e  ersample is {len
+00009be0: 2874 7261 696e 5f74 6172 6765 745f 6c6f  (train_target_lo
+00009bf0: 6164 6572 297d 220a 2020 2020 2020 2020  ader)}".        
+00009c00: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00009c10: 2020 2064 6174 615f 7472 6169 6e5f 7461     data_train_ta
+00009c20: 7267 6574 5f6c 6162 656c 6564 2e64 6620  rget_labeled.df 
+00009c30: 3d20 6461 7461 5f74 7261 696e 5f74 6172  = data_train_tar
+00009c40: 6765 745f 6c61 6265 6c65 642e 6466 5b0a  get_labeled.df[.
+00009c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c60: 5b22 7061 7274 6963 6970 616e 745f 6964  ["participant_id
+00009c70: 222c 2022 7365 7373 696f 6e5f 6964 222c  ", "session_id",
+00009c80: 2022 6469 6167 6e6f 7369 7322 2c20 2263   "diagnosis", "c
+00009c90: 6f68 6f72 7422 2c20 2264 6f6d 6169 6e22  ohort", "domain"
+00009ca0: 5d0a 2020 2020 2020 2020 2020 2020 5d0a  ].            ].
+00009cb0: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+00009cc0: 696e 5f74 6172 6765 745f 756e 6c5f 6c6f  in_target_unl_lo
+00009cd0: 6164 6572 203d 2044 6174 614c 6f61 6465  ader = DataLoade
+00009ce0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00009cf0: 2020 2064 6174 615f 7461 7267 6574 5f75     data_target_u
+00009d00: 6e6c 6162 656c 6564 2c0a 2020 2020 2020  nlabeled,.      
+00009d10: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
+00009d20: 7369 7a65 3d73 656c 662e 6261 7463 685f  size=self.batch_
+00009d30: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00009d40: 2020 2020 2020 6e75 6d5f 776f 726b 6572        num_worker
+00009d50: 733d 7365 6c66 2e6e 5f70 726f 632c 0a20  s=self.n_proc,. 
+00009d60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00009d70: 2073 616d 706c 6572 3d75 6e6c 6162 656c   sampler=unlabel
+00009d80: 6564 5f73 616d 706c 6572 2c0a 2020 2020  ed_sampler,.    
+00009d90: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00009da0: 6572 5f69 6e69 745f 666e 3d70 6c5f 776f  er_init_fn=pl_wo
+00009db0: 726b 6572 5f69 6e69 745f 6675 6e63 7469  rker_init_functi
+00009dc0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+00009dd0: 2020 2020 7368 7566 666c 653d 5472 7565      shuffle=True
+00009de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009df0: 2020 6472 6f70 5f6c 6173 743d 5472 7565    drop_last=True
+00009e00: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00009e10: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00009e20: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+00009e30: 2020 2020 2020 2020 2020 6622 5472 6169            f"Trai
+00009e40: 6e20 7461 7267 6574 2075 6e6c 6162 656c  n target unlabel
+00009e50: 6564 206c 6f61 6465 7220 7369 7a65 2069  ed loader size i
+00009e60: 7320 7b6c 656e 2874 7261 696e 5f74 6172  s {len(train_tar
+00009e70: 6765 745f 756e 6c5f 6c6f 6164 6572 292a  get_unl_loader)*
+00009e80: 7365 6c66 2e62 6174 6368 5f73 697a 657d  self.batch_size}
+00009e90: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00009ea0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+00009eb0: 6964 5f6c 6f61 6465 725f 736f 7572 6365  id_loader_source
+00009ec0: 203d 2044 6174 614c 6f61 6465 7228 0a20   = DataLoader(. 
+00009ed0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00009ee0: 6174 615f 7661 6c69 645f 736f 7572 6365  ata_valid_source
+00009ef0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009f00: 2020 6261 7463 685f 7369 7a65 3d73 656c    batch_size=sel
+00009f10: 662e 6261 7463 685f 7369 7a65 2c0a 2020  f.batch_size,.  
+00009f20: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00009f30: 7566 666c 653d 4661 6c73 652c 0a20 2020  uffle=False,.   
+00009f40: 2020 2020 2020 2020 2020 2020 206e 756d               num
+00009f50: 5f77 6f72 6b65 7273 3d73 656c 662e 6e5f  _workers=self.n_
+00009f60: 7072 6f63 2c0a 2020 2020 2020 2020 2020  proc,.          
+00009f70: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00009f80: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+00009f90: 2020 2020 2020 2020 2020 2020 2066 2256               f"V
+00009fa0: 616c 6964 6174 696f 6e20 6c6f 6164 6572  alidation loader
+00009fb0: 2073 6f75 7263 6520 7369 7a65 2069 7320   source size is 
+00009fc0: 7b6c 656e 2876 616c 6964 5f6c 6f61 6465  {len(valid_loade
+00009fd0: 725f 736f 7572 6365 292a 7365 6c66 2e62  r_source)*self.b
+00009fe0: 6174 6368 5f73 697a 657d 220a 2020 2020  atch_size}".    
+00009ff0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000a000: 2020 2020 2020 2076 616c 6964 5f6c 6f61         valid_loa
+0000a010: 6465 725f 7461 7267 6574 203d 2044 6174  der_target = Dat
+0000a020: 614c 6f61 6465 7228 0a20 2020 2020 2020  aLoader(.       
+0000a030: 2020 2020 2020 2020 2064 6174 615f 7661           data_va
+0000a040: 6c69 645f 7461 7267 6574 5f6c 6162 656c  lid_target_label
+0000a050: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+0000a060: 2020 2020 6261 7463 685f 7369 7a65 3d73      batch_size=s
+0000a070: 656c 662e 6261 7463 685f 7369 7a65 2c20  elf.batch_size, 
+0000a080: 2023 2054 6f20 6368 6563 6b0a 2020 2020   # To check.    
+0000a090: 2020 2020 2020 2020 2020 2020 7368 7566              shuf
+0000a0a0: 666c 653d 4661 6c73 652c 0a20 2020 2020  fle=False,.     
+0000a0b0: 2020 2020 2020 2020 2020 206e 756d 5f77             num_w
+0000a0c0: 6f72 6b65 7273 3d73 656c 662e 6e5f 7072  orkers=self.n_pr
+0000a0d0: 6f63 2c0a 2020 2020 2020 2020 2020 2020  oc,.            
+0000a0e0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+0000a0f0: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
+0000a100: 2020 2020 2020 2020 2020 2066 2256 616c             f"Val
+0000a110: 6964 6174 696f 6e20 6c6f 6164 6572 2074  idation loader t
+0000a120: 6172 6765 7420 7369 7a65 2069 7320 7b6c  arget size is {l
+0000a130: 656e 2876 616c 6964 5f6c 6f61 6465 725f  en(valid_loader_
+0000a140: 7461 7267 6574 292a 7365 6c66 2e62 6174  target)*self.bat
+0000a150: 6368 5f73 697a 657d 220a 2020 2020 2020  ch_size}".      
+0000a160: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000a170: 2020 2020 2073 656c 662e 5f74 7261 696e       self._train
+0000a180: 5f73 7364 616e 6e28 0a20 2020 2020 2020  _ssdann(.       
+0000a190: 2020 2020 2020 2020 2074 7261 696e 5f73           train_s
+0000a1a0: 6f75 7263 655f 6c6f 6164 6572 2c0a 2020  ource_loader,.  
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000a1c0: 6169 6e5f 7461 7267 6574 5f6c 6f61 6465  ain_target_loade
+0000a1d0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000a1e0: 2020 2074 7261 696e 5f74 6172 6765 745f     train_target_
+0000a1f0: 756e 6c5f 6c6f 6164 6572 2c0a 2020 2020  unl_loader,.    
+0000a200: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+0000a210: 645f 6c6f 6164 6572 5f74 6172 6765 742c  d_loader_target,
+0000a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a230: 2076 616c 6964 5f6c 6f61 6465 725f 736f   valid_loader_so
+0000a240: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+0000a250: 2020 2020 2020 7370 6c69 742c 0a20 2020        split,.   
+0000a260: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0000a270: 756d 653d 7265 7375 6d65 2c0a 2020 2020  ume=resume,.    
+0000a280: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000a290: 2020 2020 2020 2073 656c 662e 5f65 6e73         self._ens
+0000a2a0: 656d 626c 655f 7072 6564 6963 7469 6f6e  emble_prediction
+0000a2b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a2c0: 2020 2274 7261 696e 222c 0a20 2020 2020    "train",.     
+0000a2d0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+0000a2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a2f0: 2020 7365 6c66 2e73 656c 6563 7469 6f6e    self.selection
+0000a300: 5f6d 6574 7269 6373 2c0a 2020 2020 2020  _metrics,.      
+0000a310: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a320: 2020 2020 7365 6c66 2e5f 656e 7365 6d62      self._ensemb
+0000a330: 6c65 5f70 7265 6469 6374 696f 6e28 0a20  le_prediction(. 
+0000a340: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000a350: 7661 6c69 6461 7469 6f6e 222c 0a20 2020  validation",.   
+0000a360: 2020 2020 2020 2020 2020 2020 2073 706c               spl
+0000a370: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+0000a380: 2020 2020 7365 6c66 2e73 656c 6563 7469      self.selecti
+0000a390: 6f6e 5f6d 6574 7269 6373 2c0a 2020 2020  on_metrics,.    
+0000a3a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000a3b0: 2020 2020 2020 2073 656c 662e 5f65 7261         self._era
+0000a3c0: 7365 5f74 6d70 2873 706c 6974 290a 0a20  se_tmp(split).. 
+0000a3d0: 2020 2064 6566 205f 7472 6169 6e28 0a20     def _train(. 
+0000a3e0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000a3f0: 2020 2020 2074 7261 696e 5f6c 6f61 6465       train_loade
+0000a400: 722c 0a20 2020 2020 2020 2076 616c 6964  r,.        valid
+0000a410: 5f6c 6f61 6465 722c 0a20 2020 2020 2020  _loader,.       
+0000a420: 2073 706c 6974 2c0a 2020 2020 2020 2020   split,.        
+0000a430: 6e65 7477 6f72 6b3d 4e6f 6e65 2c0a 2020  network=None,.  
+0000a440: 2020 2020 2020 7265 7375 6d65 3d46 616c        resume=Fal
+0000a450: 7365 2c0a 2020 2020 2020 2020 6361 6c6c  se,.        call
+0000a460: 6261 636b 733d 5b5d 2c0a 2020 2020 293a  backs=[],.    ):
+0000a470: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000a480: 2020 2020 2043 6f72 6520 6675 6e63 7469       Core functi
+0000a490: 6f6e 2073 6861 7265 6420 6279 2074 7261  on shared by tra
+0000a4a0: 696e 2061 6e64 2072 6573 756d 652e 0a0a  in and resume...
+0000a4b0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0000a4c0: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
+0000a4d0: 6c6f 6164 6572 2028 746f 7263 682e 7574  loader (torch.ut
+0000a4e0: 696c 732e 6461 7461 2e44 6174 614c 6f61  ils.data.DataLoa
+0000a4f0: 6465 7229 3a20 4461 7461 4c6f 6164 6572  der): DataLoader
+0000a500: 2077 7261 7070 696e 6720 7468 6520 7472   wrapping the tr
+0000a510: 6169 6e69 6e67 2073 6574 2e0a 2020 2020  aining set..    
+0000a520: 2020 2020 2020 2020 7661 6c69 645f 6c6f          valid_lo
+0000a530: 6164 6572 2028 746f 7263 682e 7574 696c  ader (torch.util
+0000a540: 732e 6461 7461 2e44 6174 614c 6f61 6465  s.data.DataLoade
+0000a550: 7229 3a20 4461 7461 4c6f 6164 6572 2077  r): DataLoader w
+0000a560: 7261 7070 696e 6720 7468 6520 7661 6c69  rapping the vali
+0000a570: 6461 7469 6f6e 2073 6574 2e0a 2020 2020  dation set..    
+0000a580: 2020 2020 2020 2020 7370 6c69 7420 2869          split (i
+0000a590: 6e74 293a 2049 6e64 6578 206f 6620 7468  nt): Index of th
+0000a5a0: 6520 7370 6c69 7420 7472 6169 6e65 642e  e split trained.
+0000a5b0: 0a20 2020 2020 2020 2020 2020 206e 6574  .            net
+0000a5c0: 776f 726b 2028 696e 7429 3a20 496e 6465  work (int): Inde
+0000a5d0: 7820 6f66 2074 6865 206e 6574 776f 726b  x of the network
+0000a5e0: 2074 7261 696e 6564 2028 7573 6564 2069   trained (used i
+0000a5f0: 6e20 6d75 6c74 692d 6e65 7477 6f72 6b20  n multi-network 
+0000a600: 7365 7474 696e 6720 6f6e 6c79 292e 0a20  setting only).. 
+0000a610: 2020 2020 2020 2020 2020 2072 6573 756d             resum
+0000a620: 6520 2862 6f6f 6c29 3a20 4966 2054 7275  e (bool): If Tru
+0000a630: 6520 7468 6520 6a6f 6220 6973 2072 6573  e the job is res
+0000a640: 756d 6564 2066 726f 6d20 7468 6520 6368  umed from the ch
+0000a650: 6563 6b70 6f69 6e74 2e0a 2020 2020 2020  eckpoint..      
+0000a660: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
+0000a670: 6c66 2e5f 696e 6974 5f63 616c 6c62 6163  lf._init_callbac
+0000a680: 6b73 2829 0a20 2020 2020 2020 206d 6f64  ks().        mod
+0000a690: 656c 2c20 6265 6769 6e6e 696e 675f 6570  el, beginning_ep
+0000a6a0: 6f63 6820 3d20 7365 6c66 2e5f 696e 6974  och = self._init
+0000a6b0: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
+0000a6c0: 2020 2020 7370 6c69 743d 7370 6c69 742c      split=split,
+0000a6d0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000a6e0: 756d 653d 7265 7375 6d65 2c0a 2020 2020  ume=resume,.    
+0000a6f0: 2020 2020 2020 2020 7472 616e 7366 6572          transfer
+0000a700: 5f70 6174 683d 7365 6c66 2e74 7261 6e73  _path=self.trans
+0000a710: 6665 725f 7061 7468 2c0a 2020 2020 2020  fer_path,.      
+0000a720: 2020 2020 2020 7472 616e 7366 6572 5f73        transfer_s
+0000a730: 656c 6563 7469 6f6e 3d73 656c 662e 7472  election=self.tr
+0000a740: 616e 7366 6572 5f73 656c 6563 7469 6f6e  ansfer_selection
+0000a750: 5f6d 6574 7269 632c 0a20 2020 2020 2020  _metric,.       
+0000a760: 2020 2020 206e 625f 756e 6672 6f7a 656e       nb_unfrozen
+0000a770: 5f6c 6179 6572 3d73 656c 662e 6e62 5f75  _layer=self.nb_u
+0000a780: 6e66 726f 7a65 6e5f 6c61 7965 722c 0a20  nfrozen_layer,. 
+0000a790: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a7a0: 206d 6f64 656c 203d 2044 4450 286d 6f64   model = DDP(mod
+0000a7b0: 656c 2c20 6673 6470 3d73 656c 662e 6675  el, fsdp=self.fu
+0000a7c0: 6c6c 795f 7368 6172 6465 645f 6461 7461  lly_sharded_data
+0000a7d0: 5f70 6172 616c 6c65 6c2c 2061 6d70 3d73  _parallel, amp=s
+0000a7e0: 656c 662e 616d 7029 0a20 2020 2020 2020  elf.amp).       
+0000a7f0: 2063 7269 7465 7269 6f6e 203d 2073 656c   criterion = sel
+0000a800: 662e 7461 736b 5f6d 616e 6167 6572 2e67  f.task_manager.g
+0000a810: 6574 5f63 7269 7465 7269 6f6e 2873 656c  et_criterion(sel
+0000a820: 662e 6c6f 7373 290a 0a20 2020 2020 2020  f.loss)..       
+0000a830: 206f 7074 696d 697a 6572 203d 2073 656c   optimizer = sel
+0000a840: 662e 5f69 6e69 745f 6f70 7469 6d69 7a65  f._init_optimize
+0000a850: 7228 6d6f 6465 6c2c 2073 706c 6974 3d73  r(model, split=s
+0000a860: 706c 6974 2c20 7265 7375 6d65 3d72 6573  plit, resume=res
+0000a870: 756d 6529 0a20 2020 2020 2020 2073 656c  ume).        sel
+0000a880: 662e 6361 6c6c 6261 636b 5f68 616e 646c  f.callback_handl
+0000a890: 6572 2e6f 6e5f 7472 6169 6e5f 6265 6769  er.on_train_begi
+0000a8a0: 6e28 0a20 2020 2020 2020 2020 2020 2073  n(.            s
+0000a8b0: 656c 662e 7061 7261 6d65 7465 7273 2c0a  elf.parameters,.
+0000a8c0: 2020 2020 2020 2020 2020 2020 6372 6974              crit
+0000a8d0: 6572 696f 6e3d 6372 6974 6572 696f 6e2c  erion=criterion,
+0000a8e0: 0a20 2020 2020 2020 2020 2020 206f 7074  .            opt
+0000a8f0: 696d 697a 6572 3d6f 7074 696d 697a 6572  imizer=optimizer
+0000a900: 2c0a 2020 2020 2020 2020 2020 2020 7370  ,.            sp
+0000a910: 6c69 743d 7370 6c69 742c 0a20 2020 2020  lit=split,.     
+0000a920: 2020 2020 2020 206d 6170 735f 7061 7468         maps_path
+0000a930: 3d73 656c 662e 6d61 7073 5f70 6174 682c  =self.maps_path,
+0000a940: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000a950: 2020 2020 6d6f 6465 6c2e 7472 6169 6e28      model.train(
+0000a960: 290a 2020 2020 2020 2020 7472 6169 6e5f  ).        train_
+0000a970: 6c6f 6164 6572 2e64 6174 6173 6574 2e74  loader.dataset.t
+0000a980: 7261 696e 2829 0a0a 2020 2020 2020 2020  rain()..        
+0000a990: 6561 726c 795f 7374 6f70 7069 6e67 203d  early_stopping =
+0000a9a0: 2045 6172 6c79 5374 6f70 7069 6e67 280a   EarlyStopping(.
+0000a9b0: 2020 2020 2020 2020 2020 2020 226d 696e              "min
+0000a9c0: 222c 206d 696e 5f64 656c 7461 3d73 656c  ", min_delta=sel
+0000a9d0: 662e 746f 6c65 7261 6e63 652c 2070 6174  f.tolerance, pat
+0000a9e0: 6965 6e63 653d 7365 6c66 2e70 6174 6965  ience=self.patie
+0000a9f0: 6e63 650a 2020 2020 2020 2020 290a 2020  nce.        ).  
+0000aa00: 2020 2020 2020 6d65 7472 6963 735f 7661        metrics_va
+0000aa10: 6c69 6420 3d20 7b22 6c6f 7373 223a 204e  lid = {"loss": N
+0000aa20: 6f6e 657d 0a0a 2020 2020 2020 2020 6966  one}..        if
+0000aa30: 2063 6c75 7374 6572 2e6d 6173 7465 723a   cluster.master:
+0000aa40: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000aa50: 5f77 7269 7465 7220 3d20 4c6f 6757 7269  _writer = LogWri
+0000aa60: 7465 7228 0a20 2020 2020 2020 2020 2020  ter(.           
+0000aa70: 2020 2020 2073 656c 662e 6d61 7073 5f70       self.maps_p
+0000aa80: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+0000aa90: 2020 2020 2073 656c 662e 7461 736b 5f6d       self.task_m
+0000aaa0: 616e 6167 6572 2e65 7661 6c75 6174 696f  anager.evaluatio
+0000aab0: 6e5f 6d65 7472 6963 7320 2b20 5b22 6c6f  n_metrics + ["lo
+0000aac0: 7373 225d 2c0a 2020 2020 2020 2020 2020  ss"],.          
+0000aad0: 2020 2020 2020 7370 6c69 742c 0a20 2020        split,.   
+0000aae0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0000aaf0: 756d 653d 7265 7375 6d65 2c0a 2020 2020  ume=resume,.    
+0000ab00: 2020 2020 2020 2020 2020 2020 6265 6769              begi
+0000ab10: 6e6e 696e 675f 6570 6f63 683d 6265 6769  nning_epoch=begi
+0000ab20: 6e6e 696e 675f 6570 6f63 682c 0a20 2020  nning_epoch,.   
+0000ab30: 2020 2020 2020 2020 2020 2020 206e 6574               net
+0000ab40: 776f 726b 3d6e 6574 776f 726b 2c0a 2020  work=network,.  
+0000ab50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000ab60: 2020 2020 2020 2020 7265 7461 696e 5f62          retain_b
+0000ab70: 6573 7420 3d20 5265 7461 696e 4265 7374  est = RetainBest
+0000ab80: 2873 656c 6563 7469 6f6e 5f6d 6574 7269  (selection_metri
+0000ab90: 6373 3d6c 6973 7428 7365 6c66 2e73 656c  cs=list(self.sel
+0000aba0: 6563 7469 6f6e 5f6d 6574 7269 6373 2929  ection_metrics))
+0000abb0: 0a20 2020 2020 2020 2065 706f 6368 203d  .        epoch =
+0000abc0: 2062 6567 696e 6e69 6e67 5f65 706f 6368   beginning_epoch
+0000abd0: 0a0a 2020 2020 2020 2020 7265 7461 696e  ..        retain
+0000abe0: 5f62 6573 7420 3d20 5265 7461 696e 4265  _best = RetainBe
+0000abf0: 7374 2873 656c 6563 7469 6f6e 5f6d 6574  st(selection_met
+0000ac00: 7269 6373 3d6c 6973 7428 7365 6c66 2e73  rics=list(self.s
+0000ac10: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+0000ac20: 2929 0a0a 2020 2020 2020 2020 7363 616c  ))..        scal
+0000ac30: 6572 203d 2047 7261 6453 6361 6c65 7228  er = GradScaler(
+0000ac40: 656e 6162 6c65 643d 7365 6c66 2e73 7464  enabled=self.std
+0000ac50: 5f61 6d70 290a 2020 2020 2020 2020 7072  _amp).        pr
+0000ac60: 6f66 696c 6572 203d 2073 656c 662e 5f69  ofiler = self._i
+0000ac70: 6e69 745f 7072 6f66 696c 6572 2829 0a0a  nit_profiler()..
+0000ac80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000ac90: 7061 7261 6d65 7465 7273 5b22 7472 6163  parameters["trac
+0000aca0: 6b5f 6578 7022 5d20 3d3d 2022 7761 6e64  k_exp"] == "wand
+0000acb0: 6222 3a0a 2020 2020 2020 2020 2020 2020  b":.            
+0000acc0: 6672 6f6d 2063 6c69 6e69 6361 646c 2e75  from clinicadl.u
+0000acd0: 7469 6c73 2e74 7261 636b 696e 675f 6578  tils.tracking_ex
+0000ace0: 7020 696d 706f 7274 2057 616e 6442 5f68  p import WandB_h
+0000acf0: 616e 646c 6572 0a0a 2020 2020 2020 2020  andler..        
+0000ad00: 6966 2073 656c 662e 7061 7261 6d65 7465  if self.paramete
+0000ad10: 7273 5b22 6164 6170 7469 7665 5f6c 6561  rs["adaptive_lea
+0000ad20: 726e 696e 675f 7261 7465 225d 3a0a 2020  rning_rate"]:.  
+0000ad30: 2020 2020 2020 2020 2020 6672 6f6d 2074            from t
+0000ad40: 6f72 6368 2e6f 7074 696d 2e6c 725f 7363  orch.optim.lr_sc
+0000ad50: 6865 6475 6c65 7220 696d 706f 7274 2052  heduler import R
+0000ad60: 6564 7563 654c 524f 6e50 6c61 7465 6175  educeLROnPlateau
+0000ad70: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000ad80: 496e 6974 6961 6c69 7a65 2074 6865 2052  Initialize the R
+0000ad90: 6564 7563 654c 524f 6e50 6c61 7465 6175  educeLROnPlateau
+0000ada0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+0000adb0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+0000adc0: 203d 2052 6564 7563 654c 524f 6e50 6c61   = ReduceLROnPla
+0000add0: 7465 6175 280a 2020 2020 2020 2020 2020  teau(.          
+0000ade0: 2020 2020 2020 6f70 7469 6d69 7a65 722c        optimizer,
+0000adf0: 206d 6f64 653d 226d 696e 222c 2066 6163   mode="min", fac
+0000ae00: 746f 723d 302e 312c 2076 6572 626f 7365  tor=0.1, verbose
+0000ae10: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
+0000ae20: 2020 290a 0a20 2020 2020 2020 2073 6361    )..        sca
+0000ae30: 6c65 7220 3d20 4772 6164 5363 616c 6572  ler = GradScaler
+0000ae40: 2865 6e61 626c 6564 3d73 656c 662e 616d  (enabled=self.am
+0000ae50: 7029 0a20 2020 2020 2020 2070 726f 6669  p).        profi
+0000ae60: 6c65 7220 3d20 7365 6c66 2e5f 696e 6974  ler = self._init
+0000ae70: 5f70 726f 6669 6c65 7228 290a 0a20 2020  _profiler()..   
+0000ae80: 2020 2020 2077 6869 6c65 2065 706f 6368       while epoch
+0000ae90: 203c 2073 656c 662e 6570 6f63 6873 2061   < self.epochs a
+0000aea0: 6e64 206e 6f74 2065 6172 6c79 5f73 746f  nd not early_sto
+0000aeb0: 7070 696e 672e 7374 6570 286d 6574 7269  pping.step(metri
+0000aec0: 6373 5f76 616c 6964 5b22 6c6f 7373 225d  cs_valid["loss"]
+0000aed0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0000aee0: 2073 656c 662e 6361 6c6c 6261 636b 5f68   self.callback_h
+0000aef0: 616e 646c 6572 2e6f 6e5f 6570 6f63 685f  andler.on_epoch_
+0000af00: 6265 6769 6e28 7365 6c66 2e70 6172 616d  begin(self.param
+0000af10: 6574 6572 732c 2065 706f 6368 203d 2065  eters, epoch = e
+0000af20: 706f 6368 290a 0a20 2020 2020 2020 2020  poch)..         
+0000af30: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000af40: 2874 7261 696e 5f6c 6f61 6465 722e 7361  (train_loader.sa
+0000af50: 6d70 6c65 722c 2044 6973 7472 6962 7574  mpler, Distribut
+0000af60: 6564 5361 6d70 6c65 7229 3a0a 2020 2020  edSampler):.    
+0000af70: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+0000af80: 2073 686f 756c 6420 616c 7761 7973 2062   should always b
+0000af90: 6520 7472 7565 2066 6f72 2061 2072 616e  e true for a ran
+0000afa0: 646f 6d20 7361 6d70 6c65 722e 2042 7574  dom sampler. But
+0000afb0: 206a 7573 7420 696e 2063 6173 650a 2020   just in case.  
+0000afc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000afd0: 7765 2067 6574 2061 2057 6569 6768 7465  we get a Weighte
+0000afe0: 6452 616e 646f 6d53 616d 706c 6572 206f  dRandomSampler o
+0000aff0: 7220 6120 666f 7267 6f74 7465 6e20 5261  r a forgotten Ra
+0000b000: 6e64 6f6d 5361 6d70 6c65 722c 0a20 2020  ndomSampler,.   
+0000b010: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+0000b020: 6520 646f 206e 6f74 2077 616e 7420 746f  e do not want to
+0000b030: 2065 7865 6375 7465 2074 6869 7320 6c69   execute this li
+0000b040: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
+0000b050: 2020 2020 7472 6169 6e5f 6c6f 6164 6572      train_loader
+0000b060: 2e73 616d 706c 6572 2e73 6574 5f65 706f  .sampler.set_epo
+0000b070: 6368 2865 706f 6368 290a 0a20 2020 2020  ch(epoch)..     
+0000b080: 2020 2020 2020 206d 6f64 656c 2e7a 6572         model.zer
+0000b090: 6f5f 6772 6164 2873 6574 5f74 6f5f 6e6f  o_grad(set_to_no
+0000b0a0: 6e65 3d54 7275 6529 0a20 2020 2020 2020  ne=True).       
+0000b0b0: 2020 2020 2065 7661 6c75 6174 696f 6e5f       evaluation_
+0000b0c0: 666c 6167 2c20 7374 6570 5f66 6c61 6720  flag, step_flag 
+0000b0d0: 3d20 5472 7565 2c20 5472 7565 0a0a 2020  = True, True..  
+0000b0e0: 2020 2020 2020 2020 2020 7769 7468 2070            with p
+0000b0f0: 726f 6669 6c65 723a 0a20 2020 2020 2020  rofiler:.       
+0000b100: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+0000b110: 6461 7461 2069 6e20 656e 756d 6572 6174  data in enumerat
+0000b120: 6528 7472 6169 6e5f 6c6f 6164 6572 293a  e(train_loader):
+0000b130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b140: 2020 2020 2075 7064 6174 653a 2062 6f6f       update: boo
+0000b150: 6c20 3d20 2869 202b 2031 2920 2520 7365  l = (i + 1) % se
+0000b160: 6c66 2e61 6363 756d 756c 6174 696f 6e5f  lf.accumulation_
+0000b170: 7374 6570 7320 3d3d 2030 0a20 2020 2020  steps == 0.     
+0000b180: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b190: 796e 6320 3d20 6e75 6c6c 636f 6e74 6578  ync = nullcontex
+0000b1a0: 7428 2920 6966 2075 7064 6174 6520 656c  t() if update el
+0000b1b0: 7365 206d 6f64 656c 2e6e 6f5f 7379 6e63  se model.no_sync
+0000b1c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000b1d0: 2020 2020 2020 2077 6974 6820 7379 6e63         with sync
+0000b1e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b1f0: 2020 2020 2020 2020 2020 7769 7468 2061            with a
+0000b200: 7574 6f63 6173 7428 656e 6162 6c65 643d  utocast(enabled=
+0000b210: 7365 6c66 2e73 7464 5f61 6d70 293a 0a20  self.std_amp):. 
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2020 2020 2020 2020 2020 205f 2c20 6c6f             _, lo
+0000b240: 7373 5f64 6963 7420 3d20 6d6f 6465 6c28  ss_dict = model(
+0000b250: 6461 7461 2c20 6372 6974 6572 696f 6e29  data, criterion)
+0000b260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b270: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000b280: 6465 6275 6728 6622 5472 6169 6e20 6c6f  debug(f"Train lo
+0000b290: 7373 2064 6963 7469 6f6e 6172 7920 7b6c  ss dictionary {l
+0000b2a0: 6f73 735f 6469 6374 7d22 290a 2020 2020  oss_dict}").    
+0000b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2c0: 2020 2020 6c6f 7373 203d 206c 6f73 735f      loss = loss_
+0000b2d0: 6469 6374 5b22 6c6f 7373 225d 0a20 2020  dict["loss"].   
+0000b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2f0: 2020 2020 2073 6361 6c65 722e 7363 616c       scaler.scal
+0000b300: 6528 6c6f 7373 292e 6261 636b 7761 7264  e(loss).backward
+0000b310: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+0000b320: 2020 2020 2020 2020 6966 2075 7064 6174          if updat
+0000b330: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000b340: 2020 2020 2020 2020 2020 2073 7465 705f             step_
+0000b350: 666c 6167 203d 2046 616c 7365 0a20 2020  flag = False.   
+0000b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b370: 2020 2020 2073 6361 6c65 722e 7374 6570       scaler.step
+0000b380: 286f 7074 696d 697a 6572 290a 2020 2020  (optimizer).    
+0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3a0: 2020 2020 7363 616c 6572 2e75 7064 6174      scaler.updat
+0000b3b0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000b3c0: 2020 2020 2020 2020 2020 2020 6f70 7469              opti
+0000b3d0: 6d69 7a65 722e 7a65 726f 5f67 7261 6428  mizer.zero_grad(
+0000b3e0: 7365 745f 746f 5f6e 6f6e 653d 5472 7565  set_to_none=True
+0000b3f0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b400: 2020 2020 2020 2020 2020 2064 656c 206c             del l
+0000b410: 6f73 730a 0a20 2020 2020 2020 2020 2020  oss..           
+0000b420: 2020 2020 2020 2020 2020 2020 2023 2045               # E
+0000b430: 7661 6c75 6174 6520 7468 6520 6d6f 6465  valuate the mode
+0000b440: 6c20 6f6e 6c79 2077 6865 6e20 6e6f 2067  l only when no g
+0000b450: 7261 6469 656e 7473 2061 7265 2061 6363  radients are acc
+0000b460: 756d 756c 6174 6564 0a20 2020 2020 2020  umulated.       
+0000b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b480: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+0000b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4a0: 2020 7365 6c66 2e65 7661 6c75 6174 696f    self.evaluatio
+0000b4b0: 6e5f 7374 6570 7320 213d 2030 0a20 2020  n_steps != 0.   
+0000b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4d0: 2020 2020 2020 2020 2061 6e64 2028 6920           and (i 
+0000b4e0: 2b20 3129 2025 2073 656c 662e 6576 616c  + 1) % self.eval
+0000b4f0: 7561 7469 6f6e 5f73 7465 7073 203d 3d20  uation_steps == 
+0000b500: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000b510: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b530: 2020 2020 2020 2020 2065 7661 6c75 6174           evaluat
+0000b540: 696f 6e5f 666c 6167 203d 2046 616c 7365  ion_flag = False
+0000b550: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b560: 2020 2020 2020 2020 2020 2020 2020 5f2c                _,
+0000b570: 206d 6574 7269 6373 5f74 7261 696e 203d   metrics_train =
+0000b580: 2073 656c 662e 7461 736b 5f6d 616e 6167   self.task_manag
+0000b590: 6572 2e74 6573 7428 0a20 2020 2020 2020  er.test(.       
 0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2020 206d 6f64 656c 2e74 7261 696e 2829     model.train()
-0000b5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b5d0: 2020 2020 2020 2020 2020 2020 2074 7261               tra
-0000b5e0: 696e 5f6c 6f61 6465 722e 6461 7461 7365  in_loader.datase
-0000b5f0: 742e 7472 6169 6e28 290a 0a20 2020 2020  t.train()..     
-0000b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b610: 2020 2020 2020 2069 6620 636c 7573 7465         if cluste
-0000b620: 722e 6d61 7374 6572 3a0a 2020 2020 2020  r.master:.      
-0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b640: 2020 2020 2020 2020 2020 6c6f 675f 7772            log_wr
-0000b650: 6974 6572 2e73 7465 7028 0a20 2020 2020  iter.step(.     
-0000b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b670: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000b680: 706f 6368 2c0a 2020 2020 2020 2020 2020  poch,.          
-0000b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6a0: 2020 2020 2020 2020 2020 692c 0a20 2020            i,.   
-0000b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5b0: 2020 2020 2020 2020 206d 6f64 656c 2c20           model, 
+0000b5c0: 7472 6169 6e5f 6c6f 6164 6572 2c20 6372  train_loader, cr
+0000b5d0: 6974 6572 696f 6e2c 2061 6d70 3d73 656c  iterion, amp=sel
+0000b5e0: 662e 7374 645f 616d 700a 2020 2020 2020  f.std_amp.      
+0000b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b600: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b620: 2020 2020 5f2c 206d 6574 7269 6373 5f76      _, metrics_v
+0000b630: 616c 6964 203d 2073 656c 662e 7461 736b  alid = self.task
+0000b640: 5f6d 616e 6167 6572 2e74 6573 7428 0a20  _manager.test(. 
+0000b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b660: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000b670: 6f64 656c 2c20 7661 6c69 645f 6c6f 6164  odel, valid_load
+0000b680: 6572 2c20 6372 6974 6572 696f 6e2c 2061  er, criterion, a
+0000b690: 6d70 3d73 656c 662e 7374 645f 616d 700a  mp=self.std_amp.
+0000b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6b0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
 0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6d0: 206d 6574 7269 6373 5f74 7261 696e 2c0a   metrics_train,.
-0000b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6d0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0000b6e0: 2e74 7261 696e 2829 0a20 2020 2020 2020  .train().       
 0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b700: 2020 2020 6d65 7472 6963 735f 7661 6c69      metrics_vali
-0000b710: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b730: 2020 2020 2020 206c 656e 2874 7261 696e         len(train
-0000b740: 5f6c 6f61 6465 7229 2c0a 2020 2020 2020  _loader),.      
-0000b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b760: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b780: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0000b790: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7b0: 2020 2020 2066 227b 7365 6c66 2e6d 6f64       f"{self.mod
-0000b7c0: 657d 206c 6576 656c 2074 7261 696e 696e  e} level trainin
-0000b7d0: 6720 6c6f 7373 2069 7320 7b6d 6574 7269  g loss is {metri
-0000b7e0: 6373 5f74 7261 696e 5b27 6c6f 7373 275d  cs_train['loss']
-0000b7f0: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-0000b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b810: 2020 2020 6622 6174 2074 6865 2065 6e64      f"at the end
-0000b820: 206f 6620 6974 6572 6174 696f 6e20 7b69   of iteration {i
-0000b830: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-0000b840: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000b850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b860: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000b870: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+0000b700: 2020 2020 2074 7261 696e 5f6c 6f61 6465       train_loade
+0000b710: 722e 6461 7461 7365 742e 7472 6169 6e28  r.dataset.train(
+0000b720: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b730: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b740: 6620 636c 7573 7465 722e 6d61 7374 6572  f cluster.master
+0000b750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b770: 2020 6c6f 675f 7772 6974 6572 2e73 7465    log_writer.ste
+0000b780: 7028 0a20 2020 2020 2020 2020 2020 2020  p(.             
+0000b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7a0: 2020 2020 2020 2065 706f 6368 2c0a 2020         epoch,.  
+0000b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7d0: 2020 692c 0a20 2020 2020 2020 2020 2020    i,.           
+0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7f0: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+0000b800: 5f74 7261 696e 2c0a 2020 2020 2020 2020  _train,.        
+0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b820: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
+0000b830: 6963 735f 7661 6c69 642c 0a20 2020 2020  ics_valid,.     
+0000b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b850: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000b860: 656e 2874 7261 696e 5f6c 6f61 6465 7229  en(train_loader)
+0000b870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0000b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b890: 2020 2020 2020 2020 2020 6622 7b73 656c            f"{sel
-0000b8a0: 662e 6d6f 6465 7d20 6c65 7665 6c20 7661  f.mode} level va
-0000b8b0: 6c69 6461 7469 6f6e 206c 6f73 7320 6973  lidation loss is
-0000b8c0: 207b 6d65 7472 6963 735f 7661 6c69 645b   {metrics_valid[
-0000b8d0: 276c 6f73 7327 5d7d 2022 0a20 2020 2020  'loss']} ".     
-0000b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8f0: 2020 2020 2020 2020 2020 2066 2261 7420             f"at 
-0000b900: 7468 6520 656e 6420 6f66 2069 7465 7261  the end of itera
-0000b910: 7469 6f6e 207b 697d 220a 2020 2020 2020  tion {i}".      
+0000b890: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8b0: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+0000b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8d0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+0000b8e0: 7365 6c66 2e6d 6f64 657d 206c 6576 656c  self.mode} level
+0000b8f0: 2074 7261 696e 696e 6720 6c6f 7373 2069   training loss i
+0000b900: 7320 7b6d 6574 7269 6373 5f74 7261 696e  s {metrics_train
+0000b910: 5b27 6c6f 7373 275d 7d20 220a 2020 2020  ['loss']} ".    
 0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000b940: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0000b950: 6669 6c65 722e 7374 6570 2829 0a0a 2020  filer.step()..  
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000b970: 4966 206e 6f20 7374 6570 2068 6173 2062  If no step has b
-0000b980: 6565 6e20 7065 7266 6f72 6d65 642c 2072  een performed, r
-0000b990: 6169 7365 2045 7863 6570 7469 6f6e 0a20  aise Exception. 
-0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b9b0: 6620 7374 6570 5f66 6c61 673a 0a20 2020  f step_flag:.   
-0000b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9d0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0000b9e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000b9f0: 2020 2020 2020 2020 2020 2254 6865 206d            "The m
-0000ba00: 6f64 656c 2068 6173 206e 6f74 2062 6565  odel has not bee
-0000ba10: 6e20 7570 6461 7465 6420 6f6e 6365 2069  n updated once i
-0000ba20: 6e20 7468 6520 6570 6f63 682e 2054 6865  n the epoch. The
-0000ba30: 2061 6363 756d 756c 6174 696f 6e20 7374   accumulation st
-0000ba40: 6570 206d 6179 2062 6520 746f 6f20 6c61  ep may be too la
-0000ba50: 7267 652e 220a 2020 2020 2020 2020 2020  rge.".          
-0000ba60: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000ba70: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0000ba80: 6620 6e6f 2065 7661 6c75 6174 696f 6e20  f no evaluation 
-0000ba90: 6861 7320 6265 656e 2070 6572 666f 726d  has been perform
-0000baa0: 6564 2c20 7761 726e 2074 6865 2075 7365  ed, warn the use
-0000bab0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0000bac0: 2020 656c 6966 2065 7661 6c75 6174 696f    elif evaluatio
-0000bad0: 6e5f 666c 6167 2061 6e64 2073 656c 662e  n_flag and self.
-0000bae0: 6576 616c 7561 7469 6f6e 5f73 7465 7073  evaluation_steps
-0000baf0: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-0000bb00: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000bb10: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
-0000bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb30: 2020 2066 2259 6f75 7220 6576 616c 7561     f"Your evalua
-0000bb40: 7469 6f6e 2073 7465 7073 207b 7365 6c66  tion steps {self
-0000bb50: 2e65 7661 6c75 6174 696f 6e5f 7374 6570  .evaluation_step
-0000bb60: 737d 2061 7265 2074 6f6f 2062 6967 2022  s} are too big "
-0000bb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bb80: 2020 2020 2020 2020 2066 2263 6f6d 7061           f"compa
-0000bb90: 7265 6420 746f 2074 6865 2073 697a 6520  red to the size 
-0000bba0: 6f66 2074 6865 2064 6174 6173 6574 2e20  of the dataset. 
-0000bbb0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000bbc0: 2020 2020 2020 2020 2020 6622 5468 6520            f"The 
-0000bbd0: 6d6f 6465 6c20 6973 2065 7661 6c75 6174  model is evaluat
-0000bbe0: 6564 206f 6e6c 7920 6f6e 6365 2061 7420  ed only once at 
-0000bbf0: 7468 6520 656e 6420 6570 6f63 6873 2e22  the end epochs."
-0000bc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000bc20: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
-0000bc30: 2077 6569 6768 7473 206f 6e65 206c 6173   weights one las
-0000bc40: 7420 7469 6d65 2069 6620 6772 6164 6965  t time if gradie
-0000bc50: 6e74 7320 7765 7265 2063 6f6d 7075 7465  nts were compute
-0000bc60: 6420 7769 7468 6f75 7420 7570 6461 7465  d without update
-0000bc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc80: 2069 6620 2869 202b 2031 2920 2520 7365   if (i + 1) % se
-0000bc90: 6c66 2e61 6363 756d 756c 6174 696f 6e5f  lf.accumulation_
-0000bca0: 7374 6570 7320 213d 2030 3a0a 2020 2020  steps != 0:.    
-0000bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcc0: 7363 616c 6572 2e73 7465 7028 6f70 7469  scaler.step(opti
-0000bcd0: 6d69 7a65 7229 0a20 2020 2020 2020 2020  mizer).         
-0000bce0: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
-0000bcf0: 722e 7570 6461 7465 2829 0a20 2020 2020  r.update().     
-0000bd00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000bd10: 7074 696d 697a 6572 2e7a 6572 6f5f 6772  ptimizer.zero_gr
-0000bd20: 6164 2873 6574 5f74 6f5f 6e6f 6e65 3d54  ad(set_to_none=T
-0000bd30: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
-0000bd40: 2020 2020 2020 2320 416c 7761 7973 2074        # Always t
-0000bd50: 6573 7420 7468 6520 7265 7375 6c74 7320  est the results 
-0000bd60: 616e 6420 7361 7665 2074 6865 6d20 6f6e  and save them on
-0000bd70: 6365 2061 7420 7468 6520 656e 6420 6f66  ce at the end of
-0000bd80: 2074 6865 2065 706f 6368 0a20 2020 2020   the epoch.     
-0000bd90: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0000bda0: 2e7a 6572 6f5f 6772 6164 2873 6574 5f74  .zero_grad(set_t
-0000bdb0: 6f5f 6e6f 6e65 3d54 7275 6529 0a20 2020  o_none=True).   
-0000bdc0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000bdd0: 6765 722e 6465 6275 6728 6622 4c61 7374  ger.debug(f"Last
-0000bde0: 2063 6865 636b 706f 696e 7420 6174 2074   checkpoint at t
-0000bdf0: 6865 2065 6e64 206f 6620 7468 6520 6570  he end of the ep
-0000be00: 6f63 6820 7b65 706f 6368 7d22 290a 0a20  och {epoch}").. 
-0000be10: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000be20: 2c20 6d65 7472 6963 735f 7472 6169 6e20  , metrics_train 
-0000be30: 3d20 7365 6c66 2e74 6173 6b5f 6d61 6e61  = self.task_mana
-0000be40: 6765 722e 7465 7374 280a 2020 2020 2020  ger.test(.      
-0000be50: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0000be60: 6465 6c2c 2074 7261 696e 5f6c 6f61 6465  del, train_loade
-0000be70: 722c 2063 7269 7465 7269 6f6e 2c20 616d  r, criterion, am
-0000be80: 703d 7365 6c66 2e61 6d70 0a20 2020 2020  p=self.amp.     
-0000be90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000bea0: 2020 2020 2020 2020 2020 2020 205f 2c20               _, 
-0000beb0: 6d65 7472 6963 735f 7661 6c69 6420 3d20  metrics_valid = 
-0000bec0: 7365 6c66 2e74 6173 6b5f 6d61 6e61 6765  self.task_manage
-0000bed0: 722e 7465 7374 280a 2020 2020 2020 2020  r.test(.        
-0000bee0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000bef0: 6c2c 2076 616c 6964 5f6c 6f61 6465 722c  l, valid_loader,
-0000bf00: 2063 7269 7465 7269 6f6e 2c20 616d 703d   criterion, amp=
-0000bf10: 7365 6c66 2e61 6d70 0a20 2020 2020 2020  self.amp.       
-0000bf20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000bf30: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000bf40: 6c2e 7472 6169 6e28 290a 2020 2020 2020  l.train().      
-0000bf50: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-0000bf60: 6c6f 6164 6572 2e64 6174 6173 6574 2e74  loader.dataset.t
-0000bf70: 7261 696e 2829 0a0a 2020 2020 2020 2020  rain()..        
-0000bf80: 2020 2020 7365 6c66 2e63 616c 6c62 6163      self.callbac
-0000bf90: 6b5f 6861 6e64 6c65 722e 6f6e 5f65 706f  k_handler.on_epo
-0000bfa0: 6368 5f65 6e64 280a 2020 2020 2020 2020  ch_end(.        
-0000bfb0: 2020 2020 2020 2020 7365 6c66 2e70 6172          self.par
-0000bfc0: 616d 6574 6572 732c 0a20 2020 2020 2020  ameters,.       
-0000bfd0: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
-0000bfe0: 5f74 7261 696e 3d6d 6574 7269 6373 5f74  _train=metrics_t
-0000bff0: 7261 696e 2c0a 2020 2020 2020 2020 2020  rain,.          
-0000c000: 2020 2020 2020 6d65 7472 6963 735f 7661        metrics_va
-0000c010: 6c69 643d 6d65 7472 6963 735f 7661 6c69  lid=metrics_vali
-0000c020: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000c030: 2020 206d 6f64 653d 7365 6c66 2e6d 6f64     mode=self.mod
-0000c040: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000c050: 2020 2069 3d69 2c0a 2020 2020 2020 2020     i=i,.        
-0000c060: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000c070: 2020 2069 6620 636c 7573 7465 722e 6d61     if cluster.ma
-0000c080: 7374 6572 3a0a 2020 2020 2020 2020 2020  ster:.          
-0000c090: 2020 2020 2020 2320 5361 7665 2063 6865        # Save che
-0000c0a0: 636b 706f 696e 7473 2061 6e64 2062 6573  ckpoints and bes
-0000c0b0: 7420 6d6f 6465 6c73 0a20 2020 2020 2020  t models.       
-0000c0c0: 2020 2020 2020 2020 2062 6573 745f 6469           best_di
-0000c0d0: 6374 203d 2072 6574 6169 6e5f 6265 7374  ct = retain_best
-0000c0e0: 2e73 7465 7028 6d65 7472 6963 735f 7661  .step(metrics_va
-0000c0f0: 6c69 6429 0a20 2020 2020 2020 2020 2020  lid).           
-0000c100: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
-0000c110: 5f77 6569 6768 7473 280a 2020 2020 2020  _weights(.      
-0000c120: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0000c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c140: 2020 2020 2020 2020 226d 6f64 656c 223a          "model":
-0000c150: 206d 6f64 656c 2e73 7461 7465 5f64 6963   model.state_dic
-0000c160: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
-0000c170: 2020 2020 2020 2020 2020 2020 2022 6570               "ep
-0000c180: 6f63 6822 3a20 6570 6f63 682c 0a20 2020  och": epoch,.   
-0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1a0: 2020 2020 2022 6e61 6d65 223a 2073 656c       "name": sel
-0000c1b0: 662e 6172 6368 6974 6563 7475 7265 2c0a  f.architecture,.
-0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1d0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0000c1e0: 2020 2020 2020 2020 2020 2062 6573 745f             best_
-0000c1f0: 6469 6374 2c0a 2020 2020 2020 2020 2020  dict,.          
-0000c200: 2020 2020 2020 2020 2020 7370 6c69 742c            split,
-0000c210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c220: 2020 2020 206e 6574 776f 726b 3d6e 6574       network=net
-0000c230: 776f 726b 2c0a 2020 2020 2020 2020 2020  work,.          
-0000c240: 2020 2020 2020 2020 2020 7361 7665 5f61            save_a
-0000c250: 6c6c 5f6d 6f64 656c 733d 7365 6c66 2e70  ll_models=self.p
-0000c260: 6172 616d 6574 6572 735b 2273 6176 655f  arameters["save_
-0000c270: 616c 6c5f 6d6f 6465 6c73 225d 2c0a 2020  all_models"],.  
-0000c280: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2a0: 7365 6c66 2e5f 7772 6974 655f 7765 6967  self._write_weig
-0000c2b0: 6874 7328 0a20 2020 2020 2020 2020 2020  hts(.           
-0000c2c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0000c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2e0: 2020 2022 6f70 7469 6d69 7a65 7222 3a20     "optimizer": 
-0000c2f0: 6f70 7469 6d69 7a65 722e 7374 6174 655f  optimizer.state_
-0000c300: 6469 6374 2829 2c0a 2020 2020 2020 2020  dict(),.        
-0000c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c320: 2265 706f 6368 223a 2065 706f 6368 2c0a  "epoch": epoch,.
-0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-0000c350: 7365 6c66 2e6f 7074 696d 697a 6572 2c0a  self.optimizer,.
-0000c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c370: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0000c380: 2020 2020 2020 2020 2020 204e 6f6e 652c             None,
-0000c390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c3a0: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3c0: 6669 6c65 6e61 6d65 3d22 6f70 7469 6d69  filename="optimi
-0000c3d0: 7a65 722e 7074 682e 7461 7222 2c0a 2020  zer.pth.tar",.  
-0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3f0: 2020 7361 7665 5f61 6c6c 5f6d 6f64 656c    save_all_model
-0000c400: 733d 7365 6c66 2e70 6172 616d 6574 6572  s=self.parameter
-0000c410: 735b 2273 6176 655f 616c 6c5f 6d6f 6465  s["save_all_mode
-0000c420: 6c73 225d 2c0a 2020 2020 2020 2020 2020  ls"],.          
-0000c430: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000c440: 2020 2020 6966 2073 656c 662e 7061 7261      if self.para
-0000c450: 6d65 7465 7273 5b22 6164 6170 7469 7665  meters["adaptive
-0000c460: 5f6c 6561 726e 696e 675f 7261 7465 225d  _learning_rate"]
-0000c470: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c480: 2020 7363 6865 6475 6c65 722e 7374 6570    scheduler.step
-0000c490: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c4a0: 2020 2020 2020 6d65 7472 6963 735f 7661        metrics_va
-0000c4b0: 6c69 645b 226c 6f73 7322 5d0a 2020 2020  lid["loss"].    
-0000c4c0: 2020 2020 2020 2020 2020 2020 2920 2023              )  #
-0000c4d0: 2055 7064 6174 6520 6c65 6172 6e69 6e67   Update learning
-0000c4e0: 2072 6174 6520 6261 7365 6420 6f6e 2076   rate based on v
-0000c4f0: 616c 6964 6174 696f 6e20 6c6f 7373 0a0a  alidation loss..
-0000c500: 2020 2020 2020 2020 2020 2020 6570 6f63              epoc
-0000c510: 6820 2b3d 2031 0a0a 2020 2020 2020 2020  h += 1..        
-0000c520: 6465 6c20 6d6f 6465 6c0a 2020 2020 2020  del model.      
-0000c530: 2020 7365 6c66 2e5f 7465 7374 5f6c 6f61    self._test_loa
-0000c540: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
-0000c550: 2074 7261 696e 5f6c 6f61 6465 722c 0a20   train_loader,. 
-0000c560: 2020 2020 2020 2020 2020 2063 7269 7465             crite
-0000c570: 7269 6f6e 2c0a 2020 2020 2020 2020 2020  rion,.          
-0000c580: 2020 2274 7261 696e 222c 0a20 2020 2020    "train",.     
-0000c590: 2020 2020 2020 2073 706c 6974 2c0a 2020         split,.  
-0000c5a0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0000c5b0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
-0000c5c0: 2c0a 2020 2020 2020 2020 2020 2020 616d  ,.            am
-0000c5d0: 703d 7365 6c66 2e61 6d70 2c0a 2020 2020  p=self.amp,.    
-0000c5e0: 2020 2020 2020 2020 6e65 7477 6f72 6b3d          network=
-0000c5f0: 6e65 7477 6f72 6b2c 0a20 2020 2020 2020  network,.       
-0000c600: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0000c610: 5f74 6573 745f 6c6f 6164 6572 280a 2020  _test_loader(.  
-0000c620: 2020 2020 2020 2020 2020 7661 6c69 645f            valid_
-0000c630: 6c6f 6164 6572 2c0a 2020 2020 2020 2020  loader,.        
-0000c640: 2020 2020 6372 6974 6572 696f 6e2c 0a20      criterion,. 
-0000c650: 2020 2020 2020 2020 2020 2022 7661 6c69             "vali
-0000c660: 6461 7469 6f6e 222c 0a20 2020 2020 2020  dation",.       
-0000c670: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-0000c680: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
-0000c690: 6563 7469 6f6e 5f6d 6574 7269 6373 2c0a  ection_metrics,.
-0000c6a0: 2020 2020 2020 2020 2020 2020 616d 703d              amp=
-0000c6b0: 7365 6c66 2e61 6d70 2c0a 2020 2020 2020  self.amp,.      
-0000c6c0: 2020 2020 2020 6e65 7477 6f72 6b3d 6e65        network=ne
-0000c6d0: 7477 6f72 6b2c 0a20 2020 2020 2020 2029  twork,.        )
-0000c6e0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0000c6f0: 662e 7461 736b 5f6d 616e 6167 6572 2e73  f.task_manager.s
-0000c700: 6176 655f 6f75 7470 7574 733a 0a20 2020  ave_outputs:.   
-0000c710: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-0000c720: 6f6d 7075 7465 5f6f 7574 7075 745f 7465  ompute_output_te
-0000c730: 6e73 6f72 7328 0a20 2020 2020 2020 2020  nsors(.         
-0000c740: 2020 2020 2020 2074 7261 696e 5f6c 6f61         train_loa
-0000c750: 6465 722e 6461 7461 7365 742c 0a20 2020  der.dataset,.   
-0000c760: 2020 2020 2020 2020 2020 2020 2022 7472               "tr
-0000c770: 6169 6e22 2c0a 2020 2020 2020 2020 2020  ain",.          
-0000c780: 2020 2020 2020 7370 6c69 742c 0a20 2020        split,.   
-0000c790: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000c7a0: 662e 7365 6c65 6374 696f 6e5f 6d65 7472  f.selection_metr
-0000c7b0: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
-0000c7c0: 2020 2020 206e 625f 696d 6167 6573 3d31       nb_images=1
-0000c7d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c7e0: 2020 6e65 7477 6f72 6b3d 6e65 7477 6f72    network=networ
-0000c7f0: 6b2c 0a20 2020 2020 2020 2020 2020 2029  k,.            )
-0000c800: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000c810: 662e 5f63 6f6d 7075 7465 5f6f 7574 7075  f._compute_outpu
-0000c820: 745f 7465 6e73 6f72 7328 0a20 2020 2020  t_tensors(.     
-0000c830: 2020 2020 2020 2020 2020 2074 7261 696e             train
-0000c840: 5f6c 6f61 6465 722e 6461 7461 7365 742c  _loader.dataset,
-0000c850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c860: 2022 7661 6c69 6461 7469 6f6e 222c 0a20   "validation",. 
-0000c870: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000c880: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
-0000c890: 2020 2020 2020 7365 6c66 2e73 656c 6563        self.selec
-0000c8a0: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
-0000c8b0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0000c8c0: 5f69 6d61 6765 733d 312c 0a20 2020 2020  _images=1,.     
-0000c8d0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
-0000c8e0: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
-0000c8f0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000c900: 2020 2073 656c 662e 6361 6c6c 6261 636b     self.callback
-0000c910: 5f68 616e 646c 6572 2e6f 6e5f 7472 6169  _handler.on_trai
-0000c920: 6e5f 656e 6428 7061 7261 6d65 7465 7273  n_end(parameters
-0000c930: 3d73 656c 662e 7061 7261 6d65 7465 7273  =self.parameters
-0000c940: 290a 0a20 2020 2064 6566 205f 7472 6169  )..    def _trai
-0000c950: 6e5f 7373 6461 6e6e 280a 2020 2020 2020  n_ssdann(.      
-0000c960: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0000c970: 7472 6169 6e5f 736f 7572 6365 5f6c 6f61  train_source_loa
-0000c980: 6465 722c 0a20 2020 2020 2020 2074 7261  der,.        tra
-0000c990: 696e 5f74 6172 6765 745f 6c6f 6164 6572  in_target_loader
-0000c9a0: 2c0a 2020 2020 2020 2020 7472 6169 6e5f  ,.        train_
-0000c9b0: 7461 7267 6574 5f75 6e6c 5f6c 6f61 6465  target_unl_loade
-0000c9c0: 722c 0a20 2020 2020 2020 2076 616c 6964  r,.        valid
-0000c9d0: 5f6c 6f61 6465 722c 0a20 2020 2020 2020  _loader,.       
-0000c9e0: 2076 616c 6964 5f73 6f75 7263 655f 6c6f   valid_source_lo
-0000c9f0: 6164 6572 2c0a 2020 2020 2020 2020 7370  ader,.        sp
-0000ca00: 6c69 742c 0a20 2020 2020 2020 206e 6574  lit,.        net
-0000ca10: 776f 726b 3d4e 6f6e 652c 0a20 2020 2020  work=None,.     
-0000ca20: 2020 2072 6573 756d 653d 4661 6c73 652c     resume=False,
-0000ca30: 0a20 2020 2020 2020 2065 7661 6c75 6174  .        evaluat
-0000ca40: 655f 736f 7572 6365 3d54 7275 652c 2020  e_source=True,  
-0000ca50: 2320 544f 204d 4f44 4946 590a 2020 2020  # TO MODIFY.    
-0000ca60: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0000ca70: 2020 2020 2020 2043 6f72 6520 6675 6e63         Core func
-0000ca80: 7469 6f6e 2073 6861 7265 6420 6279 2074  tion shared by t
-0000ca90: 7261 696e 2061 6e64 2072 6573 756d 652e  rain and resume.
-0000caa0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0000cab0: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-0000cac0: 6e5f 6c6f 6164 6572 2028 746f 7263 682e  n_loader (torch.
-0000cad0: 7574 696c 732e 6461 7461 2e44 6174 614c  utils.data.DataL
-0000cae0: 6f61 6465 7229 3a20 4461 7461 4c6f 6164  oader): DataLoad
-0000caf0: 6572 2077 7261 7070 696e 6720 7468 6520  er wrapping the 
-0000cb00: 7472 6169 6e69 6e67 2073 6574 2e0a 2020  training set..  
-0000cb10: 2020 2020 2020 2020 2020 7661 6c69 645f            valid_
-0000cb20: 6c6f 6164 6572 2028 746f 7263 682e 7574  loader (torch.ut
-0000cb30: 696c 732e 6461 7461 2e44 6174 614c 6f61  ils.data.DataLoa
-0000cb40: 6465 7229 3a20 4461 7461 4c6f 6164 6572  der): DataLoader
-0000cb50: 2077 7261 7070 696e 6720 7468 6520 7661   wrapping the va
-0000cb60: 6c69 6461 7469 6f6e 2073 6574 2e0a 2020  lidation set..  
-0000cb70: 2020 2020 2020 2020 2020 7370 6c69 7420            split 
-0000cb80: 2869 6e74 293a 2049 6e64 6578 206f 6620  (int): Index of 
-0000cb90: 7468 6520 7370 6c69 7420 7472 6169 6e65  the split traine
-0000cba0: 642e 0a20 2020 2020 2020 2020 2020 206e  d..            n
-0000cbb0: 6574 776f 726b 2028 696e 7429 3a20 496e  etwork (int): In
-0000cbc0: 6465 7820 6f66 2074 6865 206e 6574 776f  dex of the netwo
-0000cbd0: 726b 2074 7261 696e 6564 2028 7573 6564  rk trained (used
-0000cbe0: 2069 6e20 6d75 6c74 692d 6e65 7477 6f72   in multi-networ
-0000cbf0: 6b20 7365 7474 696e 6720 6f6e 6c79 292e  k setting only).
-0000cc00: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000cc10: 756d 6520 2862 6f6f 6c29 3a20 4966 2054  ume (bool): If T
-0000cc20: 7275 6520 7468 6520 6a6f 6220 6973 2072  rue the job is r
-0000cc30: 6573 756d 6564 2066 726f 6d20 7468 6520  esumed from the 
-0000cc40: 6368 6563 6b70 6f69 6e74 2e0a 2020 2020  checkpoint..    
-0000cc50: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-0000cc60: 206d 6f64 656c 2c20 6265 6769 6e6e 696e   model, beginnin
-0000cc70: 675f 6570 6f63 6820 3d20 7365 6c66 2e5f  g_epoch = self._
-0000cc80: 696e 6974 5f6d 6f64 656c 280a 2020 2020  init_model(.    
-0000cc90: 2020 2020 2020 2020 7370 6c69 743d 7370          split=sp
-0000cca0: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
-0000ccb0: 2072 6573 756d 653d 7265 7375 6d65 2c0a   resume=resume,.
-0000ccc0: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-0000ccd0: 7366 6572 5f70 6174 683d 7365 6c66 2e74  sfer_path=self.t
-0000cce0: 7261 6e73 6665 725f 7061 7468 2c0a 2020  ransfer_path,.  
-0000ccf0: 2020 2020 2020 2020 2020 7472 616e 7366            transf
-0000cd00: 6572 5f73 656c 6563 7469 6f6e 3d73 656c  er_selection=sel
-0000cd10: 662e 7472 616e 7366 6572 5f73 656c 6563  f.transfer_selec
-0000cd20: 7469 6f6e 5f6d 6574 7269 632c 0a20 2020  tion_metric,.   
-0000cd30: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000cd40: 6372 6974 6572 696f 6e20 3d20 7365 6c66  criterion = self
-0000cd50: 2e74 6173 6b5f 6d61 6e61 6765 722e 6765  .task_manager.ge
-0000cd60: 745f 6372 6974 6572 696f 6e28 7365 6c66  t_criterion(self
-0000cd70: 2e6c 6f73 7329 0a20 2020 2020 2020 206c  .loss).        l
-0000cd80: 6f67 6765 722e 6465 6275 6728 6622 4372  ogger.debug(f"Cr
-0000cd90: 6974 6572 696f 6e20 666f 7220 7b73 656c  iterion for {sel
-0000cda0: 662e 6e65 7477 6f72 6b5f 7461 736b 7d20  f.network_task} 
-0000cdb0: 6973 207b 6372 6974 6572 696f 6e7d 2229  is {criterion}")
-0000cdc0: 0a20 2020 2020 2020 206f 7074 696d 697a  .        optimiz
-0000cdd0: 6572 203d 2073 656c 662e 5f69 6e69 745f  er = self._init_
-0000cde0: 6f70 7469 6d69 7a65 7228 6d6f 6465 6c2c  optimizer(model,
-0000cdf0: 2073 706c 6974 3d73 706c 6974 2c20 7265   split=split, re
-0000ce00: 7375 6d65 3d72 6573 756d 6529 0a0a 2020  sume=resume)..  
-0000ce10: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0000ce20: 7567 2866 224f 7074 696d 697a 6572 2075  ug(f"Optimizer u
-0000ce30: 7365 6420 666f 7220 7472 6169 6e69 6e67  sed for training
-0000ce40: 2069 7320 6f70 7469 6d69 7a65 7222 290a   is optimizer").
-0000ce50: 0a20 2020 2020 2020 206d 6f64 656c 2e74  .        model.t
-0000ce60: 7261 696e 2829 0a20 2020 2020 2020 2074  rain().        t
-0000ce70: 7261 696e 5f73 6f75 7263 655f 6c6f 6164  rain_source_load
-0000ce80: 6572 2e64 6174 6173 6574 2e74 7261 696e  er.dataset.train
-0000ce90: 2829 0a20 2020 2020 2020 2074 7261 696e  ().        train
-0000cea0: 5f74 6172 6765 745f 6c6f 6164 6572 2e64  _target_loader.d
-0000ceb0: 6174 6173 6574 2e74 7261 696e 2829 0a20  ataset.train(). 
-0000cec0: 2020 2020 2020 2074 7261 696e 5f74 6172         train_tar
-0000ced0: 6765 745f 756e 6c5f 6c6f 6164 6572 2e64  get_unl_loader.d
-0000cee0: 6174 6173 6574 2e74 7261 696e 2829 0a0a  ataset.train()..
-0000cef0: 2020 2020 2020 2020 6561 726c 795f 7374          early_st
-0000cf00: 6f70 7069 6e67 203d 2045 6172 6c79 5374  opping = EarlySt
-0000cf10: 6f70 7069 6e67 280a 2020 2020 2020 2020  opping(.        
-0000cf20: 2020 2020 226d 696e 222c 206d 696e 5f64      "min", min_d
-0000cf30: 656c 7461 3d73 656c 662e 746f 6c65 7261  elta=self.tolera
-0000cf40: 6e63 652c 2070 6174 6965 6e63 653d 7365  nce, patience=se
-0000cf50: 6c66 2e70 6174 6965 6e63 650a 2020 2020  lf.patience.    
-0000cf60: 2020 2020 290a 0a20 2020 2020 2020 206d      )..        m
-0000cf70: 6574 7269 6373 5f76 616c 6964 5f74 6172  etrics_valid_tar
-0000cf80: 6765 7420 3d20 7b22 6c6f 7373 223a 204e  get = {"loss": N
-0000cf90: 6f6e 657d 0a20 2020 2020 2020 206d 6574  one}.        met
-0000cfa0: 7269 6373 5f76 616c 6964 5f73 6f75 7263  rics_valid_sourc
-0000cfb0: 6520 3d20 7b22 6c6f 7373 223a 204e 6f6e  e = {"loss": Non
-0000cfc0: 657d 0a0a 2020 2020 2020 2020 6c6f 675f  e}..        log_
-0000cfd0: 7772 6974 6572 203d 204c 6f67 5772 6974  writer = LogWrit
-0000cfe0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-0000cff0: 7365 6c66 2e6d 6170 735f 7061 7468 2c0a  self.maps_path,.
-0000d000: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000d010: 2e74 6173 6b5f 6d61 6e61 6765 722e 6576  .task_manager.ev
-0000d020: 616c 7561 7469 6f6e 5f6d 6574 7269 6373  aluation_metrics
-0000d030: 202b 205b 226c 6f73 7322 5d2c 0a20 2020   + ["loss"],.   
-0000d040: 2020 2020 2020 2020 2073 706c 6974 2c0a           split,.
-0000d050: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0000d060: 6d65 3d72 6573 756d 652c 0a20 2020 2020  me=resume,.     
-0000d070: 2020 2020 2020 2062 6567 696e 6e69 6e67         beginning
-0000d080: 5f65 706f 6368 3d62 6567 696e 6e69 6e67  _epoch=beginning
-0000d090: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
-0000d0a0: 2020 2020 6e65 7477 6f72 6b3d 6e65 7477      network=netw
-0000d0b0: 6f72 6b2c 0a20 2020 2020 2020 2029 0a20  ork,.        ). 
-0000d0c0: 2020 2020 2020 2065 706f 6368 203d 206c         epoch = l
-0000d0d0: 6f67 5f77 7269 7465 722e 6265 6769 6e6e  og_writer.beginn
-0000d0e0: 696e 675f 6570 6f63 680a 0a20 2020 2020  ing_epoch..     
-0000d0f0: 2020 2072 6574 6169 6e5f 6265 7374 203d     retain_best =
-0000d100: 2052 6574 6169 6e42 6573 7428 7365 6c65   RetainBest(sele
-0000d110: 6374 696f 6e5f 6d65 7472 6963 733d 6c69  ction_metrics=li
-0000d120: 7374 2873 656c 662e 7365 6c65 6374 696f  st(self.selectio
-0000d130: 6e5f 6d65 7472 6963 7329 290a 2020 2020  n_metrics)).    
-0000d140: 2020 2020 696d 706f 7274 206e 756d 7079      import numpy
-0000d150: 2061 7320 6e70 0a0a 2020 2020 2020 2020   as np..        
-0000d160: 7768 696c 6520 6570 6f63 6820 3c20 7365  while epoch < se
-0000d170: 6c66 2e65 706f 6368 7320 616e 6420 6e6f  lf.epochs and no
-0000d180: 7420 6561 726c 795f 7374 6f70 7069 6e67  t early_stopping
-0000d190: 2e73 7465 7028 0a20 2020 2020 2020 2020  .step(.         
-0000d1a0: 2020 206d 6574 7269 6373 5f76 616c 6964     metrics_valid
-0000d1b0: 5f74 6172 6765 745b 226c 6f73 7322 5d0a  _target["loss"].
-0000d1c0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-0000d1d0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0000d1e0: 666f 2866 2242 6567 696e 6e69 6e67 2065  fo(f"Beginning e
-0000d1f0: 706f 6368 207b 6570 6f63 687d 2e22 290a  poch {epoch}.").
-0000d200: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-0000d210: 656c 2e7a 6572 6f5f 6772 6164 2829 0a20  el.zero_grad(). 
-0000d220: 2020 2020 2020 2020 2020 2065 7661 6c75             evalu
-0000d230: 6174 696f 6e5f 666c 6167 2c20 7374 6570  ation_flag, step
-0000d240: 5f66 6c61 6720 3d20 5472 7565 2c20 5472  _flag = True, Tr
-0000d250: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-0000d260: 666f 7220 692c 2028 6461 7461 5f73 6f75  for i, (data_sou
-0000d270: 7263 652c 2064 6174 615f 7461 7267 6574  rce, data_target
-0000d280: 2c20 6461 7461 5f74 6172 6765 745f 756e  , data_target_un
-0000d290: 6c29 2069 6e20 656e 756d 6572 6174 6528  l) in enumerate(
-0000d2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d2b0: 207a 6970 2874 7261 696e 5f73 6f75 7263   zip(train_sourc
-0000d2c0: 655f 6c6f 6164 6572 2c20 7472 6169 6e5f  e_loader, train_
-0000d2d0: 7461 7267 6574 5f6c 6f61 6465 722c 2074  target_loader, t
-0000d2e0: 7261 696e 5f74 6172 6765 745f 756e 6c5f  rain_target_unl_
-0000d2f0: 6c6f 6164 6572 290a 2020 2020 2020 2020  loader).        
-0000d300: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0000d310: 2020 2020 2020 2070 203d 2028 0a20 2020         p = (.   
-0000d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d330: 2066 6c6f 6174 2865 706f 6368 202a 206c   float(epoch * l
-0000d340: 656e 2874 7261 696e 5f74 6172 6765 745f  en(train_target_
-0000d350: 6c6f 6164 6572 2929 0a20 2020 2020 2020  loader)).       
-0000d360: 2020 2020 2020 2020 2020 2020 202f 2031               / 1
-0000d370: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0000d380: 2020 2020 2020 2f20 6c65 6e28 7472 6169        / len(trai
-0000d390: 6e5f 7461 7267 6574 5f6c 6f61 6465 7229  n_target_loader)
-0000d3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d3b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000d3c0: 2020 2061 6c70 6861 203d 2032 2e30 202f     alpha = 2.0 /
-0000d3d0: 2028 312e 3020 2b20 6e70 2e65 7870 282d   (1.0 + np.exp(-
-0000d3e0: 3130 202a 2070 2929 202d 2031 0a20 2020  10 * p)) - 1.   
-0000d3f0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-0000d400: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
-0000d410: 2020 2020 2020 2020 205f 2c20 5f2c 206c           _, _, l
-0000d420: 6f73 735f 6469 6374 203d 206d 6f64 656c  oss_dict = model
-0000d430: 2e63 6f6d 7075 7465 5f6f 7574 7075 7473  .compute_outputs
-0000d440: 5f61 6e64 5f6c 6f73 7328 0a20 2020 2020  _and_loss(.     
-0000d450: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000d460: 6174 615f 736f 7572 6365 2c20 6461 7461  ata_source, data
-0000d470: 5f74 6172 6765 742c 2064 6174 615f 7461  _target, data_ta
-0000d480: 7267 6574 5f75 6e6c 2c20 6372 6974 6572  rget_unl, criter
-0000d490: 696f 6e2c 2061 6c70 6861 0a20 2020 2020  ion, alpha.     
-0000d4a0: 2020 2020 2020 2020 2020 2029 2020 2320             )  # 
-0000d4b0: 544f 2043 4845 434b 0a20 2020 2020 2020  TO CHECK.       
-0000d4c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000d4d0: 6465 6275 6728 6622 5472 6169 6e20 6c6f  debug(f"Train lo
-0000d4e0: 7373 2064 6963 7469 6f6e 6e61 7279 207b  ss dictionnary {
-0000d4f0: 6c6f 7373 5f64 6963 747d 2229 0a20 2020  loss_dict}").   
-0000d500: 2020 2020 2020 2020 2020 2020 206c 6f73               los
-0000d510: 7320 3d20 6c6f 7373 5f64 6963 745b 226c  s = loss_dict["l
-0000d520: 6f73 7322 5d0a 2020 2020 2020 2020 2020  oss"].          
-0000d530: 2020 2020 2020 6c6f 7373 2e62 6163 6b77        loss.backw
-0000d540: 6172 6428 290a 2020 2020 2020 2020 2020  ard().          
-0000d550: 2020 2020 2020 6966 2028 6920 2b20 3129        if (i + 1)
-0000d560: 2025 2073 656c 662e 6163 6375 6d75 6c61   % self.accumula
-0000d570: 7469 6f6e 5f73 7465 7073 203d 3d20 303a  tion_steps == 0:
-0000d580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d590: 2020 2020 2073 7465 705f 666c 6167 203d       step_flag =
-0000d5a0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000d5b0: 2020 2020 2020 2020 2020 206f 7074 696d             optim
-0000d5c0: 697a 6572 2e73 7465 7028 290a 2020 2020  izer.step().    
-0000d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5e0: 6f70 7469 6d69 7a65 722e 7a65 726f 5f67  optimizer.zero_g
-0000d5f0: 7261 6428 290a 0a20 2020 2020 2020 2020  rad()..         
-0000d600: 2020 2020 2020 2020 2020 2064 656c 206c             del l
-0000d610: 6f73 730a 0a20 2020 2020 2020 2020 2020  oss..           
-0000d620: 2020 2020 2020 2020 2023 2045 7661 6c75           # Evalu
-0000d630: 6174 6520 7468 6520 6d6f 6465 6c20 6f6e  ate the model on
-0000d640: 6c79 2077 6865 6e20 6e6f 2067 7261 6469  ly when no gradi
-0000d650: 656e 7473 2061 7265 2061 6363 756d 756c  ents are accumul
-0000d660: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-0000d670: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
-0000d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d690: 2020 2020 2020 7365 6c66 2e65 7661 6c75        self.evalu
-0000d6a0: 6174 696f 6e5f 7374 6570 7320 213d 2030  ation_steps != 0
-0000d6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d6c0: 2020 2020 2020 2020 2061 6e64 2028 6920           and (i 
-0000d6d0: 2b20 3129 2025 2073 656c 662e 6576 616c  + 1) % self.eval
-0000d6e0: 7561 7469 6f6e 5f73 7465 7073 203d 3d20  uation_steps == 
-0000d6f0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0000d700: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0000d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d720: 2065 7661 6c75 6174 696f 6e5f 666c 6167   evaluation_flag
-0000d730: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0000d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d750: 2020 2320 4576 616c 7561 7465 206f 6e20    # Evaluate on 
-0000d760: 7461 6765 7420 6461 7461 0a20 2020 2020  taget data.     
-0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d780: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0000d790: 4576 616c 7561 7469 6f6e 206f 6e20 7461  Evaluation on ta
-0000d7a0: 7267 6574 2064 6174 6122 290a 2020 2020  rget data").    
-0000d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7c0: 2020 2020 5f2c 206d 6574 7269 6373 5f74      _, metrics_t
-0000d7d0: 7261 696e 5f74 6172 6765 7420 3d20 7365  rain_target = se
-0000d7e0: 6c66 2e74 6173 6b5f 6d61 6e61 6765 722e  lf.task_manager.
-0000d7f0: 7465 7374 5f64 6128 0a20 2020 2020 2020  test_da(.       
+0000b930: 2020 2020 2020 2020 2020 2020 6622 6174              f"at
+0000b940: 2074 6865 2065 6e64 206f 6620 6974 6572   the end of iter
+0000b950: 6174 696f 6e20 7b69 7d22 0a20 2020 2020  ation {i}".     
+0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b970: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b990: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0000b9a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9c0: 2020 6622 7b73 656c 662e 6d6f 6465 7d20    f"{self.mode} 
+0000b9d0: 6c65 7665 6c20 7661 6c69 6461 7469 6f6e  level validation
+0000b9e0: 206c 6f73 7320 6973 207b 6d65 7472 6963   loss is {metric
+0000b9f0: 735f 7661 6c69 645b 276c 6f73 7327 5d7d  s_valid['loss']}
+0000ba00: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba20: 2020 2066 2261 7420 7468 6520 656e 6420     f"at the end 
+0000ba30: 6f66 2069 7465 7261 7469 6f6e 207b 697d  of iteration {i}
+0000ba40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000ba50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000ba60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ba70: 2020 2020 2070 726f 6669 6c65 722e 7374       profiler.st
+0000ba80: 6570 2829 0a0a 2020 2020 2020 2020 2020  ep()..          
+0000ba90: 2020 2020 2020 2320 4966 206e 6f20 7374        # If no st
+0000baa0: 6570 2068 6173 2062 6565 6e20 7065 7266  ep has been perf
+0000bab0: 6f72 6d65 642c 2072 6169 7365 2045 7863  ormed, raise Exc
+0000bac0: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
+0000bad0: 2020 2020 2020 2069 6620 7374 6570 5f66         if step_f
+0000bae0: 6c61 673a 0a20 2020 2020 2020 2020 2020  lag:.           
+0000baf0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+0000bb00: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
+0000bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb20: 2020 2254 6865 206d 6f64 656c 2068 6173    "The model has
+0000bb30: 206e 6f74 2062 6565 6e20 7570 6461 7465   not been update
+0000bb40: 6420 6f6e 6365 2069 6e20 7468 6520 6570  d once in the ep
+0000bb50: 6f63 682e 2054 6865 2061 6363 756d 756c  och. The accumul
+0000bb60: 6174 696f 6e20 7374 6570 206d 6179 2062  ation step may b
+0000bb70: 6520 746f 6f20 6c61 7267 652e 220a 2020  e too large.".  
+0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb90: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000bba0: 2020 2020 2023 2049 6620 6e6f 2065 7661       # If no eva
+0000bbb0: 6c75 6174 696f 6e20 6861 7320 6265 656e  luation has been
+0000bbc0: 2070 6572 666f 726d 6564 2c20 7761 726e   performed, warn
+0000bbd0: 2074 6865 2075 7365 720a 2020 2020 2020   the user.      
+0000bbe0: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
+0000bbf0: 7661 6c75 6174 696f 6e5f 666c 6167 2061  valuation_flag a
+0000bc00: 6e64 2073 656c 662e 6576 616c 7561 7469  nd self.evaluati
+0000bc10: 6f6e 5f73 7465 7073 2021 3d20 303a 0a20  on_steps != 0:. 
+0000bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc30: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+0000bc40: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0000bc50: 2020 2020 2020 2020 2020 2066 2259 6f75             f"You
+0000bc60: 7220 6576 616c 7561 7469 6f6e 2073 7465  r evaluation ste
+0000bc70: 7073 207b 7365 6c66 2e65 7661 6c75 6174  ps {self.evaluat
+0000bc80: 696f 6e5f 7374 6570 737d 2061 7265 2074  ion_steps} are t
+0000bc90: 6f6f 2062 6967 2022 0a20 2020 2020 2020  oo big ".       
+0000bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcb0: 2066 2263 6f6d 7061 7265 6420 746f 2074   f"compared to t
+0000bcc0: 6865 2073 697a 6520 6f66 2074 6865 2064  he size of the d
+0000bcd0: 6174 6173 6574 2e20 220a 2020 2020 2020  ataset. ".      
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 2020 6622 5468 6520 6d6f 6465 6c20 6973    f"The model is
+0000bd00: 2065 7661 6c75 6174 6564 206f 6e6c 7920   evaluated only 
+0000bd10: 6f6e 6365 2061 7420 7468 6520 656e 6420  once at the end 
+0000bd20: 6570 6f63 6873 2e22 0a20 2020 2020 2020  epochs.".       
+0000bd30: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd50: 2320 5570 6461 7465 2077 6569 6768 7473  # Update weights
+0000bd60: 206f 6e65 206c 6173 7420 7469 6d65 2069   one last time i
+0000bd70: 6620 6772 6164 6965 6e74 7320 7765 7265  f gradients were
+0000bd80: 2063 6f6d 7075 7465 6420 7769 7468 6f75   computed withou
+0000bd90: 7420 7570 6461 7465 0a20 2020 2020 2020  t update.       
+0000bda0: 2020 2020 2020 2020 2069 6620 2869 202b           if (i +
+0000bdb0: 2031 2920 2520 7365 6c66 2e61 6363 756d   1) % self.accum
+0000bdc0: 756c 6174 696f 6e5f 7374 6570 7320 213d  ulation_steps !=
+0000bdd0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0000bde0: 2020 2020 2020 2020 7363 616c 6572 2e73          scaler.s
+0000bdf0: 7465 7028 6f70 7469 6d69 7a65 7229 0a20  tep(optimizer). 
+0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be10: 2020 2073 6361 6c65 722e 7570 6461 7465     scaler.update
+0000be20: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000be30: 2020 2020 2020 206f 7074 696d 697a 6572         optimizer
+0000be40: 2e7a 6572 6f5f 6772 6164 2873 6574 5f74  .zero_grad(set_t
+0000be50: 6f5f 6e6f 6e65 3d54 7275 6529 0a0a 2020  o_none=True)..  
+0000be60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000be70: 416c 7761 7973 2074 6573 7420 7468 6520  Always test the 
+0000be80: 7265 7375 6c74 7320 616e 6420 7361 7665  results and save
+0000be90: 2074 6865 6d20 6f6e 6365 2061 7420 7468   them once at th
+0000bea0: 6520 656e 6420 6f66 2074 6865 2065 706f  e end of the epo
+0000beb0: 6368 0a20 2020 2020 2020 2020 2020 2020  ch.             
+0000bec0: 2020 206d 6f64 656c 2e7a 6572 6f5f 6772     model.zero_gr
+0000bed0: 6164 2873 6574 5f74 6f5f 6e6f 6e65 3d54  ad(set_to_none=T
+0000bee0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0000bef0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0000bf00: 6728 6622 4c61 7374 2063 6865 636b 706f  g(f"Last checkpo
+0000bf10: 696e 7420 6174 2074 6865 2065 6e64 206f  int at the end o
+0000bf20: 6620 7468 6520 6570 6f63 6820 7b65 706f  f the epoch {epo
+0000bf30: 6368 7d22 290a 0a20 2020 2020 2020 2020  ch}")..         
+0000bf40: 2020 2020 2020 205f 2c20 6d65 7472 6963         _, metric
+0000bf50: 735f 7472 6169 6e20 3d20 7365 6c66 2e74  s_train = self.t
+0000bf60: 6173 6b5f 6d61 6e61 6765 722e 7465 7374  ask_manager.test
+0000bf70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000bf80: 2020 2020 2020 6d6f 6465 6c2c 2074 7261        model, tra
+0000bf90: 696e 5f6c 6f61 6465 722c 2063 7269 7465  in_loader, crite
+0000bfa0: 7269 6f6e 2c20 616d 703d 7365 6c66 2e73  rion, amp=self.s
+0000bfb0: 7464 5f61 6d70 0a20 2020 2020 2020 2020  td_amp.         
+0000bfc0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000bfd0: 2020 2020 2020 2020 205f 2c20 6d65 7472           _, metr
+0000bfe0: 6963 735f 7661 6c69 6420 3d20 7365 6c66  ics_valid = self
+0000bff0: 2e74 6173 6b5f 6d61 6e61 6765 722e 7465  .task_manager.te
+0000c000: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+0000c010: 2020 2020 2020 2020 6d6f 6465 6c2c 2076          model, v
+0000c020: 616c 6964 5f6c 6f61 6465 722c 2063 7269  alid_loader, cri
+0000c030: 7465 7269 6f6e 2c20 616d 703d 7365 6c66  terion, amp=self
+0000c040: 2e73 7464 5f61 6d70 0a20 2020 2020 2020  .std_amp.       
+0000c050: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000c060: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0000c070: 6c2e 7472 6169 6e28 290a 2020 2020 2020  l.train().      
+0000c080: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
+0000c090: 6c6f 6164 6572 2e64 6174 6173 6574 2e74  loader.dataset.t
+0000c0a0: 7261 696e 2829 0a0a 2020 2020 2020 2020  rain()..        
+0000c0b0: 2020 2020 7365 6c66 2e63 616c 6c62 6163      self.callbac
+0000c0c0: 6b5f 6861 6e64 6c65 722e 6f6e 5f65 706f  k_handler.on_epo
+0000c0d0: 6368 5f65 6e64 280a 2020 2020 2020 2020  ch_end(.        
+0000c0e0: 2020 2020 2020 2020 7365 6c66 2e70 6172          self.par
+0000c0f0: 616d 6574 6572 732c 0a20 2020 2020 2020  ameters,.       
+0000c100: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+0000c110: 5f74 7261 696e 3d6d 6574 7269 6373 5f74  _train=metrics_t
+0000c120: 7261 696e 2c0a 2020 2020 2020 2020 2020  rain,.          
+0000c130: 2020 2020 2020 6d65 7472 6963 735f 7661        metrics_va
+0000c140: 6c69 643d 6d65 7472 6963 735f 7661 6c69  lid=metrics_vali
+0000c150: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0000c160: 2020 206d 6f64 653d 7365 6c66 2e6d 6f64     mode=self.mod
+0000c170: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000c180: 2020 2069 3d69 2c0a 2020 2020 2020 2020     i=i,.        
+0000c190: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000c1a0: 2020 206d 6f64 656c 5f77 6569 6768 7473     model_weights
+0000c1b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0000c1c0: 2020 2020 2022 6d6f 6465 6c22 3a20 6d6f       "model": mo
+0000c1d0: 6465 6c2e 7374 6174 655f 6469 6374 2829  del.state_dict()
+0000c1e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c1f0: 2020 2265 706f 6368 223a 2065 706f 6368    "epoch": epoch
+0000c200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c210: 2020 226e 616d 6522 3a20 7365 6c66 2e61    "name": self.a
+0000c220: 7263 6869 7465 6374 7572 652c 0a20 2020  rchitecture,.   
+0000c230: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0000c240: 2020 2020 2020 206f 7074 696d 697a 6572         optimizer
+0000c250: 5f77 6569 6768 7473 203d 207b 0a20 2020  _weights = {.   
+0000c260: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+0000c270: 7469 6d69 7a65 7222 3a20 6d6f 6465 6c2e  timizer": model.
+0000c280: 6f70 7469 6d5f 7374 6174 655f 6469 6374  optim_state_dict
+0000c290: 286f 7074 696d 697a 6572 292c 0a20 2020  (optimizer),.   
+0000c2a0: 2020 2020 2020 2020 2020 2020 2022 6570               "ep
+0000c2b0: 6f63 6822 3a20 6570 6f63 682c 0a20 2020  och": epoch,.   
+0000c2c0: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
+0000c2d0: 6d65 223a 2073 656c 662e 6172 6368 6974  me": self.archit
+0000c2e0: 6563 7475 7265 2c0a 2020 2020 2020 2020  ecture,.        
+0000c2f0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0000c300: 2020 2069 6620 636c 7573 7465 722e 6d61     if cluster.ma
+0000c310: 7374 6572 3a0a 2020 2020 2020 2020 2020  ster:.          
+0000c320: 2020 2020 2020 2320 5361 7665 2063 6865        # Save che
+0000c330: 636b 706f 696e 7473 2061 6e64 2062 6573  ckpoints and bes
+0000c340: 7420 6d6f 6465 6c73 0a20 2020 2020 2020  t models.       
+0000c350: 2020 2020 2020 2020 2062 6573 745f 6469           best_di
+0000c360: 6374 203d 2072 6574 6169 6e5f 6265 7374  ct = retain_best
+0000c370: 2e73 7465 7028 6d65 7472 6963 735f 7661  .step(metrics_va
+0000c380: 6c69 6429 0a20 2020 2020 2020 2020 2020  lid).           
+0000c390: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
+0000c3a0: 5f77 6569 6768 7473 280a 2020 2020 2020  _weights(.      
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0000c3c0: 6465 6c5f 7765 6967 6874 732c 0a20 2020  del_weights,.   
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3e0: 2062 6573 745f 6469 6374 2c0a 2020 2020   best_dict,.    
+0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c400: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
+0000c410: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
+0000c420: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
+0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c440: 7361 7665 5f61 6c6c 5f6d 6f64 656c 733d  save_all_models=
+0000c450: 7365 6c66 2e70 6172 616d 6574 6572 735b  self.parameters[
+0000c460: 2273 6176 655f 616c 6c5f 6d6f 6465 6c73  "save_all_models
+0000c470: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0000c480: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000c490: 2020 2020 2020 7365 6c66 2e5f 7772 6974        self._writ
+0000c4a0: 655f 7765 6967 6874 7328 0a20 2020 2020  e_weights(.     
+0000c4b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000c4c0: 7074 696d 697a 6572 5f77 6569 6768 7473  ptimizer_weights
+0000c4d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c4e0: 2020 2020 2020 4e6f 6e65 2c0a 2020 2020        None,.    
+0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c500: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
+0000c510: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+0000c520: 616d 653d 226f 7074 696d 697a 6572 2e70  ame="optimizer.p
+0000c530: 7468 2e74 6172 222c 0a20 2020 2020 2020  th.tar",.       
+0000c540: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+0000c550: 655f 616c 6c5f 6d6f 6465 6c73 3d73 656c  e_all_models=sel
+0000c560: 662e 7061 7261 6d65 7465 7273 5b22 7361  f.parameters["sa
+0000c570: 7665 5f61 6c6c 5f6d 6f64 656c 7322 5d2c  ve_all_models"],
+0000c580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c590: 2029 0a20 2020 2020 2020 2020 2020 2064   ).            d
+0000c5a0: 6973 742e 6261 7272 6965 7228 290a 0a20  ist.barrier().. 
+0000c5b0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0000c5c0: 6c66 2e70 6172 616d 6574 6572 735b 2261  lf.parameters["a
+0000c5d0: 6461 7074 6976 655f 6c65 6172 6e69 6e67  daptive_learning
+0000c5e0: 5f72 6174 6522 5d3a 0a20 2020 2020 2020  _rate"]:.       
+0000c5f0: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
+0000c600: 6572 2e73 7465 7028 0a20 2020 2020 2020  er.step(.       
+0000c610: 2020 2020 2020 2020 2020 2020 206d 6574               met
+0000c620: 7269 6373 5f76 616c 6964 5b22 6c6f 7373  rics_valid["loss
+0000c630: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0000c640: 2020 2029 2020 2320 5570 6461 7465 206c     )  # Update l
+0000c650: 6561 726e 696e 6720 7261 7465 2062 6173  earning rate bas
+0000c660: 6564 206f 6e20 7661 6c69 6461 7469 6f6e  ed on validation
+0000c670: 206c 6f73 730a 0a20 2020 2020 2020 2020   loss..         
+0000c680: 2020 2065 706f 6368 202b 3d20 310a 0a20     epoch += 1.. 
+0000c690: 2020 2020 2020 2064 656c 206d 6f64 656c         del model
+0000c6a0: 0a20 2020 2020 2020 2073 656c 662e 5f74  .        self._t
+0000c6b0: 6573 745f 6c6f 6164 6572 280a 2020 2020  est_loader(.    
+0000c6c0: 2020 2020 2020 2020 7472 6169 6e5f 6c6f          train_lo
+0000c6d0: 6164 6572 2c0a 2020 2020 2020 2020 2020  ader,.          
+0000c6e0: 2020 6372 6974 6572 696f 6e2c 0a20 2020    criterion,.   
+0000c6f0: 2020 2020 2020 2020 2022 7472 6169 6e22           "train"
+0000c700: 2c0a 2020 2020 2020 2020 2020 2020 7370  ,.            sp
+0000c710: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
+0000c720: 2073 656c 662e 7365 6c65 6374 696f 6e5f   self.selection_
+0000c730: 6d65 7472 6963 732c 0a20 2020 2020 2020  metrics,.       
+0000c740: 2020 2020 2061 6d70 3d73 656c 662e 7374       amp=self.st
+0000c750: 645f 616d 702c 0a20 2020 2020 2020 2020  d_amp,.         
+0000c760: 2020 206e 6574 776f 726b 3d6e 6574 776f     network=netwo
+0000c770: 726b 2c0a 2020 2020 2020 2020 290a 2020  rk,.        ).  
+0000c780: 2020 2020 2020 7365 6c66 2e5f 7465 7374        self._test
+0000c790: 5f6c 6f61 6465 7228 0a20 2020 2020 2020  _loader(.       
+0000c7a0: 2020 2020 2076 616c 6964 5f6c 6f61 6465       valid_loade
+0000c7b0: 722c 0a20 2020 2020 2020 2020 2020 2063  r,.            c
+0000c7c0: 7269 7465 7269 6f6e 2c0a 2020 2020 2020  riterion,.      
+0000c7d0: 2020 2020 2020 2276 616c 6964 6174 696f        "validatio
+0000c7e0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+0000c7f0: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
+0000c800: 2020 2073 656c 662e 7365 6c65 6374 696f     self.selectio
+0000c810: 6e5f 6d65 7472 6963 732c 0a20 2020 2020  n_metrics,.     
+0000c820: 2020 2020 2020 2061 6d70 3d73 656c 662e         amp=self.
+0000c830: 7374 645f 616d 702c 0a20 2020 2020 2020  std_amp,.       
+0000c840: 2020 2020 206e 6574 776f 726b 3d6e 6574       network=net
+0000c850: 776f 726b 2c0a 2020 2020 2020 2020 290a  work,.        ).
+0000c860: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000c870: 2e74 6173 6b5f 6d61 6e61 6765 722e 7361  .task_manager.sa
+0000c880: 7665 5f6f 7574 7075 7473 3a0a 2020 2020  ve_outputs:.    
+0000c890: 2020 2020 2020 2020 7365 6c66 2e5f 636f          self._co
+0000c8a0: 6d70 7574 655f 6f75 7470 7574 5f74 656e  mpute_output_ten
+0000c8b0: 736f 7273 280a 2020 2020 2020 2020 2020  sors(.          
+0000c8c0: 2020 2020 2020 7472 6169 6e5f 6c6f 6164        train_load
+0000c8d0: 6572 2e64 6174 6173 6574 2c0a 2020 2020  er.dataset,.    
+0000c8e0: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+0000c8f0: 696e 222c 0a20 2020 2020 2020 2020 2020  in",.           
+0000c900: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
+0000c910: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c920: 2e73 656c 6563 7469 6f6e 5f6d 6574 7269  .selection_metri
+0000c930: 6373 2c0a 2020 2020 2020 2020 2020 2020  cs,.            
+0000c940: 2020 2020 6e62 5f69 6d61 6765 733d 312c      nb_images=1,
+0000c950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c960: 206e 6574 776f 726b 3d6e 6574 776f 726b   network=network
+0000c970: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000c980: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c990: 2e5f 636f 6d70 7574 655f 6f75 7470 7574  ._compute_output
+0000c9a0: 5f74 656e 736f 7273 280a 2020 2020 2020  _tensors(.      
+0000c9b0: 2020 2020 2020 2020 2020 7661 6c69 645f            valid_
+0000c9c0: 6c6f 6164 6572 2e64 6174 6173 6574 2c0a  loader.dataset,.
+0000c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9e0: 2276 616c 6964 6174 696f 6e22 2c0a 2020  "validation",.  
+0000c9f0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+0000ca00: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
+0000ca10: 2020 2020 2073 656c 662e 7365 6c65 6374       self.select
+0000ca20: 696f 6e5f 6d65 7472 6963 732c 0a20 2020  ion_metrics,.   
+0000ca30: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
+0000ca40: 696d 6167 6573 3d31 2c0a 2020 2020 2020  images=1,.      
+0000ca50: 2020 2020 2020 2020 2020 6e65 7477 6f72            networ
+0000ca60: 6b3d 6e65 7477 6f72 6b2c 0a20 2020 2020  k=network,.     
+0000ca70: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000ca80: 2020 7365 6c66 2e63 616c 6c62 6163 6b5f    self.callback_
+0000ca90: 6861 6e64 6c65 722e 6f6e 5f74 7261 696e  handler.on_train
+0000caa0: 5f65 6e64 2870 6172 616d 6574 6572 733d  _end(parameters=
+0000cab0: 7365 6c66 2e70 6172 616d 6574 6572 7329  self.parameters)
+0000cac0: 0a0a 2020 2020 6465 6620 5f74 7261 696e  ..    def _train
+0000cad0: 5f73 7364 616e 6e28 0a20 2020 2020 2020  _ssdann(.       
+0000cae0: 2073 656c 662c 0a20 2020 2020 2020 2074   self,.        t
+0000caf0: 7261 696e 5f73 6f75 7263 655f 6c6f 6164  rain_source_load
+0000cb00: 6572 2c0a 2020 2020 2020 2020 7472 6169  er,.        trai
+0000cb10: 6e5f 7461 7267 6574 5f6c 6f61 6465 722c  n_target_loader,
+0000cb20: 0a20 2020 2020 2020 2074 7261 696e 5f74  .        train_t
+0000cb30: 6172 6765 745f 756e 6c5f 6c6f 6164 6572  arget_unl_loader
+0000cb40: 2c0a 2020 2020 2020 2020 7661 6c69 645f  ,.        valid_
+0000cb50: 6c6f 6164 6572 2c0a 2020 2020 2020 2020  loader,.        
+0000cb60: 7661 6c69 645f 736f 7572 6365 5f6c 6f61  valid_source_loa
+0000cb70: 6465 722c 0a20 2020 2020 2020 2073 706c  der,.        spl
+0000cb80: 6974 2c0a 2020 2020 2020 2020 6e65 7477  it,.        netw
+0000cb90: 6f72 6b3d 4e6f 6e65 2c0a 2020 2020 2020  ork=None,.      
+0000cba0: 2020 7265 7375 6d65 3d46 616c 7365 2c0a    resume=False,.
+0000cbb0: 2020 2020 2020 2020 6576 616c 7561 7465          evaluate
+0000cbc0: 5f73 6f75 7263 653d 5472 7565 2c20 2023  _source=True,  #
+0000cbd0: 2054 4f20 4d4f 4449 4659 0a20 2020 2029   TO MODIFY.    )
+0000cbe0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000cbf0: 2020 2020 2020 436f 7265 2066 756e 6374        Core funct
+0000cc00: 696f 6e20 7368 6172 6564 2062 7920 7472  ion shared by tr
+0000cc10: 6169 6e20 616e 6420 7265 7375 6d65 2e0a  ain and resume..
+0000cc20: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0000cc30: 2020 2020 2020 2020 2020 2074 7261 696e             train
+0000cc40: 5f6c 6f61 6465 7220 2874 6f72 6368 2e75  _loader (torch.u
+0000cc50: 7469 6c73 2e64 6174 612e 4461 7461 4c6f  tils.data.DataLo
+0000cc60: 6164 6572 293a 2044 6174 614c 6f61 6465  ader): DataLoade
+0000cc70: 7220 7772 6170 7069 6e67 2074 6865 2074  r wrapping the t
+0000cc80: 7261 696e 696e 6720 7365 742e 0a20 2020  raining set..   
+0000cc90: 2020 2020 2020 2020 2076 616c 6964 5f6c           valid_l
+0000cca0: 6f61 6465 7220 2874 6f72 6368 2e75 7469  oader (torch.uti
+0000ccb0: 6c73 2e64 6174 612e 4461 7461 4c6f 6164  ls.data.DataLoad
+0000ccc0: 6572 293a 2044 6174 614c 6f61 6465 7220  er): DataLoader 
+0000ccd0: 7772 6170 7069 6e67 2074 6865 2076 616c  wrapping the val
+0000cce0: 6964 6174 696f 6e20 7365 742e 0a20 2020  idation set..   
+0000ccf0: 2020 2020 2020 2020 2073 706c 6974 2028           split (
+0000cd00: 696e 7429 3a20 496e 6465 7820 6f66 2074  int): Index of t
+0000cd10: 6865 2073 706c 6974 2074 7261 696e 6564  he split trained
+0000cd20: 2e0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
+0000cd30: 7477 6f72 6b20 2869 6e74 293a 2049 6e64  twork (int): Ind
+0000cd40: 6578 206f 6620 7468 6520 6e65 7477 6f72  ex of the networ
+0000cd50: 6b20 7472 6169 6e65 6420 2875 7365 6420  k trained (used 
+0000cd60: 696e 206d 756c 7469 2d6e 6574 776f 726b  in multi-network
+0000cd70: 2073 6574 7469 6e67 206f 6e6c 7929 2e0a   setting only)..
+0000cd80: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+0000cd90: 6d65 2028 626f 6f6c 293a 2049 6620 5472  me (bool): If Tr
+0000cda0: 7565 2074 6865 206a 6f62 2069 7320 7265  ue the job is re
+0000cdb0: 7375 6d65 6420 6672 6f6d 2074 6865 2063  sumed from the c
+0000cdc0: 6865 636b 706f 696e 742e 0a20 2020 2020  heckpoint..     
+0000cdd0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+0000cde0: 6d6f 6465 6c2c 2062 6567 696e 6e69 6e67  model, beginning
+0000cdf0: 5f65 706f 6368 203d 2073 656c 662e 5f69  _epoch = self._i
+0000ce00: 6e69 745f 6d6f 6465 6c28 0a20 2020 2020  nit_model(.     
+0000ce10: 2020 2020 2020 2073 706c 6974 3d73 706c         split=spl
+0000ce20: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+0000ce30: 7265 7375 6d65 3d72 6573 756d 652c 0a20  resume=resume,. 
+0000ce40: 2020 2020 2020 2020 2020 2074 7261 6e73             trans
+0000ce50: 6665 725f 7061 7468 3d73 656c 662e 7472  fer_path=self.tr
+0000ce60: 616e 7366 6572 5f70 6174 682c 0a20 2020  ansfer_path,.   
+0000ce70: 2020 2020 2020 2020 2074 7261 6e73 6665           transfe
+0000ce80: 725f 7365 6c65 6374 696f 6e3d 7365 6c66  r_selection=self
+0000ce90: 2e74 7261 6e73 6665 725f 7365 6c65 6374  .transfer_select
+0000cea0: 696f 6e5f 6d65 7472 6963 2c0a 2020 2020  ion_metric,.    
+0000ceb0: 2020 2020 290a 0a20 2020 2020 2020 2063      )..        c
+0000cec0: 7269 7465 7269 6f6e 203d 2073 656c 662e  riterion = self.
+0000ced0: 7461 736b 5f6d 616e 6167 6572 2e67 6574  task_manager.get
+0000cee0: 5f63 7269 7465 7269 6f6e 2873 656c 662e  _criterion(self.
+0000cef0: 6c6f 7373 290a 2020 2020 2020 2020 6c6f  loss).        lo
+0000cf00: 6767 6572 2e64 6562 7567 2866 2243 7269  gger.debug(f"Cri
+0000cf10: 7465 7269 6f6e 2066 6f72 207b 7365 6c66  terion for {self
+0000cf20: 2e6e 6574 776f 726b 5f74 6173 6b7d 2069  .network_task} i
+0000cf30: 7320 7b63 7269 7465 7269 6f6e 7d22 290a  s {criterion}").
+0000cf40: 2020 2020 2020 2020 6f70 7469 6d69 7a65          optimize
+0000cf50: 7220 3d20 7365 6c66 2e5f 696e 6974 5f6f  r = self._init_o
+0000cf60: 7074 696d 697a 6572 286d 6f64 656c 2c20  ptimizer(model, 
+0000cf70: 7370 6c69 743d 7370 6c69 742c 2072 6573  split=split, res
+0000cf80: 756d 653d 7265 7375 6d65 290a 0a20 2020  ume=resume)..   
+0000cf90: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0000cfa0: 6728 6622 4f70 7469 6d69 7a65 7220 7573  g(f"Optimizer us
+0000cfb0: 6564 2066 6f72 2074 7261 696e 696e 6720  ed for training 
+0000cfc0: 6973 206f 7074 696d 697a 6572 2229 0a0a  is optimizer")..
+0000cfd0: 2020 2020 2020 2020 6d6f 6465 6c2e 7472          model.tr
+0000cfe0: 6169 6e28 290a 2020 2020 2020 2020 7472  ain().        tr
+0000cff0: 6169 6e5f 736f 7572 6365 5f6c 6f61 6465  ain_source_loade
+0000d000: 722e 6461 7461 7365 742e 7472 6169 6e28  r.dataset.train(
+0000d010: 290a 2020 2020 2020 2020 7472 6169 6e5f  ).        train_
+0000d020: 7461 7267 6574 5f6c 6f61 6465 722e 6461  target_loader.da
+0000d030: 7461 7365 742e 7472 6169 6e28 290a 2020  taset.train().  
+0000d040: 2020 2020 2020 7472 6169 6e5f 7461 7267        train_targ
+0000d050: 6574 5f75 6e6c 5f6c 6f61 6465 722e 6461  et_unl_loader.da
+0000d060: 7461 7365 742e 7472 6169 6e28 290a 0a20  taset.train().. 
+0000d070: 2020 2020 2020 2065 6172 6c79 5f73 746f         early_sto
+0000d080: 7070 696e 6720 3d20 4561 726c 7953 746f  pping = EarlySto
+0000d090: 7070 696e 6728 0a20 2020 2020 2020 2020  pping(.         
+0000d0a0: 2020 2022 6d69 6e22 2c20 6d69 6e5f 6465     "min", min_de
+0000d0b0: 6c74 613d 7365 6c66 2e74 6f6c 6572 616e  lta=self.toleran
+0000d0c0: 6365 2c20 7061 7469 656e 6365 3d73 656c  ce, patience=sel
+0000d0d0: 662e 7061 7469 656e 6365 0a20 2020 2020  f.patience.     
+0000d0e0: 2020 2029 0a0a 2020 2020 2020 2020 6d65     )..        me
+0000d0f0: 7472 6963 735f 7661 6c69 645f 7461 7267  trics_valid_targ
+0000d100: 6574 203d 207b 226c 6f73 7322 3a20 4e6f  et = {"loss": No
+0000d110: 6e65 7d0a 2020 2020 2020 2020 6d65 7472  ne}.        metr
+0000d120: 6963 735f 7661 6c69 645f 736f 7572 6365  ics_valid_source
+0000d130: 203d 207b 226c 6f73 7322 3a20 4e6f 6e65   = {"loss": None
+0000d140: 7d0a 0a20 2020 2020 2020 206c 6f67 5f77  }..        log_w
+0000d150: 7269 7465 7220 3d20 4c6f 6757 7269 7465  riter = LogWrite
+0000d160: 7228 0a20 2020 2020 2020 2020 2020 2073  r(.            s
+0000d170: 656c 662e 6d61 7073 5f70 6174 682c 0a20  elf.maps_path,. 
+0000d180: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d190: 7461 736b 5f6d 616e 6167 6572 2e65 7661  task_manager.eva
+0000d1a0: 6c75 6174 696f 6e5f 6d65 7472 6963 7320  luation_metrics 
+0000d1b0: 2b20 5b22 6c6f 7373 225d 2c0a 2020 2020  + ["loss"],.    
+0000d1c0: 2020 2020 2020 2020 7370 6c69 742c 0a20          split,. 
+0000d1d0: 2020 2020 2020 2020 2020 2072 6573 756d             resum
+0000d1e0: 653d 7265 7375 6d65 2c0a 2020 2020 2020  e=resume,.      
+0000d1f0: 2020 2020 2020 6265 6769 6e6e 696e 675f        beginning_
+0000d200: 6570 6f63 683d 6265 6769 6e6e 696e 675f  epoch=beginning_
+0000d210: 6570 6f63 682c 0a20 2020 2020 2020 2020  epoch,.         
+0000d220: 2020 206e 6574 776f 726b 3d6e 6574 776f     network=netwo
+0000d230: 726b 2c0a 2020 2020 2020 2020 290a 2020  rk,.        ).  
+0000d240: 2020 2020 2020 6570 6f63 6820 3d20 6c6f        epoch = lo
+0000d250: 675f 7772 6974 6572 2e62 6567 696e 6e69  g_writer.beginni
+0000d260: 6e67 5f65 706f 6368 0a0a 2020 2020 2020  ng_epoch..      
+0000d270: 2020 7265 7461 696e 5f62 6573 7420 3d20    retain_best = 
+0000d280: 5265 7461 696e 4265 7374 2873 656c 6563  RetainBest(selec
+0000d290: 7469 6f6e 5f6d 6574 7269 6373 3d6c 6973  tion_metrics=lis
+0000d2a0: 7428 7365 6c66 2e73 656c 6563 7469 6f6e  t(self.selection
+0000d2b0: 5f6d 6574 7269 6373 2929 0a20 2020 2020  _metrics)).     
+0000d2c0: 2020 2069 6d70 6f72 7420 6e75 6d70 7920     import numpy 
+0000d2d0: 6173 206e 700a 0a20 2020 2020 2020 2077  as np..        w
+0000d2e0: 6869 6c65 2065 706f 6368 203c 2073 656c  hile epoch < sel
+0000d2f0: 662e 6570 6f63 6873 2061 6e64 206e 6f74  f.epochs and not
+0000d300: 2065 6172 6c79 5f73 746f 7070 696e 672e   early_stopping.
+0000d310: 7374 6570 280a 2020 2020 2020 2020 2020  step(.          
+0000d320: 2020 6d65 7472 6963 735f 7661 6c69 645f    metrics_valid_
+0000d330: 7461 7267 6574 5b22 6c6f 7373 225d 0a20  target["loss"]. 
+0000d340: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0000d350: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+0000d360: 6f28 6622 4265 6769 6e6e 696e 6720 6570  o(f"Beginning ep
+0000d370: 6f63 6820 7b65 706f 6368 7d2e 2229 0a0a  och {epoch}.")..
+0000d380: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0000d390: 6c2e 7a65 726f 5f67 7261 6428 290a 2020  l.zero_grad().  
+0000d3a0: 2020 2020 2020 2020 2020 6576 616c 7561            evalua
+0000d3b0: 7469 6f6e 5f66 6c61 672c 2073 7465 705f  tion_flag, step_
+0000d3c0: 666c 6167 203d 2054 7275 652c 2054 7275  flag = True, Tru
+0000d3d0: 650a 0a20 2020 2020 2020 2020 2020 2066  e..            f
+0000d3e0: 6f72 2069 2c20 2864 6174 615f 736f 7572  or i, (data_sour
+0000d3f0: 6365 2c20 6461 7461 5f74 6172 6765 742c  ce, data_target,
+0000d400: 2064 6174 615f 7461 7267 6574 5f75 6e6c   data_target_unl
+0000d410: 2920 696e 2065 6e75 6d65 7261 7465 280a  ) in enumerate(.
+0000d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d430: 7a69 7028 7472 6169 6e5f 736f 7572 6365  zip(train_source
+0000d440: 5f6c 6f61 6465 722c 2074 7261 696e 5f74  _loader, train_t
+0000d450: 6172 6765 745f 6c6f 6164 6572 2c20 7472  arget_loader, tr
+0000d460: 6169 6e5f 7461 7267 6574 5f75 6e6c 5f6c  ain_target_unl_l
+0000d470: 6f61 6465 7229 0a20 2020 2020 2020 2020  oader).         
+0000d480: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0000d490: 2020 2020 2020 7020 3d20 280a 2020 2020        p = (.    
+0000d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4b0: 666c 6f61 7428 6570 6f63 6820 2a20 6c65  float(epoch * le
+0000d4c0: 6e28 7472 6169 6e5f 7461 7267 6574 5f6c  n(train_target_l
+0000d4d0: 6f61 6465 7229 290a 2020 2020 2020 2020  oader)).        
+0000d4e0: 2020 2020 2020 2020 2020 2020 2f20 3130              / 10
+0000d4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d500: 2020 2020 202f 206c 656e 2874 7261 696e       / len(train
+0000d510: 5f74 6172 6765 745f 6c6f 6164 6572 290a  _target_loader).
+0000d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d530: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d540: 2020 616c 7068 6120 3d20 322e 3020 2f20    alpha = 2.0 / 
+0000d550: 2831 2e30 202b 206e 702e 6578 7028 2d31  (1.0 + np.exp(-1
+0000d560: 3020 2a20 7029 2920 2d20 310a 2020 2020  0 * p)) - 1.    
+0000d570: 2020 2020 2020 2020 2020 2020 2320 616c              # al
+0000d580: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+0000d590: 2020 2020 2020 2020 5f2c 205f 2c20 6c6f          _, _, lo
+0000d5a0: 7373 5f64 6963 7420 3d20 6d6f 6465 6c2e  ss_dict = model.
+0000d5b0: 636f 6d70 7574 655f 6f75 7470 7574 735f  compute_outputs_
+0000d5c0: 616e 645f 6c6f 7373 280a 2020 2020 2020  and_loss(.      
+0000d5d0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0000d5e0: 7461 5f73 6f75 7263 652c 2064 6174 615f  ta_source, data_
+0000d5f0: 7461 7267 6574 2c20 6461 7461 5f74 6172  target, data_tar
+0000d600: 6765 745f 756e 6c2c 2063 7269 7465 7269  get_unl, criteri
+0000d610: 6f6e 2c20 616c 7068 610a 2020 2020 2020  on, alpha.      
+0000d620: 2020 2020 2020 2020 2020 2920 2023 2054            )  # T
+0000d630: 4f20 4348 4543 4b0a 2020 2020 2020 2020  O CHECK.        
+0000d640: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0000d650: 6562 7567 2866 2254 7261 696e 206c 6f73  ebug(f"Train los
+0000d660: 7320 6469 6374 696f 6e61 7279 207b 6c6f  s dictionary {lo
+0000d670: 7373 5f64 6963 747d 2229 0a20 2020 2020  ss_dict}").     
+0000d680: 2020 2020 2020 2020 2020 206c 6f73 7320             loss 
+0000d690: 3d20 6c6f 7373 5f64 6963 745b 226c 6f73  = loss_dict["los
+0000d6a0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
+0000d6b0: 2020 2020 6c6f 7373 2e62 6163 6b77 6172      loss.backwar
+0000d6c0: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
+0000d6d0: 2020 2020 6966 2028 6920 2b20 3129 2025      if (i + 1) %
+0000d6e0: 2073 656c 662e 6163 6375 6d75 6c61 7469   self.accumulati
+0000d6f0: 6f6e 5f73 7465 7073 203d 3d20 303a 0a20  on_steps == 0:. 
+0000d700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d710: 2020 2073 7465 705f 666c 6167 203d 2046     step_flag = F
+0000d720: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0000d730: 2020 2020 2020 2020 206f 7074 696d 697a           optimiz
+0000d740: 6572 2e73 7465 7028 290a 2020 2020 2020  er.step().      
+0000d750: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000d760: 7469 6d69 7a65 722e 7a65 726f 5f67 7261  timizer.zero_gra
+0000d770: 6428 290a 0a20 2020 2020 2020 2020 2020  d()..           
+0000d780: 2020 2020 2020 2020 2064 656c 206c 6f73           del los
+0000d790: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0000d7a0: 2020 2020 2020 2023 2045 7661 6c75 6174         # Evaluat
+0000d7b0: 6520 7468 6520 6d6f 6465 6c20 6f6e 6c79  e the model only
+0000d7c0: 2077 6865 6e20 6e6f 2067 7261 6469 656e   when no gradien
+0000d7d0: 7473 2061 7265 2061 6363 756d 756c 6174  ts are accumulat
+0000d7e0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0000d7f0: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
 0000d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d810: 2020 2020 206d 6f64 656c 2c0a 2020 2020       model,.    
-0000d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d830: 2020 2020 2020 2020 7472 6169 6e5f 7461          train_ta
-0000d840: 7267 6574 5f6c 6f61 6465 722c 0a20 2020  rget_loader,.   
-0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d860: 2020 2020 2020 2020 2063 7269 7465 7269           criteri
-0000d870: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d890: 616c 7068 612c 0a20 2020 2020 2020 2020  alpha,.         
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8b0: 2020 2074 6172 6765 743d 5472 7565 2c0a     target=True,.
+0000d810: 2020 2020 7365 6c66 2e65 7661 6c75 6174      self.evaluat
+0000d820: 696f 6e5f 7374 6570 7320 213d 2030 0a20  ion_steps != 0. 
+0000d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d840: 2020 2020 2020 2061 6e64 2028 6920 2b20         and (i + 
+0000d850: 3129 2025 2073 656c 662e 6576 616c 7561  1) % self.evalua
+0000d860: 7469 6f6e 5f73 7465 7073 203d 3d20 300a  tion_steps == 0.
+0000d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d880: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0000d890: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000d8a0: 7661 6c75 6174 696f 6e5f 666c 6167 203d  valuation_flag =
+0000d8b0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
 0000d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8d0: 2020 2020 2020 2020 2920 2023 2054 4f20          )  # TO 
-0000d8e0: 4348 4543 4b0a 0a20 2020 2020 2020 2020  CHECK..         
-0000d8f0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000d900: 2c20 6d65 7472 6963 735f 7661 6c69 645f  , metrics_valid_
-0000d910: 7461 7267 6574 203d 2073 656c 662e 7461  target = self.ta
-0000d920: 736b 5f6d 616e 6167 6572 2e74 6573 745f  sk_manager.test_
-0000d930: 6461 280a 2020 2020 2020 2020 2020 2020  da(.            
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 6d6f 6465 6c2c 0a20 2020 2020 2020 2020  model,.         
-0000d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d970: 2020 2076 616c 6964 5f6c 6f61 6465 722c     valid_loader,
-0000d980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d990: 2020 2020 2020 2020 2020 2020 2063 7269               cri
-0000d9a0: 7465 7269 6f6e 2c0a 2020 2020 2020 2020  terion,.        
-0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9c0: 2020 2020 616c 7068 612c 0a20 2020 2020      alpha,.     
+0000d8d0: 2320 4576 616c 7561 7465 206f 6e20 7461  # Evaluate on ta
+0000d8e0: 7267 6574 2064 6174 610a 2020 2020 2020  rget data.      
+0000d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d900: 2020 6c6f 6767 6572 2e69 6e66 6f28 2245    logger.info("E
+0000d910: 7661 6c75 6174 696f 6e20 6f6e 2074 6172  valuation on tar
+0000d920: 6765 7420 6461 7461 2229 0a20 2020 2020  get data").     
+0000d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d940: 2020 205f 2c20 6d65 7472 6963 735f 7472     _, metrics_tr
+0000d950: 6169 6e5f 7461 7267 6574 203d 2073 656c  ain_target = sel
+0000d960: 662e 7461 736b 5f6d 616e 6167 6572 2e74  f.task_manager.t
+0000d970: 6573 745f 6461 280a 2020 2020 2020 2020  est_da(.        
+0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d990: 2020 2020 6d6f 6465 6c2c 0a20 2020 2020      model,.     
+0000d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9b0: 2020 2020 2020 2074 7261 696e 5f74 6172         train_tar
+0000d9c0: 6765 745f 6c6f 6164 6572 2c0a 2020 2020  get_loader,.    
 0000d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9e0: 2020 2020 2020 2074 6172 6765 743d 5472         target=Tr
-0000d9f0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000da00: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da20: 2020 2020 2020 206d 6f64 656c 2e74 7261         model.tra
-0000da30: 696e 2829 0a20 2020 2020 2020 2020 2020  in().           
-0000da40: 2020 2020 2020 2020 2020 2020 2074 7261               tra
-0000da50: 696e 5f74 6172 6765 745f 6c6f 6164 6572  in_target_loader
-0000da60: 2e64 6174 6173 6574 2e74 7261 696e 2829  .dataset.train()
-0000da70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000da80: 2020 2020 2020 2020 2020 6c6f 675f 7772            log_wr
-0000da90: 6974 6572 2e73 7465 7028 0a20 2020 2020  iter.step(.     
-0000daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dab0: 2020 2020 2020 2065 706f 6368 2c0a 2020         epoch,.  
-0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dad0: 2020 2020 2020 2020 2020 692c 0a20 2020            i,.   
+0000d9e0: 2020 2020 2020 2020 6372 6974 6572 696f          criterio
+0000d9f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0000da00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000da10: 6c70 6861 2c0a 2020 2020 2020 2020 2020  lpha,.          
+0000da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da30: 2020 7461 7267 6574 3d54 7275 652c 0a20    target=True,. 
+0000da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da50: 2020 2020 2020 2029 2020 2320 544f 2043         )  # TO C
+0000da60: 4845 434b 0a0a 2020 2020 2020 2020 2020  HECK..          
+0000da70: 2020 2020 2020 2020 2020 2020 2020 5f2c                _,
+0000da80: 206d 6574 7269 6373 5f76 616c 6964 5f74   metrics_valid_t
+0000da90: 6172 6765 7420 3d20 7365 6c66 2e74 6173  arget = self.tas
+0000daa0: 6b5f 6d61 6e61 6765 722e 7465 7374 5f64  k_manager.test_d
+0000dab0: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+0000dac0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000dad0: 6f64 656c 2c0a 2020 2020 2020 2020 2020  odel,.          
 0000dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000daf0: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
-0000db00: 5f74 7261 696e 5f74 6172 6765 742c 0a20  _train_target,. 
-0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db20: 2020 2020 2020 2020 2020 206d 6574 7269             metri
-0000db30: 6373 5f76 616c 6964 5f74 6172 6765 742c  cs_valid_target,
-0000db40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000db50: 2020 2020 2020 2020 2020 2020 206c 656e               len
-0000db60: 2874 7261 696e 5f74 6172 6765 745f 6c6f  (train_target_lo
-0000db70: 6164 6572 292c 0a20 2020 2020 2020 2020  ader),.         
-0000db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db90: 2020 2022 7472 6169 6e69 6e67 5f74 6172     "training_tar
-0000dba0: 6765 742e 7473 7622 2c0a 2020 2020 2020  get.tsv",.      
-0000dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbc0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000dbd0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0000dbe0: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-0000dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc00: 2020 2020 2066 227b 7365 6c66 2e6d 6f64       f"{self.mod
-0000dc10: 657d 206c 6576 656c 2074 7261 696e 696e  e} level trainin
-0000dc20: 6720 6c6f 7373 2066 6f72 2074 6172 6765  g loss for targe
-0000dc30: 7420 6461 7461 2069 7320 7b6d 6574 7269  t data is {metri
-0000dc40: 6373 5f74 7261 696e 5f74 6172 6765 745b  cs_train_target[
-0000dc50: 276c 6f73 7327 5d7d 2022 0a20 2020 2020  'loss']} ".     
+0000daf0: 2020 7661 6c69 645f 6c6f 6164 6572 2c0a    valid_loader,.
+0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db10: 2020 2020 2020 2020 2020 2020 6372 6974              crit
+0000db20: 6572 696f 6e2c 0a20 2020 2020 2020 2020  erion,.         
+0000db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db40: 2020 2061 6c70 6861 2c0a 2020 2020 2020     alpha,.      
+0000db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db60: 2020 2020 2020 7461 7267 6574 3d54 7275        target=Tru
+0000db70: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000db80: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dba0: 2020 2020 2020 6d6f 6465 6c2e 7472 6169        model.trai
+0000dbb0: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+0000dbc0: 2020 2020 2020 2020 2020 2020 7472 6169              trai
+0000dbd0: 6e5f 7461 7267 6574 5f6c 6f61 6465 722e  n_target_loader.
+0000dbe0: 6461 7461 7365 742e 7472 6169 6e28 290a  dataset.train().
+0000dbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc00: 2020 2020 2020 2020 206c 6f67 5f77 7269           log_wri
+0000dc10: 7465 722e 7374 6570 280a 2020 2020 2020  ter.step(.      
+0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc30: 2020 2020 2020 6570 6f63 682c 0a20 2020        epoch,.   
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc50: 2020 2020 2020 2020 2069 2c0a 2020 2020           i,.    
 0000dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc70: 2020 2020 2020 2066 2261 7420 7468 6520         f"at the 
-0000dc80: 656e 6420 6f66 2069 7465 7261 7469 6f6e  end of iteration
-0000dc90: 207b 697d 220a 2020 2020 2020 2020 2020   {i}".          
-0000dca0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcc0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0000dcd0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-0000dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcf0: 2066 227b 7365 6c66 2e6d 6f64 657d 206c   f"{self.mode} l
-0000dd00: 6576 656c 2076 616c 6964 6174 696f 6e20  evel validation 
-0000dd10: 6c6f 7373 2066 6f72 2074 6172 6765 7420  loss for target 
-0000dd20: 6461 7461 2069 7320 7b6d 6574 7269 6373  data is {metrics
-0000dd30: 5f76 616c 6964 5f74 6172 6765 745b 276c  _valid_target['l
-0000dd40: 6f73 7327 5d7d 2022 0a20 2020 2020 2020  oss']} ".       
-0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd60: 2020 2020 2066 2261 7420 7468 6520 656e       f"at the en
-0000dd70: 6420 6f66 2069 7465 7261 7469 6f6e 207b  d of iteration {
-0000dd80: 697d 220a 2020 2020 2020 2020 2020 2020  i}".            
-0000dd90: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddb0: 2020 2020 2020 2023 2045 7661 6c75 6174         # Evaluat
-0000ddc0: 6520 6f6e 2073 6f75 7263 6520 6461 7461  e on source data
-0000ddd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dde0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000ddf0: 696e 666f 2822 4576 616c 7561 7469 6f6e  info("Evaluation
-0000de00: 206f 6e20 736f 7572 6365 2064 6174 6122   on source data"
-0000de10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000de20: 2020 2020 2020 2020 2020 5f2c 206d 6574            _, met
-0000de30: 7269 6373 5f74 7261 696e 5f73 6f75 7263  rics_train_sourc
-0000de40: 6520 3d20 7365 6c66 2e74 6173 6b5f 6d61  e = self.task_ma
-0000de50: 6e61 6765 722e 7465 7374 5f64 6128 0a20  nager.test_da(. 
+0000dc70: 2020 2020 2020 2020 6d65 7472 6963 735f          metrics_
+0000dc80: 7472 6169 6e5f 7461 7267 6574 2c0a 2020  train_target,.  
+0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dca0: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
+0000dcb0: 735f 7661 6c69 645f 7461 7267 6574 2c0a  s_valid_target,.
+0000dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dcd0: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+0000dce0: 7472 6169 6e5f 7461 7267 6574 5f6c 6f61  train_target_loa
+0000dcf0: 6465 7229 2c0a 2020 2020 2020 2020 2020  der),.          
+0000dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd10: 2020 2274 7261 696e 696e 675f 7461 7267    "training_targ
+0000dd20: 6574 2e74 7376 222c 0a20 2020 2020 2020  et.tsv",.       
+0000dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000dd50: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000dd60: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
+0000dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd80: 2020 2020 6622 7b73 656c 662e 6d6f 6465      f"{self.mode
+0000dd90: 7d20 6c65 7665 6c20 7472 6169 6e69 6e67  } level training
+0000dda0: 206c 6f73 7320 666f 7220 7461 7267 6574   loss for target
+0000ddb0: 2064 6174 6120 6973 207b 6d65 7472 6963   data is {metric
+0000ddc0: 735f 7472 6169 6e5f 7461 7267 6574 5b27  s_train_target['
+0000ddd0: 6c6f 7373 275d 7d20 220a 2020 2020 2020  loss']} ".      
+0000dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ddf0: 2020 2020 2020 6622 6174 2074 6865 2065        f"at the e
+0000de00: 6e64 206f 6620 6974 6572 6174 696f 6e20  nd of iteration 
+0000de10: 7b69 7d22 0a20 2020 2020 2020 2020 2020  {i}".           
+0000de20: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de40: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0000de50: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
 0000de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0000de80: 2c20 7472 6169 6e5f 736f 7572 6365 5f6c  , train_source_l
-0000de90: 6f61 6465 722c 2063 7269 7465 7269 6f6e  oader, criterion
-0000dea0: 2c20 616c 7068 610a 2020 2020 2020 2020  , alpha.        
-0000deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dec0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000ded0: 2020 2020 2020 2020 2020 5f2c 206d 6574            _, met
-0000dee0: 7269 6373 5f76 616c 6964 5f73 6f75 7263  rics_valid_sourc
-0000def0: 6520 3d20 7365 6c66 2e74 6173 6b5f 6d61  e = self.task_ma
-0000df00: 6e61 6765 722e 7465 7374 5f64 6128 0a20  nager.test_da(. 
-0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df20: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0000df30: 2c20 7661 6c69 645f 736f 7572 6365 5f6c  , valid_source_l
-0000df40: 6f61 6465 722c 2063 7269 7465 7269 6f6e  oader, criterion
-0000df50: 2c20 616c 7068 610a 2020 2020 2020 2020  , alpha.        
-0000df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df70: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000df80: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0000df90: 2e74 7261 696e 2829 0a20 2020 2020 2020  .train().       
-0000dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfb0: 2074 7261 696e 5f73 6f75 7263 655f 6c6f   train_source_lo
-0000dfc0: 6164 6572 2e64 6174 6173 6574 2e74 7261  ader.dataset.tra
-0000dfd0: 696e 2829 0a0a 2020 2020 2020 2020 2020  in()..          
-0000dfe0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0000dff0: 675f 7772 6974 6572 2e73 7465 7028 0a20  g_writer.step(. 
-0000e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e010: 2020 2020 2020 2020 2020 2065 706f 6368             epoch
-0000e020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e030: 2020 2020 2020 2020 2020 2020 2020 692c                i,
+0000de70: 6622 7b73 656c 662e 6d6f 6465 7d20 6c65  f"{self.mode} le
+0000de80: 7665 6c20 7661 6c69 6461 7469 6f6e 206c  vel validation l
+0000de90: 6f73 7320 666f 7220 7461 7267 6574 2064  oss for target d
+0000dea0: 6174 6120 6973 207b 6d65 7472 6963 735f  ata is {metrics_
+0000deb0: 7661 6c69 645f 7461 7267 6574 5b27 6c6f  valid_target['lo
+0000dec0: 7373 275d 7d20 220a 2020 2020 2020 2020  ss']} ".        
+0000ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dee0: 2020 2020 6622 6174 2074 6865 2065 6e64      f"at the end
+0000def0: 206f 6620 6974 6572 6174 696f 6e20 7b69   of iteration {i
+0000df00: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0000df10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000df20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df30: 2020 2020 2020 2320 4576 616c 7561 7465        # Evaluate
+0000df40: 206f 6e20 736f 7572 6365 2064 6174 610a   on source data.
+0000df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df60: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0000df70: 6e66 6f28 2245 7661 6c75 6174 696f 6e20  nfo("Evaluation 
+0000df80: 6f6e 2073 6f75 7263 6520 6461 7461 2229  on source data")
+0000df90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dfa0: 2020 2020 2020 2020 205f 2c20 6d65 7472           _, metr
+0000dfb0: 6963 735f 7472 6169 6e5f 736f 7572 6365  ics_train_source
+0000dfc0: 203d 2073 656c 662e 7461 736b 5f6d 616e   = self.task_man
+0000dfd0: 6167 6572 2e74 6573 745f 6461 280a 2020  ager.test_da(.  
+0000dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dff0: 2020 2020 2020 2020 2020 6d6f 6465 6c2c            model,
+0000e000: 2074 7261 696e 5f73 6f75 7263 655f 6c6f   train_source_lo
+0000e010: 6164 6572 2c20 6372 6974 6572 696f 6e2c  ader, criterion,
+0000e020: 2061 6c70 6861 0a20 2020 2020 2020 2020   alpha.         
+0000e030: 2020 2020 2020 2020 2020 2020 2020 2029                 )
 0000e040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e050: 2020 2020 2020 2020 2020 2020 206d 6574               met
-0000e060: 7269 6373 5f74 7261 696e 5f73 6f75 7263  rics_train_sourc
-0000e070: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e080: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000e090: 6574 7269 6373 5f76 616c 6964 5f73 6f75  etrics_valid_sou
-0000e0a0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0c0: 206c 656e 2874 7261 696e 5f73 6f75 7263   len(train_sourc
-0000e0d0: 655f 6c6f 6164 6572 292c 0a20 2020 2020  e_loader),.     
-0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000e100: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000e110: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+0000e050: 2020 2020 2020 2020 205f 2c20 6d65 7472           _, metr
+0000e060: 6963 735f 7661 6c69 645f 736f 7572 6365  ics_valid_source
+0000e070: 203d 2073 656c 662e 7461 736b 5f6d 616e   = self.task_man
+0000e080: 6167 6572 2e74 6573 745f 6461 280a 2020  ager.test_da(.  
+0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0a0: 2020 2020 2020 2020 2020 6d6f 6465 6c2c            model,
+0000e0b0: 2076 616c 6964 5f73 6f75 7263 655f 6c6f   valid_source_lo
+0000e0c0: 6164 6572 2c20 6372 6974 6572 696f 6e2c  ader, criterion,
+0000e0d0: 2061 6c70 6861 0a20 2020 2020 2020 2020   alpha.         
+0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000e0f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e100: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
+0000e110: 7472 6169 6e28 290a 2020 2020 2020 2020  train().        
 0000e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e130: 2020 2020 2020 6622 7b73 656c 662e 6d6f        f"{self.mo
-0000e140: 6465 7d20 6c65 7665 6c20 7472 6169 6e69  de} level traini
-0000e150: 6e67 206c 6f73 7320 666f 7220 736f 7572  ng loss for sour
-0000e160: 6365 2064 6174 6120 6973 207b 6d65 7472  ce data is {metr
-0000e170: 6963 735f 7472 6169 6e5f 736f 7572 6365  ics_train_source
-0000e180: 5b27 6c6f 7373 275d 7d20 220a 2020 2020  ['loss']} ".    
-0000e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1a0: 2020 2020 2020 2020 6622 6174 2074 6865          f"at the
-0000e1b0: 2065 6e64 206f 6620 6974 6572 6174 696f   end of iteratio
-0000e1c0: 6e20 7b69 7d22 0a20 2020 2020 2020 2020  n {i}".         
-0000e1d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000e1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e1f0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000e200: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0000e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e220: 2020 6622 7b73 656c 662e 6d6f 6465 7d20    f"{self.mode} 
-0000e230: 6c65 7665 6c20 7661 6c69 6461 7469 6f6e  level validation
-0000e240: 206c 6f73 7320 666f 7220 736f 7572 6365   loss for source
-0000e250: 2064 6174 6120 6973 207b 6d65 7472 6963   data is {metric
-0000e260: 735f 7661 6c69 645f 736f 7572 6365 5b27  s_valid_source['
-0000e270: 6c6f 7373 275d 7d20 220a 2020 2020 2020  loss']} ".      
-0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e290: 2020 2020 2020 6622 6174 2074 6865 2065        f"at the e
-0000e2a0: 6e64 206f 6620 6974 6572 6174 696f 6e20  nd of iteration 
-0000e2b0: 7b69 7d22 0a20 2020 2020 2020 2020 2020  {i}".           
-0000e2c0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0000e2d0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-0000e2e0: 206e 6f20 7374 6570 2068 6173 2062 6565   no step has bee
-0000e2f0: 6e20 7065 7266 6f72 6d65 642c 2072 6169  n performed, rai
-0000e300: 7365 2045 7863 6570 7469 6f6e 0a20 2020  se Exception.   
-0000e310: 2020 2020 2020 2020 2069 6620 7374 6570           if step
-0000e320: 5f66 6c61 673a 0a20 2020 2020 2020 2020  _flag:.         
-0000e330: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0000e340: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-0000e350: 2020 2020 2020 2020 2020 2020 2254 6865              "The
-0000e360: 206d 6f64 656c 2068 6173 206e 6f74 2062   model has not b
-0000e370: 6565 6e20 7570 6461 7465 6420 6f6e 6365  een updated once
-0000e380: 2069 6e20 7468 6520 6570 6f63 682e 2054   in the epoch. T
-0000e390: 6865 2061 6363 756d 756c 6174 696f 6e20  he accumulation 
-0000e3a0: 7374 6570 206d 6179 2062 6520 746f 6f20  step may be too 
-0000e3b0: 6c61 7267 652e 220a 2020 2020 2020 2020  large.".        
-0000e3c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000e3d0: 2020 2020 2020 2023 2049 6620 6e6f 2065         # If no e
-0000e3e0: 7661 6c75 6174 696f 6e20 6861 7320 6265  valuation has be
-0000e3f0: 656e 2070 6572 666f 726d 6564 2c20 7761  en performed, wa
-0000e400: 726e 2074 6865 2075 7365 720a 2020 2020  rn the user.    
-0000e410: 2020 2020 2020 2020 656c 6966 2065 7661          elif eva
-0000e420: 6c75 6174 696f 6e5f 666c 6167 2061 6e64  luation_flag and
-0000e430: 2073 656c 662e 6576 616c 7561 7469 6f6e   self.evaluation
-0000e440: 5f73 7465 7073 2021 3d20 303a 0a20 2020  _steps != 0:.   
-0000e450: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000e460: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e480: 2066 2259 6f75 7220 6576 616c 7561 7469   f"Your evaluati
-0000e490: 6f6e 2073 7465 7073 207b 7365 6c66 2e65  on steps {self.e
-0000e4a0: 7661 6c75 6174 696f 6e5f 7374 6570 737d  valuation_steps}
-0000e4b0: 2061 7265 2074 6f6f 2062 6967 2022 0a20   are too big ". 
-0000e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4d0: 2020 2066 2263 6f6d 7061 7265 6420 746f     f"compared to
-0000e4e0: 2074 6865 2073 697a 6520 6f66 2074 6865   the size of the
-0000e4f0: 2064 6174 6173 6574 2e20 220a 2020 2020   dataset. ".    
-0000e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e510: 6622 5468 6520 6d6f 6465 6c20 6973 2065  f"The model is e
-0000e520: 7661 6c75 6174 6564 206f 6e6c 7920 6f6e  valuated only on
-0000e530: 6365 2061 7420 7468 6520 656e 6420 6570  ce at the end ep
-0000e540: 6f63 6873 2e22 0a20 2020 2020 2020 2020  ochs.".         
-0000e550: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000e560: 2020 2020 2020 2320 5570 6461 7465 2077        # Update w
-0000e570: 6569 6768 7473 206f 6e65 206c 6173 7420  eights one last 
-0000e580: 7469 6d65 2069 6620 6772 6164 6965 6e74  time if gradient
-0000e590: 7320 7765 7265 2063 6f6d 7075 7465 6420  s were computed 
-0000e5a0: 7769 7468 6f75 7420 7570 6461 7465 0a20  without update. 
-0000e5b0: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-0000e5c0: 202b 2031 2920 2520 7365 6c66 2e61 6363   + 1) % self.acc
-0000e5d0: 756d 756c 6174 696f 6e5f 7374 6570 7320  umulation_steps 
-0000e5e0: 213d 2030 3a0a 2020 2020 2020 2020 2020  != 0:.          
-0000e5f0: 2020 2020 2020 6f70 7469 6d69 7a65 722e        optimizer.
-0000e600: 7374 6570 2829 0a20 2020 2020 2020 2020  step().         
-0000e610: 2020 2020 2020 206f 7074 696d 697a 6572         optimizer
-0000e620: 2e7a 6572 6f5f 6772 6164 2829 0a20 2020  .zero_grad().   
-0000e630: 2020 2020 2020 2020 2023 2041 6c77 6179           # Alway
-0000e640: 7320 7465 7374 2074 6865 2072 6573 756c  s test the resul
-0000e650: 7473 2061 6e64 2073 6176 6520 7468 656d  ts and save them
-0000e660: 206f 6e63 6520 6174 2074 6865 2065 6e64   once at the end
-0000e670: 206f 6620 7468 6520 6570 6f63 680a 2020   of the epoch.  
-0000e680: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
-0000e690: 7a65 726f 5f67 7261 6428 290a 2020 2020  zero_grad().    
-0000e6a0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-0000e6b0: 6562 7567 2866 224c 6173 7420 6368 6563  ebug(f"Last chec
-0000e6c0: 6b70 6f69 6e74 2061 7420 7468 6520 656e  kpoint at the en
-0000e6d0: 6420 6f66 2074 6865 2065 706f 6368 207b  d of the epoch {
-0000e6e0: 6570 6f63 687d 2229 0a0a 2020 2020 2020  epoch}")..      
-0000e6f0: 2020 2020 2020 6966 2065 7661 6c75 6174        if evaluat
-0000e700: 655f 736f 7572 6365 3a0a 2020 2020 2020  e_source:.      
-0000e710: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000e720: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-0000e730: 2020 2020 2020 2020 2020 2066 2245 7661             f"Eva
-0000e740: 6c75 6174 6520 736f 7572 6365 2064 6174  luate source dat
-0000e750: 6120 6174 2074 6865 2065 6e64 206f 6620  a at the end of 
-0000e760: 7468 6520 6570 6f63 6820 7b65 706f 6368  the epoch {epoch
-0000e770: 7d20 7769 7468 2061 6c70 6861 3a20 7b61  } with alpha: {a
-0000e780: 6c70 6861 7d2e 220a 2020 2020 2020 2020  lpha}.".        
-0000e790: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000e7a0: 2020 2020 2020 2020 2020 5f2c 206d 6574            _, met
-0000e7b0: 7269 6373 5f74 7261 696e 5f73 6f75 7263  rics_train_sourc
-0000e7c0: 6520 3d20 7365 6c66 2e74 6173 6b5f 6d61  e = self.task_ma
-0000e7d0: 6e61 6765 722e 7465 7374 5f64 6128 0a20  nager.test_da(. 
-0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7f0: 2020 206d 6f64 656c 2c0a 2020 2020 2020     model,.      
-0000e800: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000e810: 6169 6e5f 736f 7572 6365 5f6c 6f61 6465  ain_source_loade
-0000e820: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000e830: 2020 2020 2020 2063 7269 7465 7269 6f6e         criterion
-0000e840: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e850: 2020 2020 2020 616c 7068 612c 0a20 2020        alpha,.   
-0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e870: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0000e880: 2020 2020 2020 2020 2020 2046 616c 7365             False
-0000e890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e8a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000e8b0: 2020 2020 5f2c 206d 6574 7269 6373 5f76      _, metrics_v
-0000e8c0: 616c 6964 5f73 6f75 7263 6520 3d20 7365  alid_source = se
-0000e8d0: 6c66 2e74 6173 6b5f 6d61 6e61 6765 722e  lf.task_manager.
-0000e8e0: 7465 7374 5f64 6128 0a20 2020 2020 2020  test_da(.       
-0000e8f0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000e900: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-0000e910: 2020 2020 2020 2020 7661 6c69 645f 736f          valid_so
-0000e920: 7572 6365 5f6c 6f61 6465 722c 0a20 2020  urce_loader,.   
-0000e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e940: 2063 7269 7465 7269 6f6e 2c0a 2020 2020   criterion,.    
-0000e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e960: 616c 7068 612c 0a20 2020 2020 2020 2020  alpha,.         
-0000e970: 2020 2020 2020 2020 2020 2054 7275 652c             True,
-0000e980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e990: 2020 2020 2046 616c 7365 2c0a 2020 2020       False,.    
-0000e9a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000e9b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000e9c0: 6f67 5f77 7269 7465 722e 7374 6570 280a  og_writer.step(.
-0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9e0: 2020 2020 6570 6f63 682c 0a20 2020 2020      epoch,.     
-0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000ea00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ea10: 2020 2020 2020 6d65 7472 6963 735f 7472        metrics_tr
-0000ea20: 6169 6e5f 736f 7572 6365 2c0a 2020 2020  ain_source,.    
-0000ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea40: 6d65 7472 6963 735f 7661 6c69 645f 736f  metrics_valid_so
-0000ea50: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0000ea60: 2020 2020 2020 2020 2020 6c65 6e28 7472            len(tr
-0000ea70: 6169 6e5f 736f 7572 6365 5f6c 6f61 6465  ain_source_loade
-0000ea80: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
-0000ea90: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000eaa0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0000eab0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-0000eac0: 2020 2020 2020 2020 6622 7b73 656c 662e          f"{self.
-0000ead0: 6d6f 6465 7d20 6c65 7665 6c20 7472 6169  mode} level trai
-0000eae0: 6e69 6e67 206c 6f73 7320 666f 7220 736f  ning loss for so
-0000eaf0: 7572 6365 2064 6174 6120 6973 207b 6d65  urce data is {me
-0000eb00: 7472 6963 735f 7472 6169 6e5f 736f 7572  trics_train_sour
-0000eb10: 6365 5b27 6c6f 7373 275d 7d20 220a 2020  ce['loss']} ".  
-0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb30: 2020 6622 6174 2074 6865 2065 6e64 206f    f"at the end o
-0000eb40: 6620 6974 6572 6174 696f 6e20 7b69 7d22  f iteration {i}"
-0000eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eb60: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000eb70: 2020 206c 6f67 6765 722e 696e 666f 280a     logger.info(.
-0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb90: 2020 2020 6622 7b73 656c 662e 6d6f 6465      f"{self.mode
-0000eba0: 7d20 6c65 7665 6c20 7661 6c69 6461 7469  } level validati
-0000ebb0: 6f6e 206c 6f73 7320 666f 7220 736f 7572  on loss for sour
-0000ebc0: 6365 2064 6174 6120 6973 207b 6d65 7472  ce data is {metr
-0000ebd0: 6963 735f 7661 6c69 645f 736f 7572 6365  ics_valid_source
-0000ebe0: 5b27 6c6f 7373 275d 7d20 220a 2020 2020  ['loss']} ".    
-0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec00: 6622 6174 2074 6865 2065 6e64 206f 6620  f"at the end of 
-0000ec10: 6974 6572 6174 696f 6e20 7b69 7d22 0a20  iteration {i}". 
-0000ec20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000ec30: 0a0a 2020 2020 2020 2020 2020 2020 5f2c  ..            _,
-0000ec40: 206d 6574 7269 6373 5f74 7261 696e 5f74   metrics_train_t
-0000ec50: 6172 6765 7420 3d20 7365 6c66 2e74 6173  arget = self.tas
-0000ec60: 6b5f 6d61 6e61 6765 722e 7465 7374 5f64  k_manager.test_d
-0000ec70: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-0000ec80: 2020 206d 6f64 656c 2c0a 2020 2020 2020     model,.      
-0000ec90: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-0000eca0: 7461 7267 6574 5f6c 6f61 6465 722c 0a20  target_loader,. 
-0000ecb0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000ecc0: 7269 7465 7269 6f6e 2c0a 2020 2020 2020  riterion,.      
-0000ecd0: 2020 2020 2020 2020 2020 616c 7068 612c            alpha,
-0000ece0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ecf0: 2074 6172 6765 743d 5472 7565 2c0a 2020   target=True,.  
-0000ed00: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000ed10: 2020 2020 2020 2020 5f2c 206d 6574 7269          _, metri
-0000ed20: 6373 5f76 616c 6964 5f74 6172 6765 7420  cs_valid_target 
-0000ed30: 3d20 7365 6c66 2e74 6173 6b5f 6d61 6e61  = self.task_mana
-0000ed40: 6765 722e 7465 7374 5f64 6128 0a20 2020  ger.test_da(.   
-0000ed50: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000ed60: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-0000ed70: 2020 2020 7661 6c69 645f 6c6f 6164 6572      valid_loader
-0000ed80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ed90: 2020 6372 6974 6572 696f 6e2c 0a20 2020    criterion,.   
-0000eda0: 2020 2020 2020 2020 2020 2020 2061 6c70               alp
-0000edb0: 6861 2c0a 2020 2020 2020 2020 2020 2020  ha,.            
-0000edc0: 2020 2020 7461 7267 6574 3d54 7275 652c      target=True,
-0000edd0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0000ede0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000edf0: 6c2e 7472 6169 6e28 290a 2020 2020 2020  l.train().      
-0000ee00: 2020 2020 2020 7472 6169 6e5f 736f 7572        train_sour
-0000ee10: 6365 5f6c 6f61 6465 722e 6461 7461 7365  ce_loader.datase
-0000ee20: 742e 7472 6169 6e28 290a 2020 2020 2020  t.train().      
-0000ee30: 2020 2020 2020 7472 6169 6e5f 7461 7267        train_targ
-0000ee40: 6574 5f6c 6f61 6465 722e 6461 7461 7365  et_loader.datase
-0000ee50: 742e 7472 6169 6e28 290a 0a20 2020 2020  t.train()..     
-0000ee60: 2020 2020 2020 206c 6f67 5f77 7269 7465         log_write
-0000ee70: 722e 7374 6570 280a 2020 2020 2020 2020  r.step(.        
-0000ee80: 2020 2020 2020 2020 6570 6f63 682c 0a20          epoch,. 
-0000ee90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000eea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000eeb0: 2020 6d65 7472 6963 735f 7472 6169 6e5f    metrics_train_
-0000eec0: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
-0000eed0: 2020 2020 2020 2020 6d65 7472 6963 735f          metrics_
-0000eee0: 7661 6c69 645f 7461 7267 6574 2c0a 2020  valid_target,.  
-0000eef0: 2020 2020 2020 2020 2020 2020 2020 6c65                le
-0000ef00: 6e28 7472 6169 6e5f 7461 7267 6574 5f6c  n(train_target_l
-0000ef10: 6f61 6465 7229 2c0a 2020 2020 2020 2020  oader),.        
-0000ef20: 2020 2020 2020 2020 2274 7261 696e 696e          "trainin
-0000ef30: 675f 7461 7267 6574 2e74 7376 222c 0a20  g_target.tsv",. 
-0000ef40: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000ef50: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000ef60: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-0000ef70: 2020 2020 2020 2066 227b 7365 6c66 2e6d         f"{self.m
-0000ef80: 6f64 657d 206c 6576 656c 2074 7261 696e  ode} level train
-0000ef90: 696e 6720 6c6f 7373 2066 6f72 2074 6172  ing loss for tar
-0000efa0: 6765 7420 6461 7461 2069 7320 7b6d 6574  get data is {met
-0000efb0: 7269 6373 5f74 7261 696e 5f74 6172 6765  rics_train_targe
-0000efc0: 745b 276c 6f73 7327 5d7d 2022 0a20 2020  t['loss']} ".   
-0000efd0: 2020 2020 2020 2020 2020 2020 2066 2261               f"a
-0000efe0: 7420 7468 6520 656e 6420 6f66 2069 7465  t the end of ite
-0000eff0: 7261 7469 6f6e 207b 697d 220a 2020 2020  ration {i}".    
-0000f000: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000f010: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-0000f020: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-0000f030: 2020 2066 227b 7365 6c66 2e6d 6f64 657d     f"{self.mode}
-0000f040: 206c 6576 656c 2076 616c 6964 6174 696f   level validatio
-0000f050: 6e20 6c6f 7373 2066 6f72 2074 6172 6765  n loss for targe
-0000f060: 7420 6461 7461 2069 7320 7b6d 6574 7269  t data is {metri
-0000f070: 6373 5f76 616c 6964 5f74 6172 6765 745b  cs_valid_target[
-0000f080: 276c 6f73 7327 5d7d 2022 0a20 2020 2020  'loss']} ".     
-0000f090: 2020 2020 2020 2020 2020 2066 2261 7420             f"at 
-0000f0a0: 7468 6520 656e 6420 6f66 2069 7465 7261  the end of itera
-0000f0b0: 7469 6f6e 207b 697d 220a 2020 2020 2020  tion {i}".      
-0000f0c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000f0d0: 2020 2020 2023 2053 6176 6520 6368 6563       # Save chec
-0000f0e0: 6b70 6f69 6e74 7320 616e 6420 6265 7374  kpoints and best
-0000f0f0: 206d 6f64 656c 730a 2020 2020 2020 2020   models.        
-0000f100: 2020 2020 6265 7374 5f64 6963 7420 3d20      best_dict = 
-0000f110: 7265 7461 696e 5f62 6573 742e 7374 6570  retain_best.step
-0000f120: 286d 6574 7269 6373 5f76 616c 6964 5f74  (metrics_valid_t
-0000f130: 6172 6765 7429 0a20 2020 2020 2020 2020  arget).         
-0000f140: 2020 2073 656c 662e 5f77 7269 7465 5f77     self._write_w
-0000f150: 6569 6768 7473 280a 2020 2020 2020 2020  eights(.        
-0000f160: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0000f170: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-0000f180: 6f64 656c 223a 206d 6f64 656c 2e73 7461  odel": model.sta
-0000f190: 7465 5f64 6963 7428 292c 0a20 2020 2020  te_dict(),.     
-0000f1a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f1b0: 6570 6f63 6822 3a20 6570 6f63 682c 0a20  epoch": epoch,. 
-0000f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1d0: 2020 2022 6e61 6d65 223a 2073 656c 662e     "name": self.
-0000f1e0: 6172 6368 6974 6563 7475 7265 2c0a 2020  architecture,.  
-0000f1f0: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-0000f200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f210: 2062 6573 745f 6469 6374 2c0a 2020 2020   best_dict,.    
-0000f220: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
-0000f230: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0000f240: 2020 206e 6574 776f 726b 3d6e 6574 776f     network=netwo
-0000f250: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
-0000f260: 2020 2020 7361 7665 5f61 6c6c 5f6d 6f64      save_all_mod
-0000f270: 656c 733d 4661 6c73 652c 0a20 2020 2020  els=False,.     
-0000f280: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f290: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
-0000f2a0: 5f77 6569 6768 7473 280a 2020 2020 2020  _weights(.      
-0000f2b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2d0: 226f 7074 696d 697a 6572 223a 206f 7074  "optimizer": opt
-0000f2e0: 696d 697a 6572 2e73 7461 7465 5f64 6963  imizer.state_dic
-0000f2f0: 7428 292c 2020 2320 544f 204d 4f44 4946  t(),  # TO MODIF
-0000f300: 590a 2020 2020 2020 2020 2020 2020 2020  Y.              
-0000f310: 2020 2020 2020 2265 706f 6368 223a 2065        "epoch": e
-0000f320: 706f 6368 2c0a 2020 2020 2020 2020 2020  poch,.          
-0000f330: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
-0000f340: 3a20 7365 6c66 2e6f 7074 696d 697a 6572  : self.optimizer
-0000f350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f360: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000f370: 2020 2020 204e 6f6e 652c 0a20 2020 2020       None,.     
-0000f380: 2020 2020 2020 2020 2020 2073 706c 6974             split
-0000f390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f3a0: 2020 6669 6c65 6e61 6d65 3d22 6f70 7469    filename="opti
-0000f3b0: 6d69 7a65 722e 7074 682e 7461 7222 2c0a  mizer.pth.tar",.
-0000f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3d0: 7361 7665 5f61 6c6c 5f6d 6f64 656c 733d  save_all_models=
-0000f3e0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-0000f3f0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000f400: 2020 6570 6f63 6820 2b3d 2031 0a0a 2020    epoch += 1..  
-0000f410: 2020 2020 2020 7365 6c66 2e5f 7465 7374        self._test
-0000f420: 5f6c 6f61 6465 725f 7373 6461 280a 2020  _loader_ssda(.  
-0000f430: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-0000f440: 7461 7267 6574 5f6c 6f61 6465 722c 0a20  target_loader,. 
-0000f450: 2020 2020 2020 2020 2020 2063 7269 7465             crite
-0000f460: 7269 6f6e 2c0a 2020 2020 2020 2020 2020  rion,.          
-0000f470: 2020 6461 7461 5f67 726f 7570 3d22 7472    data_group="tr
-0000f480: 6169 6e22 2c0a 2020 2020 2020 2020 2020  ain",.          
-0000f490: 2020 7370 6c69 743d 7370 6c69 742c 0a20    split=split,. 
-0000f4a0: 2020 2020 2020 2020 2020 2073 656c 6563             selec
-0000f4b0: 7469 6f6e 5f6d 6574 7269 6373 3d73 656c  tion_metrics=sel
-0000f4c0: 662e 7365 6c65 6374 696f 6e5f 6d65 7472  f.selection_metr
-0000f4d0: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
-0000f4e0: 206e 6574 776f 726b 3d6e 6574 776f 726b   network=network
-0000f4f0: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
-0000f500: 7267 6574 3d54 7275 652c 0a20 2020 2020  rget=True,.     
-0000f510: 2020 2020 2020 2061 6c70 6861 3d30 2c0a         alpha=0,.
-0000f520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000f530: 2020 7365 6c66 2e5f 7465 7374 5f6c 6f61    self._test_loa
-0000f540: 6465 725f 7373 6461 280a 2020 2020 2020  der_ssda(.      
-0000f550: 2020 2020 2020 7661 6c69 645f 6c6f 6164        valid_load
-0000f560: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0000f570: 6372 6974 6572 696f 6e2c 0a20 2020 2020  criterion,.     
-0000f580: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
-0000f590: 703d 2276 616c 6964 6174 696f 6e22 2c0a  p="validation",.
-0000f5a0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
-0000f5b0: 743d 7370 6c69 742c 0a20 2020 2020 2020  t=split,.       
-0000f5c0: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
-0000f5d0: 6574 7269 6373 3d73 656c 662e 7365 6c65  etrics=self.sele
-0000f5e0: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
-0000f5f0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
-0000f600: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
-0000f610: 2020 2020 2020 2020 7461 7267 6574 3d54          target=T
-0000f620: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000f630: 2061 6c70 6861 3d30 2c0a 2020 2020 2020   alpha=0,.      
-0000f640: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-0000f650: 7365 6c66 2e74 6173 6b5f 6d61 6e61 6765  self.task_manage
-0000f660: 722e 7361 7665 5f6f 7574 7075 7473 3a0a  r.save_outputs:.
-0000f670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f680: 2e5f 636f 6d70 7574 655f 6f75 7470 7574  ._compute_output
-0000f690: 5f74 656e 736f 7273 280a 2020 2020 2020  _tensors(.      
-0000f6a0: 2020 2020 2020 2020 2020 7472 6169 6e5f            train_
-0000f6b0: 7461 7267 6574 5f6c 6f61 6465 722e 6461  target_loader.da
-0000f6c0: 7461 7365 742c 0a20 2020 2020 2020 2020  taset,.         
-0000f6d0: 2020 2020 2020 2022 7472 6169 6e22 2c0a         "train",.
-0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6f0: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
-0000f700: 2020 2020 2020 2073 656c 662e 7365 6c65         self.sele
-0000f710: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
-0000f720: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000f730: 625f 696d 6167 6573 3d31 2c0a 2020 2020  b_images=1,.    
-0000f740: 2020 2020 2020 2020 2020 2020 6e65 7477              netw
-0000f750: 6f72 6b3d 6e65 7477 6f72 6b2c 0a20 2020  ork=network,.   
-0000f760: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000f770: 2020 2020 2020 2073 656c 662e 5f63 6f6d         self._com
-0000f780: 7075 7465 5f6f 7574 7075 745f 7465 6e73  pute_output_tens
-0000f790: 6f72 7328 0a20 2020 2020 2020 2020 2020  ors(.           
-0000f7a0: 2020 2020 2074 7261 696e 5f74 6172 6765       train_targe
-0000f7b0: 745f 6c6f 6164 6572 2e64 6174 6173 6574  t_loader.dataset
-0000f7c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f7d0: 2020 2276 616c 6964 6174 696f 6e22 2c0a    "validation",.
-0000f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7f0: 7370 6c69 742c 0a20 2020 2020 2020 2020  split,.         
-0000f800: 2020 2020 2020 2073 656c 662e 7365 6c65         self.sele
-0000f810: 6374 696f 6e5f 6d65 7472 6963 732c 0a20  ction_metrics,. 
-0000f820: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000f830: 625f 696d 6167 6573 3d31 2c0a 2020 2020  b_images=1,.    
-0000f840: 2020 2020 2020 2020 2020 2020 6e65 7477              netw
-0000f850: 6f72 6b3d 6e65 7477 6f72 6b2c 0a20 2020  ork=network,.   
-0000f860: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000f870: 6465 6620 5f74 6573 745f 6c6f 6164 6572  def _test_loader
-0000f880: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0000f890: 2020 2020 2020 2020 6461 7461 6c6f 6164          dataload
-0000f8a0: 6572 2c0a 2020 2020 2020 2020 6372 6974  er,.        crit
-0000f8b0: 6572 696f 6e2c 0a20 2020 2020 2020 2064  erion,.        d
-0000f8c0: 6174 615f 6772 6f75 702c 0a20 2020 2020  ata_group,.     
-0000f8d0: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
-0000f8e0: 2020 7365 6c65 6374 696f 6e5f 6d65 7472    selection_metr
-0000f8f0: 6963 732c 0a20 2020 2020 2020 2075 7365  ics,.        use
-0000f900: 5f6c 6162 656c 733d 5472 7565 2c0a 2020  _labels=True,.  
-0000f910: 2020 2020 2020 6770 753d 4e6f 6e65 2c0a        gpu=None,.
-0000f920: 2020 2020 2020 2020 616d 703d 4661 6c73          amp=Fals
-0000f930: 652c 0a20 2020 2020 2020 206e 6574 776f  e,.        netwo
-0000f940: 726b 3d4e 6f6e 652c 0a20 2020 2020 2020  rk=None,.       
-0000f950: 2072 6570 6f72 745f 6369 3d54 7275 652c   report_ci=True,
-0000f960: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0000f970: 2222 220a 2020 2020 2020 2020 4c61 756e  """.        Laun
-0000f980: 6368 6573 2074 6865 2074 6573 7469 6e67  ches the testing
-0000f990: 2074 6173 6b20 6f6e 2061 2064 6174 6173   task on a datas
-0000f9a0: 6574 2077 7261 7070 6564 2062 7920 6120  et wrapped by a 
-0000f9b0: 4461 7461 4c6f 6164 6572 2061 6e64 2077  DataLoader and w
-0000f9c0: 7269 7465 7320 7072 6564 6963 7469 6f6e  rites prediction
-0000f9d0: 2054 5356 2066 696c 6573 2e0a 0a20 2020   TSV files...   
-0000f9e0: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0000f9f0: 2020 2020 2020 2064 6174 616c 6f61 6465         dataloade
-0000fa00: 7220 2874 6f72 6368 2e75 7469 6c73 2e64  r (torch.utils.d
-0000fa10: 6174 612e 4461 7461 4c6f 6164 6572 293a  ata.DataLoader):
-0000fa20: 2044 6174 614c 6f61 6465 7220 7772 6170   DataLoader wrap
-0000fa30: 7069 6e67 2074 6865 2074 6573 7420 4361  ping the test Ca
-0000fa40: 7073 4461 7461 7365 742e 0a20 2020 2020  psDataset..     
-0000fa50: 2020 2020 2020 2063 7269 7465 7269 6f6e         criterion
-0000fa60: 2028 746f 7263 682e 6e6e 2e6d 6f64 756c   (torch.nn.modul
-0000fa70: 6573 2e6c 6f73 732e 5f4c 6f73 7329 3a20  es.loss._Loss): 
-0000fa80: 6f70 7469 6d69 7a61 7469 6f6e 2063 7269  optimization cri
-0000fa90: 7465 7269 6f6e 2075 7365 6420 6475 7269  terion used duri
-0000faa0: 6e67 2074 7261 696e 696e 672e 0a20 2020  ng training..   
-0000fab0: 2020 2020 2020 2020 2064 6174 615f 6772           data_gr
-0000fac0: 6f75 7020 2873 7472 293a 206e 616d 6520  oup (str): name 
-0000fad0: 6f66 2074 6865 2064 6174 6120 6772 6f75  of the data grou
-0000fae0: 7020 7573 6564 2066 6f72 2074 6865 2074  p used for the t
-0000faf0: 6573 7469 6e67 2074 6173 6b2e 0a20 2020  esting task..   
-0000fb00: 2020 2020 2020 2020 2073 706c 6974 2028           split (
-0000fb10: 696e 7429 3a20 496e 6465 7820 6f66 2074  int): Index of t
-0000fb20: 6865 2073 706c 6974 2075 7365 6420 746f  he split used to
-0000fb30: 2074 7261 696e 2074 6865 206d 6f64 656c   train the model
-0000fb40: 2074 6573 7465 642e 0a20 2020 2020 2020   tested..       
-0000fb50: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
-0000fb60: 6574 7269 6373 2028 6c69 7374 5b73 7472  etrics (list[str
-0000fb70: 5d29 3a20 4c69 7374 206f 6620 6d65 7472  ]): List of metr
-0000fb80: 6963 7320 7573 6564 2074 6f20 7365 6c65  ics used to sele
-0000fb90: 6374 2074 6865 2062 6573 7420 6d6f 6465  ct the best mode
-0000fba0: 6c73 2077 6869 6368 2061 7265 2074 6573  ls which are tes
-0000fbb0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-0000fbc0: 2075 7365 5f6c 6162 656c 7320 2862 6f6f   use_labels (boo
-0000fbd0: 6c29 3a20 4966 2054 7275 652c 2074 6865  l): If True, the
-0000fbe0: 206c 6162 656c 7320 6d75 7374 2065 7869   labels must exi
-0000fbf0: 7374 2069 6e20 7465 7374 206d 6574 612d  st in test meta-
-0000fc00: 6461 7461 2061 6e64 206d 6574 7269 6373  data and metrics
-0000fc10: 2061 7265 2063 6f6d 7075 7465 642e 0a20   are computed.. 
-0000fc20: 2020 2020 2020 2020 2020 2067 7075 2028             gpu (
-0000fc30: 626f 6f6c 293a 2049 6620 6769 7665 6e2c  bool): If given,
-0000fc40: 2061 206e 6577 2076 616c 7565 2066 6f72   a new value for
-0000fc50: 2074 6865 2064 6576 6963 6520 6f66 2074   the device of t
-0000fc60: 6865 206d 6f64 656c 2077 696c 6c20 6265  he model will be
-0000fc70: 2063 6f6d 7075 7465 642e 0a20 2020 2020   computed..     
-0000fc80: 2020 2020 2020 2061 6d70 2028 626f 6f6c         amp (bool
-0000fc90: 293a 2049 6620 656e 6162 6c65 642c 2075  ): If enabled, u
-0000fca0: 7365 7320 4175 746f 6d61 7469 6320 4d69  ses Automatic Mi
-0000fcb0: 7865 6420 5072 6563 6973 696f 6e20 2872  xed Precision (r
-0000fcc0: 6571 7569 7265 7320 4750 5520 7573 6167  equires GPU usag
-0000fcd0: 6529 2e0a 2020 2020 2020 2020 2020 2020  e)..            
-0000fce0: 6e65 7477 6f72 6b20 2869 6e74 293a 2049  network (int): I
-0000fcf0: 6e64 6578 206f 6620 7468 6520 6e65 7477  ndex of the netw
-0000fd00: 6f72 6b20 7465 7374 6564 2028 6f6e 6c79  ork tested (only
-0000fd10: 2075 7365 6420 696e 206d 756c 7469 2d6e   used in multi-n
-0000fd20: 6574 776f 726b 2073 6574 7469 6e67 292e  etwork setting).
-0000fd30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000fd40: 2020 2020 2066 6f72 2073 656c 6563 7469       for selecti
-0000fd50: 6f6e 5f6d 6574 7269 6320 696e 2073 656c  on_metric in sel
-0000fd60: 6563 7469 6f6e 5f6d 6574 7269 6373 3a0a  ection_metrics:.
-0000fd70: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0000fd80: 6c75 7374 6572 2e6d 6173 7465 723a 0a20  luster.master:. 
-0000fd90: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000fda0: 6f67 5f64 6972 203d 2028 0a20 2020 2020  og_dir = (.     
-0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000fdc0: 656c 662e 6d61 7073 5f70 6174 680a 2020  elf.maps_path.  
-0000fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fde0: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
-0000fdf0: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
-0000fe00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fe10: 2020 2020 202f 2066 2262 6573 742d 7b73       / f"best-{s
-0000fe20: 656c 6563 7469 6f6e 5f6d 6574 7269 637d  election_metric}
-0000fe30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000fe40: 2020 2020 2020 2f20 6461 7461 5f67 726f        / data_gro
-0000fe50: 7570 0a20 2020 2020 2020 2020 2020 2020  up.             
-0000fe60: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000fe70: 2020 2020 2073 656c 662e 7772 6974 655f       self.write_
-0000fe80: 6465 7363 7269 7074 696f 6e5f 6c6f 6728  description_log(
-0000fe90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fea0: 2020 2020 206c 6f67 5f64 6972 2c0a 2020       log_dir,.  
-0000feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fec0: 2020 6461 7461 5f67 726f 7570 2c0a 2020    data_group,.  
-0000fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fee0: 2020 6461 7461 6c6f 6164 6572 2e64 6174    dataloader.dat
-0000fef0: 6173 6574 2e63 6170 735f 6469 6374 2c0a  aset.caps_dict,.
-0000ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff10: 2020 2020 6461 7461 6c6f 6164 6572 2e64      dataloader.d
-0000ff20: 6174 6173 6574 2e64 662c 0a20 2020 2020  ataset.df,.     
-0000ff30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000ff40: 2020 2020 2020 2020 2020 2320 6c6f 6164            # load
-0000ff50: 2074 6865 2062 6573 7420 7472 6169 6e65   the best traine
-0000ff60: 6420 6d6f 6465 6c20 6475 7269 6e67 2074  d model during t
-0000ff70: 6865 2074 7261 696e 696e 670a 2020 2020  he training.    
-0000ff80: 2020 2020 2020 2020 6d6f 6465 6c2c 205f          model, _
-0000ff90: 203d 2073 656c 662e 5f69 6e69 745f 6d6f   = self._init_mo
-0000ffa0: 6465 6c28 0a20 2020 2020 2020 2020 2020  del(.           
-0000ffb0: 2020 2020 2074 7261 6e73 6665 725f 7061       transfer_pa
-0000ffc0: 7468 3d73 656c 662e 6d61 7073 5f70 6174  th=self.maps_pat
-0000ffd0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0000ffe0: 2020 2073 706c 6974 3d73 706c 6974 2c0a     split=split,.
-0000fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010000: 7472 616e 7366 6572 5f73 656c 6563 7469  transfer_selecti
-00010010: 6f6e 3d73 656c 6563 7469 6f6e 5f6d 6574  on=selection_met
-00010020: 7269 632c 0a20 2020 2020 2020 2020 2020  ric,.           
-00010030: 2020 2020 2067 7075 3d67 7075 2c0a 2020       gpu=gpu,.  
-00010040: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00010050: 7477 6f72 6b3d 6e65 7477 6f72 6b2c 0a20  twork=network,. 
-00010060: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00010070: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
-00010080: 2044 4450 286d 6f64 656c 290a 0a20 2020   DDP(model)..   
-00010090: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-000100a0: 696f 6e5f 6466 2c20 6d65 7472 6963 7320  ion_df, metrics 
-000100b0: 3d20 7365 6c66 2e74 6173 6b5f 6d61 6e61  = self.task_mana
-000100c0: 6765 722e 7465 7374 280a 2020 2020 2020  ger.test(.      
-000100d0: 2020 2020 2020 2020 2020 6d6f 6465 6c2c            model,
-000100e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000100f0: 2064 6174 616c 6f61 6465 722c 0a20 2020   dataloader,.   
-00010100: 2020 2020 2020 2020 2020 2020 2063 7269               cri
-00010110: 7465 7269 6f6e 2c0a 2020 2020 2020 2020  terion,.        
-00010120: 2020 2020 2020 2020 7573 655f 6c61 6265          use_labe
-00010130: 6c73 3d75 7365 5f6c 6162 656c 732c 0a20  ls=use_labels,. 
-00010140: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010150: 6d70 3d61 6d70 2c0a 2020 2020 2020 2020  mp=amp,.        
-00010160: 2020 2020 2020 2020 7265 706f 7274 5f63          report_c
-00010170: 693d 7265 706f 7274 5f63 692c 0a20 2020  i=report_ci,.   
-00010180: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00010190: 2020 2020 2020 2069 6620 7573 655f 6c61         if use_la
-000101a0: 6265 6c73 3a0a 2020 2020 2020 2020 2020  bels:.          
-000101b0: 2020 2020 2020 6966 206e 6574 776f 726b        if network
-000101c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000101d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101e0: 2020 6d65 7472 6963 735b 6622 7b73 656c    metrics[f"{sel
-000101f0: 662e 6d6f 6465 7d5f 6964 225d 203d 206e  f.mode}_id"] = n
-00010200: 6574 776f 726b 0a0a 2020 2020 2020 2020  etwork..        
-00010210: 2020 2020 2020 2020 6c6f 7373 5f74 6f5f          loss_to_
-00010220: 6c6f 6720 3d20 280a 2020 2020 2020 2020  log = (.        
-00010230: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
-00010240: 6963 735b 224d 6574 7269 635f 7661 6c75  ics["Metric_valu
-00010250: 6573 225d 5b2d 315d 2069 6620 7265 706f  es"][-1] if repo
-00010260: 7274 5f63 6920 656c 7365 206d 6574 7269  rt_ci else metri
-00010270: 6373 5b22 6c6f 7373 225d 0a20 2020 2020  cs["loss"].     
-00010280: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00010290: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000102a0: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
-000102b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000102c0: 227b 7365 6c66 2e6d 6f64 657d 206c 6576  "{self.mode} lev
-000102d0: 656c 207b 6461 7461 5f67 726f 7570 7d20  el {data_group} 
-000102e0: 6c6f 7373 2069 7320 7b6c 6f73 735f 746f  loss is {loss_to
-000102f0: 5f6c 6f67 7d20 666f 7220 6d6f 6465 6c20  _log} for model 
-00010300: 7365 6c65 6374 6564 206f 6e20 7b73 656c  selected on {sel
-00010310: 6563 7469 6f6e 5f6d 6574 7269 637d 220a  ection_metric}".
-00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010330: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00010340: 6620 636c 7573 7465 722e 6d61 7374 6572  f cluster.master
-00010350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010360: 2020 2320 5265 706c 6163 6520 6865 7265    # Replace here
-00010370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010380: 2073 656c 662e 5f6d 6f64 655f 6c65 7665   self._mode_leve
-00010390: 6c5f 746f 5f74 7376 280a 2020 2020 2020  l_to_tsv(.      
-000103a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000103b0: 6564 6963 7469 6f6e 5f64 662c 0a20 2020  ediction_df,.   
-000103c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103d0: 206d 6574 7269 6373 2c0a 2020 2020 2020   metrics,.      
-000103e0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-000103f0: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
-00010400: 2020 2020 2020 2020 2073 656c 6563 7469           selecti
-00010410: 6f6e 5f6d 6574 7269 632c 0a20 2020 2020  on_metric,.     
-00010420: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010430: 6174 615f 6772 6f75 703d 6461 7461 5f67  ata_group=data_g
-00010440: 726f 7570 2c0a 2020 2020 2020 2020 2020  roup,.          
-00010450: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00010460: 205f 7465 7374 5f6c 6f61 6465 725f 7373   _test_loader_ss
-00010470: 6461 280a 2020 2020 2020 2020 7365 6c66  da(.        self
-00010480: 2c0a 2020 2020 2020 2020 6461 7461 6c6f  ,.        datalo
-00010490: 6164 6572 2c0a 2020 2020 2020 2020 6372  ader,.        cr
-000104a0: 6974 6572 696f 6e2c 0a20 2020 2020 2020  iterion,.       
-000104b0: 2061 6c70 6861 2c0a 2020 2020 2020 2020   alpha,.        
-000104c0: 6461 7461 5f67 726f 7570 2c0a 2020 2020  data_group,.    
-000104d0: 2020 2020 7370 6c69 742c 0a20 2020 2020      split,.     
-000104e0: 2020 2073 656c 6563 7469 6f6e 5f6d 6574     selection_met
-000104f0: 7269 6373 2c0a 2020 2020 2020 2020 7573  rics,.        us
-00010500: 655f 6c61 6265 6c73 3d54 7275 652c 0a20  e_labels=True,. 
-00010510: 2020 2020 2020 2067 7075 3d4e 6f6e 652c         gpu=None,
-00010520: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-00010530: 3d4e 6f6e 652c 0a20 2020 2020 2020 2074  =None,.        t
-00010540: 6172 6765 743d 4661 6c73 652c 0a20 2020  arget=False,.   
-00010550: 2020 2020 2072 6570 6f72 745f 6369 3d54       report_ci=T
-00010560: 7275 652c 0a20 2020 2029 3a0a 2020 2020  rue,.    ):.    
-00010570: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00010580: 4c61 756e 6368 6573 2074 6865 2074 6573  Launches the tes
-00010590: 7469 6e67 2074 6173 6b20 6f6e 2061 2064  ting task on a d
-000105a0: 6174 6173 6574 2077 7261 7070 6564 2062  ataset wrapped b
-000105b0: 7920 6120 4461 7461 4c6f 6164 6572 2061  y a DataLoader a
-000105c0: 6e64 2077 7269 7465 7320 7072 6564 6963  nd writes predic
-000105d0: 7469 6f6e 2054 5356 2066 696c 6573 2e0a  tion TSV files..
-000105e0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-000105f0: 2020 2020 2020 2020 2020 2064 6174 616c             datal
-00010600: 6f61 6465 7220 2874 6f72 6368 2e75 7469  oader (torch.uti
-00010610: 6c73 2e64 6174 612e 4461 7461 4c6f 6164  ls.data.DataLoad
-00010620: 6572 293a 2044 6174 614c 6f61 6465 7220  er): DataLoader 
-00010630: 7772 6170 7069 6e67 2074 6865 2074 6573  wrapping the tes
-00010640: 7420 4361 7073 4461 7461 7365 742e 0a20  t CapsDataset.. 
-00010650: 2020 2020 2020 2020 2020 2063 7269 7465             crite
-00010660: 7269 6f6e 2028 746f 7263 682e 6e6e 2e6d  rion (torch.nn.m
-00010670: 6f64 756c 6573 2e6c 6f73 732e 5f4c 6f73  odules.loss._Los
-00010680: 7329 3a20 6f70 7469 6d69 7a61 7469 6f6e  s): optimization
-00010690: 2063 7269 7465 7269 6f6e 2075 7365 6420   criterion used 
-000106a0: 6475 7269 6e67 2074 7261 696e 696e 672e  during training.
-000106b0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000106c0: 615f 6772 6f75 7020 2873 7472 293a 206e  a_group (str): n
-000106d0: 616d 6520 6f66 2074 6865 2064 6174 6120  ame of the data 
-000106e0: 6772 6f75 7020 7573 6564 2066 6f72 2074  group used for t
-000106f0: 6865 2074 6573 7469 6e67 2074 6173 6b2e  he testing task.
-00010700: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
-00010710: 6974 2028 696e 7429 3a20 496e 6465 7820  it (int): Index 
-00010720: 6f66 2074 6865 2073 706c 6974 2075 7365  of the split use
-00010730: 6420 746f 2074 7261 696e 2074 6865 206d  d to train the m
-00010740: 6f64 656c 2074 6573 7465 642e 0a20 2020  odel tested..   
-00010750: 2020 2020 2020 2020 2073 656c 6563 7469           selecti
-00010760: 6f6e 5f6d 6574 7269 6373 2028 6c69 7374  on_metrics (list
-00010770: 5b73 7472 5d29 3a20 4c69 7374 206f 6620  [str]): List of 
-00010780: 6d65 7472 6963 7320 7573 6564 2074 6f20  metrics used to 
-00010790: 7365 6c65 6374 2074 6865 2062 6573 7420  select the best 
-000107a0: 6d6f 6465 6c73 2077 6869 6368 2061 7265  models which are
-000107b0: 2074 6573 7465 642e 0a20 2020 2020 2020   tested..       
-000107c0: 2020 2020 2075 7365 5f6c 6162 656c 7320       use_labels 
-000107d0: 2862 6f6f 6c29 3a20 4966 2054 7275 652c  (bool): If True,
-000107e0: 2074 6865 206c 6162 656c 7320 6d75 7374   the labels must
-000107f0: 2065 7869 7374 2069 6e20 7465 7374 206d   exist in test m
-00010800: 6574 612d 6461 7461 2061 6e64 206d 6574  eta-data and met
-00010810: 7269 6373 2061 7265 2063 6f6d 7075 7465  rics are compute
-00010820: 642e 0a20 2020 2020 2020 2020 2020 2067  d..            g
-00010830: 7075 2028 626f 6f6c 293a 2049 6620 6769  pu (bool): If gi
-00010840: 7665 6e2c 2061 206e 6577 2076 616c 7565  ven, a new value
-00010850: 2066 6f72 2074 6865 2064 6576 6963 6520   for the device 
-00010860: 6f66 2074 6865 206d 6f64 656c 2077 696c  of the model wil
-00010870: 6c20 6265 2063 6f6d 7075 7465 642e 0a20  l be computed.. 
-00010880: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
-00010890: 726b 2028 696e 7429 3a20 496e 6465 7820  rk (int): Index 
-000108a0: 6f66 2074 6865 206e 6574 776f 726b 2074  of the network t
-000108b0: 6573 7465 6420 286f 6e6c 7920 7573 6564  ested (only used
-000108c0: 2069 6e20 6d75 6c74 692d 6e65 7477 6f72   in multi-networ
-000108d0: 6b20 7365 7474 696e 6729 2e0a 2020 2020  k setting)..    
-000108e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000108f0: 666f 7220 7365 6c65 6374 696f 6e5f 6d65  for selection_me
-00010900: 7472 6963 2069 6e20 7365 6c65 6374 696f  tric in selectio
-00010910: 6e5f 6d65 7472 6963 733a 0a20 2020 2020  n_metrics:.     
-00010920: 2020 2020 2020 206c 6f67 5f64 6972 203d         log_dir =
-00010930: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00010940: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
-00010950: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-00010960: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
-00010970: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
-00010980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010990: 202f 2066 2262 6573 742d 7b73 656c 6563   / f"best-{selec
-000109a0: 7469 6f6e 5f6d 6574 7269 637d 220a 2020  tion_metric}".  
-000109b0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-000109c0: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
-000109d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000109e0: 2020 2020 2073 656c 662e 7772 6974 655f       self.write_
-000109f0: 6465 7363 7269 7074 696f 6e5f 6c6f 6728  description_log(
-00010a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010a10: 206c 6f67 5f64 6972 2c0a 2020 2020 2020   log_dir,.      
-00010a20: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00010a30: 726f 7570 2c0a 2020 2020 2020 2020 2020  roup,.          
-00010a40: 2020 2020 2020 6461 7461 6c6f 6164 6572        dataloader
-00010a50: 2e64 6174 6173 6574 2e63 6170 735f 6469  .dataset.caps_di
-00010a60: 6374 2c0a 2020 2020 2020 2020 2020 2020  ct,.            
-00010a70: 2020 2020 6461 7461 6c6f 6164 6572 2e64      dataloader.d
-00010a80: 6174 6173 6574 2e64 662c 0a20 2020 2020  ataset.df,.     
-00010a90: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00010aa0: 2020 2020 2020 2320 6c6f 6164 2074 6865        # load the
-00010ab0: 2062 6573 7420 7472 6169 6e65 6420 6d6f   best trained mo
-00010ac0: 6465 6c20 6475 7269 6e67 2074 6865 2074  del during the t
-00010ad0: 7261 696e 696e 670a 2020 2020 2020 2020  raining.        
-00010ae0: 2020 2020 6d6f 6465 6c2c 205f 203d 2073      model, _ = s
-00010af0: 656c 662e 5f69 6e69 745f 6d6f 6465 6c28  elf._init_model(
-00010b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010b10: 2074 7261 6e73 6665 725f 7061 7468 3d73   transfer_path=s
-00010b20: 656c 662e 6d61 7073 5f70 6174 682c 0a20  elf.maps_path,. 
-00010b30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010b40: 706c 6974 3d73 706c 6974 2c0a 2020 2020  plit=split,.    
-00010b50: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-00010b60: 7366 6572 5f73 656c 6563 7469 6f6e 3d73  sfer_selection=s
-00010b70: 656c 6563 7469 6f6e 5f6d 6574 7269 632c  election_metric,
-00010b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010b90: 2067 7075 3d67 7075 2c0a 2020 2020 2020   gpu=gpu,.      
-00010ba0: 2020 2020 2020 2020 2020 6e65 7477 6f72            networ
-00010bb0: 6b3d 6e65 7477 6f72 6b2c 0a20 2020 2020  k=network,.     
-00010bc0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010bd0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-00010be0: 6466 2c20 6d65 7472 6963 7320 3d20 7365  df, metrics = se
-00010bf0: 6c66 2e74 6173 6b5f 6d61 6e61 6765 722e  lf.task_manager.
-00010c00: 7465 7374 5f64 6128 0a20 2020 2020 2020  test_da(.       
-00010c10: 2020 2020 2020 2020 206d 6f64 656c 2c20           model, 
-00010c20: 6461 7461 6c6f 6164 6572 2c20 6372 6974  dataloader, crit
-00010c30: 6572 696f 6e2c 2074 6172 6765 743d 7461  erion, target=ta
-00010c40: 7267 6574 2c20 7265 706f 7274 5f63 693d  rget, report_ci=
-00010c50: 7265 706f 7274 5f63 690a 2020 2020 2020  report_ci.      
-00010c60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010c70: 2020 2020 6966 2075 7365 5f6c 6162 656c      if use_label
-00010c80: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010c90: 2020 2069 6620 6e65 7477 6f72 6b20 6973     if network is
-00010ca0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00010cb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00010cc0: 6574 7269 6373 5b66 227b 7365 6c66 2e6d  etrics[f"{self.m
-00010cd0: 6f64 657d 5f69 6422 5d20 3d20 6e65 7477  ode}_id"] = netw
-00010ce0: 6f72 6b0a 0a20 2020 2020 2020 2020 2020  ork..           
-00010cf0: 2020 2020 2069 6620 7265 706f 7274 5f63       if report_c
-00010d00: 693a 0a20 2020 2020 2020 2020 2020 2020  i:.             
-00010d10: 2020 2020 2020 206c 6f73 735f 746f 5f6c         loss_to_l
-00010d20: 6f67 203d 206d 6574 7269 6373 5b22 4d65  og = metrics["Me
-00010d30: 7472 6963 5f76 616c 7565 7322 5d5b 2d31  tric_values"][-1
-00010d40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00010d50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010d60: 2020 2020 2020 2020 2020 2020 6c6f 7373              loss
-00010d70: 5f74 6f5f 6c6f 6720 3d20 6d65 7472 6963  _to_log = metric
-00010d80: 735b 226c 6f73 7322 5d0a 0a20 2020 2020  s["loss"]..     
-00010d90: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00010da0: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
-00010db0: 2020 2020 2020 2020 2020 2020 6622 7b73              f"{s
-00010dc0: 656c 662e 6d6f 6465 7d20 6c65 7665 6c20  elf.mode} level 
-00010dd0: 7b64 6174 615f 6772 6f75 707d 206c 6f73  {data_group} los
-00010de0: 7320 6973 207b 6c6f 7373 5f74 6f5f 6c6f  s is {loss_to_lo
-00010df0: 677d 2066 6f72 206d 6f64 656c 2073 656c  g} for model sel
-00010e00: 6563 7465 6420 6f6e 207b 7365 6c65 6374  ected on {select
-00010e10: 696f 6e5f 6d65 7472 6963 7d22 0a20 2020  ion_metric}".   
-00010e20: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00010e30: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-00010e40: 706c 6163 6520 6865 7265 0a20 2020 2020  place here.     
-00010e50: 2020 2020 2020 2073 656c 662e 5f6d 6f64         self._mod
-00010e60: 655f 6c65 7665 6c5f 746f 5f74 7376 280a  e_level_to_tsv(.
-00010e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e80: 7072 6564 6963 7469 6f6e 5f64 662c 206d  prediction_df, m
-00010e90: 6574 7269 6373 2c20 7370 6c69 742c 2073  etrics, split, s
-00010ea0: 656c 6563 7469 6f6e 5f6d 6574 7269 632c  election_metric,
-00010eb0: 2064 6174 615f 6772 6f75 703d 6461 7461   data_group=data
-00010ec0: 5f67 726f 7570 0a20 2020 2020 2020 2020  _group.         
-00010ed0: 2020 2029 0a0a 2020 2020 4074 6f72 6368     )..    @torch
-00010ee0: 2e6e 6f5f 6772 6164 2829 0a20 2020 2064  .no_grad().    d
-00010ef0: 6566 205f 636f 6d70 7574 655f 6f75 7470  ef _compute_outp
-00010f00: 7574 5f6e 6966 7469 280a 2020 2020 2020  ut_nifti(.      
-00010f10: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00010f20: 6461 7461 7365 742c 0a20 2020 2020 2020  dataset,.       
-00010f30: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
-00010f40: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-00010f50: 2020 2020 7365 6c65 6374 696f 6e5f 6d65      selection_me
-00010f60: 7472 6963 732c 0a20 2020 2020 2020 2067  trics,.        g
-00010f70: 7075 3d4e 6f6e 652c 0a20 2020 2020 2020  pu=None,.       
-00010f80: 206e 6574 776f 726b 3d4e 6f6e 652c 0a20   network=None,. 
-00010f90: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00010fa0: 220a 2020 2020 2020 2020 436f 6d70 7574  ".        Comput
-00010fb0: 6573 2074 6865 206f 7574 7075 7420 6e69  es the output ni
-00010fc0: 6674 6920 696d 6167 6573 2061 6e64 2073  fti images and s
-00010fd0: 6176 6573 2074 6865 6d20 696e 2074 6865  aves them in the
-00010fe0: 204d 4150 532e 0a0a 2020 2020 2020 2020   MAPS...        
-00010ff0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00011000: 2020 6461 7461 7365 7420 2863 6c69 6e69    dataset (clini
-00011010: 6361 646c 2e75 7469 6c73 2e63 6170 735f  cadl.utils.caps_
-00011020: 6461 7461 7365 742e 6461 7461 2e43 6170  dataset.data.Cap
-00011030: 7344 6174 6173 6574 293a 2077 7261 7070  sDataset): wrapp
-00011040: 6572 206f 6620 7468 6520 6461 7461 2073  er of the data s
-00011050: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
-00011060: 6461 7461 5f67 726f 7570 2028 7374 7229  data_group (str)
-00011070: 3a20 6e61 6d65 206f 6620 7468 6520 6461  : name of the da
-00011080: 7461 2067 726f 7570 2075 7365 6420 666f  ta group used fo
-00011090: 7220 7468 6520 7461 736b 2e0a 2020 2020  r the task..    
-000110a0: 2020 2020 2020 2020 7370 6c69 7420 2869          split (i
-000110b0: 6e74 293a 2073 706c 6974 206e 756d 6265  nt): split numbe
-000110c0: 722e 0a20 2020 2020 2020 2020 2020 2073  r..            s
-000110d0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
-000110e0: 2028 6c69 7374 5b73 7472 5d29 3a20 6d65   (list[str]): me
-000110f0: 7472 6963 7320 7573 6564 2066 6f72 206d  trics used for m
-00011100: 6f64 656c 2073 656c 6563 7469 6f6e 2e0a  odel selection..
-00011110: 2020 2020 2020 2020 2020 2020 6770 7520              gpu 
-00011120: 2862 6f6f 6c29 3a20 4966 2067 6976 656e  (bool): If given
-00011130: 2c20 6120 6e65 7720 7661 6c75 6520 666f  , a new value fo
-00011140: 7220 7468 6520 6465 7669 6365 206f 6620  r the device of 
-00011150: 7468 6520 6d6f 6465 6c20 7769 6c6c 2062  the model will b
-00011160: 6520 636f 6d70 7574 6564 2e0a 2020 2020  e computed..    
-00011170: 2020 2020 2020 2020 6e65 7477 6f72 6b20          network 
-00011180: 2869 6e74 293a 2049 6e64 6578 206f 6620  (int): Index of 
-00011190: 7468 6520 6e65 7477 6f72 6b20 7465 7374  the network test
-000111a0: 6564 2028 6f6e 6c79 2075 7365 6420 696e  ed (only used in
-000111b0: 206d 756c 7469 2d6e 6574 776f 726b 2073   multi-network s
-000111c0: 6574 7469 6e67 292e 0a20 2020 2020 2020  etting)..       
-000111d0: 2023 2052 6169 7365 2061 6e20 6572 726f   # Raise an erro
-000111e0: 7220 6966 206d 6f64 6520 6973 206e 6f74  r if mode is not
-000111f0: 2069 6d61 6765 0a20 2020 2020 2020 2022   image.        "
-00011200: 2222 0a20 2020 2020 2020 2069 6d70 6f72  "".        impor
-00011210: 7420 6e69 6261 6265 6c20 6173 206e 6962  t nibabel as nib
-00011220: 0a20 2020 2020 2020 2066 726f 6d20 6e75  .        from nu
-00011230: 6d70 7920 696d 706f 7274 2065 7965 0a0a  mpy import eye..
-00011240: 2020 2020 2020 2020 666f 7220 7365 6c65          for sele
-00011250: 6374 696f 6e5f 6d65 7472 6963 2069 6e20  ction_metric in 
-00011260: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-00011270: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-00011280: 206c 6f61 6420 7468 6520 6265 7374 2074   load the best t
-00011290: 7261 696e 6564 206d 6f64 656c 2064 7572  rained model dur
-000112a0: 696e 6720 7468 6520 7472 6169 6e69 6e67  ing the training
-000112b0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-000112c0: 656c 2c20 5f20 3d20 7365 6c66 2e5f 696e  el, _ = self._in
-000112d0: 6974 5f6d 6f64 656c 280a 2020 2020 2020  it_model(.      
-000112e0: 2020 2020 2020 2020 2020 7472 616e 7366            transf
-000112f0: 6572 5f70 6174 683d 7365 6c66 2e6d 6170  er_path=self.map
-00011300: 735f 7061 7468 2c0a 2020 2020 2020 2020  s_path,.        
-00011310: 2020 2020 2020 2020 7370 6c69 743d 7370          split=sp
-00011320: 6c69 742c 0a20 2020 2020 2020 2020 2020  lit,.           
-00011330: 2020 2020 2074 7261 6e73 6665 725f 7365       transfer_se
-00011340: 6c65 6374 696f 6e3d 7365 6c65 6374 696f  lection=selectio
-00011350: 6e5f 6d65 7472 6963 2c0a 2020 2020 2020  n_metric,.      
-00011360: 2020 2020 2020 2020 2020 6770 753d 6770            gpu=gp
-00011370: 752c 0a20 2020 2020 2020 2020 2020 2020  u,.             
-00011380: 2020 206e 6574 776f 726b 3d6e 6574 776f     network=netwo
-00011390: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
-000113a0: 2020 2020 6e62 5f75 6e66 726f 7a65 6e5f      nb_unfrozen_
-000113b0: 6c61 7965 723d 7365 6c66 2e6e 625f 756e  layer=self.nb_un
-000113c0: 6672 6f7a 656e 5f6c 6179 6572 2c0a 2020  frozen_layer,.  
-000113d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000113e0: 2020 2020 2020 2020 6d6f 6465 6c20 3d20          model = 
-000113f0: 4444 5028 6d6f 6465 6c29 0a0a 2020 2020  DDP(model)..    
-00011400: 2020 2020 2020 2020 6e69 6674 695f 7061          nifti_pa
-00011410: 7468 203d 2028 0a20 2020 2020 2020 2020  th = (.         
-00011420: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
-00011430: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
-00011440: 2020 2020 2020 2f20 6622 7b73 656c 662e        / f"{self.
-00011450: 7370 6c69 745f 6e61 6d65 7d2d 7b73 706c  split_name}-{spl
-00011460: 6974 7d22 0a20 2020 2020 2020 2020 2020  it}".           
-00011470: 2020 2020 202f 2066 2262 6573 742d 7b73       / f"best-{s
-00011480: 656c 6563 7469 6f6e 5f6d 6574 7269 637d  election_metric}
-00011490: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000114a0: 2020 2f20 6461 7461 5f67 726f 7570 0a20    / data_group. 
-000114b0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-000114c0: 2022 6e69 6674 695f 696d 6167 6573 220a   "nifti_images".
-000114d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000114e0: 2020 2020 2020 2020 2020 6966 2063 6c75            if clu
-000114f0: 7374 6572 2e6d 6173 7465 723a 0a20 2020  ster.master:.   
-00011500: 2020 2020 2020 2020 2020 2020 206e 6966               nif
-00011510: 7469 5f70 6174 682e 6d6b 6469 7228 7061  ti_path.mkdir(pa
-00011520: 7265 6e74 733d 5472 7565 2c20 6578 6973  rents=True, exis
-00011530: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00011540: 2020 2020 2020 2064 6973 742e 6261 7272         dist.barr
-00011550: 6965 7228 290a 0a20 2020 2020 2020 2020  ier()..         
-00011560: 2020 206e 625f 696d 6773 203d 206c 656e     nb_imgs = len
-00011570: 2864 6174 6173 6574 290a 2020 2020 2020  (dataset).      
-00011580: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-00011590: 616e 6765 2863 6c75 7374 6572 2e72 616e  ange(cluster.ran
-000115a0: 6b2c 206e 625f 696d 6773 2c20 636c 7573  k, nb_imgs, clus
-000115b0: 7465 722e 776f 726c 645f 7369 7a65 293a  ter.world_size):
-000115c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000115d0: 2064 6174 6120 3d20 6461 7461 7365 745b   data = dataset[
-000115e0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
-000115f0: 2020 2069 6d61 6765 203d 2064 6174 615b     image = data[
-00011600: 2269 6d61 6765 225d 0a20 2020 2020 2020  "image"].       
-00011610: 2020 2020 2020 2020 2078 203d 2069 6d61           x = ima
-00011620: 6765 2e75 6e73 7175 6565 7a65 2830 292e  ge.unsqueeze(0).
-00011630: 746f 286d 6f64 656c 2e64 6576 6963 6529  to(model.device)
-00011640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011650: 2077 6974 6820 6175 746f 6361 7374 2865   with autocast(e
-00011660: 6e61 626c 6564 3d73 656c 662e 616d 7029  nabled=self.amp)
-00011670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011680: 2020 2020 2020 6f75 7470 7574 203d 206d        output = m
-00011690: 6f64 656c 2e70 7265 6469 6374 2878 290a  odel.predict(x).
-000116a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116b0: 6f75 7470 7574 203d 206f 7574 7075 742e  output = output.
-000116c0: 7371 7565 657a 6528 3029 2e64 6574 6163  squeeze(0).detac
-000116d0: 6828 292e 6370 7528 292e 666c 6f61 7428  h().cpu().float(
-000116e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000116f0: 2020 2320 436f 6e76 6572 7420 7465 6e73    # Convert tens
-00011700: 6f72 2074 6f20 6e69 6674 6920 696d 6167  or to nifti imag
-00011710: 6520 7769 7468 2061 7070 726f 7072 6961  e with appropria
-00011720: 7465 2061 6666 696e 650a 2020 2020 2020  te affine.      
-00011730: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-00011740: 6e69 6920 3d20 6e69 622e 4e69 6674 6931  nii = nib.Nifti1
-00011750: 496d 6167 6528 696d 6167 655b 305d 2e64  Image(image[0].d
-00011760: 6574 6163 6828 292e 6370 7528 292e 6e75  etach().cpu().nu
-00011770: 6d70 7928 292c 2065 7965 2834 2929 0a20  mpy(), eye(4)). 
-00011780: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00011790: 7574 7075 745f 6e69 6920 3d20 6e69 622e  utput_nii = nib.
-000117a0: 4e69 6674 6931 496d 6167 6528 6f75 7470  Nifti1Image(outp
-000117b0: 7574 5b30 5d2e 6e75 6d70 7928 292c 2065  ut[0].numpy(), e
-000117c0: 7965 2834 2929 0a20 2020 2020 2020 2020  ye(4)).         
-000117d0: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-000117e0: 6669 6c65 206e 616d 6520 6163 636f 7264  file name accord
-000117f0: 696e 6720 746f 2070 6172 7469 6369 7061  ing to participa
-00011800: 6e74 2061 6e64 2073 6573 7369 6f6e 2069  nt and session i
-00011810: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00011820: 2020 7061 7274 6963 6970 616e 745f 6964    participant_id
-00011830: 203d 2064 6174 615b 2270 6172 7469 6369   = data["partici
-00011840: 7061 6e74 5f69 6422 5d0a 2020 2020 2020  pant_id"].      
-00011850: 2020 2020 2020 2020 2020 7365 7373 696f            sessio
-00011860: 6e5f 6964 203d 2064 6174 615b 2273 6573  n_id = data["ses
-00011870: 7369 6f6e 5f69 6422 5d0a 2020 2020 2020  sion_id"].      
-00011880: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-00011890: 6669 6c65 6e61 6d65 203d 2066 227b 7061  filename = f"{pa
-000118a0: 7274 6963 6970 616e 745f 6964 7d5f 7b73  rticipant_id}_{s
-000118b0: 6573 7369 6f6e 5f69 647d 5f69 6d61 6765  ession_id}_image
-000118c0: 5f69 6e70 7574 2e6e 6969 2e67 7a22 0a20  _input.nii.gz". 
-000118d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000118e0: 7574 7075 745f 6669 6c65 6e61 6d65 203d  utput_filename =
-000118f0: 2066 227b 7061 7274 6963 6970 616e 745f   f"{participant_
-00011900: 6964 7d5f 7b73 6573 7369 6f6e 5f69 647d  id}_{session_id}
-00011910: 5f69 6d61 6765 5f6f 7574 7075 742e 6e69  _image_output.ni
-00011920: 692e 677a 220a 2020 2020 2020 2020 2020  i.gz".          
-00011930: 2020 2020 2020 6e69 622e 7361 7665 2869        nib.save(i
-00011940: 6e70 7574 5f6e 6969 2c20 6e69 6674 695f  nput_nii, nifti_
-00011950: 7061 7468 202f 2069 6e70 7574 5f66 696c  path / input_fil
-00011960: 656e 616d 6529 0a20 2020 2020 2020 2020  ename).         
-00011970: 2020 2020 2020 206e 6962 2e73 6176 6528         nib.save(
-00011980: 6f75 7470 7574 5f6e 6969 2c20 6e69 6674  output_nii, nift
-00011990: 695f 7061 7468 202f 206f 7574 7075 745f  i_path / output_
-000119a0: 6669 6c65 6e61 6d65 290a 0a20 2020 2040  filename)..    @
-000119b0: 746f 7263 682e 6e6f 5f67 7261 6428 290a  torch.no_grad().
-000119c0: 2020 2020 6465 6620 5f63 6f6d 7075 7465      def _compute
-000119d0: 5f6f 7574 7075 745f 7465 6e73 6f72 7328  _output_tensors(
-000119e0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000119f0: 2020 2020 2020 2064 6174 6173 6574 2c0a         dataset,.
-00011a00: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
-00011a10: 7570 2c0a 2020 2020 2020 2020 7370 6c69  up,.        spli
-00011a20: 742c 0a20 2020 2020 2020 2073 656c 6563  t,.        selec
-00011a30: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
-00011a40: 2020 2020 2020 6e62 5f69 6d61 6765 733d        nb_images=
-00011a50: 4e6f 6e65 2c0a 2020 2020 2020 2020 6770  None,.        gp
-00011a60: 753d 4e6f 6e65 2c0a 2020 2020 2020 2020  u=None,.        
-00011a70: 6e65 7477 6f72 6b3d 4e6f 6e65 2c0a 2020  network=None,.  
-00011a80: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
-00011a90: 0a20 2020 2020 2020 2043 6f6d 7075 7465  .        Compute
-00011aa0: 2074 6865 206f 7574 7075 7420 7465 6e73   the output tens
-00011ab0: 6f72 7320 616e 6420 7361 7665 7320 7468  ors and saves th
-00011ac0: 656d 2069 6e20 7468 6520 4d41 5053 2e0a  em in the MAPS..
-00011ad0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00011ae0: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-00011af0: 6574 2028 636c 696e 6963 6164 6c2e 7574  et (clinicadl.ut
-00011b00: 696c 732e 6361 7073 5f64 6174 6173 6574  ils.caps_dataset
-00011b10: 2e64 6174 612e 4361 7073 4461 7461 7365  .data.CapsDatase
-00011b20: 7429 3a20 7772 6170 7065 7220 6f66 2074  t): wrapper of t
-00011b30: 6865 2064 6174 6120 7365 742e 0a20 2020  he data set..   
-00011b40: 2020 2020 2020 2020 2064 6174 615f 6772           data_gr
-00011b50: 6f75 7020 2873 7472 293a 206e 616d 6520  oup (str): name 
-00011b60: 6f66 2074 6865 2064 6174 6120 6772 6f75  of the data grou
-00011b70: 7020 7573 6564 2066 6f72 2074 6865 2074  p used for the t
-00011b80: 6173 6b2e 0a20 2020 2020 2020 2020 2020  ask..           
-00011b90: 2073 706c 6974 2028 696e 7429 3a20 7370   split (int): sp
-00011ba0: 6c69 7420 6e75 6d62 6572 2e0a 2020 2020  lit number..    
-00011bb0: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
-00011bc0: 6e5f 6d65 7472 6963 7320 286c 6973 745b  n_metrics (list[
-00011bd0: 7374 725d 293a 206d 6574 7269 6373 2075  str]): metrics u
-00011be0: 7365 6420 666f 7220 6d6f 6465 6c20 7365  sed for model se
-00011bf0: 6c65 6374 696f 6e2e 0a20 2020 2020 2020  lection..       
-00011c00: 2020 2020 206e 625f 696d 6167 6573 2028       nb_images (
-00011c10: 696e 7429 3a20 6e75 6d62 6572 206f 6620  int): number of 
-00011c20: 6675 6c6c 2069 6d61 6765 7320 746f 2077  full images to w
-00011c30: 7269 7465 2e20 4465 6661 756c 7420 636f  rite. Default co
-00011c40: 6d70 7574 6573 2074 6865 206f 7574 7075  mputes the outpu
-00011c50: 7473 206f 6620 7468 6520 7768 6f6c 6520  ts of the whole 
-00011c60: 6461 7461 2073 6574 2e0a 2020 2020 2020  data set..      
-00011c70: 2020 2020 2020 6770 7520 2862 6f6f 6c29        gpu (bool)
-00011c80: 3a20 4966 2067 6976 656e 2c20 6120 6e65  : If given, a ne
-00011c90: 7720 7661 6c75 6520 666f 7220 7468 6520  w value for the 
-00011ca0: 6465 7669 6365 206f 6620 7468 6520 6d6f  device of the mo
-00011cb0: 6465 6c20 7769 6c6c 2062 6520 636f 6d70  del will be comp
-00011cc0: 7574 6564 2e0a 2020 2020 2020 2020 2020  uted..          
-00011cd0: 2020 6e65 7477 6f72 6b20 2869 6e74 293a    network (int):
-00011ce0: 2049 6e64 6578 206f 6620 7468 6520 6e65   Index of the ne
-00011cf0: 7477 6f72 6b20 7465 7374 6564 2028 6f6e  twork tested (on
-00011d00: 6c79 2075 7365 6420 696e 206d 756c 7469  ly used in multi
-00011d10: 2d6e 6574 776f 726b 2073 6574 7469 6e67  -network setting
-00011d20: 292e 0a20 2020 2020 2020 2022 2222 0a20  )..        """. 
-00011d30: 2020 2020 2020 2066 6f72 2073 656c 6563         for selec
-00011d40: 7469 6f6e 5f6d 6574 7269 6320 696e 2073  tion_metric in s
-00011d50: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
-00011d60: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00011d70: 6c6f 6164 2074 6865 2062 6573 7420 7472  load the best tr
-00011d80: 6169 6e65 6420 6d6f 6465 6c20 6475 7269  ained model duri
-00011d90: 6e67 2074 6865 2074 7261 696e 696e 670a  ng the training.
-00011da0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00011db0: 6c2c 205f 203d 2073 656c 662e 5f69 6e69  l, _ = self._ini
-00011dc0: 745f 6d6f 6465 6c28 0a20 2020 2020 2020  t_model(.       
-00011dd0: 2020 2020 2020 2020 2074 7261 6e73 6665           transfe
-00011de0: 725f 7061 7468 3d73 656c 662e 6d61 7073  r_path=self.maps
-00011df0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00011e00: 2020 2020 2020 2073 706c 6974 3d73 706c         split=spl
-00011e10: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-00011e20: 2020 2020 7472 616e 7366 6572 5f73 656c      transfer_sel
-00011e30: 6563 7469 6f6e 3d73 656c 6563 7469 6f6e  ection=selection
-00011e40: 5f6d 6574 7269 632c 0a20 2020 2020 2020  _metric,.       
-00011e50: 2020 2020 2020 2020 2067 7075 3d67 7075           gpu=gpu
-00011e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011e70: 2020 6e65 7477 6f72 6b3d 6e65 7477 6f72    network=networ
-00011e80: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-00011e90: 2020 206e 625f 756e 6672 6f7a 656e 5f6c     nb_unfrozen_l
-00011ea0: 6179 6572 3d73 656c 662e 6e62 5f75 6e66  ayer=self.nb_unf
-00011eb0: 726f 7a65 6e5f 6c61 7965 722c 0a20 2020  rozen_layer,.   
-00011ec0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00011ed0: 2020 2020 2020 206d 6f64 656c 203d 2044         model = D
-00011ee0: 4450 286d 6f64 656c 290a 0a20 2020 2020  DP(model)..     
-00011ef0: 2020 2020 2020 2074 656e 736f 725f 7061         tensor_pa
-00011f00: 7468 203d 2028 0a20 2020 2020 2020 2020  th = (.         
-00011f10: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
-00011f20: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
-00011f30: 2020 2020 2020 2f20 6622 7b73 656c 662e        / f"{self.
-00011f40: 7370 6c69 745f 6e61 6d65 7d2d 7b73 706c  split_name}-{spl
-00011f50: 6974 7d22 0a20 2020 2020 2020 2020 2020  it}".           
-00011f60: 2020 2020 202f 2066 2262 6573 742d 7b73       / f"best-{s
-00011f70: 656c 6563 7469 6f6e 5f6d 6574 7269 637d  election_metric}
-00011f80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00011f90: 2020 2f20 6461 7461 5f67 726f 7570 0a20    / data_group. 
-00011fa0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00011fb0: 2022 7465 6e73 6f72 7322 0a20 2020 2020   "tensors".     
-00011fc0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00011fd0: 2020 2020 2069 6620 636c 7573 7465 722e       if cluster.
-00011fe0: 6d61 7374 6572 3a0a 2020 2020 2020 2020  master:.        
-00011ff0: 2020 2020 2020 2020 7465 6e73 6f72 5f70          tensor_p
-00012000: 6174 682e 6d6b 6469 7228 7061 7265 6e74  ath.mkdir(parent
-00012010: 733d 5472 7565 2c20 6578 6973 745f 6f6b  s=True, exist_ok
-00012020: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00012030: 2020 2064 6973 742e 6261 7272 6965 7228     dist.barrier(
-00012040: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00012050: 6620 6e62 5f69 6d61 6765 7320 6973 204e  f nb_images is N
-00012060: 6f6e 653a 2020 2320 436f 6d70 7574 6520  one:  # Compute 
-00012070: 6f75 7470 7574 7320 666f 7220 7468 6520  outputs for the 
-00012080: 7768 6f6c 6520 6461 7461 2073 6574 0a20  whole data set. 
-00012090: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000120a0: 625f 6d6f 6465 7320 3d20 6c65 6e28 6461  b_modes = len(da
-000120b0: 7461 7365 7429 0a20 2020 2020 2020 2020  taset).         
-000120c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000120d0: 2020 2020 2020 2020 206e 625f 6d6f 6465           nb_mode
-000120e0: 7320 3d20 6e62 5f69 6d61 6765 7320 2a20  s = nb_images * 
-000120f0: 6461 7461 7365 742e 656c 656d 5f70 6572  dataset.elem_per
-00012100: 5f69 6d61 6765 0a0a 2020 2020 2020 2020  _image..        
-00012110: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00012120: 6765 2863 6c75 7374 6572 2e72 616e 6b2c  ge(cluster.rank,
-00012130: 206e 625f 6d6f 6465 732c 2063 6c75 7374   nb_modes, clust
-00012140: 6572 2e77 6f72 6c64 5f73 697a 6529 3a0a  er.world_size):.
-00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012160: 6461 7461 203d 2064 6174 6173 6574 5b69  data = dataset[i
-00012170: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00012180: 2020 696d 6167 6520 3d20 6461 7461 5b22    image = data["
-00012190: 696d 6167 6522 5d0a 2020 2020 2020 2020  image"].        
-000121a0: 2020 2020 2020 2020 7820 3d20 696d 6167          x = imag
-000121b0: 652e 756e 7371 7565 657a 6528 3029 2e74  e.unsqueeze(0).t
-000121c0: 6f28 6d6f 6465 6c2e 6465 7669 6365 290a  o(model.device).
-000121d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121e0: 7769 7468 2061 7574 6f63 6173 7428 656e  with autocast(en
-000121f0: 6162 6c65 643d 7365 6c66 2e61 6d70 293a  abled=self.amp):
-00012200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012210: 2020 2020 206f 7574 7075 7420 3d20 6d6f       output = mo
-00012220: 6465 6c2e 7072 6564 6963 7428 7829 0a20  del.predict(x). 
-00012230: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00012240: 7574 7075 7420 3d20 6f75 7470 7574 2e73  utput = output.s
-00012250: 7175 6565 7a65 2830 292e 6370 7528 292e  queeze(0).cpu().
-00012260: 666c 6f61 7428 290a 2020 2020 2020 2020  float().        
-00012270: 2020 2020 2020 2020 7061 7274 6963 6970          particip
-00012280: 616e 745f 6964 203d 2064 6174 615b 2270  ant_id = data["p
-00012290: 6172 7469 6369 7061 6e74 5f69 6422 5d0a  articipant_id"].
-000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122b0: 7365 7373 696f 6e5f 6964 203d 2064 6174  session_id = dat
-000122c0: 615b 2273 6573 7369 6f6e 5f69 6422 5d0a  a["session_id"].
-000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122e0: 6d6f 6465 5f69 6420 3d20 6461 7461 5b66  mode_id = data[f
-000122f0: 227b 7365 6c66 2e6d 6f64 657d 5f69 6422  "{self.mode}_id"
-00012300: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00012310: 2020 696e 7075 745f 6669 6c65 6e61 6d65    input_filename
-00012320: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00012330: 2020 2020 2020 2020 2066 227b 7061 7274           f"{part
-00012340: 6963 6970 616e 745f 6964 7d5f 7b73 6573  icipant_id}_{ses
-00012350: 7369 6f6e 5f69 647d 5f7b 7365 6c66 2e6d  sion_id}_{self.m
-00012360: 6f64 657d 2d7b 6d6f 6465 5f69 647d 5f69  ode}-{mode_id}_i
-00012370: 6e70 7574 2e70 7422 0a20 2020 2020 2020  nput.pt".       
-00012380: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012390: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-000123a0: 745f 6669 6c65 6e61 6d65 203d 2028 0a20  t_filename = (. 
-000123b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123c0: 2020 2066 227b 7061 7274 6963 6970 616e     f"{participan
-000123d0: 745f 6964 7d5f 7b73 6573 7369 6f6e 5f69  t_id}_{session_i
-000123e0: 647d 5f7b 7365 6c66 2e6d 6f64 657d 2d7b  d}_{self.mode}-{
-000123f0: 6d6f 6465 5f69 647d 5f6f 7574 7075 742e  mode_id}_output.
-00012400: 7074 220a 2020 2020 2020 2020 2020 2020  pt".            
-00012410: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00012420: 2020 2020 2020 746f 7263 682e 7361 7665        torch.save
-00012430: 2869 6d61 6765 2c20 7465 6e73 6f72 5f70  (image, tensor_p
-00012440: 6174 6820 2f20 696e 7075 745f 6669 6c65  ath / input_file
-00012450: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00012460: 2020 2020 2020 746f 7263 682e 7361 7665        torch.save
-00012470: 286f 7574 7075 742c 2074 656e 736f 725f  (output, tensor_
-00012480: 7061 7468 202f 206f 7574 7075 745f 6669  path / output_fi
-00012490: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
-000124a0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-000124b0: 6562 7567 2866 2246 696c 6520 7361 7665  ebug(f"File save
-000124c0: 6420 6174 207b 5b69 6e70 7574 5f66 696c  d at {[input_fil
-000124d0: 656e 616d 652c 206f 7574 7075 745f 6669  ename, output_fi
-000124e0: 6c65 6e61 6d65 5d7d 2229 0a0a 2020 2020  lename]}")..    
-000124f0: 6465 6620 5f63 6f6d 7075 7465 5f6c 6174  def _compute_lat
-00012500: 656e 745f 7465 6e73 6f72 7328 0a20 2020  ent_tensors(.   
-00012510: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00012520: 2020 2064 6174 6173 6574 2c0a 2020 2020     dataset,.    
-00012530: 2020 2020 6461 7461 5f67 726f 7570 2c0a      data_group,.
-00012540: 2020 2020 2020 2020 7370 6c69 742c 0a20          split,. 
-00012550: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
-00012560: 5f6d 6574 7269 6373 2c0a 2020 2020 2020  _metrics,.      
-00012570: 2020 6e62 5f69 6d61 6765 733d 4e6f 6e65    nb_images=None
-00012580: 2c0a 2020 2020 2020 2020 6770 753d 4e6f  ,.        gpu=No
-00012590: 6e65 2c0a 2020 2020 2020 2020 6e65 7477  ne,.        netw
-000125a0: 6f72 6b3d 4e6f 6e65 2c0a 2020 2020 293a  ork=None,.    ):
-000125b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000125c0: 2020 2020 2043 6f6d 7075 7465 2074 6865       Compute the
-000125d0: 206f 7574 7075 7420 7465 6e73 6f72 7320   output tensors 
-000125e0: 616e 6420 7361 7665 7320 7468 656d 2069  and saves them i
-000125f0: 6e20 7468 6520 4d41 5053 2e0a 0a20 2020  n the MAPS...   
-00012600: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-00012610: 2020 2020 2020 2064 6174 6173 6574 2028         dataset (
-00012620: 636c 696e 6963 6164 6c2e 7574 696c 732e  clinicadl.utils.
-00012630: 6361 7073 5f64 6174 6173 6574 2e64 6174  caps_dataset.dat
-00012640: 612e 4361 7073 4461 7461 7365 7429 3a20  a.CapsDataset): 
-00012650: 7772 6170 7065 7220 6f66 2074 6865 2064  wrapper of the d
-00012660: 6174 6120 7365 742e 0a20 2020 2020 2020  ata set..       
-00012670: 2020 2020 2064 6174 615f 6772 6f75 7020       data_group 
-00012680: 2873 7472 293a 206e 616d 6520 6f66 2074  (str): name of t
-00012690: 6865 2064 6174 6120 6772 6f75 7020 7573  he data group us
-000126a0: 6564 2066 6f72 2074 6865 2074 6173 6b2e  ed for the task.
-000126b0: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
-000126c0: 6974 2028 696e 7429 3a20 7370 6c69 7420  it (int): split 
-000126d0: 6e75 6d62 6572 2e0a 2020 2020 2020 2020  number..        
-000126e0: 2020 2020 7365 6c65 6374 696f 6e5f 6d65      selection_me
-000126f0: 7472 6963 7320 286c 6973 745b 7374 725d  trics (list[str]
-00012700: 293a 206d 6574 7269 6373 2075 7365 6420  ): metrics used 
-00012710: 666f 7220 6d6f 6465 6c20 7365 6c65 6374  for model select
-00012720: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-00012730: 206e 625f 696d 6167 6573 2028 696e 7429   nb_images (int)
-00012740: 3a20 6e75 6d62 6572 206f 6620 6675 6c6c  : number of full
-00012750: 2069 6d61 6765 7320 746f 2077 7269 7465   images to write
-00012760: 2e20 4465 6661 756c 7420 636f 6d70 7574  . Default comput
-00012770: 6573 2074 6865 206f 7574 7075 7473 206f  es the outputs o
-00012780: 6620 7468 6520 7768 6f6c 6520 6461 7461  f the whole data
-00012790: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-000127a0: 2020 6770 7520 2862 6f6f 6c29 3a20 4966    gpu (bool): If
-000127b0: 2067 6976 656e 2c20 6120 6e65 7720 7661   given, a new va
-000127c0: 6c75 6520 666f 7220 7468 6520 6465 7669  lue for the devi
-000127d0: 6365 206f 6620 7468 6520 6d6f 6465 6c20  ce of the model 
-000127e0: 7769 6c6c 2062 6520 636f 6d70 7574 6564  will be computed
-000127f0: 2e0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
-00012800: 7477 6f72 6b20 2869 6e74 293a 2049 6e64  twork (int): Ind
-00012810: 6578 206f 6620 7468 6520 6e65 7477 6f72  ex of the networ
-00012820: 6b20 7465 7374 6564 2028 6f6e 6c79 2075  k tested (only u
-00012830: 7365 6420 696e 206d 756c 7469 2d6e 6574  sed in multi-net
-00012840: 776f 726b 2073 6574 7469 6e67 292e 0a20  work setting).. 
-00012850: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00012860: 2020 2066 6f72 2073 656c 6563 7469 6f6e     for selection
-00012870: 5f6d 6574 7269 6320 696e 2073 656c 6563  _metric in selec
-00012880: 7469 6f6e 5f6d 6574 7269 6373 3a0a 2020  tion_metrics:.  
-00012890: 2020 2020 2020 2020 2020 2320 6c6f 6164            # load
-000128a0: 2074 6865 2062 6573 7420 7472 6169 6e65   the best traine
-000128b0: 6420 6d6f 6465 6c20 6475 7269 6e67 2074  d model during t
-000128c0: 6865 2074 7261 696e 696e 670a 2020 2020  he training.    
-000128d0: 2020 2020 2020 2020 6d6f 6465 6c2c 205f          model, _
-000128e0: 203d 2073 656c 662e 5f69 6e69 745f 6d6f   = self._init_mo
-000128f0: 6465 6c28 0a20 2020 2020 2020 2020 2020  del(.           
-00012900: 2020 2020 2074 7261 6e73 6665 725f 7061       transfer_pa
-00012910: 7468 3d73 656c 662e 6d61 7073 5f70 6174  th=self.maps_pat
-00012920: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00012930: 2020 2073 706c 6974 3d73 706c 6974 2c0a     split=split,.
-00012940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012950: 7472 616e 7366 6572 5f73 656c 6563 7469  transfer_selecti
-00012960: 6f6e 3d73 656c 6563 7469 6f6e 5f6d 6574  on=selection_met
-00012970: 7269 632c 0a20 2020 2020 2020 2020 2020  ric,.           
-00012980: 2020 2020 2067 7075 3d67 7075 2c0a 2020       gpu=gpu,.  
-00012990: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-000129a0: 7477 6f72 6b3d 6e65 7477 6f72 6b2c 0a20  twork=network,. 
-000129b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000129c0: 625f 756e 6672 6f7a 656e 5f6c 6179 6572  b_unfrozen_layer
-000129d0: 3d73 656c 662e 6e62 5f75 6e66 726f 7a65  =self.nb_unfroze
-000129e0: 6e5f 6c61 7965 722c 0a20 2020 2020 2020  n_layer,.       
-000129f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00012a00: 2020 206d 6f64 656c 203d 2044 4450 286d     model = DDP(m
-00012a10: 6f64 656c 290a 0a20 2020 2020 2020 2020  odel)..         
-00012a20: 2020 2074 656e 736f 725f 7061 7468 203d     tensor_path =
-00012a30: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00012a40: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
-00012a50: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-00012a60: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
-00012a70: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
-00012a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012a90: 202f 2066 2262 6573 742d 7b73 656c 6563   / f"best-{selec
-00012aa0: 7469 6f6e 5f6d 6574 7269 637d 220a 2020  tion_metric}".  
-00012ab0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-00012ac0: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
-00012ad0: 2020 2020 2020 2020 2020 202f 2022 6c61             / "la
-00012ae0: 7465 6e74 5f74 656e 736f 7273 220a 2020  tent_tensors".  
-00012af0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00012b00: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
-00012b10: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
-00012b20: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00012b30: 725f 7061 7468 2e6d 6b64 6972 2870 6172  r_path.mkdir(par
-00012b40: 656e 7473 3d54 7275 652c 2065 7869 7374  ents=True, exist
-00012b50: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-00012b60: 2020 2020 2020 6469 7374 2e62 6172 7269        dist.barri
-00012b70: 6572 2829 0a0a 2020 2020 2020 2020 2020  er()..          
-00012b80: 2020 6966 206e 625f 696d 6167 6573 2069    if nb_images i
-00012b90: 7320 4e6f 6e65 3a20 2023 2043 6f6d 7075  s None:  # Compu
-00012ba0: 7465 206f 7574 7075 7473 2066 6f72 2074  te outputs for t
-00012bb0: 6865 2077 686f 6c65 2064 6174 6120 7365  he whole data se
-00012bc0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00012bd0: 2020 6e62 5f6d 6f64 6573 203d 206c 656e    nb_modes = len
-00012be0: 2864 6174 6173 6574 290a 2020 2020 2020  (dataset).      
-00012bf0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012c00: 2020 2020 2020 2020 2020 2020 6e62 5f6d              nb_m
-00012c10: 6f64 6573 203d 206e 625f 696d 6167 6573  odes = nb_images
-00012c20: 202a 2064 6174 6173 6574 2e65 6c65 6d5f   * dataset.elem_
-00012c30: 7065 725f 696d 6167 650a 0a20 2020 2020  per_image..     
-00012c40: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00012c50: 7261 6e67 6528 636c 7573 7465 722e 7261  range(cluster.ra
-00012c60: 6e6b 2c20 6e62 5f6d 6f64 6573 2c20 636c  nk, nb_modes, cl
-00012c70: 7573 7465 722e 776f 726c 645f 7369 7a65  uster.world_size
-00012c80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012c90: 2020 2064 6174 6120 3d20 6461 7461 7365     data = datase
-00012ca0: 745b 695d 0a20 2020 2020 2020 2020 2020  t[i].           
-00012cb0: 2020 2020 2069 6d61 6765 203d 2064 6174       image = dat
-00012cc0: 615b 2269 6d61 6765 225d 0a20 2020 2020  a["image"].     
-00012cd0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00012ce0: 722e 6465 6275 6728 6622 496d 6167 6520  r.debug(f"Image 
-00012cf0: 666f 7220 6c61 7465 6e74 2072 6570 7265  for latent repre
-00012d00: 7365 6e74 6174 696f 6e20 7b69 6d61 6765  sentation {image
-00012d10: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-00012d20: 2020 2020 7769 7468 2061 7574 6f63 6173      with autocas
-00012d30: 7428 656e 6162 6c65 643d 7365 6c66 2e61  t(enabled=self.a
-00012d40: 6d70 293a 0a20 2020 2020 2020 2020 2020  mp):.           
-00012d50: 2020 2020 2020 2020 205f 2c20 6c61 7465           _, late
-00012d60: 6e74 2c20 5f20 3d20 6d6f 6465 6c2e 5f66  nt, _ = model._f
-00012d70: 6f72 7761 7264 2869 6d61 6765 2e75 6e73  orward(image.uns
-00012d80: 7175 6565 7a65 2830 292e 746f 286d 6f64  queeze(0).to(mod
-00012d90: 656c 2e64 6576 6963 6529 290a 2020 2020  el.device)).    
-00012da0: 2020 2020 2020 2020 2020 2020 6c61 7465              late
-00012db0: 6e74 203d 206c 6174 656e 742e 7371 7565  nt = latent.sque
-00012dc0: 657a 6528 3029 2e63 7075 2829 2e66 6c6f  eze(0).cpu().flo
-00012dd0: 6174 2829 0a20 2020 2020 2020 2020 2020  at().           
-00012de0: 2020 2020 2070 6172 7469 6369 7061 6e74       participant
-00012df0: 5f69 6420 3d20 6461 7461 5b22 7061 7274  _id = data["part
-00012e00: 6963 6970 616e 745f 6964 225d 0a20 2020  icipant_id"].   
-00012e10: 2020 2020 2020 2020 2020 2020 2073 6573               ses
-00012e20: 7369 6f6e 5f69 6420 3d20 6461 7461 5b22  sion_id = data["
-00012e30: 7365 7373 696f 6e5f 6964 225d 0a20 2020  session_id"].   
-00012e40: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00012e50: 655f 6964 203d 2064 6174 615b 6622 7b73  e_id = data[f"{s
-00012e60: 656c 662e 6d6f 6465 7d5f 6964 225d 0a20  elf.mode}_id"]. 
-00012e70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00012e80: 7574 7075 745f 6669 6c65 6e61 6d65 203d  utput_filename =
-00012e90: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00012ea0: 2020 2020 2020 2066 227b 7061 7274 6963         f"{partic
-00012eb0: 6970 616e 745f 6964 7d5f 7b73 6573 7369  ipant_id}_{sessi
-00012ec0: 6f6e 5f69 647d 5f7b 7365 6c66 2e6d 6f64  on_id}_{self.mod
-00012ed0: 657d 2d7b 6d6f 6465 5f69 647d 5f6c 6174  e}-{mode_id}_lat
-00012ee0: 656e 742e 7074 220a 2020 2020 2020 2020  ent.pt".        
-00012ef0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00012f00: 2020 2020 2020 2020 2020 746f 7263 682e            torch.
-00012f10: 7361 7665 286c 6174 656e 742c 2074 656e  save(latent, ten
-00012f20: 736f 725f 7061 7468 202f 206f 7574 7075  sor_path / outpu
-00012f30: 745f 6669 6c65 6e61 6d65 290a 0a20 2020  t_filename)..   
-00012f40: 2064 6566 205f 656e 7365 6d62 6c65 5f70   def _ensemble_p
-00012f50: 7265 6469 6374 696f 6e28 0a20 2020 2020  rediction(.     
-00012f60: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00012f70: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
-00012f80: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-00012f90: 2020 2020 7365 6c65 6374 696f 6e5f 6d65      selection_me
-00012fa0: 7472 6963 732c 0a20 2020 2020 2020 2075  trics,.        u
-00012fb0: 7365 5f6c 6162 656c 733d 5472 7565 2c0a  se_labels=True,.
-00012fc0: 2020 2020 2020 2020 736b 6970 5f6c 6561          skip_lea
-00012fd0: 6b5f 6368 6563 6b3d 4661 6c73 652c 0a20  k_check=False,. 
-00012fe0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00012ff0: 2243 6f6d 7075 7465 7320 7468 6520 7265  "Computes the re
-00013000: 7375 6c74 7320 6f6e 2074 6865 2069 6d61  sults on the ima
-00013010: 6765 2d6c 6576 656c 2e22 2222 0a0a 2020  ge-level."""..  
-00013020: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00013030: 6563 7469 6f6e 5f6d 6574 7269 6373 3a0a  ection_metrics:.
-00013040: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-00013050: 6374 696f 6e5f 6d65 7472 6963 7320 3d20  ction_metrics = 
-00013060: 7365 6c66 2e5f 6669 6e64 5f73 656c 6563  self._find_selec
-00013070: 7469 6f6e 5f6d 6574 7269 6373 2873 706c  tion_metrics(spl
-00013080: 6974 290a 0a20 2020 2020 2020 2066 6f72  it)..        for
-00013090: 2073 656c 6563 7469 6f6e 5f6d 6574 7269   selection_metri
-000130a0: 6320 696e 2073 656c 6563 7469 6f6e 5f6d  c in selection_m
-000130b0: 6574 7269 6373 3a0a 2020 2020 2020 2020  etrics:.        
-000130c0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-000130d0: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
-000130e0: 2020 2020 2020 2320 536f 6674 2076 6f74        # Soft vot
-000130f0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00013100: 6966 2073 656c 662e 6e75 6d5f 6e65 7477  if self.num_netw
-00013110: 6f72 6b73 203e 2031 2061 6e64 206e 6f74  orks > 1 and not
-00013120: 2073 6b69 705f 6c65 616b 5f63 6865 636b   skip_leak_check
+0000e130: 7472 6169 6e5f 736f 7572 6365 5f6c 6f61  train_source_loa
+0000e140: 6465 722e 6461 7461 7365 742e 7472 6169  der.dataset.trai
+0000e150: 6e28 290a 0a20 2020 2020 2020 2020 2020  n()..           
+0000e160: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000e170: 5f77 7269 7465 722e 7374 6570 280a 2020  _writer.step(.  
+0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e190: 2020 2020 2020 2020 2020 6570 6f63 682c            epoch,
+0000e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e1b0: 2020 2020 2020 2020 2020 2020 2069 2c0a               i,.
+0000e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1d0: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
+0000e1e0: 6963 735f 7472 6169 6e5f 736f 7572 6365  ics_train_source
+0000e1f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e200: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0000e210: 7472 6963 735f 7661 6c69 645f 736f 7572  trics_valid_sour
+0000e220: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e240: 6c65 6e28 7472 6169 6e5f 736f 7572 6365  len(train_source
+0000e250: 5f6c 6f61 6465 7229 2c0a 2020 2020 2020  _loader),.      
+0000e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e270: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000e280: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000e290: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2b0: 2020 2020 2066 227b 7365 6c66 2e6d 6f64       f"{self.mod
+0000e2c0: 657d 206c 6576 656c 2074 7261 696e 696e  e} level trainin
+0000e2d0: 6720 6c6f 7373 2066 6f72 2073 6f75 7263  g loss for sourc
+0000e2e0: 6520 6461 7461 2069 7320 7b6d 6574 7269  e data is {metri
+0000e2f0: 6373 5f74 7261 696e 5f73 6f75 7263 655b  cs_train_source[
+0000e300: 276c 6f73 7327 5d7d 2022 0a20 2020 2020  'loss']} ".     
+0000e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e320: 2020 2020 2020 2066 2261 7420 7468 6520         f"at the 
+0000e330: 656e 6420 6f66 2069 7465 7261 7469 6f6e  end of iteration
+0000e340: 207b 697d 220a 2020 2020 2020 2020 2020   {i}".          
+0000e350: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e370: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0000e380: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+0000e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e3a0: 2066 227b 7365 6c66 2e6d 6f64 657d 206c   f"{self.mode} l
+0000e3b0: 6576 656c 2076 616c 6964 6174 696f 6e20  evel validation 
+0000e3c0: 6c6f 7373 2066 6f72 2073 6f75 7263 6520  loss for source 
+0000e3d0: 6461 7461 2069 7320 7b6d 6574 7269 6373  data is {metrics
+0000e3e0: 5f76 616c 6964 5f73 6f75 7263 655b 276c  _valid_source['l
+0000e3f0: 6f73 7327 5d7d 2022 0a20 2020 2020 2020  oss']} ".       
+0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e410: 2020 2020 2066 2261 7420 7468 6520 656e       f"at the en
+0000e420: 6420 6f66 2069 7465 7261 7469 6f6e 207b  d of iteration {
+0000e430: 697d 220a 2020 2020 2020 2020 2020 2020  i}".            
+0000e440: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000e450: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0000e460: 6e6f 2073 7465 7020 6861 7320 6265 656e  no step has been
+0000e470: 2070 6572 666f 726d 6564 2c20 7261 6973   performed, rais
+0000e480: 6520 4578 6365 7074 696f 6e0a 2020 2020  e Exception.    
+0000e490: 2020 2020 2020 2020 6966 2073 7465 705f          if step_
+0000e4a0: 666c 6167 3a0a 2020 2020 2020 2020 2020  flag:.          
+0000e4b0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+0000e4c0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+0000e4d0: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
+0000e4e0: 6d6f 6465 6c20 6861 7320 6e6f 7420 6265  model has not be
+0000e4f0: 656e 2075 7064 6174 6564 206f 6e63 6520  en updated once 
+0000e500: 696e 2074 6865 2065 706f 6368 2e20 5468  in the epoch. Th
+0000e510: 6520 6163 6375 6d75 6c61 7469 6f6e 2073  e accumulation s
+0000e520: 7465 7020 6d61 7920 6265 2074 6f6f 206c  tep may be too l
+0000e530: 6172 6765 2e22 0a20 2020 2020 2020 2020  arge.".         
+0000e540: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000e550: 2020 2020 2020 2320 4966 206e 6f20 6576        # If no ev
+0000e560: 616c 7561 7469 6f6e 2068 6173 2062 6565  aluation has bee
+0000e570: 6e20 7065 7266 6f72 6d65 642c 2077 6172  n performed, war
+0000e580: 6e20 7468 6520 7573 6572 0a20 2020 2020  n the user.     
+0000e590: 2020 2020 2020 2065 6c69 6620 6576 616c         elif eval
+0000e5a0: 7561 7469 6f6e 5f66 6c61 6720 616e 6420  uation_flag and 
+0000e5b0: 7365 6c66 2e65 7661 6c75 6174 696f 6e5f  self.evaluation_
+0000e5c0: 7374 6570 7320 213d 2030 3a0a 2020 2020  steps != 0:.    
+0000e5d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000e5e0: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+0000e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e600: 6622 596f 7572 2065 7661 6c75 6174 696f  f"Your evaluatio
+0000e610: 6e20 7374 6570 7320 7b73 656c 662e 6576  n steps {self.ev
+0000e620: 616c 7561 7469 6f6e 5f73 7465 7073 7d20  aluation_steps} 
+0000e630: 6172 6520 746f 6f20 6269 6720 220a 2020  are too big ".  
+0000e640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e650: 2020 6622 636f 6d70 6172 6564 2074 6f20    f"compared to 
+0000e660: 7468 6520 7369 7a65 206f 6620 7468 6520  the size of the 
+0000e670: 6461 7461 7365 742e 2022 0a20 2020 2020  dataset. ".     
+0000e680: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e690: 2254 6865 206d 6f64 656c 2069 7320 6576  "The model is ev
+0000e6a0: 616c 7561 7465 6420 6f6e 6c79 206f 6e63  aluated only onc
+0000e6b0: 6520 6174 2074 6865 2065 6e64 2065 706f  e at the end epo
+0000e6c0: 6368 732e 220a 2020 2020 2020 2020 2020  chs.".          
+0000e6d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000e6e0: 2020 2020 2023 2055 7064 6174 6520 7765       # Update we
+0000e6f0: 6967 6874 7320 6f6e 6520 6c61 7374 2074  ights one last t
+0000e700: 696d 6520 6966 2067 7261 6469 656e 7473  ime if gradients
+0000e710: 2077 6572 6520 636f 6d70 7574 6564 2077   were computed w
+0000e720: 6974 686f 7574 2075 7064 6174 650a 2020  ithout update.  
+0000e730: 2020 2020 2020 2020 2020 6966 2028 6920            if (i 
+0000e740: 2b20 3129 2025 2073 656c 662e 6163 6375  + 1) % self.accu
+0000e750: 6d75 6c61 7469 6f6e 5f73 7465 7073 2021  mulation_steps !
+0000e760: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0000e770: 2020 2020 206f 7074 696d 697a 6572 2e73       optimizer.s
+0000e780: 7465 7028 290a 2020 2020 2020 2020 2020  tep().          
+0000e790: 2020 2020 2020 6f70 7469 6d69 7a65 722e        optimizer.
+0000e7a0: 7a65 726f 5f67 7261 6428 290a 2020 2020  zero_grad().    
+0000e7b0: 2020 2020 2020 2020 2320 416c 7761 7973          # Always
+0000e7c0: 2074 6573 7420 7468 6520 7265 7375 6c74   test the result
+0000e7d0: 7320 616e 6420 7361 7665 2074 6865 6d20  s and save them 
+0000e7e0: 6f6e 6365 2061 7420 7468 6520 656e 6420  once at the end 
+0000e7f0: 6f66 2074 6865 2065 706f 6368 0a20 2020  of the epoch.   
+0000e800: 2020 2020 2020 2020 206d 6f64 656c 2e7a           model.z
+0000e810: 6572 6f5f 6772 6164 2829 0a20 2020 2020  ero_grad().     
+0000e820: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+0000e830: 6275 6728 6622 4c61 7374 2063 6865 636b  bug(f"Last check
+0000e840: 706f 696e 7420 6174 2074 6865 2065 6e64  point at the end
+0000e850: 206f 6620 7468 6520 6570 6f63 6820 7b65   of the epoch {e
+0000e860: 706f 6368 7d22 290a 0a20 2020 2020 2020  poch}")..       
+0000e870: 2020 2020 2069 6620 6576 616c 7561 7465       if evaluate
+0000e880: 5f73 6f75 7263 653a 0a20 2020 2020 2020  _source:.       
+0000e890: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000e8a0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+0000e8b0: 2020 2020 2020 2020 2020 6622 4576 616c            f"Eval
+0000e8c0: 7561 7465 2073 6f75 7263 6520 6461 7461  uate source data
+0000e8d0: 2061 7420 7468 6520 656e 6420 6f66 2074   at the end of t
+0000e8e0: 6865 2065 706f 6368 207b 6570 6f63 687d  he epoch {epoch}
+0000e8f0: 2077 6974 6820 616c 7068 613a 207b 616c   with alpha: {al
+0000e900: 7068 617d 2e22 0a20 2020 2020 2020 2020  pha}.".         
+0000e910: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e920: 2020 2020 2020 2020 205f 2c20 6d65 7472           _, metr
+0000e930: 6963 735f 7472 6169 6e5f 736f 7572 6365  ics_train_source
+0000e940: 203d 2073 656c 662e 7461 736b 5f6d 616e   = self.task_man
+0000e950: 6167 6572 2e74 6573 745f 6461 280a 2020  ager.test_da(.  
+0000e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e970: 2020 6d6f 6465 6c2c 0a20 2020 2020 2020    model,.       
+0000e980: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+0000e990: 696e 5f73 6f75 7263 655f 6c6f 6164 6572  in_source_loader
+0000e9a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e9b0: 2020 2020 2020 6372 6974 6572 696f 6e2c        criterion,
+0000e9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e9d0: 2020 2020 2061 6c70 6861 2c0a 2020 2020       alpha,.    
+0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9f0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000ea00: 2020 2020 2020 2020 2020 4661 6c73 652c            False,
+0000ea10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ea20: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000ea30: 2020 205f 2c20 6d65 7472 6963 735f 7661     _, metrics_va
+0000ea40: 6c69 645f 736f 7572 6365 203d 2073 656c  lid_source = sel
+0000ea50: 662e 7461 736b 5f6d 616e 6167 6572 2e74  f.task_manager.t
+0000ea60: 6573 745f 6461 280a 2020 2020 2020 2020  est_da(.        
+0000ea70: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0000ea80: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+0000ea90: 2020 2020 2020 2076 616c 6964 5f73 6f75         valid_sou
+0000eaa0: 7263 655f 6c6f 6164 6572 2c0a 2020 2020  rce_loader,.    
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eac0: 6372 6974 6572 696f 6e2c 0a20 2020 2020  criterion,.     
+0000ead0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000eae0: 6c70 6861 2c0a 2020 2020 2020 2020 2020  lpha,.          
+0000eaf0: 2020 2020 2020 2020 2020 5472 7565 2c0a            True,.
+0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb10: 2020 2020 4661 6c73 652c 0a20 2020 2020      False,.     
+0000eb20: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000eb30: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000eb40: 675f 7772 6974 6572 2e73 7465 7028 0a20  g_writer.step(. 
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2020 2065 706f 6368 2c0a 2020 2020 2020     epoch,.      
+0000eb70: 2020 2020 2020 2020 2020 2020 2020 692c                i,
+0000eb80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eb90: 2020 2020 206d 6574 7269 6373 5f74 7261       metrics_tra
+0000eba0: 696e 5f73 6f75 7263 652c 0a20 2020 2020  in_source,.     
+0000ebb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000ebc0: 6574 7269 6373 5f76 616c 6964 5f73 6f75  etrics_valid_sou
+0000ebd0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0000ebe0: 2020 2020 2020 2020 206c 656e 2874 7261           len(tra
+0000ebf0: 696e 5f73 6f75 7263 655f 6c6f 6164 6572  in_source_loader
+0000ec00: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000ec10: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0000ec20: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+0000ec30: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0000ec40: 2020 2020 2020 2066 227b 7365 6c66 2e6d         f"{self.m
+0000ec50: 6f64 657d 206c 6576 656c 2074 7261 696e  ode} level train
+0000ec60: 696e 6720 6c6f 7373 2066 6f72 2073 6f75  ing loss for sou
+0000ec70: 7263 6520 6461 7461 2069 7320 7b6d 6574  rce data is {met
+0000ec80: 7269 6373 5f74 7261 696e 5f73 6f75 7263  rics_train_sourc
+0000ec90: 655b 276c 6f73 7327 5d7d 2022 0a20 2020  e['loss']} ".   
+0000eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecb0: 2066 2261 7420 7468 6520 656e 6420 6f66   f"at the end of
+0000ecc0: 2069 7465 7261 7469 6f6e 207b 697d 220a   iteration {i}".
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ece0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ecf0: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
+0000ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed10: 2020 2066 227b 7365 6c66 2e6d 6f64 657d     f"{self.mode}
+0000ed20: 206c 6576 656c 2076 616c 6964 6174 696f   level validatio
+0000ed30: 6e20 6c6f 7373 2066 6f72 2073 6f75 7263  n loss for sourc
+0000ed40: 6520 6461 7461 2069 7320 7b6d 6574 7269  e data is {metri
+0000ed50: 6373 5f76 616c 6964 5f73 6f75 7263 655b  cs_valid_source[
+0000ed60: 276c 6f73 7327 5d7d 2022 0a20 2020 2020  'loss']} ".     
+0000ed70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ed80: 2261 7420 7468 6520 656e 6420 6f66 2069  "at the end of i
+0000ed90: 7465 7261 7469 6f6e 207b 697d 220a 2020  teration {i}".  
+0000eda0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000edb0: 0a20 2020 2020 2020 2020 2020 205f 2c20  .            _, 
+0000edc0: 6d65 7472 6963 735f 7472 6169 6e5f 7461  metrics_train_ta
+0000edd0: 7267 6574 203d 2073 656c 662e 7461 736b  rget = self.task
+0000ede0: 5f6d 616e 6167 6572 2e74 6573 745f 6461  _manager.test_da
+0000edf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ee00: 2020 6d6f 6465 6c2c 0a20 2020 2020 2020    model,.       
+0000ee10: 2020 2020 2020 2020 2074 7261 696e 5f74           train_t
+0000ee20: 6172 6765 745f 6c6f 6164 6572 2c0a 2020  arget_loader,.  
+0000ee30: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+0000ee40: 6974 6572 696f 6e2c 0a20 2020 2020 2020  iterion,.       
+0000ee50: 2020 2020 2020 2020 2061 6c70 6861 2c0a           alpha,.
+0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee70: 7461 7267 6574 3d54 7275 652c 0a20 2020  target=True,.   
+0000ee80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000ee90: 2020 2020 2020 205f 2c20 6d65 7472 6963         _, metric
+0000eea0: 735f 7661 6c69 645f 7461 7267 6574 203d  s_valid_target =
+0000eeb0: 2073 656c 662e 7461 736b 5f6d 616e 6167   self.task_manag
+0000eec0: 6572 2e74 6573 745f 6461 280a 2020 2020  er.test_da(.    
+0000eed0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0000eee0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+0000eef0: 2020 2076 616c 6964 5f6c 6f61 6465 722c     valid_loader,
+0000ef00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef10: 2063 7269 7465 7269 6f6e 2c0a 2020 2020   criterion,.    
+0000ef20: 2020 2020 2020 2020 2020 2020 616c 7068              alph
+0000ef30: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+0000ef40: 2020 2074 6172 6765 743d 5472 7565 2c0a     target=True,.
+0000ef50: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000ef60: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0000ef70: 2e74 7261 696e 2829 0a20 2020 2020 2020  .train().       
+0000ef80: 2020 2020 2074 7261 696e 5f73 6f75 7263       train_sourc
+0000ef90: 655f 6c6f 6164 6572 2e64 6174 6173 6574  e_loader.dataset
+0000efa0: 2e74 7261 696e 2829 0a20 2020 2020 2020  .train().       
+0000efb0: 2020 2020 2074 7261 696e 5f74 6172 6765       train_targe
+0000efc0: 745f 6c6f 6164 6572 2e64 6174 6173 6574  t_loader.dataset
+0000efd0: 2e74 7261 696e 2829 0a0a 2020 2020 2020  .train()..      
+0000efe0: 2020 2020 2020 6c6f 675f 7772 6974 6572        log_writer
+0000eff0: 2e73 7465 7028 0a20 2020 2020 2020 2020  .step(.         
+0000f000: 2020 2020 2020 2065 706f 6368 2c0a 2020         epoch,.  
+0000f010: 2020 2020 2020 2020 2020 2020 2020 692c                i,
+0000f020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f030: 206d 6574 7269 6373 5f74 7261 696e 5f74   metrics_train_t
+0000f040: 6172 6765 742c 0a20 2020 2020 2020 2020  arget,.         
+0000f050: 2020 2020 2020 206d 6574 7269 6373 5f76         metrics_v
+0000f060: 616c 6964 5f74 6172 6765 742c 0a20 2020  alid_target,.   
+0000f070: 2020 2020 2020 2020 2020 2020 206c 656e               len
+0000f080: 2874 7261 696e 5f74 6172 6765 745f 6c6f  (train_target_lo
+0000f090: 6164 6572 292c 0a20 2020 2020 2020 2020  ader),.         
+0000f0a0: 2020 2020 2020 2022 7472 6169 6e69 6e67         "training
+0000f0b0: 5f74 6172 6765 742e 7473 7622 2c0a 2020  _target.tsv",.  
+0000f0c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000f0d0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000f0e0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+0000f0f0: 2020 2020 2020 6622 7b73 656c 662e 6d6f        f"{self.mo
+0000f100: 6465 7d20 6c65 7665 6c20 7472 6169 6e69  de} level traini
+0000f110: 6e67 206c 6f73 7320 666f 7220 7461 7267  ng loss for targ
+0000f120: 6574 2064 6174 6120 6973 207b 6d65 7472  et data is {metr
+0000f130: 6963 735f 7472 6169 6e5f 7461 7267 6574  ics_train_target
+0000f140: 5b27 6c6f 7373 275d 7d20 220a 2020 2020  ['loss']} ".    
+0000f150: 2020 2020 2020 2020 2020 2020 6622 6174              f"at
+0000f160: 2074 6865 2065 6e64 206f 6620 6974 6572   the end of iter
+0000f170: 6174 696f 6e20 7b69 7d22 0a20 2020 2020  ation {i}".     
+0000f180: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000f190: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0000f1a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000f1b0: 2020 6622 7b73 656c 662e 6d6f 6465 7d20    f"{self.mode} 
+0000f1c0: 6c65 7665 6c20 7661 6c69 6461 7469 6f6e  level validation
+0000f1d0: 206c 6f73 7320 666f 7220 7461 7267 6574   loss for target
+0000f1e0: 2064 6174 6120 6973 207b 6d65 7472 6963   data is {metric
+0000f1f0: 735f 7661 6c69 645f 7461 7267 6574 5b27  s_valid_target['
+0000f200: 6c6f 7373 275d 7d20 220a 2020 2020 2020  loss']} ".      
+0000f210: 2020 2020 2020 2020 2020 6622 6174 2074            f"at t
+0000f220: 6865 2065 6e64 206f 6620 6974 6572 6174  he end of iterat
+0000f230: 696f 6e20 7b69 7d22 0a20 2020 2020 2020  ion {i}".       
+0000f240: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000f250: 2020 2020 2320 5361 7665 2063 6865 636b      # Save check
+0000f260: 706f 696e 7473 2061 6e64 2062 6573 7420  points and best 
+0000f270: 6d6f 6465 6c73 0a20 2020 2020 2020 2020  models.         
+0000f280: 2020 2062 6573 745f 6469 6374 203d 2072     best_dict = r
+0000f290: 6574 6169 6e5f 6265 7374 2e73 7465 7028  etain_best.step(
+0000f2a0: 6d65 7472 6963 735f 7661 6c69 645f 7461  metrics_valid_ta
+0000f2b0: 7267 6574 290a 2020 2020 2020 2020 2020  rget).          
+0000f2c0: 2020 7365 6c66 2e5f 7772 6974 655f 7765    self._write_we
+0000f2d0: 6967 6874 7328 0a20 2020 2020 2020 2020  ights(.         
+0000f2e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000f2f0: 2020 2020 2020 2020 2020 2020 2022 6d6f               "mo
+0000f300: 6465 6c22 3a20 6d6f 6465 6c2e 7374 6174  del": model.stat
+0000f310: 655f 6469 6374 2829 2c0a 2020 2020 2020  e_dict(),.      
+0000f320: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+0000f330: 706f 6368 223a 2065 706f 6368 2c0a 2020  poch": epoch,.  
+0000f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f350: 2020 226e 616d 6522 3a20 7365 6c66 2e61    "name": self.a
+0000f360: 7263 6869 7465 6374 7572 652c 0a20 2020  rchitecture,.   
+0000f370: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+0000f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f390: 6265 7374 5f64 6963 742c 0a20 2020 2020  best_dict,.     
+0000f3a0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+0000f3b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f3c0: 2020 6e65 7477 6f72 6b3d 6e65 7477 6f72    network=networ
+0000f3d0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+0000f3e0: 2020 2073 6176 655f 616c 6c5f 6d6f 6465     save_all_mode
+0000f3f0: 6c73 3d46 616c 7365 2c0a 2020 2020 2020  ls=False,.      
+0000f400: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f410: 2020 2020 7365 6c66 2e5f 7772 6974 655f      self._write_
+0000f420: 7765 6967 6874 7328 0a20 2020 2020 2020  weights(.       
+0000f430: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0000f440: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000f450: 6f70 7469 6d69 7a65 7222 3a20 6f70 7469  optimizer": opti
+0000f460: 6d69 7a65 722e 7374 6174 655f 6469 6374  mizer.state_dict
+0000f470: 2829 2c20 2023 2054 4f20 4d4f 4449 4659  (),  # TO MODIFY
+0000f480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f490: 2020 2020 2022 6570 6f63 6822 3a20 6570       "epoch": ep
+0000f4a0: 6f63 682c 0a20 2020 2020 2020 2020 2020  och,.           
+0000f4b0: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+0000f4c0: 2073 656c 662e 6f70 7469 6d69 7a65 722c   self.optimizer,
+0000f4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f4e0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+0000f4f0: 2020 2020 4e6f 6e65 2c0a 2020 2020 2020      None,.      
+0000f500: 2020 2020 2020 2020 2020 7370 6c69 742c            split,
+0000f510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f520: 2066 696c 656e 616d 653d 226f 7074 696d   filename="optim
+0000f530: 697a 6572 2e70 7468 2e74 6172 222c 0a20  izer.pth.tar",. 
+0000f540: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f550: 6176 655f 616c 6c5f 6d6f 6465 6c73 3d46  ave_all_models=F
+0000f560: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+0000f570: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000f580: 2065 706f 6368 202b 3d20 310a 0a20 2020   epoch += 1..   
+0000f590: 2020 2020 2073 656c 662e 5f74 6573 745f       self._test_
+0000f5a0: 6c6f 6164 6572 5f73 7364 6128 0a20 2020  loader_ssda(.   
+0000f5b0: 2020 2020 2020 2020 2074 7261 696e 5f74           train_t
+0000f5c0: 6172 6765 745f 6c6f 6164 6572 2c0a 2020  arget_loader,.  
+0000f5d0: 2020 2020 2020 2020 2020 6372 6974 6572            criter
+0000f5e0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+0000f5f0: 2064 6174 615f 6772 6f75 703d 2274 7261   data_group="tra
+0000f600: 696e 222c 0a20 2020 2020 2020 2020 2020  in",.           
+0000f610: 2073 706c 6974 3d73 706c 6974 2c0a 2020   split=split,.  
+0000f620: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+0000f630: 696f 6e5f 6d65 7472 6963 733d 7365 6c66  ion_metrics=self
+0000f640: 2e73 656c 6563 7469 6f6e 5f6d 6574 7269  .selection_metri
+0000f650: 6373 2c0a 2020 2020 2020 2020 2020 2020  cs,.            
+0000f660: 6e65 7477 6f72 6b3d 6e65 7477 6f72 6b2c  network=network,
+0000f670: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
+0000f680: 6765 743d 5472 7565 2c0a 2020 2020 2020  get=True,.      
+0000f690: 2020 2020 2020 616c 7068 613d 302c 0a20        alpha=0,. 
+0000f6a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000f6b0: 2073 656c 662e 5f74 6573 745f 6c6f 6164   self._test_load
+0000f6c0: 6572 5f73 7364 6128 0a20 2020 2020 2020  er_ssda(.       
+0000f6d0: 2020 2020 2076 616c 6964 5f6c 6f61 6465       valid_loade
+0000f6e0: 722c 0a20 2020 2020 2020 2020 2020 2063  r,.            c
+0000f6f0: 7269 7465 7269 6f6e 2c0a 2020 2020 2020  riterion,.      
+0000f700: 2020 2020 2020 6461 7461 5f67 726f 7570        data_group
+0000f710: 3d22 7661 6c69 6461 7469 6f6e 222c 0a20  ="validation",. 
+0000f720: 2020 2020 2020 2020 2020 2073 706c 6974             split
+0000f730: 3d73 706c 6974 2c0a 2020 2020 2020 2020  =split,.        
+0000f740: 2020 2020 7365 6c65 6374 696f 6e5f 6d65      selection_me
+0000f750: 7472 6963 733d 7365 6c66 2e73 656c 6563  trics=self.selec
+0000f760: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
+0000f770: 2020 2020 2020 2020 2020 6e65 7477 6f72            networ
+0000f780: 6b3d 6e65 7477 6f72 6b2c 0a20 2020 2020  k=network,.     
+0000f790: 2020 2020 2020 2074 6172 6765 743d 5472         target=Tr
+0000f7a0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000f7b0: 616c 7068 613d 302c 0a20 2020 2020 2020  alpha=0,.       
+0000f7c0: 2029 0a0a 2020 2020 2020 2020 6966 2073   )..        if s
+0000f7d0: 656c 662e 7461 736b 5f6d 616e 6167 6572  elf.task_manager
+0000f7e0: 2e73 6176 655f 6f75 7470 7574 733a 0a20  .save_outputs:. 
+0000f7f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f800: 5f63 6f6d 7075 7465 5f6f 7574 7075 745f  _compute_output_
+0000f810: 7465 6e73 6f72 7328 0a20 2020 2020 2020  tensors(.       
+0000f820: 2020 2020 2020 2020 2074 7261 696e 5f74           train_t
+0000f830: 6172 6765 745f 6c6f 6164 6572 2e64 6174  arget_loader.dat
+0000f840: 6173 6574 2c0a 2020 2020 2020 2020 2020  aset,.          
+0000f850: 2020 2020 2020 2274 7261 696e 222c 0a20        "train",. 
+0000f860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f870: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+0000f880: 2020 2020 2020 7365 6c66 2e73 656c 6563        self.selec
+0000f890: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
+0000f8a0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0000f8b0: 5f69 6d61 6765 733d 312c 0a20 2020 2020  _images=1,.     
+0000f8c0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
+0000f8d0: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
+0000f8e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000f8f0: 2020 2020 2020 7365 6c66 2e5f 636f 6d70        self._comp
+0000f900: 7574 655f 6f75 7470 7574 5f74 656e 736f  ute_output_tenso
+0000f910: 7273 280a 2020 2020 2020 2020 2020 2020  rs(.            
+0000f920: 2020 2020 7472 6169 6e5f 7461 7267 6574      train_target
+0000f930: 5f6c 6f61 6465 722e 6461 7461 7365 742c  _loader.dataset,
+0000f940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f950: 2022 7661 6c69 6461 7469 6f6e 222c 0a20   "validation",. 
+0000f960: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f970: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+0000f980: 2020 2020 2020 7365 6c66 2e73 656c 6563        self.selec
+0000f990: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0000f9b0: 5f69 6d61 6765 733d 312c 0a20 2020 2020  _images=1,.     
+0000f9c0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
+0000f9d0: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
+0000f9e0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+0000f9f0: 6566 205f 7465 7374 5f6c 6f61 6465 7228  ef _test_loader(
+0000fa00: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0000fa10: 2020 2020 2020 2064 6174 616c 6f61 6465         dataloade
+0000fa20: 722c 0a20 2020 2020 2020 2063 7269 7465  r,.        crite
+0000fa30: 7269 6f6e 2c0a 2020 2020 2020 2020 6461  rion,.        da
+0000fa40: 7461 5f67 726f 7570 3a20 7374 722c 0a20  ta_group: str,. 
+0000fa50: 2020 2020 2020 2073 706c 6974 3a20 696e         split: in
+0000fa60: 742c 0a20 2020 2020 2020 2073 656c 6563  t,.        selec
+0000fa70: 7469 6f6e 5f6d 6574 7269 6373 2c0a 2020  tion_metrics,.  
+0000fa80: 2020 2020 2020 7573 655f 6c61 6265 6c73        use_labels
+0000fa90: 3d54 7275 652c 0a20 2020 2020 2020 2067  =True,.        g
+0000faa0: 7075 3d4e 6f6e 652c 0a20 2020 2020 2020  pu=None,.       
+0000fab0: 2061 6d70 3d46 616c 7365 2c0a 2020 2020   amp=False,.    
+0000fac0: 2020 2020 6e65 7477 6f72 6b3d 4e6f 6e65      network=None
+0000fad0: 2c0a 2020 2020 2020 2020 7265 706f 7274  ,.        report
+0000fae0: 5f63 693d 5472 7565 2c0a 2020 2020 293a  _ci=True,.    ):
+0000faf0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000fb00: 2020 2020 204c 6175 6e63 6865 7320 7468       Launches th
+0000fb10: 6520 7465 7374 696e 6720 7461 736b 206f  e testing task o
+0000fb20: 6e20 6120 6461 7461 7365 7420 7772 6170  n a dataset wrap
+0000fb30: 7065 6420 6279 2061 2044 6174 614c 6f61  ped by a DataLoa
+0000fb40: 6465 7220 616e 6420 7772 6974 6573 2070  der and writes p
+0000fb50: 7265 6469 6374 696f 6e20 5453 5620 6669  rediction TSV fi
+0000fb60: 6c65 732e 0a0a 2020 2020 2020 2020 4172  les...        Ar
+0000fb70: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0000fb80: 6461 7461 6c6f 6164 6572 2028 746f 7263  dataloader (torc
+0000fb90: 682e 7574 696c 732e 6461 7461 2e44 6174  h.utils.data.Dat
+0000fba0: 614c 6f61 6465 7229 3a20 4461 7461 4c6f  aLoader): DataLo
+0000fbb0: 6164 6572 2077 7261 7070 696e 6720 7468  ader wrapping th
+0000fbc0: 6520 7465 7374 2043 6170 7344 6174 6173  e test CapsDatas
+0000fbd0: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+0000fbe0: 6372 6974 6572 696f 6e20 2874 6f72 6368  criterion (torch
+0000fbf0: 2e6e 6e2e 6d6f 6475 6c65 732e 6c6f 7373  .nn.modules.loss
+0000fc00: 2e5f 4c6f 7373 293a 206f 7074 696d 697a  ._Loss): optimiz
+0000fc10: 6174 696f 6e20 6372 6974 6572 696f 6e20  ation criterion 
+0000fc20: 7573 6564 2064 7572 696e 6720 7472 6169  used during trai
+0000fc30: 6e69 6e67 2e0a 2020 2020 2020 2020 2020  ning..          
+0000fc40: 2020 6461 7461 5f67 726f 7570 2028 7374    data_group (st
+0000fc50: 7229 3a20 6e61 6d65 206f 6620 7468 6520  r): name of the 
+0000fc60: 6461 7461 2067 726f 7570 2075 7365 6420  data group used 
+0000fc70: 666f 7220 7468 6520 7465 7374 696e 6720  for the testing 
+0000fc80: 7461 736b 2e0a 2020 2020 2020 2020 2020  task..          
+0000fc90: 2020 7370 6c69 7420 2869 6e74 293a 2049    split (int): I
+0000fca0: 6e64 6578 206f 6620 7468 6520 7370 6c69  ndex of the spli
+0000fcb0: 7420 7573 6564 2074 6f20 7472 6169 6e20  t used to train 
+0000fcc0: 7468 6520 6d6f 6465 6c20 7465 7374 6564  the model tested
+0000fcd0: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0000fce0: 6c65 6374 696f 6e5f 6d65 7472 6963 7320  lection_metrics 
+0000fcf0: 286c 6973 745b 7374 725d 293a 204c 6973  (list[str]): Lis
+0000fd00: 7420 6f66 206d 6574 7269 6373 2075 7365  t of metrics use
+0000fd10: 6420 746f 2073 656c 6563 7420 7468 6520  d to select the 
+0000fd20: 6265 7374 206d 6f64 656c 7320 7768 6963  best models whic
+0000fd30: 6820 6172 6520 7465 7374 6564 2e0a 2020  h are tested..  
+0000fd40: 2020 2020 2020 2020 2020 7573 655f 6c61            use_la
+0000fd50: 6265 6c73 2028 626f 6f6c 293a 2049 6620  bels (bool): If 
+0000fd60: 5472 7565 2c20 7468 6520 6c61 6265 6c73  True, the labels
+0000fd70: 206d 7573 7420 6578 6973 7420 696e 2074   must exist in t
+0000fd80: 6573 7420 6d65 7461 2d64 6174 6120 616e  est meta-data an
+0000fd90: 6420 6d65 7472 6963 7320 6172 6520 636f  d metrics are co
+0000fda0: 6d70 7574 6564 2e0a 2020 2020 2020 2020  mputed..        
+0000fdb0: 2020 2020 6770 7520 2862 6f6f 6c29 3a20      gpu (bool): 
+0000fdc0: 4966 2067 6976 656e 2c20 6120 6e65 7720  If given, a new 
+0000fdd0: 7661 6c75 6520 666f 7220 7468 6520 6465  value for the de
+0000fde0: 7669 6365 206f 6620 7468 6520 6d6f 6465  vice of the mode
+0000fdf0: 6c20 7769 6c6c 2062 6520 636f 6d70 7574  l will be comput
+0000fe00: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000fe10: 616d 7020 2862 6f6f 6c29 3a20 4966 2065  amp (bool): If e
+0000fe20: 6e61 626c 6564 2c20 7573 6573 2041 7574  nabled, uses Aut
+0000fe30: 6f6d 6174 6963 204d 6978 6564 2050 7265  omatic Mixed Pre
+0000fe40: 6369 7369 6f6e 2028 7265 7175 6972 6573  cision (requires
+0000fe50: 2047 5055 2075 7361 6765 292e 0a20 2020   GPU usage)..   
+0000fe60: 2020 2020 2020 2020 206e 6574 776f 726b           network
+0000fe70: 2028 696e 7429 3a20 496e 6465 7820 6f66   (int): Index of
+0000fe80: 2074 6865 206e 6574 776f 726b 2074 6573   the network tes
+0000fe90: 7465 6420 286f 6e6c 7920 7573 6564 2069  ted (only used i
+0000fea0: 6e20 6d75 6c74 692d 6e65 7477 6f72 6b20  n multi-network 
+0000feb0: 7365 7474 696e 6729 2e0a 2020 2020 2020  setting)..      
+0000fec0: 2020 2222 220a 2020 2020 2020 2020 666f    """.        fo
+0000fed0: 7220 7365 6c65 6374 696f 6e5f 6d65 7472  r selection_metr
+0000fee0: 6963 2069 6e20 7365 6c65 6374 696f 6e5f  ic in selection_
+0000fef0: 6d65 7472 6963 733a 0a20 2020 2020 2020  metrics:.       
+0000ff00: 2020 2020 2069 6620 636c 7573 7465 722e       if cluster.
+0000ff10: 6d61 7374 6572 3a0a 2020 2020 2020 2020  master:.        
+0000ff20: 2020 2020 2020 2020 6c6f 675f 6469 7220          log_dir 
+0000ff30: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000ff40: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
+0000ff50: 735f 7061 7468 0a20 2020 2020 2020 2020  s_path.         
+0000ff60: 2020 2020 2020 2020 2020 202f 2066 227b             / f"{
+0000ff70: 7365 6c66 2e73 706c 6974 5f6e 616d 657d  self.split_name}
+0000ff80: 2d7b 7370 6c69 747d 220a 2020 2020 2020  -{split}".      
+0000ff90: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+0000ffa0: 6622 6265 7374 2d7b 7365 6c65 6374 696f  f"best-{selectio
+0000ffb0: 6e5f 6d65 7472 6963 7d22 0a20 2020 2020  n_metric}".     
+0000ffc0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0000ffd0: 2064 6174 615f 6772 6f75 700a 2020 2020   data_group.    
+0000ffe0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000fff0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00010000: 6c66 2e77 7269 7465 5f64 6573 6372 6970  lf.write_descrip
+00010010: 7469 6f6e 5f6c 6f67 280a 2020 2020 2020  tion_log(.      
+00010020: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00010030: 675f 6469 722c 0a20 2020 2020 2020 2020  g_dir,.         
+00010040: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00010050: 6772 6f75 702c 0a20 2020 2020 2020 2020  group,.         
+00010060: 2020 2020 2020 2020 2020 2064 6174 616c             datal
+00010070: 6f61 6465 722e 6461 7461 7365 742e 6361  oader.dataset.ca
+00010080: 7073 5f64 6963 742c 0a20 2020 2020 2020  ps_dict,.       
+00010090: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000100a0: 616c 6f61 6465 722e 6461 7461 7365 742e  aloader.dataset.
+000100b0: 6466 2c0a 2020 2020 2020 2020 2020 2020  df,.            
+000100c0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000100d0: 2020 2023 206c 6f61 6420 7468 6520 6265     # load the be
+000100e0: 7374 2074 7261 696e 6564 206d 6f64 656c  st trained model
+000100f0: 2064 7572 696e 6720 7468 6520 7472 6169   during the trai
+00010100: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+00010110: 206d 6f64 656c 2c20 5f20 3d20 7365 6c66   model, _ = self
+00010120: 2e5f 696e 6974 5f6d 6f64 656c 280a 2020  ._init_model(.  
+00010130: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00010140: 616e 7366 6572 5f70 6174 683d 7365 6c66  ansfer_path=self
+00010150: 2e6d 6170 735f 7061 7468 2c0a 2020 2020  .maps_path,.    
+00010160: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+00010170: 743d 7370 6c69 742c 0a20 2020 2020 2020  t=split,.       
+00010180: 2020 2020 2020 2020 2074 7261 6e73 6665           transfe
+00010190: 725f 7365 6c65 6374 696f 6e3d 7365 6c65  r_selection=sele
+000101a0: 6374 696f 6e5f 6d65 7472 6963 2c0a 2020  ction_metric,.  
+000101b0: 2020 2020 2020 2020 2020 2020 2020 6770                gp
+000101c0: 753d 6770 752c 0a20 2020 2020 2020 2020  u=gpu,.         
+000101d0: 2020 2020 2020 206e 6574 776f 726b 3d6e         network=n
+000101e0: 6574 776f 726b 2c0a 2020 2020 2020 2020  etwork,.        
+000101f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00010200: 2020 6d6f 6465 6c20 3d20 4444 5028 6d6f    model = DDP(mo
+00010210: 6465 6c2c 2066 7364 703d 7365 6c66 2e66  del, fsdp=self.f
+00010220: 756c 6c79 5f73 6861 7264 6564 5f64 6174  ully_sharded_dat
+00010230: 615f 7061 7261 6c6c 656c 2c20 616d 703d  a_parallel, amp=
+00010240: 7365 6c66 2e61 6d70 290a 0a20 2020 2020  self.amp)..     
+00010250: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+00010260: 6e5f 6466 2c20 6d65 7472 6963 7320 3d20  n_df, metrics = 
+00010270: 7365 6c66 2e74 6173 6b5f 6d61 6e61 6765  self.task_manage
+00010280: 722e 7465 7374 280a 2020 2020 2020 2020  r.test(.        
+00010290: 2020 2020 2020 2020 6d6f 6465 6c2c 0a20          model,. 
+000102a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000102b0: 6174 616c 6f61 6465 722c 0a20 2020 2020  ataloader,.     
+000102c0: 2020 2020 2020 2020 2020 2063 7269 7465             crite
+000102d0: 7269 6f6e 2c0a 2020 2020 2020 2020 2020  rion,.          
+000102e0: 2020 2020 2020 7573 655f 6c61 6265 6c73        use_labels
+000102f0: 3d75 7365 5f6c 6162 656c 732c 0a20 2020  =use_labels,.   
+00010300: 2020 2020 2020 2020 2020 2020 2061 6d70               amp
+00010310: 3d61 6d70 2c0a 2020 2020 2020 2020 2020  =amp,.          
+00010320: 2020 2020 2020 7265 706f 7274 5f63 693d        report_ci=
+00010330: 7265 706f 7274 5f63 692c 0a20 2020 2020  report_ci,.     
+00010340: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010350: 2020 2020 2069 6620 7573 655f 6c61 6265       if use_labe
+00010360: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+00010370: 2020 2020 6966 206e 6574 776f 726b 2069      if network i
+00010380: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00010390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103a0: 6d65 7472 6963 735b 6622 7b73 656c 662e  metrics[f"{self.
+000103b0: 6d6f 6465 7d5f 6964 225d 203d 206e 6574  mode}_id"] = net
+000103c0: 776f 726b 0a0a 2020 2020 2020 2020 2020  work..          
+000103d0: 2020 2020 2020 6c6f 7373 5f74 6f5f 6c6f        loss_to_lo
+000103e0: 6720 3d20 280a 2020 2020 2020 2020 2020  g = (.          
+000103f0: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
+00010400: 735b 224d 6574 7269 635f 7661 6c75 6573  s["Metric_values
+00010410: 225d 5b2d 315d 2069 6620 7265 706f 7274  "][-1] if report
+00010420: 5f63 6920 656c 7365 206d 6574 7269 6373  _ci else metrics
+00010430: 5b22 6c6f 7373 225d 0a20 2020 2020 2020  ["loss"].       
+00010440: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00010450: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00010460: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+00010470: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00010480: 7365 6c66 2e6d 6f64 657d 206c 6576 656c  self.mode} level
+00010490: 207b 6461 7461 5f67 726f 7570 7d20 6c6f   {data_group} lo
+000104a0: 7373 2069 7320 7b6c 6f73 735f 746f 5f6c  ss is {loss_to_l
+000104b0: 6f67 7d20 666f 7220 6d6f 6465 6c20 7365  og} for model se
+000104c0: 6c65 6374 6564 206f 6e20 7b73 656c 6563  lected on {selec
+000104d0: 7469 6f6e 5f6d 6574 7269 637d 220a 2020  tion_metric}".  
+000104e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000104f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010500: 636c 7573 7465 722e 6d61 7374 6572 3a0a  cluster.master:.
+00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010520: 2320 5265 706c 6163 6520 6865 7265 0a20  # Replace here. 
+00010530: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010540: 656c 662e 5f6d 6f64 655f 6c65 7665 6c5f  elf._mode_level_
+00010550: 746f 5f74 7376 280a 2020 2020 2020 2020  to_tsv(.        
+00010560: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+00010570: 6963 7469 6f6e 5f64 662c 0a20 2020 2020  iction_df,.     
+00010580: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00010590: 6574 7269 6373 2c0a 2020 2020 2020 2020  etrics,.        
+000105a0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+000105b0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000105c0: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+000105d0: 5f6d 6574 7269 632c 0a20 2020 2020 2020  _metric,.       
+000105e0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000105f0: 615f 6772 6f75 703d 6461 7461 5f67 726f  a_group=data_gro
+00010600: 7570 2c0a 2020 2020 2020 2020 2020 2020  up,.            
+00010610: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+00010620: 7465 7374 5f6c 6f61 6465 725f 7373 6461  test_loader_ssda
+00010630: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00010640: 2020 2020 2020 2020 6461 7461 6c6f 6164          dataload
+00010650: 6572 2c0a 2020 2020 2020 2020 6372 6974  er,.        crit
+00010660: 6572 696f 6e2c 0a20 2020 2020 2020 2061  erion,.        a
+00010670: 6c70 6861 2c0a 2020 2020 2020 2020 6461  lpha,.        da
+00010680: 7461 5f67 726f 7570 2c0a 2020 2020 2020  ta_group,.      
+00010690: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
+000106a0: 2073 656c 6563 7469 6f6e 5f6d 6574 7269   selection_metri
+000106b0: 6373 2c0a 2020 2020 2020 2020 7573 655f  cs,.        use_
+000106c0: 6c61 6265 6c73 3d54 7275 652c 0a20 2020  labels=True,.   
+000106d0: 2020 2020 2067 7075 3d4e 6f6e 652c 0a20       gpu=None,. 
+000106e0: 2020 2020 2020 206e 6574 776f 726b 3d4e         network=N
+000106f0: 6f6e 652c 0a20 2020 2020 2020 2074 6172  one,.        tar
+00010700: 6765 743d 4661 6c73 652c 0a20 2020 2020  get=False,.     
+00010710: 2020 2072 6570 6f72 745f 6369 3d54 7275     report_ci=Tru
+00010720: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00010730: 2020 2222 220a 2020 2020 2020 2020 4c61    """.        La
+00010740: 756e 6368 6573 2074 6865 2074 6573 7469  unches the testi
+00010750: 6e67 2074 6173 6b20 6f6e 2061 2064 6174  ng task on a dat
+00010760: 6173 6574 2077 7261 7070 6564 2062 7920  aset wrapped by 
+00010770: 6120 4461 7461 4c6f 6164 6572 2061 6e64  a DataLoader and
+00010780: 2077 7269 7465 7320 7072 6564 6963 7469   writes predicti
+00010790: 6f6e 2054 5356 2066 696c 6573 2e0a 0a20  on TSV files... 
+000107a0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+000107b0: 2020 2020 2020 2020 2064 6174 616c 6f61           dataloa
+000107c0: 6465 7220 2874 6f72 6368 2e75 7469 6c73  der (torch.utils
+000107d0: 2e64 6174 612e 4461 7461 4c6f 6164 6572  .data.DataLoader
+000107e0: 293a 2044 6174 614c 6f61 6465 7220 7772  ): DataLoader wr
+000107f0: 6170 7069 6e67 2074 6865 2074 6573 7420  apping the test 
+00010800: 4361 7073 4461 7461 7365 742e 0a20 2020  CapsDataset..   
+00010810: 2020 2020 2020 2020 2063 7269 7465 7269           criteri
+00010820: 6f6e 2028 746f 7263 682e 6e6e 2e6d 6f64  on (torch.nn.mod
+00010830: 756c 6573 2e6c 6f73 732e 5f4c 6f73 7329  ules.loss._Loss)
+00010840: 3a20 6f70 7469 6d69 7a61 7469 6f6e 2063  : optimization c
+00010850: 7269 7465 7269 6f6e 2075 7365 6420 6475  riterion used du
+00010860: 7269 6e67 2074 7261 696e 696e 672e 0a20  ring training.. 
+00010870: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00010880: 6772 6f75 7020 2873 7472 293a 206e 616d  group (str): nam
+00010890: 6520 6f66 2074 6865 2064 6174 6120 6772  e of the data gr
+000108a0: 6f75 7020 7573 6564 2066 6f72 2074 6865  oup used for the
+000108b0: 2074 6573 7469 6e67 2074 6173 6b2e 0a20   testing task.. 
+000108c0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+000108d0: 2028 696e 7429 3a20 496e 6465 7820 6f66   (int): Index of
+000108e0: 2074 6865 2073 706c 6974 2075 7365 6420   the split used 
+000108f0: 746f 2074 7261 696e 2074 6865 206d 6f64  to train the mod
+00010900: 656c 2074 6573 7465 642e 0a20 2020 2020  el tested..     
+00010910: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+00010920: 5f6d 6574 7269 6373 2028 6c69 7374 5b73  _metrics (list[s
+00010930: 7472 5d29 3a20 4c69 7374 206f 6620 6d65  tr]): List of me
+00010940: 7472 6963 7320 7573 6564 2074 6f20 7365  trics used to se
+00010950: 6c65 6374 2074 6865 2062 6573 7420 6d6f  lect the best mo
+00010960: 6465 6c73 2077 6869 6368 2061 7265 2074  dels which are t
+00010970: 6573 7465 642e 0a20 2020 2020 2020 2020  ested..         
+00010980: 2020 2075 7365 5f6c 6162 656c 7320 2862     use_labels (b
+00010990: 6f6f 6c29 3a20 4966 2054 7275 652c 2074  ool): If True, t
+000109a0: 6865 206c 6162 656c 7320 6d75 7374 2065  he labels must e
+000109b0: 7869 7374 2069 6e20 7465 7374 206d 6574  xist in test met
+000109c0: 612d 6461 7461 2061 6e64 206d 6574 7269  a-data and metri
+000109d0: 6373 2061 7265 2063 6f6d 7075 7465 642e  cs are computed.
+000109e0: 0a20 2020 2020 2020 2020 2020 2067 7075  .            gpu
+000109f0: 2028 626f 6f6c 293a 2049 6620 6769 7665   (bool): If give
+00010a00: 6e2c 2061 206e 6577 2076 616c 7565 2066  n, a new value f
+00010a10: 6f72 2074 6865 2064 6576 6963 6520 6f66  or the device of
+00010a20: 2074 6865 206d 6f64 656c 2077 696c 6c20   the model will 
+00010a30: 6265 2063 6f6d 7075 7465 642e 0a20 2020  be computed..   
+00010a40: 2020 2020 2020 2020 206e 6574 776f 726b           network
+00010a50: 2028 696e 7429 3a20 496e 6465 7820 6f66   (int): Index of
+00010a60: 2074 6865 206e 6574 776f 726b 2074 6573   the network tes
+00010a70: 7465 6420 286f 6e6c 7920 7573 6564 2069  ted (only used i
+00010a80: 6e20 6d75 6c74 692d 6e65 7477 6f72 6b20  n multi-network 
+00010a90: 7365 7474 696e 6729 2e0a 2020 2020 2020  setting)..      
+00010aa0: 2020 2222 220a 2020 2020 2020 2020 666f    """.        fo
+00010ab0: 7220 7365 6c65 6374 696f 6e5f 6d65 7472  r selection_metr
+00010ac0: 6963 2069 6e20 7365 6c65 6374 696f 6e5f  ic in selection_
+00010ad0: 6d65 7472 6963 733a 0a20 2020 2020 2020  metrics:.       
+00010ae0: 2020 2020 206c 6f67 5f64 6972 203d 2028       log_dir = (
+00010af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010b00: 2073 656c 662e 6d61 7073 5f70 6174 680a   self.maps_path.
+00010b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b20: 2f20 6622 7b73 656c 662e 7370 6c69 745f  / f"{self.split_
+00010b30: 6e61 6d65 7d2d 7b73 706c 6974 7d22 0a20  name}-{split}". 
+00010b40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00010b50: 2066 2262 6573 742d 7b73 656c 6563 7469   f"best-{selecti
+00010b60: 6f6e 5f6d 6574 7269 637d 220a 2020 2020  on_metric}".    
+00010b70: 2020 2020 2020 2020 2020 2020 2f20 6461              / da
+00010b80: 7461 5f67 726f 7570 0a20 2020 2020 2020  ta_group.       
+00010b90: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010ba0: 2020 2073 656c 662e 7772 6974 655f 6465     self.write_de
+00010bb0: 7363 7269 7074 696f 6e5f 6c6f 6728 0a20  scription_log(. 
+00010bc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00010bd0: 6f67 5f64 6972 2c0a 2020 2020 2020 2020  og_dir,.        
+00010be0: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
+00010bf0: 7570 2c0a 2020 2020 2020 2020 2020 2020  up,.            
+00010c00: 2020 2020 6461 7461 6c6f 6164 6572 2e64      dataloader.d
+00010c10: 6174 6173 6574 2e63 6170 735f 6469 6374  ataset.caps_dict
+00010c20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010c30: 2020 6461 7461 6c6f 6164 6572 2e64 6174    dataloader.dat
+00010c40: 6173 6574 2e64 662c 0a20 2020 2020 2020  aset.df,.       
+00010c50: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00010c60: 2020 2020 2320 6c6f 6164 2074 6865 2062      # load the b
+00010c70: 6573 7420 7472 6169 6e65 6420 6d6f 6465  est trained mode
+00010c80: 6c20 6475 7269 6e67 2074 6865 2074 7261  l during the tra
+00010c90: 696e 696e 670a 2020 2020 2020 2020 2020  ining.          
+00010ca0: 2020 6d6f 6465 6c2c 205f 203d 2073 656c    model, _ = sel
+00010cb0: 662e 5f69 6e69 745f 6d6f 6465 6c28 0a20  f._init_model(. 
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00010cd0: 7261 6e73 6665 725f 7061 7468 3d73 656c  ransfer_path=sel
+00010ce0: 662e 6d61 7073 5f70 6174 682c 0a20 2020  f.maps_path,.   
+00010cf0: 2020 2020 2020 2020 2020 2020 2073 706c               spl
+00010d00: 6974 3d73 706c 6974 2c0a 2020 2020 2020  it=split,.      
+00010d10: 2020 2020 2020 2020 2020 7472 616e 7366            transf
+00010d20: 6572 5f73 656c 6563 7469 6f6e 3d73 656c  er_selection=sel
+00010d30: 6563 7469 6f6e 5f6d 6574 7269 632c 0a20  ection_metric,. 
+00010d40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00010d50: 7075 3d67 7075 2c0a 2020 2020 2020 2020  pu=gpu,.        
+00010d60: 2020 2020 2020 2020 6e65 7477 6f72 6b3d          network=
+00010d70: 6e65 7477 6f72 6b2c 0a20 2020 2020 2020  network,.       
+00010d80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010d90: 2020 2070 7265 6469 6374 696f 6e5f 6466     prediction_df
+00010da0: 2c20 6d65 7472 6963 7320 3d20 7365 6c66  , metrics = self
+00010db0: 2e74 6173 6b5f 6d61 6e61 6765 722e 7465  .task_manager.te
+00010dc0: 7374 5f64 6128 0a20 2020 2020 2020 2020  st_da(.         
+00010dd0: 2020 2020 2020 206d 6f64 656c 2c20 6461         model, da
+00010de0: 7461 6c6f 6164 6572 2c20 6372 6974 6572  taloader, criter
+00010df0: 696f 6e2c 2074 6172 6765 743d 7461 7267  ion, target=targ
+00010e00: 6574 2c20 7265 706f 7274 5f63 693d 7265  et, report_ci=re
+00010e10: 706f 7274 5f63 690a 2020 2020 2020 2020  port_ci.        
+00010e20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00010e30: 2020 6966 2075 7365 5f6c 6162 656c 733a    if use_labels:
+00010e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e50: 2069 6620 6e65 7477 6f72 6b20 6973 206e   if network is n
+00010e60: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00010e70: 2020 2020 2020 2020 2020 2020 206d 6574               met
+00010e80: 7269 6373 5b66 227b 7365 6c66 2e6d 6f64  rics[f"{self.mod
+00010e90: 657d 5f69 6422 5d20 3d20 6e65 7477 6f72  e}_id"] = networ
+00010ea0: 6b0a 0a20 2020 2020 2020 2020 2020 2020  k..             
+00010eb0: 2020 2069 6620 7265 706f 7274 5f63 693a     if report_ci:
+00010ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ed0: 2020 2020 206c 6f73 735f 746f 5f6c 6f67       loss_to_log
+00010ee0: 203d 206d 6574 7269 6373 5b22 4d65 7472   = metrics["Metr
+00010ef0: 6963 5f76 616c 7565 7322 5d5b 2d31 5d0a  ic_values"][-1].
+00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00010f20: 2020 2020 2020 2020 2020 6c6f 7373 5f74            loss_t
+00010f30: 6f5f 6c6f 6720 3d20 6d65 7472 6963 735b  o_log = metrics[
+00010f40: 226c 6f73 7322 5d0a 0a20 2020 2020 2020  "loss"]..       
+00010f50: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00010f60: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+00010f70: 2020 2020 2020 2020 2020 6622 7b73 656c            f"{sel
+00010f80: 662e 6d6f 6465 7d20 6c65 7665 6c20 7b64  f.mode} level {d
+00010f90: 6174 615f 6772 6f75 707d 206c 6f73 7320  ata_group} loss 
+00010fa0: 6973 207b 6c6f 7373 5f74 6f5f 6c6f 677d  is {loss_to_log}
+00010fb0: 2066 6f72 206d 6f64 656c 2073 656c 6563   for model selec
+00010fc0: 7465 6420 6f6e 207b 7365 6c65 6374 696f  ted on {selectio
+00010fd0: 6e5f 6d65 7472 6963 7d22 0a20 2020 2020  n_metric}".     
+00010fe0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00010ff0: 2020 2020 2020 2020 2020 2320 5265 706c            # Repl
+00011000: 6163 6520 6865 7265 0a20 2020 2020 2020  ace here.       
+00011010: 2020 2020 2073 656c 662e 5f6d 6f64 655f       self._mode_
+00011020: 6c65 7665 6c5f 746f 5f74 7376 280a 2020  level_to_tsv(.  
+00011030: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00011040: 6564 6963 7469 6f6e 5f64 662c 206d 6574  ediction_df, met
+00011050: 7269 6373 2c20 7370 6c69 742c 2073 656c  rics, split, sel
+00011060: 6563 7469 6f6e 5f6d 6574 7269 632c 2064  ection_metric, d
+00011070: 6174 615f 6772 6f75 703d 6461 7461 5f67  ata_group=data_g
+00011080: 726f 7570 0a20 2020 2020 2020 2020 2020  roup.           
+00011090: 2029 0a0a 2020 2020 4074 6f72 6368 2e6e   )..    @torch.n
+000110a0: 6f5f 6772 6164 2829 0a20 2020 2064 6566  o_grad().    def
+000110b0: 205f 636f 6d70 7574 655f 6f75 7470 7574   _compute_output
+000110c0: 5f6e 6966 7469 280a 2020 2020 2020 2020  _nifti(.        
+000110d0: 7365 6c66 2c0a 2020 2020 2020 2020 6461  self,.        da
+000110e0: 7461 7365 742c 0a20 2020 2020 2020 2064  taset,.        d
+000110f0: 6174 615f 6772 6f75 702c 0a20 2020 2020  ata_group,.     
+00011100: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
+00011110: 2020 7365 6c65 6374 696f 6e5f 6d65 7472    selection_metr
+00011120: 6963 732c 0a20 2020 2020 2020 2067 7075  ics,.        gpu
+00011130: 3d4e 6f6e 652c 0a20 2020 2020 2020 206e  =None,.        n
+00011140: 6574 776f 726b 3d4e 6f6e 652c 0a20 2020  etwork=None,.   
+00011150: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
+00011160: 2020 2020 2020 2020 436f 6d70 7574 6573          Computes
+00011170: 2074 6865 206f 7574 7075 7420 6e69 6674   the output nift
+00011180: 6920 696d 6167 6573 2061 6e64 2073 6176  i images and sav
+00011190: 6573 2074 6865 6d20 696e 2074 6865 204d  es them in the M
+000111a0: 4150 532e 0a0a 2020 2020 2020 2020 4172  APS...        Ar
+000111b0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+000111c0: 6461 7461 7365 7420 2863 6c69 6e69 6361  dataset (clinica
+000111d0: 646c 2e75 7469 6c73 2e63 6170 735f 6461  dl.utils.caps_da
+000111e0: 7461 7365 742e 6461 7461 2e43 6170 7344  taset.data.CapsD
+000111f0: 6174 6173 6574 293a 2077 7261 7070 6572  ataset): wrapper
+00011200: 206f 6620 7468 6520 6461 7461 2073 6574   of the data set
+00011210: 2e0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+00011220: 7461 5f67 726f 7570 2028 7374 7229 3a20  ta_group (str): 
+00011230: 6e61 6d65 206f 6620 7468 6520 6461 7461  name of the data
+00011240: 2067 726f 7570 2075 7365 6420 666f 7220   group used for 
+00011250: 7468 6520 7461 736b 2e0a 2020 2020 2020  the task..      
+00011260: 2020 2020 2020 7370 6c69 7420 2869 6e74        split (int
+00011270: 293a 2073 706c 6974 206e 756d 6265 722e  ): split number.
+00011280: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011290: 6563 7469 6f6e 5f6d 6574 7269 6373 2028  ection_metrics (
+000112a0: 6c69 7374 5b73 7472 5d29 3a20 6d65 7472  list[str]): metr
+000112b0: 6963 7320 7573 6564 2066 6f72 206d 6f64  ics used for mod
+000112c0: 656c 2073 656c 6563 7469 6f6e 2e0a 2020  el selection..  
+000112d0: 2020 2020 2020 2020 2020 6770 7520 2862            gpu (b
+000112e0: 6f6f 6c29 3a20 4966 2067 6976 656e 2c20  ool): If given, 
+000112f0: 6120 6e65 7720 7661 6c75 6520 666f 7220  a new value for 
+00011300: 7468 6520 6465 7669 6365 206f 6620 7468  the device of th
+00011310: 6520 6d6f 6465 6c20 7769 6c6c 2062 6520  e model will be 
+00011320: 636f 6d70 7574 6564 2e0a 2020 2020 2020  computed..      
+00011330: 2020 2020 2020 6e65 7477 6f72 6b20 2869        network (i
+00011340: 6e74 293a 2049 6e64 6578 206f 6620 7468  nt): Index of th
+00011350: 6520 6e65 7477 6f72 6b20 7465 7374 6564  e network tested
+00011360: 2028 6f6e 6c79 2075 7365 6420 696e 206d   (only used in m
+00011370: 756c 7469 2d6e 6574 776f 726b 2073 6574  ulti-network set
+00011380: 7469 6e67 292e 0a20 2020 2020 2020 2023  ting)..        #
+00011390: 2052 6169 7365 2061 6e20 6572 726f 7220   Raise an error 
+000113a0: 6966 206d 6f64 6520 6973 206e 6f74 2069  if mode is not i
+000113b0: 6d61 6765 0a20 2020 2020 2020 2022 2222  mage.        """
+000113c0: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+000113d0: 6e69 6261 6265 6c20 6173 206e 6962 0a20  nibabel as nib. 
+000113e0: 2020 2020 2020 2066 726f 6d20 6e75 6d70         from nump
+000113f0: 7920 696d 706f 7274 2065 7965 0a0a 2020  y import eye..  
+00011400: 2020 2020 2020 666f 7220 7365 6c65 6374        for select
+00011410: 696f 6e5f 6d65 7472 6963 2069 6e20 7365  ion_metric in se
+00011420: 6c65 6374 696f 6e5f 6d65 7472 6963 733a  lection_metrics:
+00011430: 0a20 2020 2020 2020 2020 2020 2023 206c  .            # l
+00011440: 6f61 6420 7468 6520 6265 7374 2074 7261  oad the best tra
+00011450: 696e 6564 206d 6f64 656c 2064 7572 696e  ined model durin
+00011460: 6720 7468 6520 7472 6169 6e69 6e67 0a20  g the training. 
+00011470: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00011480: 2c20 5f20 3d20 7365 6c66 2e5f 696e 6974  , _ = self._init
+00011490: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
+000114a0: 2020 2020 2020 2020 7472 616e 7366 6572          transfer
+000114b0: 5f70 6174 683d 7365 6c66 2e6d 6170 735f  _path=self.maps_
+000114c0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+000114d0: 2020 2020 2020 7370 6c69 743d 7370 6c69        split=spli
+000114e0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000114f0: 2020 2074 7261 6e73 6665 725f 7365 6c65     transfer_sele
+00011500: 6374 696f 6e3d 7365 6c65 6374 696f 6e5f  ction=selection_
+00011510: 6d65 7472 6963 2c0a 2020 2020 2020 2020  metric,.        
+00011520: 2020 2020 2020 2020 6770 753d 6770 752c          gpu=gpu,
+00011530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011540: 206e 6574 776f 726b 3d6e 6574 776f 726b   network=network
+00011550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011560: 2020 6e62 5f75 6e66 726f 7a65 6e5f 6c61    nb_unfrozen_la
+00011570: 7965 723d 7365 6c66 2e6e 625f 756e 6672  yer=self.nb_unfr
+00011580: 6f7a 656e 5f6c 6179 6572 2c0a 2020 2020  ozen_layer,.    
+00011590: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000115a0: 2020 2020 2020 6d6f 6465 6c20 3d20 4444        model = DD
+000115b0: 5028 6d6f 6465 6c2c 2066 7364 703d 7365  P(model, fsdp=se
+000115c0: 6c66 2e66 756c 6c79 5f73 6861 7264 6564  lf.fully_sharded
+000115d0: 5f64 6174 615f 7061 7261 6c6c 656c 2c20  _data_parallel, 
+000115e0: 616d 703d 7365 6c66 2e61 6d70 290a 2020  amp=self.amp).  
+000115f0: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
+00011600: 6576 616c 2829 0a0a 2020 2020 2020 2020  eval()..        
+00011610: 2020 2020 6e69 6674 695f 7061 7468 203d      nifti_path =
+00011620: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00011630: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
+00011640: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+00011650: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
+00011660: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
+00011670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011680: 202f 2066 2262 6573 742d 7b73 656c 6563   / f"best-{selec
+00011690: 7469 6f6e 5f6d 6574 7269 637d 220a 2020  tion_metric}".  
+000116a0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+000116b0: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
+000116c0: 2020 2020 2020 2020 2020 202f 2022 6e69             / "ni
+000116d0: 6674 695f 696d 6167 6573 220a 2020 2020  fti_images".    
+000116e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000116f0: 2020 2020 2020 6966 2063 6c75 7374 6572        if cluster
+00011700: 2e6d 6173 7465 723a 0a20 2020 2020 2020  .master:.       
+00011710: 2020 2020 2020 2020 206e 6966 7469 5f70           nifti_p
+00011720: 6174 682e 6d6b 6469 7228 7061 7265 6e74  ath.mkdir(parent
+00011730: 733d 5472 7565 2c20 6578 6973 745f 6f6b  s=True, exist_ok
+00011740: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+00011750: 2020 2064 6973 742e 6261 7272 6965 7228     dist.barrier(
+00011760: 290a 0a20 2020 2020 2020 2020 2020 206e  )..            n
+00011770: 625f 696d 6773 203d 206c 656e 2864 6174  b_imgs = len(dat
+00011780: 6173 6574 290a 2020 2020 2020 2020 2020  aset).          
+00011790: 2020 666f 7220 6920 696e 205b 0a20 2020    for i in [.   
+000117a0: 2020 2020 2020 2020 2020 2020 202a 7261               *ra
+000117b0: 6e67 6528 636c 7573 7465 722e 7261 6e6b  nge(cluster.rank
+000117c0: 2c20 6e62 5f69 6d67 732c 2063 6c75 7374  , nb_imgs, clust
+000117d0: 6572 2e77 6f72 6c64 5f73 697a 6529 2c0a  er.world_size),.
+000117e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117f0: 2a72 616e 6765 2869 6e74 286e 625f 696d  *range(int(nb_im
+00011800: 6773 2025 2063 6c75 7374 6572 2e77 6f72  gs % cluster.wor
+00011810: 6c64 5f73 697a 6520 3c3d 2063 6c75 7374  ld_size <= clust
+00011820: 6572 2e72 616e 6b29 292c 0a20 2020 2020  er.rank)),.     
+00011830: 2020 2020 2020 205d 3a0a 2020 2020 2020         ]:.      
+00011840: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00011850: 2064 6174 6173 6574 5b69 5d0a 2020 2020   dataset[i].    
+00011860: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00011870: 6520 3d20 6461 7461 5b22 696d 6167 6522  e = data["image"
+00011880: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00011890: 2020 7820 3d20 696d 6167 652e 756e 7371    x = image.unsq
+000118a0: 7565 657a 6528 3029 2e74 6f28 6d6f 6465  ueeze(0).to(mode
+000118b0: 6c2e 6465 7669 6365 290a 2020 2020 2020  l.device).      
+000118c0: 2020 2020 2020 2020 2020 7769 7468 2061            with a
+000118d0: 7574 6f63 6173 7428 656e 6162 6c65 643d  utocast(enabled=
+000118e0: 7365 6c66 2e73 7464 5f61 6d70 293a 0a20  self.std_amp):. 
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011900: 2020 206f 7574 7075 7420 3d20 6d6f 6465     output = mode
+00011910: 6c28 7829 0a20 2020 2020 2020 2020 2020  l(x).           
+00011920: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
+00011930: 7470 7574 2e73 7175 6565 7a65 2830 292e  tput.squeeze(0).
+00011940: 6465 7461 6368 2829 2e63 7075 2829 2e66  detach().cpu().f
+00011950: 6c6f 6174 2829 0a20 2020 2020 2020 2020  loat().         
+00011960: 2020 2020 2020 2023 2043 6f6e 7665 7274         # Convert
+00011970: 2074 656e 736f 7220 746f 206e 6966 7469   tensor to nifti
+00011980: 2069 6d61 6765 2077 6974 6820 6170 7072   image with appr
+00011990: 6f70 7269 6174 6520 6166 6669 6e65 0a20  opriate affine. 
+000119a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000119b0: 6e70 7574 5f6e 6969 203d 206e 6962 2e4e  nput_nii = nib.N
+000119c0: 6966 7469 3149 6d61 6765 2869 6d61 6765  ifti1Image(image
+000119d0: 5b30 5d2e 6465 7461 6368 2829 2e63 7075  [0].detach().cpu
+000119e0: 2829 2e6e 756d 7079 2829 2c20 6579 6528  ().numpy(), eye(
+000119f0: 3429 290a 2020 2020 2020 2020 2020 2020  4)).            
+00011a00: 2020 2020 6f75 7470 7574 5f6e 6969 203d      output_nii =
+00011a10: 206e 6962 2e4e 6966 7469 3149 6d61 6765   nib.Nifti1Image
+00011a20: 286f 7574 7075 745b 305d 2e6e 756d 7079  (output[0].numpy
+00011a30: 2829 2c20 6579 6528 3429 290a 2020 2020  (), eye(4)).    
+00011a40: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+00011a50: 6561 7465 2066 696c 6520 6e61 6d65 2061  eate file name a
+00011a60: 6363 6f72 6469 6e67 2074 6f20 7061 7274  ccording to part
+00011a70: 6963 6970 616e 7420 616e 6420 7365 7373  icipant and sess
+00011a80: 696f 6e20 6964 0a20 2020 2020 2020 2020  ion id.         
+00011a90: 2020 2020 2020 2070 6172 7469 6369 7061         participa
+00011aa0: 6e74 5f69 6420 3d20 6461 7461 5b22 7061  nt_id = data["pa
+00011ab0: 7274 6963 6970 616e 745f 6964 225d 0a20  rticipant_id"]. 
+00011ac0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00011ad0: 6573 7369 6f6e 5f69 6420 3d20 6461 7461  ession_id = data
+00011ae0: 5b22 7365 7373 696f 6e5f 6964 225d 0a20  ["session_id"]. 
+00011af0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00011b00: 6e70 7574 5f66 696c 656e 616d 6520 3d20  nput_filename = 
+00011b10: 6622 7b70 6172 7469 6369 7061 6e74 5f69  f"{participant_i
+00011b20: 647d 5f7b 7365 7373 696f 6e5f 6964 7d5f  d}_{session_id}_
+00011b30: 696d 6167 655f 696e 7075 742e 6e69 692e  image_input.nii.
+00011b40: 677a 220a 2020 2020 2020 2020 2020 2020  gz".            
+00011b50: 2020 2020 6f75 7470 7574 5f66 696c 656e      output_filen
+00011b60: 616d 6520 3d20 6622 7b70 6172 7469 6369  ame = f"{partici
+00011b70: 7061 6e74 5f69 647d 5f7b 7365 7373 696f  pant_id}_{sessio
+00011b80: 6e5f 6964 7d5f 696d 6167 655f 6f75 7470  n_id}_image_outp
+00011b90: 7574 2e6e 6969 2e67 7a22 0a20 2020 2020  ut.nii.gz".     
+00011ba0: 2020 2020 2020 2020 2020 206e 6962 2e73             nib.s
+00011bb0: 6176 6528 696e 7075 745f 6e69 692c 206e  ave(input_nii, n
+00011bc0: 6966 7469 5f70 6174 6820 2f20 696e 7075  ifti_path / inpu
+00011bd0: 745f 6669 6c65 6e61 6d65 290a 2020 2020  t_filename).    
+00011be0: 2020 2020 2020 2020 2020 2020 6e69 622e              nib.
+00011bf0: 7361 7665 286f 7574 7075 745f 6e69 692c  save(output_nii,
+00011c00: 206e 6966 7469 5f70 6174 6820 2f20 6f75   nifti_path / ou
+00011c10: 7470 7574 5f66 696c 656e 616d 6529 0a0a  tput_filename)..
+00011c20: 2020 2020 4074 6f72 6368 2e6e 6f5f 6772      @torch.no_gr
+00011c30: 6164 2829 0a20 2020 2064 6566 205f 636f  ad().    def _co
+00011c40: 6d70 7574 655f 6f75 7470 7574 5f74 656e  mpute_output_ten
+00011c50: 736f 7273 280a 2020 2020 2020 2020 7365  sors(.        se
+00011c60: 6c66 2c0a 2020 2020 2020 2020 6461 7461  lf,.        data
+00011c70: 7365 742c 0a20 2020 2020 2020 2064 6174  set,.        dat
+00011c80: 615f 6772 6f75 702c 0a20 2020 2020 2020  a_group,.       
+00011c90: 2073 706c 6974 2c0a 2020 2020 2020 2020   split,.        
+00011ca0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
+00011cb0: 732c 0a20 2020 2020 2020 206e 625f 696d  s,.        nb_im
+00011cc0: 6167 6573 3d4e 6f6e 652c 0a20 2020 2020  ages=None,.     
+00011cd0: 2020 2067 7075 3d4e 6f6e 652c 0a20 2020     gpu=None,.   
+00011ce0: 2020 2020 206e 6574 776f 726b 3d4e 6f6e       network=Non
+00011cf0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00011d00: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
+00011d10: 6d70 7574 6520 7468 6520 6f75 7470 7574  mpute the output
+00011d20: 2074 656e 736f 7273 2061 6e64 2073 6176   tensors and sav
+00011d30: 6573 2074 6865 6d20 696e 2074 6865 204d  es them in the M
+00011d40: 4150 532e 0a0a 2020 2020 2020 2020 4172  APS...        Ar
+00011d50: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00011d60: 6461 7461 7365 7420 2863 6c69 6e69 6361  dataset (clinica
+00011d70: 646c 2e75 7469 6c73 2e63 6170 735f 6461  dl.utils.caps_da
+00011d80: 7461 7365 742e 6461 7461 2e43 6170 7344  taset.data.CapsD
+00011d90: 6174 6173 6574 293a 2077 7261 7070 6572  ataset): wrapper
+00011da0: 206f 6620 7468 6520 6461 7461 2073 6574   of the data set
+00011db0: 2e0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+00011dc0: 7461 5f67 726f 7570 2028 7374 7229 3a20  ta_group (str): 
+00011dd0: 6e61 6d65 206f 6620 7468 6520 6461 7461  name of the data
+00011de0: 2067 726f 7570 2075 7365 6420 666f 7220   group used for 
+00011df0: 7468 6520 7461 736b 2e0a 2020 2020 2020  the task..      
+00011e00: 2020 2020 2020 7370 6c69 7420 2869 6e74        split (int
+00011e10: 293a 2073 706c 6974 206e 756d 6265 722e  ): split number.
+00011e20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011e30: 6563 7469 6f6e 5f6d 6574 7269 6373 2028  ection_metrics (
+00011e40: 6c69 7374 5b73 7472 5d29 3a20 6d65 7472  list[str]): metr
+00011e50: 6963 7320 7573 6564 2066 6f72 206d 6f64  ics used for mod
+00011e60: 656c 2073 656c 6563 7469 6f6e 2e0a 2020  el selection..  
+00011e70: 2020 2020 2020 2020 2020 6e62 5f69 6d61            nb_ima
+00011e80: 6765 7320 2869 6e74 293a 206e 756d 6265  ges (int): numbe
+00011e90: 7220 6f66 2066 756c 6c20 696d 6167 6573  r of full images
+00011ea0: 2074 6f20 7772 6974 652e 2044 6566 6175   to write. Defau
+00011eb0: 6c74 2063 6f6d 7075 7465 7320 7468 6520  lt computes the 
+00011ec0: 6f75 7470 7574 7320 6f66 2074 6865 2077  outputs of the w
+00011ed0: 686f 6c65 2064 6174 6120 7365 742e 0a20  hole data set.. 
+00011ee0: 2020 2020 2020 2020 2020 2067 7075 2028             gpu (
+00011ef0: 626f 6f6c 293a 2049 6620 6769 7665 6e2c  bool): If given,
+00011f00: 2061 206e 6577 2076 616c 7565 2066 6f72   a new value for
+00011f10: 2074 6865 2064 6576 6963 6520 6f66 2074   the device of t
+00011f20: 6865 206d 6f64 656c 2077 696c 6c20 6265  he model will be
+00011f30: 2063 6f6d 7075 7465 642e 0a20 2020 2020   computed..     
+00011f40: 2020 2020 2020 206e 6574 776f 726b 2028         network (
+00011f50: 696e 7429 3a20 496e 6465 7820 6f66 2074  int): Index of t
+00011f60: 6865 206e 6574 776f 726b 2074 6573 7465  he network teste
+00011f70: 6420 286f 6e6c 7920 7573 6564 2069 6e20  d (only used in 
+00011f80: 6d75 6c74 692d 6e65 7477 6f72 6b20 7365  multi-network se
+00011f90: 7474 696e 6729 2e0a 2020 2020 2020 2020  tting)..        
+00011fa0: 2222 220a 2020 2020 2020 2020 666f 7220  """.        for 
+00011fb0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
+00011fc0: 2069 6e20 7365 6c65 6374 696f 6e5f 6d65   in selection_me
+00011fd0: 7472 6963 733a 0a20 2020 2020 2020 2020  trics:.         
+00011fe0: 2020 2023 206c 6f61 6420 7468 6520 6265     # load the be
+00011ff0: 7374 2074 7261 696e 6564 206d 6f64 656c  st trained model
+00012000: 2064 7572 696e 6720 7468 6520 7472 6169   during the trai
+00012010: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+00012020: 206d 6f64 656c 2c20 5f20 3d20 7365 6c66   model, _ = self
+00012030: 2e5f 696e 6974 5f6d 6f64 656c 280a 2020  ._init_model(.  
+00012040: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00012050: 616e 7366 6572 5f70 6174 683d 7365 6c66  ansfer_path=self
+00012060: 2e6d 6170 735f 7061 7468 2c0a 2020 2020  .maps_path,.    
+00012070: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+00012080: 743d 7370 6c69 742c 0a20 2020 2020 2020  t=split,.       
+00012090: 2020 2020 2020 2020 2074 7261 6e73 6665           transfe
+000120a0: 725f 7365 6c65 6374 696f 6e3d 7365 6c65  r_selection=sele
+000120b0: 6374 696f 6e5f 6d65 7472 6963 2c0a 2020  ction_metric,.  
+000120c0: 2020 2020 2020 2020 2020 2020 2020 6770                gp
+000120d0: 753d 6770 752c 0a20 2020 2020 2020 2020  u=gpu,.         
+000120e0: 2020 2020 2020 206e 6574 776f 726b 3d6e         network=n
+000120f0: 6574 776f 726b 2c0a 2020 2020 2020 2020  etwork,.        
+00012100: 2020 2020 2020 2020 6e62 5f75 6e66 726f          nb_unfro
+00012110: 7a65 6e5f 6c61 7965 723d 7365 6c66 2e6e  zen_layer=self.n
+00012120: 625f 756e 6672 6f7a 656e 5f6c 6179 6572  b_unfrozen_layer
+00012130: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00012140: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00012150: 6c20 3d20 4444 5028 6d6f 6465 6c2c 2066  l = DDP(model, f
+00012160: 7364 703d 7365 6c66 2e66 756c 6c79 5f73  sdp=self.fully_s
+00012170: 6861 7264 6564 5f64 6174 615f 7061 7261  harded_data_para
+00012180: 6c6c 656c 2c20 616d 703d 7365 6c66 2e61  llel, amp=self.a
+00012190: 6d70 290a 2020 2020 2020 2020 2020 2020  mp).            
+000121a0: 6d6f 6465 6c2e 6576 616c 2829 0a0a 2020  model.eval()..  
+000121b0: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+000121c0: 5f70 6174 6820 3d20 280a 2020 2020 2020  _path = (.      
+000121d0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+000121e0: 6170 735f 7061 7468 0a20 2020 2020 2020  aps_path.       
+000121f0: 2020 2020 2020 2020 202f 2066 227b 7365           / f"{se
+00012200: 6c66 2e73 706c 6974 5f6e 616d 657d 2d7b  lf.split_name}-{
+00012210: 7370 6c69 747d 220a 2020 2020 2020 2020  split}".        
+00012220: 2020 2020 2020 2020 2f20 6622 6265 7374          / f"best
+00012230: 2d7b 7365 6c65 6374 696f 6e5f 6d65 7472  -{selection_metr
+00012240: 6963 7d22 0a20 2020 2020 2020 2020 2020  ic}".           
+00012250: 2020 2020 202f 2064 6174 615f 6772 6f75       / data_grou
+00012260: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00012270: 2020 2f20 2274 656e 736f 7273 220a 2020    / "tensors".  
+00012280: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00012290: 2020 2020 2020 2020 6966 2063 6c75 7374          if clust
+000122a0: 6572 2e6d 6173 7465 723a 0a20 2020 2020  er.master:.     
+000122b0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+000122c0: 725f 7061 7468 2e6d 6b64 6972 2870 6172  r_path.mkdir(par
+000122d0: 656e 7473 3d54 7275 652c 2065 7869 7374  ents=True, exist
+000122e0: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
+000122f0: 2020 2020 2020 6469 7374 2e62 6172 7269        dist.barri
+00012300: 6572 2829 0a0a 2020 2020 2020 2020 2020  er()..          
+00012310: 2020 6966 206e 625f 696d 6167 6573 2069    if nb_images i
+00012320: 7320 4e6f 6e65 3a20 2023 2043 6f6d 7075  s None:  # Compu
+00012330: 7465 206f 7574 7075 7473 2066 6f72 2074  te outputs for t
+00012340: 6865 2077 686f 6c65 2064 6174 6120 7365  he whole data se
+00012350: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00012360: 2020 6e62 5f6d 6f64 6573 203d 206c 656e    nb_modes = len
+00012370: 2864 6174 6173 6574 290a 2020 2020 2020  (dataset).      
+00012380: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012390: 2020 2020 2020 2020 2020 2020 6e62 5f6d              nb_m
+000123a0: 6f64 6573 203d 206e 625f 696d 6167 6573  odes = nb_images
+000123b0: 202a 2064 6174 6173 6574 2e65 6c65 6d5f   * dataset.elem_
+000123c0: 7065 725f 696d 6167 650a 0a20 2020 2020  per_image..     
+000123d0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+000123e0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000123f0: 2020 2a72 616e 6765 2863 6c75 7374 6572    *range(cluster
+00012400: 2e72 616e 6b2c 206e 625f 6d6f 6465 732c  .rank, nb_modes,
+00012410: 2063 6c75 7374 6572 2e77 6f72 6c64 5f73   cluster.world_s
+00012420: 697a 6529 2c0a 2020 2020 2020 2020 2020  ize),.          
+00012430: 2020 2020 2020 2a72 616e 6765 2869 6e74        *range(int
+00012440: 286e 625f 6d6f 6465 7320 2520 636c 7573  (nb_modes % clus
+00012450: 7465 722e 776f 726c 645f 7369 7a65 203c  ter.world_size <
+00012460: 3d20 636c 7573 7465 722e 7261 6e6b 2929  = cluster.rank))
+00012470: 2c0a 2020 2020 2020 2020 2020 2020 5d3a  ,.            ]:
+00012480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012490: 2064 6174 6120 3d20 6461 7461 7365 745b   data = dataset[
+000124a0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+000124b0: 2020 2069 6d61 6765 203d 2064 6174 615b     image = data[
+000124c0: 2269 6d61 6765 225d 0a20 2020 2020 2020  "image"].       
+000124d0: 2020 2020 2020 2020 2078 203d 2069 6d61           x = ima
+000124e0: 6765 2e75 6e73 7175 6565 7a65 2830 292e  ge.unsqueeze(0).
+000124f0: 746f 286d 6f64 656c 2e64 6576 6963 6529  to(model.device)
+00012500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012510: 2077 6974 6820 6175 746f 6361 7374 2865   with autocast(e
+00012520: 6e61 626c 6564 3d73 656c 662e 7374 645f  nabled=self.std_
+00012530: 616d 7029 3a0a 2020 2020 2020 2020 2020  amp):.          
+00012540: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00012550: 203d 206d 6f64 656c 2878 290a 2020 2020   = model(x).    
+00012560: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00012570: 7574 203d 206f 7574 7075 742e 7371 7565  ut = output.sque
+00012580: 657a 6528 3029 2e63 7075 2829 2e66 6c6f  eze(0).cpu().flo
+00012590: 6174 2829 0a20 2020 2020 2020 2020 2020  at().           
+000125a0: 2020 2020 2070 6172 7469 6369 7061 6e74       participant
+000125b0: 5f69 6420 3d20 6461 7461 5b22 7061 7274  _id = data["part
+000125c0: 6963 6970 616e 745f 6964 225d 0a20 2020  icipant_id"].   
+000125d0: 2020 2020 2020 2020 2020 2020 2073 6573               ses
+000125e0: 7369 6f6e 5f69 6420 3d20 6461 7461 5b22  sion_id = data["
+000125f0: 7365 7373 696f 6e5f 6964 225d 0a20 2020  session_id"].   
+00012600: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00012610: 655f 6964 203d 2064 6174 615b 6622 7b73  e_id = data[f"{s
+00012620: 656c 662e 6d6f 6465 7d5f 6964 225d 0a20  elf.mode}_id"]. 
+00012630: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012640: 6e70 7574 5f66 696c 656e 616d 6520 3d20  nput_filename = 
+00012650: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012660: 2020 2020 2020 6622 7b70 6172 7469 6369        f"{partici
+00012670: 7061 6e74 5f69 647d 5f7b 7365 7373 696f  pant_id}_{sessio
+00012680: 6e5f 6964 7d5f 7b73 656c 662e 6d6f 6465  n_id}_{self.mode
+00012690: 7d2d 7b6d 6f64 655f 6964 7d5f 696e 7075  }-{mode_id}_inpu
+000126a0: 742e 7074 220a 2020 2020 2020 2020 2020  t.pt".          
+000126b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000126c0: 2020 2020 2020 2020 6f75 7470 7574 5f66          output_f
+000126d0: 696c 656e 616d 6520 3d20 280a 2020 2020  ilename = (.    
+000126e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126f0: 6622 7b70 6172 7469 6369 7061 6e74 5f69  f"{participant_i
+00012700: 647d 5f7b 7365 7373 696f 6e5f 6964 7d5f  d}_{session_id}_
+00012710: 7b73 656c 662e 6d6f 6465 7d2d 7b6d 6f64  {self.mode}-{mod
+00012720: 655f 6964 7d5f 6f75 7470 7574 2e70 7422  e_id}_output.pt"
+00012730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012740: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00012750: 2020 2074 6f72 6368 2e73 6176 6528 696d     torch.save(im
+00012760: 6167 652c 2074 656e 736f 725f 7061 7468  age, tensor_path
+00012770: 202f 2069 6e70 7574 5f66 696c 656e 616d   / input_filenam
+00012780: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00012790: 2020 2074 6f72 6368 2e73 6176 6528 6f75     torch.save(ou
+000127a0: 7470 7574 2c20 7465 6e73 6f72 5f70 6174  tput, tensor_pat
+000127b0: 6820 2f20 6f75 7470 7574 5f66 696c 656e  h / output_filen
+000127c0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+000127d0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+000127e0: 6728 6622 4669 6c65 2073 6176 6564 2061  g(f"File saved a
+000127f0: 7420 7b5b 696e 7075 745f 6669 6c65 6e61  t {[input_filena
+00012800: 6d65 2c20 6f75 7470 7574 5f66 696c 656e  me, output_filen
+00012810: 616d 655d 7d22 290a 0a20 2020 2064 6566  ame]}")..    def
+00012820: 205f 636f 6d70 7574 655f 6c61 7465 6e74   _compute_latent
+00012830: 5f74 656e 736f 7273 280a 2020 2020 2020  _tensors(.      
+00012840: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00012850: 6461 7461 7365 742c 0a20 2020 2020 2020  dataset,.       
+00012860: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
+00012870: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
+00012880: 2020 2020 7365 6c65 6374 696f 6e5f 6d65      selection_me
+00012890: 7472 6963 732c 0a20 2020 2020 2020 206e  trics,.        n
+000128a0: 625f 696d 6167 6573 3d4e 6f6e 652c 0a20  b_images=None,. 
+000128b0: 2020 2020 2020 2067 7075 3d4e 6f6e 652c         gpu=None,
+000128c0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
+000128d0: 3d4e 6f6e 652c 0a20 2020 2029 3a0a 2020  =None,.    ):.  
+000128e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000128f0: 2020 436f 6d70 7574 6520 7468 6520 6f75    Compute the ou
+00012900: 7470 7574 2074 656e 736f 7273 2061 6e64  tput tensors and
+00012910: 2073 6176 6573 2074 6865 6d20 696e 2074   saves them in t
+00012920: 6865 204d 4150 532e 0a0a 2020 2020 2020  he MAPS...      
+00012930: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00012940: 2020 2020 6461 7461 7365 7420 2863 6c69      dataset (cli
+00012950: 6e69 6361 646c 2e75 7469 6c73 2e63 6170  nicadl.utils.cap
+00012960: 735f 6461 7461 7365 742e 6461 7461 2e43  s_dataset.data.C
+00012970: 6170 7344 6174 6173 6574 293a 2077 7261  apsDataset): wra
+00012980: 7070 6572 206f 6620 7468 6520 6461 7461  pper of the data
+00012990: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
+000129a0: 2020 6461 7461 5f67 726f 7570 2028 7374    data_group (st
+000129b0: 7229 3a20 6e61 6d65 206f 6620 7468 6520  r): name of the 
+000129c0: 6461 7461 2067 726f 7570 2075 7365 6420  data group used 
+000129d0: 666f 7220 7468 6520 7461 736b 2e0a 2020  for the task..  
+000129e0: 2020 2020 2020 2020 2020 7370 6c69 7420            split 
+000129f0: 2869 6e74 293a 2073 706c 6974 206e 756d  (int): split num
+00012a00: 6265 722e 0a20 2020 2020 2020 2020 2020  ber..           
+00012a10: 2073 656c 6563 7469 6f6e 5f6d 6574 7269   selection_metri
+00012a20: 6373 2028 6c69 7374 5b73 7472 5d29 3a20  cs (list[str]): 
+00012a30: 6d65 7472 6963 7320 7573 6564 2066 6f72  metrics used for
+00012a40: 206d 6f64 656c 2073 656c 6563 7469 6f6e   model selection
+00012a50: 2e0a 2020 2020 2020 2020 2020 2020 6e62  ..            nb
+00012a60: 5f69 6d61 6765 7320 2869 6e74 293a 206e  _images (int): n
+00012a70: 756d 6265 7220 6f66 2066 756c 6c20 696d  umber of full im
+00012a80: 6167 6573 2074 6f20 7772 6974 652e 2044  ages to write. D
+00012a90: 6566 6175 6c74 2063 6f6d 7075 7465 7320  efault computes 
+00012aa0: 7468 6520 6f75 7470 7574 7320 6f66 2074  the outputs of t
+00012ab0: 6865 2077 686f 6c65 2064 6174 6120 7365  he whole data se
+00012ac0: 742e 0a20 2020 2020 2020 2020 2020 2067  t..            g
+00012ad0: 7075 2028 626f 6f6c 293a 2049 6620 6769  pu (bool): If gi
+00012ae0: 7665 6e2c 2061 206e 6577 2076 616c 7565  ven, a new value
+00012af0: 2066 6f72 2074 6865 2064 6576 6963 6520   for the device 
+00012b00: 6f66 2074 6865 206d 6f64 656c 2077 696c  of the model wil
+00012b10: 6c20 6265 2063 6f6d 7075 7465 642e 0a20  l be computed.. 
+00012b20: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
+00012b30: 726b 2028 696e 7429 3a20 496e 6465 7820  rk (int): Index 
+00012b40: 6f66 2074 6865 206e 6574 776f 726b 2074  of the network t
+00012b50: 6573 7465 6420 286f 6e6c 7920 7573 6564  ested (only used
+00012b60: 2069 6e20 6d75 6c74 692d 6e65 7477 6f72   in multi-networ
+00012b70: 6b20 7365 7474 696e 6729 2e0a 2020 2020  k setting)..    
+00012b80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00012b90: 666f 7220 7365 6c65 6374 696f 6e5f 6d65  for selection_me
+00012ba0: 7472 6963 2069 6e20 7365 6c65 6374 696f  tric in selectio
+00012bb0: 6e5f 6d65 7472 6963 733a 0a20 2020 2020  n_metrics:.     
+00012bc0: 2020 2020 2020 2023 206c 6f61 6420 7468         # load th
+00012bd0: 6520 6265 7374 2074 7261 696e 6564 206d  e best trained m
+00012be0: 6f64 656c 2064 7572 696e 6720 7468 6520  odel during the 
+00012bf0: 7472 6169 6e69 6e67 0a20 2020 2020 2020  training.       
+00012c00: 2020 2020 206d 6f64 656c 2c20 5f20 3d20       model, _ = 
+00012c10: 7365 6c66 2e5f 696e 6974 5f6d 6f64 656c  self._init_model
+00012c20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012c30: 2020 7472 616e 7366 6572 5f70 6174 683d    transfer_path=
+00012c40: 7365 6c66 2e6d 6170 735f 7061 7468 2c0a  self.maps_path,.
+00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c60: 7370 6c69 743d 7370 6c69 742c 0a20 2020  split=split,.   
+00012c70: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+00012c80: 6e73 6665 725f 7365 6c65 6374 696f 6e3d  nsfer_selection=
+00012c90: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
+00012ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012cb0: 2020 6770 753d 6770 752c 0a20 2020 2020    gpu=gpu,.     
+00012cc0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
+00012cd0: 726b 3d6e 6574 776f 726b 2c0a 2020 2020  rk=network,.    
+00012ce0: 2020 2020 2020 2020 2020 2020 6e62 5f75              nb_u
+00012cf0: 6e66 726f 7a65 6e5f 6c61 7965 723d 7365  nfrozen_layer=se
+00012d00: 6c66 2e6e 625f 756e 6672 6f7a 656e 5f6c  lf.nb_unfrozen_l
+00012d10: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
+00012d20: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00012d30: 6d6f 6465 6c20 3d20 4444 5028 6d6f 6465  model = DDP(mode
+00012d40: 6c2c 2066 7364 703d 7365 6c66 2e66 756c  l, fsdp=self.ful
+00012d50: 6c79 5f73 6861 7264 6564 5f64 6174 615f  ly_sharded_data_
+00012d60: 7061 7261 6c6c 656c 2c20 616d 703d 7365  parallel, amp=se
+00012d70: 6c66 2e61 6d70 290a 2020 2020 2020 2020  lf.amp).        
+00012d80: 2020 2020 6d6f 6465 6c2e 6576 616c 2829      model.eval()
+00012d90: 0a0a 2020 2020 2020 2020 2020 2020 7465  ..            te
+00012da0: 6e73 6f72 5f70 6174 6820 3d20 280a 2020  nsor_path = (.  
+00012db0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00012dc0: 6c66 2e6d 6170 735f 7061 7468 0a20 2020  lf.maps_path.   
+00012dd0: 2020 2020 2020 2020 2020 2020 202f 2066               / f
+00012de0: 227b 7365 6c66 2e73 706c 6974 5f6e 616d  "{self.split_nam
+00012df0: 657d 2d7b 7370 6c69 747d 220a 2020 2020  e}-{split}".    
+00012e00: 2020 2020 2020 2020 2020 2020 2f20 6622              / f"
+00012e10: 6265 7374 2d7b 7365 6c65 6374 696f 6e5f  best-{selection_
+00012e20: 6d65 7472 6963 7d22 0a20 2020 2020 2020  metric}".       
+00012e30: 2020 2020 2020 2020 202f 2064 6174 615f           / data_
+00012e40: 6772 6f75 700a 2020 2020 2020 2020 2020  group.          
+00012e50: 2020 2020 2020 2f20 226c 6174 656e 745f        / "latent_
+00012e60: 7465 6e73 6f72 7322 0a20 2020 2020 2020  tensors".       
+00012e70: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00012e80: 2020 2069 6620 636c 7573 7465 722e 6d61     if cluster.ma
+00012e90: 7374 6572 3a0a 2020 2020 2020 2020 2020  ster:.          
+00012ea0: 2020 2020 2020 7465 6e73 6f72 5f70 6174        tensor_pat
+00012eb0: 682e 6d6b 6469 7228 7061 7265 6e74 733d  h.mkdir(parents=
+00012ec0: 5472 7565 2c20 6578 6973 745f 6f6b 3d54  True, exist_ok=T
+00012ed0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+00012ee0: 2064 6973 742e 6261 7272 6965 7228 290a   dist.barrier().
+00012ef0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00012f00: 6e62 5f69 6d61 6765 7320 6973 204e 6f6e  nb_images is Non
+00012f10: 653a 2020 2320 436f 6d70 7574 6520 6f75  e:  # Compute ou
+00012f20: 7470 7574 7320 666f 7220 7468 6520 7768  tputs for the wh
+00012f30: 6f6c 6520 6461 7461 2073 6574 0a20 2020  ole data set.   
+00012f40: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
+00012f50: 6d6f 6465 7320 3d20 6c65 6e28 6461 7461  modes = len(data
+00012f60: 7365 7429 0a20 2020 2020 2020 2020 2020  set).           
+00012f70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00012f80: 2020 2020 2020 206e 625f 6d6f 6465 7320         nb_modes 
+00012f90: 3d20 6e62 5f69 6d61 6765 7320 2a20 6461  = nb_images * da
+00012fa0: 7461 7365 742e 656c 656d 5f70 6572 5f69  taset.elem_per_i
+00012fb0: 6d61 6765 0a0a 2020 2020 2020 2020 2020  mage..          
+00012fc0: 2020 666f 7220 6920 696e 205b 0a20 2020    for i in [.   
+00012fd0: 2020 2020 2020 2020 2020 2020 202a 7261               *ra
+00012fe0: 6e67 6528 636c 7573 7465 722e 7261 6e6b  nge(cluster.rank
+00012ff0: 2c20 6e62 5f6d 6f64 6573 2c20 636c 7573  , nb_modes, clus
+00013000: 7465 722e 776f 726c 645f 7369 7a65 292c  ter.world_size),
+00013010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013020: 202a 7261 6e67 6528 696e 7428 6e62 5f6d   *range(int(nb_m
+00013030: 6f64 6573 2025 2063 6c75 7374 6572 2e77  odes % cluster.w
+00013040: 6f72 6c64 5f73 697a 6520 3c3d 2063 6c75  orld_size <= clu
+00013050: 7374 6572 2e72 616e 6b29 292c 0a20 2020  ster.rank)),.   
+00013060: 2020 2020 2020 2020 205d 3a0a 2020 2020           ]:.    
+00013070: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00013080: 203d 2064 6174 6173 6574 5b69 5d0a 2020   = dataset[i].  
+00013090: 2020 2020 2020 2020 2020 2020 2020 696d                im
+000130a0: 6167 6520 3d20 6461 7461 5b22 696d 6167  age = data["imag
+000130b0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+000130c0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+000130d0: 2866 2249 6d61 6765 2066 6f72 206c 6174  (f"Image for lat
+000130e0: 656e 7420 7265 7072 6573 656e 7461 7469  ent representati
+000130f0: 6f6e 207b 696d 6167 657d 2229 0a20 2020  on {image}").   
+00013100: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+00013110: 6820 6175 746f 6361 7374 2865 6e61 626c  h autocast(enabl
+00013120: 6564 3d73 656c 662e 7374 645f 616d 7029  ed=self.std_amp)
 00013130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013140: 2020 7365 6c66 2e5f 656e 7365 6d62 6c65    self._ensemble
-00013150: 5f74 6f5f 7473 7628 0a20 2020 2020 2020  _to_tsv(.       
-00013160: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-00013170: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-00013180: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
-00013190: 6e3d 7365 6c65 6374 696f 6e5f 6d65 7472  n=selection_metr
-000131a0: 6963 2c0a 2020 2020 2020 2020 2020 2020  ic,.            
-000131b0: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
-000131c0: 7570 3d64 6174 615f 6772 6f75 702c 0a20  up=data_group,. 
-000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131e0: 2020 2075 7365 5f6c 6162 656c 733d 7573     use_labels=us
-000131f0: 655f 6c61 6265 6c73 2c0a 2020 2020 2020  e_labels,.      
-00013200: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00013210: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00013220: 662e 6d6f 6465 2021 3d20 2269 6d61 6765  f.mode != "image
-00013230: 2220 616e 6420 6e6f 7420 736b 6970 5f6c  " and not skip_l
-00013240: 6561 6b5f 6368 6563 6b3a 0a20 2020 2020  eak_check:.     
-00013250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013260: 5f6d 6f64 655f 746f 5f69 6d61 6765 5f74  _mode_to_image_t
-00013270: 7376 280a 2020 2020 2020 2020 2020 2020  sv(.            
-00013280: 2020 2020 2020 2020 7370 6c69 742c 0a20          split,. 
-00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132a0: 2020 2073 656c 6563 7469 6f6e 3d73 656c     selection=sel
-000132b0: 6563 7469 6f6e 5f6d 6574 7269 632c 0a20  ection_metric,. 
-000132c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132d0: 2020 2064 6174 615f 6772 6f75 703d 6461     data_group=da
-000132e0: 7461 5f67 726f 7570 2c0a 2020 2020 2020  ta_group,.      
-000132f0: 2020 2020 2020 2020 2020 2020 2020 7573                us
-00013300: 655f 6c61 6265 6c73 3d75 7365 5f6c 6162  e_labels=use_lab
-00013310: 656c 732c 0a20 2020 2020 2020 2020 2020  els,.           
-00013320: 2020 2020 2029 0a0a 2020 2020 2323 2323       )..    ####
-00013330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013340: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00013350: 2320 4368 6563 6b73 2020 2020 2020 2020  # Checks        
-00013360: 2020 2020 2020 2020 2020 2020 2020 230a                #.
-00013370: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00013380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013390: 2323 230a 2020 2020 6465 6620 5f63 6865  ###.    def _che
-000133a0: 636b 5f61 7267 7328 7365 6c66 2c20 7061  ck_args(self, pa
-000133b0: 7261 6d65 7465 7273 293a 0a20 2020 2020  rameters):.     
-000133c0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-000133d0: 6865 636b 2074 6865 2074 7261 696e 696e  heck the trainin
-000133e0: 6720 7061 7261 6d65 7465 7273 2069 6e74  g parameters int
-000133f0: 6567 7269 7479 0a20 2020 2020 2020 2022  egrity.        "
-00013400: 2222 0a20 2020 2020 2020 206c 6f67 6765  "".        logge
-00013410: 722e 6465 6275 6728 2243 6865 636b 696e  r.debug("Checkin
-00013420: 6720 6172 6775 6d65 6e74 732e 2e2e 2229  g arguments...")
-00013430: 0a20 2020 2020 2020 206d 616e 6461 746f  .        mandato
-00013440: 7279 5f61 7267 756d 656e 7473 203d 205b  ry_arguments = [
-00013450: 0a20 2020 2020 2020 2020 2020 2022 6361  .            "ca
-00013460: 7073 5f64 6972 6563 746f 7279 222c 0a20  ps_directory",. 
-00013470: 2020 2020 2020 2020 2020 2022 7473 765f             "tsv_
-00013480: 7061 7468 222c 0a20 2020 2020 2020 2020  path",.         
-00013490: 2020 2022 7072 6570 726f 6365 7373 696e     "preprocessin
-000134a0: 675f 6469 6374 222c 0a20 2020 2020 2020  g_dict",.       
-000134b0: 2020 2020 2022 6d6f 6465 222c 0a20 2020       "mode",.   
-000134c0: 2020 2020 2020 2020 2022 6e65 7477 6f72           "networ
-000134d0: 6b5f 7461 736b 222c 0a20 2020 2020 2020  k_task",.       
-000134e0: 205d 0a20 2020 2020 2020 2066 6f72 2061   ].        for a
-000134f0: 7267 2069 6e20 6d61 6e64 6174 6f72 795f  rg in mandatory_
-00013500: 6172 6775 6d65 6e74 733a 0a20 2020 2020  arguments:.     
-00013510: 2020 2020 2020 2069 6620 6172 6720 6e6f         if arg no
-00013520: 7420 696e 2070 6172 616d 6574 6572 733a  t in parameters:
-00013530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013540: 2072 6169 7365 2043 6c69 6e69 6361 444c   raise ClinicaDL
-00013550: 4172 6775 6d65 6e74 4572 726f 7228 0a20  ArgumentError(. 
-00013560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013570: 2020 2066 2254 6865 2076 616c 7565 7320     f"The values 
-00013580: 6f66 206d 616e 6461 746f 7279 2061 7267  of mandatory arg
-00013590: 756d 656e 7473 207b 6d61 6e64 6174 6f72  uments {mandator
-000135a0: 795f 6172 6775 6d65 6e74 737d 2073 686f  y_arguments} sho
-000135b0: 756c 6420 6265 2073 6574 2e20 220a 2020  uld be set. ".  
-000135c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135d0: 2020 6622 4e6f 2076 616c 7565 2077 6173    f"No value was
-000135e0: 2067 6976 656e 2066 6f72 207b 6172 677d   given for {arg}
-000135f0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00013600: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00013610: 662e 7061 7261 6d65 7465 7273 203d 2061  f.parameters = a
-00013620: 6464 5f64 6566 6175 6c74 5f76 616c 7565  dd_default_value
-00013630: 7328 7061 7261 6d65 7465 7273 290a 2020  s(parameters).  
-00013640: 2020 2020 2020 7365 6c66 2e70 6172 616d        self.param
-00013650: 6574 6572 7320 3d20 6368 616e 6765 5f73  eters = change_s
-00013660: 7472 5f74 6f5f 7061 7468 2870 6172 616d  tr_to_path(param
-00013670: 6574 6572 7329 0a20 2020 2020 2020 2069  eters).        i
-00013680: 6620 7365 6c66 2e70 6172 616d 6574 6572  f self.parameter
-00013690: 735b 2267 7075 225d 3a0a 2020 2020 2020  s["gpu"]:.      
-000136a0: 2020 2020 2020 6368 6563 6b5f 6770 7528        check_gpu(
-000136b0: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-000136c0: 656c 662e 7061 7261 6d65 7465 7273 5b22  elf.parameters["
-000136d0: 616d 7022 5d3a 0a20 2020 2020 2020 2020  amp"]:.         
-000136e0: 2020 2072 6169 7365 2043 6c69 6e69 6361     raise Clinica
-000136f0: 444c 4172 6775 6d65 6e74 4572 726f 7228  DLArgumentError(
-00013700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013710: 2022 414d 5020 6973 2064 6573 6967 6e65   "AMP is designe
-00013720: 6420 746f 2077 6f72 6b20 7769 7468 206d  d to work with m
-00013730: 6f64 6572 6e20 4750 5573 2e20 506c 6561  odern GPUs. Plea
-00013740: 7365 2061 6464 2074 6865 202d 2d67 7075  se add the --gpu
-00013750: 2066 6c61 672e 220a 2020 2020 2020 2020   flag.".        
-00013760: 2020 2020 290a 0a20 2020 2020 2020 205f      )..        _
-00013770: 2c20 7472 616e 7366 6f72 6d61 7469 6f6e  , transformation
-00013780: 7320 3d20 6765 745f 7472 616e 7366 6f72  s = get_transfor
-00013790: 6d73 280a 2020 2020 2020 2020 2020 2020  ms(.            
-000137a0: 6e6f 726d 616c 697a 653d 7365 6c66 2e6e  normalize=self.n
-000137b0: 6f72 6d61 6c69 7a65 2c0a 2020 2020 2020  ormalize,.      
-000137c0: 2020 2020 2020 7369 7a65 5f72 6564 7563        size_reduc
-000137d0: 7469 6f6e 3d73 656c 662e 7369 7a65 5f72  tion=self.size_r
-000137e0: 6564 7563 7469 6f6e 2c0a 2020 2020 2020  eduction,.      
-000137f0: 2020 2020 2020 7369 7a65 5f72 6564 7563        size_reduc
-00013800: 7469 6f6e 5f66 6163 746f 723d 7365 6c66  tion_factor=self
-00013810: 2e73 697a 655f 7265 6475 6374 696f 6e5f  .size_reduction_
-00013820: 6661 6374 6f72 2c0a 2020 2020 2020 2020  factor,.        
-00013830: 290a 0a20 2020 2020 2020 2073 706c 6974  )..        split
-00013840: 5f6d 616e 6167 6572 203d 2073 656c 662e  _manager = self.
-00013850: 5f69 6e69 745f 7370 6c69 745f 6d61 6e61  _init_split_mana
-00013860: 6765 7228 4e6f 6e65 290a 2020 2020 2020  ger(None).      
-00013870: 2020 7472 6169 6e5f 6466 203d 2073 706c    train_df = spl
-00013880: 6974 5f6d 616e 6167 6572 5b30 5d5b 2274  it_manager[0]["t
-00013890: 7261 696e 225d 0a20 2020 2020 2020 2069  rain"].        i
-000138a0: 6620 226c 6162 656c 2220 6e6f 7420 696e  f "label" not in
-000138b0: 2073 656c 662e 7061 7261 6d65 7465 7273   self.parameters
-000138c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000138d0: 6c66 2e70 6172 616d 6574 6572 735b 226c  lf.parameters["l
-000138e0: 6162 656c 225d 203d 204e 6f6e 650a 0a20  abel"] = None.. 
-000138f0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-00013900: 5f6d 616e 6167 6572 203d 2073 656c 662e  _manager = self.
-00013910: 5f69 6e69 745f 7461 736b 5f6d 616e 6167  _init_task_manag
-00013920: 6572 2864 663d 7472 6169 6e5f 6466 290a  er(df=train_df).
-00013930: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013940: 2e70 6172 616d 6574 6572 735b 2261 7263  .parameters["arc
-00013950: 6869 7465 6374 7572 6522 5d20 3d3d 2022  hitecture"] == "
-00013960: 6465 6661 756c 7422 3a0a 2020 2020 2020  default":.      
-00013970: 2020 2020 2020 7365 6c66 2e70 6172 616d        self.param
-00013980: 6574 6572 735b 2261 7263 6869 7465 6374  eters["architect
-00013990: 7572 6522 5d20 3d20 7365 6c66 2e74 6173  ure"] = self.tas
-000139a0: 6b5f 6d61 6e61 6765 722e 6765 745f 6465  k_manager.get_de
-000139b0: 6661 756c 745f 6e65 7477 6f72 6b28 290a  fault_network().
-000139c0: 2020 2020 2020 2020 6966 2022 7365 6c65          if "sele
-000139d0: 6374 696f 6e5f 7468 7265 7368 6f6c 6422  ction_threshold"
-000139e0: 206e 6f74 2069 6e20 7365 6c66 2e70 6172   not in self.par
-000139f0: 616d 6574 6572 733a 0a20 2020 2020 2020  ameters:.       
-00013a00: 2020 2020 2073 656c 662e 7061 7261 6d65       self.parame
-00013a10: 7465 7273 5b22 7365 6c65 6374 696f 6e5f  ters["selection_
-00013a20: 7468 7265 7368 6f6c 6422 5d20 3d20 4e6f  threshold"] = No
-00013a30: 6e65 0a20 2020 2020 2020 2069 6620 280a  ne.        if (.
-00013a40: 2020 2020 2020 2020 2020 2020 226c 6162              "lab
-00013a50: 656c 5f63 6f64 6522 206e 6f74 2069 6e20  el_code" not in 
-00013a60: 7365 6c66 2e70 6172 616d 6574 6572 730a  self.parameters.
-00013a70: 2020 2020 2020 2020 2020 2020 6f72 206c              or l
-00013a80: 656e 2873 656c 662e 7061 7261 6d65 7465  en(self.paramete
-00013a90: 7273 5b22 6c61 6265 6c5f 636f 6465 225d  rs["label_code"]
-00013aa0: 2920 3d3d 2030 0a20 2020 2020 2020 2029  ) == 0.        )
-00013ab0: 3a20 2023 2041 6c6c 6f77 7320 746f 2073  :  # Allows to s
-00013ac0: 6574 2063 7573 746f 6d20 6c61 6265 6c20  et custom label 
-00013ad0: 636f 6465 2069 6e20 544f 4d4c 0a20 2020  code in TOML.   
-00013ae0: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
-00013af0: 7261 6d65 7465 7273 5b22 6c61 6265 6c5f  rameters["label_
-00013b00: 636f 6465 225d 203d 2073 656c 662e 7461  code"] = self.ta
-00013b10: 736b 5f6d 616e 6167 6572 2e67 656e 6572  sk_manager.gener
-00013b20: 6174 655f 6c61 6265 6c5f 636f 6465 280a  ate_label_code(.
-00013b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b40: 7472 6169 6e5f 6466 2c20 7365 6c66 2e6c  train_df, self.l
-00013b50: 6162 656c 0a20 2020 2020 2020 2020 2020  abel.           
-00013b60: 2029 0a0a 2020 2020 2020 2020 6675 6c6c   )..        full
-00013b70: 5f64 6174 6173 6574 203d 2072 6574 7572  _dataset = retur
-00013b80: 6e5f 6461 7461 7365 7428 0a20 2020 2020  n_dataset(.     
-00013b90: 2020 2020 2020 2073 656c 662e 6361 7073         self.caps
-00013ba0: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
-00013bb0: 2020 2020 2020 2020 7472 6169 6e5f 6466          train_df
-00013bc0: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-00013bd0: 6c66 2e70 7265 7072 6f63 6573 7369 6e67  lf.preprocessing
-00013be0: 5f64 6963 742c 0a20 2020 2020 2020 2020  _dict,.         
-00013bf0: 2020 206d 756c 7469 5f63 6f68 6f72 743d     multi_cohort=
-00013c00: 7365 6c66 2e6d 756c 7469 5f63 6f68 6f72  self.multi_cohor
-00013c10: 742c 0a20 2020 2020 2020 2020 2020 206c  t,.            l
-00013c20: 6162 656c 3d73 656c 662e 6c61 6265 6c2c  abel=self.label,
-00013c30: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
-00013c40: 656c 5f63 6f64 653d 7365 6c66 2e70 6172  el_code=self.par
-00013c50: 616d 6574 6572 735b 226c 6162 656c 5f63  ameters["label_c
-00013c60: 6f64 6522 5d2c 0a20 2020 2020 2020 2020  ode"],.         
-00013c70: 2020 2074 7261 696e 5f74 7261 6e73 666f     train_transfo
-00013c80: 726d 6174 696f 6e73 3d4e 6f6e 652c 0a20  rmations=None,. 
-00013c90: 2020 2020 2020 2020 2020 2061 6c6c 5f74             all_t
-00013ca0: 7261 6e73 666f 726d 6174 696f 6e73 3d74  ransformations=t
-00013cb0: 7261 6e73 666f 726d 6174 696f 6e73 2c0a  ransformations,.
-00013cc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00013cd0: 2020 7365 6c66 2e70 6172 616d 6574 6572    self.parameter
-00013ce0: 732e 7570 6461 7465 280a 2020 2020 2020  s.update(.      
-00013cf0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00013d00: 2020 2020 2020 2020 226e 756d 5f6e 6574          "num_net
-00013d10: 776f 726b 7322 3a20 6675 6c6c 5f64 6174  works": full_dat
-00013d20: 6173 6574 2e65 6c65 6d5f 7065 725f 696d  aset.elem_per_im
-00013d30: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-00013d40: 2020 2020 2022 6f75 7470 7574 5f73 697a       "output_siz
-00013d50: 6522 3a20 7365 6c66 2e74 6173 6b5f 6d61  e": self.task_ma
-00013d60: 6e61 6765 722e 6f75 7470 7574 5f73 697a  nager.output_siz
-00013d70: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00013d80: 2020 2020 2020 2066 756c 6c5f 6461 7461         full_data
-00013d90: 7365 742e 7369 7a65 2c20 6675 6c6c 5f64  set.size, full_d
-00013da0: 6174 6173 6574 2e64 662c 2073 656c 662e  ataset.df, self.
-00013db0: 6c61 6265 6c0a 2020 2020 2020 2020 2020  label.          
-00013dc0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00013dd0: 2020 2020 2020 2020 2022 696e 7075 745f           "input_
-00013de0: 7369 7a65 223a 2066 756c 6c5f 6461 7461  size": full_data
-00013df0: 7365 742e 7369 7a65 2c0a 2020 2020 2020  set.size,.      
-00013e00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00013e10: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00013e20: 7061 7261 6d65 7465 7273 5b22 7365 6564  parameters["seed
-00013e30: 225d 203d 2067 6574 5f73 6565 6428 7365  "] = get_seed(se
-00013e40: 6c66 2e70 6172 616d 6574 6572 735b 2273  lf.parameters["s
-00013e50: 6565 6422 5d29 0a0a 2020 2020 2020 2020  eed"])..        
-00013e60: 6966 2073 656c 662e 7061 7261 6d65 7465  if self.paramete
-00013e70: 7273 5b22 6e75 6d5f 6e65 7477 6f72 6b73  rs["num_networks
-00013e80: 225d 203c 2032 2061 6e64 2073 656c 662e  "] < 2 and self.
-00013e90: 6d75 6c74 695f 6e65 7477 6f72 6b3a 0a20  multi_network:. 
-00013ea0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013eb0: 2043 6c69 6e69 6361 444c 436f 6e66 6967   ClinicaDLConfig
-00013ec0: 7572 6174 696f 6e45 7272 6f72 280a 2020  urationError(.  
-00013ed0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00013ee0: 496e 7661 6c69 6420 7472 6169 6e69 6e67  Invalid training
-00013ef0: 2063 6f6e 6669 6775 7261 7469 6f6e 3a20   configuration: 
-00013f00: 6361 6e6e 6f74 2074 7261 696e 2061 206d  cannot train a m
-00013f10: 756c 7469 2d6e 6574 776f 726b 2022 0a20  ulti-network ". 
-00013f20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013f30: 2266 7261 6d65 776f 726b 2077 6974 6820  "framework with 
-00013f40: 6f6e 6c79 207b 7365 6c66 2e70 6172 616d  only {self.param
-00013f50: 6574 6572 735b 276e 756d 5f6e 6574 776f  eters['num_netwo
-00013f60: 726b 7327 5d7d 2065 6c65 6d65 6e74 2022  rks']} element "
-00013f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013f80: 2066 2270 6572 2069 6d61 6765 2e22 0a20   f"per image.". 
-00013f90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00013fa0: 2020 2020 2070 6f73 7369 626c 655f 7365       possible_se
-00013fb0: 6c65 6374 696f 6e5f 6d65 7472 6963 735f  lection_metrics_
-00013fc0: 7365 7420 3d20 7365 7428 7365 6c66 2e74  set = set(self.t
-00013fd0: 6173 6b5f 6d61 6e61 6765 722e 6576 616c  ask_manager.eval
-00013fe0: 7561 7469 6f6e 5f6d 6574 7269 6373 2920  uation_metrics) 
-00013ff0: 7c20 7b0a 2020 2020 2020 2020 2020 2020  | {.            
-00014000: 226c 6f73 7322 0a20 2020 2020 2020 207d  "loss".        }
-00014010: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00014020: 7365 7428 7365 6c66 2e70 6172 616d 6574  set(self.paramet
-00014030: 6572 735b 2273 656c 6563 7469 6f6e 5f6d  ers["selection_m
-00014040: 6574 7269 6373 225d 292e 6973 7375 6273  etrics"]).issubs
-00014050: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-00014060: 706f 7373 6962 6c65 5f73 656c 6563 7469  possible_selecti
-00014070: 6f6e 5f6d 6574 7269 6373 5f73 6574 0a20  on_metrics_set. 
-00014080: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00014090: 2020 2020 2020 7261 6973 6520 436c 696e        raise Clin
-000140a0: 6963 6144 4c43 6f6e 6669 6775 7261 7469  icaDLConfigurati
-000140b0: 6f6e 4572 726f 7228 0a20 2020 2020 2020  onError(.       
-000140c0: 2020 2020 2020 2020 2066 2253 656c 6563           f"Selec
-000140d0: 7469 6f6e 206d 6574 7269 6373 207b 7365  tion metrics {se
-000140e0: 6c66 2e70 6172 616d 6574 6572 735b 2773  lf.parameters['s
-000140f0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
-00014100: 275d 7d20 220a 2020 2020 2020 2020 2020  ']} ".          
-00014110: 2020 2020 2020 6622 6d75 7374 2062 6520        f"must be 
-00014120: 6120 7375 6273 6574 206f 6620 6d65 7472  a subset of metr
-00014130: 6963 7320 7573 6564 2066 6f72 2065 7661  ics used for eva
-00014140: 6c75 6174 696f 6e20 220a 2020 2020 2020  luation ".      
-00014150: 2020 2020 2020 2020 2020 6622 7b70 6f73            f"{pos
-00014160: 7369 626c 655f 7365 6c65 6374 696f 6e5f  sible_selection_
-00014170: 6d65 7472 6963 735f 7365 747d 2e22 0a20  metrics_set}.". 
-00014180: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00014190: 2020 6465 6620 5f63 6865 636b 5f73 706c    def _check_spl
-000141a0: 6974 5f77 6f72 6469 6e67 2873 656c 6629  it_wording(self)
-000141b0: 3a0a 2020 2020 2020 2020 2222 2246 696e  :.        """Fin
-000141c0: 6473 2069 6620 4d41 5053 2073 7472 7563  ds if MAPS struc
-000141d0: 7475 7265 2075 7365 7320 2766 6f6c 642d  ture uses 'fold-
-000141e0: 5827 206f 7220 2773 706c 6974 2d58 2720  X' or 'split-X' 
-000141f0: 666f 6c64 6572 732e 2222 220a 0a20 2020  folders."""..   
-00014200: 2020 2020 2069 6620 6c65 6e28 6c69 7374       if len(list
-00014210: 2873 656c 662e 6d61 7073 5f70 6174 682e  (self.maps_path.
-00014220: 676c 6f62 2822 666f 6c64 2d2a 2229 2929  glob("fold-*")))
-00014230: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00014240: 2020 7265 7475 726e 2022 666f 6c64 220a    return "fold".
-00014250: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00014260: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00014270: 2022 7370 6c69 7422 0a0a 2020 2020 6465   "split"..    de
-00014280: 6620 5f66 696e 645f 7370 6c69 7473 2873  f _find_splits(s
-00014290: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-000142a0: 2246 696e 6420 7768 6963 6820 7370 6c69  "Find which spli
-000142b0: 7473 2077 6572 6520 7472 6169 6e65 6420  ts were trained 
-000142c0: 696e 2074 6865 204d 4150 532e 2222 220a  in the MAPS.""".
-000142d0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-000142e0: 0a20 2020 2020 2020 2020 2020 2069 6e74  .            int
-000142f0: 2873 706c 6974 2e6e 616d 652e 7370 6c69  (split.name.spli
-00014300: 7428 222d 2229 5b31 5d29 0a20 2020 2020  t("-")[1]).     
-00014310: 2020 2020 2020 2066 6f72 2073 706c 6974         for split
-00014320: 2069 6e20 6c69 7374 2873 656c 662e 6d61   in list(self.ma
-00014330: 7073 5f70 6174 682e 6974 6572 6469 7228  ps_path.iterdir(
-00014340: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-00014350: 6620 7370 6c69 742e 6e61 6d65 2e73 7461  f split.name.sta
-00014360: 7274 7377 6974 6828 6622 7b73 656c 662e  rtswith(f"{self.
-00014370: 7370 6c69 745f 6e61 6d65 7d2d 2229 0a20  split_name}-"). 
-00014380: 2020 2020 2020 205d 0a0a 2020 2020 6465         ]..    de
-00014390: 6620 5f66 696e 645f 7365 6c65 6374 696f  f _find_selectio
-000143a0: 6e5f 6d65 7472 6963 7328 7365 6c66 2c20  n_metrics(self, 
-000143b0: 7370 6c69 7429 3a0a 2020 2020 2020 2020  split):.        
-000143c0: 2222 2246 696e 6420 7768 6963 6820 7365  """Find which se
-000143d0: 6c65 6374 696f 6e20 6d65 7472 6963 7320  lection metrics 
-000143e0: 6172 6520 6176 6169 6c61 626c 6520 696e  are available in
-000143f0: 204d 4150 5320 666f 7220 6120 6769 7665   MAPS for a give
-00014400: 6e20 7370 6c69 742e 2222 220a 0a20 2020  n split."""..   
-00014410: 2020 2020 2073 706c 6974 5f70 6174 6820       split_path 
-00014420: 3d20 7365 6c66 2e6d 6170 735f 7061 7468  = self.maps_path
-00014430: 202f 2066 227b 7365 6c66 2e73 706c 6974   / f"{self.split
-00014440: 5f6e 616d 657d 2d7b 7370 6c69 747d 220a  _name}-{split}".
-00014450: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00014460: 706c 6974 5f70 6174 682e 6973 5f64 6972  plit_path.is_dir
-00014470: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00014480: 7261 6973 6520 4d41 5053 4572 726f 7228  raise MAPSError(
-00014490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000144a0: 2066 2254 7261 696e 696e 6720 6f66 2073   f"Training of s
-000144b0: 706c 6974 207b 7370 6c69 747d 2077 6173  plit {split} was
-000144c0: 206e 6f74 2070 6572 666f 726d 6564 2e22   not performed."
-000144d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000144e0: 2066 2250 6c65 6173 6520 6578 6563 7574   f"Please execut
-000144f0: 6520 6d61 7073 5f6d 616e 6167 6572 2e74  e maps_manager.t
-00014500: 7261 696e 2873 706c 6974 5f6c 6973 743d  rain(split_list=
-00014510: 5b7b 7370 6c69 747d 5d29 220a 2020 2020  [{split}])".    
-00014520: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00014530: 2020 2072 6574 7572 6e20 5b0a 2020 2020     return [.    
-00014540: 2020 2020 2020 2020 6d65 7472 6963 2e6e          metric.n
-00014550: 616d 652e 7370 6c69 7428 222d 2229 5b31  ame.split("-")[1
-00014560: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00014570: 7220 6d65 7472 6963 2069 6e20 6c69 7374  r metric in list
-00014580: 2873 706c 6974 5f70 6174 682e 6974 6572  (split_path.iter
-00014590: 6469 7228 2929 0a20 2020 2020 2020 2020  dir()).         
-000145a0: 2020 2069 6620 6d65 7472 6963 2e6e 616d     if metric.nam
-000145b0: 655b 3a35 3a5d 203d 3d20 2262 6573 742d  e[:5:] == "best-
-000145c0: 220a 2020 2020 2020 2020 5d0a 0a20 2020  ".        ]..   
-000145d0: 2064 6566 205f 6368 6563 6b5f 7365 6c65   def _check_sele
-000145e0: 6374 696f 6e5f 6d65 7472 6963 2873 656c  ction_metric(sel
-000145f0: 662c 2073 706c 6974 2c20 7365 6c65 6374  f, split, select
-00014600: 696f 6e5f 6d65 7472 6963 3d4e 6f6e 6529  ion_metric=None)
-00014610: 3a0a 2020 2020 2020 2020 2222 2243 6865  :.        """Che
-00014620: 636b 2074 6861 7420 6120 6769 7665 6e20  ck that a given 
-00014630: 7365 6c65 6374 696f 6e20 6d65 7472 6963  selection metric
-00014640: 2069 7320 6176 6169 6c61 626c 6520 666f   is available fo
-00014650: 7220 6120 6769 7665 6e20 7370 6c69 742e  r a given split.
-00014660: 2222 220a 2020 2020 2020 2020 6176 6169  """.        avai
-00014670: 6c61 626c 655f 6d65 7472 6963 7320 3d20  lable_metrics = 
-00014680: 7365 6c66 2e5f 6669 6e64 5f73 656c 6563  self._find_selec
-00014690: 7469 6f6e 5f6d 6574 7269 6373 2873 706c  tion_metrics(spl
-000146a0: 6974 290a 2020 2020 2020 2020 6966 206e  it).        if n
-000146b0: 6f74 2073 656c 6563 7469 6f6e 5f6d 6574  ot selection_met
-000146c0: 7269 633a 0a20 2020 2020 2020 2020 2020  ric:.           
-000146d0: 2069 6620 6c65 6e28 6176 6169 6c61 626c   if len(availabl
-000146e0: 655f 6d65 7472 6963 7329 203e 2031 3a0a  e_metrics) > 1:.
-000146f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014700: 7261 6973 6520 436c 696e 6963 6144 4c41  raise ClinicaDLA
-00014710: 7267 756d 656e 7445 7272 6f72 280a 2020  rgumentError(.  
-00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014730: 2020 6622 5365 7665 7261 6c20 6d65 7472    f"Several metr
-00014740: 6963 7320 6172 6520 6176 6169 6c61 626c  ics are availabl
-00014750: 6520 666f 7220 7370 6c69 7420 7b73 706c  e for split {spl
-00014760: 6974 7d2e 2022 0a20 2020 2020 2020 2020  it}. ".         
-00014770: 2020 2020 2020 2020 2020 2066 2250 6c65             f"Ple
-00014780: 6173 6520 6368 6f6f 7365 2077 6869 6368  ase choose which
-00014790: 206f 6e65 2079 6f75 2077 616e 7420 746f   one you want to
-000147a0: 2072 6561 6420 616d 6f6e 6720 7b61 7661   read among {ava
-000147b0: 696c 6162 6c65 5f6d 6574 7269 6373 7d22  ilable_metrics}"
-000147c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000147d0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-000147e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000147f0: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
-00014800: 6574 7269 6320 3d20 6176 6169 6c61 626c  etric = availabl
-00014810: 655f 6d65 7472 6963 735b 305d 0a20 2020  e_metrics[0].   
-00014820: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014830: 2020 2020 2020 2069 6620 7365 6c65 6374         if select
-00014840: 696f 6e5f 6d65 7472 6963 206e 6f74 2069  ion_metric not i
-00014850: 6e20 6176 6169 6c61 626c 655f 6d65 7472  n available_metr
-00014860: 6963 733a 0a20 2020 2020 2020 2020 2020  ics:.           
-00014870: 2020 2020 2072 6169 7365 2043 6c69 6e69       raise Clini
-00014880: 6361 444c 4172 6775 6d65 6e74 4572 726f  caDLArgumentErro
-00014890: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000148a0: 2020 2020 2020 2066 2254 6865 206d 6574         f"The met
-000148b0: 7269 6320 7b73 656c 6563 7469 6f6e 5f6d  ric {selection_m
-000148c0: 6574 7269 637d 2069 7320 6e6f 7420 6176  etric} is not av
-000148d0: 6169 6c61 626c 652e 220a 2020 2020 2020  ailable.".      
-000148e0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000148f0: 506c 6561 7365 2063 686f 6f73 6520 616d  Please choose am
-00014900: 6f6e 6720 6973 2074 6865 2061 7661 696c  ong is the avail
-00014910: 6162 6c65 206d 6574 7269 6373 207b 6176  able metrics {av
-00014920: 6169 6c61 626c 655f 6d65 7472 6963 737d  ailable_metrics}
-00014930: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00014940: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
-00014950: 7572 6e20 7365 6c65 6374 696f 6e5f 6d65  urn selection_me
-00014960: 7472 6963 0a0a 2020 2020 6465 6620 5f63  tric..    def _c
-00014970: 6865 636b 5f6c 6561 6b61 6765 2873 656c  heck_leakage(sel
-00014980: 662c 2064 6174 615f 6772 6f75 702c 2074  f, data_group, t
-00014990: 6573 745f 6466 293a 0a20 2020 2020 2020  est_df):.       
-000149a0: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
-000149b0: 636b 7320 7468 6174 206e 6f20 696e 7465  cks that no inte
-000149c0: 7273 6563 7469 6f6e 2065 7869 7374 2062  rsection exist b
-000149d0: 6574 7765 656e 2074 6865 2070 6172 7469  etween the parti
-000149e0: 6369 7061 6e74 7320 7573 6564 2066 6f72  cipants used for
-000149f0: 2074 7261 696e 696e 6720 616e 6420 7468   training and th
-00014a00: 6f73 6520 7573 6564 2066 6f72 2074 6573  ose used for tes
-00014a10: 7469 6e67 2e0a 0a20 2020 2020 2020 2041  ting...        A
-00014a20: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00014a30: 2064 6174 615f 6772 6f75 7020 2873 7472   data_group (str
-00014a40: 293a 206e 616d 6520 6f66 2074 6865 2064  ): name of the d
-00014a50: 6174 6120 6772 6f75 700a 2020 2020 2020  ata group.      
-00014a60: 2020 2020 2020 7465 7374 5f64 6620 2870        test_df (p
-00014a70: 642e 4461 7461 4672 616d 6529 3a20 5461  d.DataFrame): Ta
-00014a80: 626c 6520 6f66 2070 6172 7469 6369 7061  ble of participa
-00014a90: 6e74 5f69 6420 2f20 7365 7373 696f 6e5f  nt_id / session_
-00014aa0: 6964 206f 6620 7468 6520 6461 7461 2067  id of the data g
-00014ab0: 726f 7570 0a20 2020 2020 2020 2052 6169  roup.        Rai
-00014ac0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-00014ad0: 2043 6c69 6e69 6361 444c 4461 7461 4c65   ClinicaDLDataLe
-00014ae0: 616b 6167 6545 7272 6f72 3a20 6966 2064  akageError: if d
-00014af0: 6174 615f 6772 6f75 7020 6e6f 7420 696e  ata_group not in
-00014b00: 205b 2274 7261 696e 222c 2022 7661 6c69   ["train", "vali
-00014b10: 6461 7469 6f6e 225d 2061 6e64 2074 6865  dation"] and the
-00014b20: 7265 2069 7320 616e 2069 6e74 6572 7365  re is an interse
-00014b30: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-00014b40: 2020 2020 2020 6265 7477 6565 6e20 7468        between th
-00014b50: 6520 7061 7274 6963 6970 616e 7420 4944  e participant ID
-00014b60: 7320 696e 2074 6573 745f 6466 2061 6e64  s in test_df and
-00014b70: 2074 6865 206f 6e65 7320 7573 6564 2066   the ones used f
-00014b80: 6f72 2074 7261 696e 696e 672e 0a20 2020  or training..   
-00014b90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00014ba0: 2069 6620 6461 7461 5f67 726f 7570 206e   if data_group n
-00014bb0: 6f74 2069 6e20 5b22 7472 6169 6e22 2c20  ot in ["train", 
-00014bc0: 2276 616c 6964 6174 696f 6e22 5d3a 0a20  "validation"]:. 
-00014bd0: 2020 2020 2020 2020 2020 2074 7261 696e             train
-00014be0: 5f70 6174 6820 3d20 7365 6c66 2e6d 6170  _path = self.map
-00014bf0: 735f 7061 7468 202f 2022 6772 6f75 7073  s_path / "groups
-00014c00: 2220 2f20 2274 7261 696e 2b76 616c 6964  " / "train+valid
-00014c10: 6174 696f 6e2e 7473 7622 0a20 2020 2020  ation.tsv".     
-00014c20: 2020 2020 2020 2074 7261 696e 5f64 6620         train_df 
-00014c30: 3d20 7064 2e72 6561 645f 6373 7628 7472  = pd.read_csv(tr
-00014c40: 6169 6e5f 7061 7468 2c20 7365 703d 225c  ain_path, sep="\
-00014c50: 7422 290a 2020 2020 2020 2020 2020 2020  t").            
-00014c60: 7061 7274 6963 6970 616e 7473 5f74 7261  participants_tra
-00014c70: 696e 203d 2073 6574 2874 7261 696e 5f64  in = set(train_d
-00014c80: 662e 7061 7274 6963 6970 616e 745f 6964  f.participant_id
-00014c90: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-00014ca0: 2020 2020 2070 6172 7469 6369 7061 6e74       participant
-00014cb0: 735f 7465 7374 203d 2073 6574 2874 6573  s_test = set(tes
-00014cc0: 745f 6466 2e70 6172 7469 6369 7061 6e74  t_df.participant
-00014cd0: 5f69 642e 7661 6c75 6573 290a 2020 2020  _id.values).    
-00014ce0: 2020 2020 2020 2020 696e 7465 7273 6563          intersec
-00014cf0: 7469 6f6e 203d 2070 6172 7469 6369 7061  tion = participa
-00014d00: 6e74 735f 7465 7374 2026 2070 6172 7469  nts_test & parti
-00014d10: 6369 7061 6e74 735f 7472 6169 6e0a 0a20  cipants_train.. 
-00014d20: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00014d30: 6e28 696e 7465 7273 6563 7469 6f6e 2920  n(intersection) 
-00014d40: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00014d50: 2020 2020 2072 6169 7365 2043 6c69 6e69       raise Clini
-00014d60: 6361 444c 4461 7461 4c65 616b 6167 6545  caDLDataLeakageE
-00014d70: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00014d80: 2020 2020 2020 2020 2020 2259 6f75 7220            "Your 
-00014d90: 6576 616c 7561 7469 6f6e 2073 6574 2063  evaluation set c
-00014da0: 6f6e 7461 696e 7320 7061 7274 6963 6970  ontains particip
-00014db0: 616e 7473 2077 686f 2077 6572 6520 616c  ants who were al
-00014dc0: 7265 6164 7920 7365 656e 2064 7572 696e  ready seen durin
-00014dd0: 6720 220a 2020 2020 2020 2020 2020 2020  g ".            
-00014de0: 2020 2020 2020 2020 2274 6865 2074 7261          "the tra
-00014df0: 696e 696e 6720 7374 6570 2e20 5468 6520  ining step. The 
-00014e00: 6c69 7374 206f 6620 636f 6d6d 6f6e 2070  list of common p
-00014e10: 6172 7469 6369 7061 6e74 7320 6973 2074  articipants is t
-00014e20: 6865 2066 6f6c 6c6f 7769 6e67 3a20 220a  he following: ".
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e40: 2020 2020 6622 7b69 6e74 6572 7365 6374      f"{intersect
-00014e50: 696f 6e7d 2e22 0a20 2020 2020 2020 2020  ion}.".         
-00014e60: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00014e70: 6620 5f63 6865 636b 5f64 6174 615f 6772  f _check_data_gr
-00014e80: 6f75 7028 0a20 2020 2020 2020 2073 656c  oup(.        sel
-00014e90: 662c 0a20 2020 2020 2020 2064 6174 615f  f,.        data_
-00014ea0: 6772 6f75 702c 0a20 2020 2020 2020 2063  group,.        c
-00014eb0: 6170 735f 6469 7265 6374 6f72 793d 4e6f  aps_directory=No
-00014ec0: 6e65 2c0a 2020 2020 2020 2020 6466 3d4e  ne,.        df=N
-00014ed0: 6f6e 652c 0a20 2020 2020 2020 206d 756c  one,.        mul
-00014ee0: 7469 5f63 6f68 6f72 743d 4661 6c73 652c  ti_cohort=False,
-00014ef0: 0a20 2020 2020 2020 206f 7665 7277 7269  .        overwri
-00014f00: 7465 3d46 616c 7365 2c0a 2020 2020 2020  te=False,.      
-00014f10: 2020 6c61 6265 6c3d 4e6f 6e65 2c0a 2020    label=None,.  
-00014f20: 2020 2020 2020 7370 6c69 745f 6c69 7374        split_list
-00014f30: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-00014f40: 6b69 705f 6c65 616b 5f63 6865 636b 3d46  kip_leak_check=F
-00014f50: 616c 7365 2c0a 2020 2020 293a 0a20 2020  alse,.    ):.   
-00014f60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00014f70: 2043 6865 636b 2069 6620 6120 6461 7461   Check if a data
-00014f80: 2067 726f 7570 2069 7320 616c 7265 6164   group is alread
-00014f90: 7920 6176 6169 6c61 626c 6520 6966 206f  y available if o
-00014fa0: 7468 6572 2061 7267 756d 656e 7473 2061  ther arguments a
-00014fb0: 7265 204e 6f6e 652e 0a20 2020 2020 2020  re None..       
-00014fc0: 2045 6c73 6520 6372 6561 7465 7320 6120   Else creates a 
-00014fd0: 6e65 7720 6461 7461 5f67 726f 7570 2e0a  new data_group..
-00014fe0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00014ff0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00015000: 6772 6f75 7020 2873 7472 293a 206e 616d  group (str): nam
-00015010: 6520 6f66 2074 6865 2064 6174 6120 6772  e of the data gr
-00015020: 6f75 700a 2020 2020 2020 2020 2020 2020  oup.            
-00015030: 6361 7073 5f64 6972 6563 746f 7279 2020  caps_directory  
-00015040: 2873 7472 293a 2069 6e70 7574 2043 4150  (str): input CAP
-00015050: 5320 6469 7265 6374 6f72 790a 2020 2020  S directory.    
-00015060: 2020 2020 2020 2020 6466 2028 7064 2e44          df (pd.D
-00015070: 6174 6146 7261 6d65 293a 2054 6162 6c65  ataFrame): Table
-00015080: 206f 6620 7061 7274 6963 6970 616e 745f   of participant_
-00015090: 6964 202f 2073 6573 7369 6f6e 5f69 6420  id / session_id 
-000150a0: 6f66 2074 6865 2064 6174 6120 6772 6f75  of the data grou
-000150b0: 700a 2020 2020 2020 2020 2020 2020 6d75  p.            mu
-000150c0: 6c74 695f 636f 686f 7274 2028 626f 6f6c  lti_cohort (bool
-000150d0: 293a 2069 6e64 6963 6174 6573 2069 6620  ): indicates if 
-000150e0: 7468 6520 696e 7075 7420 6461 7461 2063  the input data c
-000150f0: 6f6d 6573 2066 726f 6d20 7365 7665 7261  omes from severa
-00015100: 6c20 4341 5053 0a20 2020 2020 2020 2020  l CAPS.         
-00015110: 2020 206f 7665 7277 7269 7465 2028 626f     overwrite (bo
-00015120: 6f6c 293a 2049 6620 5472 7565 2066 6f72  ol): If True for
-00015130: 6d65 7220 6465 6669 6e69 7469 6f6e 206f  mer definition o
-00015140: 6620 6461 7461 2067 726f 7570 2069 7320  f data group is 
-00015150: 6572 6173 6564 0a20 2020 2020 2020 2020  erased.         
-00015160: 2020 206c 6162 656c 2028 7374 7229 3a20     label (str): 
-00015170: 6c61 6265 6c20 6e61 6d65 2069 6620 6170  label name if ap
-00015180: 706c 6963 6162 6c65 0a0a 2020 2020 2020  plicable..      
-00015190: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-000151a0: 2020 2020 2020 4d41 5053 4572 726f 7220        MAPSError 
-000151b0: 7768 656e 2074 7279 696e 6720 746f 206f  when trying to o
-000151c0: 7665 7277 7269 7465 2074 7261 696e 206f  verwrite train o
-000151d0: 7220 7661 6c69 6461 7469 6f6e 2064 6174  r validation dat
-000151e0: 6120 6772 6f75 7073 0a20 2020 2020 2020  a groups.       
-000151f0: 2020 2020 2043 6c69 6e69 6361 444c 4172       ClinicaDLAr
-00015200: 6775 6d65 6e74 4572 726f 723a 0a20 2020  gumentError:.   
-00015210: 2020 2020 2020 2020 2020 2020 2077 6865               whe
-00015220: 6e20 6361 7073 5f64 6972 6563 746f 7279  n caps_directory
-00015230: 206f 7220 6466 2061 7265 2067 6976 656e   or df are given
-00015240: 2062 7574 2064 6174 6120 6772 6f75 7020   but data group 
-00015250: 616c 7265 6164 7920 6578 6973 7473 0a20  already exists. 
-00015260: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00015270: 6865 6e20 6361 7073 5f64 6972 6563 746f  hen caps_directo
-00015280: 7279 206f 7220 6466 2061 7265 206e 6f74  ry or df are not
-00015290: 2067 6976 656e 2061 6e64 2064 6174 6120   given and data 
-000152a0: 6772 6f75 7020 646f 6573 206e 6f74 2065  group does not e
-000152b0: 7869 7374 0a20 2020 2020 2020 2022 2222  xist.        """
-000152c0: 0a20 2020 2020 2020 2067 726f 7570 5f64  .        group_d
-000152d0: 6972 203d 2073 656c 662e 6d61 7073 5f70  ir = self.maps_p
-000152e0: 6174 6820 2f20 2267 726f 7570 7322 202f  ath / "groups" /
-000152f0: 2064 6174 615f 6772 6f75 700a 2020 2020   data_group.    
-00015300: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00015310: 2866 2247 726f 7570 2070 6174 6820 7b67  (f"Group path {g
-00015320: 726f 7570 5f64 6972 7d22 290a 2020 2020  roup_dir}").    
-00015330: 2020 2020 6966 2067 726f 7570 5f64 6972      if group_dir
-00015340: 2e69 735f 6469 7228 293a 2020 2320 4461  .is_dir():  # Da
-00015350: 7461 2067 726f 7570 2061 6c72 6561 6479  ta group already
-00015360: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
-00015370: 2020 2020 6966 206f 7665 7277 7269 7465      if overwrite
-00015380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015390: 2020 6966 2064 6174 615f 6772 6f75 7020    if data_group 
-000153a0: 696e 205b 2274 7261 696e 222c 2022 7661  in ["train", "va
-000153b0: 6c69 6461 7469 6f6e 225d 3a0a 2020 2020  lidation"]:.    
-000153c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000153d0: 7261 6973 6520 4d41 5053 4572 726f 7228  raise MAPSError(
-000153e0: 2243 616e 6e6f 7420 6f76 6572 7772 6974  "Cannot overwrit
-000153f0: 6520 7472 6169 6e20 6f72 2076 616c 6964  e train or valid
-00015400: 6174 696f 6e20 6461 7461 2067 726f 7570  ation data group
-00015410: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00015420: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00015430: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00015440: 206e 6f74 2073 706c 6974 5f6c 6973 743a   not split_list:
-00015450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015460: 2020 2020 2020 2020 2073 706c 6974 5f6c           split_l
-00015470: 6973 7420 3d20 7365 6c66 2e5f 6669 6e64  ist = self._find
-00015480: 5f73 706c 6974 7328 290a 2020 2020 2020  _splits().      
-00015490: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000154a0: 7220 7370 6c69 7420 696e 2073 706c 6974  r split in split
-000154b0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-000154c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000154d0: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
-000154e0: 203d 2073 656c 662e 5f66 696e 645f 7365   = self._find_se
-000154f0: 6c65 6374 696f 6e5f 6d65 7472 6963 7328  lection_metrics(
-00015500: 7370 6c69 7429 0a20 2020 2020 2020 2020  split).         
-00015510: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015520: 6f72 2073 656c 6563 7469 6f6e 2069 6e20  or selection in 
-00015530: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-00015540: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015550: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00015560: 6573 756c 7473 5f70 6174 6820 3d20 280a  esults_path = (.
-00015570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015590: 7365 6c66 2e6d 6170 735f 7061 7468 0a20  self.maps_path. 
-000155a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155b0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-000155c0: 2066 227b 7365 6c66 2e73 706c 6974 5f6e   f"{self.split_n
-000155d0: 616d 657d 2d7b 7370 6c69 747d 220a 2020  ame}-{split}".  
-000155e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155f0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-00015600: 6622 6265 7374 2d7b 7365 6c65 6374 696f  f"best-{selectio
-00015610: 6e7d 220a 2020 2020 2020 2020 2020 2020  n}".            
-00015620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015630: 2020 2020 2f20 6461 7461 5f67 726f 7570      / data_group
-00015640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015650: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00015660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015670: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-00015680: 7375 6c74 735f 7061 7468 2e69 735f 6469  sults_path.is_di
-00015690: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-000156a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156b0: 2020 2020 2073 6875 7469 6c2e 726d 7472       shutil.rmtr
-000156c0: 6565 2872 6573 756c 7473 5f70 6174 6829  ee(results_path)
-000156d0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-000156e0: 6620 6466 2069 7320 6e6f 7420 4e6f 6e65  f df is not None
-000156f0: 206f 7220 6361 7073 5f64 6972 6563 746f   or caps_directo
-00015700: 7279 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ry is not None:.
-00015710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015720: 7261 6973 6520 436c 696e 6963 6144 4c41  raise ClinicaDLA
-00015730: 7267 756d 656e 7445 7272 6f72 280a 2020  rgumentError(.  
-00015740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015750: 2020 6622 4461 7461 2067 726f 7570 207b    f"Data group {
-00015760: 6461 7461 5f67 726f 7570 7d20 6973 2061  data_group} is a
-00015770: 6c72 6561 6479 2064 6566 696e 6564 2e20  lready defined. 
-00015780: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00015790: 2020 2020 2020 6622 506c 6561 7365 2064        f"Please d
-000157a0: 6f20 6e6f 7420 6769 7665 2061 6e79 2063  o not give any c
-000157b0: 6170 735f 6469 7265 6374 6f72 792c 2074  aps_directory, t
-000157c0: 7376 5f70 6174 6820 6f72 206d 756c 7469  sv_path or multi
-000157d0: 5f63 6f68 6f72 7420 746f 2075 7365 2069  _cohort to use i
-000157e0: 742e 2022 0a20 2020 2020 2020 2020 2020  t. ".           
-000157f0: 2020 2020 2020 2020 2066 2254 6f20 6572           f"To er
-00015800: 6173 6520 7b64 6174 615f 6772 6f75 707d  ase {data_group}
-00015810: 2070 6c65 6173 6520 7365 7420 6f76 6572   please set over
-00015820: 7772 6974 6520 746f 2054 7275 652e 220a  write to True.".
-00015830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015840: 290a 0a20 2020 2020 2020 2065 6c69 6620  )..        elif 
-00015850: 6e6f 7420 6772 6f75 705f 6469 722e 6973  not group_dir.is
-00015860: 5f64 6972 2829 2061 6e64 2028 0a20 2020  _dir() and (.   
-00015870: 2020 2020 2020 2020 2063 6170 735f 6469           caps_di
-00015880: 7265 6374 6f72 7920 6973 204e 6f6e 6520  rectory is None 
-00015890: 6f72 2064 6620 6973 204e 6f6e 650a 2020  or df is None.  
-000158a0: 2020 2020 2020 293a 2020 2320 4461 7461        ):  # Data
-000158b0: 2067 726f 7570 2064 6f65 7320 6e6f 7420   group does not 
-000158c0: 6578 6973 7420 7965 7420 2f20 7761 7320  exist yet / was 
-000158d0: 6f76 6572 7772 6974 7465 6e20 2b20 6d69  overwritten + mi
-000158e0: 7373 696e 6720 6461 7461 0a20 2020 2020  ssing data.     
-000158f0: 2020 2020 2020 2072 6169 7365 2043 6c69         raise Cli
-00015900: 6e69 6361 444c 4172 6775 6d65 6e74 4572  nicaDLArgumentEr
-00015910: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00015920: 2020 2020 2066 2254 6865 2064 6174 6120       f"The data 
-00015930: 6772 6f75 7020 7b64 6174 615f 6772 6f75  group {data_grou
-00015940: 707d 2064 6f65 7320 6e6f 7420 616c 7265  p} does not alre
-00015950: 6164 7920 6578 6973 742e 2022 0a20 2020  ady exist. ".   
-00015960: 2020 2020 2020 2020 2020 2020 2066 2250               f"P
-00015970: 6c65 6173 6520 7370 6563 6966 7920 6120  lease specify a 
-00015980: 6361 7073 5f64 6972 6563 746f 7279 2061  caps_directory a
-00015990: 6e64 2061 2074 7376 5f70 6174 6820 746f  nd a tsv_path to
-000159a0: 2063 7265 6174 6520 7468 6973 2064 6174   create this dat
-000159b0: 6120 6772 6f75 702e 220a 2020 2020 2020  a group.".      
-000159c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000159d0: 656c 6966 2028 0a20 2020 2020 2020 2020  elif (.         
-000159e0: 2020 206e 6f74 2067 726f 7570 5f64 6972     not group_dir
-000159f0: 2e69 735f 6469 7228 290a 2020 2020 2020  .is_dir().      
-00015a00: 2020 293a 2020 2320 4461 7461 2067 726f    ):  # Data gro
-00015a10: 7570 2064 6f65 7320 6e6f 7420 6578 6973  up does not exis
-00015a20: 7420 7965 7420 2f20 7761 7320 6f76 6572  t yet / was over
-00015a30: 7772 6974 7465 6e20 2b20 616c 6c20 6461  written + all da
-00015a40: 7461 2069 7320 7072 6f76 6964 6564 0a20  ta is provided. 
-00015a50: 2020 2020 2020 2020 2020 2069 6620 736b             if sk
-00015a60: 6970 5f6c 6561 6b5f 6368 6563 6b3a 0a20  ip_leak_check:. 
-00015a70: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015a80: 6f67 6765 722e 696e 666f 2822 536b 6970  ogger.info("Skip
-00015a90: 7069 6e67 2064 6174 6120 6c65 616b 6167  ping data leakag
-00015aa0: 6520 6368 6563 6b22 290a 2020 2020 2020  e check").      
-00015ab0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015ac0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015ad0: 2e5f 6368 6563 6b5f 6c65 616b 6167 6528  ._check_leakage(
-00015ae0: 6461 7461 5f67 726f 7570 2c20 6466 290a  data_group, df).
-00015af0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015b00: 2e5f 7772 6974 655f 6461 7461 5f67 726f  ._write_data_gro
-00015b10: 7570 280a 2020 2020 2020 2020 2020 2020  up(.            
-00015b20: 2020 2020 6461 7461 5f67 726f 7570 2c20      data_group, 
-00015b30: 6466 2c20 6361 7073 5f64 6972 6563 746f  df, caps_directo
-00015b40: 7279 2c20 6d75 6c74 695f 636f 686f 7274  ry, multi_cohort
-00015b50: 2c20 6c61 6265 6c3d 6c61 6265 6c0a 2020  , label=label.  
-00015b60: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00015b70: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00015b80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015b90: 0a20 2020 2023 2046 696c 6520 7772 6974  .    # File writ
-00015ba0: 6572 7320 2020 2020 2020 2020 2020 2020  ers             
-00015bb0: 2020 2023 0a20 2020 2023 2323 2323 2323     #.    #######
-00015bc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015bd0: 2323 2323 2323 2323 0a20 2020 2040 7374  ########.    @st
-00015be0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-00015bf0: 6566 2077 7269 7465 5f70 6172 616d 6574  ef write_paramet
-00015c00: 6572 7328 6a73 6f6e 5f70 6174 683a 2050  ers(json_path: P
-00015c10: 6174 682c 2070 6172 616d 6574 6572 732c  ath, parameters,
-00015c20: 2076 6572 626f 7365 3d54 7275 6529 3a0a   verbose=True):.
-00015c30: 2020 2020 2020 2020 2222 2257 7269 7465          """Write
-00015c40: 204a 534f 4e20 6669 6c65 7320 6f66 2070   JSON files of p
-00015c50: 6172 616d 6574 6572 732e 2222 220a 2020  arameters.""".  
-00015c60: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-00015c70: 7567 2822 5772 6974 696e 6720 7061 7261  ug("Writing para
-00015c80: 6d65 7465 7273 2e2e 2e22 290a 2020 2020  meters...").    
-00015c90: 2020 2020 6a73 6f6e 5f70 6174 682e 6d6b      json_path.mk
-00015ca0: 6469 7228 7061 7265 6e74 733d 5472 7565  dir(parents=True
-00015cb0: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
-00015cc0: 0a0a 2020 2020 2020 2020 7061 7261 6d65  ..        parame
-00015cd0: 7465 7273 203d 2063 6861 6e67 655f 7061  ters = change_pa
-00015ce0: 7468 5f74 6f5f 7374 7228 7061 7261 6d65  th_to_str(parame
-00015cf0: 7465 7273 290a 2020 2020 2020 2020 2320  ters).        # 
-00015d00: 7361 7665 2074 6f20 6a73 6f6e 2066 696c  save to json fil
-00015d10: 650a 2020 2020 2020 2020 6a73 6f6e 5f64  e.        json_d
-00015d20: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00015d30: 2870 6172 616d 6574 6572 732c 2073 6b69  (parameters, ski
-00015d40: 706b 6579 733d 5472 7565 2c20 696e 6465  pkeys=True, inde
-00015d50: 6e74 3d34 290a 2020 2020 2020 2020 6a73  nt=4).        js
-00015d60: 6f6e 5f70 6174 6820 3d20 6a73 6f6e 5f70  on_path = json_p
-00015d70: 6174 6820 2f20 226d 6170 732e 6a73 6f6e  ath / "maps.json
-00015d80: 220a 2020 2020 2020 2020 6966 2076 6572  ".        if ver
-00015d90: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00015da0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
-00015db0: 5061 7468 206f 6620 6a73 6f6e 2066 696c  Path of json fil
-00015dc0: 653a 207b 6a73 6f6e 5f70 6174 687d 2229  e: {json_path}")
-00015dd0: 0a20 2020 2020 2020 2077 6974 6820 6a73  .        with js
-00015de0: 6f6e 5f70 6174 682e 6f70 656e 286d 6f64  on_path.open(mod
-00015df0: 653d 2277 2229 2061 7320 663a 0a20 2020  e="w") as f:.   
-00015e00: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-00015e10: 286a 736f 6e5f 6461 7461 290a 2020 2020  (json_data).    
-00015e20: 2020 2020 7061 7261 6d65 7465 7273 203d      parameters =
-00015e30: 2063 6861 6e67 655f 7374 725f 746f 5f70   change_str_to_p
-00015e40: 6174 6828 7061 7261 6d65 7465 7273 290a  ath(parameters).
-00015e50: 0a20 2020 2064 6566 205f 7772 6974 655f  .    def _write_
-00015e60: 7265 7175 6972 656d 656e 7473 5f76 6572  requirements_ver
-00015e70: 7369 6f6e 2873 656c 6629 3a0a 2020 2020  sion(self):.    
-00015e80: 2020 2020 2222 2257 7269 7465 7320 7468      """Writes th
-00015e90: 6520 656e 7669 726f 6e6d 656e 742e 7478  e environment.tx
-00015ea0: 7420 6669 6c65 2e22 2222 0a20 2020 2020  t file.""".     
-00015eb0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00015ec0: 2257 7269 7469 6e67 2072 6571 7569 7265  "Writing require
-00015ed0: 6d65 6e74 2076 6572 7369 6f6e 2e2e 2e22  ment version..."
-00015ee0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-00015ef0: 2020 2020 2020 2020 2020 2065 6e76 5f76             env_v
-00015f00: 6172 6961 626c 6573 203d 2073 7562 7072  ariables = subpr
-00015f10: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00015f20: 7574 2822 7069 7020 6672 6565 7a65 222c  ut("pip freeze",
-00015f30: 2073 6865 6c6c 3d54 7275 6529 2e64 6563   shell=True).dec
-00015f40: 6f64 6528 0a20 2020 2020 2020 2020 2020  ode(.           
-00015f50: 2020 2020 2022 7574 662d 3822 0a20 2020       "utf-8".   
-00015f60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015f70: 2020 2020 2020 2077 6974 6820 2873 656c         with (sel
-00015f80: 662e 6d61 7073 5f70 6174 6820 2f20 2265  f.maps_path / "e
-00015f90: 6e76 6972 6f6e 6d65 6e74 2e74 7874 2229  nvironment.txt")
-00015fa0: 2e6f 7065 6e28 6d6f 6465 3d22 7722 2920  .open(mode="w") 
-00015fb0: 6173 2066 696c 653a 0a20 2020 2020 2020  as file:.       
-00015fc0: 2020 2020 2020 2020 2066 696c 652e 7772           file.wr
-00015fd0: 6974 6528 656e 765f 7661 7269 6162 6c65  ite(env_variable
-00015fe0: 7329 0a20 2020 2020 2020 2065 7863 6570  s).        excep
-00015ff0: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
-00016000: 6c65 6450 726f 6365 7373 4572 726f 723a  ledProcessError:
-00016010: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00016020: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00016030: 2020 2020 2020 2020 2020 2020 2022 596f               "Yo
-00016040: 7520 646f 206e 6f74 2068 6176 6520 7468  u do not have th
-00016050: 6520 7269 6768 7420 746f 2065 7865 6375  e right to execu
-00016060: 7465 2070 6970 2066 7265 657a 652e 2059  te pip freeze. Y
-00016070: 6f75 7220 656e 7669 726f 6e6d 656e 7420  our environment 
-00016080: 7769 6c6c 206e 6f74 2062 6520 7772 6974  will not be writ
-00016090: 7465 6e22 0a20 2020 2020 2020 2020 2020  ten".           
-000160a0: 2029 0a0a 2020 2020 6465 6620 5f77 7269   )..    def _wri
-000160b0: 7465 5f74 7261 696e 696e 675f 6461 7461  te_training_data
-000160c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000160d0: 2222 2257 7269 7465 7320 7468 6520 5453  """Writes the TS
-000160e0: 5620 6669 6c65 2063 6f6e 7461 696e 696e  V file containin
-000160f0: 6720 7468 6520 7061 7274 6963 6970 616e  g the participan
-00016100: 7420 616e 6420 7365 7373 696f 6e20 4944  t and session ID
-00016110: 7320 7573 6564 2066 6f72 2074 7261 696e  s used for train
-00016120: 696e 672e 2222 220a 2020 2020 2020 2020  ing.""".        
-00016130: 6c6f 6767 6572 2e64 6562 7567 2822 5772  logger.debug("Wr
-00016140: 6974 696e 6720 7472 6169 6e69 6e67 2064  iting training d
-00016150: 6174 612e 2e2e 2229 0a20 2020 2020 2020  ata...").       
-00016160: 2066 726f 6d20 636c 696e 6963 6164 6c2e   from clinicadl.
-00016170: 7574 696c 732e 6361 7073 5f64 6174 6173  utils.caps_datas
-00016180: 6574 2e64 6174 6120 696d 706f 7274 206c  et.data import l
-00016190: 6f61 645f 6461 7461 5f74 6573 740a 0a20  oad_data_test.. 
-000161a0: 2020 2020 2020 2074 7261 696e 5f64 6620         train_df 
-000161b0: 3d20 6c6f 6164 5f64 6174 615f 7465 7374  = load_data_test
-000161c0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-000161d0: 6c66 2e74 7376 5f70 6174 682c 0a20 2020  lf.tsv_path,.   
-000161e0: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
-000161f0: 6167 6e6f 7365 732c 0a20 2020 2020 2020  agnoses,.       
-00016200: 2020 2020 2062 6173 656c 696e 653d 4661       baseline=Fa
-00016210: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00016220: 206d 756c 7469 5f63 6f68 6f72 743d 7365   multi_cohort=se
-00016230: 6c66 2e6d 756c 7469 5f63 6f68 6f72 742c  lf.multi_cohort,
-00016240: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00016250: 2020 2074 7261 696e 5f64 6620 3d20 7472     train_df = tr
-00016260: 6169 6e5f 6466 5b5b 2270 6172 7469 6369  ain_df[["partici
-00016270: 7061 6e74 5f69 6422 2c20 2273 6573 7369  pant_id", "sessi
-00016280: 6f6e 5f69 6422 5d5d 0a20 2020 2020 2020  on_id"]].       
-00016290: 2069 6620 7365 6c66 2e74 7261 6e73 6665   if self.transfe
-000162a0: 725f 7061 7468 3a0a 2020 2020 2020 2020  r_path:.        
-000162b0: 2020 2020 7472 616e 7366 6572 5f74 7261      transfer_tra
-000162c0: 696e 5f70 6174 6820 3d20 7365 6c66 2e74  in_path = self.t
-000162d0: 7261 6e73 6665 725f 7061 7468 202f 2022  ransfer_path / "
-000162e0: 6772 6f75 7073 2220 2f20 2274 7261 696e  groups" / "train
-000162f0: 2b76 616c 6964 6174 696f 6e2e 7473 7622  +validation.tsv"
-00016300: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
-00016310: 6e73 6665 725f 7472 6169 6e5f 6466 203d  nsfer_train_df =
-00016320: 2070 642e 7265 6164 5f63 7376 2874 7261   pd.read_csv(tra
-00016330: 6e73 6665 725f 7472 6169 6e5f 7061 7468  nsfer_train_path
-00016340: 2c20 7365 703d 225c 7422 290a 2020 2020  , sep="\t").    
-00016350: 2020 2020 2020 2020 7472 616e 7366 6572          transfer
-00016360: 5f74 7261 696e 5f64 6620 3d20 7472 616e  _train_df = tran
-00016370: 7366 6572 5f74 7261 696e 5f64 665b 5b22  sfer_train_df[["
-00016380: 7061 7274 6963 6970 616e 745f 6964 222c  participant_id",
-00016390: 2022 7365 7373 696f 6e5f 6964 225d 5d0a   "session_id"]].
-000163a0: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-000163b0: 6e5f 6466 203d 2070 642e 636f 6e63 6174  n_df = pd.concat
-000163c0: 285b 7472 6169 6e5f 6466 2c20 7472 616e  ([train_df, tran
-000163d0: 7366 6572 5f74 7261 696e 5f64 665d 290a  sfer_train_df]).
-000163e0: 2020 2020 2020 2020 2020 2020 7472 6169              trai
-000163f0: 6e5f 6466 2e64 726f 705f 6475 706c 6963  n_df.drop_duplic
-00016400: 6174 6573 2869 6e70 6c61 6365 3d54 7275  ates(inplace=Tru
-00016410: 6529 0a20 2020 2020 2020 2074 7261 696e  e).        train
-00016420: 5f64 662e 746f 5f63 7376 280a 2020 2020  _df.to_csv(.    
-00016430: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
-00016440: 735f 7061 7468 202f 2022 6772 6f75 7073  s_path / "groups
-00016450: 2220 2f20 2274 7261 696e 2b76 616c 6964  " / "train+valid
-00016460: 6174 696f 6e2e 7473 7622 2c20 7365 703d  ation.tsv", sep=
-00016470: 225c 7422 2c20 696e 6465 783d 4661 6c73  "\t", index=Fals
-00016480: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
-00016490: 2064 6566 205f 7772 6974 655f 6461 7461   def _write_data
-000164a0: 5f67 726f 7570 280a 2020 2020 2020 2020  _group(.        
-000164b0: 7365 6c66 2c0a 2020 2020 2020 2020 6461  self,.        da
-000164c0: 7461 5f67 726f 7570 2c0a 2020 2020 2020  ta_group,.      
-000164d0: 2020 6466 2c0a 2020 2020 2020 2020 6361    df,.        ca
-000164e0: 7073 5f64 6972 6563 746f 7279 3a20 5061  ps_directory: Pa
-000164f0: 7468 203d 204e 6f6e 652c 0a20 2020 2020  th = None,.     
-00016500: 2020 206d 756c 7469 5f63 6f68 6f72 743a     multi_cohort:
-00016510: 2062 6f6f 6c20 3d20 4e6f 6e65 2c0a 2020   bool = None,.  
-00016520: 2020 2020 2020 6c61 6265 6c3d 4e6f 6e65        label=None
-00016530: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00016540: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
-00016550: 636b 2074 6861 7420 6120 6461 7461 5f67  ck that a data_g
-00016560: 726f 7570 2069 7320 6e6f 7420 616c 7265  roup is not alre
-00016570: 6164 7920 7772 6974 7465 6e20 616e 6420  ady written and 
-00016580: 7772 6974 6573 2074 6865 2063 6861 7261  writes the chara
-00016590: 6374 6572 6973 7469 6373 206f 6620 7468  cteristics of th
-000165a0: 6520 6461 7461 2067 726f 7570 0a20 2020  e data group.   
-000165b0: 2020 2020 2028 5453 5620 6669 6c65 2077       (TSV file w
-000165c0: 6974 6820 6120 6c69 7374 206f 6620 7061  ith a list of pa
-000165d0: 7274 6963 6970 616e 7420 2f20 7365 7373  rticipant / sess
-000165e0: 696f 6e20 2b20 4a53 4f4e 2066 696c 6520  ion + JSON file 
-000165f0: 636f 6e74 6169 6e69 6e67 2074 6865 2043  containing the C
-00016600: 4150 5320 616e 6420 7468 6520 7072 6570  APS and the prep
-00016610: 726f 6365 7373 696e 6729 2e0a 0a20 2020  rocessing)...   
-00016620: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-00016630: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
-00016640: 7020 2873 7472 293a 206e 616d 6520 7768  p (str): name wh
-00016650: 6f73 6520 7072 6573 656e 6365 2069 7320  ose presence is 
-00016660: 6368 6563 6b65 642e 0a20 2020 2020 2020  checked..       
-00016670: 2020 2020 2064 6620 2870 642e 4461 7461       df (pd.Data
-00016680: 4672 616d 6529 3a20 4461 7461 4672 616d  Frame): DataFram
-00016690: 6520 636f 6e74 6169 6e69 6e67 2074 6865  e containing the
-000166a0: 2070 6172 7469 6369 7061 6e74 5f69 6420   participant_id 
-000166b0: 616e 6420 7365 7373 696f 6e5f 6964 2028  and session_id (
-000166c0: 616e 6420 6c61 6265 6c20 6966 2075 7365  and label if use
-000166d0: 5f6c 6162 656c 7320 6973 2054 7275 6529  _labels is True)
-000166e0: 0a20 2020 2020 2020 2020 2020 2063 6170  .            cap
-000166f0: 735f 6469 7265 6374 6f72 7920 2873 7472  s_directory (str
-00016700: 293a 2063 6170 735f 6469 7265 6374 6f72  ): caps_director
-00016710: 7920 6966 2064 6966 6665 7265 6e74 2066  y if different f
-00016720: 726f 6d20 7468 6520 7472 6169 6e69 6e67  rom the training
-00016730: 2063 6170 735f 6469 7265 6374 6f72 792c   caps_directory,
-00016740: 0a20 2020 2020 2020 2020 2020 206d 756c  .            mul
-00016750: 7469 5f63 6f68 6f72 7420 2862 6f6f 6c29  ti_cohort (bool)
-00016760: 3a20 6d75 6c74 695f 636f 686f 7274 2075  : multi_cohort u
-00016770: 7365 6420 6966 2064 6966 6665 7265 6e74  sed if different
-00016780: 2066 726f 6d20 7468 6520 7472 6169 6e69   from the traini
-00016790: 6e67 206d 756c 7469 5f63 6f68 6f72 742e  ng multi_cohort.
-000167a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000167b0: 2020 2020 2067 726f 7570 5f70 6174 6820       group_path 
-000167c0: 3d20 7365 6c66 2e6d 6170 735f 7061 7468  = self.maps_path
-000167d0: 202f 2022 6772 6f75 7073 2220 2f20 6461   / "groups" / da
-000167e0: 7461 5f67 726f 7570 0a20 2020 2020 2020  ta_group.       
-000167f0: 2067 726f 7570 5f70 6174 682e 6d6b 6469   group_path.mkdi
-00016800: 7228 7061 7265 6e74 733d 5472 7565 290a  r(parents=True).
-00016810: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-00016820: 203d 205b 2270 6172 7469 6369 7061 6e74   = ["participant
-00016830: 5f69 6422 2c20 2273 6573 7369 6f6e 5f69  _id", "session_i
-00016840: 6422 2c20 2263 6f68 6f72 7422 5d0a 2020  d", "cohort"].  
-00016850: 2020 2020 2020 6966 2073 656c 662e 6c61        if self.la
-00016860: 6265 6c20 696e 2064 662e 636f 6c75 6d6e  bel in df.column
-00016870: 732e 7661 6c75 6573 3a0a 2020 2020 2020  s.values:.      
-00016880: 2020 2020 2020 636f 6c75 6d6e 7320 2b3d        columns +=
-00016890: 205b 7365 6c66 2e6c 6162 656c 5d0a 2020   [self.label].  
-000168a0: 2020 2020 2020 6966 206c 6162 656c 2069        if label i
-000168b0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206c  s not None and l
-000168c0: 6162 656c 2069 6e20 6466 2e63 6f6c 756d  abel in df.colum
-000168d0: 6e73 2e76 616c 7565 733a 0a20 2020 2020  ns.values:.     
-000168e0: 2020 2020 2020 2063 6f6c 756d 6e73 202b         columns +
-000168f0: 3d20 5b6c 6162 656c 5d0a 0a20 2020 2020  = [label]..     
-00016900: 2020 2064 662e 746f 5f63 7376 2867 726f     df.to_csv(gro
-00016910: 7570 5f70 6174 6820 2f20 2264 6174 612e  up_path / "data.
-00016920: 7473 7622 2c20 7365 703d 225c 7422 2c20  tsv", sep="\t", 
-00016930: 636f 6c75 6d6e 733d 636f 6c75 6d6e 732c  columns=columns,
-00016940: 2069 6e64 6578 3d46 616c 7365 290a 2020   index=False).  
-00016950: 2020 2020 2020 7365 6c66 2e77 7269 7465        self.write
-00016960: 5f70 6172 616d 6574 6572 7328 0a20 2020  _parameters(.   
-00016970: 2020 2020 2020 2020 2067 726f 7570 5f70           group_p
-00016980: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00016990: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000169a0: 2020 2022 6361 7073 5f64 6972 6563 746f     "caps_directo
-000169b0: 7279 223a 2028 0a20 2020 2020 2020 2020  ry": (.         
-000169c0: 2020 2020 2020 2020 2020 2063 6170 735f             caps_
-000169d0: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
-000169e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000169f0: 2063 6170 735f 6469 7265 6374 6f72 7920   caps_directory 
-00016a00: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00016a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a20: 656c 7365 2073 656c 662e 6361 7073 5f64  else self.caps_d
-00016a30: 6972 6563 746f 7279 0a20 2020 2020 2020  irectory.       
-00016a40: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00016a50: 2020 2020 2020 2020 2020 2020 226d 756c              "mul
-00016a60: 7469 5f63 6f68 6f72 7422 3a20 280a 2020  ti_cohort": (.  
-00016a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a80: 2020 6d75 6c74 695f 636f 686f 7274 2069    multi_cohort i
-00016a90: 6620 6d75 6c74 695f 636f 686f 7274 2069  f multi_cohort i
-00016aa0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-00016ab0: 7365 6c66 2e6d 756c 7469 5f63 6f68 6f72  self.multi_cohor
-00016ac0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00016ad0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00016ae0: 207d 2c0a 2020 2020 2020 2020 290a 0a20   },.        ).. 
-00016af0: 2020 2064 6566 205f 7772 6974 655f 7472     def _write_tr
-00016b00: 6169 6e5f 7661 6c5f 6772 6f75 7073 2873  ain_val_groups(s
-00016b10: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00016b20: 2244 6566 696e 6573 2074 6865 2074 7261  "Defines the tra
-00016b30: 696e 696e 6720 616e 6420 7661 6c69 6461  ining and valida
-00016b40: 7469 6f6e 2067 726f 7570 7320 6174 2074  tion groups at t
-00016b50: 6865 2069 6e69 7469 616c 697a 6174 696f  he initializatio
-00016b60: 6e22 2222 0a20 2020 2020 2020 206c 6f67  n""".        log
-00016b70: 6765 722e 6465 6275 6728 2257 7269 7469  ger.debug("Writi
-00016b80: 6e67 2074 7261 696e 696e 6720 616e 6420  ng training and 
-00016b90: 7661 6c69 6461 7469 6f6e 2067 726f 7570  validation group
-00016ba0: 732e 2e2e 2229 0a20 2020 2020 2020 2073  s...").        s
-00016bb0: 706c 6974 5f6d 616e 6167 6572 203d 2073  plit_manager = s
-00016bc0: 656c 662e 5f69 6e69 745f 7370 6c69 745f  elf._init_split_
-00016bd0: 6d61 6e61 6765 7228 290a 2020 2020 2020  manager().      
-00016be0: 2020 666f 7220 7370 6c69 7420 696e 2073    for split in s
-00016bf0: 706c 6974 5f6d 616e 6167 6572 2e73 706c  plit_manager.spl
-00016c00: 6974 5f69 7465 7261 746f 7228 293a 0a20  it_iterator():. 
-00016c10: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-00016c20: 6174 615f 6772 6f75 7020 696e 205b 2274  ata_group in ["t
-00016c30: 7261 696e 222c 2022 7661 6c69 6461 7469  rain", "validati
-00016c40: 6f6e 225d 3a0a 2020 2020 2020 2020 2020  on"]:.          
-00016c50: 2020 2020 2020 6466 203d 2073 706c 6974        df = split
-00016c60: 5f6d 616e 6167 6572 5b73 706c 6974 5d5b  _manager[split][
-00016c70: 6461 7461 5f67 726f 7570 5d0a 2020 2020  data_group].    
-00016c80: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00016c90: 705f 7061 7468 203d 2028 0a20 2020 2020  p_path = (.     
-00016ca0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016cb0: 656c 662e 6d61 7073 5f70 6174 680a 2020  elf.maps_path.  
-00016cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cd0: 2020 2f20 2267 726f 7570 7322 0a20 2020    / "groups".   
-00016ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cf0: 202f 2064 6174 615f 6772 6f75 700a 2020   / data_group.  
-00016d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d10: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
-00016d20: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
-00016d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016d40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00016d50: 2020 2067 726f 7570 5f70 6174 682e 6d6b     group_path.mk
-00016d60: 6469 7228 7061 7265 6e74 733d 5472 7565  dir(parents=True
-00016d70: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
-00016d80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016d90: 2020 636f 6c75 6d6e 7320 3d20 5b22 7061    columns = ["pa
-00016da0: 7274 6963 6970 616e 745f 6964 222c 2022  rticipant_id", "
-00016db0: 7365 7373 696f 6e5f 6964 222c 2022 636f  session_id", "co
-00016dc0: 686f 7274 225d 0a20 2020 2020 2020 2020  hort"].         
-00016dd0: 2020 2020 2020 2069 6620 7365 6c66 2e6c         if self.l
-00016de0: 6162 656c 2069 7320 6e6f 7420 4e6f 6e65  abel is not None
-00016df0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016e00: 2020 2020 2020 636f 6c75 6d6e 732e 6170        columns.ap
-00016e10: 7065 6e64 2873 656c 662e 6c61 6265 6c29  pend(self.label)
-00016e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016e30: 2064 662e 746f 5f63 7376 2867 726f 7570   df.to_csv(group
-00016e40: 5f70 6174 6820 2f20 2264 6174 612e 7473  _path / "data.ts
-00016e50: 7622 2c20 7365 703d 225c 7422 2c20 636f  v", sep="\t", co
-00016e60: 6c75 6d6e 733d 636f 6c75 6d6e 7329 0a20  lumns=columns). 
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016e80: 656c 662e 7772 6974 655f 7061 7261 6d65  elf.write_parame
-00016e90: 7465 7273 280a 2020 2020 2020 2020 2020  ters(.          
-00016ea0: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-00016eb0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00016ec0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00016ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ee0: 2020 2020 2263 6170 735f 6469 7265 6374      "caps_direct
-00016ef0: 6f72 7922 3a20 7365 6c66 2e63 6170 735f  ory": self.caps_
-00016f00: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
-00016f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f20: 2020 2022 6d75 6c74 695f 636f 686f 7274     "multi_cohort
-00016f30: 223a 2073 656c 662e 6d75 6c74 695f 636f  ": self.multi_co
-00016f40: 686f 7274 2c0a 2020 2020 2020 2020 2020  hort,.          
-00016f50: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00016f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f70: 2076 6572 626f 7365 3d46 616c 7365 2c0a   verbose=False,.
-00016f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f90: 290a 0a20 2020 2064 6566 205f 7772 6974  )..    def _writ
-00016fa0: 655f 7765 6967 6874 7328 0a20 2020 2020  e_weights(.     
-00016fb0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00016fc0: 2073 7461 7465 3a20 4469 6374 5b73 7472   state: Dict[str
-00016fd0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00016fe0: 6d65 7472 6963 735f 6469 6374 3a20 4f70  metrics_dict: Op
-00016ff0: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
-00017000: 2062 6f6f 6c5d 5d2c 0a20 2020 2020 2020   bool]],.       
-00017010: 2073 706c 6974 3a20 696e 742c 0a20 2020   split: int,.   
-00017020: 2020 2020 206e 6574 776f 726b 3a20 696e       network: in
-00017030: 7420 3d20 4e6f 6e65 2c0a 2020 2020 2020  t = None,.      
-00017040: 2020 6669 6c65 6e61 6d65 3a20 7374 7220    filename: str 
-00017050: 3d20 2263 6865 636b 706f 696e 742e 7074  = "checkpoint.pt
-00017060: 682e 7461 7222 2c0a 2020 2020 2020 2020  h.tar",.        
-00017070: 7361 7665 5f61 6c6c 5f6d 6f64 656c 733a  save_all_models:
-00017080: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00017090: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-000170a0: 220a 2020 2020 2020 2020 5570 6461 7465  ".        Update
-000170b0: 2063 6865 636b 706f 696e 7420 616e 6420   checkpoint and 
-000170c0: 7361 7665 2074 6865 2062 6573 7420 6d6f  save the best mo
-000170d0: 6465 6c20 6163 636f 7264 696e 6720 746f  del according to
-000170e0: 2061 2073 6574 206f 6620 6d65 7472 6963   a set of metric
-000170f0: 732e 0a20 2020 2020 2020 2049 6620 6e6f  s..        If no
-00017100: 206d 6574 7269 6373 5f64 6963 7420 6973   metrics_dict is
-00017110: 2067 6976 656e 2c20 6f6e 6c79 2074 6865   given, only the
-00017120: 2063 6865 636b 706f 696e 7420 6973 2073   checkpoint is s
-00017130: 6176 6564 2e0a 0a20 2020 2020 2020 2041  aved...        A
-00017140: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00017150: 2073 7461 7465 3a20 7374 6174 6520 6f66   state: state of
-00017160: 2074 6865 2074 7261 696e 696e 6720 286d   the training (m
-00017170: 6f64 656c 2077 6569 6768 7473 2c20 6570  odel weights, ep
-00017180: 6f63 682e 2e2e 292e 0a20 2020 2020 2020  och...)..       
-00017190: 2020 2020 206d 6574 7269 6373 5f64 6963       metrics_dic
-000171a0: 743a 206f 7574 7075 7420 6f66 2052 6574  t: output of Ret
-000171b0: 6169 6e42 6573 7420 7374 6570 2e0a 2020  ainBest step..  
-000171c0: 2020 2020 2020 2020 2020 7370 6c69 743a            split:
-000171d0: 2073 706c 6974 206e 756d 6265 722e 0a20   split number.. 
-000171e0: 2020 2020 2020 2020 2020 206e 6574 776f             netwo
-000171f0: 726b 3a20 6e65 7477 6f72 6b20 6e75 6d62  rk: network numb
-00017200: 6572 2028 6d75 6c74 692d 6e65 7477 6f72  er (multi-networ
-00017210: 6b20 6672 616d 6577 6f72 6b29 2e0a 2020  k framework)..  
-00017220: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00017230: 6d65 3a20 6e61 6d65 206f 6620 7468 6520  me: name of the 
-00017240: 6368 6563 6b70 6f69 6e74 2066 696c 652e  checkpoint file.
-00017250: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00017260: 2020 2020 2063 6865 636b 706f 696e 745f       checkpoint_
-00017270: 6469 7220 3d20 7365 6c66 2e6d 6170 735f  dir = self.maps_
-00017280: 7061 7468 202f 2066 227b 7365 6c66 2e73  path / f"{self.s
-00017290: 706c 6974 5f6e 616d 657d 2d7b 7370 6c69  plit_name}-{spli
-000172a0: 747d 2220 2f20 2274 6d70 220a 2020 2020  t}" / "tmp".    
-000172b0: 2020 2020 6368 6563 6b70 6f69 6e74 5f64      checkpoint_d
-000172c0: 6972 2e6d 6b64 6972 2870 6172 656e 7473  ir.mkdir(parents
-000172d0: 3d54 7275 652c 2065 7869 7374 5f6f 6b3d  =True, exist_ok=
-000172e0: 5472 7565 290a 2020 2020 2020 2020 6368  True).        ch
-000172f0: 6563 6b70 6f69 6e74 5f70 6174 6820 3d20  eckpoint_path = 
-00017300: 6368 6563 6b70 6f69 6e74 5f64 6972 202f  checkpoint_dir /
-00017310: 2066 696c 656e 616d 650a 2020 2020 2020   filename.      
-00017320: 2020 746f 7263 682e 7361 7665 2873 7461    torch.save(sta
-00017330: 7465 2c20 6368 6563 6b70 6f69 6e74 5f70  te, checkpoint_p
-00017340: 6174 6829 0a0a 2020 2020 2020 2020 6966  ath)..        if
-00017350: 2073 6176 655f 616c 6c5f 6d6f 6465 6c73   save_all_models
-00017360: 3a0a 2020 2020 2020 2020 2020 2020 616c  :.            al
-00017370: 6c5f 6d6f 6465 6c73 5f64 6972 203d 2028  l_models_dir = (
-00017380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017390: 2073 656c 662e 6d61 7073 5f70 6174 6820   self.maps_path 
-000173a0: 2f20 6622 7b73 656c 662e 7370 6c69 745f  / f"{self.split_
-000173b0: 6e61 6d65 7d2d 7b73 706c 6974 7d22 202f  name}-{split}" /
-000173c0: 2022 616c 6c5f 6d6f 6465 6c73 220a 2020   "all_models".  
-000173d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000173e0: 2020 2020 2020 2020 616c 6c5f 6d6f 6465          all_mode
-000173f0: 6c73 5f64 6972 2e6d 6b64 6972 2870 6172  ls_dir.mkdir(par
-00017400: 656e 7473 3d54 7275 652c 2065 7869 7374  ents=True, exist
-00017410: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-00017420: 2020 2020 2020 746f 7263 682e 7361 7665        torch.save
-00017430: 2873 7461 7465 2c20 616c 6c5f 6d6f 6465  (state, all_mode
-00017440: 6c73 5f64 6972 202f 2066 226d 6f64 656c  ls_dir / f"model
-00017450: 5f65 706f 6368 5f7b 7374 6174 655b 2765  _epoch_{state['e
-00017460: 706f 6368 275d 7d2e 7074 682e 7461 7222  poch']}.pth.tar"
-00017470: 290a 0a20 2020 2020 2020 2062 6573 745f  )..        best_
-00017480: 6669 6c65 6e61 6d65 203d 2022 6d6f 6465  filename = "mode
-00017490: 6c2e 7074 682e 7461 7222 0a20 2020 2020  l.pth.tar".     
-000174a0: 2020 2069 6620 6e65 7477 6f72 6b20 6973     if network is
-000174b0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000174c0: 2020 2020 2020 2062 6573 745f 6669 6c65         best_file
-000174d0: 6e61 6d65 203d 2066 226e 6574 776f 726b  name = f"network
-000174e0: 2d7b 6e65 7477 6f72 6b7d 5f6d 6f64 656c  -{network}_model
-000174f0: 2e70 7468 2e74 6172 220a 0a20 2020 2020  .pth.tar"..     
-00017500: 2020 2023 2053 6176 6520 6d6f 6465 6c20     # Save model 
-00017510: 6163 636f 7264 696e 6720 746f 2073 6576  according to sev
-00017520: 6572 616c 206d 6574 7269 6373 0a20 2020  eral metrics.   
-00017530: 2020 2020 2069 6620 6d65 7472 6963 735f       if metrics_
-00017540: 6469 6374 2069 7320 6e6f 7420 4e6f 6e65  dict is not None
-00017550: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00017560: 7220 6d65 7472 6963 5f6e 616d 652c 206d  r metric_name, m
-00017570: 6574 7269 635f 626f 6f6c 2069 6e20 6d65  etric_bool in me
-00017580: 7472 6963 735f 6469 6374 2e69 7465 6d73  trics_dict.items
-00017590: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000175a0: 2020 2020 6d65 7472 6963 5f70 6174 6820      metric_path 
-000175b0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-000175c0: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
-000175d0: 735f 7061 7468 0a20 2020 2020 2020 2020  s_path.         
-000175e0: 2020 2020 2020 2020 2020 202f 2066 227b             / f"{
-000175f0: 7365 6c66 2e73 706c 6974 5f6e 616d 657d  self.split_name}
-00017600: 2d7b 7370 6c69 747d 220a 2020 2020 2020  -{split}".      
-00017610: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-00017620: 6622 6265 7374 2d7b 6d65 7472 6963 5f6e  f"best-{metric_n
-00017630: 616d 657d 220a 2020 2020 2020 2020 2020  ame}".          
-00017640: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00017650: 2020 2020 2020 2020 6966 206d 6574 7269          if metri
-00017660: 635f 626f 6f6c 3a0a 2020 2020 2020 2020  c_bool:.        
-00017670: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
-00017680: 6963 5f70 6174 682e 6d6b 6469 7228 7061  ic_path.mkdir(pa
-00017690: 7265 6e74 733d 5472 7565 2c20 6578 6973  rents=True, exis
-000176a0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-000176b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000176c0: 6875 7469 6c2e 636f 7079 6669 6c65 2863  hutil.copyfile(c
-000176d0: 6865 636b 706f 696e 745f 7061 7468 2c20  heckpoint_path, 
-000176e0: 6d65 7472 6963 5f70 6174 6820 2f20 6265  metric_path / be
-000176f0: 7374 5f66 696c 656e 616d 6529 0a0a 2020  st_filename)..  
-00017700: 2020 6465 6620 5f77 7269 7465 5f69 6e66    def _write_inf
-00017710: 6f72 6d61 7469 6f6e 2873 656c 6629 3a0a  ormation(self):.
-00017720: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00017730: 2020 2020 5772 6974 6573 206d 6f64 656c      Writes model
-00017740: 2061 7263 6869 7465 6374 7572 6520 6f66   architecture of
-00017750: 2074 6865 204d 4150 5320 696e 204d 4150   the MAPS in MAP
-00017760: 5320 726f 6f74 2e0a 2020 2020 2020 2020  S root..        
-00017770: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
-00017780: 2064 6174 6574 696d 6520 696d 706f 7274   datetime import
-00017790: 2064 6174 6574 696d 650a 0a20 2020 2020   datetime..     
-000177a0: 2020 2069 6d70 6f72 7420 636c 696e 6963     import clinic
-000177b0: 6164 6c2e 7574 696c 732e 6e65 7477 6f72  adl.utils.networ
-000177c0: 6b20 6173 206e 6574 776f 726b 5f70 6163  k as network_pac
-000177d0: 6b61 6765 0a0a 2020 2020 2020 2020 6d6f  kage..        mo
-000177e0: 6465 6c5f 636c 6173 7320 3d20 6765 7461  del_class = geta
-000177f0: 7474 7228 6e65 7477 6f72 6b5f 7061 636b  ttr(network_pack
-00017800: 6167 652c 2073 656c 662e 6172 6368 6974  age, self.archit
-00017810: 6563 7475 7265 290a 2020 2020 2020 2020  ecture).        
-00017820: 6172 6773 203d 206c 6973 7428 0a20 2020  args = list(.   
-00017830: 2020 2020 2020 2020 206d 6f64 656c 5f63           model_c
-00017840: 6c61 7373 2e5f 5f69 6e69 745f 5f2e 5f5f  lass.__init__.__
-00017850: 636f 6465 5f5f 2e63 6f5f 7661 726e 616d  code__.co_varnam
-00017860: 6573 5b0a 2020 2020 2020 2020 2020 2020  es[.            
-00017870: 2020 2020 3a20 6d6f 6465 6c5f 636c 6173      : model_clas
-00017880: 732e 5f5f 696e 6974 5f5f 2e5f 5f63 6f64  s.__init__.__cod
-00017890: 655f 5f2e 636f 5f61 7267 636f 756e 740a  e__.co_argcount.
-000178a0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000178b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000178c0: 6172 6773 2e72 656d 6f76 6528 2273 656c  args.remove("sel
-000178d0: 6622 290a 2020 2020 2020 2020 6b77 6172  f").        kwar
-000178e0: 6773 203d 2064 6963 7428 290a 2020 2020  gs = dict().    
-000178f0: 2020 2020 666f 7220 6172 6720 696e 2061      for arg in a
-00017900: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00017910: 206b 7761 7267 735b 6172 675d 203d 2073   kwargs[arg] = s
-00017920: 656c 662e 7061 7261 6d65 7465 7273 5b61  elf.parameters[a
-00017930: 7267 5d0a 2020 2020 2020 2020 6b77 6172  rg].        kwar
-00017940: 6773 5b22 6770 7522 5d20 3d20 4661 6c73  gs["gpu"] = Fals
-00017950: 650a 0a20 2020 2020 2020 206d 6f64 656c  e..        model
-00017960: 203d 206d 6f64 656c 5f63 6c61 7373 282a   = model_class(*
-00017970: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
-00017980: 2020 6669 6c65 5f6e 616d 6520 3d20 2269    file_name = "i
-00017990: 6e66 6f72 6d61 7469 6f6e 2e6c 6f67 220a  nformation.log".
-000179a0: 0a20 2020 2020 2020 2077 6974 6820 2873  .        with (s
-000179b0: 656c 662e 6d61 7073 5f70 6174 6820 2f20  elf.maps_path / 
-000179c0: 6669 6c65 5f6e 616d 6529 2e6f 7065 6e28  file_name).open(
-000179d0: 6d6f 6465 3d22 7722 2920 6173 2066 3a0a  mode="w") as f:.
-000179e0: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
-000179f0: 6974 6528 6622 2d20 4461 7465 203a 5c74  ite(f"- Date :\t
-00017a00: 7b64 6174 6574 696d 652e 6e6f 7728 292e  {datetime.now().
-00017a10: 7374 7266 7469 6d65 2827 2564 2025 6220  strftime('%d %b 
-00017a20: 2559 2c20 2548 3a25 4d3a 2553 2729 7d5c  %Y, %H:%M:%S')}\
-00017a30: 6e5c 6e22 290a 2020 2020 2020 2020 2020  n\n").          
-00017a40: 2020 662e 7772 6974 6528 6622 2d20 5061    f.write(f"- Pa
-00017a50: 7468 203a 5c74 7b73 656c 662e 6d61 7073  th :\t{self.maps
-00017a60: 5f70 6174 687d 5c6e 5c6e 2229 0a20 2020  _path}\n\n").   
-00017a70: 2020 2020 2020 2020 2023 2066 2e77 7269           # f.wri
-00017a80: 7465 2822 2d20 4a6f 6220 4944 203a 5c74  te("- Job ID :\t
-00017a90: 7b7d 5c6e 222e 666f 726d 6174 286f 732e  {}\n".format(os.
-00017aa0: 6765 7465 6e76 2827 534c 5552 4d5f 4a4f  getenv('SLURM_JO
-00017ab0: 4249 4427 2929 290a 2020 2020 2020 2020  BID'))).        
-00017ac0: 2020 2020 662e 7772 6974 6528 6622 2d20      f.write(f"- 
-00017ad0: 4d6f 6465 6c20 3a5c 747b 6d6f 6465 6c2e  Model :\t{model.
-00017ae0: 6c61 7965 7273 7d5c 6e5c 6e22 290a 0a20  layers}\n\n").. 
-00017af0: 2020 2020 2020 2064 656c 206d 6f64 656c         del model
-00017b00: 0a0a 2020 2020 6465 6620 5f65 7261 7365  ..    def _erase
-00017b10: 5f74 6d70 2873 656c 662c 2073 706c 6974  _tmp(self, split
-00017b20: 293a 0a20 2020 2020 2020 2022 2222 4572  ):.        """Er
-00017b30: 6173 6520 6368 6563 6b70 6f69 6e74 7320  ase checkpoints 
-00017b40: 6f66 2074 6865 206d 6f64 656c 2061 6e64  of the model and
-00017b50: 206f 7074 696d 697a 6572 2061 7420 7468   optimizer at th
-00017b60: 6520 656e 6420 6f66 2074 7261 696e 696e  e end of trainin
-00017b70: 672e 2222 220a 2020 2020 2020 2020 746d  g.""".        tm
-00017b80: 705f 7061 7468 203d 2073 656c 662e 6d61  p_path = self.ma
-00017b90: 7073 5f70 6174 6820 2f20 6622 7b73 656c  ps_path / f"{sel
-00017ba0: 662e 7370 6c69 745f 6e61 6d65 7d2d 7b73  f.split_name}-{s
-00017bb0: 706c 6974 7d22 202f 2022 746d 7022 0a20  plit}" / "tmp". 
-00017bc0: 2020 2020 2020 2073 6875 7469 6c2e 726d         shutil.rm
-00017bd0: 7472 6565 2874 6d70 5f70 6174 6829 0a0a  tree(tmp_path)..
-00017be0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00017bf0: 640a 2020 2020 6465 6620 7772 6974 655f  d.    def write_
-00017c00: 6465 7363 7269 7074 696f 6e5f 6c6f 6728  description_log(
-00017c10: 0a20 2020 2020 2020 206c 6f67 5f64 6972  .        log_dir
-00017c20: 3a20 5061 7468 2c0a 2020 2020 2020 2020  : Path,.        
-00017c30: 6461 7461 5f67 726f 7570 2c0a 2020 2020  data_group,.    
-00017c40: 2020 2020 6361 7073 5f64 6963 742c 0a20      caps_dict,. 
-00017c50: 2020 2020 2020 2064 662c 0a20 2020 2029         df,.    )
-00017c60: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00017c70: 2020 2020 2020 5772 6974 6520 6465 7363        Write desc
-00017c80: 7269 7074 696f 6e20 6c6f 6720 6669 6c65  ription log file
-00017c90: 2061 7373 6f63 6961 7465 6420 746f 2061   associated to a
-00017ca0: 2064 6174 6120 6772 6f75 702e 0a0a 2020   data group...  
-00017cb0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00017cc0: 2020 2020 2020 2020 6c6f 675f 6469 7220          log_dir 
-00017cd0: 2873 7472 293a 2070 6174 6820 746f 2074  (str): path to t
-00017ce0: 6865 206c 6f67 2066 696c 6520 6469 7265  he log file dire
-00017cf0: 6374 6f72 792e 0a20 2020 2020 2020 2020  ctory..         
-00017d00: 2020 2064 6174 615f 6772 6f75 7020 2873     data_group (s
-00017d10: 7472 293a 206e 616d 6520 6f66 2074 6865  tr): name of the
-00017d20: 2064 6174 6120 6772 6f75 7020 7573 6564   data group used
-00017d30: 2066 6f72 2074 6865 2074 6173 6b2e 0a20   for the task.. 
-00017d40: 2020 2020 2020 2020 2020 2063 6170 735f             caps_
-00017d50: 6469 6374 2028 6469 6374 5b73 7472 2c20  dict (dict[str, 
-00017d60: 7374 725d 293a 2044 6963 7469 6f6e 6172  str]): Dictionar
-00017d70: 7920 6f66 2074 6865 2043 4150 5320 666f  y of the CAPS fo
-00017d80: 6c64 6572 7320 7573 6564 2066 6f72 2074  lders used for t
-00017d90: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
-00017da0: 2020 2020 6466 2028 7064 2e44 6174 6146      df (pd.DataF
-00017db0: 7261 6d65 293a 2044 6174 6146 7261 6d65  rame): DataFrame
-00017dc0: 206f 6620 7468 6520 6d65 7461 2d64 6174   of the meta-dat
-00017dd0: 6120 7573 6564 2066 6f72 2074 6865 2074  a used for the t
-00017de0: 6173 6b2e 0a20 2020 2020 2020 2022 2222  ask..        """
-00017df0: 0a20 2020 2020 2020 206c 6f67 5f64 6972  .        log_dir
-00017e00: 2e6d 6b64 6972 2870 6172 656e 7473 3d54  .mkdir(parents=T
-00017e10: 7275 652c 2065 7869 7374 5f6f 6b3d 5472  rue, exist_ok=Tr
-00017e20: 7565 290a 2020 2020 2020 2020 6c6f 675f  ue).        log_
-00017e30: 7061 7468 203d 206c 6f67 5f64 6972 202f  path = log_dir /
-00017e40: 2022 6465 7363 7269 7074 696f 6e2e 6c6f   "description.lo
-00017e50: 6722 0a20 2020 2020 2020 2077 6974 6820  g".        with 
-00017e60: 6c6f 675f 7061 7468 2e6f 7065 6e28 6d6f  log_path.open(mo
-00017e70: 6465 3d22 7722 2920 6173 2066 3a0a 2020  de="w") as f:.  
-00017e80: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-00017e90: 6528 6622 5072 6564 6963 7469 6f6e 207b  e(f"Prediction {
-00017ea0: 6461 7461 5f67 726f 7570 7d20 6772 6f75  data_group} grou
-00017eb0: 7020 2d20 7b64 6174 6574 696d 652e 6e6f  p - {datetime.no
-00017ec0: 7728 297d 5c6e 2229 0a20 2020 2020 2020  w()}\n").       
-00017ed0: 2020 2020 2066 2e77 7269 7465 2866 2244       f.write(f"D
-00017ee0: 6174 6120 6c6f 6164 6564 2066 726f 6d20  ata loaded from 
-00017ef0: 4341 5053 2064 6972 6563 746f 7269 6573  CAPS directories
-00017f00: 3a20 7b63 6170 735f 6469 6374 7d5c 6e22  : {caps_dict}\n"
-00017f10: 290a 2020 2020 2020 2020 2020 2020 662e  ).            f.
-00017f20: 7772 6974 6528 6622 4e75 6d62 6572 206f  write(f"Number o
-00017f30: 6620 7061 7274 6963 6970 616e 7473 3a20  f participants: 
-00017f40: 7b64 662e 7061 7274 6963 6970 616e 745f  {df.participant_
-00017f50: 6964 2e6e 756e 6971 7565 2829 7d5c 6e22  id.nunique()}\n"
-00017f60: 290a 2020 2020 2020 2020 2020 2020 662e  ).            f.
-00017f70: 7772 6974 6528 6622 4e75 6d62 6572 206f  write(f"Number o
-00017f80: 6620 7365 7373 696f 6e73 3a20 7b6c 656e  f sessions: {len
-00017f90: 2864 6629 7d5c 6e22 290a 0a20 2020 2064  (df)}\n")..    d
-00017fa0: 6566 205f 6d6f 6465 5f6c 6576 656c 5f74  ef _mode_level_t
-00017fb0: 6f5f 7473 7628 0a20 2020 2020 2020 2073  o_tsv(.        s
-00017fc0: 656c 662c 0a20 2020 2020 2020 2072 6573  elf,.        res
-00017fd0: 756c 7473 5f64 663a 2070 642e 4461 7461  ults_df: pd.Data
-00017fe0: 4672 616d 652c 0a20 2020 2020 2020 206d  Frame,.        m
-00017ff0: 6574 7269 6373 3a20 556e 696f 6e5b 4469  etrics: Union[Di
-00018000: 6374 2c20 7064 2e44 6174 6146 7261 6d65  ct, pd.DataFrame
-00018010: 5d2c 0a20 2020 2020 2020 2073 706c 6974  ],.        split
-00018020: 3a20 696e 742c 0a20 2020 2020 2020 2073  : int,.        s
-00018030: 656c 6563 7469 6f6e 3a20 7374 722c 0a20  election: str,. 
-00018040: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
-00018050: 703a 2073 7472 203d 2022 7472 6169 6e22  p: str = "train"
-00018060: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00018070: 2022 2222 0a20 2020 2020 2020 2057 7269   """.        Wri
-00018080: 7465 7320 7468 6520 6f75 7470 7574 7320  tes the outputs 
-00018090: 6f66 2074 6865 2074 6573 7420 6675 6e63  of the test func
-000180a0: 7469 6f6e 2069 6e20 7473 7620 6669 6c65  tion in tsv file
-000180b0: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
-000180c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000180d0: 7375 6c74 735f 6466 3a20 7468 6520 696e  sults_df: the in
-000180e0: 6469 7669 6475 616c 2072 6573 756c 7473  dividual results
-000180f0: 2070 6572 2070 6174 6368 2e0a 2020 2020   per patch..    
-00018100: 2020 2020 2020 2020 6d65 7472 6963 733a          metrics:
-00018110: 2074 6865 2070 6572 666f 726d 616e 6365   the performance
-00018120: 7320 6f62 7461 696e 6564 206f 6e20 6120  s obtained on a 
-00018130: 7365 7269 6573 206f 6620 6d65 7472 6963  series of metric
-00018140: 732e 0a20 2020 2020 2020 2020 2020 2073  s..            s
-00018150: 706c 6974 3a20 7468 6520 7370 6c69 7420  plit: the split 
-00018160: 666f 7220 7768 6963 6820 7468 6520 7065  for which the pe
-00018170: 7266 6f72 6d61 6e63 6573 2077 6572 6520  rformances were 
-00018180: 6f62 7461 696e 6564 2e0a 2020 2020 2020  obtained..      
-00018190: 2020 2020 2020 7365 6c65 6374 696f 6e3a        selection:
-000181a0: 2074 6865 206d 6574 7269 6373 206f 6e20   the metrics on 
-000181b0: 7768 6963 6820 7468 6520 6d6f 6465 6c20  which the model 
-000181c0: 7761 7320 7365 6c65 6374 6564 2028 4241  was selected (BA
-000181d0: 2c20 6c6f 7373 2e2e 2e29 0a20 2020 2020  , loss...).     
-000181e0: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
-000181f0: 703a 2074 6865 206e 616d 6520 7265 6665  p: the name refe
-00018200: 7272 696e 6720 746f 2074 6865 2064 6174  rring to the dat
-00018210: 6120 6772 6f75 7020 6f6e 2077 6869 6368  a group on which
-00018220: 2065 7661 6c75 6174 696f 6e20 6973 2070   evaluation is p
-00018230: 6572 666f 726d 6564 2e0a 2020 2020 2020  erformed..      
-00018240: 2020 2222 220a 2020 2020 2020 2020 7065    """.        pe
-00018250: 7266 6f72 6d61 6e63 655f 6469 7220 3d20  rformance_dir = 
-00018260: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00018270: 6c66 2e6d 6170 735f 7061 7468 0a20 2020  lf.maps_path.   
-00018280: 2020 2020 2020 2020 202f 2066 227b 7365           / f"{se
-00018290: 6c66 2e73 706c 6974 5f6e 616d 657d 2d7b  lf.split_name}-{
-000182a0: 7370 6c69 747d 220a 2020 2020 2020 2020  split}".        
-000182b0: 2020 2020 2f20 6622 6265 7374 2d7b 7365      / f"best-{se
-000182c0: 6c65 6374 696f 6e7d 220a 2020 2020 2020  lection}".      
-000182d0: 2020 2020 2020 2f20 6461 7461 5f67 726f        / data_gro
-000182e0: 7570 0a20 2020 2020 2020 2029 0a20 2020  up.        ).   
-000182f0: 2020 2020 2070 6572 666f 726d 616e 6365       performance
-00018300: 5f64 6972 2e6d 6b64 6972 2870 6172 656e  _dir.mkdir(paren
-00018310: 7473 3d54 7275 652c 2065 7869 7374 5f6f  ts=True, exist_o
-00018320: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
-00018330: 7065 7266 6f72 6d61 6e63 655f 7061 7468  performance_path
-00018340: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00018350: 2070 6572 666f 726d 616e 6365 5f64 6972   performance_dir
-00018360: 202f 2066 227b 6461 7461 5f67 726f 7570   / f"{data_group
-00018370: 7d5f 7b73 656c 662e 6d6f 6465 7d5f 6c65  }_{self.mode}_le
-00018380: 7665 6c5f 7072 6564 6963 7469 6f6e 2e74  vel_prediction.t
-00018390: 7376 220a 2020 2020 2020 2020 290a 2020  sv".        ).  
-000183a0: 2020 2020 2020 6966 206e 6f74 2070 6572        if not per
-000183b0: 666f 726d 616e 6365 5f70 6174 682e 6973  formance_path.is
-000183c0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-000183d0: 2020 2020 2072 6573 756c 7473 5f64 662e       results_df.
-000183e0: 746f 5f63 7376 2870 6572 666f 726d 616e  to_csv(performan
-000183f0: 6365 5f70 6174 682c 2069 6e64 6578 3d46  ce_path, index=F
-00018400: 616c 7365 2c20 7365 703d 225c 7422 290a  alse, sep="\t").
-00018410: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00018420: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00018430: 735f 6466 2e74 6f5f 6373 7628 0a20 2020  s_df.to_csv(.   
-00018440: 2020 2020 2020 2020 2020 2020 2070 6572               per
-00018450: 666f 726d 616e 6365 5f70 6174 682c 2069  formance_path, i
-00018460: 6e64 6578 3d46 616c 7365 2c20 7365 703d  ndex=False, sep=
-00018470: 225c 7422 2c20 6d6f 6465 3d22 6122 2c20  "\t", mode="a", 
-00018480: 6865 6164 6572 3d46 616c 7365 0a20 2020  header=False.   
-00018490: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000184a0: 2020 2020 6d65 7472 6963 735f 7061 7468      metrics_path
-000184b0: 203d 2070 6572 666f 726d 616e 6365 5f64   = performance_d
-000184c0: 6972 202f 2066 227b 6461 7461 5f67 726f  ir / f"{data_gro
-000184d0: 7570 7d5f 7b73 656c 662e 6d6f 6465 7d5f  up}_{self.mode}_
-000184e0: 6c65 7665 6c5f 6d65 7472 6963 732e 7473  level_metrics.ts
-000184f0: 7622 0a20 2020 2020 2020 2069 6620 6d65  v".        if me
-00018500: 7472 6963 7320 6973 206e 6f74 204e 6f6e  trics is not Non
-00018510: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00018520: 2069 6620 6461 7461 5f67 726f 7570 203d   if data_group =
-00018530: 3d20 2274 7261 696e 2220 6f72 2064 6174  = "train" or dat
-00018540: 615f 6772 6f75 7020 3d3d 2022 7661 6c69  a_group == "vali
-00018550: 6461 7469 6f6e 223a 0a20 2020 2020 2020  dation":.       
-00018560: 2020 2020 2023 2020 2020 2070 645f 6d65       #     pd_me
-00018570: 7472 6963 7320 3d20 7064 2e44 6174 6146  trics = pd.DataF
-00018580: 7261 6d65 286d 6574 7269 6373 2c20 696e  rame(metrics, in
-00018590: 6465 7820 3d20 5b30 5d29 0a20 2020 2020  dex = [0]).     
-000185a0: 2020 2020 2020 2023 2020 2020 2068 6561         #     hea
-000185b0: 6465 7220 3d20 5472 7565 0a20 2020 2020  der = True.     
-000185c0: 2020 2020 2020 2023 2065 6c73 653a 0a20         # else:. 
-000185d0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-000185e0: 2070 645f 6d65 7472 6963 7320 3d20 7064   pd_metrics = pd
-000185f0: 2e44 6174 6146 7261 6d65 286d 6574 7269  .DataFrame(metri
-00018600: 6373 292e 540a 2020 2020 2020 2020 2020  cs).T.          
-00018610: 2020 2320 2020 2020 6865 6164 6572 203d    #     header =
-00018620: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-00018630: 2020 2020 7064 5f6d 6574 7269 6373 203d      pd_metrics =
-00018640: 2070 642e 4461 7461 4672 616d 6528 6d65   pd.DataFrame(me
-00018650: 7472 6963 7329 2e54 0a20 2020 2020 2020  trics).T.       
-00018660: 2020 2020 2068 6561 6465 7220 3d20 4661       header = Fa
-00018670: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00018680: 2320 696d 706f 7274 2069 7064 623b 2069  # import ipdb; i
-00018690: 7064 622e 7365 745f 7472 6163 6528 290a  pdb.set_trace().
-000186a0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000186b0: 6f74 206d 6574 7269 6373 5f70 6174 682e  ot metrics_path.
-000186c0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-000186d0: 2020 2020 2020 2020 2020 2070 645f 6d65             pd_me
-000186e0: 7472 6963 732e 746f 5f63 7376 286d 6574  trics.to_csv(met
-000186f0: 7269 6373 5f70 6174 682c 2069 6e64 6578  rics_path, index
-00018700: 3d46 616c 7365 2c20 7365 703d 225c 7422  =False, sep="\t"
-00018710: 2c20 6865 6164 6572 3d68 6561 6465 7229  , header=header)
-00018720: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00018730: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00018740: 2020 2070 645f 6d65 7472 6963 732e 746f     pd_metrics.to
-00018750: 5f63 7376 280a 2020 2020 2020 2020 2020  _csv(.          
-00018760: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
-00018770: 735f 7061 7468 2c20 696e 6465 783d 4661  s_path, index=Fa
-00018780: 6c73 652c 2073 6570 3d22 5c74 222c 206d  lse, sep="\t", m
-00018790: 6f64 653d 2261 222c 2068 6561 6465 723d  ode="a", header=
-000187a0: 6865 6164 6572 0a20 2020 2020 2020 2020  header.         
-000187b0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000187c0: 6620 5f65 6e73 656d 626c 655f 746f 5f74  f _ensemble_to_t
-000187d0: 7376 280a 2020 2020 2020 2020 7365 6c66  sv(.        self
-000187e0: 2c0a 2020 2020 2020 2020 7370 6c69 743a  ,.        split:
-000187f0: 2069 6e74 2c0a 2020 2020 2020 2020 7365   int,.        se
-00018800: 6c65 6374 696f 6e3a 2073 7472 2c0a 2020  lection: str,.  
-00018810: 2020 2020 2020 6461 7461 5f67 726f 7570        data_group
-00018820: 3a20 7374 7220 3d20 2274 6573 7422 2c0a  : str = "test",.
-00018830: 2020 2020 2020 2020 7573 655f 6c61 6265          use_labe
-00018840: 6c73 3a20 626f 6f6c 203d 2054 7275 652c  ls: bool = True,
-00018850: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00018860: 2222 220a 2020 2020 2020 2020 5772 6974  """.        Writ
-00018870: 6573 2069 6d61 6765 2d6c 6576 656c 2070  es image-level p
-00018880: 6572 666f 726d 616e 6365 2066 696c 6573  erformance files
-00018890: 2066 726f 6d20 6d6f 6465 206c 6576 656c   from mode level
-000188a0: 2070 6572 666f 726d 616e 6365 732e 0a0a   performances...
-000188b0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-000188c0: 2020 2020 2020 2020 2020 7370 6c69 743a            split:
-000188d0: 2073 706c 6974 206e 756d 6265 7220 6f66   split number of
-000188e0: 2074 6865 2063 726f 7373 2d76 616c 6964   the cross-valid
-000188f0: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
-00018900: 2020 2073 656c 6563 7469 6f6e 3a20 6d65     selection: me
-00018910: 7472 6963 206f 6e20 7768 6963 6820 7468  tric on which th
-00018920: 6520 6d6f 6465 6c20 6973 2073 656c 6563  e model is selec
-00018930: 7465 6420 2866 6f72 2065 7861 6d70 6c65  ted (for example
-00018940: 206c 6f73 7320 6f72 2042 4129 2e0a 2020   loss or BA)..  
-00018950: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00018960: 726f 7570 3a20 7468 6520 6e61 6d65 2072  roup: the name r
-00018970: 6566 6572 7269 6e67 2074 6f20 7468 6520  eferring to the 
-00018980: 6461 7461 2067 726f 7570 206f 6e20 7768  data group on wh
-00018990: 6963 6820 6576 616c 7561 7469 6f6e 2069  ich evaluation i
-000189a0: 7320 7065 7266 6f72 6d65 642e 0a20 2020  s performed..   
-000189b0: 2020 2020 2020 2020 2020 2020 2049 6620               If 
-000189c0: 6469 6666 6572 656e 7420 6672 6f6d 2074  different from t
-000189d0: 7261 696e 696e 6720 6f72 2076 616c 6964  raining or valid
-000189e0: 6174 696f 6e2c 2074 6865 2077 6569 6768  ation, the weigh
-000189f0: 7473 206f 6620 736f 6674 2076 6f74 696e  ts of soft votin
-00018a00: 6720 7769 6c6c 2062 6520 636f 6d70 7574  g will be comput
-00018a10: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-00018a20: 2020 206f 6e20 7661 6c69 6461 7469 6f6e     on validation
-00018a30: 2061 6363 7572 6163 6965 732e 0a20 2020   accuracies..   
-00018a40: 2020 2020 2020 2020 2075 7365 5f6c 6162           use_lab
-00018a50: 656c 733a 2049 6620 5472 7565 2074 6865  els: If True the
-00018a60: 206c 6162 656c 7320 6172 6520 6164 6465   labels are adde
-00018a70: 6420 746f 2074 6865 2066 696e 616c 2074  d to the final t
-00018a80: 7376 0a20 2020 2020 2020 2022 2222 0a20  sv.        """. 
-00018a90: 2020 2020 2020 2023 2043 686f 6f73 6520         # Choose 
-00018aa0: 7768 6963 6820 6461 7461 7365 7420 6973  which dataset is
-00018ab0: 2075 7365 6420 746f 2063 6f6d 7075 7465   used to compute
-00018ac0: 2074 6865 2077 6569 6768 7473 206f 6620   the weights of 
-00018ad0: 736f 6674 2076 6f74 696e 672e 0a20 2020  soft voting..   
-00018ae0: 2020 2020 2069 6620 6461 7461 5f67 726f       if data_gro
-00018af0: 7570 2069 6e20 5b22 7472 6169 6e22 2c20  up in ["train", 
-00018b00: 2276 616c 6964 6174 696f 6e22 5d3a 0a20  "validation"]:. 
-00018b10: 2020 2020 2020 2020 2020 2076 616c 6964             valid
-00018b20: 6174 696f 6e5f 6461 7461 7365 7420 3d20  ation_dataset = 
-00018b30: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
-00018b40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018b50: 2020 2020 2076 616c 6964 6174 696f 6e5f       validation_
-00018b60: 6461 7461 7365 7420 3d20 2276 616c 6964  dataset = "valid
-00018b70: 6174 696f 6e22 0a20 2020 2020 2020 2074  ation".        t
-00018b80: 6573 745f 6466 203d 2073 656c 662e 6765  est_df = self.ge
-00018b90: 745f 7072 6564 6963 7469 6f6e 280a 2020  t_prediction(.  
-00018ba0: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00018bb0: 726f 7570 2c20 7370 6c69 742c 2073 656c  roup, split, sel
-00018bc0: 6563 7469 6f6e 2c20 7365 6c66 2e6d 6f64  ection, self.mod
-00018bd0: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
-00018be0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00018bf0: 2020 2076 616c 6964 6174 696f 6e5f 6466     validation_df
-00018c00: 203d 2073 656c 662e 6765 745f 7072 6564   = self.get_pred
-00018c10: 6963 7469 6f6e 280a 2020 2020 2020 2020  iction(.        
-00018c20: 2020 2020 7661 6c69 6461 7469 6f6e 5f64      validation_d
-00018c30: 6174 6173 6574 2c20 7370 6c69 742c 2073  ataset, split, s
-00018c40: 656c 6563 7469 6f6e 2c20 7365 6c66 2e6d  election, self.m
-00018c50: 6f64 652c 2076 6572 626f 7365 3d46 616c  ode, verbose=Fal
-00018c60: 7365 0a20 2020 2020 2020 2029 0a0a 2020  se.        )..  
-00018c70: 2020 2020 2020 7065 7266 6f72 6d61 6e63        performanc
-00018c80: 655f 6469 7220 3d20 280a 2020 2020 2020  e_dir = (.      
-00018c90: 2020 2020 2020 7365 6c66 2e6d 6170 735f        self.maps_
-00018ca0: 7061 7468 0a20 2020 2020 2020 2020 2020  path.           
-00018cb0: 202f 2066 227b 7365 6c66 2e73 706c 6974   / f"{self.split
-00018cc0: 5f6e 616d 657d 2d7b 7370 6c69 747d 220a  _name}-{split}".
-00018cd0: 2020 2020 2020 2020 2020 2020 2f20 6622              / f"
-00018ce0: 6265 7374 2d7b 7365 6c65 6374 696f 6e7d  best-{selection}
-00018cf0: 220a 2020 2020 2020 2020 2020 2020 2f20  ".            / 
-00018d00: 6461 7461 5f67 726f 7570 0a20 2020 2020  data_group.     
-00018d10: 2020 2029 0a0a 2020 2020 2020 2020 7065     )..        pe
-00018d20: 7266 6f72 6d61 6e63 655f 6469 722e 6d6b  rformance_dir.mk
-00018d30: 6469 7228 7061 7265 6e74 733d 5472 7565  dir(parents=True
-00018d40: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
-00018d50: 0a0a 2020 2020 2020 2020 6466 5f66 696e  ..        df_fin
-00018d60: 616c 2c20 6d65 7472 6963 7320 3d20 7365  al, metrics = se
-00018d70: 6c66 2e74 6173 6b5f 6d61 6e61 6765 722e  lf.task_manager.
-00018d80: 656e 7365 6d62 6c65 5f70 7265 6469 6374  ensemble_predict
-00018d90: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00018da0: 2074 6573 745f 6466 2c0a 2020 2020 2020   test_df,.      
-00018db0: 2020 2020 2020 7661 6c69 6461 7469 6f6e        validation
-00018dc0: 5f64 662c 0a20 2020 2020 2020 2020 2020  _df,.           
-00018dd0: 2073 656c 6563 7469 6f6e 5f74 6872 6573   selection_thres
-00018de0: 686f 6c64 3d73 656c 662e 7365 6c65 6374  hold=self.select
-00018df0: 696f 6e5f 7468 7265 7368 6f6c 642c 0a20  ion_threshold,. 
-00018e00: 2020 2020 2020 2020 2020 2075 7365 5f6c             use_l
-00018e10: 6162 656c 733d 7573 655f 6c61 6265 6c73  abels=use_labels
-00018e20: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00018e30: 2020 2020 2069 6620 6466 5f66 696e 616c       if df_final
-00018e40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00018e50: 2020 2020 2020 2020 2020 6466 5f66 696e            df_fin
-00018e60: 616c 2e74 6f5f 6373 7628 0a20 2020 2020  al.to_csv(.     
-00018e70: 2020 2020 2020 2020 2020 2070 6572 666f             perfo
-00018e80: 726d 616e 6365 5f64 6972 202f 2066 227b  rmance_dir / f"{
-00018e90: 6461 7461 5f67 726f 7570 7d5f 696d 6167  data_group}_imag
-00018ea0: 655f 6c65 7665 6c5f 7072 6564 6963 7469  e_level_predicti
-00018eb0: 6f6e 2e74 7376 222c 0a20 2020 2020 2020  on.tsv",.       
-00018ec0: 2020 2020 2020 2020 2069 6e64 6578 3d46           index=F
-00018ed0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00018ee0: 2020 2020 2020 7365 703d 225c 7422 2c0a        sep="\t",.
-00018ef0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018f00: 2020 2020 2020 6966 206d 6574 7269 6373        if metrics
-00018f10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00018f20: 2020 2020 2020 2020 2020 7064 2e44 6174            pd.Dat
-00018f30: 6146 7261 6d65 286d 6574 7269 6373 2c20  aFrame(metrics, 
-00018f40: 696e 6465 783d 5b30 5d29 2e74 6f5f 6373  index=[0]).to_cs
-00018f50: 7628 0a20 2020 2020 2020 2020 2020 2020  v(.             
-00018f60: 2020 2070 6572 666f 726d 616e 6365 5f64     performance_d
-00018f70: 6972 202f 2066 227b 6461 7461 5f67 726f  ir / f"{data_gro
-00018f80: 7570 7d5f 696d 6167 655f 6c65 7665 6c5f  up}_image_level_
-00018f90: 6d65 7472 6963 732e 7473 7622 2c0a 2020  metrics.tsv",.  
-00018fa0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00018fb0: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
-00018fc0: 2020 2020 2020 2020 2020 2073 6570 3d22             sep="
-00018fd0: 5c74 222c 0a20 2020 2020 2020 2020 2020  \t",.           
-00018fe0: 2029 0a0a 2020 2020 6465 6620 5f6d 6f64   )..    def _mod
-00018ff0: 655f 746f 5f69 6d61 6765 5f74 7376 280a  e_to_image_tsv(.
-00019000: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00019010: 2020 2020 2020 7370 6c69 743a 2069 6e74        split: int
-00019020: 2c0a 2020 2020 2020 2020 7365 6c65 6374  ,.        select
-00019030: 696f 6e3a 2073 7472 2c0a 2020 2020 2020  ion: str,.      
-00019040: 2020 6461 7461 5f67 726f 7570 3a20 7374    data_group: st
-00019050: 7220 3d20 2274 6573 7422 2c0a 2020 2020  r = "test",.    
-00019060: 2020 2020 7573 655f 6c61 6265 6c73 3a20      use_labels: 
-00019070: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00019080: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
-00019090: 2020 2020 2020 2020 436f 7079 206d 6f64          Copy mod
-000190a0: 652d 6c65 7665 6c20 5453 5620 6669 6c65  e-level TSV file
-000190b0: 7320 746f 206e 616d 6520 7468 656d 2061  s to name them a
-000190c0: 7320 696d 6167 652d 6c65 7665 6c20 5453  s image-level TS
-000190d0: 5620 6669 6c65 730a 0a20 2020 2020 2020  V files..       
-000190e0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-000190f0: 2020 2073 706c 6974 3a20 7370 6c69 7420     split: split 
-00019100: 6e75 6d62 6572 206f 6620 7468 6520 6372  number of the cr
-00019110: 6f73 732d 7661 6c69 6461 7469 6f6e 2e0a  oss-validation..
-00019120: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-00019130: 6374 696f 6e3a 206d 6574 7269 6320 6f6e  ction: metric on
-00019140: 2077 6869 6368 2074 6865 206d 6f64 656c   which the model
-00019150: 2069 7320 7365 6c65 6374 6564 2028 666f   is selected (fo
-00019160: 7220 6578 616d 706c 6520 6c6f 7373 206f  r example loss o
-00019170: 7220 4241 290a 2020 2020 2020 2020 2020  r BA).          
-00019180: 2020 6461 7461 5f67 726f 7570 3a20 7468    data_group: th
-00019190: 6520 6e61 6d65 2072 6566 6572 7269 6e67  e name referring
-000191a0: 2074 6f20 7468 6520 6461 7461 2067 726f   to the data gro
-000191b0: 7570 206f 6e20 7768 6963 6820 6576 616c  up on which eval
-000191c0: 7561 7469 6f6e 2069 7320 7065 7266 6f72  uation is perfor
-000191d0: 6d65 642e 0a20 2020 2020 2020 2020 2020  med..           
-000191e0: 2075 7365 5f6c 6162 656c 733a 2049 6620   use_labels: If 
-000191f0: 5472 7565 2074 6865 206c 6162 656c 7320  True the labels 
-00019200: 6172 6520 6164 6465 6420 746f 2074 6865  are added to the
-00019210: 2066 696e 616c 2074 7376 0a0a 2020 2020   final tsv..    
-00019220: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00019230: 7375 625f 6466 203d 2073 656c 662e 6765  sub_df = self.ge
-00019240: 745f 7072 6564 6963 7469 6f6e 280a 2020  t_prediction(.  
-00019250: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00019260: 726f 7570 2c20 7370 6c69 742c 2073 656c  roup, split, sel
-00019270: 6563 7469 6f6e 2c20 7365 6c66 2e6d 6f64  ection, self.mod
-00019280: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
-00019290: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000192a0: 2020 2073 7562 5f64 662e 7265 6e61 6d65     sub_df.rename
-000192b0: 2863 6f6c 756d 6e73 3d7b 6622 7b73 656c  (columns={f"{sel
-000192c0: 662e 6d6f 6465 7d5f 6964 223a 2022 696d  f.mode}_id": "im
-000192d0: 6167 655f 6964 227d 2c20 696e 706c 6163  age_id"}, inplac
-000192e0: 653d 5472 7565 290a 0a20 2020 2020 2020  e=True)..       
-000192f0: 2070 6572 666f 726d 616e 6365 5f64 6972   performance_dir
-00019300: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00019310: 2073 656c 662e 6d61 7073 5f70 6174 680a   self.maps_path.
-00019320: 2020 2020 2020 2020 2020 2020 2f20 6622              / f"
-00019330: 7b73 656c 662e 7370 6c69 745f 6e61 6d65  {self.split_name
-00019340: 7d2d 7b73 706c 6974 7d22 0a20 2020 2020  }-{split}".     
-00019350: 2020 2020 2020 202f 2066 2262 6573 742d         / f"best-
-00019360: 7b73 656c 6563 7469 6f6e 7d22 0a20 2020  {selection}".   
-00019370: 2020 2020 2020 2020 202f 2064 6174 615f           / data_
-00019380: 6772 6f75 700a 2020 2020 2020 2020 290a  group.        ).
-00019390: 2020 2020 2020 2020 7375 625f 6466 2e74          sub_df.t
-000193a0: 6f5f 6373 7628 0a20 2020 2020 2020 2020  o_csv(.         
-000193b0: 2020 2070 6572 666f 726d 616e 6365 5f64     performance_d
-000193c0: 6972 202f 2066 227b 6461 7461 5f67 726f  ir / f"{data_gro
-000193d0: 7570 7d5f 696d 6167 655f 6c65 7665 6c5f  up}_image_level_
-000193e0: 7072 6564 6963 7469 6f6e 2e74 7376 222c  prediction.tsv",
-000193f0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-00019400: 6578 3d46 616c 7365 2c0a 2020 2020 2020  ex=False,.      
-00019410: 2020 2020 2020 7365 703d 225c 7422 2c0a        sep="\t",.
-00019420: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00019430: 2020 6966 2075 7365 5f6c 6162 656c 733a    if use_labels:
-00019440: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-00019450: 7269 6373 5f64 6620 3d20 7064 2e72 6561  rics_df = pd.rea
-00019460: 645f 6373 7628 0a20 2020 2020 2020 2020  d_csv(.         
-00019470: 2020 2020 2020 2070 6572 666f 726d 616e         performan
-00019480: 6365 5f64 6972 202f 2066 227b 6461 7461  ce_dir / f"{data
-00019490: 5f67 726f 7570 7d5f 7b73 656c 662e 6d6f  _group}_{self.mo
-000194a0: 6465 7d5f 6c65 7665 6c5f 6d65 7472 6963  de}_level_metric
-000194b0: 732e 7473 7622 2c0a 2020 2020 2020 2020  s.tsv",.        
-000194c0: 2020 2020 2020 2020 7365 703d 225c 7422          sep="\t"
-000194d0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-000194e0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000194f0: 227b 7365 6c66 2e6d 6f64 657d 5f69 6422  "{self.mode}_id"
-00019500: 2069 6e20 6d65 7472 6963 735f 6466 3a0a   in metrics_df:.
-00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019520: 6465 6c20 6d65 7472 6963 735f 6466 5b66  del metrics_df[f
-00019530: 227b 7365 6c66 2e6d 6f64 657d 5f69 6422  "{self.mode}_id"
-00019540: 5d0a 2020 2020 2020 2020 2020 2020 6d65  ].            me
-00019550: 7472 6963 735f 6466 2e74 6f5f 6373 7628  trics_df.to_csv(
-00019560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019570: 2028 7065 7266 6f72 6d61 6e63 655f 6469   (performance_di
-00019580: 7220 2f20 6622 7b64 6174 615f 6772 6f75  r / f"{data_grou
-00019590: 707d 5f69 6d61 6765 5f6c 6576 656c 5f6d  p}_image_level_m
-000195a0: 6574 7269 6373 2e74 7376 2229 2c0a 2020  etrics.tsv"),.  
-000195b0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-000195c0: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
-000195d0: 2020 2020 2020 2020 2020 2073 6570 3d22             sep="
-000195e0: 5c74 222c 0a20 2020 2020 2020 2020 2020  \t",.           
-000195f0: 2029 0a0a 2020 2020 2323 2323 2323 2323   )..    ########
-00019600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019610: 2323 2323 2323 230a 2020 2020 2320 4f62  #######.    # Ob
-00019620: 6a65 6374 7320 696e 6974 6961 6c69 7a61  jects initializa
-00019630: 7469 6f6e 2020 2020 2020 230a 2020 2020  tion      #.    
-00019640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019650: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00019660: 2020 2020 6465 6620 5f69 6e69 745f 6d6f      def _init_mo
-00019670: 6465 6c28 0a20 2020 2020 2020 2073 656c  del(.        sel
-00019680: 662c 0a20 2020 2020 2020 2074 7261 6e73  f,.        trans
-00019690: 6665 725f 7061 7468 3a20 5061 7468 203d  fer_path: Path =
-000196a0: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
-000196b0: 7261 6e73 6665 725f 7365 6c65 6374 696f  ransfer_selectio
-000196c0: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
-000196d0: 6e62 5f75 6e66 726f 7a65 6e5f 6c61 7965  nb_unfrozen_laye
-000196e0: 723d 302c 0a20 2020 2020 2020 2073 706c  r=0,.        spl
-000196f0: 6974 3d4e 6f6e 652c 0a20 2020 2020 2020  it=None,.       
-00019700: 2072 6573 756d 653d 4661 6c73 652c 0a20   resume=False,. 
-00019710: 2020 2020 2020 2067 7075 3d4e 6f6e 652c         gpu=None,
-00019720: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-00019730: 3d4e 6f6e 652c 0a20 2020 2029 3a0a 2020  =None,.    ):.  
-00019740: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00019750: 2020 496e 7374 616e 7469 6174 6520 7468    Instantiate th
-00019760: 6520 6d6f 6465 6c0a 0a20 2020 2020 2020  e model..       
-00019770: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-00019780: 2020 2074 7261 6e73 6665 725f 7061 7468     transfer_path
-00019790: 2028 7374 7229 3a20 7061 7468 2074 6f20   (str): path to 
-000197a0: 6120 4d41 5053 2069 6e20 7768 6963 6820  a MAPS in which 
-000197b0: 6120 6d6f 6465 6c27 7320 7765 6967 6874  a model's weight
-000197c0: 7320 6172 6520 7573 6564 2066 6f72 2074  s are used for t
-000197d0: 7261 6e73 6665 7220 6c65 6172 6e69 6e67  ransfer learning
-000197e0: 2e0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
-000197f0: 616e 7366 6572 5f73 656c 6563 7469 6f6e  ansfer_selection
-00019800: 2028 7374 7229 3a20 6e61 6d65 206f 6620   (str): name of 
-00019810: 7468 6520 6d65 7472 6963 2075 7365 6420  the metric used 
-00019820: 746f 2066 696e 6420 7468 6520 736f 7572  to find the sour
-00019830: 6365 206d 6f64 656c 2e0a 2020 2020 2020  ce model..      
-00019840: 2020 2020 2020 7370 6c69 7420 2869 6e74        split (int
-00019850: 293a 2049 6e64 6578 206f 6620 7468 6520  ): Index of the 
-00019860: 7370 6c69 7420 286f 6e6c 7920 7573 6564  split (only used
-00019870: 2069 6620 7472 616e 7366 6572 5f70 6174   if transfer_pat
-00019880: 6820 6973 206e 6f74 204e 6f6e 6520 6f66  h is not None of
-00019890: 206e 6f74 2072 6573 756d 6529 2e0a 2020   not resume)..  
-000198a0: 2020 2020 2020 2020 2020 7265 7375 6d65            resume
-000198b0: 2028 626f 6f6c 293a 2049 6620 5472 7565   (bool): If True
-000198c0: 2069 6e69 7469 616c 697a 6520 7468 6520   initialize the 
-000198d0: 6e65 7477 6f72 6b20 7769 7468 2074 6865  network with the
-000198e0: 2063 6865 636b 706f 696e 7420 7765 6967   checkpoint weig
-000198f0: 6874 732e 0a20 2020 2020 2020 2020 2020  hts..           
-00019900: 2067 7075 2028 626f 6f6c 293a 2049 6620   gpu (bool): If 
-00019910: 6769 7665 6e2c 2061 206e 6577 2076 616c  given, a new val
-00019920: 7565 2066 6f72 2074 6865 2064 6576 6963  ue for the devic
-00019930: 6520 6f66 2074 6865 206d 6f64 656c 2077  e of the model w
-00019940: 696c 6c20 6265 2063 6f6d 7075 7465 642e  ill be computed.
-00019950: 0a20 2020 2020 2020 2020 2020 206e 6574  .            net
-00019960: 776f 726b 2028 696e 7429 3a20 496e 6465  work (int): Inde
-00019970: 7820 6f66 2074 6865 206e 6574 776f 726b  x of the network
-00019980: 2074 7261 696e 6564 2028 7573 6564 2069   trained (used i
-00019990: 6e20 6d75 6c74 692d 6e65 7477 6f72 6b20  n multi-network 
-000199a0: 7365 7474 696e 6720 6f6e 6c79 292e 0a20  setting only).. 
-000199b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000199c0: 2020 2069 6d70 6f72 7420 636c 696e 6963     import clinic
-000199d0: 6164 6c2e 7574 696c 732e 6e65 7477 6f72  adl.utils.networ
-000199e0: 6b20 6173 206e 6574 776f 726b 5f70 6163  k as network_pac
-000199f0: 6b61 6765 0a0a 2020 2020 2020 2020 6c6f  kage..        lo
-00019a00: 6767 6572 2e64 6562 7567 2866 2249 6e69  gger.debug(f"Ini
-00019a10: 7469 616c 697a 6174 696f 6e20 6f66 206d  tialization of m
-00019a20: 6f64 656c 207b 7365 6c66 2e61 7263 6869  odel {self.archi
-00019a30: 7465 6374 7572 657d 2229 0a20 2020 2020  tecture}").     
-00019a40: 2020 2023 206f 7220 6368 6f6f 7365 2074     # or choose t
-00019a50: 6f20 696d 706c 656d 656e 7420 6120 6469  o implement a di
-00019a60: 6374 696f 6e61 7279 0a20 2020 2020 2020  ctionary.       
-00019a70: 206d 6f64 656c 5f63 6c61 7373 203d 2067   model_class = g
-00019a80: 6574 6174 7472 286e 6574 776f 726b 5f70  etattr(network_p
-00019a90: 6163 6b61 6765 2c20 7365 6c66 2e61 7263  ackage, self.arc
-00019aa0: 6869 7465 6374 7572 6529 0a20 2020 2020  hitecture).     
-00019ab0: 2020 2061 7267 7320 3d20 6c69 7374 280a     args = list(.
-00019ac0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00019ad0: 6c5f 636c 6173 732e 5f5f 696e 6974 5f5f  l_class.__init__
-00019ae0: 2e5f 5f63 6f64 655f 5f2e 636f 5f76 6172  .__code__.co_var
-00019af0: 6e61 6d65 735b 0a20 2020 2020 2020 2020  names[.         
-00019b00: 2020 2020 2020 203a 206d 6f64 656c 5f63         : model_c
-00019b10: 6c61 7373 2e5f 5f69 6e69 745f 5f2e 5f5f  lass.__init__.__
-00019b20: 636f 6465 5f5f 2e63 6f5f 6172 6763 6f75  code__.co_argcou
-00019b30: 6e74 0a20 2020 2020 2020 2020 2020 205d  nt.            ]
-00019b40: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00019b50: 2020 2061 7267 732e 7265 6d6f 7665 2822     args.remove("
-00019b60: 7365 6c66 2229 0a20 2020 2020 2020 206b  self").        k
-00019b70: 7761 7267 7320 3d20 6469 6374 2829 0a20  wargs = dict(). 
-00019b80: 2020 2020 2020 2066 6f72 2061 7267 2069         for arg i
-00019b90: 6e20 6172 6773 3a0a 2020 2020 2020 2020  n args:.        
-00019ba0: 2020 2020 6b77 6172 6773 5b61 7267 5d20      kwargs[arg] 
-00019bb0: 3d20 7365 6c66 2e70 6172 616d 6574 6572  = self.parameter
-00019bc0: 735b 6172 675d 0a0a 2020 2020 2020 2020  s[arg]..        
-00019bd0: 2320 4368 616e 6765 2064 6576 6963 6520  # Change device 
-00019be0: 6672 6f6d 2074 6865 2074 7261 696e 696e  from the trainin
-00019bf0: 6720 7061 7261 6d65 7465 7273 0a20 2020  g parameters.   
-00019c00: 2020 2020 2069 6620 6770 7520 6973 206e       if gpu is n
-00019c10: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00019c20: 2020 2020 206b 7761 7267 735b 2267 7075       kwargs["gpu
-00019c30: 225d 203d 2067 7075 0a0a 2020 2020 2020  "] = gpu..      
-00019c40: 2020 6d6f 6465 6c20 3d20 6d6f 6465 6c5f    model = model_
-00019c50: 636c 6173 7328 2a2a 6b77 6172 6773 290a  class(**kwargs).
-00019c60: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00019c70: 6562 7567 2866 224d 6f64 656c 3a5c 6e7b  ebug(f"Model:\n{
-00019c80: 6d6f 6465 6c2e 6c61 7965 7273 7d22 290a  model.layers}").
-00019c90: 0a20 2020 2020 2020 2064 6576 6963 6520  .        device 
-00019ca0: 3d20 2263 7075 220a 2020 2020 2020 2020  = "cpu".        
-00019cb0: 6966 2064 6576 6963 6520 213d 206d 6f64  if device != mod
-00019cc0: 656c 2e64 6576 6963 653a 0a20 2020 2020  el.device:.     
-00019cd0: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
-00019ce0: 6d6f 6465 6c2e 6465 7669 6365 0a20 2020  model.device.   
-00019cf0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00019d00: 696e 666f 2866 2257 6f72 6b69 6e67 206f  info(f"Working o
-00019d10: 6e20 7b64 6576 6963 657d 2229 0a20 2020  n {device}").   
-00019d20: 2020 2020 2063 7572 7265 6e74 5f65 706f       current_epo
-00019d30: 6368 203d 2030 0a0a 2020 2020 2020 2020  ch = 0..        
-00019d40: 6966 2072 6573 756d 653a 0a20 2020 2020  if resume:.     
-00019d50: 2020 2020 2020 2063 6865 636b 706f 696e         checkpoin
-00019d60: 745f 7061 7468 203d 2028 0a20 2020 2020  t_path = (.     
-00019d70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019d80: 6d61 7073 5f70 6174 680a 2020 2020 2020  maps_path.      
-00019d90: 2020 2020 2020 2020 2020 2f20 6622 7b73            / f"{s
-00019da0: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
-00019db0: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
-00019dc0: 2020 2020 2020 2020 202f 2022 746d 7022           / "tmp"
-00019dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019de0: 202f 2022 6368 6563 6b70 6f69 6e74 2e70   / "checkpoint.p
-00019df0: 7468 2e74 6172 220a 2020 2020 2020 2020  th.tar".        
-00019e00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00019e10: 2020 6368 6563 6b70 6f69 6e74 5f73 7461    checkpoint_sta
-00019e20: 7465 203d 2074 6f72 6368 2e6c 6f61 6428  te = torch.load(
-00019e30: 6368 6563 6b70 6f69 6e74 5f70 6174 682c  checkpoint_path,
-00019e40: 206d 6170 5f6c 6f63 6174 696f 6e3d 6465   map_location=de
-00019e50: 7669 6365 290a 2020 2020 2020 2020 2020  vice).          
-00019e60: 2020 6d6f 6465 6c2e 6c6f 6164 5f73 7461    model.load_sta
-00019e70: 7465 5f64 6963 7428 6368 6563 6b70 6f69  te_dict(checkpoi
-00019e80: 6e74 5f73 7461 7465 5b22 6d6f 6465 6c22  nt_state["model"
-00019e90: 5d29 0a20 2020 2020 2020 2020 2020 2063  ]).            c
-00019ea0: 7572 7265 6e74 5f65 706f 6368 203d 2063  urrent_epoch = c
-00019eb0: 6865 636b 706f 696e 745f 7374 6174 655b  heckpoint_state[
-00019ec0: 2265 706f 6368 225d 0a20 2020 2020 2020  "epoch"].       
-00019ed0: 2065 6c69 6620 7472 616e 7366 6572 5f70   elif transfer_p
-00019ee0: 6174 683a 0a20 2020 2020 2020 2020 2020  ath:.           
-00019ef0: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
-00019f00: 5472 616e 7366 6572 2077 6569 6768 7473  Transfer weights
-00019f10: 2066 726f 6d20 4d41 5053 2061 7420 7b74   from MAPS at {t
-00019f20: 7261 6e73 6665 725f 7061 7468 7d22 290a  ransfer_path}").
-00019f30: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-00019f40: 7366 6572 5f6d 6170 7320 3d20 4d61 7073  sfer_maps = Maps
-00019f50: 4d61 6e61 6765 7228 7472 616e 7366 6572  Manager(transfer
-00019f60: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-00019f70: 2020 2074 7261 6e73 6665 725f 7374 6174     transfer_stat
-00019f80: 6520 3d20 7472 616e 7366 6572 5f6d 6170  e = transfer_map
-00019f90: 732e 6765 745f 7374 6174 655f 6469 6374  s.get_state_dict
-00019fa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019fb0: 2020 7370 6c69 742c 0a20 2020 2020 2020    split,.       
-00019fc0: 2020 2020 2020 2020 2073 656c 6563 7469           selecti
-00019fd0: 6f6e 5f6d 6574 7269 633d 7472 616e 7366  on_metric=transf
-00019fe0: 6572 5f73 656c 6563 7469 6f6e 2c0a 2020  er_selection,.  
-00019ff0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001a000: 7477 6f72 6b3d 6e65 7477 6f72 6b2c 0a20  twork=network,. 
-0001a010: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001a020: 6170 5f6c 6f63 6174 696f 6e3d 6d6f 6465  ap_location=mode
-0001a030: 6c2e 6465 7669 6365 2c0a 2020 2020 2020  l.device,.      
-0001a040: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001a050: 2020 2020 7472 616e 7366 6572 5f63 6c61      transfer_cla
-0001a060: 7373 203d 2067 6574 6174 7472 286e 6574  ss = getattr(net
-0001a070: 776f 726b 5f70 6163 6b61 6765 2c20 7472  work_package, tr
-0001a080: 616e 7366 6572 5f6d 6170 732e 6172 6368  ansfer_maps.arch
-0001a090: 6974 6563 7475 7265 290a 2020 2020 2020  itecture).      
-0001a0a0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0001a0b0: 7567 2866 2254 7261 6e73 6665 7220 6672  ug(f"Transfer fr
-0001a0c0: 6f6d 207b 7472 616e 7366 6572 5f63 6c61  om {transfer_cla
-0001a0d0: 7373 7d22 290a 2020 2020 2020 2020 2020  ss}").          
-0001a0e0: 2020 6d6f 6465 6c2e 7472 616e 7366 6572    model.transfer
-0001a0f0: 5f77 6569 6768 7473 2874 7261 6e73 6665  _weights(transfe
-0001a100: 725f 7374 6174 655b 226d 6f64 656c 225d  r_state["model"]
-0001a110: 2c20 7472 616e 7366 6572 5f63 6c61 7373  , transfer_class
-0001a120: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0001a130: 6620 6e62 5f75 6e66 726f 7a65 6e5f 6c61  f nb_unfrozen_la
-0001a140: 7965 7220 213d 2030 3a0a 2020 2020 2020  yer != 0:.      
-0001a150: 2020 2020 2020 2020 2020 6c69 7374 5f6e            list_n
-0001a160: 616d 6520 3d20 5b6e 616d 6520 666f 7220  ame = [name for 
-0001a170: 286e 616d 652c 205f 2920 696e 206d 6f64  (name, _) in mod
-0001a180: 656c 2e6e 616d 6564 5f70 6172 616d 6574  el.named_paramet
-0001a190: 6572 7328 295d 0a20 2020 2020 2020 2020  ers()].         
-0001a1a0: 2020 2020 2020 206c 6973 745f 7061 7261         list_para
-0001a1b0: 6d20 3d20 5b70 6172 616d 2066 6f72 2028  m = [param for (
-0001a1c0: 5f2c 2070 6172 616d 2920 696e 206d 6f64  _, param) in mod
-0001a1d0: 656c 2e6e 616d 6564 5f70 6172 616d 6574  el.named_paramet
-0001a1e0: 6572 7328 295d 0a0a 2020 2020 2020 2020  ers()]..        
-0001a1f0: 2020 2020 2020 2020 666f 7220 7061 7261          for para
-0001a200: 6d2c 205f 2069 6e20 7a69 7028 6c69 7374  m, _ in zip(list
-0001a210: 5f70 6172 616d 2c20 6c69 7374 5f6e 616d  _param, list_nam
-0001a220: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001a230: 2020 2020 2020 2020 7061 7261 6d2e 7265          param.re
-0001a240: 7175 6972 6573 5f67 7261 6420 3d20 4661  quires_grad = Fa
-0001a250: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
-0001a260: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-0001a270: 6e67 6528 6e62 5f75 6e66 726f 7a65 6e5f  nge(nb_unfrozen_
-0001a280: 6c61 7965 7220 2a20 3229 3a20 2023 2055  layer * 2):  # U
-0001a290: 6e66 7265 657a 6520 7468 6520 6c61 7374  nfreeze the last
-0001a2a0: 206c 6179 6572 730a 2020 2020 2020 2020   layers.        
-0001a2b0: 2020 2020 2020 2020 2020 2020 7061 7261              para
-0001a2c0: 6d20 3d20 6c69 7374 5f70 6172 616d 5b6c  m = list_param[l
-0001a2d0: 656e 286c 6973 745f 7061 7261 6d29 202d  en(list_param) -
-0001a2e0: 2069 202d 2031 5d0a 2020 2020 2020 2020   i - 1].        
-0001a2f0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0001a300: 203d 206c 6973 745f 6e61 6d65 5b6c 656e   = list_name[len
-0001a310: 286c 6973 745f 6e61 6d65 2920 2d20 6920  (list_name) - i 
-0001a320: 2d20 315d 0a20 2020 2020 2020 2020 2020  - 1].           
-0001a330: 2020 2020 2020 2020 2070 6172 616d 2e72           param.r
-0001a340: 6571 7569 7265 735f 6772 6164 203d 2054  equires_grad = T
-0001a350: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0001a360: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0001a370: 6e66 6f28 6622 4c61 7965 7220 7b6e 616d  nfo(f"Layer {nam
-0001a380: 657d 2075 6e66 726f 7a65 6e20 7b70 6172  e} unfrozen {par
-0001a390: 616d 2e72 6571 7569 7265 735f 6772 6164  am.requires_grad
-0001a3a0: 7d22 290a 0a20 2020 2020 2020 2072 6574  }")..        ret
-0001a3b0: 7572 6e20 6d6f 6465 6c2c 2063 7572 7265  urn model, curre
-0001a3c0: 6e74 5f65 706f 6368 0a0a 2020 2020 6465  nt_epoch..    de
-0001a3d0: 6620 5f69 6e69 745f 6f70 7469 6d69 7a65  f _init_optimize
-0001a3e0: 7228 7365 6c66 2c20 6d6f 6465 6c2c 2073  r(self, model, s
-0001a3f0: 706c 6974 3d4e 6f6e 652c 2072 6573 756d  plit=None, resum
-0001a400: 653d 4661 6c73 6529 3a0a 2020 2020 2020  e=False):.      
-0001a410: 2020 2222 2249 6e69 7469 616c 697a 6520    """Initialize 
-0001a420: 7468 6520 6f70 7469 6d69 7a65 7220 616e  the optimizer an
-0001a430: 6420 7573 6520 6368 6563 6b70 6f69 6e74  d use checkpoint
-0001a440: 2077 6569 6768 7473 2069 6620 7265 7375   weights if resu
-0001a450: 6d65 2069 7320 5472 7565 2e22 2222 0a0a  me is True."""..
-0001a460: 2020 2020 2020 2020 6f70 7469 6d69 7a65          optimize
-0001a470: 725f 636c 7320 3d20 6765 7461 7474 7228  r_cls = getattr(
-0001a480: 746f 7263 682e 6f70 7469 6d2c 2073 656c  torch.optim, sel
-0001a490: 662e 6f70 7469 6d69 7a65 7229 0a20 2020  f.optimizer).   
-0001a4a0: 2020 2020 2070 6172 616d 6574 6572 7320       parameters 
-0001a4b0: 3d20 6669 6c74 6572 286c 616d 6264 6120  = filter(lambda 
-0001a4c0: 783a 2078 2e72 6571 7569 7265 735f 6772  x: x.requires_gr
-0001a4d0: 6164 2c20 6d6f 6465 6c2e 7061 7261 6d65  ad, model.parame
-0001a4e0: 7465 7273 2829 290a 2020 2020 2020 2020  ters()).        
-0001a4f0: 6f70 7469 6d69 7a65 725f 6b77 6172 6773  optimizer_kwargs
-0001a500: 203d 2064 6963 7428 0a20 2020 2020 2020   = dict(.       
-0001a510: 2020 2020 206c 723d 7365 6c66 2e6c 6561       lr=self.lea
-0001a520: 726e 696e 675f 7261 7465 2c0a 2020 2020  rning_rate,.    
-0001a530: 2020 2020 2020 2020 7765 6967 6874 5f64          weight_d
-0001a540: 6563 6179 3d73 656c 662e 7765 6967 6874  ecay=self.weight
-0001a550: 5f64 6563 6179 2c0a 2020 2020 2020 2020  _decay,.        
-0001a560: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-0001a570: 7420 7365 6c66 2e66 756c 6c79 5f73 6861  t self.fully_sha
-0001a580: 7264 6564 5f64 6174 615f 7061 7261 6c6c  rded_data_parall
-0001a590: 656c 3a0a 2020 2020 2020 2020 2020 2020  el:.            
-0001a5a0: 6f70 7469 6d69 7a65 7220 3d20 6f70 7469  optimizer = opti
-0001a5b0: 6d69 7a65 725f 636c 7328 7061 7261 6d65  mizer_cls(parame
-0001a5c0: 7465 7273 2c20 2a2a 6f70 7469 6d69 7a65  ters, **optimize
-0001a5d0: 725f 6b77 6172 6773 290a 2020 2020 2020  r_kwargs).      
-0001a5e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001a5f0: 2020 2020 6672 6f6d 2074 6f72 6368 2e64      from torch.d
-0001a600: 6973 7472 6962 7574 6564 2e6f 7074 696d  istributed.optim
-0001a610: 2069 6d70 6f72 7420 5a65 726f 5265 6475   import ZeroRedu
-0001a620: 6e64 616e 6379 4f70 7469 6d69 7a65 720a  ndancyOptimizer.
-0001a630: 0a20 2020 2020 2020 2020 2020 206f 7074  .            opt
-0001a640: 696d 697a 6572 203d 205a 6572 6f52 6564  imizer = ZeroRed
-0001a650: 756e 6461 6e63 794f 7074 696d 697a 6572  undancyOptimizer
-0001a660: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001a670: 2020 7061 7261 6d65 7465 7273 2c20 6f70    parameters, op
-0001a680: 7469 6d69 7a65 725f 636c 6173 733d 6f70  timizer_class=op
-0001a690: 7469 6d69 7a65 725f 636c 732c 202a 2a6f  timizer_cls, **o
-0001a6a0: 7074 696d 697a 6572 5f6b 7761 7267 730a  ptimizer_kwargs.
-0001a6b0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0001a6c0: 2020 2020 2020 2069 6620 7265 7375 6d65         if resume
-0001a6d0: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
-0001a6e0: 6563 6b70 6f69 6e74 5f70 6174 6820 3d20  eckpoint_path = 
-0001a6f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001a700: 2020 7365 6c66 2e6d 6170 735f 7061 7468    self.maps_path
-0001a710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a720: 202f 2066 227b 7365 6c66 2e73 706c 6974   / f"{self.split
-0001a730: 5f6e 616d 657d 2d7b 7370 6c69 747d 220a  _name}-{split}".
-0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a750: 2f20 2274 6d70 220a 2020 2020 2020 2020  / "tmp".        
-0001a760: 2020 2020 2020 2020 2f20 226f 7074 696d          / "optim
-0001a770: 697a 6572 2e70 7468 2e74 6172 220a 2020  izer.pth.tar".  
-0001a780: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001a790: 2020 2020 2020 2020 6368 6563 6b70 6f69          checkpoi
-0001a7a0: 6e74 5f73 7461 7465 203d 2074 6f72 6368  nt_state = torch
-0001a7b0: 2e6c 6f61 6428 6368 6563 6b70 6f69 6e74  .load(checkpoint
-0001a7c0: 5f70 6174 682c 206d 6170 5f6c 6f63 6174  _path, map_locat
-0001a7d0: 696f 6e3d 6d6f 6465 6c2e 6465 7669 6365  ion=model.device
-0001a7e0: 290a 2020 2020 2020 2020 2020 2020 6f70  ).            op
-0001a7f0: 7469 6d69 7a65 722e 6c6f 6164 5f73 7461  timizer.load_sta
-0001a800: 7465 5f64 6963 7428 6368 6563 6b70 6f69  te_dict(checkpoi
-0001a810: 6e74 5f73 7461 7465 5b22 6f70 7469 6d69  nt_state["optimi
-0001a820: 7a65 7222 5d29 0a0a 2020 2020 2020 2020  zer"])..        
-0001a830: 7265 7475 726e 206f 7074 696d 697a 6572  return optimizer
-0001a840: 0a0a 2020 2020 6465 6620 5f69 6e69 745f  ..    def _init_
-0001a850: 7370 6c69 745f 6d61 6e61 6765 7228 7365  split_manager(se
-0001a860: 6c66 2c20 7370 6c69 745f 6c69 7374 3d4e  lf, split_list=N
-0001a870: 6f6e 6529 3a0a 2020 2020 2020 2020 6672  one):.        fr
-0001a880: 6f6d 2063 6c69 6e69 6361 646c 2e75 7469  om clinicadl.uti
-0001a890: 6c73 2069 6d70 6f72 7420 7370 6c69 745f  ls import split_
-0001a8a0: 6d61 6e61 6765 720a 0a20 2020 2020 2020  manager..       
-0001a8b0: 2073 706c 6974 5f63 6c61 7373 203d 2067   split_class = g
-0001a8c0: 6574 6174 7472 2873 706c 6974 5f6d 616e  etattr(split_man
-0001a8d0: 6167 6572 2c20 7365 6c66 2e76 616c 6964  ager, self.valid
-0001a8e0: 6174 696f 6e29 0a20 2020 2020 2020 2061  ation).        a
-0001a8f0: 7267 7320 3d20 6c69 7374 280a 2020 2020  rgs = list(.    
-0001a900: 2020 2020 2020 2020 7370 6c69 745f 636c          split_cl
-0001a910: 6173 732e 5f5f 696e 6974 5f5f 2e5f 5f63  ass.__init__.__c
-0001a920: 6f64 655f 5f2e 636f 5f76 6172 6e61 6d65  ode__.co_varname
-0001a930: 735b 0a20 2020 2020 2020 2020 2020 2020  s[.             
-0001a940: 2020 203a 2073 706c 6974 5f63 6c61 7373     : split_class
-0001a950: 2e5f 5f69 6e69 745f 5f2e 5f5f 636f 6465  .__init__.__code
-0001a960: 5f5f 2e63 6f5f 6172 6763 6f75 6e74 0a20  __.co_argcount. 
-0001a970: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-0001a980: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-0001a990: 7267 732e 7265 6d6f 7665 2822 7365 6c66  rgs.remove("self
-0001a9a0: 2229 0a20 2020 2020 2020 2061 7267 732e  ").        args.
-0001a9b0: 7265 6d6f 7665 2822 7370 6c69 745f 6c69  remove("split_li
-0001a9c0: 7374 2229 0a20 2020 2020 2020 206b 7761  st").        kwa
-0001a9d0: 7267 7320 3d20 7b22 7370 6c69 745f 6c69  rgs = {"split_li
-0001a9e0: 7374 223a 2073 706c 6974 5f6c 6973 747d  st": split_list}
-0001a9f0: 0a20 2020 2020 2020 2066 6f72 2061 7267  .        for arg
-0001aa00: 2069 6e20 6172 6773 3a0a 2020 2020 2020   in args:.      
-0001aa10: 2020 2020 2020 6b77 6172 6773 5b61 7267        kwargs[arg
-0001aa20: 5d20 3d20 7365 6c66 2e70 6172 616d 6574  ] = self.paramet
-0001aa30: 6572 735b 6172 675d 0a20 2020 2020 2020  ers[arg].       
-0001aa40: 2072 6574 7572 6e20 7370 6c69 745f 636c   return split_cl
-0001aa50: 6173 7328 2a2a 6b77 6172 6773 290a 0a20  ass(**kwargs).. 
-0001aa60: 2020 2064 6566 205f 696e 6974 5f73 706c     def _init_spl
-0001aa70: 6974 5f6d 616e 6167 6572 5f73 7364 6128  it_manager_ssda(
-0001aa80: 7365 6c66 2c20 6361 7073 5f64 6972 2c20  self, caps_dir, 
-0001aa90: 7473 765f 6469 722c 2073 706c 6974 5f6c  tsv_dir, split_l
-0001aaa0: 6973 743d 4e6f 6e65 293a 0a20 2020 2020  ist=None):.     
-0001aab0: 2020 2023 2041 2069 6e74 c3a9 6772 6572     # A int..grer
-0001aac0: 2064 6972 6563 7465 6d65 6e74 2064 616e   directement dan
-0001aad0: 7320 5f69 6e69 745f 7370 6c69 745f 6d61  s _init_split_ma
-0001aae0: 6e61 6765 720a 2020 2020 2020 2020 6672  nager.        fr
-0001aaf0: 6f6d 2063 6c69 6e69 6361 646c 2e75 7469  om clinicadl.uti
-0001ab00: 6c73 2069 6d70 6f72 7420 7370 6c69 745f  ls import split_
-0001ab10: 6d61 6e61 6765 720a 0a20 2020 2020 2020  manager..       
-0001ab20: 2073 706c 6974 5f63 6c61 7373 203d 2067   split_class = g
-0001ab30: 6574 6174 7472 2873 706c 6974 5f6d 616e  etattr(split_man
-0001ab40: 6167 6572 2c20 7365 6c66 2e76 616c 6964  ager, self.valid
-0001ab50: 6174 696f 6e29 0a20 2020 2020 2020 2061  ation).        a
-0001ab60: 7267 7320 3d20 6c69 7374 280a 2020 2020  rgs = list(.    
-0001ab70: 2020 2020 2020 2020 7370 6c69 745f 636c          split_cl
-0001ab80: 6173 732e 5f5f 696e 6974 5f5f 2e5f 5f63  ass.__init__.__c
-0001ab90: 6f64 655f 5f2e 636f 5f76 6172 6e61 6d65  ode__.co_varname
-0001aba0: 735b 0a20 2020 2020 2020 2020 2020 2020  s[.             
-0001abb0: 2020 203a 2073 706c 6974 5f63 6c61 7373     : split_class
-0001abc0: 2e5f 5f69 6e69 745f 5f2e 5f5f 636f 6465  .__init__.__code
-0001abd0: 5f5f 2e63 6f5f 6172 6763 6f75 6e74 0a20  __.co_argcount. 
-0001abe0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-0001abf0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-0001ac00: 7267 732e 7265 6d6f 7665 2822 7365 6c66  rgs.remove("self
-0001ac10: 2229 0a20 2020 2020 2020 2061 7267 732e  ").        args.
-0001ac20: 7265 6d6f 7665 2822 7370 6c69 745f 6c69  remove("split_li
-0001ac30: 7374 2229 0a20 2020 2020 2020 206b 7761  st").        kwa
-0001ac40: 7267 7320 3d20 7b22 7370 6c69 745f 6c69  rgs = {"split_li
-0001ac50: 7374 223a 2073 706c 6974 5f6c 6973 747d  st": split_list}
-0001ac60: 0a20 2020 2020 2020 2066 6f72 2061 7267  .        for arg
-0001ac70: 2069 6e20 6172 6773 3a0a 2020 2020 2020   in args:.      
-0001ac80: 2020 2020 2020 6b77 6172 6773 5b61 7267        kwargs[arg
-0001ac90: 5d20 3d20 7365 6c66 2e70 6172 616d 6574  ] = self.paramet
-0001aca0: 6572 735b 6172 675d 0a0a 2020 2020 2020  ers[arg]..      
-0001acb0: 2020 6b77 6172 6773 5b22 6361 7073 5f64    kwargs["caps_d
-0001acc0: 6972 6563 746f 7279 225d 203d 2050 6174  irectory"] = Pat
-0001acd0: 6828 6361 7073 5f64 6972 290a 2020 2020  h(caps_dir).    
-0001ace0: 2020 2020 6b77 6172 6773 5b22 7473 765f      kwargs["tsv_
-0001acf0: 7061 7468 225d 203d 2050 6174 6828 7473  path"] = Path(ts
-0001ad00: 765f 6469 7229 0a0a 2020 2020 2020 2020  v_dir)..        
-0001ad10: 7265 7475 726e 2073 706c 6974 5f63 6c61  return split_cla
-0001ad20: 7373 282a 2a6b 7761 7267 7329 0a0a 2020  ss(**kwargs)..  
-0001ad30: 2020 6465 6620 5f69 6e69 745f 7461 736b    def _init_task
-0001ad40: 5f6d 616e 6167 6572 2873 656c 662c 2064  _manager(self, d
-0001ad50: 663d 4e6f 6e65 2c20 6e5f 636c 6173 7365  f=None, n_classe
-0001ad60: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
-0001ad70: 2066 726f 6d20 636c 696e 6963 6164 6c2e   from clinicadl.
-0001ad80: 7574 696c 732e 7461 736b 5f6d 616e 6167  utils.task_manag
-0001ad90: 6572 2069 6d70 6f72 7420 280a 2020 2020  er import (.    
-0001ada0: 2020 2020 2020 2020 436c 6173 7369 6669          Classifi
-0001adb0: 6361 7469 6f6e 4d61 6e61 6765 722c 0a20  cationManager,. 
-0001adc0: 2020 2020 2020 2020 2020 2052 6563 6f6e             Recon
-0001add0: 7374 7275 6374 696f 6e4d 616e 6167 6572  structionManager
-0001ade0: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
-0001adf0: 6772 6573 7369 6f6e 4d61 6e61 6765 722c  gressionManager,
-0001ae00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0001ae10: 2020 2020 6966 2073 656c 662e 6e65 7477      if self.netw
-0001ae20: 6f72 6b5f 7461 736b 203d 3d20 2263 6c61  ork_task == "cla
-0001ae30: 7373 6966 6963 6174 696f 6e22 3a0a 2020  ssification":.  
-0001ae40: 2020 2020 2020 2020 2020 6966 206e 5f63            if n_c
-0001ae50: 6c61 7373 6573 2069 7320 6e6f 7420 4e6f  lasses is not No
-0001ae60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001ae70: 2020 2020 7265 7475 726e 2043 6c61 7373      return Class
-0001ae80: 6966 6963 6174 696f 6e4d 616e 6167 6572  ificationManager
-0001ae90: 2873 656c 662e 6d6f 6465 2c20 6e5f 636c  (self.mode, n_cl
-0001aea0: 6173 7365 733d 6e5f 636c 6173 7365 7329  asses=n_classes)
-0001aeb0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001aec0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001aed0: 2020 2072 6574 7572 6e20 436c 6173 7369     return Classi
-0001aee0: 6669 6361 7469 6f6e 4d61 6e61 6765 7228  ficationManager(
-0001aef0: 7365 6c66 2e6d 6f64 652c 2064 663d 6466  self.mode, df=df
-0001af00: 2c20 6c61 6265 6c3d 7365 6c66 2e6c 6162  , label=self.lab
-0001af10: 656c 290a 2020 2020 2020 2020 656c 6966  el).        elif
-0001af20: 2073 656c 662e 6e65 7477 6f72 6b5f 7461   self.network_ta
-0001af30: 736b 203d 3d20 2272 6567 7265 7373 696f  sk == "regressio
-0001af40: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-0001af50: 7265 7475 726e 2052 6567 7265 7373 696f  return Regressio
-0001af60: 6e4d 616e 6167 6572 2873 656c 662e 6d6f  nManager(self.mo
-0001af70: 6465 290a 2020 2020 2020 2020 656c 6966  de).        elif
-0001af80: 2073 656c 662e 6e65 7477 6f72 6b5f 7461   self.network_ta
-0001af90: 736b 203d 3d20 2272 6563 6f6e 7374 7275  sk == "reconstru
-0001afa0: 6374 696f 6e22 3a0a 2020 2020 2020 2020  ction":.        
-0001afb0: 2020 2020 7265 7475 726e 2052 6563 6f6e      return Recon
-0001afc0: 7374 7275 6374 696f 6e4d 616e 6167 6572  structionManager
-0001afd0: 2873 656c 662e 6d6f 6465 290a 2020 2020  (self.mode).    
-0001afe0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001aff0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0001b000: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0001b010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b020: 2066 2254 6173 6b20 7b73 656c 662e 6e65   f"Task {self.ne
-0001b030: 7477 6f72 6b5f 7461 736b 7d20 6973 206e  twork_task} is n
-0001b040: 6f74 2069 6d70 6c65 6d65 6e74 6564 2069  ot implemented i
-0001b050: 6e20 436c 696e 6963 6144 4c2e 2022 0a20  n ClinicaDL. ". 
-0001b060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001b070: 2250 6c65 6173 6520 6368 6f6f 7365 2062  "Please choose b
-0001b080: 6574 7765 656e 2063 6c61 7373 6966 6963  etween classific
-0001b090: 6174 696f 6e2c 2072 6567 7265 7373 696f  ation, regressio
-0001b0a0: 6e20 616e 6420 7265 636f 6e73 7472 7563  n and reconstruc
-0001b0b0: 7469 6f6e 2e22 0a20 2020 2020 2020 2020  tion.".         
-0001b0c0: 2020 2029 0a0a 2020 2020 6465 6620 5f69     )..    def _i
-0001b0d0: 6e69 745f 7072 6f66 696c 6572 2873 656c  nit_profiler(sel
-0001b0e0: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
-0001b0f0: 656c 662e 7072 6f66 696c 6572 3a0a 2020  elf.profiler:.  
-0001b100: 2020 2020 2020 2020 2020 6672 6f6d 2063            from c
-0001b110: 6c69 6e69 6361 646c 2e75 7469 6c73 2e6d  linicadl.utils.m
-0001b120: 6170 735f 6d61 6e61 6765 722e 636c 7573  aps_manager.clus
-0001b130: 7465 722e 7072 6f66 696c 6572 2069 6d70  ter.profiler imp
-0001b140: 6f72 7420 280a 2020 2020 2020 2020 2020  ort (.          
-0001b150: 2020 2020 2020 5072 6f66 696c 6572 4163        ProfilerAc
-0001b160: 7469 7669 7479 2c0a 2020 2020 2020 2020  tivity,.        
-0001b170: 2020 2020 2020 2020 7072 6f66 696c 652c          profile,
-0001b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b190: 2073 6368 6564 756c 652c 0a20 2020 2020   schedule,.     
-0001b1a0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0001b1b0: 7262 6f61 7264 5f74 7261 6365 5f68 616e  rboard_trace_han
-0001b1c0: 646c 6572 2c0a 2020 2020 2020 2020 2020  dler,.          
-0001b1d0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0001b1e0: 2074 696d 6520 3d20 6461 7465 7469 6d65   time = datetime
-0001b1f0: 2e6e 6f77 2829 2e73 7472 6674 696d 6528  .now().strftime(
-0001b200: 2225 483a 254d 3a25 5322 290a 2020 2020  "%H:%M:%S").    
-0001b210: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-0001b220: 203d 205b 7365 6c66 2e6d 6170 735f 7061   = [self.maps_pa
-0001b230: 7468 202f 2022 7072 6f66 696c 6572 2220  th / "profiler" 
-0001b240: 2f20 6622 636c 696e 6963 6164 6c5f 7b74  / f"clinicadl_{t
-0001b250: 696d 657d 225d 0a20 2020 2020 2020 2020  ime}"].         
-0001b260: 2020 2064 6973 742e 6272 6f61 6463 6173     dist.broadcas
-0001b270: 745f 6f62 6a65 6374 5f6c 6973 7428 6669  t_object_list(fi
-0001b280: 6c65 6e61 6d65 2c20 7372 633d 3029 0a20  lename, src=0). 
-0001b290: 2020 2020 2020 2020 2020 2070 726f 6669             profi
-0001b2a0: 6c65 7220 3d20 7072 6f66 696c 6528 0a20  ler = profile(. 
-0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001b2c0: 6374 6976 6974 6965 733d 5b50 726f 6669  ctivities=[Profi
-0001b2d0: 6c65 7241 6374 6976 6974 792e 4350 552c  lerActivity.CPU,
-0001b2e0: 2050 726f 6669 6c65 7241 6374 6976 6974   ProfilerActivit
-0001b2f0: 792e 4355 4441 5d2c 0a20 2020 2020 2020  y.CUDA],.       
-0001b300: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
-0001b310: 653d 7363 6865 6475 6c65 2877 6169 743d  e=schedule(wait=
-0001b320: 322c 2077 6172 6d75 703d 322c 2061 6374  2, warmup=2, act
-0001b330: 6976 653d 3330 2c20 7265 7065 6174 3d31  ive=30, repeat=1
-0001b340: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001b350: 2020 206f 6e5f 7472 6163 655f 7265 6164     on_trace_read
-0001b360: 793d 7465 6e73 6f72 626f 6172 645f 7472  y=tensorboard_tr
-0001b370: 6163 655f 6861 6e64 6c65 7228 6669 6c65  ace_handler(file
-0001b380: 6e61 6d65 5b30 5d29 2c0a 2020 2020 2020  name[0]),.      
-0001b390: 2020 2020 2020 2020 2020 7072 6f66 696c            profil
-0001b3a0: 655f 6d65 6d6f 7279 3d54 7275 652c 0a20  e_memory=True,. 
-0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001b3c0: 6563 6f72 645f 7368 6170 6573 3d46 616c  ecord_shapes=Fal
-0001b3d0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-0001b3e0: 2020 2020 7769 7468 5f73 7461 636b 3d46      with_stack=F
-0001b3f0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-0001b400: 2020 2020 2020 7769 7468 5f66 6c6f 7073        with_flops
-0001b410: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0001b420: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0001b430: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001b440: 7072 6f66 696c 6572 203d 206e 756c 6c63  profiler = nullc
-0001b450: 6f6e 7465 7874 2829 0a20 2020 2020 2020  ontext().       
-0001b460: 2020 2020 2070 726f 6669 6c65 722e 7374       profiler.st
-0001b470: 6570 203d 206c 616d 6264 6120 2a61 7267  ep = lambda *arg
-0001b480: 732c 202a 2a6b 7761 7267 733a 204e 6f6e  s, **kwargs: Non
-0001b490: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-0001b4a0: 2070 726f 6669 6c65 720a 0a20 2020 2023   profiler..    #
-0001b4b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b4c0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0001b4d0: 2020 2023 2047 6574 7465 7273 2020 2020     # Getters    
-0001b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4f0: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
-0001b500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b510: 2323 2323 2323 0a20 2020 2064 6566 205f  ######.    def _
-0001b520: 7072 696e 745f 6465 7363 7269 7074 696f  print_descriptio
-0001b530: 6e5f 6c6f 6728 0a20 2020 2020 2020 2073  n_log(.        s
-0001b540: 656c 662c 0a20 2020 2020 2020 2064 6174  elf,.        dat
-0001b550: 615f 6772 6f75 702c 0a20 2020 2020 2020  a_group,.       
-0001b560: 2073 706c 6974 2c0a 2020 2020 2020 2020   split,.        
-0001b570: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001b580: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0001b590: 2022 2222 0a20 2020 2020 2020 2050 7269   """.        Pri
-0001b5a0: 6e74 2074 6865 2064 6573 6372 6970 7469  nt the descripti
-0001b5b0: 6f6e 206c 6f67 2061 7373 6f63 6961 7465  on log associate
-0001b5c0: 6420 746f 2061 2070 7265 6469 6374 696f  d to a predictio
-0001b5d0: 6e20 6f72 2069 6e74 6572 7072 6574 6174  n or interpretat
-0001b5e0: 696f 6e2e 0a0a 2020 2020 2020 2020 4172  ion...        Ar
-0001b5f0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0001b600: 6461 7461 5f67 726f 7570 2028 7374 7229  data_group (str)
-0001b610: 3a20 6e61 6d65 206f 6620 7468 6520 6461  : name of the da
-0001b620: 7461 2067 726f 7570 2075 7365 6420 666f  ta group used fo
-0001b630: 7220 7468 6520 7461 736b 2e0a 2020 2020  r the task..    
-0001b640: 2020 2020 2020 2020 7370 6c69 7420 2869          split (i
-0001b650: 6e74 293a 2049 6e64 6578 206f 6620 7468  nt): Index of th
-0001b660: 6520 7370 6c69 7420 7573 6564 2066 6f72  e split used for
-0001b670: 2074 7261 696e 696e 672e 0a20 2020 2020   training..     
-0001b680: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
-0001b690: 5f6d 6574 7269 6320 2873 7472 293a 204d  _metric (str): M
-0001b6a0: 6574 7269 6320 7573 6564 2066 6f72 2062  etric used for b
-0001b6b0: 6573 7420 7765 6967 6874 7320 7365 6c65  est weights sele
-0001b6c0: 6374 696f 6e2e 0a20 2020 2020 2020 2022  ction..        "
-0001b6d0: 2222 0a20 2020 2020 2020 206c 6f67 5f64  "".        log_d
-0001b6e0: 6972 203d 2028 0a20 2020 2020 2020 2020  ir = (.         
-0001b6f0: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
-0001b700: 680a 2020 2020 2020 2020 2020 2020 2f20  h.            / 
-0001b710: 6622 7b73 656c 662e 7370 6c69 745f 6e61  f"{self.split_na
-0001b720: 6d65 7d2d 7b73 706c 6974 7d22 0a20 2020  me}-{split}".   
-0001b730: 2020 2020 2020 2020 202f 2066 2262 6573           / f"bes
-0001b740: 742d 7b73 656c 6563 7469 6f6e 5f6d 6574  t-{selection_met
-0001b750: 7269 637d 220a 2020 2020 2020 2020 2020  ric}".          
-0001b760: 2020 2f20 6461 7461 5f67 726f 7570 0a20    / data_group. 
-0001b770: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001b780: 206c 6f67 5f70 6174 6820 3d20 6c6f 675f   log_path = log_
-0001b790: 6469 7220 2f20 2264 6573 6372 6970 7469  dir / "descripti
-0001b7a0: 6f6e 2e6c 6f67 220a 2020 2020 2020 2020  on.log".        
-0001b7b0: 7769 7468 206c 6f67 5f70 6174 682e 6f70  with log_path.op
-0001b7c0: 656e 286d 6f64 653d 2272 2229 2061 7320  en(mode="r") as 
-0001b7d0: 663a 0a20 2020 2020 2020 2020 2020 2063  f:.            c
-0001b7e0: 6f6e 7465 6e74 203d 2066 2e72 6561 6428  ontent = f.read(
-0001b7f0: 290a 0a20 2020 2064 6566 2067 6574 5f67  )..    def get_g
-0001b800: 726f 7570 5f69 6e66 6f28 0a20 2020 2020  roup_info(.     
-0001b810: 2020 2073 656c 662c 2064 6174 615f 6772     self, data_gr
-0001b820: 6f75 703a 2073 7472 2c20 7370 6c69 743a  oup: str, split:
-0001b830: 2069 6e74 203d 204e 6f6e 650a 2020 2020   int = None.    
-0001b840: 2920 2d3e 2054 7570 6c65 5b70 642e 4461  ) -> Tuple[pd.Da
-0001b850: 7461 4672 616d 652c 2044 6963 745b 7374  taFrame, Dict[st
-0001b860: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
-0001b870: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
-0001b880: 7473 2069 6e66 6f72 6d61 7469 6f6e 2066  ts information f
-0001b890: 726f 6d20 636f 7272 6573 706f 6e64 696e  rom correspondin
-0001b8a0: 6720 6461 7461 2067 726f 7570 0a20 2020  g data group.   
-0001b8b0: 2020 2020 2028 6c69 7374 206f 6620 7061       (list of pa
-0001b8c0: 7274 6963 6970 616e 745f 6964 202f 2073  rticipant_id / s
-0001b8d0: 6573 7369 6f6e 5f69 6420 2b20 636f 6e66  ession_id + conf
-0001b8e0: 6967 7572 6174 696f 6e20 7061 7261 6d65  iguration parame
-0001b8f0: 7465 7273 292e 0a20 2020 2020 2020 2073  ters)..        s
-0001b900: 706c 6974 2069 7320 6f6e 6c79 206e 6565  plit is only nee
-0001b910: 6465 6420 6966 2064 6174 615f 6772 6f75  ded if data_grou
-0001b920: 7020 6973 2074 7261 696e 206f 7220 7661  p is train or va
-0001b930: 6c69 6461 7469 6f6e 2e0a 2020 2020 2020  lidation..      
-0001b940: 2020 2222 220a 2020 2020 2020 2020 6772    """.        gr
-0001b950: 6f75 705f 7061 7468 203d 2073 656c 662e  oup_path = self.
-0001b960: 6d61 7073 5f70 6174 6820 2f20 2267 726f  maps_path / "gro
-0001b970: 7570 7322 202f 2064 6174 615f 6772 6f75  ups" / data_grou
-0001b980: 700a 2020 2020 2020 2020 6966 206e 6f74  p.        if not
-0001b990: 2067 726f 7570 5f70 6174 682e 6973 5f64   group_path.is_d
-0001b9a0: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
-0001b9b0: 2020 7261 6973 6520 4d41 5053 4572 726f    raise MAPSErro
-0001b9c0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0001b9d0: 2020 2066 2244 6174 6120 6772 6f75 7020     f"Data group 
-0001b9e0: 7b64 6174 615f 6772 6f75 707d 2069 7320  {data_group} is 
-0001b9f0: 6e6f 7420 6465 6669 6e65 642e 2022 0a20  not defined. ". 
-0001ba00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001ba10: 2250 6c65 6173 6520 7275 6e20 6120 7072  "Please run a pr
-0001ba20: 6564 6963 7469 6f6e 2074 6f20 6372 6561  ediction to crea
-0001ba30: 7465 2074 6869 7320 6461 7461 2067 726f  te this data gro
-0001ba40: 7570 2e22 0a20 2020 2020 2020 2020 2020  up.".           
-0001ba50: 2029 0a20 2020 2020 2020 2069 6620 6461   ).        if da
-0001ba60: 7461 5f67 726f 7570 2069 6e20 5b22 7472  ta_group in ["tr
-0001ba70: 6169 6e22 2c20 2276 616c 6964 6174 696f  ain", "validatio
-0001ba80: 6e22 5d3a 0a20 2020 2020 2020 2020 2020  n"]:.           
-0001ba90: 2069 6620 7370 6c69 7420 6973 204e 6f6e   if split is Non
-0001baa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001bab0: 2020 2072 6169 7365 204d 4150 5345 7272     raise MAPSErr
-0001bac0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001bad0: 2020 2020 2020 2020 6622 496e 666f 726d          f"Inform
-0001bae0: 6174 696f 6e20 6f6e 2074 7261 696e 206f  ation on train o
-0001baf0: 7220 7661 6c69 6461 7469 6f6e 2064 6174  r validation dat
-0001bb00: 6120 6361 6e20 6f6e 6c79 2062 6520 220a  a can only be ".
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2020 6622 6c6f 6164 6564 2069 6620      f"loaded if 
-0001bb30: 6120 7370 6c69 7420 6e75 6d62 6572 2069  a split number i
-0001bb40: 7320 6769 7665 6e22 0a20 2020 2020 2020  s given".       
-0001bb50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001bb60: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
-0001bb70: 2867 726f 7570 5f70 6174 6820 2f20 6622  (group_path / f"
-0001bb80: 7b73 656c 662e 7370 6c69 745f 6e61 6d65  {self.split_name
-0001bb90: 7d2d 7b73 706c 6974 7d22 292e 6973 5f64  }-{split}").is_d
-0001bba0: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
-0001bbb0: 2020 2020 2020 7261 6973 6520 4d41 5053        raise MAPS
-0001bbc0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0001bbd0: 2020 2020 2020 2020 2020 2066 2253 706c             f"Spl
-0001bbe0: 6974 207b 7370 6c69 747d 2069 7320 6e6f  it {split} is no
-0001bbf0: 7420 6176 6169 6c61 626c 6520 666f 7220  t available for 
-0001bc00: 6461 7461 2067 726f 7570 207b 6461 7461  data group {data
-0001bc10: 5f67 726f 7570 7d2e 220a 2020 2020 2020  _group}.".      
-0001bc20: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001bc30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001bc40: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0001bc50: 6f75 705f 7061 7468 203d 2067 726f 7570  oup_path = group
-0001bc60: 5f70 6174 6820 2f20 6622 7b73 656c 662e  _path / f"{self.
-0001bc70: 7370 6c69 745f 6e61 6d65 7d2d 7b73 706c  split_name}-{spl
-0001bc80: 6974 7d22 0a0a 2020 2020 2020 2020 6466  it}"..        df
-0001bc90: 203d 2070 642e 7265 6164 5f63 7376 2867   = pd.read_csv(g
-0001bca0: 726f 7570 5f70 6174 6820 2f20 2264 6174  roup_path / "dat
-0001bcb0: 612e 7473 7622 2c20 7365 703d 225c 7422  a.tsv", sep="\t"
-0001bcc0: 290a 2020 2020 2020 2020 6a73 6f6e 5f70  ).        json_p
-0001bcd0: 6174 6820 3d20 6772 6f75 705f 7061 7468  ath = group_path
-0001bce0: 202f 2022 6d61 7073 2e6a 736f 6e22 0a20   / "maps.json". 
-0001bcf0: 2020 2020 2020 2077 6974 6820 6a73 6f6e         with json
-0001bd00: 5f70 6174 682e 6f70 656e 286d 6f64 653d  _path.open(mode=
-0001bd10: 2272 2229 2061 7320 663a 0a20 2020 2020  "r") as f:.     
-0001bd20: 2020 2020 2020 2070 6172 616d 6574 6572         parameter
-0001bd30: 7320 3d20 6a73 6f6e 2e6c 6f61 6428 6629  s = json.load(f)
-0001bd40: 0a20 2020 2020 2020 2070 6172 616d 6574  .        paramet
-0001bd50: 6572 7320 3d20 6368 616e 6765 5f73 7472  ers = change_str
-0001bd60: 5f74 6f5f 7061 7468 2870 6172 616d 6574  _to_path(paramet
-0001bd70: 6572 7329 0a20 2020 2020 2020 2072 6574  ers).        ret
-0001bd80: 7572 6e20 6466 2c20 7061 7261 6d65 7465  urn df, paramete
-0001bd90: 7273 0a0a 2020 2020 6465 6620 6765 745f  rs..    def get_
-0001bda0: 7061 7261 6d65 7465 7273 2873 656c 6629  parameters(self)
-0001bdb0: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-0001bdc0: 7572 6e73 2074 6865 2074 7261 696e 696e  urns the trainin
-0001bdd0: 6720 7061 7261 6d65 7465 7273 2064 6963  g parameters dic
-0001bde0: 7469 6f6e 6172 792e 2222 220a 2020 2020  tionary.""".    
-0001bdf0: 2020 2020 6a73 6f6e 5f70 6174 6820 3d20      json_path = 
-0001be00: 7365 6c66 2e6d 6170 735f 7061 7468 202f  self.maps_path /
-0001be10: 2022 6d61 7073 2e6a 736f 6e22 0a20 2020   "maps.json".   
-0001be20: 2020 2020 2072 6574 7572 6e20 7265 6164       return read
-0001be30: 5f6a 736f 6e28 6a73 6f6e 5f70 6174 6829  _json(json_path)
-0001be40: 0a0a 2020 2020 2320 6465 6620 6765 745f  ..    # def get_
-0001be50: 6d6f 6465 6c28 0a20 2020 2023 2020 2020  model(.    #    
-0001be60: 2073 656c 662c 2073 706c 6974 3a20 696e   self, split: in
-0001be70: 7420 3d20 302c 2073 656c 6563 7469 6f6e  t = 0, selection
-0001be80: 5f6d 6574 7269 633a 2073 7472 203d 204e  _metric: str = N
-0001be90: 6f6e 652c 206e 6574 776f 726b 3a20 696e  one, network: in
-0001bea0: 7420 3d20 4e6f 6e65 0a20 2020 2023 2029  t = None.    # )
-0001beb0: 202d 3e20 4e65 7477 6f72 6b3a 0a20 2020   -> Network:.   
-0001bec0: 2023 2020 2020 2073 656c 6563 7469 6f6e   #     selection
-0001bed0: 5f6d 6574 7269 6320 3d20 7365 6c66 2e5f  _metric = self._
-0001bee0: 6368 6563 6b5f 7365 6c65 6374 696f 6e5f  check_selection_
-0001bef0: 6d65 7472 6963 2873 706c 6974 2c20 7365  metric(split, se
-0001bf00: 6c65 6374 696f 6e5f 6d65 7472 6963 290a  lection_metric).
-0001bf10: 2020 2020 2320 2020 2020 6966 2073 656c      #     if sel
-0001bf20: 662e 6d75 6c74 695f 6e65 7477 6f72 6b3a  f.multi_network:
-0001bf30: 0a20 2020 2023 2020 2020 2020 2020 2069  .    #         i
-0001bf40: 6620 6e65 7477 6f72 6b20 6973 204e 6f6e  f network is Non
-0001bf50: 653a 0a20 2020 2023 2020 2020 2020 2020  e:.    #        
-0001bf60: 2020 2020 2072 6169 7365 2043 6c69 6e69       raise Clini
-0001bf70: 6361 444c 4172 6775 6d65 6e74 4572 726f  caDLArgumentErro
-0001bf80: 7228 0a20 2020 2023 2020 2020 2020 2020  r(.    #        
-0001bf90: 2020 2020 2020 2020 2022 506c 6561 7365           "Please
-0001bfa0: 2070 7265 6369 7365 2074 6865 206e 6574   precise the net
-0001bfb0: 776f 726b 206e 756d 6265 7220 7468 6174  work number that
-0001bfc0: 206d 7573 7420 6265 206c 6f61 6465 642e   must be loaded.
-0001bfd0: 220a 2020 2020 2320 2020 2020 2020 2020  ".    #         
-0001bfe0: 2020 2020 290a 2020 2020 2320 2020 2020      ).    #     
-0001bff0: 7265 7475 726e 2073 656c 662e 5f69 6e69  return self._ini
-0001c000: 745f 6d6f 6465 6c28 0a20 2020 2023 2020  t_model(.    #  
-0001c010: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
-0001c020: 5f70 6174 682c 0a20 2020 2023 2020 2020  _path,.    #    
-0001c030: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
-0001c040: 6574 7269 632c 0a20 2020 2023 2020 2020  etric,.    #    
-0001c050: 2020 2020 2073 706c 6974 2c0a 2020 2020       split,.    
-0001c060: 2320 2020 2020 2020 2020 6e65 7477 6f72  #         networ
-0001c070: 6b3d 6e65 7477 6f72 6b2c 0a20 2020 2023  k=network,.    #
-0001c080: 2020 2020 2020 2020 206e 625f 756e 6672           nb_unfr
-0001c090: 6f7a 656e 5f6c 6179 6572 3d73 656c 662e  ozen_layer=self.
-0001c0a0: 6e62 5f75 6e66 726f 7a65 6e5f 6c61 7965  nb_unfrozen_laye
-0001c0b0: 722c 0a20 2020 2023 2020 2020 2029 5b30  r,.    #     )[0
-0001c0c0: 5d0a 0a20 2020 2023 2064 6566 2067 6574  ]..    # def get
-0001c0d0: 5f62 6573 745f 6570 6f63 6828 0a20 2020  _best_epoch(.   
-0001c0e0: 2023 2020 2020 2073 656c 662c 2073 706c   #     self, spl
-0001c0f0: 6974 3a20 696e 7420 3d20 302c 2073 656c  it: int = 0, sel
-0001c100: 6563 7469 6f6e 5f6d 6574 7269 633a 2073  ection_metric: s
-0001c110: 7472 203d 204e 6f6e 652c 206e 6574 776f  tr = None, netwo
-0001c120: 726b 3a20 696e 7420 3d20 4e6f 6e65 0a20  rk: int = None. 
-0001c130: 2020 2023 2029 202d 3e20 696e 743a 0a20     # ) -> int:. 
-0001c140: 2020 2023 2020 2020 2073 656c 6563 7469     #     selecti
-0001c150: 6f6e 5f6d 6574 7269 6320 3d20 7365 6c66  on_metric = self
-0001c160: 2e5f 6368 6563 6b5f 7365 6c65 6374 696f  ._check_selectio
-0001c170: 6e5f 6d65 7472 6963 2873 706c 6974 2c20  n_metric(split, 
-0001c180: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001c190: 290a 2020 2020 2320 2020 2020 6966 2073  ).    #     if s
-0001c1a0: 656c 662e 6d75 6c74 695f 6e65 7477 6f72  elf.multi_networ
-0001c1b0: 6b3a 0a20 2020 2023 2020 2020 2020 2020  k:.    #        
-0001c1c0: 2069 6620 6e65 7477 6f72 6b20 6973 204e   if network is N
-0001c1d0: 6f6e 653a 0a20 2020 2023 2020 2020 2020  one:.    #      
-0001c1e0: 2020 2020 2020 2072 6169 7365 2043 6c69         raise Cli
-0001c1f0: 6e69 6361 444c 4172 6775 6d65 6e74 4572  nicaDLArgumentEr
-0001c200: 726f 7228 0a20 2020 2023 2020 2020 2020  ror(.    #      
-0001c210: 2020 2020 2020 2020 2020 2022 506c 6561             "Plea
-0001c220: 7365 2070 7265 6369 7365 2074 6865 206e  se precise the n
-0001c230: 6574 776f 726b 206e 756d 6265 7220 7468  etwork number th
-0001c240: 6174 206d 7573 7420 6265 206c 6f61 6465  at must be loade
-0001c250: 642e 220a 2020 2020 2320 2020 2020 2020  d.".    #       
-0001c260: 2020 2020 2020 290a 2020 2020 2320 2020        ).    #   
-0001c270: 2020 7265 7475 726e 2073 656c 662e 6765    return self.ge
-0001c280: 745f 7374 6174 655f 6469 6374 2873 706c  t_state_dict(spl
-0001c290: 6974 3d73 706c 6974 2c20 7365 6c65 6374  it=split, select
-0001c2a0: 696f 6e5f 6d65 7472 6963 3d73 656c 6563  ion_metric=selec
-0001c2b0: 7469 6f6e 5f6d 6574 7269 6329 5b0a 2020  tion_metric)[.  
-0001c2c0: 2020 2320 2020 2020 2020 2020 2265 706f    #         "epo
-0001c2d0: 6368 220a 2020 2020 2320 2020 2020 5d0a  ch".    #     ].
-0001c2e0: 0a20 2020 2064 6566 2067 6574 5f73 7461  .    def get_sta
-0001c2f0: 7465 5f64 6963 7428 0a20 2020 2020 2020  te_dict(.       
-0001c300: 2073 656c 662c 2073 706c 6974 3d30 2c20   self, split=0, 
-0001c310: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001c320: 3d4e 6f6e 652c 206e 6574 776f 726b 3d4e  =None, network=N
-0001c330: 6f6e 652c 206d 6170 5f6c 6f63 6174 696f  one, map_locatio
-0001c340: 6e3d 4e6f 6e65 0a20 2020 2029 3a0a 2020  n=None.    ):.  
-0001c350: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c360: 2020 4765 7420 7468 6520 6d6f 6465 6c20    Get the model 
-0001c370: 7472 6169 6e65 6420 636f 7272 6573 706f  trained correspo
-0001c380: 6e64 696e 6720 746f 206f 6e65 2073 706c  nding to one spl
-0001c390: 6974 2061 6e64 206f 6e65 206d 6574 7269  it and one metri
-0001c3a0: 6320 6576 616c 7561 7465 6420 6f6e 2074  c evaluated on t
-0001c3b0: 6865 2076 616c 6964 6174 696f 6e20 7365  he validation se
-0001c3c0: 742e 0a0a 2020 2020 2020 2020 4172 6773  t...        Args
-0001c3d0: 3a0a 2020 2020 2020 2020 2020 2020 7370  :.            sp
-0001c3e0: 6c69 7420 2869 6e74 293a 2049 6e64 6578  lit (int): Index
-0001c3f0: 206f 6620 7468 6520 7370 6c69 7420 7573   of the split us
-0001c400: 6564 2066 6f72 2074 7261 696e 696e 672e  ed for training.
-0001c410: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001c420: 6563 7469 6f6e 5f6d 6574 7269 6320 2873  ection_metric (s
-0001c430: 7472 293a 206e 616d 6520 6f66 2074 6865  tr): name of the
-0001c440: 206d 6574 7269 6320 7573 6564 2066 6f72   metric used for
-0001c450: 2074 6865 2073 656c 6563 7469 6f6e 2e0a   the selection..
-0001c460: 2020 2020 2020 2020 2020 2020 6e65 7477              netw
-0001c470: 6f72 6b20 2869 6e74 293a 2049 6e64 6578  ork (int): Index
-0001c480: 206f 6620 7468 6520 6e65 7477 6f72 6b20   of the network 
-0001c490: 7472 6169 6e65 6420 2875 7365 6420 696e  trained (used in
-0001c4a0: 206d 756c 7469 2d6e 6574 776f 726b 2073   multi-network s
-0001c4b0: 6574 7469 6e67 206f 6e6c 7929 2e0a 2020  etting only)..  
-0001c4c0: 2020 2020 2020 2020 2020 6d61 705f 6c6f            map_lo
-0001c4d0: 6361 7469 6f6e 2028 7374 7229 3a20 746f  cation (str): to
-0001c4e0: 7263 682e 6465 7669 6365 206f 626a 6563  rch.device objec
-0001c4f0: 7420 6f72 2061 2073 7472 696e 6720 636f  t or a string co
-0001c500: 6e74 6169 6e69 6e67 2061 2064 6576 6963  ntaining a devic
-0001c510: 6520 7461 672c 0a20 2020 2020 2020 2020  e tag,.         
-0001c520: 2020 2020 2020 2069 7420 696e 6469 6361         it indica
-0001c530: 7465 7320 7468 6520 6c6f 6361 7469 6f6e  tes the location
-0001c540: 2077 6865 7265 2061 6c6c 2074 656e 736f   where all tenso
-0001c550: 7273 2073 686f 756c 6420 6265 206c 6f61  rs should be loa
-0001c560: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0001c570: 2020 2020 2028 7365 6520 6874 7470 733a       (see https:
-0001c580: 2f2f 7079 746f 7263 682e 6f72 672f 646f  //pytorch.org/do
-0001c590: 6373 2f73 7461 626c 652f 6765 6e65 7261  cs/stable/genera
-0001c5a0: 7465 642f 746f 7263 682e 6c6f 6164 2e68  ted/torch.load.h
-0001c5b0: 746d 6c29 2e0a 2020 2020 2020 2020 5265  tml)..        Re
-0001c5c0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-0001c5d0: 2020 2028 4469 6374 293a 2064 6963 7469     (Dict): dicti
-0001c5e0: 6f6e 6172 7920 6f66 2072 6573 756c 7473  onary of results
-0001c5f0: 2028 7765 6967 6874 732c 2065 706f 6368   (weights, epoch
-0001c600: 206e 756d 6265 722c 206d 6574 7269 6373   number, metrics
-0001c610: 2076 616c 7565 7329 0a20 2020 2020 2020   values).       
-0001c620: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
-0001c630: 6563 7469 6f6e 5f6d 6574 7269 6320 3d20  ection_metric = 
-0001c640: 7365 6c66 2e5f 6368 6563 6b5f 7365 6c65  self._check_sele
-0001c650: 6374 696f 6e5f 6d65 7472 6963 2873 706c  ction_metric(spl
-0001c660: 6974 2c20 7365 6c65 6374 696f 6e5f 6d65  it, selection_me
-0001c670: 7472 6963 290a 2020 2020 2020 2020 6966  tric).        if
-0001c680: 2073 656c 662e 6d75 6c74 695f 6e65 7477   self.multi_netw
-0001c690: 6f72 6b3a 0a20 2020 2020 2020 2020 2020  ork:.           
-0001c6a0: 2069 6620 6e65 7477 6f72 6b20 6973 204e   if network is N
-0001c6b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001c6c0: 2020 2020 2072 6169 7365 2043 6c69 6e69       raise Clini
-0001c6d0: 6361 444c 4172 6775 6d65 6e74 4572 726f  caDLArgumentErro
-0001c6e0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0001c6f0: 2020 2020 2020 2022 506c 6561 7365 2070         "Please p
-0001c700: 7265 6369 7365 2074 6865 206e 6574 776f  recise the netwo
-0001c710: 726b 206e 756d 6265 7220 7468 6174 206d  rk number that m
-0001c720: 7573 7420 6265 206c 6f61 6465 642e 220a  ust be loaded.".
-0001c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c740: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0001c750: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001c760: 2020 2020 6d6f 6465 6c5f 7061 7468 203d      model_path =
-0001c770: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001c780: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
-0001c790: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
-0001c7a0: 2020 2020 2020 2020 2020 2f20 6622 7b73            / f"{s
-0001c7b0: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
-0001c7c0: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
-0001c7d0: 2020 2020 2020 2020 2020 2020 202f 2066               / f
-0001c7e0: 2262 6573 742d 7b73 656c 6563 7469 6f6e  "best-{selection
-0001c7f0: 5f6d 6574 7269 637d 220a 2020 2020 2020  _metric}".      
-0001c800: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-0001c810: 6622 6e65 7477 6f72 6b2d 7b6e 6574 776f  f"network-{netwo
-0001c820: 726b 7d5f 6d6f 6465 6c2e 7074 682e 7461  rk}_model.pth.ta
-0001c830: 7222 0a20 2020 2020 2020 2020 2020 2020  r".             
-0001c840: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0001c850: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-0001c860: 6f64 656c 5f70 6174 6820 3d20 280a 2020  odel_path = (.  
-0001c870: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001c880: 6c66 2e6d 6170 735f 7061 7468 0a20 2020  lf.maps_path.   
-0001c890: 2020 2020 2020 2020 2020 2020 202f 2066               / f
-0001c8a0: 227b 7365 6c66 2e73 706c 6974 5f6e 616d  "{self.split_nam
-0001c8b0: 657d 2d7b 7370 6c69 747d 220a 2020 2020  e}-{split}".    
-0001c8c0: 2020 2020 2020 2020 2020 2020 2f20 6622              / f"
-0001c8d0: 6265 7374 2d7b 7365 6c65 6374 696f 6e5f  best-{selection_
-0001c8e0: 6d65 7472 6963 7d22 0a20 2020 2020 2020  metric}".       
-0001c8f0: 2020 2020 2020 2020 202f 2022 6d6f 6465           / "mode
-0001c900: 6c2e 7074 682e 7461 7222 0a20 2020 2020  l.pth.tar".     
-0001c910: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001c920: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
-0001c930: 2020 2020 2020 2020 2020 2066 224c 6f61             f"Loa
-0001c940: 6469 6e67 206d 6f64 656c 2074 7261 696e  ding model train
-0001c950: 6564 2066 6f72 2073 706c 6974 207b 7370  ed for split {sp
-0001c960: 6c69 747d 2022 0a20 2020 2020 2020 2020  lit} ".         
-0001c970: 2020 2066 2273 656c 6563 7465 6420 6163     f"selected ac
-0001c980: 636f 7264 696e 6720 746f 2062 6573 7420  cording to best 
-0001c990: 7661 6c69 6461 7469 6f6e 207b 7365 6c65  validation {sele
-0001c9a0: 6374 696f 6e5f 6d65 7472 6963 7d20 220a  ction_metric} ".
-0001c9b0: 2020 2020 2020 2020 2020 2020 6622 6174              f"at
-0001c9c0: 2070 6174 6820 7b6d 6f64 656c 5f70 6174   path {model_pat
-0001c9d0: 687d 2e22 0a20 2020 2020 2020 2029 0a20  h}.".        ). 
-0001c9e0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
-0001c9f0: 7263 682e 6c6f 6164 286d 6f64 656c 5f70  rch.load(model_p
-0001ca00: 6174 682c 206d 6170 5f6c 6f63 6174 696f  ath, map_locatio
-0001ca10: 6e3d 6d61 705f 6c6f 6361 7469 6f6e 290a  n=map_location).
-0001ca20: 0a20 2020 2064 6566 2067 6574 5f70 7265  .    def get_pre
-0001ca30: 6469 6374 696f 6e28 0a20 2020 2020 2020  diction(.       
-0001ca40: 2073 656c 662c 2064 6174 615f 6772 6f75   self, data_grou
-0001ca50: 702c 2073 706c 6974 3d30 2c20 7365 6c65  p, split=0, sele
-0001ca60: 6374 696f 6e5f 6d65 7472 6963 3d4e 6f6e  ction_metric=Non
-0001ca70: 652c 206d 6f64 653d 2269 6d61 6765 222c  e, mode="image",
-0001ca80: 2076 6572 626f 7365 3d46 616c 7365 0a20   verbose=False. 
-0001ca90: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-0001caa0: 220a 2020 2020 2020 2020 4765 7420 7468  ".        Get th
-0001cab0: 6520 696e 6469 7669 6475 616c 2070 7265  e individual pre
-0001cac0: 6469 6374 696f 6e73 2066 6f72 2065 6163  dictions for eac
-0001cad0: 6820 7061 7274 6963 6970 616e 7420 636f  h participant co
-0001cae0: 7272 6573 706f 6e64 696e 6720 746f 206f  rresponding to o
-0001caf0: 6e65 2067 726f 7570 0a20 2020 2020 2020  ne group.       
-0001cb00: 206f 6620 7061 7274 6963 6970 616e 7473   of participants
-0001cb10: 2069 6465 6e74 6966 6965 6420 6279 2069   identified by i
-0001cb20: 7473 2064 6174 6120 6772 6f75 702e 0a0a  ts data group...
-0001cb30: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0001cb40: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-0001cb50: 726f 7570 2028 7374 7229 3a20 6e61 6d65  roup (str): name
-0001cb60: 206f 6620 7468 6520 6461 7461 2067 726f   of the data gro
-0001cb70: 7570 2075 7365 6420 666f 7220 7468 6520  up used for the 
-0001cb80: 7072 6564 6963 7469 6f6e 2074 6173 6b2e  prediction task.
-0001cb90: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
-0001cba0: 6974 2028 696e 7429 3a20 496e 6465 7820  it (int): Index 
-0001cbb0: 6f66 2074 6865 2073 706c 6974 2075 7365  of the split use
-0001cbc0: 6420 666f 7220 7472 6169 6e69 6e67 2e0a  d for training..
-0001cbd0: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-0001cbe0: 6374 696f 6e5f 6d65 7472 6963 2028 7374  ction_metric (st
-0001cbf0: 7229 3a20 4d65 7472 6963 2075 7365 6420  r): Metric used 
-0001cc00: 666f 7220 6265 7374 2077 6569 6768 7473  for best weights
-0001cc10: 2073 656c 6563 7469 6f6e 2e0a 2020 2020   selection..    
-0001cc20: 2020 2020 2020 2020 6d6f 6465 2028 7374          mode (st
-0001cc30: 7229 3a20 6c65 7665 6c20 6f66 2074 6865  r): level of the
-0001cc40: 2070 7265 6469 6374 696f 6e2e 0a20 2020   prediction..   
-0001cc50: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-0001cc60: 2028 626f 6f6c 293a 2069 6620 5472 7565   (bool): if True
-0001cc70: 2077 696c 6c20 7072 696e 7420 6173 736f   will print asso
-0001cc80: 6369 6174 6564 2070 7265 6469 6374 696f  ciated predictio
-0001cc90: 6e2e 6c6f 672e 0a20 2020 2020 2020 2052  n.log..        R
-0001cca0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0001ccb0: 2020 2020 2844 6174 6146 7261 6d65 293a      (DataFrame):
-0001ccc0: 2052 6573 756c 7473 2069 6e64 6578 6564   Results indexed
-0001ccd0: 2062 7920 636f 6c75 6d6e 7320 2770 6172   by columns 'par
-0001cce0: 7469 6369 7061 6e74 5f69 6427 2061 6e64  ticipant_id' and
-0001ccf0: 2027 7365 7373 696f 6e5f 6964 2720 7768   'session_id' wh
-0001cd00: 6963 680a 2020 2020 2020 2020 2020 2020  ich.            
-0001cd10: 6964 656e 7469 6669 6573 2074 6865 2069  identifies the i
-0001cd20: 6d61 6765 2069 6e20 7468 6520 4249 4453  mage in the BIDS
-0001cd30: 202f 2043 4150 532e 0a20 2020 2020 2020   / CAPS..       
-0001cd40: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
-0001cd50: 6563 7469 6f6e 5f6d 6574 7269 6320 3d20  ection_metric = 
-0001cd60: 7365 6c66 2e5f 6368 6563 6b5f 7365 6c65  self._check_sele
-0001cd70: 6374 696f 6e5f 6d65 7472 6963 2873 706c  ction_metric(spl
-0001cd80: 6974 2c20 7365 6c65 6374 696f 6e5f 6d65  it, selection_me
-0001cd90: 7472 6963 290a 2020 2020 2020 2020 6966  tric).        if
-0001cda0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0001cdb0: 2020 2020 2020 7365 6c66 2e5f 7072 696e        self._prin
-0001cdc0: 745f 6465 7363 7269 7074 696f 6e5f 6c6f  t_description_lo
-0001cdd0: 6728 6461 7461 5f67 726f 7570 2c20 7370  g(data_group, sp
-0001cde0: 6c69 742c 2073 656c 6563 7469 6f6e 5f6d  lit, selection_m
-0001cdf0: 6574 7269 6329 0a20 2020 2020 2020 2070  etric).        p
-0001ce00: 7265 6469 6374 696f 6e5f 6469 7220 3d20  rediction_dir = 
-0001ce10: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-0001ce20: 6c66 2e6d 6170 735f 7061 7468 0a20 2020  lf.maps_path.   
-0001ce30: 2020 2020 2020 2020 202f 2066 227b 7365           / f"{se
-0001ce40: 6c66 2e73 706c 6974 5f6e 616d 657d 2d7b  lf.split_name}-{
-0001ce50: 7370 6c69 747d 220a 2020 2020 2020 2020  split}".        
-0001ce60: 2020 2020 2f20 6622 6265 7374 2d7b 7365      / f"best-{se
-0001ce70: 6c65 6374 696f 6e5f 6d65 7472 6963 7d22  lection_metric}"
-0001ce80: 0a20 2020 2020 2020 2020 2020 202f 2064  .            / d
-0001ce90: 6174 615f 6772 6f75 700a 2020 2020 2020  ata_group.      
-0001cea0: 2020 290a 2020 2020 2020 2020 6966 206e    ).        if n
-0001ceb0: 6f74 2070 7265 6469 6374 696f 6e5f 6469  ot prediction_di
-0001cec0: 722e 6973 5f64 6972 2829 3a0a 2020 2020  r.is_dir():.    
-0001ced0: 2020 2020 2020 2020 7261 6973 6520 4d41          raise MA
-0001cee0: 5053 4572 726f 7228 0a20 2020 2020 2020  PSError(.       
-0001cef0: 2020 2020 2020 2020 2066 224e 6f20 7072           f"No pr
-0001cf00: 6564 6963 7469 6f6e 2063 6f72 7265 7370  ediction corresp
-0001cf10: 6f6e 6469 6e67 2074 6f20 6461 7461 2067  onding to data g
-0001cf20: 726f 7570 207b 6461 7461 5f67 726f 7570  roup {data_group
-0001cf30: 7d20 7761 7320 666f 756e 642e 220a 2020  } was found.".  
-0001cf40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001cf50: 2020 2020 6466 203d 2070 642e 7265 6164      df = pd.read
-0001cf60: 5f63 7376 280a 2020 2020 2020 2020 2020  _csv(.          
-0001cf70: 2020 7072 6564 6963 7469 6f6e 5f64 6972    prediction_dir
-0001cf80: 202f 2066 227b 6461 7461 5f67 726f 7570   / f"{data_group
-0001cf90: 7d5f 7b6d 6f64 657d 5f6c 6576 656c 5f70  }_{mode}_level_p
-0001cfa0: 7265 6469 6374 696f 6e2e 7473 7622 2c0a  rediction.tsv",.
-0001cfb0: 2020 2020 2020 2020 2020 2020 7365 703d              sep=
-0001cfc0: 225c 7422 2c0a 2020 2020 2020 2020 290a  "\t",.        ).
-0001cfd0: 2020 2020 2020 2020 6466 2e73 6574 5f69          df.set_i
-0001cfe0: 6e64 6578 285b 2270 6172 7469 6369 7061  ndex(["participa
-0001cff0: 6e74 5f69 6422 2c20 2273 6573 7369 6f6e  nt_id", "session
-0001d000: 5f69 6422 5d2c 2069 6e70 6c61 6365 3d54  _id"], inplace=T
-0001d010: 7275 652c 2064 726f 703d 5472 7565 290a  rue, drop=True).
-0001d020: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-0001d030: 660a 0a20 2020 2064 6566 2067 6574 5f6d  f..    def get_m
-0001d040: 6574 7269 6373 280a 2020 2020 2020 2020  etrics(.        
-0001d050: 7365 6c66 2c20 6461 7461 5f67 726f 7570  self, data_group
-0001d060: 2c20 7370 6c69 743d 302c 2073 656c 6563  , split=0, selec
-0001d070: 7469 6f6e 5f6d 6574 7269 633d 4e6f 6e65  tion_metric=None
-0001d080: 2c20 6d6f 6465 3d22 696d 6167 6522 2c20  , mode="image", 
-0001d090: 7665 7262 6f73 653d 5472 7565 0a20 2020  verbose=True.   
-0001d0a0: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
-0001d0b0: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
-0001d0c0: 6d65 7472 6963 7320 636f 7272 6573 706f  metrics correspo
-0001d0d0: 6e64 696e 6720 746f 2061 2067 726f 7570  nding to a group
-0001d0e0: 206f 6620 7061 7274 6963 6970 616e 7473   of participants
-0001d0f0: 2069 6465 6e74 6966 6965 6420 6279 2069   identified by i
-0001d100: 7473 2064 6174 615f 6772 6f75 702e 0a0a  ts data_group...
-0001d110: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0001d120: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-0001d130: 726f 7570 2028 7374 7229 3a20 6e61 6d65  roup (str): name
-0001d140: 206f 6620 7468 6520 6461 7461 2067 726f   of the data gro
-0001d150: 7570 2075 7365 6420 666f 7220 7468 6520  up used for the 
-0001d160: 7072 6564 6963 7469 6f6e 2074 6173 6b2e  prediction task.
-0001d170: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
-0001d180: 6974 2028 696e 7429 3a20 496e 6465 7820  it (int): Index 
-0001d190: 6f66 2074 6865 2073 706c 6974 2075 7365  of the split use
-0001d1a0: 6420 666f 7220 7472 6169 6e69 6e67 2e0a  d for training..
-0001d1b0: 2020 2020 2020 2020 2020 2020 7365 6c65              sele
-0001d1c0: 6374 696f 6e5f 6d65 7472 6963 2028 7374  ction_metric (st
-0001d1d0: 7229 3a20 4d65 7472 6963 2075 7365 6420  r): Metric used 
-0001d1e0: 666f 7220 6265 7374 2077 6569 6768 7473  for best weights
-0001d1f0: 2073 656c 6563 7469 6f6e 2e0a 2020 2020   selection..    
-0001d200: 2020 2020 2020 2020 6d6f 6465 2028 7374          mode (st
-0001d210: 7229 3a20 6c65 7665 6c20 6f66 2074 6865  r): level of the
-0001d220: 2070 7265 6469 6374 696f 6e0a 2020 2020   prediction.    
-0001d230: 2020 2020 2020 2020 7665 7262 6f73 6520          verbose 
-0001d240: 2862 6f6f 6c29 3a20 6966 2054 7275 6520  (bool): if True 
-0001d250: 7769 6c6c 2070 7269 6e74 2061 7373 6f63  will print assoc
-0001d260: 6961 7465 6420 7072 6564 6963 7469 6f6e  iated prediction
-0001d270: 2e6c 6f67 0a20 2020 2020 2020 2052 6574  .log.        Ret
-0001d280: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-0001d290: 2020 2864 6963 745b 7374 723a 666c 6f61    (dict[str:floa
-0001d2a0: 745d 293a 2056 616c 7565 7320 6f66 2074  t]): Values of t
-0001d2b0: 6865 206d 6574 7269 6373 0a20 2020 2020  he metrics.     
-0001d2c0: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-0001d2d0: 656c 6563 7469 6f6e 5f6d 6574 7269 6320  election_metric 
-0001d2e0: 3d20 7365 6c66 2e5f 6368 6563 6b5f 7365  = self._check_se
-0001d2f0: 6c65 6374 696f 6e5f 6d65 7472 6963 2873  lection_metric(s
-0001d300: 706c 6974 2c20 7365 6c65 6374 696f 6e5f  plit, selection_
-0001d310: 6d65 7472 6963 290a 2020 2020 2020 2020  metric).        
-0001d320: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-0001d330: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-0001d340: 696e 745f 6465 7363 7269 7074 696f 6e5f  int_description_
-0001d350: 6c6f 6728 6461 7461 5f67 726f 7570 2c20  log(data_group, 
-0001d360: 7370 6c69 742c 2073 656c 6563 7469 6f6e  split, selection
-0001d370: 5f6d 6574 7269 6329 0a20 2020 2020 2020  _metric).       
-0001d380: 2070 7265 6469 6374 696f 6e5f 6469 7220   prediction_dir 
-0001d390: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0001d3a0: 7365 6c66 2e6d 6170 735f 7061 7468 0a20  self.maps_path. 
-0001d3b0: 2020 2020 2020 2020 2020 202f 2066 227b             / f"{
-0001d3c0: 7365 6c66 2e73 706c 6974 5f6e 616d 657d  self.split_name}
-0001d3d0: 2d7b 7370 6c69 747d 220a 2020 2020 2020  -{split}".      
-0001d3e0: 2020 2020 2020 2f20 6622 6265 7374 2d7b        / f"best-{
-0001d3f0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001d400: 7d22 0a20 2020 2020 2020 2020 2020 202f  }".            /
-0001d410: 2064 6174 615f 6772 6f75 700a 2020 2020   data_group.    
-0001d420: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-0001d430: 206e 6f74 2070 7265 6469 6374 696f 6e5f   not prediction_
-0001d440: 6469 722e 6973 5f64 6972 2829 3a0a 2020  dir.is_dir():.  
-0001d450: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001d460: 4d41 5053 4572 726f 7228 0a20 2020 2020  MAPSError(.     
-0001d470: 2020 2020 2020 2020 2020 2066 224e 6f20             f"No 
-0001d480: 7072 6564 6963 7469 6f6e 2063 6f72 7265  prediction corre
-0001d490: 7370 6f6e 6469 6e67 2074 6f20 6461 7461  sponding to data
-0001d4a0: 2067 726f 7570 207b 6461 7461 5f67 726f   group {data_gro
-0001d4b0: 7570 7d20 7761 7320 666f 756e 642e 220a  up} was found.".
-0001d4c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001d4d0: 2020 2020 2020 6466 203d 2070 642e 7265        df = pd.re
-0001d4e0: 6164 5f63 7376 280a 2020 2020 2020 2020  ad_csv(.        
-0001d4f0: 2020 2020 7072 6564 6963 7469 6f6e 5f64      prediction_d
-0001d500: 6972 202f 2066 227b 6461 7461 5f67 726f  ir / f"{data_gro
-0001d510: 7570 7d5f 7b6d 6f64 657d 5f6c 6576 656c  up}_{mode}_level
-0001d520: 5f6d 6574 7269 6373 2e74 7376 222c 2073  _metrics.tsv", s
-0001d530: 6570 3d22 5c74 220a 2020 2020 2020 2020  ep="\t".        
-0001d540: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001d550: 2064 662e 746f 5f64 6963 7428 2272 6563   df.to_dict("rec
-0001d560: 6f72 6473 2229 5b30 5d0a 0a20 2020 2064  ords")[0]..    d
-0001d570: 6566 2067 6574 5f69 6e74 6572 7072 6574  ef get_interpret
-0001d580: 6174 696f 6e28 0a20 2020 2020 2020 2073  ation(.        s
-0001d590: 656c 662c 0a20 2020 2020 2020 2064 6174  elf,.        dat
-0001d5a0: 615f 6772 6f75 702c 0a20 2020 2020 2020  a_group,.       
-0001d5b0: 206e 616d 652c 0a20 2020 2020 2020 2073   name,.        s
-0001d5c0: 706c 6974 3d30 2c0a 2020 2020 2020 2020  plit=0,.        
-0001d5d0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001d5e0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2076  =None,.        v
-0001d5f0: 6572 626f 7365 3d54 7275 652c 0a20 2020  erbose=True,.   
-0001d600: 2020 2020 2070 6172 7469 6369 7061 6e74       participant
-0001d610: 5f69 643d 4e6f 6e65 2c0a 2020 2020 2020  _id=None,.      
-0001d620: 2020 7365 7373 696f 6e5f 6964 3d4e 6f6e    session_id=Non
-0001d630: 652c 0a20 2020 2020 2020 206d 6f64 655f  e,.        mode_
-0001d640: 6964 3d30 2c0a 2020 2020 2920 2d3e 2074  id=0,.    ) -> t
-0001d650: 6f72 6368 2e54 656e 736f 723a 0a20 2020  orch.Tensor:.   
-0001d660: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001d670: 2047 6574 2074 6865 2069 6e64 6976 6964   Get the individ
-0001d680: 7561 6c20 696e 7465 7270 7265 7461 7469  ual interpretati
-0001d690: 6f6e 206d 6170 7320 666f 7220 6f6e 6520  on maps for one 
-0001d6a0: 7365 7373 696f 6e20 6966 2070 6172 7469  session if parti
-0001d6b0: 6369 7061 6e74 5f69 6420 616e 6420 7365  cipant_id and se
-0001d6c0: 7373 696f 6e5f 6964 2061 7265 2066 696c  ssion_id are fil
-0001d6d0: 6c65 642e 0a20 2020 2020 2020 2045 6c73  led..        Els
-0001d6e0: 6520 6c6f 6164 2074 6865 206d 6561 6e20  e load the mean 
-0001d6f0: 696e 7465 7270 7265 7461 7469 6f6e 206d  interpretation m
-0001d700: 6170 2e0a 0a20 2020 2020 2020 2041 7267  ap...        Arg
-0001d710: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-0001d720: 6174 615f 6772 6f75 7020 2873 7472 293a  ata_group (str):
-0001d730: 204e 616d 6520 6f66 2074 6865 2064 6174   Name of the dat
-0001d740: 6120 6772 6f75 7020 7573 6564 2066 6f72  a group used for
-0001d750: 2074 6865 2069 6e74 6572 7072 6574 6174   the interpretat
-0001d760: 696f 6e20 7461 736b 2e0a 2020 2020 2020  ion task..      
-0001d770: 2020 2020 2020 6e61 6d65 2028 7374 7229        name (str)
-0001d780: 3a20 6e61 6d65 206f 6620 7468 6520 696e  : name of the in
-0001d790: 7465 7270 7265 7461 7469 6f6e 2074 6173  terpretation tas
-0001d7a0: 6b2e 0a20 2020 2020 2020 2020 2020 2073  k..            s
-0001d7b0: 706c 6974 2028 696e 7429 3a20 496e 6465  plit (int): Inde
-0001d7c0: 7820 6f66 2074 6865 2073 706c 6974 2075  x of the split u
-0001d7d0: 7365 6420 666f 7220 7472 6169 6e69 6e67  sed for training
-0001d7e0: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001d7f0: 6c65 6374 696f 6e5f 6d65 7472 6963 2028  lection_metric (
-0001d800: 7374 7229 3a20 4d65 7472 6963 2075 7365  str): Metric use
-0001d810: 6420 666f 7220 6265 7374 2077 6569 6768  d for best weigh
-0001d820: 7473 2073 656c 6563 7469 6f6e 2e0a 2020  ts selection..  
-0001d830: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-0001d840: 6520 2862 6f6f 6c29 3a20 6966 2054 7275  e (bool): if Tru
-0001d850: 6520 7769 6c6c 2070 7269 6e74 2061 7373  e will print ass
-0001d860: 6f63 6961 7465 6420 7072 6564 6963 7469  ociated predicti
-0001d870: 6f6e 2e6c 6f67 2e0a 2020 2020 2020 2020  on.log..        
-0001d880: 2020 2020 7061 7274 6963 6970 616e 745f      participant_
-0001d890: 6964 2028 7374 7229 3a20 4944 206f 6620  id (str): ID of 
-0001d8a0: 7468 6520 7061 7274 6963 6970 616e 7420  the participant 
-0001d8b0: 2869 6620 6e6f 7420 6769 7665 6e20 6c6f  (if not given lo
-0001d8c0: 6164 206d 6561 6e20 6d61 7029 2e0a 2020  ad mean map)..  
-0001d8d0: 2020 2020 2020 2020 2020 7365 7373 696f            sessio
-0001d8e0: 6e5f 6964 2028 7374 7229 3a20 4944 206f  n_id (str): ID o
-0001d8f0: 6620 7468 6520 7365 7373 696f 6e20 2869  f the session (i
-0001d900: 6620 6e6f 7420 6769 7665 206c 6f61 6420  f not give load 
-0001d910: 7468 6520 6d65 616e 206d 6170 292e 0a20  the mean map).. 
-0001d920: 2020 2020 2020 2020 2020 206d 6f64 655f             mode_
-0001d930: 6964 2028 696e 7429 3a20 496e 6465 7820  id (int): Index 
-0001d940: 6f66 2074 6865 206d 6f64 6520 7573 6564  of the mode used
-0001d950: 2e0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-0001d960: 733a 0a20 2020 2020 2020 2020 2020 2028  s:.            (
-0001d970: 746f 7263 682e 5465 6e73 6f72 293a 2054  torch.Tensor): T
-0001d980: 656e 736f 7220 6f66 2074 6865 2069 6e74  ensor of the int
-0001d990: 6572 7072 6574 6162 696c 6974 7920 6d61  erpretability ma
-0001d9a0: 702e 0a20 2020 2020 2020 2022 2222 0a0a  p..        """..
-0001d9b0: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
-0001d9c0: 6e5f 6d65 7472 6963 203d 2073 656c 662e  n_metric = self.
-0001d9d0: 5f63 6865 636b 5f73 656c 6563 7469 6f6e  _check_selection
-0001d9e0: 5f6d 6574 7269 6328 7370 6c69 742c 2073  _metric(split, s
-0001d9f0: 656c 6563 7469 6f6e 5f6d 6574 7269 6329  election_metric)
-0001da00: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-0001da10: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0001da20: 2073 656c 662e 5f70 7269 6e74 5f64 6573   self._print_des
-0001da30: 6372 6970 7469 6f6e 5f6c 6f67 2864 6174  cription_log(dat
-0001da40: 615f 6772 6f75 702c 2073 706c 6974 2c20  a_group, split, 
-0001da50: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
-0001da60: 290a 2020 2020 2020 2020 6d61 705f 6469  ).        map_di
-0001da70: 7220 3d20 280a 2020 2020 2020 2020 2020  r = (.          
-0001da80: 2020 7365 6c66 2e6d 6170 735f 7061 7468    self.maps_path
-0001da90: 0a20 2020 2020 2020 2020 2020 202f 2066  .            / f
-0001daa0: 227b 7365 6c66 2e73 706c 6974 5f6e 616d  "{self.split_nam
-0001dab0: 657d 2d7b 7370 6c69 747d 220a 2020 2020  e}-{split}".    
-0001dac0: 2020 2020 2020 2020 2f20 6622 6265 7374          / f"best
-0001dad0: 2d7b 7365 6c65 6374 696f 6e5f 6d65 7472  -{selection_metr
-0001dae0: 6963 7d22 0a20 2020 2020 2020 2020 2020  ic}".           
-0001daf0: 202f 2064 6174 615f 6772 6f75 700a 2020   / data_group.  
-0001db00: 2020 2020 2020 2020 2020 2f20 6622 696e            / f"in
-0001db10: 7465 7270 7265 742d 7b6e 616d 657d 220a  terpret-{name}".
-0001db20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001db30: 2020 6966 206e 6f74 206d 6170 5f64 6972    if not map_dir
-0001db40: 2e69 735f 6469 7228 293a 0a20 2020 2020  .is_dir():.     
-0001db50: 2020 2020 2020 2072 6169 7365 204d 4150         raise MAP
-0001db60: 5345 7272 6f72 280a 2020 2020 2020 2020  SError(.        
-0001db70: 2020 2020 2020 2020 6622 4e6f 2070 7265          f"No pre
-0001db80: 6469 6374 696f 6e20 636f 7272 6573 706f  diction correspo
-0001db90: 6e64 696e 6720 746f 2064 6174 6120 6772  nding to data gr
-0001dba0: 6f75 7020 7b64 6174 615f 6772 6f75 707d  oup {data_group}
-0001dbb0: 2061 6e64 2022 0a20 2020 2020 2020 2020   and ".         
-0001dbc0: 2020 2020 2020 2066 2269 6e74 6572 7072         f"interpr
-0001dbd0: 6574 6174 696f 6e20 7b6e 616d 657d 2077  etation {name} w
-0001dbe0: 6173 2066 6f75 6e64 2e22 0a20 2020 2020  as found.".     
-0001dbf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001dc00: 2069 6620 7061 7274 6963 6970 616e 745f   if participant_
-0001dc10: 6964 2069 7320 4e6f 6e65 2061 6e64 2073  id is None and s
-0001dc20: 6573 7369 6f6e 5f69 6420 6973 204e 6f6e  ession_id is Non
-0001dc30: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-0001dc40: 6170 5f70 7420 3d20 746f 7263 682e 6c6f  ap_pt = torch.lo
-0001dc50: 6164 286d 6170 5f64 6972 202f 2066 226d  ad(map_dir / f"m
-0001dc60: 6561 6e5f 7b73 656c 662e 6d6f 6465 7d2d  ean_{self.mode}-
-0001dc70: 7b6d 6f64 655f 6964 7d5f 6d61 702e 7074  {mode_id}_map.pt
-0001dc80: 2229 0a20 2020 2020 2020 2065 6c69 6620  ").        elif 
-0001dc90: 7061 7274 6963 6970 616e 745f 6964 2069  participant_id i
-0001dca0: 7320 4e6f 6e65 206f 7220 7365 7373 696f  s None or sessio
-0001dcb0: 6e5f 6964 2069 7320 4e6f 6e65 3a0a 2020  n_id is None:.  
-0001dcc0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001dcd0: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-0001dce0: 2020 2020 2020 2020 2020 2020 6622 546f              f"To
-0001dcf0: 206c 6f61 6420 7468 6520 6d65 616e 2069   load the mean i
-0001dd00: 6e74 6572 7072 6574 6174 696f 6e20 6d61  nterpretation ma
-0001dd10: 702c 2022 0a20 2020 2020 2020 2020 2020  p, ".           
-0001dd20: 2020 2020 2066 2270 6c65 6173 6520 646f       f"please do
-0001dd30: 206e 6f74 2067 6976 6520 616e 7920 7061   not give any pa
-0001dd40: 7274 6963 6970 616e 745f 6964 206f 7220  rticipant_id or 
-0001dd50: 7365 7373 696f 6e5f 6964 2e5c 6e20 220a  session_id.\n ".
-0001dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd70: 6622 456c 7365 2073 7065 6369 6679 2062  f"Else specify b
-0001dd80: 6f74 6820 7061 7261 6d65 7465 7273 220a  oth parameters".
-0001dd90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001dda0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001ddb0: 2020 2020 2020 2020 6d61 705f 7074 203d          map_pt =
-0001ddc0: 2074 6f72 6368 2e6c 6f61 6428 0a20 2020   torch.load(.   
-0001ddd0: 2020 2020 2020 2020 2020 2020 206d 6170               map
-0001dde0: 5f64 6972 202f 2066 227b 7061 7274 6963  _dir / f"{partic
-0001ddf0: 6970 616e 745f 6964 7d5f 7b73 6573 7369  ipant_id}_{sessi
-0001de00: 6f6e 5f69 647d 5f7b 7365 6c66 2e6d 6f64  on_id}_{self.mod
-0001de10: 657d 2d7b 6d6f 6465 5f69 647d 5f6d 6170  e}-{mode_id}_map
-0001de20: 2e70 7422 0a20 2020 2020 2020 2020 2020  .pt".           
-0001de30: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0001de40: 6e20 6d61 705f 7074 0a0a 2020 2020 6465  n map_pt..    de
-0001de50: 6620 5f69 6e69 745f 6361 6c6c 6261 636b  f _init_callback
-0001de60: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0001de70: 2066 726f 6d20 636c 696e 6963 6164 6c2e   from clinicadl.
-0001de80: 7574 696c 732e 6361 6c6c 6261 636b 732e  utils.callbacks.
-0001de90: 6361 6c6c 6261 636b 7320 696d 706f 7274  callbacks import
-0001dea0: 2028 0a20 2020 2020 2020 2020 2020 2043   (.            C
-0001deb0: 616c 6c62 6163 6b2c 0a20 2020 2020 2020  allback,.       
-0001dec0: 2020 2020 2043 616c 6c62 6163 6b73 4861       CallbacksHa
-0001ded0: 6e64 6c65 722c 0a20 2020 2020 2020 2020  ndler,.         
-0001dee0: 2020 204c 6f67 6765 7243 616c 6c62 6163     LoggerCallbac
-0001def0: 6b2c 0a20 2020 2020 2020 2029 0a0a 2020  k,.        )..  
-0001df00: 2020 2020 2020 2320 6966 2073 656c 662e        # if self.
-0001df10: 6361 6c6c 6261 636b 7320 6973 204e 6f6e  callbacks is Non
-0001df20: 653a 0a20 2020 2020 2020 2023 2020 2020  e:.        #    
-0001df30: 2073 656c 662e 6361 6c6c 6261 636b 7320   self.callbacks 
-0001df40: 3d20 5b43 616c 6c62 6163 6b28 295d 0a0a  = [Callback()]..
-0001df50: 2020 2020 2020 2020 7365 6c66 2e63 616c          self.cal
-0001df60: 6c62 6163 6b5f 6861 6e64 6c65 7220 3d20  lback_handler = 
-0001df70: 4361 6c6c 6261 636b 7348 616e 646c 6572  CallbacksHandler
-0001df80: 2829 2020 2320 6361 6c6c 6261 636b 733d  ()  # callbacks=
-0001df90: 7365 6c66 2e63 616c 6c62 6163 6b73 290a  self.callbacks).
-0001dfa0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001dfb0: 2e70 6172 616d 6574 6572 735b 2265 6d69  .parameters["emi
-0001dfc0: 7373 696f 6e73 5f63 616c 6375 6c61 746f  ssions_calculato
-0001dfd0: 7222 5d3a 0a20 2020 2020 2020 2020 2020  r"]:.           
-0001dfe0: 2066 726f 6d20 636c 696e 6963 6164 6c2e   from clinicadl.
-0001dff0: 7574 696c 732e 6361 6c6c 6261 636b 732e  utils.callbacks.
-0001e000: 6361 6c6c 6261 636b 7320 696d 706f 7274  callbacks import
-0001e010: 2043 6f64 6543 6172 626f 6e54 7261 636b   CodeCarbonTrack
-0001e020: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
-0001e030: 7365 6c66 2e63 616c 6c62 6163 6b5f 6861  self.callback_ha
-0001e040: 6e64 6c65 722e 6164 645f 6361 6c6c 6261  ndler.add_callba
-0001e050: 636b 2843 6f64 6543 6172 626f 6e54 7261  ck(CodeCarbonTra
-0001e060: 636b 6572 2829 290a 0a20 2020 2020 2020  cker())..       
-0001e070: 2069 6620 7365 6c66 2e70 6172 616d 6574   if self.paramet
-0001e080: 6572 735b 2274 7261 636b 5f65 7870 225d  ers["track_exp"]
-0001e090: 3a0a 2020 2020 2020 2020 2020 2020 6672  :.            fr
-0001e0a0: 6f6d 2063 6c69 6e69 6361 646c 2e75 7469  om clinicadl.uti
-0001e0b0: 6c73 2e63 616c 6c62 6163 6b73 2e63 616c  ls.callbacks.cal
-0001e0c0: 6c62 6163 6b73 2069 6d70 6f72 7420 5472  lbacks import Tr
-0001e0d0: 6163 6b65 720a 0a20 2020 2020 2020 2020  acker..         
-0001e0e0: 2020 2073 656c 662e 6361 6c6c 6261 636b     self.callback
-0001e0f0: 5f68 616e 646c 6572 2e61 6464 5f63 616c  _handler.add_cal
-0001e100: 6c62 6163 6b28 5472 6163 6b65 7229 0a0a  lback(Tracker)..
-0001e110: 2020 2020 2020 2020 7365 6c66 2e63 616c          self.cal
-0001e120: 6c62 6163 6b5f 6861 6e64 6c65 722e 6164  lback_handler.ad
-0001e130: 645f 6361 6c6c 6261 636b 284c 6f67 6765  d_callback(Logge
-0001e140: 7243 616c 6c62 6163 6b28 2929 0a20 2020  rCallback()).   
-0001e150: 2020 2020 2023 2073 656c 662e 6361 6c6c       # self.call
-0001e160: 6261 636b 5f68 616e 646c 6572 2e61 6464  back_handler.add
-0001e170: 5f63 616c 6c62 6163 6b28 4d65 7472 6963  _callback(Metric
-0001e180: 436f 6e73 6f6c 6550 7269 6e74 6572 4361  ConsolePrinterCa
-0001e190: 6c6c 6261 636b 2829 290a                 llback()).
+00013140: 2020 2020 2020 5f2c 206c 6174 656e 742c        _, latent,
+00013150: 205f 203d 206d 6f64 656c 2e6d 6f64 756c   _ = model.modul
+00013160: 652e 5f66 6f72 7761 7264 280a 2020 2020  e._forward(.    
+00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013180: 2020 2020 696d 6167 652e 756e 7371 7565      image.unsque
+00013190: 657a 6528 3029 2e74 6f28 6d6f 6465 6c2e  eze(0).to(model.
+000131a0: 6465 7669 6365 290a 2020 2020 2020 2020  device).        
+000131b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000131c0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+000131d0: 7465 6e74 203d 206c 6174 656e 742e 7371  tent = latent.sq
+000131e0: 7565 657a 6528 3029 2e63 7075 2829 2e66  ueeze(0).cpu().f
+000131f0: 6c6f 6174 2829 0a20 2020 2020 2020 2020  loat().         
+00013200: 2020 2020 2020 2070 6172 7469 6369 7061         participa
+00013210: 6e74 5f69 6420 3d20 6461 7461 5b22 7061  nt_id = data["pa
+00013220: 7274 6963 6970 616e 745f 6964 225d 0a20  rticipant_id"]. 
+00013230: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00013240: 6573 7369 6f6e 5f69 6420 3d20 6461 7461  ession_id = data
+00013250: 5b22 7365 7373 696f 6e5f 6964 225d 0a20  ["session_id"]. 
+00013260: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00013270: 6f64 655f 6964 203d 2064 6174 615b 6622  ode_id = data[f"
+00013280: 7b73 656c 662e 6d6f 6465 7d5f 6964 225d  {self.mode}_id"]
+00013290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000132a0: 206f 7574 7075 745f 6669 6c65 6e61 6d65   output_filename
+000132b0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000132c0: 2020 2020 2020 2020 2066 227b 7061 7274           f"{part
+000132d0: 6963 6970 616e 745f 6964 7d5f 7b73 6573  icipant_id}_{ses
+000132e0: 7369 6f6e 5f69 647d 5f7b 7365 6c66 2e6d  sion_id}_{self.m
+000132f0: 6f64 657d 2d7b 6d6f 6465 5f69 647d 5f6c  ode}-{mode_id}_l
+00013300: 6174 656e 742e 7074 220a 2020 2020 2020  atent.pt".      
+00013310: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00013320: 2020 2020 2020 2020 2020 2020 746f 7263              torc
+00013330: 682e 7361 7665 286c 6174 656e 742c 2074  h.save(latent, t
+00013340: 656e 736f 725f 7061 7468 202f 206f 7574  ensor_path / out
+00013350: 7075 745f 6669 6c65 6e61 6d65 290a 0a20  put_filename).. 
+00013360: 2020 2064 6566 205f 656e 7365 6d62 6c65     def _ensemble
+00013370: 5f70 7265 6469 6374 696f 6e28 0a20 2020  _prediction(.   
+00013380: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00013390: 2020 2064 6174 615f 6772 6f75 702c 0a20     data_group,. 
+000133a0: 2020 2020 2020 2073 706c 6974 2c0a 2020         split,.  
+000133b0: 2020 2020 2020 7365 6c65 6374 696f 6e5f        selection_
+000133c0: 6d65 7472 6963 732c 0a20 2020 2020 2020  metrics,.       
+000133d0: 2075 7365 5f6c 6162 656c 733d 5472 7565   use_labels=True
+000133e0: 2c0a 2020 2020 2020 2020 736b 6970 5f6c  ,.        skip_l
+000133f0: 6561 6b5f 6368 6563 6b3d 4661 6c73 652c  eak_check=False,
+00013400: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00013410: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
+00013420: 7265 7375 6c74 7320 6f6e 2074 6865 2069  results on the i
+00013430: 6d61 6765 2d6c 6576 656c 2e22 2222 0a0a  mage-level."""..
+00013440: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00013450: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+00013460: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00013470: 6c65 6374 696f 6e5f 6d65 7472 6963 7320  lection_metrics 
+00013480: 3d20 7365 6c66 2e5f 6669 6e64 5f73 656c  = self._find_sel
+00013490: 6563 7469 6f6e 5f6d 6574 7269 6373 2873  ection_metrics(s
+000134a0: 706c 6974 290a 0a20 2020 2020 2020 2066  plit)..        f
+000134b0: 6f72 2073 656c 6563 7469 6f6e 5f6d 6574  or selection_met
+000134c0: 7269 6320 696e 2073 656c 6563 7469 6f6e  ric in selection
+000134d0: 5f6d 6574 7269 6373 3a0a 2020 2020 2020  _metrics:.      
+000134e0: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+000134f0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+00013500: 2020 2020 2020 2020 2320 536f 6674 2076          # Soft v
+00013510: 6f74 696e 670a 2020 2020 2020 2020 2020  oting.          
+00013520: 2020 6966 2073 656c 662e 6e75 6d5f 6e65    if self.num_ne
+00013530: 7477 6f72 6b73 203e 2031 2061 6e64 206e  tworks > 1 and n
+00013540: 6f74 2073 6b69 705f 6c65 616b 5f63 6865  ot skip_leak_che
+00013550: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+00013560: 2020 2020 7365 6c66 2e5f 656e 7365 6d62      self._ensemb
+00013570: 6c65 5f74 6f5f 7473 7628 0a20 2020 2020  le_to_tsv(.     
+00013580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00013590: 706c 6974 2c0a 2020 2020 2020 2020 2020  plit,.          
+000135a0: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+000135b0: 696f 6e3d 7365 6c65 6374 696f 6e5f 6d65  ion=selection_me
+000135c0: 7472 6963 2c0a 2020 2020 2020 2020 2020  tric,.          
+000135d0: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
+000135e0: 726f 7570 3d64 6174 615f 6772 6f75 702c  roup=data_group,
+000135f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013600: 2020 2020 2075 7365 5f6c 6162 656c 733d       use_labels=
+00013610: 7573 655f 6c61 6265 6c73 2c0a 2020 2020  use_labels,.    
+00013620: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013630: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
+00013640: 656c 662e 6d6f 6465 2021 3d20 2269 6d61  elf.mode != "ima
+00013650: 6765 2220 616e 6420 6e6f 7420 736b 6970  ge" and not skip
+00013660: 5f6c 6561 6b5f 6368 6563 6b3a 0a20 2020  _leak_check:.   
+00013670: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00013680: 662e 5f6d 6f64 655f 746f 5f69 6d61 6765  f._mode_to_image
+00013690: 5f74 7376 280a 2020 2020 2020 2020 2020  _tsv(.          
+000136a0: 2020 2020 2020 2020 2020 7370 6c69 742c            split,
+000136b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000136c0: 2020 2020 2073 656c 6563 7469 6f6e 3d73       selection=s
+000136d0: 656c 6563 7469 6f6e 5f6d 6574 7269 632c  election_metric,
+000136e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000136f0: 2020 2020 2064 6174 615f 6772 6f75 703d       data_group=
+00013700: 6461 7461 5f67 726f 7570 2c0a 2020 2020  data_group,.    
+00013710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013720: 7573 655f 6c61 6265 6c73 3d75 7365 5f6c  use_labels=use_l
+00013730: 6162 656c 732c 0a20 2020 2020 2020 2020  abels,.         
+00013740: 2020 2020 2020 2029 0a0a 2020 2020 2323         )..    ##
+00013750: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00013760: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+00013770: 2020 2320 4368 6563 6b73 2020 2020 2020    # Checks      
+00013780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013790: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
+000137a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000137b0: 2323 2323 230a 2020 2020 6465 6620 5f63  #####.    def _c
+000137c0: 6865 636b 5f61 7267 7328 7365 6c66 2c20  heck_args(self, 
+000137d0: 7061 7261 6d65 7465 7273 293a 0a20 2020  parameters):.   
+000137e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000137f0: 2043 6865 636b 2074 6865 2074 7261 696e   Check the train
+00013800: 696e 6720 7061 7261 6d65 7465 7273 2069  ing parameters i
+00013810: 6e74 6567 7269 7479 0a20 2020 2020 2020  ntegrity.       
+00013820: 2022 2222 0a20 2020 2020 2020 206c 6f67   """.        log
+00013830: 6765 722e 6465 6275 6728 2243 6865 636b  ger.debug("Check
+00013840: 696e 6720 6172 6775 6d65 6e74 732e 2e2e  ing arguments...
+00013850: 2229 0a20 2020 2020 2020 206d 616e 6461  ").        manda
+00013860: 746f 7279 5f61 7267 756d 656e 7473 203d  tory_arguments =
+00013870: 205b 0a20 2020 2020 2020 2020 2020 2022   [.            "
+00013880: 6361 7073 5f64 6972 6563 746f 7279 222c  caps_directory",
+00013890: 0a20 2020 2020 2020 2020 2020 2022 7473  .            "ts
+000138a0: 765f 7061 7468 222c 0a20 2020 2020 2020  v_path",.       
+000138b0: 2020 2020 2022 7072 6570 726f 6365 7373       "preprocess
+000138c0: 696e 675f 6469 6374 222c 0a20 2020 2020  ing_dict",.     
+000138d0: 2020 2020 2020 2022 6d6f 6465 222c 0a20         "mode",. 
+000138e0: 2020 2020 2020 2020 2020 2022 6e65 7477             "netw
+000138f0: 6f72 6b5f 7461 736b 222c 0a20 2020 2020  ork_task",.     
+00013900: 2020 205d 0a20 2020 2020 2020 2066 6f72     ].        for
+00013910: 2061 7267 2069 6e20 6d61 6e64 6174 6f72   arg in mandator
+00013920: 795f 6172 6775 6d65 6e74 733a 0a20 2020  y_arguments:.   
+00013930: 2020 2020 2020 2020 2069 6620 6172 6720           if arg 
+00013940: 6e6f 7420 696e 2070 6172 616d 6574 6572  not in parameter
+00013950: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00013960: 2020 2072 6169 7365 2043 6c69 6e69 6361     raise Clinica
+00013970: 444c 4172 6775 6d65 6e74 4572 726f 7228  DLArgumentError(
+00013980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013990: 2020 2020 2066 2254 6865 2076 616c 7565       f"The value
+000139a0: 7320 6f66 206d 616e 6461 746f 7279 2061  s of mandatory a
+000139b0: 7267 756d 656e 7473 207b 6d61 6e64 6174  rguments {mandat
+000139c0: 6f72 795f 6172 6775 6d65 6e74 737d 2073  ory_arguments} s
+000139d0: 686f 756c 6420 6265 2073 6574 2e20 220a  hould be set. ".
+000139e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139f0: 2020 2020 6622 4e6f 2076 616c 7565 2077      f"No value w
+00013a00: 6173 2067 6976 656e 2066 6f72 207b 6172  as given for {ar
+00013a10: 677d 2e22 0a20 2020 2020 2020 2020 2020  g}.".           
+00013a20: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00013a30: 656c 662e 7061 7261 6d65 7465 7273 203d  elf.parameters =
+00013a40: 2061 6464 5f64 6566 6175 6c74 5f76 616c   add_default_val
+00013a50: 7565 7328 7061 7261 6d65 7465 7273 290a  ues(parameters).
+00013a60: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00013a70: 7061 7261 6d65 7465 7273 5b22 6770 7522  parameters["gpu"
+00013a80: 5d3a 0a20 2020 2020 2020 2020 2020 2063  ]:.            c
+00013a90: 6865 636b 5f67 7075 2829 0a20 2020 2020  heck_gpu().     
+00013aa0: 2020 2065 6c69 6620 7365 6c66 2e70 6172     elif self.par
+00013ab0: 616d 6574 6572 735b 2261 6d70 225d 3a0a  ameters["amp"]:.
+00013ac0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013ad0: 6520 436c 696e 6963 6144 4c41 7267 756d  e ClinicaDLArgum
+00013ae0: 656e 7445 7272 6f72 280a 2020 2020 2020  entError(.      
+00013af0: 2020 2020 2020 2020 2020 2241 4d50 2069            "AMP i
+00013b00: 7320 6465 7369 676e 6564 2074 6f20 776f  s designed to wo
+00013b10: 726b 2077 6974 6820 6d6f 6465 726e 2047  rk with modern G
+00013b20: 5055 732e 2050 6c65 6173 6520 6164 6420  PUs. Please add 
+00013b30: 7468 6520 2d2d 6770 7520 666c 6167 2e22  the --gpu flag."
+00013b40: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00013b50: 2020 2020 2020 2020 5f2c 2074 7261 6e73          _, trans
+00013b60: 666f 726d 6174 696f 6e73 203d 2067 6574  formations = get
+00013b70: 5f74 7261 6e73 666f 726d 7328 0a20 2020  _transforms(.   
+00013b80: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
+00013b90: 7a65 3d73 656c 662e 6e6f 726d 616c 697a  ze=self.normaliz
+00013ba0: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+00013bb0: 697a 655f 7265 6475 6374 696f 6e3d 7365  ize_reduction=se
+00013bc0: 6c66 2e73 697a 655f 7265 6475 6374 696f  lf.size_reductio
+00013bd0: 6e2c 0a20 2020 2020 2020 2020 2020 2073  n,.            s
+00013be0: 697a 655f 7265 6475 6374 696f 6e5f 6661  ize_reduction_fa
+00013bf0: 6374 6f72 3d73 656c 662e 7369 7a65 5f72  ctor=self.size_r
+00013c00: 6564 7563 7469 6f6e 5f66 6163 746f 722c  eduction_factor,
+00013c10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00013c20: 2020 2020 7370 6c69 745f 6d61 6e61 6765      split_manage
+00013c30: 7220 3d20 7365 6c66 2e5f 696e 6974 5f73  r = self._init_s
+00013c40: 706c 6974 5f6d 616e 6167 6572 284e 6f6e  plit_manager(Non
+00013c50: 6529 0a20 2020 2020 2020 2074 7261 696e  e).        train
+00013c60: 5f64 6620 3d20 7370 6c69 745f 6d61 6e61  _df = split_mana
+00013c70: 6765 725b 305d 5b22 7472 6169 6e22 5d0a  ger[0]["train"].
+00013c80: 2020 2020 2020 2020 6966 2022 6c61 6265          if "labe
+00013c90: 6c22 206e 6f74 2069 6e20 7365 6c66 2e70  l" not in self.p
+00013ca0: 6172 616d 6574 6572 733a 0a20 2020 2020  arameters:.     
+00013cb0: 2020 2020 2020 2073 656c 662e 7061 7261         self.para
+00013cc0: 6d65 7465 7273 5b22 6c61 6265 6c22 5d20  meters["label"] 
+00013cd0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+00013ce0: 7365 6c66 2e74 6173 6b5f 6d61 6e61 6765  self.task_manage
+00013cf0: 7220 3d20 7365 6c66 2e5f 696e 6974 5f74  r = self._init_t
+00013d00: 6173 6b5f 6d61 6e61 6765 7228 6466 3d74  ask_manager(df=t
+00013d10: 7261 696e 5f64 6629 0a0a 2020 2020 2020  rain_df)..      
+00013d20: 2020 6966 2073 656c 662e 7061 7261 6d65    if self.parame
+00013d30: 7465 7273 5b22 6172 6368 6974 6563 7475  ters["architectu
+00013d40: 7265 225d 203d 3d20 2264 6566 6175 6c74  re"] == "default
+00013d50: 223a 0a20 2020 2020 2020 2020 2020 2073  ":.            s
+00013d60: 656c 662e 7061 7261 6d65 7465 7273 5b22  elf.parameters["
+00013d70: 6172 6368 6974 6563 7475 7265 225d 203d  architecture"] =
+00013d80: 2073 656c 662e 7461 736b 5f6d 616e 6167   self.task_manag
+00013d90: 6572 2e67 6574 5f64 6566 6175 6c74 5f6e  er.get_default_n
+00013da0: 6574 776f 726b 2829 0a20 2020 2020 2020  etwork().       
+00013db0: 2069 6620 2273 656c 6563 7469 6f6e 5f74   if "selection_t
+00013dc0: 6872 6573 686f 6c64 2220 6e6f 7420 696e  hreshold" not in
+00013dd0: 2073 656c 662e 7061 7261 6d65 7465 7273   self.parameters
+00013de0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00013df0: 6c66 2e70 6172 616d 6574 6572 735b 2273  lf.parameters["s
+00013e00: 656c 6563 7469 6f6e 5f74 6872 6573 686f  election_thresho
+00013e10: 6c64 225d 203d 204e 6f6e 650a 2020 2020  ld"] = None.    
+00013e20: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+00013e30: 2020 2020 2022 6c61 6265 6c5f 636f 6465       "label_code
+00013e40: 2220 6e6f 7420 696e 2073 656c 662e 7061  " not in self.pa
+00013e50: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00013e60: 2020 2020 206f 7220 6c65 6e28 7365 6c66       or len(self
+00013e70: 2e70 6172 616d 6574 6572 735b 226c 6162  .parameters["lab
+00013e80: 656c 5f63 6f64 6522 5d29 203d 3d20 300a  el_code"]) == 0.
+00013e90: 2020 2020 2020 2020 293a 2020 2320 416c          ):  # Al
+00013ea0: 6c6f 7773 2074 6f20 7365 7420 6375 7374  lows to set cust
+00013eb0: 6f6d 206c 6162 656c 2063 6f64 6520 696e  om label code in
+00013ec0: 2054 4f4d 4c0a 2020 2020 2020 2020 2020   TOML.          
+00013ed0: 2020 7365 6c66 2e70 6172 616d 6574 6572    self.parameter
+00013ee0: 735b 226c 6162 656c 5f63 6f64 6522 5d20  s["label_code"] 
+00013ef0: 3d20 7365 6c66 2e74 6173 6b5f 6d61 6e61  = self.task_mana
+00013f00: 6765 722e 6765 6e65 7261 7465 5f6c 6162  ger.generate_lab
+00013f10: 656c 5f63 6f64 6528 0a20 2020 2020 2020  el_code(.       
+00013f20: 2020 2020 2020 2020 2074 7261 696e 5f64           train_d
+00013f30: 662c 2073 656c 662e 6c61 6265 6c0a 2020  f, self.label.  
+00013f40: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00013f50: 2020 2020 2066 756c 6c5f 6461 7461 7365       full_datase
+00013f60: 7420 3d20 7265 7475 726e 5f64 6174 6173  t = return_datas
+00013f70: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00013f80: 7365 6c66 2e63 6170 735f 6469 7265 6374  self.caps_direct
+00013f90: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
+00013fa0: 2074 7261 696e 5f64 662c 0a20 2020 2020   train_df,.     
+00013fb0: 2020 2020 2020 2073 656c 662e 7072 6570         self.prep
+00013fc0: 726f 6365 7373 696e 675f 6469 6374 2c0a  rocessing_dict,.
+00013fd0: 2020 2020 2020 2020 2020 2020 6d75 6c74              mult
+00013fe0: 695f 636f 686f 7274 3d73 656c 662e 6d75  i_cohort=self.mu
+00013ff0: 6c74 695f 636f 686f 7274 2c0a 2020 2020  lti_cohort,.    
+00014000: 2020 2020 2020 2020 6c61 6265 6c3d 7365          label=se
+00014010: 6c66 2e6c 6162 656c 2c0a 2020 2020 2020  lf.label,.      
+00014020: 2020 2020 2020 6c61 6265 6c5f 636f 6465        label_code
+00014030: 3d73 656c 662e 7061 7261 6d65 7465 7273  =self.parameters
+00014040: 5b22 6c61 6265 6c5f 636f 6465 225d 2c0a  ["label_code"],.
+00014050: 2020 2020 2020 2020 2020 2020 7472 6169              trai
+00014060: 6e5f 7472 616e 7366 6f72 6d61 7469 6f6e  n_transformation
+00014070: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00014080: 2020 2020 616c 6c5f 7472 616e 7366 6f72      all_transfor
+00014090: 6d61 7469 6f6e 733d 7472 616e 7366 6f72  mations=transfor
+000140a0: 6d61 7469 6f6e 732c 0a20 2020 2020 2020  mations,.       
+000140b0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+000140c0: 7061 7261 6d65 7465 7273 2e75 7064 6174  parameters.updat
+000140d0: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
+000140e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000140f0: 2022 6e75 6d5f 6e65 7477 6f72 6b73 223a   "num_networks":
+00014100: 2066 756c 6c5f 6461 7461 7365 742e 656c   full_dataset.el
+00014110: 656d 5f70 6572 5f69 6d61 6765 2c0a 2020  em_per_image,.  
+00014120: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+00014130: 7574 7075 745f 7369 7a65 223a 2073 656c  utput_size": sel
+00014140: 662e 7461 736b 5f6d 616e 6167 6572 2e6f  f.task_manager.o
+00014150: 7574 7075 745f 7369 7a65 280a 2020 2020  utput_size(.    
+00014160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014170: 6675 6c6c 5f64 6174 6173 6574 2e73 697a  full_dataset.siz
+00014180: 652c 2066 756c 6c5f 6461 7461 7365 742e  e, full_dataset.
+00014190: 6466 2c20 7365 6c66 2e6c 6162 656c 0a20  df, self.label. 
+000141a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000141b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000141c0: 2020 2269 6e70 7574 5f73 697a 6522 3a20    "input_size": 
+000141d0: 6675 6c6c 5f64 6174 6173 6574 2e73 697a  full_dataset.siz
+000141e0: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+000141f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00014200: 2020 2020 7365 6c66 2e70 6172 616d 6574      self.paramet
+00014210: 6572 735b 2273 6565 6422 5d20 3d20 6765  ers["seed"] = ge
+00014220: 745f 7365 6564 2873 656c 662e 7061 7261  t_seed(self.para
+00014230: 6d65 7465 7273 5b22 7365 6564 225d 290a  meters["seed"]).
+00014240: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00014250: 2e70 6172 616d 6574 6572 735b 226e 756d  .parameters["num
+00014260: 5f6e 6574 776f 726b 7322 5d20 3c20 3220  _networks"] < 2 
+00014270: 616e 6420 7365 6c66 2e6d 756c 7469 5f6e  and self.multi_n
+00014280: 6574 776f 726b 3a0a 2020 2020 2020 2020  etwork:.        
+00014290: 2020 2020 7261 6973 6520 436c 696e 6963      raise Clinic
+000142a0: 6144 4c43 6f6e 6669 6775 7261 7469 6f6e  aDLConfiguration
+000142b0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000142c0: 2020 2020 2020 2066 2249 6e76 616c 6964         f"Invalid
+000142d0: 2074 7261 696e 696e 6720 636f 6e66 6967   training config
+000142e0: 7572 6174 696f 6e3a 2063 616e 6e6f 7420  uration: cannot 
+000142f0: 7472 6169 6e20 6120 6d75 6c74 692d 6e65  train a multi-ne
+00014300: 7477 6f72 6b20 220a 2020 2020 2020 2020  twork ".        
+00014310: 2020 2020 2020 2020 6622 6672 616d 6577          f"framew
+00014320: 6f72 6b20 7769 7468 206f 6e6c 7920 7b73  ork with only {s
+00014330: 656c 662e 7061 7261 6d65 7465 7273 5b27  elf.parameters['
+00014340: 6e75 6d5f 6e65 7477 6f72 6b73 275d 7d20  num_networks']} 
+00014350: 656c 656d 656e 7420 220a 2020 2020 2020  element ".      
+00014360: 2020 2020 2020 2020 2020 6622 7065 7220            f"per 
+00014370: 696d 6167 652e 220a 2020 2020 2020 2020  image.".        
+00014380: 2020 2020 290a 2020 2020 2020 2020 706f      ).        po
+00014390: 7373 6962 6c65 5f73 656c 6563 7469 6f6e  ssible_selection
+000143a0: 5f6d 6574 7269 6373 5f73 6574 203d 2073  _metrics_set = s
+000143b0: 6574 2873 656c 662e 7461 736b 5f6d 616e  et(self.task_man
+000143c0: 6167 6572 2e65 7661 6c75 6174 696f 6e5f  ager.evaluation_
+000143d0: 6d65 7472 6963 7329 207c 207b 0a20 2020  metrics) | {.   
+000143e0: 2020 2020 2020 2020 2022 6c6f 7373 220a           "loss".
+000143f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00014400: 2020 6966 206e 6f74 2073 6574 2873 656c    if not set(sel
+00014410: 662e 7061 7261 6d65 7465 7273 5b22 7365  f.parameters["se
+00014420: 6c65 6374 696f 6e5f 6d65 7472 6963 7322  lection_metrics"
+00014430: 5d29 2e69 7373 7562 7365 7428 0a20 2020  ]).issubset(.   
+00014440: 2020 2020 2020 2020 2070 6f73 7369 626c           possibl
+00014450: 655f 7365 6c65 6374 696f 6e5f 6d65 7472  e_selection_metr
+00014460: 6963 735f 7365 740a 2020 2020 2020 2020  ics_set.        
+00014470: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00014480: 6169 7365 2043 6c69 6e69 6361 444c 436f  aise ClinicaDLCo
+00014490: 6e66 6967 7572 6174 696f 6e45 7272 6f72  nfigurationError
+000144a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000144b0: 2020 6622 5365 6c65 6374 696f 6e20 6d65    f"Selection me
+000144c0: 7472 6963 7320 7b73 656c 662e 7061 7261  trics {self.para
+000144d0: 6d65 7465 7273 5b27 7365 6c65 6374 696f  meters['selectio
+000144e0: 6e5f 6d65 7472 6963 7327 5d7d 2022 0a20  n_metrics']} ". 
+000144f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00014500: 226d 7573 7420 6265 2061 2073 7562 7365  "must be a subse
+00014510: 7420 6f66 206d 6574 7269 6373 2075 7365  t of metrics use
+00014520: 6420 666f 7220 6576 616c 7561 7469 6f6e  d for evaluation
+00014530: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00014540: 2020 2066 227b 706f 7373 6962 6c65 5f73     f"{possible_s
+00014550: 656c 6563 7469 6f6e 5f6d 6574 7269 6373  election_metrics
+00014560: 5f73 6574 7d2e 220a 2020 2020 2020 2020  _set}.".        
+00014570: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+00014580: 6368 6563 6b5f 7370 6c69 745f 776f 7264  check_split_word
+00014590: 696e 6728 7365 6c66 293a 0a20 2020 2020  ing(self):.     
+000145a0: 2020 2022 2222 4669 6e64 7320 6966 204d     """Finds if M
+000145b0: 4150 5320 7374 7275 6374 7572 6520 7573  APS structure us
+000145c0: 6573 2027 666f 6c64 2d58 2720 6f72 2027  es 'fold-X' or '
+000145d0: 7370 6c69 742d 5827 2066 6f6c 6465 7273  split-X' folders
+000145e0: 2e22 2222 0a0a 2020 2020 2020 2020 6966  ."""..        if
+000145f0: 206c 656e 286c 6973 7428 7365 6c66 2e6d   len(list(self.m
+00014600: 6170 735f 7061 7468 2e67 6c6f 6228 2266  aps_path.glob("f
+00014610: 6f6c 642d 2a22 2929 2920 3e20 303a 0a20  old-*"))) > 0:. 
+00014620: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00014630: 6e20 2266 6f6c 6422 0a20 2020 2020 2020  n "fold".       
+00014640: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014650: 2020 2072 6574 7572 6e20 2273 706c 6974     return "split
+00014660: 220a 0a20 2020 2064 6566 205f 6669 6e64  "..    def _find
+00014670: 5f73 706c 6974 7328 7365 6c66 293a 0a20  _splits(self):. 
+00014680: 2020 2020 2020 2022 2222 4669 6e64 2077         """Find w
+00014690: 6869 6368 2073 706c 6974 7320 7765 7265  hich splits were
+000146a0: 2074 7261 696e 6564 2069 6e20 7468 6520   trained in the 
+000146b0: 4d41 5053 2e22 2222 0a20 2020 2020 2020  MAPS.""".       
+000146c0: 2072 6574 7572 6e20 5b0a 2020 2020 2020   return [.      
+000146d0: 2020 2020 2020 696e 7428 7370 6c69 742e        int(split.
+000146e0: 6e61 6d65 2e73 706c 6974 2822 2d22 295b  name.split("-")[
+000146f0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+00014700: 666f 7220 7370 6c69 7420 696e 206c 6973  for split in lis
+00014710: 7428 7365 6c66 2e6d 6170 735f 7061 7468  t(self.maps_path
+00014720: 2e69 7465 7264 6972 2829 290a 2020 2020  .iterdir()).    
+00014730: 2020 2020 2020 2020 6966 2073 706c 6974          if split
+00014740: 2e6e 616d 652e 7374 6172 7473 7769 7468  .name.startswith
+00014750: 2866 227b 7365 6c66 2e73 706c 6974 5f6e  (f"{self.split_n
+00014760: 616d 657d 2d22 290a 2020 2020 2020 2020  ame}-").        
+00014770: 5d0a 0a20 2020 2064 6566 205f 6669 6e64  ]..    def _find
+00014780: 5f73 656c 6563 7469 6f6e 5f6d 6574 7269  _selection_metri
+00014790: 6373 2873 656c 662c 2073 706c 6974 293a  cs(self, split):
+000147a0: 0a20 2020 2020 2020 2022 2222 4669 6e64  .        """Find
+000147b0: 2077 6869 6368 2073 656c 6563 7469 6f6e   which selection
+000147c0: 206d 6574 7269 6373 2061 7265 2061 7661   metrics are ava
+000147d0: 696c 6162 6c65 2069 6e20 4d41 5053 2066  ilable in MAPS f
+000147e0: 6f72 2061 2067 6976 656e 2073 706c 6974  or a given split
+000147f0: 2e22 2222 0a0a 2020 2020 2020 2020 7370  ."""..        sp
+00014800: 6c69 745f 7061 7468 203d 2073 656c 662e  lit_path = self.
+00014810: 6d61 7073 5f70 6174 6820 2f20 6622 7b73  maps_path / f"{s
+00014820: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
+00014830: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
+00014840: 2069 6620 6e6f 7420 7370 6c69 745f 7061   if not split_pa
+00014850: 7468 2e69 735f 6469 7228 293a 0a20 2020  th.is_dir():.   
+00014860: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
+00014870: 4150 5345 7272 6f72 280a 2020 2020 2020  APSError(.      
+00014880: 2020 2020 2020 2020 2020 6622 5472 6169            f"Trai
+00014890: 6e69 6e67 206f 6620 7370 6c69 7420 7b73  ning of split {s
+000148a0: 706c 6974 7d20 7761 7320 6e6f 7420 7065  plit} was not pe
+000148b0: 7266 6f72 6d65 642e 220a 2020 2020 2020  rformed.".      
+000148c0: 2020 2020 2020 2020 2020 6622 506c 6561            f"Plea
+000148d0: 7365 2065 7865 6375 7465 206d 6170 735f  se execute maps_
+000148e0: 6d61 6e61 6765 722e 7472 6169 6e28 7370  manager.train(sp
+000148f0: 6c69 745f 6c69 7374 3d5b 7b73 706c 6974  lit_list=[{split
+00014900: 7d5d 2922 0a20 2020 2020 2020 2020 2020  }])".           
+00014910: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
+00014920: 726e 205b 0a20 2020 2020 2020 2020 2020  rn [.           
+00014930: 206d 6574 7269 632e 6e61 6d65 2e73 706c   metric.name.spl
+00014940: 6974 2822 2d22 295b 315d 0a20 2020 2020  it("-")[1].     
+00014950: 2020 2020 2020 2066 6f72 206d 6574 7269         for metri
+00014960: 6320 696e 206c 6973 7428 7370 6c69 745f  c in list(split_
+00014970: 7061 7468 2e69 7465 7264 6972 2829 290a  path.iterdir()).
+00014980: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00014990: 6574 7269 632e 6e61 6d65 5b3a 353a 5d20  etric.name[:5:] 
+000149a0: 3d3d 2022 6265 7374 2d22 0a20 2020 2020  == "best-".     
+000149b0: 2020 205d 0a0a 2020 2020 6465 6620 5f63     ]..    def _c
+000149c0: 6865 636b 5f73 656c 6563 7469 6f6e 5f6d  heck_selection_m
+000149d0: 6574 7269 6328 7365 6c66 2c20 7370 6c69  etric(self, spli
+000149e0: 742c 2073 656c 6563 7469 6f6e 5f6d 6574  t, selection_met
+000149f0: 7269 633d 4e6f 6e65 293a 0a20 2020 2020  ric=None):.     
+00014a00: 2020 2022 2222 4368 6563 6b20 7468 6174     """Check that
+00014a10: 2061 2067 6976 656e 2073 656c 6563 7469   a given selecti
+00014a20: 6f6e 206d 6574 7269 6320 6973 2061 7661  on metric is ava
+00014a30: 696c 6162 6c65 2066 6f72 2061 2067 6976  ilable for a giv
+00014a40: 656e 2073 706c 6974 2e22 2222 0a20 2020  en split.""".   
+00014a50: 2020 2020 2061 7661 696c 6162 6c65 5f6d       available_m
+00014a60: 6574 7269 6373 203d 2073 656c 662e 5f66  etrics = self._f
+00014a70: 696e 645f 7365 6c65 6374 696f 6e5f 6d65  ind_selection_me
+00014a80: 7472 6963 7328 7370 6c69 7429 0a20 2020  trics(split).   
+00014a90: 2020 2020 2069 6620 6e6f 7420 7365 6c65       if not sele
+00014aa0: 6374 696f 6e5f 6d65 7472 6963 3a0a 2020  ction_metric:.  
+00014ab0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00014ac0: 2861 7661 696c 6162 6c65 5f6d 6574 7269  (available_metri
+00014ad0: 6373 2920 3e20 313a 0a20 2020 2020 2020  cs) > 1:.       
+00014ae0: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
+00014af0: 6c69 6e69 6361 444c 4172 6775 6d65 6e74  linicaDLArgument
+00014b00: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00014b10: 2020 2020 2020 2020 2020 2066 2253 6576             f"Sev
+00014b20: 6572 616c 206d 6574 7269 6373 2061 7265  eral metrics are
+00014b30: 2061 7661 696c 6162 6c65 2066 6f72 2073   available for s
+00014b40: 706c 6974 207b 7370 6c69 747d 2e20 220a  plit {split}. ".
+00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b60: 2020 2020 6622 506c 6561 7365 2063 686f      f"Please cho
+00014b70: 6f73 6520 7768 6963 6820 6f6e 6520 796f  ose which one yo
+00014b80: 7520 7761 6e74 2074 6f20 7265 6164 2061  u want to read a
+00014b90: 6d6f 6e67 207b 6176 6169 6c61 626c 655f  mong {available_
+00014ba0: 6d65 7472 6963 737d 220a 2020 2020 2020  metrics}".      
+00014bb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00014bc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00014bd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00014be0: 6c65 6374 696f 6e5f 6d65 7472 6963 203d  lection_metric =
+00014bf0: 2061 7661 696c 6162 6c65 5f6d 6574 7269   available_metri
+00014c00: 6373 5b30 5d0a 2020 2020 2020 2020 656c  cs[0].        el
+00014c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014c20: 6966 2073 656c 6563 7469 6f6e 5f6d 6574  if selection_met
+00014c30: 7269 6320 6e6f 7420 696e 2061 7661 696c  ric not in avail
+00014c40: 6162 6c65 5f6d 6574 7269 6373 3a0a 2020  able_metrics:.  
+00014c50: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00014c60: 6973 6520 436c 696e 6963 6144 4c41 7267  ise ClinicaDLArg
+00014c70: 756d 656e 7445 7272 6f72 280a 2020 2020  umentError(.    
+00014c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c90: 6622 5468 6520 6d65 7472 6963 207b 7365  f"The metric {se
+00014ca0: 6c65 6374 696f 6e5f 6d65 7472 6963 7d20  lection_metric} 
+00014cb0: 6973 206e 6f74 2061 7661 696c 6162 6c65  is not available
+00014cc0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00014cd0: 2020 2020 2020 2066 2250 6c65 6173 6520         f"Please 
+00014ce0: 6368 6f6f 7365 2061 6d6f 6e67 2069 7320  choose among is 
+00014cf0: 7468 6520 6176 6169 6c61 626c 6520 6d65  the available me
+00014d00: 7472 6963 7320 7b61 7661 696c 6162 6c65  trics {available
+00014d10: 5f6d 6574 7269 6373 7d2e 220a 2020 2020  _metrics}.".    
+00014d20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00014d30: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00014d40: 6563 7469 6f6e 5f6d 6574 7269 630a 0a20  ection_metric.. 
+00014d50: 2020 2064 6566 205f 6368 6563 6b5f 6c65     def _check_le
+00014d60: 616b 6167 6528 7365 6c66 2c20 6461 7461  akage(self, data
+00014d70: 5f67 726f 7570 2c20 7465 7374 5f64 6629  _group, test_df)
+00014d80: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00014d90: 2020 2020 2020 4368 6563 6b73 2074 6861        Checks tha
+00014da0: 7420 6e6f 2069 6e74 6572 7365 6374 696f  t no intersectio
+00014db0: 6e20 6578 6973 7420 6265 7477 6565 6e20  n exist between 
+00014dc0: 7468 6520 7061 7274 6963 6970 616e 7473  the participants
+00014dd0: 2075 7365 6420 666f 7220 7472 6169 6e69   used for traini
+00014de0: 6e67 2061 6e64 2074 686f 7365 2075 7365  ng and those use
+00014df0: 6420 666f 7220 7465 7374 696e 672e 0a0a  d for testing...
+00014e00: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00014e10: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
+00014e20: 726f 7570 2028 7374 7229 3a20 6e61 6d65  roup (str): name
+00014e30: 206f 6620 7468 6520 6461 7461 2067 726f   of the data gro
+00014e40: 7570 0a20 2020 2020 2020 2020 2020 2074  up.            t
+00014e50: 6573 745f 6466 2028 7064 2e44 6174 6146  est_df (pd.DataF
+00014e60: 7261 6d65 293a 2054 6162 6c65 206f 6620  rame): Table of 
+00014e70: 7061 7274 6963 6970 616e 745f 6964 202f  participant_id /
+00014e80: 2073 6573 7369 6f6e 5f69 6420 6f66 2074   session_id of t
+00014e90: 6865 2064 6174 6120 6772 6f75 700a 2020  he data group.  
+00014ea0: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
+00014eb0: 2020 2020 2020 2020 2020 436c 696e 6963            Clinic
+00014ec0: 6144 4c44 6174 614c 6561 6b61 6765 4572  aDLDataLeakageEr
+00014ed0: 726f 723a 2069 6620 6461 7461 5f67 726f  ror: if data_gro
+00014ee0: 7570 206e 6f74 2069 6e20 5b22 7472 6169  up not in ["trai
+00014ef0: 6e22 2c20 2276 616c 6964 6174 696f 6e22  n", "validation"
+00014f00: 5d20 616e 6420 7468 6572 6520 6973 2061  ] and there is a
+00014f10: 6e20 696e 7465 7273 6563 7469 6f6e 0a20  n intersection. 
+00014f20: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00014f30: 6574 7765 656e 2074 6865 2070 6172 7469  etween the parti
+00014f40: 6369 7061 6e74 2049 4473 2069 6e20 7465  cipant IDs in te
+00014f50: 7374 5f64 6620 616e 6420 7468 6520 6f6e  st_df and the on
+00014f60: 6573 2075 7365 6420 666f 7220 7472 6169  es used for trai
+00014f70: 6e69 6e67 2e0a 2020 2020 2020 2020 2222  ning..        ""
+00014f80: 220a 2020 2020 2020 2020 6966 2064 6174  ".        if dat
+00014f90: 615f 6772 6f75 7020 6e6f 7420 696e 205b  a_group not in [
+00014fa0: 2274 7261 696e 222c 2022 7661 6c69 6461  "train", "valida
+00014fb0: 7469 6f6e 225d 3a0a 2020 2020 2020 2020  tion"]:.        
+00014fc0: 2020 2020 7472 6169 6e5f 7061 7468 203d      train_path =
+00014fd0: 2073 656c 662e 6d61 7073 5f70 6174 6820   self.maps_path 
+00014fe0: 2f20 2267 726f 7570 7322 202f 2022 7472  / "groups" / "tr
+00014ff0: 6169 6e2b 7661 6c69 6461 7469 6f6e 2e74  ain+validation.t
+00015000: 7376 220a 2020 2020 2020 2020 2020 2020  sv".            
+00015010: 7472 6169 6e5f 6466 203d 2070 642e 7265  train_df = pd.re
+00015020: 6164 5f63 7376 2874 7261 696e 5f70 6174  ad_csv(train_pat
+00015030: 682c 2073 6570 3d22 5c74 2229 0a20 2020  h, sep="\t").   
+00015040: 2020 2020 2020 2020 2070 6172 7469 6369           partici
+00015050: 7061 6e74 735f 7472 6169 6e20 3d20 7365  pants_train = se
+00015060: 7428 7472 6169 6e5f 6466 2e70 6172 7469  t(train_df.parti
+00015070: 6369 7061 6e74 5f69 642e 7661 6c75 6573  cipant_id.values
+00015080: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
+00015090: 7274 6963 6970 616e 7473 5f74 6573 7420  rticipants_test 
+000150a0: 3d20 7365 7428 7465 7374 5f64 662e 7061  = set(test_df.pa
+000150b0: 7274 6963 6970 616e 745f 6964 2e76 616c  rticipant_id.val
+000150c0: 7565 7329 0a20 2020 2020 2020 2020 2020  ues).           
+000150d0: 2069 6e74 6572 7365 6374 696f 6e20 3d20   intersection = 
+000150e0: 7061 7274 6963 6970 616e 7473 5f74 6573  participants_tes
+000150f0: 7420 2620 7061 7274 6963 6970 616e 7473  t & participants
+00015100: 5f74 7261 696e 0a0a 2020 2020 2020 2020  _train..        
+00015110: 2020 2020 6966 206c 656e 2869 6e74 6572      if len(inter
+00015120: 7365 6374 696f 6e29 203e 2030 3a0a 2020  section) > 0:.  
+00015130: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00015140: 6973 6520 436c 696e 6963 6144 4c44 6174  ise ClinicaDLDat
+00015150: 614c 6561 6b61 6765 4572 726f 7228 0a20  aLeakageError(. 
+00015160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015170: 2020 2022 596f 7572 2065 7661 6c75 6174     "Your evaluat
+00015180: 696f 6e20 7365 7420 636f 6e74 6169 6e73  ion set contains
+00015190: 2070 6172 7469 6369 7061 6e74 7320 7768   participants wh
+000151a0: 6f20 7765 7265 2061 6c72 6561 6479 2073  o were already s
+000151b0: 6565 6e20 6475 7269 6e67 2022 0a20 2020  een during ".   
+000151c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151d0: 2022 7468 6520 7472 6169 6e69 6e67 2073   "the training s
+000151e0: 7465 702e 2054 6865 206c 6973 7420 6f66  tep. The list of
+000151f0: 2063 6f6d 6d6f 6e20 7061 7274 6963 6970   common particip
+00015200: 616e 7473 2069 7320 7468 6520 666f 6c6c  ants is the foll
+00015210: 6f77 696e 673a 2022 0a20 2020 2020 2020  owing: ".       
+00015220: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00015230: 696e 7465 7273 6563 7469 6f6e 7d2e 220a  intersection}.".
+00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015250: 290a 0a20 2020 2064 6566 205f 6368 6563  )..    def _chec
+00015260: 6b5f 6461 7461 5f67 726f 7570 280a 2020  k_data_group(.  
+00015270: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00015280: 2020 2020 6461 7461 5f67 726f 7570 2c0a      data_group,.
+00015290: 2020 2020 2020 2020 6361 7073 5f64 6972          caps_dir
+000152a0: 6563 746f 7279 3d4e 6f6e 652c 0a20 2020  ectory=None,.   
+000152b0: 2020 2020 2064 663d 4e6f 6e65 2c0a 2020       df=None,.  
+000152c0: 2020 2020 2020 6d75 6c74 695f 636f 686f        multi_coho
+000152d0: 7274 3d46 616c 7365 2c0a 2020 2020 2020  rt=False,.      
+000152e0: 2020 6f76 6572 7772 6974 653d 4661 6c73    overwrite=Fals
+000152f0: 652c 0a20 2020 2020 2020 206c 6162 656c  e,.        label
+00015300: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
+00015310: 706c 6974 5f6c 6973 743d 4e6f 6e65 2c0a  plit_list=None,.
+00015320: 2020 2020 2020 2020 736b 6970 5f6c 6561          skip_lea
+00015330: 6b5f 6368 6563 6b3d 4661 6c73 652c 0a20  k_check=False,. 
+00015340: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+00015350: 220a 2020 2020 2020 2020 4368 6563 6b20  ".        Check 
+00015360: 6966 2061 2064 6174 6120 6772 6f75 7020  if a data group 
+00015370: 6973 2061 6c72 6561 6479 2061 7661 696c  is already avail
+00015380: 6162 6c65 2069 6620 6f74 6865 7220 6172  able if other ar
+00015390: 6775 6d65 6e74 7320 6172 6520 4e6f 6e65  guments are None
+000153a0: 2e0a 2020 2020 2020 2020 456c 7365 2063  ..        Else c
+000153b0: 7265 6174 6573 2061 206e 6577 2064 6174  reates a new dat
+000153c0: 615f 6772 6f75 702e 0a0a 2020 2020 2020  a_group...      
+000153d0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000153e0: 2020 2020 6461 7461 5f67 726f 7570 2028      data_group (
+000153f0: 7374 7229 3a20 6e61 6d65 206f 6620 7468  str): name of th
+00015400: 6520 6461 7461 2067 726f 7570 0a20 2020  e data group.   
+00015410: 2020 2020 2020 2020 2063 6170 735f 6469           caps_di
+00015420: 7265 6374 6f72 7920 2028 7374 7229 3a20  rectory  (str): 
+00015430: 696e 7075 7420 4341 5053 2064 6972 6563  input CAPS direc
+00015440: 746f 7279 0a20 2020 2020 2020 2020 2020  tory.           
+00015450: 2064 6620 2870 642e 4461 7461 4672 616d   df (pd.DataFram
+00015460: 6529 3a20 5461 626c 6520 6f66 2070 6172  e): Table of par
+00015470: 7469 6369 7061 6e74 5f69 6420 2f20 7365  ticipant_id / se
+00015480: 7373 696f 6e5f 6964 206f 6620 7468 6520  ssion_id of the 
+00015490: 6461 7461 2067 726f 7570 0a20 2020 2020  data group.     
+000154a0: 2020 2020 2020 206d 756c 7469 5f63 6f68         multi_coh
+000154b0: 6f72 7420 2862 6f6f 6c29 3a20 696e 6469  ort (bool): indi
+000154c0: 6361 7465 7320 6966 2074 6865 2069 6e70  cates if the inp
+000154d0: 7574 2064 6174 6120 636f 6d65 7320 6672  ut data comes fr
+000154e0: 6f6d 2073 6576 6572 616c 2043 4150 530a  om several CAPS.
+000154f0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+00015500: 7772 6974 6520 2862 6f6f 6c29 3a20 4966  write (bool): If
+00015510: 2054 7275 6520 666f 726d 6572 2064 6566   True former def
+00015520: 696e 6974 696f 6e20 6f66 2064 6174 6120  inition of data 
+00015530: 6772 6f75 7020 6973 2065 7261 7365 640a  group is erased.
+00015540: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
+00015550: 6c20 2873 7472 293a 206c 6162 656c 206e  l (str): label n
+00015560: 616d 6520 6966 2061 7070 6c69 6361 626c  ame if applicabl
+00015570: 650a 0a20 2020 2020 2020 2052 6169 7365  e..        Raise
+00015580: 733a 0a20 2020 2020 2020 2020 2020 204d  s:.            M
+00015590: 4150 5345 7272 6f72 2077 6865 6e20 7472  APSError when tr
+000155a0: 7969 6e67 2074 6f20 6f76 6572 7772 6974  ying to overwrit
+000155b0: 6520 7472 6169 6e20 6f72 2076 616c 6964  e train or valid
+000155c0: 6174 696f 6e20 6461 7461 2067 726f 7570  ation data group
+000155d0: 730a 2020 2020 2020 2020 2020 2020 436c  s.            Cl
+000155e0: 696e 6963 6144 4c41 7267 756d 656e 7445  inicaDLArgumentE
+000155f0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00015600: 2020 2020 2020 7768 656e 2063 6170 735f        when caps_
+00015610: 6469 7265 6374 6f72 7920 6f72 2064 6620  directory or df 
+00015620: 6172 6520 6769 7665 6e20 6275 7420 6461  are given but da
+00015630: 7461 2067 726f 7570 2061 6c72 6561 6479  ta group already
+00015640: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
+00015650: 2020 2020 2020 2020 7768 656e 2063 6170          when cap
+00015660: 735f 6469 7265 6374 6f72 7920 6f72 2064  s_directory or d
+00015670: 6620 6172 6520 6e6f 7420 6769 7665 6e20  f are not given 
+00015680: 616e 6420 6461 7461 2067 726f 7570 2064  and data group d
+00015690: 6f65 7320 6e6f 7420 6578 6973 740a 2020  oes not exist.  
+000156a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000156b0: 2020 6772 6f75 705f 6469 7220 3d20 7365    group_dir = se
+000156c0: 6c66 2e6d 6170 735f 7061 7468 202f 2022  lf.maps_path / "
+000156d0: 6772 6f75 7073 2220 2f20 6461 7461 5f67  groups" / data_g
+000156e0: 726f 7570 0a20 2020 2020 2020 206c 6f67  roup.        log
+000156f0: 6765 722e 6465 6275 6728 6622 4772 6f75  ger.debug(f"Grou
+00015700: 7020 7061 7468 207b 6772 6f75 705f 6469  p path {group_di
+00015710: 727d 2229 0a20 2020 2020 2020 2069 6620  r}").        if 
+00015720: 6772 6f75 705f 6469 722e 6973 5f64 6972  group_dir.is_dir
+00015730: 2829 3a20 2023 2044 6174 6120 6772 6f75  ():  # Data grou
+00015740: 7020 616c 7265 6164 7920 6578 6973 7473  p already exists
+00015750: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00015760: 6f76 6572 7772 6974 653a 0a20 2020 2020  overwrite:.     
+00015770: 2020 2020 2020 2020 2020 2069 6620 6461             if da
+00015780: 7461 5f67 726f 7570 2069 6e20 5b22 7472  ta_group in ["tr
+00015790: 6169 6e22 2c20 2276 616c 6964 6174 696f  ain", "validatio
+000157a0: 6e22 5d3a 0a20 2020 2020 2020 2020 2020  n"]:.           
+000157b0: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
+000157c0: 4150 5345 7272 6f72 2822 4361 6e6e 6f74  APSError("Cannot
+000157d0: 206f 7665 7277 7269 7465 2074 7261 696e   overwrite train
+000157e0: 206f 7220 7661 6c69 6461 7469 6f6e 2064   or validation d
+000157f0: 6174 6120 6772 6f75 702e 2229 0a20 2020  ata group.").   
+00015800: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00015810: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00015820: 2020 2020 2020 2069 6620 6e6f 7420 7370         if not sp
+00015830: 6c69 745f 6c69 7374 3a0a 2020 2020 2020  lit_list:.      
+00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015850: 2020 7370 6c69 745f 6c69 7374 203d 2073    split_list = s
+00015860: 656c 662e 5f66 696e 645f 7370 6c69 7473  elf._find_splits
+00015870: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00015880: 2020 2020 2020 2066 6f72 2073 706c 6974         for split
+00015890: 2069 6e20 7370 6c69 745f 6c69 7374 3a0a   in split_list:.
+000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158b0: 2020 2020 2020 2020 7365 6c65 6374 696f          selectio
+000158c0: 6e5f 6d65 7472 6963 7320 3d20 7365 6c66  n_metrics = self
+000158d0: 2e5f 6669 6e64 5f73 656c 6563 7469 6f6e  ._find_selection
+000158e0: 5f6d 6574 7269 6373 2873 706c 6974 290a  _metrics(split).
+000158f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015900: 2020 2020 2020 2020 666f 7220 7365 6c65          for sele
+00015910: 6374 696f 6e20 696e 2073 656c 6563 7469  ction in selecti
+00015920: 6f6e 5f6d 6574 7269 6373 3a0a 2020 2020  on_metrics:.    
+00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015940: 2020 2020 2020 2020 7265 7375 6c74 735f          results_
+00015950: 7061 7468 203d 2028 0a20 2020 2020 2020  path = (.       
+00015960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015970: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00015980: 7073 5f70 6174 680a 2020 2020 2020 2020  ps_path.        
+00015990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159a0: 2020 2020 2020 2020 2f20 6622 7b73 656c          / f"{sel
+000159b0: 662e 7370 6c69 745f 6e61 6d65 7d2d 7b73  f.split_name}-{s
+000159c0: 706c 6974 7d22 0a20 2020 2020 2020 2020  plit}".         
+000159d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159e0: 2020 2020 2020 202f 2066 2262 6573 742d         / f"best-
+000159f0: 7b73 656c 6563 7469 6f6e 7d22 0a20 2020  {selection}".   
+00015a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a10: 2020 2020 2020 2020 2020 2020 202f 2064               / d
+00015a20: 6174 615f 6772 6f75 700a 2020 2020 2020  ata_group.      
+00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a60: 2020 2020 6966 2072 6573 756c 7473 5f70      if results_p
+00015a70: 6174 682e 6973 5f64 6972 2829 3a0a 2020  ath.is_dir():.  
+00015a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a90: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00015aa0: 7574 696c 2e72 6d74 7265 6528 7265 7375  util.rmtree(resu
+00015ab0: 6c74 735f 7061 7468 290a 2020 2020 2020  lts_path).      
+00015ac0: 2020 2020 2020 656c 6966 2064 6620 6973        elif df is
+00015ad0: 206e 6f74 204e 6f6e 6520 6f72 2063 6170   not None or cap
+00015ae0: 735f 6469 7265 6374 6f72 7920 6973 206e  s_directory is n
+00015af0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00015b00: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
+00015b10: 6c69 6e69 6361 444c 4172 6775 6d65 6e74  linicaDLArgument
+00015b20: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00015b30: 2020 2020 2020 2020 2020 2066 2244 6174             f"Dat
+00015b40: 6120 6772 6f75 7020 7b64 6174 615f 6772  a group {data_gr
+00015b50: 6f75 707d 2069 7320 616c 7265 6164 7920  oup} is already 
+00015b60: 6465 6669 6e65 642e 2022 0a20 2020 2020  defined. ".     
+00015b70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00015b80: 2250 6c65 6173 6520 646f 206e 6f74 2067  "Please do not g
+00015b90: 6976 6520 616e 7920 6361 7073 5f64 6972  ive any caps_dir
+00015ba0: 6563 746f 7279 2c20 7473 765f 7061 7468  ectory, tsv_path
+00015bb0: 206f 7220 6d75 6c74 695f 636f 686f 7274   or multi_cohort
+00015bc0: 2074 6f20 7573 6520 6974 2e20 220a 2020   to use it. ".  
+00015bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015be0: 2020 6622 546f 2065 7261 7365 207b 6461    f"To erase {da
+00015bf0: 7461 5f67 726f 7570 7d20 706c 6561 7365  ta_group} please
+00015c00: 2073 6574 206f 7665 7277 7269 7465 2074   set overwrite t
+00015c10: 6f20 5472 7565 2e22 0a20 2020 2020 2020  o True.".       
+00015c20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00015c30: 2020 2020 656c 6966 206e 6f74 2067 726f      elif not gro
+00015c40: 7570 5f64 6972 2e69 735f 6469 7228 2920  up_dir.is_dir() 
+00015c50: 616e 6420 280a 2020 2020 2020 2020 2020  and (.          
+00015c60: 2020 6361 7073 5f64 6972 6563 746f 7279    caps_directory
+00015c70: 2069 7320 4e6f 6e65 206f 7220 6466 2069   is None or df i
+00015c80: 7320 4e6f 6e65 0a20 2020 2020 2020 2029  s None.        )
+00015c90: 3a20 2023 2044 6174 6120 6772 6f75 7020  :  # Data group 
+00015ca0: 646f 6573 206e 6f74 2065 7869 7374 2079  does not exist y
+00015cb0: 6574 202f 2077 6173 206f 7665 7277 7269  et / was overwri
+00015cc0: 7474 656e 202b 206d 6973 7369 6e67 2064  tten + missing d
+00015cd0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00015ce0: 7261 6973 6520 436c 696e 6963 6144 4c41  raise ClinicaDLA
+00015cf0: 7267 756d 656e 7445 7272 6f72 280a 2020  rgumentError(.  
+00015d00: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00015d10: 5468 6520 6461 7461 2067 726f 7570 207b  The data group {
+00015d20: 6461 7461 5f67 726f 7570 7d20 646f 6573  data_group} does
+00015d30: 206e 6f74 2061 6c72 6561 6479 2065 7869   not already exi
+00015d40: 7374 2e20 220a 2020 2020 2020 2020 2020  st. ".          
+00015d50: 2020 2020 2020 6622 506c 6561 7365 2073        f"Please s
+00015d60: 7065 6369 6679 2061 2063 6170 735f 6469  pecify a caps_di
+00015d70: 7265 6374 6f72 7920 616e 6420 6120 7473  rectory and a ts
+00015d80: 765f 7061 7468 2074 6f20 6372 6561 7465  v_path to create
+00015d90: 2074 6869 7320 6461 7461 2067 726f 7570   this data group
+00015da0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00015db0: 0a20 2020 2020 2020 2065 6c69 6620 280a  .        elif (.
+00015dc0: 2020 2020 2020 2020 2020 2020 6e6f 7420              not 
+00015dd0: 6772 6f75 705f 6469 722e 6973 5f64 6972  group_dir.is_dir
+00015de0: 2829 0a20 2020 2020 2020 2029 3a20 2023  ().        ):  #
+00015df0: 2044 6174 6120 6772 6f75 7020 646f 6573   Data group does
+00015e00: 206e 6f74 2065 7869 7374 2079 6574 202f   not exist yet /
+00015e10: 2077 6173 206f 7665 7277 7269 7474 656e   was overwritten
+00015e20: 202b 2061 6c6c 2064 6174 6120 6973 2070   + all data is p
+00015e30: 726f 7669 6465 640a 2020 2020 2020 2020  rovided.        
+00015e40: 2020 2020 6966 2073 6b69 705f 6c65 616b      if skip_leak
+00015e50: 5f63 6865 636b 3a0a 2020 2020 2020 2020  _check:.        
+00015e60: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00015e70: 6e66 6f28 2253 6b69 7070 696e 6720 6461  nfo("Skipping da
+00015e80: 7461 206c 6561 6b61 6765 2063 6865 636b  ta leakage check
+00015e90: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+00015ea0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00015eb0: 2020 2020 2073 656c 662e 5f63 6865 636b       self._check
+00015ec0: 5f6c 6561 6b61 6765 2864 6174 615f 6772  _leakage(data_gr
+00015ed0: 6f75 702c 2064 6629 0a20 2020 2020 2020  oup, df).       
+00015ee0: 2020 2020 2073 656c 662e 5f77 7269 7465       self._write
+00015ef0: 5f64 6174 615f 6772 6f75 7028 0a20 2020  _data_group(.   
+00015f00: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00015f10: 615f 6772 6f75 702c 2064 662c 2063 6170  a_group, df, cap
+00015f20: 735f 6469 7265 6374 6f72 792c 206d 756c  s_directory, mul
+00015f30: 7469 5f63 6f68 6f72 742c 206c 6162 656c  ti_cohort, label
+00015f40: 3d6c 6162 656c 0a20 2020 2020 2020 2020  =label.         
+00015f50: 2020 2029 0a0a 2020 2020 2323 2323 2323     )..    ######
+00015f60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00015f70: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+00015f80: 4669 6c65 2077 7269 7465 7273 2020 2020  File writers    
+00015f90: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+00015fa0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00015fb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00015fc0: 230a 2020 2020 4073 7461 7469 636d 6574  #.    @staticmet
+00015fd0: 686f 640a 2020 2020 6465 6620 7772 6974  hod.    def writ
+00015fe0: 655f 7061 7261 6d65 7465 7273 286a 736f  e_parameters(jso
+00015ff0: 6e5f 7061 7468 3a20 5061 7468 2c20 7061  n_path: Path, pa
+00016000: 7261 6d65 7465 7273 2c20 7665 7262 6f73  rameters, verbos
+00016010: 653d 5472 7565 293a 0a20 2020 2020 2020  e=True):.       
+00016020: 2022 2222 5772 6974 6520 4a53 4f4e 2066   """Write JSON f
+00016030: 696c 6573 206f 6620 7061 7261 6d65 7465  iles of paramete
+00016040: 7273 2e22 2222 0a20 2020 2020 2020 206c  rs.""".        l
+00016050: 6f67 6765 722e 6465 6275 6728 2257 7269  ogger.debug("Wri
+00016060: 7469 6e67 2070 6172 616d 6574 6572 732e  ting parameters.
+00016070: 2e2e 2229 0a20 2020 2020 2020 206a 736f  ..").        jso
+00016080: 6e5f 7061 7468 2e6d 6b64 6972 2870 6172  n_path.mkdir(par
+00016090: 656e 7473 3d54 7275 652c 2065 7869 7374  ents=True, exist
+000160a0: 5f6f 6b3d 5472 7565 290a 0a20 2020 2020  _ok=True)..     
+000160b0: 2020 2023 2073 6176 6520 746f 206a 736f     # save to jso
+000160c0: 6e20 6669 6c65 0a20 2020 2020 2020 206a  n file.        j
+000160d0: 736f 6e5f 7061 7468 203d 206a 736f 6e5f  son_path = json_
+000160e0: 7061 7468 202f 2022 6d61 7073 2e6a 736f  path / "maps.jso
+000160f0: 6e22 0a20 2020 2020 2020 2069 6620 7665  n".        if ve
+00016100: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00016110: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
+00016120: 2250 6174 6820 6f66 206a 736f 6e20 6669  "Path of json fi
+00016130: 6c65 3a20 7b6a 736f 6e5f 7061 7468 7d22  le: {json_path}"
+00016140: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+00016150: 6a73 6f6e 5f70 6174 682e 6f70 656e 286d  json_path.open(m
+00016160: 6f64 653d 2277 2229 2061 7320 6a73 6f6e  ode="w") as json
+00016170: 5f66 696c 653a 0a20 2020 2020 2020 2020  _file:.         
+00016180: 2020 206a 736f 6e2e 6475 6d70 280a 2020     json.dump(.  
+00016190: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000161a0: 7261 6d65 7465 7273 2c20 6a73 6f6e 5f66  rameters, json_f
+000161b0: 696c 652c 2073 6b69 706b 6579 733d 5472  ile, skipkeys=Tr
+000161c0: 7565 2c20 696e 6465 6e74 3d34 2c20 6465  ue, indent=4, de
+000161d0: 6661 756c 743d 7061 7468 5f65 6e63 6f64  fault=path_encod
+000161e0: 6572 0a20 2020 2020 2020 2020 2020 2029  er.            )
+000161f0: 0a0a 2020 2020 6465 6620 5f77 7269 7465  ..    def _write
+00016200: 5f72 6571 7569 7265 6d65 6e74 735f 7665  _requirements_ve
+00016210: 7273 696f 6e28 7365 6c66 293a 0a20 2020  rsion(self):.   
+00016220: 2020 2020 2022 2222 5772 6974 6573 2074       """Writes t
+00016230: 6865 2065 6e76 6972 6f6e 6d65 6e74 2e74  he environment.t
+00016240: 7874 2066 696c 652e 2222 220a 2020 2020  xt file.""".    
+00016250: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00016260: 2822 5772 6974 696e 6720 7265 7175 6972  ("Writing requir
+00016270: 656d 656e 7420 7665 7273 696f 6e2e 2e2e  ement version...
+00016280: 2229 0a20 2020 2020 2020 2074 7279 3a0a  ").        try:.
+00016290: 2020 2020 2020 2020 2020 2020 656e 765f              env_
+000162a0: 7661 7269 6162 6c65 7320 3d20 7375 6270  variables = subp
+000162b0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+000162c0: 7075 7428 2270 6970 2066 7265 657a 6522  put("pip freeze"
+000162d0: 2c20 7368 656c 6c3d 5472 7565 292e 6465  , shell=True).de
+000162e0: 636f 6465 280a 2020 2020 2020 2020 2020  code(.          
+000162f0: 2020 2020 2020 2275 7466 2d38 220a 2020        "utf-8".  
+00016300: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016310: 2020 2020 2020 2020 7769 7468 2028 7365          with (se
+00016320: 6c66 2e6d 6170 735f 7061 7468 202f 2022  lf.maps_path / "
+00016330: 656e 7669 726f 6e6d 656e 742e 7478 7422  environment.txt"
+00016340: 292e 6f70 656e 286d 6f64 653d 2277 2229  ).open(mode="w")
+00016350: 2061 7320 6669 6c65 3a0a 2020 2020 2020   as file:.      
+00016360: 2020 2020 2020 2020 2020 6669 6c65 2e77            file.w
+00016370: 7269 7465 2865 6e76 5f76 6172 6961 626c  rite(env_variabl
+00016380: 6573 290a 2020 2020 2020 2020 6578 6365  es).        exce
+00016390: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
+000163a0: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
+000163b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000163c0: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+000163d0: 2020 2020 2020 2020 2020 2020 2020 2259                "Y
+000163e0: 6f75 2064 6f20 6e6f 7420 6861 7665 2074  ou do not have t
+000163f0: 6865 2072 6967 6874 2074 6f20 6578 6563  he right to exec
+00016400: 7574 6520 7069 7020 6672 6565 7a65 2e20  ute pip freeze. 
+00016410: 596f 7572 2065 6e76 6972 6f6e 6d65 6e74  Your environment
+00016420: 2077 696c 6c20 6e6f 7420 6265 2077 7269   will not be wri
+00016430: 7474 656e 220a 2020 2020 2020 2020 2020  tten".          
+00016440: 2020 290a 0a20 2020 2064 6566 205f 7772    )..    def _wr
+00016450: 6974 655f 7472 6169 6e69 6e67 5f64 6174  ite_training_dat
+00016460: 6128 7365 6c66 293a 0a20 2020 2020 2020  a(self):.       
+00016470: 2022 2222 5772 6974 6573 2074 6865 2054   """Writes the T
+00016480: 5356 2066 696c 6520 636f 6e74 6169 6e69  SV file containi
+00016490: 6e67 2074 6865 2070 6172 7469 6369 7061  ng the participa
+000164a0: 6e74 2061 6e64 2073 6573 7369 6f6e 2049  nt and session I
+000164b0: 4473 2075 7365 6420 666f 7220 7472 6169  Ds used for trai
+000164c0: 6e69 6e67 2e22 2222 0a20 2020 2020 2020  ning.""".       
+000164d0: 206c 6f67 6765 722e 6465 6275 6728 2257   logger.debug("W
+000164e0: 7269 7469 6e67 2074 7261 696e 696e 6720  riting training 
+000164f0: 6461 7461 2e2e 2e22 290a 2020 2020 2020  data...").      
+00016500: 2020 6672 6f6d 2063 6c69 6e69 6361 646c    from clinicadl
+00016510: 2e75 7469 6c73 2e63 6170 735f 6461 7461  .utils.caps_data
+00016520: 7365 742e 6461 7461 2069 6d70 6f72 7420  set.data import 
+00016530: 6c6f 6164 5f64 6174 615f 7465 7374 0a0a  load_data_test..
+00016540: 2020 2020 2020 2020 7472 6169 6e5f 6466          train_df
+00016550: 203d 206c 6f61 645f 6461 7461 5f74 6573   = load_data_tes
+00016560: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
+00016570: 656c 662e 7473 765f 7061 7468 2c0a 2020  elf.tsv_path,.  
+00016580: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00016590: 6961 676e 6f73 6573 2c0a 2020 2020 2020  iagnoses,.      
+000165a0: 2020 2020 2020 6261 7365 6c69 6e65 3d46        baseline=F
+000165b0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+000165c0: 2020 6d75 6c74 695f 636f 686f 7274 3d73    multi_cohort=s
+000165d0: 656c 662e 6d75 6c74 695f 636f 686f 7274  elf.multi_cohort
+000165e0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000165f0: 2020 2020 7472 6169 6e5f 6466 203d 2074      train_df = t
+00016600: 7261 696e 5f64 665b 5b22 7061 7274 6963  rain_df[["partic
+00016610: 6970 616e 745f 6964 222c 2022 7365 7373  ipant_id", "sess
+00016620: 696f 6e5f 6964 225d 5d0a 2020 2020 2020  ion_id"]].      
+00016630: 2020 6966 2073 656c 662e 7472 616e 7366    if self.transf
+00016640: 6572 5f70 6174 683a 0a20 2020 2020 2020  er_path:.       
+00016650: 2020 2020 2074 7261 6e73 6665 725f 7472       transfer_tr
+00016660: 6169 6e5f 7061 7468 203d 2073 656c 662e  ain_path = self.
+00016670: 7472 616e 7366 6572 5f70 6174 6820 2f20  transfer_path / 
+00016680: 2267 726f 7570 7322 202f 2022 7472 6169  "groups" / "trai
+00016690: 6e2b 7661 6c69 6461 7469 6f6e 2e74 7376  n+validation.tsv
+000166a0: 220a 2020 2020 2020 2020 2020 2020 7472  ".            tr
+000166b0: 616e 7366 6572 5f74 7261 696e 5f64 6620  ansfer_train_df 
+000166c0: 3d20 7064 2e72 6561 645f 6373 7628 7472  = pd.read_csv(tr
+000166d0: 616e 7366 6572 5f74 7261 696e 5f70 6174  ansfer_train_pat
+000166e0: 682c 2073 6570 3d22 5c74 2229 0a20 2020  h, sep="\t").   
+000166f0: 2020 2020 2020 2020 2074 7261 6e73 6665           transfe
+00016700: 725f 7472 6169 6e5f 6466 203d 2074 7261  r_train_df = tra
+00016710: 6e73 6665 725f 7472 6169 6e5f 6466 5b5b  nsfer_train_df[[
+00016720: 2270 6172 7469 6369 7061 6e74 5f69 6422  "participant_id"
+00016730: 2c20 2273 6573 7369 6f6e 5f69 6422 5d5d  , "session_id"]]
+00016740: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+00016750: 696e 5f64 6620 3d20 7064 2e63 6f6e 6361  in_df = pd.conca
+00016760: 7428 5b74 7261 696e 5f64 662c 2074 7261  t([train_df, tra
+00016770: 6e73 6665 725f 7472 6169 6e5f 6466 5d29  nsfer_train_df])
+00016780: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+00016790: 696e 5f64 662e 6472 6f70 5f64 7570 6c69  in_df.drop_dupli
+000167a0: 6361 7465 7328 696e 706c 6163 653d 5472  cates(inplace=Tr
+000167b0: 7565 290a 2020 2020 2020 2020 7472 6169  ue).        trai
+000167c0: 6e5f 6466 2e74 6f5f 6373 7628 0a20 2020  n_df.to_csv(.   
+000167d0: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+000167e0: 7073 5f70 6174 6820 2f20 2267 726f 7570  ps_path / "group
+000167f0: 7322 202f 2022 7472 6169 6e2b 7661 6c69  s" / "train+vali
+00016800: 6461 7469 6f6e 2e74 7376 222c 2073 6570  dation.tsv", sep
+00016810: 3d22 5c74 222c 2069 6e64 6578 3d46 616c  ="\t", index=Fal
+00016820: 7365 0a20 2020 2020 2020 2029 0a0a 2020  se.        )..  
+00016830: 2020 6465 6620 5f77 7269 7465 5f64 6174    def _write_dat
+00016840: 615f 6772 6f75 7028 0a20 2020 2020 2020  a_group(.       
+00016850: 2073 656c 662c 0a20 2020 2020 2020 2064   self,.        d
+00016860: 6174 615f 6772 6f75 702c 0a20 2020 2020  ata_group,.     
+00016870: 2020 2064 662c 0a20 2020 2020 2020 2063     df,.        c
+00016880: 6170 735f 6469 7265 6374 6f72 793a 2050  aps_directory: P
+00016890: 6174 6820 3d20 4e6f 6e65 2c0a 2020 2020  ath = None,.    
+000168a0: 2020 2020 6d75 6c74 695f 636f 686f 7274      multi_cohort
+000168b0: 3a20 626f 6f6c 203d 204e 6f6e 652c 0a20  : bool = None,. 
+000168c0: 2020 2020 2020 206c 6162 656c 3d4e 6f6e         label=Non
+000168d0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+000168e0: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
+000168f0: 6563 6b20 7468 6174 2061 2064 6174 615f  eck that a data_
+00016900: 6772 6f75 7020 6973 206e 6f74 2061 6c72  group is not alr
+00016910: 6561 6479 2077 7269 7474 656e 2061 6e64  eady written and
+00016920: 2077 7269 7465 7320 7468 6520 6368 6172   writes the char
+00016930: 6163 7465 7269 7374 6963 7320 6f66 2074  acteristics of t
+00016940: 6865 2064 6174 6120 6772 6f75 700a 2020  he data group.  
+00016950: 2020 2020 2020 2854 5356 2066 696c 6520        (TSV file 
+00016960: 7769 7468 2061 206c 6973 7420 6f66 2070  with a list of p
+00016970: 6172 7469 6369 7061 6e74 202f 2073 6573  articipant / ses
+00016980: 7369 6f6e 202b 204a 534f 4e20 6669 6c65  sion + JSON file
+00016990: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
+000169a0: 4341 5053 2061 6e64 2074 6865 2070 7265  CAPS and the pre
+000169b0: 7072 6f63 6573 7369 6e67 292e 0a0a 2020  processing)...  
+000169c0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+000169d0: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
+000169e0: 7570 2028 7374 7229 3a20 6e61 6d65 2077  up (str): name w
+000169f0: 686f 7365 2070 7265 7365 6e63 6520 6973  hose presence is
+00016a00: 2063 6865 636b 6564 2e0a 2020 2020 2020   checked..      
+00016a10: 2020 2020 2020 6466 2028 7064 2e44 6174        df (pd.Dat
+00016a20: 6146 7261 6d65 293a 2044 6174 6146 7261  aFrame): DataFra
+00016a30: 6d65 2063 6f6e 7461 696e 696e 6720 7468  me containing th
+00016a40: 6520 7061 7274 6963 6970 616e 745f 6964  e participant_id
+00016a50: 2061 6e64 2073 6573 7369 6f6e 5f69 6420   and session_id 
+00016a60: 2861 6e64 206c 6162 656c 2069 6620 7573  (and label if us
+00016a70: 655f 6c61 6265 6c73 2069 7320 5472 7565  e_labels is True
+00016a80: 290a 2020 2020 2020 2020 2020 2020 6361  ).            ca
+00016a90: 7073 5f64 6972 6563 746f 7279 2028 7374  ps_directory (st
+00016aa0: 7229 3a20 6361 7073 5f64 6972 6563 746f  r): caps_directo
+00016ab0: 7279 2069 6620 6469 6666 6572 656e 7420  ry if different 
+00016ac0: 6672 6f6d 2074 6865 2074 7261 696e 696e  from the trainin
+00016ad0: 6720 6361 7073 5f64 6972 6563 746f 7279  g caps_directory
+00016ae0: 2c0a 2020 2020 2020 2020 2020 2020 6d75  ,.            mu
+00016af0: 6c74 695f 636f 686f 7274 2028 626f 6f6c  lti_cohort (bool
+00016b00: 293a 206d 756c 7469 5f63 6f68 6f72 7420  ): multi_cohort 
+00016b10: 7573 6564 2069 6620 6469 6666 6572 656e  used if differen
+00016b20: 7420 6672 6f6d 2074 6865 2074 7261 696e  t from the train
+00016b30: 696e 6720 6d75 6c74 695f 636f 686f 7274  ing multi_cohort
+00016b40: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00016b50: 2020 2020 2020 6772 6f75 705f 7061 7468        group_path
+00016b60: 203d 2073 656c 662e 6d61 7073 5f70 6174   = self.maps_pat
+00016b70: 6820 2f20 2267 726f 7570 7322 202f 2064  h / "groups" / d
+00016b80: 6174 615f 6772 6f75 700a 2020 2020 2020  ata_group.      
+00016b90: 2020 6772 6f75 705f 7061 7468 2e6d 6b64    group_path.mkd
+00016ba0: 6972 2870 6172 656e 7473 3d54 7275 6529  ir(parents=True)
+00016bb0: 0a0a 2020 2020 2020 2020 636f 6c75 6d6e  ..        column
+00016bc0: 7320 3d20 5b22 7061 7274 6963 6970 616e  s = ["participan
+00016bd0: 745f 6964 222c 2022 7365 7373 696f 6e5f  t_id", "session_
+00016be0: 6964 222c 2022 636f 686f 7274 225d 0a20  id", "cohort"]. 
+00016bf0: 2020 2020 2020 2069 6620 7365 6c66 2e6c         if self.l
+00016c00: 6162 656c 2069 6e20 6466 2e63 6f6c 756d  abel in df.colum
+00016c10: 6e73 2e76 616c 7565 733a 0a20 2020 2020  ns.values:.     
+00016c20: 2020 2020 2020 2063 6f6c 756d 6e73 202b         columns +
+00016c30: 3d20 5b73 656c 662e 6c61 6265 6c5d 0a20  = [self.label]. 
+00016c40: 2020 2020 2020 2069 6620 6c61 6265 6c20         if label 
+00016c50: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00016c60: 6c61 6265 6c20 696e 2064 662e 636f 6c75  label in df.colu
+00016c70: 6d6e 732e 7661 6c75 6573 3a0a 2020 2020  mns.values:.    
+00016c80: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
+00016c90: 2b3d 205b 6c61 6265 6c5d 0a0a 2020 2020  += [label]..    
+00016ca0: 2020 2020 6466 2e74 6f5f 6373 7628 6772      df.to_csv(gr
+00016cb0: 6f75 705f 7061 7468 202f 2022 6461 7461  oup_path / "data
+00016cc0: 2e74 7376 222c 2073 6570 3d22 5c74 222c  .tsv", sep="\t",
+00016cd0: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
+00016ce0: 2c20 696e 6465 783d 4661 6c73 6529 0a20  , index=False). 
+00016cf0: 2020 2020 2020 2073 656c 662e 7772 6974         self.writ
+00016d00: 655f 7061 7261 6d65 7465 7273 280a 2020  e_parameters(.  
+00016d10: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+00016d20: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00016d30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00016d40: 2020 2020 2263 6170 735f 6469 7265 6374      "caps_direct
+00016d50: 6f72 7922 3a20 280a 2020 2020 2020 2020  ory": (.        
+00016d60: 2020 2020 2020 2020 2020 2020 6361 7073              caps
+00016d70: 5f64 6972 6563 746f 7279 0a20 2020 2020  _directory.     
+00016d80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016d90: 6620 6361 7073 5f64 6972 6563 746f 7279  f caps_directory
+00016da0: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00016db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016dc0: 2065 6c73 6520 7365 6c66 2e63 6170 735f   else self.caps_
+00016dd0: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
+00016de0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00016df0: 2020 2020 2020 2020 2020 2020 2022 6d75               "mu
+00016e00: 6c74 695f 636f 686f 7274 223a 2028 0a20  lti_cohort": (. 
+00016e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e20: 2020 206d 756c 7469 5f63 6f68 6f72 7420     multi_cohort 
+00016e30: 6966 206d 756c 7469 5f63 6f68 6f72 7420  if multi_cohort 
+00016e40: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00016e50: 2073 656c 662e 6d75 6c74 695f 636f 686f   self.multi_coho
+00016e60: 7274 0a20 2020 2020 2020 2020 2020 2020  rt.             
+00016e70: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00016e80: 2020 7d2c 0a20 2020 2020 2020 2029 0a0a    },.        )..
+00016e90: 2020 2020 6465 6620 5f77 7269 7465 5f74      def _write_t
+00016ea0: 7261 696e 5f76 616c 5f67 726f 7570 7328  rain_val_groups(
+00016eb0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00016ec0: 2222 4465 6669 6e65 7320 7468 6520 7472  ""Defines the tr
+00016ed0: 6169 6e69 6e67 2061 6e64 2076 616c 6964  aining and valid
+00016ee0: 6174 696f 6e20 6772 6f75 7073 2061 7420  ation groups at 
+00016ef0: 7468 6520 696e 6974 6961 6c69 7a61 7469  the initializati
+00016f00: 6f6e 2222 220a 2020 2020 2020 2020 6c6f  on""".        lo
+00016f10: 6767 6572 2e64 6562 7567 2822 5772 6974  gger.debug("Writ
+00016f20: 696e 6720 7472 6169 6e69 6e67 2061 6e64  ing training and
+00016f30: 2076 616c 6964 6174 696f 6e20 6772 6f75   validation grou
+00016f40: 7073 2e2e 2e22 290a 2020 2020 2020 2020  ps...").        
+00016f50: 7370 6c69 745f 6d61 6e61 6765 7220 3d20  split_manager = 
+00016f60: 7365 6c66 2e5f 696e 6974 5f73 706c 6974  self._init_split
+00016f70: 5f6d 616e 6167 6572 2829 0a20 2020 2020  _manager().     
+00016f80: 2020 2066 6f72 2073 706c 6974 2069 6e20     for split in 
+00016f90: 7370 6c69 745f 6d61 6e61 6765 722e 7370  split_manager.sp
+00016fa0: 6c69 745f 6974 6572 6174 6f72 2829 3a0a  lit_iterator():.
+00016fb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00016fc0: 6461 7461 5f67 726f 7570 2069 6e20 5b22  data_group in ["
+00016fd0: 7472 6169 6e22 2c20 2276 616c 6964 6174  train", "validat
+00016fe0: 696f 6e22 5d3a 0a20 2020 2020 2020 2020  ion"]:.         
+00016ff0: 2020 2020 2020 2064 6620 3d20 7370 6c69         df = spli
+00017000: 745f 6d61 6e61 6765 725b 7370 6c69 745d  t_manager[split]
+00017010: 5b64 6174 615f 6772 6f75 705d 0a20 2020  [data_group].   
+00017020: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00017030: 7570 5f70 6174 6820 3d20 280a 2020 2020  up_path = (.    
+00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017050: 7365 6c66 2e6d 6170 735f 7061 7468 0a20  self.maps_path. 
+00017060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017070: 2020 202f 2022 6772 6f75 7073 220a 2020     / "groups".  
+00017080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017090: 2020 2f20 6461 7461 5f67 726f 7570 0a20    / data_group. 
+000170a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170b0: 2020 202f 2066 227b 7365 6c66 2e73 706c     / f"{self.spl
+000170c0: 6974 5f6e 616d 657d 2d7b 7370 6c69 747d  it_name}-{split}
+000170d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000170e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000170f0: 2020 2020 6772 6f75 705f 7061 7468 2e6d      group_path.m
+00017100: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
+00017110: 652c 2065 7869 7374 5f6f 6b3d 5472 7565  e, exist_ok=True
+00017120: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00017130: 2020 2063 6f6c 756d 6e73 203d 205b 2270     columns = ["p
+00017140: 6172 7469 6369 7061 6e74 5f69 6422 2c20  articipant_id", 
+00017150: 2273 6573 7369 6f6e 5f69 6422 2c20 2263  "session_id", "c
+00017160: 6f68 6f72 7422 5d0a 2020 2020 2020 2020  ohort"].        
+00017170: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017180: 6c61 6265 6c20 6973 206e 6f74 204e 6f6e  label is not Non
+00017190: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000171a0: 2020 2020 2020 2063 6f6c 756d 6e73 2e61         columns.a
+000171b0: 7070 656e 6428 7365 6c66 2e6c 6162 656c  ppend(self.label
+000171c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000171d0: 2020 6466 2e74 6f5f 6373 7628 6772 6f75    df.to_csv(grou
+000171e0: 705f 7061 7468 202f 2022 6461 7461 2e74  p_path / "data.t
+000171f0: 7376 222c 2073 6570 3d22 5c74 222c 2063  sv", sep="\t", c
+00017200: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 290a  olumns=columns).
+00017210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017220: 7365 6c66 2e77 7269 7465 5f70 6172 616d  self.write_param
+00017230: 6574 6572 7328 0a20 2020 2020 2020 2020  eters(.         
+00017240: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00017250: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+00017260: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00017270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017280: 2020 2020 2022 6361 7073 5f64 6972 6563       "caps_direc
+00017290: 746f 7279 223a 2073 656c 662e 6361 7073  tory": self.caps
+000172a0: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
+000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172c0: 2020 2020 226d 756c 7469 5f63 6f68 6f72      "multi_cohor
+000172d0: 7422 3a20 7365 6c66 2e6d 756c 7469 5f63  t": self.multi_c
+000172e0: 6f68 6f72 742c 0a20 2020 2020 2020 2020  ohort,.         
+000172f0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00017300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017310: 2020 7665 7262 6f73 653d 4661 6c73 652c    verbose=False,
+00017320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017330: 2029 0a0a 2020 2020 6465 6620 5f77 7269   )..    def _wri
+00017340: 7465 5f77 6569 6768 7473 280a 2020 2020  te_weights(.    
+00017350: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00017360: 2020 7374 6174 653a 2044 6963 745b 7374    state: Dict[st
+00017370: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
+00017380: 206d 6574 7269 6373 5f64 6963 743a 204f   metrics_dict: O
+00017390: 7074 696f 6e61 6c5b 4469 6374 5b73 7472  ptional[Dict[str
+000173a0: 2c20 626f 6f6c 5d5d 2c0a 2020 2020 2020  , bool]],.      
+000173b0: 2020 7370 6c69 743a 2069 6e74 2c0a 2020    split: int,.  
+000173c0: 2020 2020 2020 6e65 7477 6f72 6b3a 2069        network: i
+000173d0: 6e74 203d 204e 6f6e 652c 0a20 2020 2020  nt = None,.     
+000173e0: 2020 2066 696c 656e 616d 653a 2073 7472     filename: str
+000173f0: 203d 2022 6368 6563 6b70 6f69 6e74 2e70   = "checkpoint.p
+00017400: 7468 2e74 6172 222c 0a20 2020 2020 2020  th.tar",.       
+00017410: 2073 6176 655f 616c 6c5f 6d6f 6465 6c73   save_all_models
+00017420: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00017430: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+00017440: 2222 0a20 2020 2020 2020 2055 7064 6174  "".        Updat
+00017450: 6520 6368 6563 6b70 6f69 6e74 2061 6e64  e checkpoint and
+00017460: 2073 6176 6520 7468 6520 6265 7374 206d   save the best m
+00017470: 6f64 656c 2061 6363 6f72 6469 6e67 2074  odel according t
+00017480: 6f20 6120 7365 7420 6f66 206d 6574 7269  o a set of metri
+00017490: 6373 2e0a 2020 2020 2020 2020 4966 206e  cs..        If n
+000174a0: 6f20 6d65 7472 6963 735f 6469 6374 2069  o metrics_dict i
+000174b0: 7320 6769 7665 6e2c 206f 6e6c 7920 7468  s given, only th
+000174c0: 6520 6368 6563 6b70 6f69 6e74 2069 7320  e checkpoint is 
+000174d0: 7361 7665 642e 0a0a 2020 2020 2020 2020  saved...        
+000174e0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+000174f0: 2020 7374 6174 653a 2073 7461 7465 206f    state: state o
+00017500: 6620 7468 6520 7472 6169 6e69 6e67 2028  f the training (
+00017510: 6d6f 6465 6c20 7765 6967 6874 732c 2065  model weights, e
+00017520: 706f 6368 2e2e 2e29 2e0a 2020 2020 2020  poch...)..      
+00017530: 2020 2020 2020 6d65 7472 6963 735f 6469        metrics_di
+00017540: 6374 3a20 6f75 7470 7574 206f 6620 5265  ct: output of Re
+00017550: 7461 696e 4265 7374 2073 7465 702e 0a20  tainBest step.. 
+00017560: 2020 2020 2020 2020 2020 2073 706c 6974             split
+00017570: 3a20 7370 6c69 7420 6e75 6d62 6572 2e0a  : split number..
+00017580: 2020 2020 2020 2020 2020 2020 6e65 7477              netw
+00017590: 6f72 6b3a 206e 6574 776f 726b 206e 756d  ork: network num
+000175a0: 6265 7220 286d 756c 7469 2d6e 6574 776f  ber (multi-netwo
+000175b0: 726b 2066 7261 6d65 776f 726b 292e 0a20  rk framework).. 
+000175c0: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+000175d0: 616d 653a 206e 616d 6520 6f66 2074 6865  ame: name of the
+000175e0: 2063 6865 636b 706f 696e 7420 6669 6c65   checkpoint file
+000175f0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00017600: 2020 2020 2020 6368 6563 6b70 6f69 6e74        checkpoint
+00017610: 5f64 6972 203d 2073 656c 662e 6d61 7073  _dir = self.maps
+00017620: 5f70 6174 6820 2f20 6622 7b73 656c 662e  _path / f"{self.
+00017630: 7370 6c69 745f 6e61 6d65 7d2d 7b73 706c  split_name}-{spl
+00017640: 6974 7d22 202f 2022 746d 7022 0a20 2020  it}" / "tmp".   
+00017650: 2020 2020 2063 6865 636b 706f 696e 745f       checkpoint_
+00017660: 6469 722e 6d6b 6469 7228 7061 7265 6e74  dir.mkdir(parent
+00017670: 733d 5472 7565 2c20 6578 6973 745f 6f6b  s=True, exist_ok
+00017680: 3d54 7275 6529 0a20 2020 2020 2020 2063  =True).        c
+00017690: 6865 636b 706f 696e 745f 7061 7468 203d  heckpoint_path =
+000176a0: 2063 6865 636b 706f 696e 745f 6469 7220   checkpoint_dir 
+000176b0: 2f20 6669 6c65 6e61 6d65 0a20 2020 2020  / filename.     
+000176c0: 2020 2074 6f72 6368 2e73 6176 6528 7374     torch.save(st
+000176d0: 6174 652c 2063 6865 636b 706f 696e 745f  ate, checkpoint_
+000176e0: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
+000176f0: 6620 7361 7665 5f61 6c6c 5f6d 6f64 656c  f save_all_model
+00017700: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+00017710: 6c6c 5f6d 6f64 656c 735f 6469 7220 3d20  ll_models_dir = 
+00017720: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00017730: 2020 7365 6c66 2e6d 6170 735f 7061 7468    self.maps_path
+00017740: 202f 2066 227b 7365 6c66 2e73 706c 6974   / f"{self.split
+00017750: 5f6e 616d 657d 2d7b 7370 6c69 747d 2220  _name}-{split}" 
+00017760: 2f20 2261 6c6c 5f6d 6f64 656c 7322 0a20  / "all_models". 
+00017770: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00017780: 2020 2020 2020 2020 2061 6c6c 5f6d 6f64           all_mod
+00017790: 656c 735f 6469 722e 6d6b 6469 7228 7061  els_dir.mkdir(pa
+000177a0: 7265 6e74 733d 5472 7565 2c20 6578 6973  rents=True, exis
+000177b0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
+000177c0: 2020 2020 2020 2074 6f72 6368 2e73 6176         torch.sav
+000177d0: 6528 7374 6174 652c 2061 6c6c 5f6d 6f64  e(state, all_mod
+000177e0: 656c 735f 6469 7220 2f20 6622 6d6f 6465  els_dir / f"mode
+000177f0: 6c5f 6570 6f63 685f 7b73 7461 7465 5b27  l_epoch_{state['
+00017800: 6570 6f63 6827 5d7d 2e70 7468 2e74 6172  epoch']}.pth.tar
+00017810: 2229 0a0a 2020 2020 2020 2020 6265 7374  ")..        best
+00017820: 5f66 696c 656e 616d 6520 3d20 226d 6f64  _filename = "mod
+00017830: 656c 2e70 7468 2e74 6172 220a 2020 2020  el.pth.tar".    
+00017840: 2020 2020 6966 206e 6574 776f 726b 2069      if network i
+00017850: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00017860: 2020 2020 2020 2020 6265 7374 5f66 696c          best_fil
+00017870: 656e 616d 6520 3d20 6622 6e65 7477 6f72  ename = f"networ
+00017880: 6b2d 7b6e 6574 776f 726b 7d5f 6d6f 6465  k-{network}_mode
+00017890: 6c2e 7074 682e 7461 7222 0a0a 2020 2020  l.pth.tar"..    
+000178a0: 2020 2020 2320 5361 7665 206d 6f64 656c      # Save model
+000178b0: 2061 6363 6f72 6469 6e67 2074 6f20 7365   according to se
+000178c0: 7665 7261 6c20 6d65 7472 6963 730a 2020  veral metrics.  
+000178d0: 2020 2020 2020 6966 206d 6574 7269 6373        if metrics
+000178e0: 5f64 6963 7420 6973 206e 6f74 204e 6f6e  _dict is not Non
+000178f0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00017900: 6f72 206d 6574 7269 635f 6e61 6d65 2c20  or metric_name, 
+00017910: 6d65 7472 6963 5f62 6f6f 6c20 696e 206d  metric_bool in m
+00017920: 6574 7269 6373 5f64 6963 742e 6974 656d  etrics_dict.item
+00017930: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00017940: 2020 2020 206d 6574 7269 635f 7061 7468       metric_path
+00017950: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00017960: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00017970: 7073 5f70 6174 680a 2020 2020 2020 2020  ps_path.        
+00017980: 2020 2020 2020 2020 2020 2020 2f20 6622              / f"
+00017990: 7b73 656c 662e 7370 6c69 745f 6e61 6d65  {self.split_name
+000179a0: 7d2d 7b73 706c 6974 7d22 0a20 2020 2020  }-{split}".     
+000179b0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+000179c0: 2066 2262 6573 742d 7b6d 6574 7269 635f   f"best-{metric_
+000179d0: 6e61 6d65 7d22 0a20 2020 2020 2020 2020  name}".         
+000179e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000179f0: 2020 2020 2020 2020 2069 6620 6d65 7472           if metr
+00017a00: 6963 5f62 6f6f 6c3a 0a20 2020 2020 2020  ic_bool:.       
+00017a10: 2020 2020 2020 2020 2020 2020 206d 6574               met
+00017a20: 7269 635f 7061 7468 2e6d 6b64 6972 2870  ric_path.mkdir(p
+00017a30: 6172 656e 7473 3d54 7275 652c 2065 7869  arents=True, exi
+00017a40: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
+00017a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a60: 7368 7574 696c 2e63 6f70 7966 696c 6528  shutil.copyfile(
+00017a70: 6368 6563 6b70 6f69 6e74 5f70 6174 682c  checkpoint_path,
+00017a80: 206d 6574 7269 635f 7061 7468 202f 2062   metric_path / b
+00017a90: 6573 745f 6669 6c65 6e61 6d65 290a 0a20  est_filename).. 
+00017aa0: 2020 2064 6566 205f 7772 6974 655f 696e     def _write_in
+00017ab0: 666f 726d 6174 696f 6e28 7365 6c66 293a  formation(self):
+00017ac0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00017ad0: 2020 2020 2057 7269 7465 7320 6d6f 6465       Writes mode
+00017ae0: 6c20 6172 6368 6974 6563 7475 7265 206f  l architecture o
+00017af0: 6620 7468 6520 4d41 5053 2069 6e20 4d41  f the MAPS in MA
+00017b00: 5053 2072 6f6f 742e 0a20 2020 2020 2020  PS root..       
+00017b10: 2022 2222 0a20 2020 2020 2020 2066 726f   """.        fro
+00017b20: 6d20 6461 7465 7469 6d65 2069 6d70 6f72  m datetime impor
+00017b30: 7420 6461 7465 7469 6d65 0a0a 2020 2020  t datetime..    
+00017b40: 2020 2020 696d 706f 7274 2063 6c69 6e69      import clini
+00017b50: 6361 646c 2e75 7469 6c73 2e6e 6574 776f  cadl.utils.netwo
+00017b60: 726b 2061 7320 6e65 7477 6f72 6b5f 7061  rk as network_pa
+00017b70: 636b 6167 650a 0a20 2020 2020 2020 206d  ckage..        m
+00017b80: 6f64 656c 5f63 6c61 7373 203d 2067 6574  odel_class = get
+00017b90: 6174 7472 286e 6574 776f 726b 5f70 6163  attr(network_pac
+00017ba0: 6b61 6765 2c20 7365 6c66 2e61 7263 6869  kage, self.archi
+00017bb0: 7465 6374 7572 6529 0a20 2020 2020 2020  tecture).       
+00017bc0: 2061 7267 7320 3d20 6c69 7374 280a 2020   args = list(.  
+00017bd0: 2020 2020 2020 2020 2020 6d6f 6465 6c5f            model_
+00017be0: 636c 6173 732e 5f5f 696e 6974 5f5f 2e5f  class.__init__._
+00017bf0: 5f63 6f64 655f 5f2e 636f 5f76 6172 6e61  _code__.co_varna
+00017c00: 6d65 735b 0a20 2020 2020 2020 2020 2020  mes[.           
+00017c10: 2020 2020 203a 206d 6f64 656c 5f63 6c61       : model_cla
+00017c20: 7373 2e5f 5f69 6e69 745f 5f2e 5f5f 636f  ss.__init__.__co
+00017c30: 6465 5f5f 2e63 6f5f 6172 6763 6f75 6e74  de__.co_argcount
+00017c40: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+00017c50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00017c60: 2061 7267 732e 7265 6d6f 7665 2822 7365   args.remove("se
+00017c70: 6c66 2229 0a20 2020 2020 2020 206b 7761  lf").        kwa
+00017c80: 7267 7320 3d20 6469 6374 2829 0a20 2020  rgs = dict().   
+00017c90: 2020 2020 2066 6f72 2061 7267 2069 6e20       for arg in 
+00017ca0: 6172 6773 3a0a 2020 2020 2020 2020 2020  args:.          
+00017cb0: 2020 6b77 6172 6773 5b61 7267 5d20 3d20    kwargs[arg] = 
+00017cc0: 7365 6c66 2e70 6172 616d 6574 6572 735b  self.parameters[
+00017cd0: 6172 675d 0a20 2020 2020 2020 206b 7761  arg].        kwa
+00017ce0: 7267 735b 2267 7075 225d 203d 2046 616c  rgs["gpu"] = Fal
+00017cf0: 7365 0a0a 2020 2020 2020 2020 6d6f 6465  se..        mode
+00017d00: 6c20 3d20 6d6f 6465 6c5f 636c 6173 7328  l = model_class(
+00017d10: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
+00017d20: 2020 2066 696c 655f 6e61 6d65 203d 2022     file_name = "
+00017d30: 696e 666f 726d 6174 696f 6e2e 6c6f 6722  information.log"
+00017d40: 0a0a 2020 2020 2020 2020 7769 7468 2028  ..        with (
+00017d50: 7365 6c66 2e6d 6170 735f 7061 7468 202f  self.maps_path /
+00017d60: 2066 696c 655f 6e61 6d65 292e 6f70 656e   file_name).open
+00017d70: 286d 6f64 653d 2277 2229 2061 7320 663a  (mode="w") as f:
+00017d80: 0a20 2020 2020 2020 2020 2020 2066 2e77  .            f.w
+00017d90: 7269 7465 2866 222d 2044 6174 6520 3a5c  rite(f"- Date :\
+00017da0: 747b 6461 7465 7469 6d65 2e6e 6f77 2829  t{datetime.now()
+00017db0: 2e73 7472 6674 696d 6528 2725 6420 2562  .strftime('%d %b
+00017dc0: 2025 592c 2025 483a 254d 3a25 5327 297d   %Y, %H:%M:%S')}
+00017dd0: 5c6e 5c6e 2229 0a20 2020 2020 2020 2020  \n\n").         
+00017de0: 2020 2066 2e77 7269 7465 2866 222d 2050     f.write(f"- P
+00017df0: 6174 6820 3a5c 747b 7365 6c66 2e6d 6170  ath :\t{self.map
+00017e00: 735f 7061 7468 7d5c 6e5c 6e22 290a 2020  s_path}\n\n").  
+00017e10: 2020 2020 2020 2020 2020 2320 662e 7772            # f.wr
+00017e20: 6974 6528 222d 204a 6f62 2049 4420 3a5c  ite("- Job ID :\
+00017e30: 747b 7d5c 6e22 2e66 6f72 6d61 7428 6f73  t{}\n".format(os
+00017e40: 2e67 6574 656e 7628 2753 4c55 524d 5f4a  .getenv('SLURM_J
+00017e50: 4f42 4944 2729 2929 0a20 2020 2020 2020  OBID'))).       
+00017e60: 2020 2020 2066 2e77 7269 7465 2866 222d       f.write(f"-
+00017e70: 204d 6f64 656c 203a 5c74 7b6d 6f64 656c   Model :\t{model
+00017e80: 2e6c 6179 6572 737d 5c6e 5c6e 2229 0a0a  .layers}\n\n")..
+00017e90: 2020 2020 2020 2020 6465 6c20 6d6f 6465          del mode
+00017ea0: 6c0a 0a20 2020 2064 6566 205f 6572 6173  l..    def _eras
+00017eb0: 655f 746d 7028 7365 6c66 2c20 7370 6c69  e_tmp(self, spli
+00017ec0: 7429 3a0a 2020 2020 2020 2020 2222 2245  t):.        """E
+00017ed0: 7261 7365 2063 6865 636b 706f 696e 7473  rase checkpoints
+00017ee0: 206f 6620 7468 6520 6d6f 6465 6c20 616e   of the model an
+00017ef0: 6420 6f70 7469 6d69 7a65 7220 6174 2074  d optimizer at t
+00017f00: 6865 2065 6e64 206f 6620 7472 6169 6e69  he end of traini
+00017f10: 6e67 2e22 2222 0a20 2020 2020 2020 2074  ng.""".        t
+00017f20: 6d70 5f70 6174 6820 3d20 7365 6c66 2e6d  mp_path = self.m
+00017f30: 6170 735f 7061 7468 202f 2066 227b 7365  aps_path / f"{se
+00017f40: 6c66 2e73 706c 6974 5f6e 616d 657d 2d7b  lf.split_name}-{
+00017f50: 7370 6c69 747d 2220 2f20 2274 6d70 220a  split}" / "tmp".
+00017f60: 2020 2020 2020 2020 7368 7574 696c 2e72          shutil.r
+00017f70: 6d74 7265 6528 746d 705f 7061 7468 290a  mtree(tmp_path).
+00017f80: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+00017f90: 6f64 0a20 2020 2064 6566 2077 7269 7465  od.    def write
+00017fa0: 5f64 6573 6372 6970 7469 6f6e 5f6c 6f67  _description_log
+00017fb0: 280a 2020 2020 2020 2020 6c6f 675f 6469  (.        log_di
+00017fc0: 723a 2050 6174 682c 0a20 2020 2020 2020  r: Path,.       
+00017fd0: 2064 6174 615f 6772 6f75 702c 0a20 2020   data_group,.   
+00017fe0: 2020 2020 2063 6170 735f 6469 6374 2c0a       caps_dict,.
+00017ff0: 2020 2020 2020 2020 6466 2c0a 2020 2020          df,.    
+00018000: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00018010: 2020 2020 2020 2057 7269 7465 2064 6573         Write des
+00018020: 6372 6970 7469 6f6e 206c 6f67 2066 696c  cription log fil
+00018030: 6520 6173 736f 6369 6174 6564 2074 6f20  e associated to 
+00018040: 6120 6461 7461 2067 726f 7570 2e0a 0a20  a data group... 
+00018050: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00018060: 2020 2020 2020 2020 206c 6f67 5f64 6972           log_dir
+00018070: 2028 7374 7229 3a20 7061 7468 2074 6f20   (str): path to 
+00018080: 7468 6520 6c6f 6720 6669 6c65 2064 6972  the log file dir
+00018090: 6563 746f 7279 2e0a 2020 2020 2020 2020  ectory..        
+000180a0: 2020 2020 6461 7461 5f67 726f 7570 2028      data_group (
+000180b0: 7374 7229 3a20 6e61 6d65 206f 6620 7468  str): name of th
+000180c0: 6520 6461 7461 2067 726f 7570 2075 7365  e data group use
+000180d0: 6420 666f 7220 7468 6520 7461 736b 2e0a  d for the task..
+000180e0: 2020 2020 2020 2020 2020 2020 6361 7073              caps
+000180f0: 5f64 6963 7420 2864 6963 745b 7374 722c  _dict (dict[str,
+00018100: 2073 7472 5d29 3a20 4469 6374 696f 6e61   str]): Dictiona
+00018110: 7279 206f 6620 7468 6520 4341 5053 2066  ry of the CAPS f
+00018120: 6f6c 6465 7273 2075 7365 6420 666f 7220  olders used for 
+00018130: 7468 6520 7461 736b 0a20 2020 2020 2020  the task.       
+00018140: 2020 2020 2064 6620 2870 642e 4461 7461       df (pd.Data
+00018150: 4672 616d 6529 3a20 4461 7461 4672 616d  Frame): DataFram
+00018160: 6520 6f66 2074 6865 206d 6574 612d 6461  e of the meta-da
+00018170: 7461 2075 7365 6420 666f 7220 7468 6520  ta used for the 
+00018180: 7461 736b 2e0a 2020 2020 2020 2020 2222  task..        ""
+00018190: 220a 2020 2020 2020 2020 6c6f 675f 6469  ".        log_di
+000181a0: 722e 6d6b 6469 7228 7061 7265 6e74 733d  r.mkdir(parents=
+000181b0: 5472 7565 2c20 6578 6973 745f 6f6b 3d54  True, exist_ok=T
+000181c0: 7275 6529 0a20 2020 2020 2020 206c 6f67  rue).        log
+000181d0: 5f70 6174 6820 3d20 6c6f 675f 6469 7220  _path = log_dir 
+000181e0: 2f20 2264 6573 6372 6970 7469 6f6e 2e6c  / "description.l
+000181f0: 6f67 220a 2020 2020 2020 2020 7769 7468  og".        with
+00018200: 206c 6f67 5f70 6174 682e 6f70 656e 286d   log_path.open(m
+00018210: 6f64 653d 2277 2229 2061 7320 663a 0a20  ode="w") as f:. 
+00018220: 2020 2020 2020 2020 2020 2066 2e77 7269             f.wri
+00018230: 7465 2866 2250 7265 6469 6374 696f 6e20  te(f"Prediction 
+00018240: 7b64 6174 615f 6772 6f75 707d 2067 726f  {data_group} gro
+00018250: 7570 202d 207b 6461 7465 7469 6d65 2e6e  up - {datetime.n
+00018260: 6f77 2829 7d5c 6e22 290a 2020 2020 2020  ow()}\n").      
+00018270: 2020 2020 2020 662e 7772 6974 6528 6622        f.write(f"
+00018280: 4461 7461 206c 6f61 6465 6420 6672 6f6d  Data loaded from
+00018290: 2043 4150 5320 6469 7265 6374 6f72 6965   CAPS directorie
+000182a0: 733a 207b 6361 7073 5f64 6963 747d 5c6e  s: {caps_dict}\n
+000182b0: 2229 0a20 2020 2020 2020 2020 2020 2066  ").            f
+000182c0: 2e77 7269 7465 2866 224e 756d 6265 7220  .write(f"Number 
+000182d0: 6f66 2070 6172 7469 6369 7061 6e74 733a  of participants:
+000182e0: 207b 6466 2e70 6172 7469 6369 7061 6e74   {df.participant
+000182f0: 5f69 642e 6e75 6e69 7175 6528 297d 5c6e  _id.nunique()}\n
+00018300: 2229 0a20 2020 2020 2020 2020 2020 2066  ").            f
+00018310: 2e77 7269 7465 2866 224e 756d 6265 7220  .write(f"Number 
+00018320: 6f66 2073 6573 7369 6f6e 733a 207b 6c65  of sessions: {le
+00018330: 6e28 6466 297d 5c6e 2229 0a0a 2020 2020  n(df)}\n")..    
+00018340: 6465 6620 5f6d 6f64 655f 6c65 7665 6c5f  def _mode_level_
+00018350: 746f 5f74 7376 280a 2020 2020 2020 2020  to_tsv(.        
+00018360: 7365 6c66 2c0a 2020 2020 2020 2020 7265  self,.        re
+00018370: 7375 6c74 735f 6466 3a20 7064 2e44 6174  sults_df: pd.Dat
+00018380: 6146 7261 6d65 2c0a 2020 2020 2020 2020  aFrame,.        
+00018390: 6d65 7472 6963 733a 2055 6e69 6f6e 5b44  metrics: Union[D
+000183a0: 6963 742c 2070 642e 4461 7461 4672 616d  ict, pd.DataFram
+000183b0: 655d 2c0a 2020 2020 2020 2020 7370 6c69  e],.        spli
+000183c0: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
+000183d0: 7365 6c65 6374 696f 6e3a 2073 7472 2c0a  selection: str,.
+000183e0: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
+000183f0: 7570 3a20 7374 7220 3d20 2274 7261 696e  up: str = "train
+00018400: 222c 0a20 2020 2029 3a0a 2020 2020 2020  ",.    ):.      
+00018410: 2020 2222 220a 2020 2020 2020 2020 5772    """.        Wr
+00018420: 6974 6573 2074 6865 206f 7574 7075 7473  ites the outputs
+00018430: 206f 6620 7468 6520 7465 7374 2066 756e   of the test fun
+00018440: 6374 696f 6e20 696e 2074 7376 2066 696c  ction in tsv fil
+00018450: 6573 2e0a 0a20 2020 2020 2020 2041 7267  es...        Arg
+00018460: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00018470: 6573 756c 7473 5f64 663a 2074 6865 2069  esults_df: the i
+00018480: 6e64 6976 6964 7561 6c20 7265 7375 6c74  ndividual result
+00018490: 7320 7065 7220 7061 7463 682e 0a20 2020  s per patch..   
+000184a0: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+000184b0: 3a20 7468 6520 7065 7266 6f72 6d61 6e63  : the performanc
+000184c0: 6573 206f 6274 6169 6e65 6420 6f6e 2061  es obtained on a
+000184d0: 2073 6572 6965 7320 6f66 206d 6574 7269   series of metri
+000184e0: 6373 2e0a 2020 2020 2020 2020 2020 2020  cs..            
+000184f0: 7370 6c69 743a 2074 6865 2073 706c 6974  split: the split
+00018500: 2066 6f72 2077 6869 6368 2074 6865 2070   for which the p
+00018510: 6572 666f 726d 616e 6365 7320 7765 7265  erformances were
+00018520: 206f 6274 6169 6e65 642e 0a20 2020 2020   obtained..     
+00018530: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+00018540: 3a20 7468 6520 6d65 7472 6963 7320 6f6e  : the metrics on
+00018550: 2077 6869 6368 2074 6865 206d 6f64 656c   which the model
+00018560: 2077 6173 2073 656c 6563 7465 6420 2842   was selected (B
+00018570: 412c 206c 6f73 732e 2e2e 290a 2020 2020  A, loss...).    
+00018580: 2020 2020 2020 2020 6461 7461 5f67 726f          data_gro
+00018590: 7570 3a20 7468 6520 6e61 6d65 2072 6566  up: the name ref
+000185a0: 6572 7269 6e67 2074 6f20 7468 6520 6461  erring to the da
+000185b0: 7461 2067 726f 7570 206f 6e20 7768 6963  ta group on whic
+000185c0: 6820 6576 616c 7561 7469 6f6e 2069 7320  h evaluation is 
+000185d0: 7065 7266 6f72 6d65 642e 0a20 2020 2020  performed..     
+000185e0: 2020 2022 2222 0a20 2020 2020 2020 2070     """.        p
+000185f0: 6572 666f 726d 616e 6365 5f64 6972 203d  erformance_dir =
+00018600: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
+00018610: 656c 662e 6d61 7073 5f70 6174 680a 2020  elf.maps_path.  
+00018620: 2020 2020 2020 2020 2020 2f20 6622 7b73            / f"{s
+00018630: 656c 662e 7370 6c69 745f 6e61 6d65 7d2d  elf.split_name}-
+00018640: 7b73 706c 6974 7d22 0a20 2020 2020 2020  {split}".       
+00018650: 2020 2020 202f 2066 2262 6573 742d 7b73       / f"best-{s
+00018660: 656c 6563 7469 6f6e 7d22 0a20 2020 2020  election}".     
+00018670: 2020 2020 2020 202f 2064 6174 615f 6772         / data_gr
+00018680: 6f75 700a 2020 2020 2020 2020 290a 2020  oup.        ).  
+00018690: 2020 2020 2020 7065 7266 6f72 6d61 6e63        performanc
+000186a0: 655f 6469 722e 6d6b 6469 7228 7061 7265  e_dir.mkdir(pare
+000186b0: 6e74 733d 5472 7565 2c20 6578 6973 745f  nts=True, exist_
+000186c0: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
+000186d0: 2070 6572 666f 726d 616e 6365 5f70 6174   performance_pat
+000186e0: 6820 3d20 280a 2020 2020 2020 2020 2020  h = (.          
+000186f0: 2020 7065 7266 6f72 6d61 6e63 655f 6469    performance_di
+00018700: 7220 2f20 6622 7b64 6174 615f 6772 6f75  r / f"{data_grou
+00018710: 707d 5f7b 7365 6c66 2e6d 6f64 657d 5f6c  p}_{self.mode}_l
+00018720: 6576 656c 5f70 7265 6469 6374 696f 6e2e  evel_prediction.
+00018730: 7473 7622 0a20 2020 2020 2020 2029 0a20  tsv".        ). 
+00018740: 2020 2020 2020 2069 6620 6e6f 7420 7065         if not pe
+00018750: 7266 6f72 6d61 6e63 655f 7061 7468 2e69  rformance_path.i
+00018760: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
+00018770: 2020 2020 2020 7265 7375 6c74 735f 6466        results_df
+00018780: 2e74 6f5f 6373 7628 7065 7266 6f72 6d61  .to_csv(performa
+00018790: 6e63 655f 7061 7468 2c20 696e 6465 783d  nce_path, index=
+000187a0: 4661 6c73 652c 2073 6570 3d22 5c74 2229  False, sep="\t")
+000187b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000187c0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000187d0: 7473 5f64 662e 746f 5f63 7376 280a 2020  ts_df.to_csv(.  
+000187e0: 2020 2020 2020 2020 2020 2020 2020 7065                pe
+000187f0: 7266 6f72 6d61 6e63 655f 7061 7468 2c20  rformance_path, 
+00018800: 696e 6465 783d 4661 6c73 652c 2073 6570  index=False, sep
+00018810: 3d22 5c74 222c 206d 6f64 653d 2261 222c  ="\t", mode="a",
+00018820: 2068 6561 6465 723d 4661 6c73 650a 2020   header=False.  
+00018830: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00018840: 2020 2020 206d 6574 7269 6373 5f70 6174       metrics_pat
+00018850: 6820 3d20 7065 7266 6f72 6d61 6e63 655f  h = performance_
+00018860: 6469 7220 2f20 6622 7b64 6174 615f 6772  dir / f"{data_gr
+00018870: 6f75 707d 5f7b 7365 6c66 2e6d 6f64 657d  oup}_{self.mode}
+00018880: 5f6c 6576 656c 5f6d 6574 7269 6373 2e74  _level_metrics.t
+00018890: 7376 220a 2020 2020 2020 2020 6966 206d  sv".        if m
+000188a0: 6574 7269 6373 2069 7320 6e6f 7420 4e6f  etrics is not No
+000188b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000188c0: 2320 6966 2064 6174 615f 6772 6f75 7020  # if data_group 
+000188d0: 3d3d 2022 7472 6169 6e22 206f 7220 6461  == "train" or da
+000188e0: 7461 5f67 726f 7570 203d 3d20 2276 616c  ta_group == "val
+000188f0: 6964 6174 696f 6e22 3a0a 2020 2020 2020  idation":.      
+00018900: 2020 2020 2020 2320 2020 2020 7064 5f6d        #     pd_m
+00018910: 6574 7269 6373 203d 2070 642e 4461 7461  etrics = pd.Data
+00018920: 4672 616d 6528 6d65 7472 6963 732c 2069  Frame(metrics, i
+00018930: 6e64 6578 203d 205b 305d 290a 2020 2020  ndex = [0]).    
+00018940: 2020 2020 2020 2020 2320 2020 2020 6865          #     he
+00018950: 6164 6572 203d 2054 7275 650a 2020 2020  ader = True.    
+00018960: 2020 2020 2020 2020 2320 656c 7365 3a0a          # else:.
+00018970: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00018980: 2020 7064 5f6d 6574 7269 6373 203d 2070    pd_metrics = p
+00018990: 642e 4461 7461 4672 616d 6528 6d65 7472  d.DataFrame(metr
+000189a0: 6963 7329 2e54 0a20 2020 2020 2020 2020  ics).T.         
+000189b0: 2020 2023 2020 2020 2068 6561 6465 7220     #     header 
+000189c0: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+000189d0: 2020 2020 2070 645f 6d65 7472 6963 7320       pd_metrics 
+000189e0: 3d20 7064 2e44 6174 6146 7261 6d65 286d  = pd.DataFrame(m
+000189f0: 6574 7269 6373 292e 540a 2020 2020 2020  etrics).T.      
+00018a00: 2020 2020 2020 6865 6164 6572 203d 2046        header = F
+00018a10: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00018a20: 2023 2069 6d70 6f72 7420 6970 6462 3b20   # import ipdb; 
+00018a30: 6970 6462 2e73 6574 5f74 7261 6365 2829  ipdb.set_trace()
+00018a40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018a50: 6e6f 7420 6d65 7472 6963 735f 7061 7468  not metrics_path
+00018a60: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
+00018a70: 2020 2020 2020 2020 2020 2020 7064 5f6d              pd_m
+00018a80: 6574 7269 6373 2e74 6f5f 6373 7628 6d65  etrics.to_csv(me
+00018a90: 7472 6963 735f 7061 7468 2c20 696e 6465  trics_path, inde
+00018aa0: 783d 4661 6c73 652c 2073 6570 3d22 5c74  x=False, sep="\t
+00018ab0: 222c 2068 6561 6465 723d 6865 6164 6572  ", header=header
+00018ac0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00018ad0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00018ae0: 2020 2020 7064 5f6d 6574 7269 6373 2e74      pd_metrics.t
+00018af0: 6f5f 6373 7628 0a20 2020 2020 2020 2020  o_csv(.         
+00018b00: 2020 2020 2020 2020 2020 206d 6574 7269             metri
+00018b10: 6373 5f70 6174 682c 2069 6e64 6578 3d46  cs_path, index=F
+00018b20: 616c 7365 2c20 7365 703d 225c 7422 2c20  alse, sep="\t", 
+00018b30: 6d6f 6465 3d22 6122 2c20 6865 6164 6572  mode="a", header
+00018b40: 3d68 6561 6465 720a 2020 2020 2020 2020  =header.        
+00018b50: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00018b60: 6566 205f 656e 7365 6d62 6c65 5f74 6f5f  ef _ensemble_to_
+00018b70: 7473 7628 0a20 2020 2020 2020 2073 656c  tsv(.        sel
+00018b80: 662c 0a20 2020 2020 2020 2073 706c 6974  f,.        split
+00018b90: 3a20 696e 742c 0a20 2020 2020 2020 2073  : int,.        s
+00018ba0: 656c 6563 7469 6f6e 3a20 7374 722c 0a20  election: str,. 
+00018bb0: 2020 2020 2020 2064 6174 615f 6772 6f75         data_grou
+00018bc0: 703a 2073 7472 203d 2022 7465 7374 222c  p: str = "test",
+00018bd0: 0a20 2020 2020 2020 2075 7365 5f6c 6162  .        use_lab
+00018be0: 656c 733a 2062 6f6f 6c20 3d20 5472 7565  els: bool = True
+00018bf0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+00018c00: 2022 2222 0a20 2020 2020 2020 2057 7269   """.        Wri
+00018c10: 7465 7320 696d 6167 652d 6c65 7665 6c20  tes image-level 
+00018c20: 7065 7266 6f72 6d61 6e63 6520 6669 6c65  performance file
+00018c30: 7320 6672 6f6d 206d 6f64 6520 6c65 7665  s from mode leve
+00018c40: 6c20 7065 7266 6f72 6d61 6e63 6573 2e0a  l performances..
+00018c50: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+00018c60: 2020 2020 2020 2020 2020 2073 706c 6974             split
+00018c70: 3a20 7370 6c69 7420 6e75 6d62 6572 206f  : split number o
+00018c80: 6620 7468 6520 6372 6f73 732d 7661 6c69  f the cross-vali
+00018c90: 6461 7469 6f6e 2e0a 2020 2020 2020 2020  dation..        
+00018ca0: 2020 2020 7365 6c65 6374 696f 6e3a 206d      selection: m
+00018cb0: 6574 7269 6320 6f6e 2077 6869 6368 2074  etric on which t
+00018cc0: 6865 206d 6f64 656c 2069 7320 7365 6c65  he model is sele
+00018cd0: 6374 6564 2028 666f 7220 6578 616d 706c  cted (for exampl
+00018ce0: 6520 6c6f 7373 206f 7220 4241 292e 0a20  e loss or BA).. 
+00018cf0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00018d00: 6772 6f75 703a 2074 6865 206e 616d 6520  group: the name 
+00018d10: 7265 6665 7272 696e 6720 746f 2074 6865  referring to the
+00018d20: 2064 6174 6120 6772 6f75 7020 6f6e 2077   data group on w
+00018d30: 6869 6368 2065 7661 6c75 6174 696f 6e20  hich evaluation 
+00018d40: 6973 2070 6572 666f 726d 6564 2e0a 2020  is performed..  
+00018d50: 2020 2020 2020 2020 2020 2020 2020 4966                If
+00018d60: 2064 6966 6665 7265 6e74 2066 726f 6d20   different from 
+00018d70: 7472 6169 6e69 6e67 206f 7220 7661 6c69  training or vali
+00018d80: 6461 7469 6f6e 2c20 7468 6520 7765 6967  dation, the weig
+00018d90: 6874 7320 6f66 2073 6f66 7420 766f 7469  hts of soft voti
+00018da0: 6e67 2077 696c 6c20 6265 2063 6f6d 7075  ng will be compu
+00018db0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+00018dc0: 2020 2020 6f6e 2076 616c 6964 6174 696f      on validatio
+00018dd0: 6e20 6163 6375 7261 6369 6573 2e0a 2020  n accuracies..  
+00018de0: 2020 2020 2020 2020 2020 7573 655f 6c61            use_la
+00018df0: 6265 6c73 3a20 4966 2054 7275 6520 7468  bels: If True th
+00018e00: 6520 6c61 6265 6c73 2061 7265 2061 6464  e labels are add
+00018e10: 6564 2074 6f20 7468 6520 6669 6e61 6c20  ed to the final 
+00018e20: 7473 760a 2020 2020 2020 2020 2222 220a  tsv.        """.
+00018e30: 2020 2020 2020 2020 2320 4368 6f6f 7365          # Choose
+00018e40: 2077 6869 6368 2064 6174 6173 6574 2069   which dataset i
+00018e50: 7320 7573 6564 2074 6f20 636f 6d70 7574  s used to comput
+00018e60: 6520 7468 6520 7765 6967 6874 7320 6f66  e the weights of
+00018e70: 2073 6f66 7420 766f 7469 6e67 2e0a 2020   soft voting..  
+00018e80: 2020 2020 2020 6966 2064 6174 615f 6772        if data_gr
+00018e90: 6f75 7020 696e 205b 2274 7261 696e 222c  oup in ["train",
+00018ea0: 2022 7661 6c69 6461 7469 6f6e 225d 3a0a   "validation"]:.
+00018eb0: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+00018ec0: 6461 7469 6f6e 5f64 6174 6173 6574 203d  dation_dataset =
+00018ed0: 2064 6174 615f 6772 6f75 700a 2020 2020   data_group.    
+00018ee0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018ef0: 2020 2020 2020 7661 6c69 6461 7469 6f6e        validation
+00018f00: 5f64 6174 6173 6574 203d 2022 7661 6c69  _dataset = "vali
+00018f10: 6461 7469 6f6e 220a 2020 2020 2020 2020  dation".        
+00018f20: 7465 7374 5f64 6620 3d20 7365 6c66 2e67  test_df = self.g
+00018f30: 6574 5f70 7265 6469 6374 696f 6e28 0a20  et_prediction(. 
+00018f40: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00018f50: 6772 6f75 702c 2073 706c 6974 2c20 7365  group, split, se
+00018f60: 6c65 6374 696f 6e2c 2073 656c 662e 6d6f  lection, self.mo
+00018f70: 6465 2c20 7665 7262 6f73 653d 4661 6c73  de, verbose=Fals
+00018f80: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
+00018f90: 2020 2020 7661 6c69 6461 7469 6f6e 5f64      validation_d
+00018fa0: 6620 3d20 7365 6c66 2e67 6574 5f70 7265  f = self.get_pre
+00018fb0: 6469 6374 696f 6e28 0a20 2020 2020 2020  diction(.       
+00018fc0: 2020 2020 2076 616c 6964 6174 696f 6e5f       validation_
+00018fd0: 6461 7461 7365 742c 2073 706c 6974 2c20  dataset, split, 
+00018fe0: 7365 6c65 6374 696f 6e2c 2073 656c 662e  selection, self.
+00018ff0: 6d6f 6465 2c20 7665 7262 6f73 653d 4661  mode, verbose=Fa
+00019000: 6c73 650a 2020 2020 2020 2020 290a 0a20  lse.        ).. 
+00019010: 2020 2020 2020 2070 6572 666f 726d 616e         performan
+00019020: 6365 5f64 6972 203d 2028 0a20 2020 2020  ce_dir = (.     
+00019030: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
+00019040: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
+00019050: 2020 2f20 6622 7b73 656c 662e 7370 6c69    / f"{self.spli
+00019060: 745f 6e61 6d65 7d2d 7b73 706c 6974 7d22  t_name}-{split}"
+00019070: 0a20 2020 2020 2020 2020 2020 202f 2066  .            / f
+00019080: 2262 6573 742d 7b73 656c 6563 7469 6f6e  "best-{selection
+00019090: 7d22 0a20 2020 2020 2020 2020 2020 202f  }".            /
+000190a0: 2064 6174 615f 6772 6f75 700a 2020 2020   data_group.    
+000190b0: 2020 2020 290a 0a20 2020 2020 2020 2070      )..        p
+000190c0: 6572 666f 726d 616e 6365 5f64 6972 2e6d  erformance_dir.m
+000190d0: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
+000190e0: 652c 2065 7869 7374 5f6f 6b3d 5472 7565  e, exist_ok=True
+000190f0: 290a 0a20 2020 2020 2020 2064 665f 6669  )..        df_fi
+00019100: 6e61 6c2c 206d 6574 7269 6373 203d 2073  nal, metrics = s
+00019110: 656c 662e 7461 736b 5f6d 616e 6167 6572  elf.task_manager
+00019120: 2e65 6e73 656d 626c 655f 7072 6564 6963  .ensemble_predic
+00019130: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00019140: 2020 7465 7374 5f64 662c 0a20 2020 2020    test_df,.     
+00019150: 2020 2020 2020 2076 616c 6964 6174 696f         validatio
+00019160: 6e5f 6466 2c0a 2020 2020 2020 2020 2020  n_df,.          
+00019170: 2020 7365 6c65 6374 696f 6e5f 7468 7265    selection_thre
+00019180: 7368 6f6c 643d 7365 6c66 2e73 656c 6563  shold=self.selec
+00019190: 7469 6f6e 5f74 6872 6573 686f 6c64 2c0a  tion_threshold,.
+000191a0: 2020 2020 2020 2020 2020 2020 7573 655f              use_
+000191b0: 6c61 6265 6c73 3d75 7365 5f6c 6162 656c  labels=use_label
+000191c0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+000191d0: 2020 2020 2020 6966 2064 665f 6669 6e61        if df_fina
+000191e0: 6c20 6973 206e 6f74 204e 6f6e 653a 0a20  l is not None:. 
+000191f0: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
+00019200: 6e61 6c2e 746f 5f63 7376 280a 2020 2020  nal.to_csv(.    
+00019210: 2020 2020 2020 2020 2020 2020 7065 7266              perf
+00019220: 6f72 6d61 6e63 655f 6469 7220 2f20 6622  ormance_dir / f"
+00019230: 7b64 6174 615f 6772 6f75 707d 5f69 6d61  {data_group}_ima
+00019240: 6765 5f6c 6576 656c 5f70 7265 6469 6374  ge_level_predict
+00019250: 696f 6e2e 7473 7622 2c0a 2020 2020 2020  ion.tsv",.      
+00019260: 2020 2020 2020 2020 2020 696e 6465 783d            index=
+00019270: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00019280: 2020 2020 2020 2073 6570 3d22 5c74 222c         sep="\t",
+00019290: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000192a0: 2020 2020 2020 2069 6620 6d65 7472 6963         if metric
+000192b0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+000192c0: 2020 2020 2020 2020 2020 2070 642e 4461             pd.Da
+000192d0: 7461 4672 616d 6528 6d65 7472 6963 732c  taFrame(metrics,
+000192e0: 2069 6e64 6578 3d5b 305d 292e 746f 5f63   index=[0]).to_c
+000192f0: 7376 280a 2020 2020 2020 2020 2020 2020  sv(.            
+00019300: 2020 2020 7065 7266 6f72 6d61 6e63 655f      performance_
+00019310: 6469 7220 2f20 6622 7b64 6174 615f 6772  dir / f"{data_gr
+00019320: 6f75 707d 5f69 6d61 6765 5f6c 6576 656c  oup}_image_level
+00019330: 5f6d 6574 7269 6373 2e74 7376 222c 0a20  _metrics.tsv",. 
+00019340: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019350: 6e64 6578 3d46 616c 7365 2c0a 2020 2020  ndex=False,.    
+00019360: 2020 2020 2020 2020 2020 2020 7365 703d              sep=
+00019370: 225c 7422 2c0a 2020 2020 2020 2020 2020  "\t",.          
+00019380: 2020 290a 0a20 2020 2064 6566 205f 6d6f    )..    def _mo
+00019390: 6465 5f74 6f5f 696d 6167 655f 7473 7628  de_to_image_tsv(
+000193a0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000193b0: 2020 2020 2020 2073 706c 6974 3a20 696e         split: in
+000193c0: 742c 0a20 2020 2020 2020 2073 656c 6563  t,.        selec
+000193d0: 7469 6f6e 3a20 7374 722c 0a20 2020 2020  tion: str,.     
+000193e0: 2020 2064 6174 615f 6772 6f75 703a 2073     data_group: s
+000193f0: 7472 203d 2022 7465 7374 222c 0a20 2020  tr = "test",.   
+00019400: 2020 2020 2075 7365 5f6c 6162 656c 733a       use_labels:
+00019410: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+00019420: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00019430: 0a20 2020 2020 2020 2043 6f70 7920 6d6f  .        Copy mo
+00019440: 6465 2d6c 6576 656c 2054 5356 2066 696c  de-level TSV fil
+00019450: 6573 2074 6f20 6e61 6d65 2074 6865 6d20  es to name them 
+00019460: 6173 2069 6d61 6765 2d6c 6576 656c 2054  as image-level T
+00019470: 5356 2066 696c 6573 0a0a 2020 2020 2020  SV files..      
+00019480: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00019490: 2020 2020 7370 6c69 743a 2073 706c 6974      split: split
+000194a0: 206e 756d 6265 7220 6f66 2074 6865 2063   number of the c
+000194b0: 726f 7373 2d76 616c 6964 6174 696f 6e2e  ross-validation.
+000194c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000194d0: 6563 7469 6f6e 3a20 6d65 7472 6963 206f  ection: metric o
+000194e0: 6e20 7768 6963 6820 7468 6520 6d6f 6465  n which the mode
+000194f0: 6c20 6973 2073 656c 6563 7465 6420 2866  l is selected (f
+00019500: 6f72 2065 7861 6d70 6c65 206c 6f73 7320  or example loss 
+00019510: 6f72 2042 4129 0a20 2020 2020 2020 2020  or BA).         
+00019520: 2020 2064 6174 615f 6772 6f75 703a 2074     data_group: t
+00019530: 6865 206e 616d 6520 7265 6665 7272 696e  he name referrin
+00019540: 6720 746f 2074 6865 2064 6174 6120 6772  g to the data gr
+00019550: 6f75 7020 6f6e 2077 6869 6368 2065 7661  oup on which eva
+00019560: 6c75 6174 696f 6e20 6973 2070 6572 666f  luation is perfo
+00019570: 726d 6564 2e0a 2020 2020 2020 2020 2020  rmed..          
+00019580: 2020 7573 655f 6c61 6265 6c73 3a20 4966    use_labels: If
+00019590: 2054 7275 6520 7468 6520 6c61 6265 6c73   True the labels
+000195a0: 2061 7265 2061 6464 6564 2074 6f20 7468   are added to th
+000195b0: 6520 6669 6e61 6c20 7473 760a 0a20 2020  e final tsv..   
+000195c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000195d0: 2073 7562 5f64 6620 3d20 7365 6c66 2e67   sub_df = self.g
+000195e0: 6574 5f70 7265 6469 6374 696f 6e28 0a20  et_prediction(. 
+000195f0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00019600: 6772 6f75 702c 2073 706c 6974 2c20 7365  group, split, se
+00019610: 6c65 6374 696f 6e2c 2073 656c 662e 6d6f  lection, self.mo
+00019620: 6465 2c20 7665 7262 6f73 653d 4661 6c73  de, verbose=Fals
+00019630: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
+00019640: 2020 2020 7375 625f 6466 2e72 656e 616d      sub_df.renam
+00019650: 6528 636f 6c75 6d6e 733d 7b66 227b 7365  e(columns={f"{se
+00019660: 6c66 2e6d 6f64 657d 5f69 6422 3a20 2269  lf.mode}_id": "i
+00019670: 6d61 6765 5f69 6422 7d2c 2069 6e70 6c61  mage_id"}, inpla
+00019680: 6365 3d54 7275 6529 0a0a 2020 2020 2020  ce=True)..      
+00019690: 2020 7065 7266 6f72 6d61 6e63 655f 6469    performance_di
+000196a0: 7220 3d20 280a 2020 2020 2020 2020 2020  r = (.          
+000196b0: 2020 7365 6c66 2e6d 6170 735f 7061 7468    self.maps_path
+000196c0: 0a20 2020 2020 2020 2020 2020 202f 2066  .            / f
+000196d0: 227b 7365 6c66 2e73 706c 6974 5f6e 616d  "{self.split_nam
+000196e0: 657d 2d7b 7370 6c69 747d 220a 2020 2020  e}-{split}".    
+000196f0: 2020 2020 2020 2020 2f20 6622 6265 7374          / f"best
+00019700: 2d7b 7365 6c65 6374 696f 6e7d 220a 2020  -{selection}".  
+00019710: 2020 2020 2020 2020 2020 2f20 6461 7461            / data
+00019720: 5f67 726f 7570 0a20 2020 2020 2020 2029  _group.        )
+00019730: 0a20 2020 2020 2020 2073 7562 5f64 662e  .        sub_df.
+00019740: 746f 5f63 7376 280a 2020 2020 2020 2020  to_csv(.        
+00019750: 2020 2020 7065 7266 6f72 6d61 6e63 655f      performance_
+00019760: 6469 7220 2f20 6622 7b64 6174 615f 6772  dir / f"{data_gr
+00019770: 6f75 707d 5f69 6d61 6765 5f6c 6576 656c  oup}_image_level
+00019780: 5f70 7265 6469 6374 696f 6e2e 7473 7622  _prediction.tsv"
+00019790: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+000197a0: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
+000197b0: 2020 2020 2020 2073 6570 3d22 5c74 222c         sep="\t",
+000197c0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000197d0: 2020 2069 6620 7573 655f 6c61 6265 6c73     if use_labels
+000197e0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
+000197f0: 7472 6963 735f 6466 203d 2070 642e 7265  trics_df = pd.re
+00019800: 6164 5f63 7376 280a 2020 2020 2020 2020  ad_csv(.        
+00019810: 2020 2020 2020 2020 7065 7266 6f72 6d61          performa
+00019820: 6e63 655f 6469 7220 2f20 6622 7b64 6174  nce_dir / f"{dat
+00019830: 615f 6772 6f75 707d 5f7b 7365 6c66 2e6d  a_group}_{self.m
+00019840: 6f64 657d 5f6c 6576 656c 5f6d 6574 7269  ode}_level_metri
+00019850: 6373 2e74 7376 222c 0a20 2020 2020 2020  cs.tsv",.       
+00019860: 2020 2020 2020 2020 2073 6570 3d22 5c74           sep="\t
+00019870: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+00019880: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00019890: 6622 7b73 656c 662e 6d6f 6465 7d5f 6964  f"{self.mode}_id
+000198a0: 2220 696e 206d 6574 7269 6373 5f64 663a  " in metrics_df:
+000198b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000198c0: 2064 656c 206d 6574 7269 6373 5f64 665b   del metrics_df[
+000198d0: 6622 7b73 656c 662e 6d6f 6465 7d5f 6964  f"{self.mode}_id
+000198e0: 225d 0a20 2020 2020 2020 2020 2020 206d  "].            m
+000198f0: 6574 7269 6373 5f64 662e 746f 5f63 7376  etrics_df.to_csv
+00019900: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00019910: 2020 2870 6572 666f 726d 616e 6365 5f64    (performance_d
+00019920: 6972 202f 2066 227b 6461 7461 5f67 726f  ir / f"{data_gro
+00019930: 7570 7d5f 696d 6167 655f 6c65 7665 6c5f  up}_image_level_
+00019940: 6d65 7472 6963 732e 7473 7622 292c 0a20  metrics.tsv"),. 
+00019950: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019960: 6e64 6578 3d46 616c 7365 2c0a 2020 2020  ndex=False,.    
+00019970: 2020 2020 2020 2020 2020 2020 7365 703d              sep=
+00019980: 225c 7422 2c0a 2020 2020 2020 2020 2020  "\t",.          
+00019990: 2020 290a 0a20 2020 2023 2323 2323 2323    )..    #######
+000199a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000199b0: 2323 2323 2323 2323 0a20 2020 2023 204f  ########.    # O
+000199c0: 626a 6563 7473 2069 6e69 7469 616c 697a  bjects initializ
+000199d0: 6174 696f 6e20 2020 2020 2023 0a20 2020  ation      #.   
+000199e0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+000199f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019a00: 0a20 2020 2064 6566 205f 696e 6974 5f6d  .    def _init_m
+00019a10: 6f64 656c 280a 2020 2020 2020 2020 7365  odel(.        se
+00019a20: 6c66 2c0a 2020 2020 2020 2020 7472 616e  lf,.        tran
+00019a30: 7366 6572 5f70 6174 683a 2050 6174 6820  sfer_path: Path 
+00019a40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00019a50: 7472 616e 7366 6572 5f73 656c 6563 7469  transfer_selecti
+00019a60: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
+00019a70: 206e 625f 756e 6672 6f7a 656e 5f6c 6179   nb_unfrozen_lay
+00019a80: 6572 3d30 2c0a 2020 2020 2020 2020 7370  er=0,.        sp
+00019a90: 6c69 743d 4e6f 6e65 2c0a 2020 2020 2020  lit=None,.      
+00019aa0: 2020 7265 7375 6d65 3d46 616c 7365 2c0a    resume=False,.
+00019ab0: 2020 2020 2020 2020 6770 753d 4e6f 6e65          gpu=None
+00019ac0: 2c0a 2020 2020 2020 2020 6e65 7477 6f72  ,.        networ
+00019ad0: 6b3d 4e6f 6e65 2c0a 2020 2020 293a 0a20  k=None,.    ):. 
+00019ae0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00019af0: 2020 2049 6e73 7461 6e74 6961 7465 2074     Instantiate t
+00019b00: 6865 206d 6f64 656c 0a0a 2020 2020 2020  he model..      
+00019b10: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00019b20: 2020 2020 7472 616e 7366 6572 5f70 6174      transfer_pat
+00019b30: 6820 2873 7472 293a 2070 6174 6820 746f  h (str): path to
+00019b40: 2061 204d 4150 5320 696e 2077 6869 6368   a MAPS in which
+00019b50: 2061 206d 6f64 656c 2773 2077 6569 6768   a model's weigh
+00019b60: 7473 2061 7265 2075 7365 6420 666f 7220  ts are used for 
+00019b70: 7472 616e 7366 6572 206c 6561 726e 696e  transfer learnin
+00019b80: 672e 0a20 2020 2020 2020 2020 2020 2074  g..            t
+00019b90: 7261 6e73 6665 725f 7365 6c65 6374 696f  ransfer_selectio
+00019ba0: 6e20 2873 7472 293a 206e 616d 6520 6f66  n (str): name of
+00019bb0: 2074 6865 206d 6574 7269 6320 7573 6564   the metric used
+00019bc0: 2074 6f20 6669 6e64 2074 6865 2073 6f75   to find the sou
+00019bd0: 7263 6520 6d6f 6465 6c2e 0a20 2020 2020  rce model..     
+00019be0: 2020 2020 2020 2073 706c 6974 2028 696e         split (in
+00019bf0: 7429 3a20 496e 6465 7820 6f66 2074 6865  t): Index of the
+00019c00: 2073 706c 6974 2028 6f6e 6c79 2075 7365   split (only use
+00019c10: 6420 6966 2074 7261 6e73 6665 725f 7061  d if transfer_pa
+00019c20: 7468 2069 7320 6e6f 7420 4e6f 6e65 206f  th is not None o
+00019c30: 6620 6e6f 7420 7265 7375 6d65 292e 0a20  f not resume).. 
+00019c40: 2020 2020 2020 2020 2020 2072 6573 756d             resum
+00019c50: 6520 2862 6f6f 6c29 3a20 4966 2054 7275  e (bool): If Tru
+00019c60: 6520 696e 6974 6961 6c69 7a65 2074 6865  e initialize the
+00019c70: 206e 6574 776f 726b 2077 6974 6820 7468   network with th
+00019c80: 6520 6368 6563 6b70 6f69 6e74 2077 6569  e checkpoint wei
+00019c90: 6768 7473 2e0a 2020 2020 2020 2020 2020  ghts..          
+00019ca0: 2020 6770 7520 2862 6f6f 6c29 3a20 4966    gpu (bool): If
+00019cb0: 2067 6976 656e 2c20 6120 6e65 7720 7661   given, a new va
+00019cc0: 6c75 6520 666f 7220 7468 6520 6465 7669  lue for the devi
+00019cd0: 6365 206f 6620 7468 6520 6d6f 6465 6c20  ce of the model 
+00019ce0: 7769 6c6c 2062 6520 636f 6d70 7574 6564  will be computed
+00019cf0: 2e0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
+00019d00: 7477 6f72 6b20 2869 6e74 293a 2049 6e64  twork (int): Ind
+00019d10: 6578 206f 6620 7468 6520 6e65 7477 6f72  ex of the networ
+00019d20: 6b20 7472 6169 6e65 6420 2875 7365 6420  k trained (used 
+00019d30: 696e 206d 756c 7469 2d6e 6574 776f 726b  in multi-network
+00019d40: 2073 6574 7469 6e67 206f 6e6c 7929 2e0a   setting only)..
+00019d50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00019d60: 2020 2020 696d 706f 7274 2063 6c69 6e69      import clini
+00019d70: 6361 646c 2e75 7469 6c73 2e6e 6574 776f  cadl.utils.netwo
+00019d80: 726b 2061 7320 6e65 7477 6f72 6b5f 7061  rk as network_pa
+00019d90: 636b 6167 650a 0a20 2020 2020 2020 206c  ckage..        l
+00019da0: 6f67 6765 722e 6465 6275 6728 6622 496e  ogger.debug(f"In
+00019db0: 6974 6961 6c69 7a61 7469 6f6e 206f 6620  itialization of 
+00019dc0: 6d6f 6465 6c20 7b73 656c 662e 6172 6368  model {self.arch
+00019dd0: 6974 6563 7475 7265 7d22 290a 2020 2020  itecture}").    
+00019de0: 2020 2020 2320 6f72 2063 686f 6f73 6520      # or choose 
+00019df0: 746f 2069 6d70 6c65 6d65 6e74 2061 2064  to implement a d
+00019e00: 6963 7469 6f6e 6172 790a 2020 2020 2020  ictionary.      
+00019e10: 2020 6d6f 6465 6c5f 636c 6173 7320 3d20    model_class = 
+00019e20: 6765 7461 7474 7228 6e65 7477 6f72 6b5f  getattr(network_
+00019e30: 7061 636b 6167 652c 2073 656c 662e 6172  package, self.ar
+00019e40: 6368 6974 6563 7475 7265 290a 2020 2020  chitecture).    
+00019e50: 2020 2020 6172 6773 203d 206c 6973 7428      args = list(
+00019e60: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00019e70: 656c 5f63 6c61 7373 2e5f 5f69 6e69 745f  el_class.__init_
+00019e80: 5f2e 5f5f 636f 6465 5f5f 2e63 6f5f 7661  _.__code__.co_va
+00019e90: 726e 616d 6573 5b0a 2020 2020 2020 2020  rnames[.        
+00019ea0: 2020 2020 2020 2020 3a20 6d6f 6465 6c5f          : model_
+00019eb0: 636c 6173 732e 5f5f 696e 6974 5f5f 2e5f  class.__init__._
+00019ec0: 5f63 6f64 655f 5f2e 636f 5f61 7267 636f  _code__.co_argco
+00019ed0: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
+00019ee0: 5d0a 2020 2020 2020 2020 290a 2020 2020  ].        ).    
+00019ef0: 2020 2020 6172 6773 2e72 656d 6f76 6528      args.remove(
+00019f00: 2273 656c 6622 290a 2020 2020 2020 2020  "self").        
+00019f10: 6b77 6172 6773 203d 2064 6963 7428 290a  kwargs = dict().
+00019f20: 2020 2020 2020 2020 666f 7220 6172 6720          for arg 
+00019f30: 696e 2061 7267 733a 0a20 2020 2020 2020  in args:.       
+00019f40: 2020 2020 206b 7761 7267 735b 6172 675d       kwargs[arg]
+00019f50: 203d 2073 656c 662e 7061 7261 6d65 7465   = self.paramete
+00019f60: 7273 5b61 7267 5d0a 0a20 2020 2020 2020  rs[arg]..       
+00019f70: 2023 2043 6861 6e67 6520 6465 7669 6365   # Change device
+00019f80: 2066 726f 6d20 7468 6520 7472 6169 6e69   from the traini
+00019f90: 6e67 2070 6172 616d 6574 6572 730a 2020  ng parameters.  
+00019fa0: 2020 2020 2020 6966 2067 7075 2069 7320        if gpu is 
+00019fb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00019fc0: 2020 2020 2020 6b77 6172 6773 5b22 6770        kwargs["gp
+00019fd0: 7522 5d20 3d20 6770 750a 0a20 2020 2020  u"] = gpu..     
+00019fe0: 2020 206d 6f64 656c 203d 206d 6f64 656c     model = model
+00019ff0: 5f63 6c61 7373 282a 2a6b 7761 7267 7329  _class(**kwargs)
+0001a000: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0001a010: 6465 6275 6728 6622 4d6f 6465 6c3a 5c6e  debug(f"Model:\n
+0001a020: 7b6d 6f64 656c 2e6c 6179 6572 737d 2229  {model.layers}")
+0001a030: 0a0a 2020 2020 2020 2020 6465 7669 6365  ..        device
+0001a040: 203d 2022 6370 7522 0a20 2020 2020 2020   = "cpu".       
+0001a050: 2069 6620 6465 7669 6365 2021 3d20 6d6f   if device != mo
+0001a060: 6465 6c2e 6465 7669 6365 3a0a 2020 2020  del.device:.    
+0001a070: 2020 2020 2020 2020 6465 7669 6365 203d          device =
+0001a080: 206d 6f64 656c 2e64 6576 6963 650a 2020   model.device.  
+0001a090: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0001a0a0: 2e69 6e66 6f28 6622 576f 726b 696e 6720  .info(f"Working 
+0001a0b0: 6f6e 207b 6465 7669 6365 7d22 290a 2020  on {device}").  
+0001a0c0: 2020 2020 2020 6375 7272 656e 745f 6570        current_ep
+0001a0d0: 6f63 6820 3d20 300a 0a20 2020 2020 2020  och = 0..       
+0001a0e0: 2069 6620 7265 7375 6d65 3a0a 2020 2020   if resume:.    
+0001a0f0: 2020 2020 2020 2020 6368 6563 6b70 6f69          checkpoi
+0001a100: 6e74 5f70 6174 6820 3d20 280a 2020 2020  nt_path = (.    
+0001a110: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a120: 2e6d 6170 735f 7061 7468 0a20 2020 2020  .maps_path.     
+0001a130: 2020 2020 2020 2020 2020 202f 2066 227b             / f"{
+0001a140: 7365 6c66 2e73 706c 6974 5f6e 616d 657d  self.split_name}
+0001a150: 2d7b 7370 6c69 747d 220a 2020 2020 2020  -{split}".      
+0001a160: 2020 2020 2020 2020 2020 2f20 2274 6d70            / "tmp
+0001a170: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001a180: 2020 2f20 2263 6865 636b 706f 696e 742e    / "checkpoint.
+0001a190: 7074 682e 7461 7222 0a20 2020 2020 2020  pth.tar".       
+0001a1a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001a1b0: 2020 2063 6865 636b 706f 696e 745f 7374     checkpoint_st
+0001a1c0: 6174 6520 3d20 746f 7263 682e 6c6f 6164  ate = torch.load
+0001a1d0: 2863 6865 636b 706f 696e 745f 7061 7468  (checkpoint_path
+0001a1e0: 2c20 6d61 705f 6c6f 6361 7469 6f6e 3d64  , map_location=d
+0001a1f0: 6576 6963 6529 0a20 2020 2020 2020 2020  evice).         
+0001a200: 2020 206d 6f64 656c 2e6c 6f61 645f 7374     model.load_st
+0001a210: 6174 655f 6469 6374 2863 6865 636b 706f  ate_dict(checkpo
+0001a220: 696e 745f 7374 6174 655b 226d 6f64 656c  int_state["model
+0001a230: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0001a240: 6375 7272 656e 745f 6570 6f63 6820 3d20  current_epoch = 
+0001a250: 6368 6563 6b70 6f69 6e74 5f73 7461 7465  checkpoint_state
+0001a260: 5b22 6570 6f63 6822 5d0a 2020 2020 2020  ["epoch"].      
+0001a270: 2020 656c 6966 2074 7261 6e73 6665 725f    elif transfer_
+0001a280: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
+0001a290: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+0001a2a0: 2254 7261 6e73 6665 7220 7765 6967 6874  "Transfer weight
+0001a2b0: 7320 6672 6f6d 204d 4150 5320 6174 207b  s from MAPS at {
+0001a2c0: 7472 616e 7366 6572 5f70 6174 687d 2229  transfer_path}")
+0001a2d0: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+0001a2e0: 6e73 6665 725f 6d61 7073 203d 204d 6170  nsfer_maps = Map
+0001a2f0: 734d 616e 6167 6572 2874 7261 6e73 6665  sManager(transfe
+0001a300: 725f 7061 7468 290a 2020 2020 2020 2020  r_path).        
+0001a310: 2020 2020 7472 616e 7366 6572 5f73 7461      transfer_sta
+0001a320: 7465 203d 2074 7261 6e73 6665 725f 6d61  te = transfer_ma
+0001a330: 7073 2e67 6574 5f73 7461 7465 5f64 6963  ps.get_state_dic
+0001a340: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0001a350: 2020 2073 706c 6974 2c0a 2020 2020 2020     split,.      
+0001a360: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+0001a370: 696f 6e5f 6d65 7472 6963 3d74 7261 6e73  ion_metric=trans
+0001a380: 6665 725f 7365 6c65 6374 696f 6e2c 0a20  fer_selection,. 
+0001a390: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001a3a0: 6574 776f 726b 3d6e 6574 776f 726b 2c0a  etwork=network,.
+0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3c0: 6d61 705f 6c6f 6361 7469 6f6e 3d6d 6f64  map_location=mod
+0001a3d0: 656c 2e64 6576 6963 652c 0a20 2020 2020  el.device,.     
+0001a3e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001a3f0: 2020 2020 2074 7261 6e73 6665 725f 636c       transfer_cl
+0001a400: 6173 7320 3d20 6765 7461 7474 7228 6e65  ass = getattr(ne
+0001a410: 7477 6f72 6b5f 7061 636b 6167 652c 2074  twork_package, t
+0001a420: 7261 6e73 6665 725f 6d61 7073 2e61 7263  ransfer_maps.arc
+0001a430: 6869 7465 6374 7572 6529 0a20 2020 2020  hitecture).     
+0001a440: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+0001a450: 6275 6728 6622 5472 616e 7366 6572 2066  bug(f"Transfer f
+0001a460: 726f 6d20 7b74 7261 6e73 6665 725f 636c  rom {transfer_cl
+0001a470: 6173 737d 2229 0a20 2020 2020 2020 2020  ass}").         
+0001a480: 2020 206d 6f64 656c 2e74 7261 6e73 6665     model.transfe
+0001a490: 725f 7765 6967 6874 7328 7472 616e 7366  r_weights(transf
+0001a4a0: 6572 5f73 7461 7465 5b22 6d6f 6465 6c22  er_state["model"
+0001a4b0: 5d2c 2074 7261 6e73 6665 725f 636c 6173  ], transfer_clas
+0001a4c0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0001a4d0: 6966 206e 625f 756e 6672 6f7a 656e 5f6c  if nb_unfrozen_l
+0001a4e0: 6179 6572 2021 3d20 303a 0a20 2020 2020  ayer != 0:.     
+0001a4f0: 2020 2020 2020 2020 2020 206c 6973 745f             list_
+0001a500: 6e61 6d65 203d 205b 6e61 6d65 2066 6f72  name = [name for
+0001a510: 2028 6e61 6d65 2c20 5f29 2069 6e20 6d6f   (name, _) in mo
+0001a520: 6465 6c2e 6e61 6d65 645f 7061 7261 6d65  del.named_parame
+0001a530: 7465 7273 2829 5d0a 2020 2020 2020 2020  ters()].        
+0001a540: 2020 2020 2020 2020 6c69 7374 5f70 6172          list_par
+0001a550: 616d 203d 205b 7061 7261 6d20 666f 7220  am = [param for 
+0001a560: 285f 2c20 7061 7261 6d29 2069 6e20 6d6f  (_, param) in mo
+0001a570: 6465 6c2e 6e61 6d65 645f 7061 7261 6d65  del.named_parame
+0001a580: 7465 7273 2829 5d0a 0a20 2020 2020 2020  ters()]..       
+0001a590: 2020 2020 2020 2020 2066 6f72 2070 6172           for par
+0001a5a0: 616d 2c20 5f20 696e 207a 6970 286c 6973  am, _ in zip(lis
+0001a5b0: 745f 7061 7261 6d2c 206c 6973 745f 6e61  t_param, list_na
+0001a5c0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
+0001a5d0: 2020 2020 2020 2020 2070 6172 616d 2e72           param.r
+0001a5e0: 6571 7569 7265 735f 6772 6164 203d 2046  equires_grad = F
+0001a5f0: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
+0001a600: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+0001a610: 616e 6765 286e 625f 756e 6672 6f7a 656e  ange(nb_unfrozen
+0001a620: 5f6c 6179 6572 202a 2032 293a 2020 2320  _layer * 2):  # 
+0001a630: 556e 6672 6565 7a65 2074 6865 206c 6173  Unfreeze the las
+0001a640: 7420 6c61 7965 7273 0a20 2020 2020 2020  t layers.       
+0001a650: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0001a660: 616d 203d 206c 6973 745f 7061 7261 6d5b  am = list_param[
+0001a670: 6c65 6e28 6c69 7374 5f70 6172 616d 2920  len(list_param) 
+0001a680: 2d20 6920 2d20 315d 0a20 2020 2020 2020  - i - 1].       
+0001a690: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+0001a6a0: 6520 3d20 6c69 7374 5f6e 616d 655b 6c65  e = list_name[le
+0001a6b0: 6e28 6c69 7374 5f6e 616d 6529 202d 2069  n(list_name) - i
+0001a6c0: 202d 2031 5d0a 2020 2020 2020 2020 2020   - 1].          
+0001a6d0: 2020 2020 2020 2020 2020 7061 7261 6d2e            param.
+0001a6e0: 7265 7175 6972 6573 5f67 7261 6420 3d20  requires_grad = 
+0001a6f0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001a700: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0001a710: 696e 666f 2866 224c 6179 6572 207b 6e61  info(f"Layer {na
+0001a720: 6d65 7d20 756e 6672 6f7a 656e 207b 7061  me} unfrozen {pa
+0001a730: 7261 6d2e 7265 7175 6972 6573 5f67 7261  ram.requires_gra
+0001a740: 647d 2229 0a0a 2020 2020 2020 2020 7265  d}")..        re
+0001a750: 7475 726e 206d 6f64 656c 2c20 6375 7272  turn model, curr
+0001a760: 656e 745f 6570 6f63 680a 0a20 2020 2064  ent_epoch..    d
+0001a770: 6566 205f 696e 6974 5f6f 7074 696d 697a  ef _init_optimiz
+0001a780: 6572 2873 656c 662c 206d 6f64 656c 3a20  er(self, model: 
+0001a790: 4444 502c 2073 706c 6974 3d4e 6f6e 652c  DDP, split=None,
+0001a7a0: 2072 6573 756d 653d 4661 6c73 6529 3a0a   resume=False):.
+0001a7b0: 2020 2020 2020 2020 2222 2249 6e69 7469          """Initi
+0001a7c0: 616c 697a 6520 7468 6520 6f70 7469 6d69  alize the optimi
+0001a7d0: 7a65 7220 616e 6420 7573 6520 6368 6563  zer and use chec
+0001a7e0: 6b70 6f69 6e74 2077 6569 6768 7473 2069  kpoint weights i
+0001a7f0: 6620 7265 7375 6d65 2069 7320 5472 7565  f resume is True
+0001a800: 2e22 2222 0a0a 2020 2020 2020 2020 6f70  ."""..        op
+0001a810: 7469 6d69 7a65 725f 636c 7320 3d20 6765  timizer_cls = ge
+0001a820: 7461 7474 7228 746f 7263 682e 6f70 7469  tattr(torch.opti
+0001a830: 6d2c 2073 656c 662e 6f70 7469 6d69 7a65  m, self.optimize
+0001a840: 7229 0a20 2020 2020 2020 2070 6172 616d  r).        param
+0001a850: 6574 6572 7320 3d20 6669 6c74 6572 286c  eters = filter(l
+0001a860: 616d 6264 6120 783a 2078 2e72 6571 7569  ambda x: x.requi
+0001a870: 7265 735f 6772 6164 2c20 6d6f 6465 6c2e  res_grad, model.
+0001a880: 7061 7261 6d65 7465 7273 2829 290a 2020  parameters()).  
+0001a890: 2020 2020 2020 6f70 7469 6d69 7a65 725f        optimizer_
+0001a8a0: 6b77 6172 6773 203d 2064 6963 7428 0a20  kwargs = dict(. 
+0001a8b0: 2020 2020 2020 2020 2020 206c 723d 7365             lr=se
+0001a8c0: 6c66 2e6c 6561 726e 696e 675f 7261 7465  lf.learning_rate
+0001a8d0: 2c0a 2020 2020 2020 2020 2020 2020 7765  ,.            we
+0001a8e0: 6967 6874 5f64 6563 6179 3d73 656c 662e  ight_decay=self.
+0001a8f0: 7765 6967 6874 5f64 6563 6179 2c0a 2020  weight_decay,.  
+0001a900: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001a910: 206f 7074 696d 697a 6572 203d 206f 7074   optimizer = opt
+0001a920: 696d 697a 6572 5f63 6c73 2870 6172 616d  imizer_cls(param
+0001a930: 6574 6572 732c 202a 2a6f 7074 696d 697a  eters, **optimiz
+0001a940: 6572 5f6b 7761 7267 7329 0a0a 2020 2020  er_kwargs)..    
+0001a950: 2020 2020 6966 2072 6573 756d 653a 0a20      if resume:. 
+0001a960: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0001a970: 706f 696e 745f 7061 7468 203d 2028 0a20  point_path = (. 
+0001a980: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001a990: 656c 662e 6d61 7073 5f70 6174 680a 2020  elf.maps_path.  
+0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+0001a9b0: 6622 7b73 656c 662e 7370 6c69 745f 6e61  f"{self.split_na
+0001a9c0: 6d65 7d2d 7b73 706c 6974 7d22 0a20 2020  me}-{split}".   
+0001a9d0: 2020 2020 2020 2020 2020 2020 202f 2022               / "
+0001a9e0: 746d 7022 0a20 2020 2020 2020 2020 2020  tmp".           
+0001a9f0: 2020 2020 202f 2022 6f70 7469 6d69 7a65       / "optimize
+0001aa00: 722e 7074 682e 7461 7222 0a20 2020 2020  r.pth.tar".     
+0001aa10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001aa20: 2020 2020 2063 6865 636b 706f 696e 745f       checkpoint_
+0001aa30: 7374 6174 6520 3d20 746f 7263 682e 6c6f  state = torch.lo
+0001aa40: 6164 2863 6865 636b 706f 696e 745f 7061  ad(checkpoint_pa
+0001aa50: 7468 2c20 6d61 705f 6c6f 6361 7469 6f6e  th, map_location
+0001aa60: 3d6d 6f64 656c 2e64 6576 6963 6529 0a20  =model.device). 
+0001aa70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0001aa80: 2e6c 6f61 645f 6f70 7469 6d5f 7374 6174  .load_optim_stat
+0001aa90: 655f 6469 6374 286f 7074 696d 697a 6572  e_dict(optimizer
+0001aaa0: 2c20 6368 6563 6b70 6f69 6e74 5f73 7461  , checkpoint_sta
+0001aab0: 7465 5b22 6f70 7469 6d69 7a65 7222 5d29  te["optimizer"])
+0001aac0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001aad0: 206f 7074 696d 697a 6572 0a0a 2020 2020   optimizer..    
+0001aae0: 6465 6620 5f69 6e69 745f 7370 6c69 745f  def _init_split_
+0001aaf0: 6d61 6e61 6765 7228 7365 6c66 2c20 7370  manager(self, sp
+0001ab00: 6c69 745f 6c69 7374 3d4e 6f6e 652c 2073  lit_list=None, s
+0001ab10: 7364 615f 626f 6f6c 3a20 626f 6f6c 203d  sda_bool: bool =
+0001ab20: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
+0001ab30: 2066 726f 6d20 636c 696e 6963 6164 6c2e   from clinicadl.
+0001ab40: 7574 696c 7320 696d 706f 7274 2073 706c  utils import spl
+0001ab50: 6974 5f6d 616e 6167 6572 0a0a 2020 2020  it_manager..    
+0001ab60: 2020 2020 7370 6c69 745f 636c 6173 7320      split_class 
+0001ab70: 3d20 6765 7461 7474 7228 7370 6c69 745f  = getattr(split_
+0001ab80: 6d61 6e61 6765 722c 2073 656c 662e 7661  manager, self.va
+0001ab90: 6c69 6461 7469 6f6e 290a 2020 2020 2020  lidation).      
+0001aba0: 2020 6172 6773 203d 206c 6973 7428 0a20    args = list(. 
+0001abb0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+0001abc0: 5f63 6c61 7373 2e5f 5f69 6e69 745f 5f2e  _class.__init__.
+0001abd0: 5f5f 636f 6465 5f5f 2e63 6f5f 7661 726e  __code__.co_varn
+0001abe0: 616d 6573 5b0a 2020 2020 2020 2020 2020  ames[.          
+0001abf0: 2020 2020 2020 3a20 7370 6c69 745f 636c        : split_cl
+0001ac00: 6173 732e 5f5f 696e 6974 5f5f 2e5f 5f63  ass.__init__.__c
+0001ac10: 6f64 655f 5f2e 636f 5f61 7267 636f 756e  ode__.co_argcoun
+0001ac20: 740a 2020 2020 2020 2020 2020 2020 5d0a  t.            ].
+0001ac30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001ac40: 2020 6172 6773 2e72 656d 6f76 6528 2273    args.remove("s
+0001ac50: 656c 6622 290a 2020 2020 2020 2020 6172  elf").        ar
+0001ac60: 6773 2e72 656d 6f76 6528 2273 706c 6974  gs.remove("split
+0001ac70: 5f6c 6973 7422 290a 2020 2020 2020 2020  _list").        
+0001ac80: 6b77 6172 6773 203d 207b 2273 706c 6974  kwargs = {"split
+0001ac90: 5f6c 6973 7422 3a20 7370 6c69 745f 6c69  _list": split_li
+0001aca0: 7374 7d0a 2020 2020 2020 2020 666f 7220  st}.        for 
+0001acb0: 6172 6720 696e 2061 7267 733a 0a20 2020  arg in args:.   
+0001acc0: 2020 2020 2020 2020 206b 7761 7267 735b           kwargs[
+0001acd0: 6172 675d 203d 2073 656c 662e 7061 7261  arg] = self.para
+0001ace0: 6d65 7465 7273 5b61 7267 5d0a 0a20 2020  meters[arg]..   
+0001acf0: 2020 2020 2069 6620 7373 6461 5f62 6f6f       if ssda_boo
+0001ad00: 6c3a 0a20 2020 2020 2020 2020 2020 206b  l:.            k
+0001ad10: 7761 7267 735b 2263 6170 735f 6469 7265  wargs["caps_dire
+0001ad20: 6374 6f72 7922 5d20 3d20 7365 6c66 2e63  ctory"] = self.c
+0001ad30: 6170 735f 7461 7267 6574 0a20 2020 2020  aps_target.     
+0001ad40: 2020 2020 2020 206b 7761 7267 735b 2274         kwargs["t
+0001ad50: 7376 5f70 6174 6822 5d20 3d20 7365 6c66  sv_path"] = self
+0001ad60: 2e74 7376 5f74 6172 6765 745f 6c61 620a  .tsv_target_lab.
+0001ad70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001ad80: 7370 6c69 745f 636c 6173 7328 2a2a 6b77  split_class(**kw
+0001ad90: 6172 6773 290a 0a20 2020 2064 6566 205f  args)..    def _
+0001ada0: 696e 6974 5f73 706c 6974 5f6d 616e 6167  init_split_manag
+0001adb0: 6572 5f73 7364 6128 7365 6c66 2c20 6361  er_ssda(self, ca
+0001adc0: 7073 5f64 6972 2c20 7473 765f 6469 722c  ps_dir, tsv_dir,
+0001add0: 2073 706c 6974 5f6c 6973 743d 4e6f 6e65   split_list=None
+0001ade0: 293a 0a20 2020 2020 2020 2023 2041 2069  ):.        # A i
+0001adf0: 6e74 c3a9 6772 6572 2064 6972 6563 7465  nt..grer directe
+0001ae00: 6d65 6e74 2064 616e 7320 5f69 6e69 745f  ment dans _init_
+0001ae10: 7370 6c69 745f 6d61 6e61 6765 720a 2020  split_manager.  
+0001ae20: 2020 2020 2020 6672 6f6d 2063 6c69 6e69        from clini
+0001ae30: 6361 646c 2e75 7469 6c73 2069 6d70 6f72  cadl.utils impor
+0001ae40: 7420 7370 6c69 745f 6d61 6e61 6765 720a  t split_manager.
+0001ae50: 0a20 2020 2020 2020 2073 706c 6974 5f63  .        split_c
+0001ae60: 6c61 7373 203d 2067 6574 6174 7472 2873  lass = getattr(s
+0001ae70: 706c 6974 5f6d 616e 6167 6572 2c20 7365  plit_manager, se
+0001ae80: 6c66 2e76 616c 6964 6174 696f 6e29 0a20  lf.validation). 
+0001ae90: 2020 2020 2020 2061 7267 7320 3d20 6c69         args = li
+0001aea0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+0001aeb0: 7370 6c69 745f 636c 6173 732e 5f5f 696e  split_class.__in
+0001aec0: 6974 5f5f 2e5f 5f63 6f64 655f 5f2e 636f  it__.__code__.co
+0001aed0: 5f76 6172 6e61 6d65 735b 0a20 2020 2020  _varnames[.     
+0001aee0: 2020 2020 2020 2020 2020 203a 2073 706c             : spl
+0001aef0: 6974 5f63 6c61 7373 2e5f 5f69 6e69 745f  it_class.__init_
+0001af00: 5f2e 5f5f 636f 6465 5f5f 2e63 6f5f 6172  _.__code__.co_ar
+0001af10: 6763 6f75 6e74 0a20 2020 2020 2020 2020  gcount.         
+0001af20: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
+0001af30: 2020 2020 2020 2061 7267 732e 7265 6d6f         args.remo
+0001af40: 7665 2822 7365 6c66 2229 0a20 2020 2020  ve("self").     
+0001af50: 2020 2061 7267 732e 7265 6d6f 7665 2822     args.remove("
+0001af60: 7370 6c69 745f 6c69 7374 2229 0a20 2020  split_list").   
+0001af70: 2020 2020 206b 7761 7267 7320 3d20 7b22       kwargs = {"
+0001af80: 7370 6c69 745f 6c69 7374 223a 2073 706c  split_list": spl
+0001af90: 6974 5f6c 6973 747d 0a20 2020 2020 2020  it_list}.       
+0001afa0: 2066 6f72 2061 7267 2069 6e20 6172 6773   for arg in args
+0001afb0: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
+0001afc0: 6172 6773 5b61 7267 5d20 3d20 7365 6c66  args[arg] = self
+0001afd0: 2e70 6172 616d 6574 6572 735b 6172 675d  .parameters[arg]
+0001afe0: 0a0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+0001aff0: 5b22 6361 7073 5f64 6972 6563 746f 7279  ["caps_directory
+0001b000: 225d 203d 2050 6174 6828 6361 7073 5f64  "] = Path(caps_d
+0001b010: 6972 290a 2020 2020 2020 2020 6b77 6172  ir).        kwar
+0001b020: 6773 5b22 7473 765f 7061 7468 225d 203d  gs["tsv_path"] =
+0001b030: 2050 6174 6828 7473 765f 6469 7229 0a0a   Path(tsv_dir)..
+0001b040: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001b050: 706c 6974 5f63 6c61 7373 282a 2a6b 7761  plit_class(**kwa
+0001b060: 7267 7329 0a0a 2020 2020 6465 6620 5f69  rgs)..    def _i
+0001b070: 6e69 745f 7461 736b 5f6d 616e 6167 6572  nit_task_manager
+0001b080: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001b090: 6466 3a20 4f70 7469 6f6e 616c 5b70 642e  df: Optional[pd.
+0001b0a0: 4461 7461 4672 616d 655d 203d 204e 6f6e  DataFrame] = Non
+0001b0b0: 652c 206e 5f63 6c61 7373 6573 3a20 4f70  e, n_classes: Op
+0001b0c0: 7469 6f6e 616c 5b69 6e74 5d20 3d20 4e6f  tional[int] = No
+0001b0d0: 6e65 0a20 2020 2029 3a0a 2020 2020 2020  ne.    ):.      
+0001b0e0: 2020 6672 6f6d 2063 6c69 6e69 6361 646c    from clinicadl
+0001b0f0: 2e75 7469 6c73 2e74 6173 6b5f 6d61 6e61  .utils.task_mana
+0001b100: 6765 7220 696d 706f 7274 2028 0a20 2020  ger import (.   
+0001b110: 2020 2020 2020 2020 2043 6c61 7373 6966           Classif
+0001b120: 6963 6174 696f 6e4d 616e 6167 6572 2c0a  icationManager,.
+0001b130: 2020 2020 2020 2020 2020 2020 5265 636f              Reco
+0001b140: 6e73 7472 7563 7469 6f6e 4d61 6e61 6765  nstructionManage
+0001b150: 722c 0a20 2020 2020 2020 2020 2020 2052  r,.            R
+0001b160: 6567 7265 7373 696f 6e4d 616e 6167 6572  egressionManager
+0001b170: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0001b180: 2020 2020 2069 6620 7365 6c66 2e6e 6574       if self.net
+0001b190: 776f 726b 5f74 6173 6b20 3d3d 2022 636c  work_task == "cl
+0001b1a0: 6173 7369 6669 6361 7469 6f6e 223a 0a20  assification":. 
+0001b1b0: 2020 2020 2020 2020 2020 2069 6620 6e5f             if n_
+0001b1c0: 636c 6173 7365 7320 6973 206e 6f74 204e  classes is not N
+0001b1d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001b1e0: 2020 2020 2072 6574 7572 6e20 436c 6173       return Clas
+0001b1f0: 7369 6669 6361 7469 6f6e 4d61 6e61 6765  sificationManage
+0001b200: 7228 7365 6c66 2e6d 6f64 652c 206e 5f63  r(self.mode, n_c
+0001b210: 6c61 7373 6573 3d6e 5f63 6c61 7373 6573  lasses=n_classes
+0001b220: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0001b230: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001b240: 2020 2020 7265 7475 726e 2043 6c61 7373      return Class
+0001b250: 6966 6963 6174 696f 6e4d 616e 6167 6572  ificationManager
+0001b260: 2873 656c 662e 6d6f 6465 2c20 6466 3d64  (self.mode, df=d
+0001b270: 662c 206c 6162 656c 3d73 656c 662e 6c61  f, label=self.la
+0001b280: 6265 6c29 0a20 2020 2020 2020 2065 6c69  bel).        eli
+0001b290: 6620 7365 6c66 2e6e 6574 776f 726b 5f74  f self.network_t
+0001b2a0: 6173 6b20 3d3d 2022 7265 6772 6573 7369  ask == "regressi
+0001b2b0: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
+0001b2c0: 2072 6574 7572 6e20 5265 6772 6573 7369   return Regressi
+0001b2d0: 6f6e 4d61 6e61 6765 7228 7365 6c66 2e6d  onManager(self.m
+0001b2e0: 6f64 6529 0a20 2020 2020 2020 2065 6c69  ode).        eli
+0001b2f0: 6620 7365 6c66 2e6e 6574 776f 726b 5f74  f self.network_t
+0001b300: 6173 6b20 3d3d 2022 7265 636f 6e73 7472  ask == "reconstr
+0001b310: 7563 7469 6f6e 223a 0a20 2020 2020 2020  uction":.       
+0001b320: 2020 2020 2072 6574 7572 6e20 5265 636f       return Reco
+0001b330: 6e73 7472 7563 7469 6f6e 4d61 6e61 6765  nstructionManage
+0001b340: 7228 7365 6c66 2e6d 6f64 6529 0a20 2020  r(self.mode).   
+0001b350: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001b360: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+0001b370: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+0001b380: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001b390: 2020 6622 5461 736b 207b 7365 6c66 2e6e    f"Task {self.n
+0001b3a0: 6574 776f 726b 5f74 6173 6b7d 2069 7320  etwork_task} is 
+0001b3b0: 6e6f 7420 696d 706c 656d 656e 7465 6420  not implemented 
+0001b3c0: 696e 2043 6c69 6e69 6361 444c 2e20 220a  in ClinicaDL. ".
+0001b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3e0: 6622 506c 6561 7365 2063 686f 6f73 6520  f"Please choose 
+0001b3f0: 6265 7477 6565 6e20 636c 6173 7369 6669  between classifi
+0001b400: 6361 7469 6f6e 2c20 7265 6772 6573 7369  cation, regressi
+0001b410: 6f6e 2061 6e64 2072 6563 6f6e 7374 7275  on and reconstru
+0001b420: 6374 696f 6e2e 220a 2020 2020 2020 2020  ction.".        
+0001b430: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+0001b440: 696e 6974 5f70 726f 6669 6c65 7228 7365  init_profiler(se
+0001b450: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
+0001b460: 7365 6c66 2e70 726f 6669 6c65 723a 0a20  self.profiler:. 
+0001b470: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0001b480: 636c 696e 6963 6164 6c2e 7574 696c 732e  clinicadl.utils.
+0001b490: 6d61 7073 5f6d 616e 6167 6572 2e63 6c75  maps_manager.clu
+0001b4a0: 7374 6572 2e70 726f 6669 6c65 7220 696d  ster.profiler im
+0001b4b0: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
+0001b4c0: 2020 2020 2020 2050 726f 6669 6c65 7241         ProfilerA
+0001b4d0: 6374 6976 6974 792c 0a20 2020 2020 2020  ctivity,.       
+0001b4e0: 2020 2020 2020 2020 2070 726f 6669 6c65           profile
+0001b4f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b500: 2020 7363 6865 6475 6c65 2c0a 2020 2020    schedule,.    
+0001b510: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0001b520: 6f72 626f 6172 645f 7472 6163 655f 6861  orboard_trace_ha
+0001b530: 6e64 6c65 722c 0a20 2020 2020 2020 2020  ndler,.         
+0001b540: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0001b550: 2020 7469 6d65 203d 2064 6174 6574 696d    time = datetim
+0001b560: 652e 6e6f 7728 292e 7374 7266 7469 6d65  e.now().strftime
+0001b570: 2822 2548 3a25 4d3a 2553 2229 0a20 2020  ("%H:%M:%S").   
+0001b580: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+0001b590: 6520 3d20 5b73 656c 662e 6d61 7073 5f70  e = [self.maps_p
+0001b5a0: 6174 6820 2f20 2270 726f 6669 6c65 7222  ath / "profiler"
+0001b5b0: 202f 2066 2263 6c69 6e69 6361 646c 5f7b   / f"clinicadl_{
+0001b5c0: 7469 6d65 7d22 5d0a 2020 2020 2020 2020  time}"].        
+0001b5d0: 2020 2020 6469 7374 2e62 726f 6164 6361      dist.broadca
+0001b5e0: 7374 5f6f 626a 6563 745f 6c69 7374 2866  st_object_list(f
+0001b5f0: 696c 656e 616d 652c 2073 7263 3d30 290a  ilename, src=0).
+0001b600: 2020 2020 2020 2020 2020 2020 7072 6f66              prof
+0001b610: 696c 6572 203d 2070 726f 6669 6c65 280a  iler = profile(.
+0001b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b630: 6163 7469 7669 7469 6573 3d5b 5072 6f66  activities=[Prof
+0001b640: 696c 6572 4163 7469 7669 7479 2e43 5055  ilerActivity.CPU
+0001b650: 2c20 5072 6f66 696c 6572 4163 7469 7669  , ProfilerActivi
+0001b660: 7479 2e43 5544 415d 2c0a 2020 2020 2020  ty.CUDA],.      
+0001b670: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+0001b680: 6c65 3d73 6368 6564 756c 6528 7761 6974  le=schedule(wait
+0001b690: 3d32 2c20 7761 726d 7570 3d32 2c20 6163  =2, warmup=2, ac
+0001b6a0: 7469 7665 3d33 302c 2072 6570 6561 743d  tive=30, repeat=
+0001b6b0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+0001b6c0: 2020 2020 6f6e 5f74 7261 6365 5f72 6561      on_trace_rea
+0001b6d0: 6479 3d74 656e 736f 7262 6f61 7264 5f74  dy=tensorboard_t
+0001b6e0: 7261 6365 5f68 616e 646c 6572 2866 696c  race_handler(fil
+0001b6f0: 656e 616d 655b 305d 292c 0a20 2020 2020  ename[0]),.     
+0001b700: 2020 2020 2020 2020 2020 2070 726f 6669             profi
+0001b710: 6c65 5f6d 656d 6f72 793d 5472 7565 2c0a  le_memory=True,.
+0001b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b730: 7265 636f 7264 5f73 6861 7065 733d 4661  record_shapes=Fa
+0001b740: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+0001b750: 2020 2020 2077 6974 685f 7374 6163 6b3d       with_stack=
+0001b760: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+0001b770: 2020 2020 2020 2077 6974 685f 666c 6f70         with_flop
+0001b780: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
+0001b790: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0001b7a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001b7b0: 2070 726f 6669 6c65 7220 3d20 6e75 6c6c   profiler = null
+0001b7c0: 636f 6e74 6578 7428 290a 2020 2020 2020  context().      
+0001b7d0: 2020 2020 2020 7072 6f66 696c 6572 2e73        profiler.s
+0001b7e0: 7465 7020 3d20 6c61 6d62 6461 202a 6172  tep = lambda *ar
+0001b7f0: 6773 2c20 2a2a 6b77 6172 6773 3a20 4e6f  gs, **kwargs: No
+0001b800: 6e65 0a20 2020 2020 2020 2072 6574 7572  ne.        retur
+0001b810: 6e20 7072 6f66 696c 6572 0a0a 2020 2020  n profiler..    
+0001b820: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b830: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0001b840: 2020 2020 2320 4765 7474 6572 7320 2020      # Getters   
+0001b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b860: 2020 230a 2020 2020 2323 2323 2323 2323    #.    ########
+0001b870: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b880: 2323 2323 2323 230a 2020 2020 6465 6620  #######.    def 
+0001b890: 5f70 7269 6e74 5f64 6573 6372 6970 7469  _print_descripti
+0001b8a0: 6f6e 5f6c 6f67 280a 2020 2020 2020 2020  on_log(.        
+0001b8b0: 7365 6c66 2c0a 2020 2020 2020 2020 6461  self,.        da
+0001b8c0: 7461 5f67 726f 7570 3a20 7374 722c 0a20  ta_group: str,. 
+0001b8d0: 2020 2020 2020 2073 706c 6974 3a20 696e         split: in
+0001b8e0: 742c 0a20 2020 2020 2020 2073 656c 6563  t,.        selec
+0001b8f0: 7469 6f6e 5f6d 6574 7269 633a 2073 7472  tion_metric: str
+0001b900: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+0001b910: 2022 2222 0a20 2020 2020 2020 2050 7269   """.        Pri
+0001b920: 6e74 2074 6865 2064 6573 6372 6970 7469  nt the descripti
+0001b930: 6f6e 206c 6f67 2061 7373 6f63 6961 7465  on log associate
+0001b940: 6420 746f 2061 2070 7265 6469 6374 696f  d to a predictio
+0001b950: 6e20 6f72 2069 6e74 6572 7072 6574 6174  n or interpretat
+0001b960: 696f 6e2e 0a0a 2020 2020 2020 2020 4172  ion...        Ar
+0001b970: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0001b980: 6461 7461 5f67 726f 7570 2028 7374 7229  data_group (str)
+0001b990: 3a20 6e61 6d65 206f 6620 7468 6520 6461  : name of the da
+0001b9a0: 7461 2067 726f 7570 2075 7365 6420 666f  ta group used fo
+0001b9b0: 7220 7468 6520 7461 736b 2e0a 2020 2020  r the task..    
+0001b9c0: 2020 2020 2020 2020 7370 6c69 7420 2869          split (i
+0001b9d0: 6e74 293a 2049 6e64 6578 206f 6620 7468  nt): Index of th
+0001b9e0: 6520 7370 6c69 7420 7573 6564 2066 6f72  e split used for
+0001b9f0: 2074 7261 696e 696e 672e 0a20 2020 2020   training..     
+0001ba00: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+0001ba10: 5f6d 6574 7269 6320 2873 7472 293a 204d  _metric (str): M
+0001ba20: 6574 7269 6320 7573 6564 2066 6f72 2062  etric used for b
+0001ba30: 6573 7420 7765 6967 6874 7320 7365 6c65  est weights sele
+0001ba40: 6374 696f 6e2e 0a20 2020 2020 2020 2022  ction..        "
+0001ba50: 2222 0a20 2020 2020 2020 206c 6f67 5f64  "".        log_d
+0001ba60: 6972 203d 2028 0a20 2020 2020 2020 2020  ir = (.         
+0001ba70: 2020 2073 656c 662e 6d61 7073 5f70 6174     self.maps_pat
+0001ba80: 680a 2020 2020 2020 2020 2020 2020 2f20  h.            / 
+0001ba90: 6622 7b73 656c 662e 7370 6c69 745f 6e61  f"{self.split_na
+0001baa0: 6d65 7d2d 7b73 706c 6974 7d22 0a20 2020  me}-{split}".   
+0001bab0: 2020 2020 2020 2020 202f 2066 2262 6573           / f"bes
+0001bac0: 742d 7b73 656c 6563 7469 6f6e 5f6d 6574  t-{selection_met
+0001bad0: 7269 637d 220a 2020 2020 2020 2020 2020  ric}".          
+0001bae0: 2020 2f20 6461 7461 5f67 726f 7570 0a20    / data_group. 
+0001baf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001bb00: 206c 6f67 5f70 6174 6820 3d20 6c6f 675f   log_path = log_
+0001bb10: 6469 7220 2f20 2264 6573 6372 6970 7469  dir / "descripti
+0001bb20: 6f6e 2e6c 6f67 220a 2020 2020 2020 2020  on.log".        
+0001bb30: 7769 7468 206c 6f67 5f70 6174 682e 6f70  with log_path.op
+0001bb40: 656e 286d 6f64 653d 2272 2229 2061 7320  en(mode="r") as 
+0001bb50: 663a 0a20 2020 2020 2020 2020 2020 2063  f:.            c
+0001bb60: 6f6e 7465 6e74 203d 2066 2e72 6561 6428  ontent = f.read(
+0001bb70: 290a 0a20 2020 2064 6566 2067 6574 5f67  )..    def get_g
+0001bb80: 726f 7570 5f69 6e66 6f28 0a20 2020 2020  roup_info(.     
+0001bb90: 2020 2073 656c 662c 2064 6174 615f 6772     self, data_gr
+0001bba0: 6f75 703a 2073 7472 2c20 7370 6c69 743a  oup: str, split:
+0001bbb0: 2069 6e74 203d 204e 6f6e 650a 2020 2020   int = None.    
+0001bbc0: 2920 2d3e 2054 7570 6c65 5b70 642e 4461  ) -> Tuple[pd.Da
+0001bbd0: 7461 4672 616d 652c 2044 6963 745b 7374  taFrame, Dict[st
+0001bbe0: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
+0001bbf0: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
+0001bc00: 7473 2069 6e66 6f72 6d61 7469 6f6e 2066  ts information f
+0001bc10: 726f 6d20 636f 7272 6573 706f 6e64 696e  rom correspondin
+0001bc20: 6720 6461 7461 2067 726f 7570 0a20 2020  g data group.   
+0001bc30: 2020 2020 2028 6c69 7374 206f 6620 7061       (list of pa
+0001bc40: 7274 6963 6970 616e 745f 6964 202f 2073  rticipant_id / s
+0001bc50: 6573 7369 6f6e 5f69 6420 2b20 636f 6e66  ession_id + conf
+0001bc60: 6967 7572 6174 696f 6e20 7061 7261 6d65  iguration parame
+0001bc70: 7465 7273 292e 0a20 2020 2020 2020 2073  ters)..        s
+0001bc80: 706c 6974 2069 7320 6f6e 6c79 206e 6565  plit is only nee
+0001bc90: 6465 6420 6966 2064 6174 615f 6772 6f75  ded if data_grou
+0001bca0: 7020 6973 2074 7261 696e 206f 7220 7661  p is train or va
+0001bcb0: 6c69 6461 7469 6f6e 2e0a 2020 2020 2020  lidation..      
+0001bcc0: 2020 2222 220a 2020 2020 2020 2020 6772    """.        gr
+0001bcd0: 6f75 705f 7061 7468 203d 2073 656c 662e  oup_path = self.
+0001bce0: 6d61 7073 5f70 6174 6820 2f20 2267 726f  maps_path / "gro
+0001bcf0: 7570 7322 202f 2064 6174 615f 6772 6f75  ups" / data_grou
+0001bd00: 700a 2020 2020 2020 2020 6966 206e 6f74  p.        if not
+0001bd10: 2067 726f 7570 5f70 6174 682e 6973 5f64   group_path.is_d
+0001bd20: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+0001bd30: 2020 7261 6973 6520 4d41 5053 4572 726f    raise MAPSErro
+0001bd40: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001bd50: 2020 2066 2244 6174 6120 6772 6f75 7020     f"Data group 
+0001bd60: 7b64 6174 615f 6772 6f75 707d 2069 7320  {data_group} is 
+0001bd70: 6e6f 7420 6465 6669 6e65 642e 2022 0a20  not defined. ". 
+0001bd80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001bd90: 2250 6c65 6173 6520 7275 6e20 6120 7072  "Please run a pr
+0001bda0: 6564 6963 7469 6f6e 2074 6f20 6372 6561  ediction to crea
+0001bdb0: 7465 2074 6869 7320 6461 7461 2067 726f  te this data gro
+0001bdc0: 7570 2e22 0a20 2020 2020 2020 2020 2020  up.".           
+0001bdd0: 2029 0a20 2020 2020 2020 2069 6620 6461   ).        if da
+0001bde0: 7461 5f67 726f 7570 2069 6e20 5b22 7472  ta_group in ["tr
+0001bdf0: 6169 6e22 2c20 2276 616c 6964 6174 696f  ain", "validatio
+0001be00: 6e22 5d3a 0a20 2020 2020 2020 2020 2020  n"]:.           
+0001be10: 2069 6620 7370 6c69 7420 6973 204e 6f6e   if split is Non
+0001be20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001be30: 2020 2072 6169 7365 204d 4150 5345 7272     raise MAPSErr
+0001be40: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0001be50: 2020 2020 2020 2020 6622 496e 666f 726d          f"Inform
+0001be60: 6174 696f 6e20 6f6e 2074 7261 696e 206f  ation on train o
+0001be70: 7220 7661 6c69 6461 7469 6f6e 2064 6174  r validation dat
+0001be80: 6120 6361 6e20 6f6e 6c79 2062 6520 220a  a can only be ".
+0001be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bea0: 2020 2020 6622 6c6f 6164 6564 2069 6620      f"loaded if 
+0001beb0: 6120 7370 6c69 7420 6e75 6d62 6572 2069  a split number i
+0001bec0: 7320 6769 7665 6e22 0a20 2020 2020 2020  s given".       
+0001bed0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001bee0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+0001bef0: 2867 726f 7570 5f70 6174 6820 2f20 6622  (group_path / f"
+0001bf00: 7b73 656c 662e 7370 6c69 745f 6e61 6d65  {self.split_name
+0001bf10: 7d2d 7b73 706c 6974 7d22 292e 6973 5f64  }-{split}").is_d
+0001bf20: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+0001bf30: 2020 2020 2020 7261 6973 6520 4d41 5053        raise MAPS
+0001bf40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001bf50: 2020 2020 2020 2020 2020 2066 2253 706c             f"Spl
+0001bf60: 6974 207b 7370 6c69 747d 2069 7320 6e6f  it {split} is no
+0001bf70: 7420 6176 6169 6c61 626c 6520 666f 7220  t available for 
+0001bf80: 6461 7461 2067 726f 7570 207b 6461 7461  data group {data
+0001bf90: 5f67 726f 7570 7d2e 220a 2020 2020 2020  _group}.".      
+0001bfa0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001bfb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001bfc0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+0001bfd0: 6f75 705f 7061 7468 203d 2067 726f 7570  oup_path = group
+0001bfe0: 5f70 6174 6820 2f20 6622 7b73 656c 662e  _path / f"{self.
+0001bff0: 7370 6c69 745f 6e61 6d65 7d2d 7b73 706c  split_name}-{spl
+0001c000: 6974 7d22 0a0a 2020 2020 2020 2020 6466  it}"..        df
+0001c010: 203d 2070 642e 7265 6164 5f63 7376 2867   = pd.read_csv(g
+0001c020: 726f 7570 5f70 6174 6820 2f20 2264 6174  roup_path / "dat
+0001c030: 612e 7473 7622 2c20 7365 703d 225c 7422  a.tsv", sep="\t"
+0001c040: 290a 2020 2020 2020 2020 6a73 6f6e 5f70  ).        json_p
+0001c050: 6174 6820 3d20 6772 6f75 705f 7061 7468  ath = group_path
+0001c060: 202f 2022 6d61 7073 2e6a 736f 6e22 0a20   / "maps.json". 
+0001c070: 2020 2020 2020 2066 726f 6d20 636c 696e         from clin
+0001c080: 6963 6164 6c2e 7574 696c 732e 7072 6570  icadl.utils.prep
+0001c090: 726f 6365 7373 696e 6720 696d 706f 7274  rocessing import
+0001c0a0: 2070 6174 685f 6465 636f 6465 720a 0a20   path_decoder.. 
+0001c0b0: 2020 2020 2020 2077 6974 6820 6a73 6f6e         with json
+0001c0c0: 5f70 6174 682e 6f70 656e 286d 6f64 653d  _path.open(mode=
+0001c0d0: 2272 2229 2061 7320 663a 0a20 2020 2020  "r") as f:.     
+0001c0e0: 2020 2020 2020 2070 6172 616d 6574 6572         parameter
+0001c0f0: 7320 3d20 6a73 6f6e 2e6c 6f61 6428 662c  s = json.load(f,
+0001c100: 206f 626a 6563 745f 686f 6f6b 3d70 6174   object_hook=pat
+0001c110: 685f 6465 636f 6465 7229 0a20 2020 2020  h_decoder).     
+0001c120: 2020 2072 6574 7572 6e20 6466 2c20 7061     return df, pa
+0001c130: 7261 6d65 7465 7273 0a0a 2020 2020 6465  rameters..    de
+0001c140: 6620 6765 745f 7061 7261 6d65 7465 7273  f get_parameters
+0001c150: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001c160: 2222 2252 6574 7572 6e73 2074 6865 2074  """Returns the t
+0001c170: 7261 696e 696e 6720 7061 7261 6d65 7465  raining paramete
+0001c180: 7273 2064 6963 7469 6f6e 6172 792e 2222  rs dictionary.""
+0001c190: 220a 2020 2020 2020 2020 6a73 6f6e 5f70  ".        json_p
+0001c1a0: 6174 6820 3d20 7365 6c66 2e6d 6170 735f  ath = self.maps_
+0001c1b0: 7061 7468 202f 2022 6d61 7073 2e6a 736f  path / "maps.jso
+0001c1c0: 6e22 0a20 2020 2020 2020 2072 6574 7572  n".        retur
+0001c1d0: 6e20 7265 6164 5f6a 736f 6e28 6a73 6f6e  n read_json(json
+0001c1e0: 5f70 6174 6829 0a0a 2020 2020 6465 6620  _path)..    def 
+0001c1f0: 6765 745f 6d6f 6465 6c28 0a20 2020 2020  get_model(.     
+0001c200: 2020 2073 656c 662c 2073 706c 6974 3a20     self, split: 
+0001c210: 696e 7420 3d20 302c 2073 656c 6563 7469  int = 0, selecti
+0001c220: 6f6e 5f6d 6574 7269 633a 2073 7472 203d  on_metric: str =
+0001c230: 204e 6f6e 652c 206e 6574 776f 726b 3a20   None, network: 
+0001c240: 696e 7420 3d20 4e6f 6e65 0a20 2020 2029  int = None.    )
+0001c250: 202d 3e20 4e65 7477 6f72 6b3a 0a20 2020   -> Network:.   
+0001c260: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
+0001c270: 6574 7269 6320 3d20 7365 6c66 2e5f 6368  etric = self._ch
+0001c280: 6563 6b5f 7365 6c65 6374 696f 6e5f 6d65  eck_selection_me
+0001c290: 7472 6963 2873 706c 6974 2c20 7365 6c65  tric(split, sele
+0001c2a0: 6374 696f 6e5f 6d65 7472 6963 290a 2020  ction_metric).  
+0001c2b0: 2020 2020 2020 6966 2073 656c 662e 6d75        if self.mu
+0001c2c0: 6c74 695f 6e65 7477 6f72 6b3a 0a20 2020  lti_network:.   
+0001c2d0: 2020 2020 2020 2020 2069 6620 6e65 7477           if netw
+0001c2e0: 6f72 6b20 6973 204e 6f6e 653a 0a20 2020  ork is None:.   
+0001c2f0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001c300: 7365 2043 6c69 6e69 6361 444c 4172 6775  se ClinicaDLArgu
+0001c310: 6d65 6e74 4572 726f 7228 0a20 2020 2020  mentError(.     
+0001c320: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c330: 506c 6561 7365 2070 7265 6369 7365 2074  Please precise t
+0001c340: 6865 206e 6574 776f 726b 206e 756d 6265  he network numbe
+0001c350: 7220 7468 6174 206d 7573 7420 6265 206c  r that must be l
+0001c360: 6f61 6465 642e 220a 2020 2020 2020 2020  oaded.".        
+0001c370: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001c380: 2020 7265 7475 726e 2073 656c 662e 5f69    return self._i
+0001c390: 6e69 745f 6d6f 6465 6c28 0a20 2020 2020  nit_model(.     
+0001c3a0: 2020 2020 2020 2073 656c 662e 6d61 7073         self.maps
+0001c3b0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+0001c3c0: 2020 2073 656c 6563 7469 6f6e 5f6d 6574     selection_met
+0001c3d0: 7269 632c 0a20 2020 2020 2020 2020 2020  ric,.           
+0001c3e0: 2073 706c 6974 2c0a 2020 2020 2020 2020   split,.        
+0001c3f0: 2020 2020 6e65 7477 6f72 6b3d 6e65 7477      network=netw
+0001c400: 6f72 6b2c 0a20 2020 2020 2020 2020 2020  ork,.           
+0001c410: 206e 625f 756e 6672 6f7a 656e 5f6c 6179   nb_unfrozen_lay
+0001c420: 6572 3d73 656c 662e 6e62 5f75 6e66 726f  er=self.nb_unfro
+0001c430: 7a65 6e5f 6c61 7965 722c 0a20 2020 2020  zen_layer,.     
+0001c440: 2020 2029 5b30 5d0a 0a20 2020 2064 6566     )[0]..    def
+0001c450: 2067 6574 5f62 6573 745f 6570 6f63 6828   get_best_epoch(
+0001c460: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
+0001c470: 706c 6974 3a20 696e 7420 3d20 302c 2073  plit: int = 0, s
+0001c480: 656c 6563 7469 6f6e 5f6d 6574 7269 633a  election_metric:
+0001c490: 2073 7472 203d 204e 6f6e 652c 206e 6574   str = None, net
+0001c4a0: 776f 726b 3a20 696e 7420 3d20 4e6f 6e65  work: int = None
+0001c4b0: 0a20 2020 2029 202d 3e20 696e 743a 0a20  .    ) -> int:. 
+0001c4c0: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+0001c4d0: 5f6d 6574 7269 6320 3d20 7365 6c66 2e5f  _metric = self._
+0001c4e0: 6368 6563 6b5f 7365 6c65 6374 696f 6e5f  check_selection_
+0001c4f0: 6d65 7472 6963 2873 706c 6974 2c20 7365  metric(split, se
+0001c500: 6c65 6374 696f 6e5f 6d65 7472 6963 290a  lection_metric).
+0001c510: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001c520: 6d75 6c74 695f 6e65 7477 6f72 6b3a 0a20  multi_network:. 
+0001c530: 2020 2020 2020 2020 2020 2069 6620 6e65             if ne
+0001c540: 7477 6f72 6b20 6973 204e 6f6e 653a 0a20  twork is None:. 
+0001c550: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001c560: 6169 7365 2043 6c69 6e69 6361 444c 4172  aise ClinicaDLAr
+0001c570: 6775 6d65 6e74 4572 726f 7228 0a20 2020  gumentError(.   
+0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c590: 2022 506c 6561 7365 2070 7265 6369 7365   "Please precise
+0001c5a0: 2074 6865 206e 6574 776f 726b 206e 756d   the network num
+0001c5b0: 6265 7220 7468 6174 206d 7573 7420 6265  ber that must be
+0001c5c0: 206c 6f61 6465 642e 220a 2020 2020 2020   loaded.".      
+0001c5d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001c5e0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0001c5f0: 6765 745f 7374 6174 655f 6469 6374 2873  get_state_dict(s
+0001c600: 706c 6974 3d73 706c 6974 2c20 7365 6c65  plit=split, sele
+0001c610: 6374 696f 6e5f 6d65 7472 6963 3d73 656c  ction_metric=sel
+0001c620: 6563 7469 6f6e 5f6d 6574 7269 6329 5b0a  ection_metric)[.
+0001c630: 2020 2020 2020 2020 2020 2020 2265 706f              "epo
+0001c640: 6368 220a 2020 2020 2020 2020 5d0a 0a20  ch".        ].. 
+0001c650: 2020 2064 6566 2067 6574 5f73 7461 7465     def get_state
+0001c660: 5f64 6963 7428 0a20 2020 2020 2020 2073  _dict(.        s
+0001c670: 656c 662c 0a20 2020 2020 2020 2073 706c  elf,.        spl
+0001c680: 6974 3d30 2c0a 2020 2020 2020 2020 7365  it=0,.        se
+0001c690: 6c65 6374 696f 6e5f 6d65 7472 6963 3a20  lection_metric: 
+0001c6a0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+0001c6b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e65  None,.        ne
+0001c6c0: 7477 6f72 6b3a 204f 7074 696f 6e61 6c5b  twork: Optional[
+0001c6d0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+0001c6e0: 2020 2020 206d 6170 5f6c 6f63 6174 696f       map_locatio
+0001c6f0: 6e3a 204f 7074 696f 6e61 6c5b 7374 725d  n: Optional[str]
+0001c700: 203d 204e 6f6e 652c 0a20 2020 2029 3a0a   = None,.    ):.
+0001c710: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001c720: 2020 2020 4765 7420 7468 6520 6d6f 6465      Get the mode
+0001c730: 6c20 7472 6169 6e65 6420 636f 7272 6573  l trained corres
+0001c740: 706f 6e64 696e 6720 746f 206f 6e65 2073  ponding to one s
+0001c750: 706c 6974 2061 6e64 206f 6e65 206d 6574  plit and one met
+0001c760: 7269 6320 6576 616c 7561 7465 6420 6f6e  ric evaluated on
+0001c770: 2074 6865 2076 616c 6964 6174 696f 6e20   the validation 
+0001c780: 7365 742e 0a0a 2020 2020 2020 2020 5061  set...        Pa
+0001c790: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+0001c7a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0001c7b0: 2020 2020 7370 6c69 743a 2069 6e74 0a20      split: int. 
+0001c7c0: 2020 2020 2020 2020 2020 2049 6e64 6578             Index
+0001c7d0: 206f 6620 7468 6520 7370 6c69 7420 7573   of the split us
+0001c7e0: 6564 2066 6f72 2074 7261 696e 696e 672e  ed for training.
+0001c7f0: 0a20 2020 2020 2020 2073 656c 6563 7469  .        selecti
+0001c800: 6f6e 5f6d 6574 7269 633a 2073 7472 0a20  on_metric: str. 
+0001c810: 2020 2020 2020 2020 2020 206e 616d 6520             name 
+0001c820: 6f66 2074 6865 206d 6574 7269 6320 7573  of the metric us
+0001c830: 6564 2066 6f72 2074 6865 2073 656c 6563  ed for the selec
+0001c840: 7469 6f6e 2e0a 2020 2020 2020 2020 6e65  tion..        ne
+0001c850: 7477 6f72 6b3a 2069 6e74 0a20 2020 2020  twork: int.     
+0001c860: 2020 2020 2020 2049 6e64 6578 206f 6620         Index of 
+0001c870: 7468 6520 6e65 7477 6f72 6b20 7472 6169  the network trai
+0001c880: 6e65 6420 2875 7365 6420 696e 206d 756c  ned (used in mul
+0001c890: 7469 2d6e 6574 776f 726b 2073 6574 7469  ti-network setti
+0001c8a0: 6e67 206f 6e6c 7929 2e0a 2020 2020 2020  ng only)..      
+0001c8b0: 2020 6d61 705f 6c6f 6361 7469 6f6e 3a20    map_location: 
+0001c8c0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
+0001c8d0: 746f 7263 682e 6465 7669 6365 206f 626a  torch.device obj
+0001c8e0: 6563 7420 6f72 2061 2073 7472 696e 6720  ect or a string 
+0001c8f0: 636f 6e74 6169 6e69 6e67 2061 2064 6576  containing a dev
+0001c900: 6963 6520 7461 672c 0a20 2020 2020 2020  ice tag,.       
+0001c910: 2020 2020 2069 7420 696e 6469 6361 7465       it indicate
+0001c920: 7320 7468 6520 6c6f 6361 7469 6f6e 2077  s the location w
+0001c930: 6865 7265 2061 6c6c 2074 656e 736f 7273  here all tensors
+0001c940: 2073 686f 756c 6420 6265 206c 6f61 6465   should be loade
+0001c950: 642e 0a20 2020 2020 2020 2020 2020 2028  d..            (
+0001c960: 7365 6520 6874 7470 733a 2f2f 7079 746f  see https://pyto
+0001c970: 7263 682e 6f72 672f 646f 6373 2f73 7461  rch.org/docs/sta
+0001c980: 626c 652f 6765 6e65 7261 7465 642f 746f  ble/generated/to
+0001c990: 7263 682e 6c6f 6164 2e68 746d 6c29 2e0a  rch.load.html)..
+0001c9a0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0001c9b0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0001c9c0: 0a20 2020 2020 2020 2020 2020 2028 4469  .            (Di
+0001c9d0: 6374 293a 2064 6963 7469 6f6e 6172 7920  ct): dictionary 
+0001c9e0: 6f66 2072 6573 756c 7473 2028 7765 6967  of results (weig
+0001c9f0: 6874 732c 2065 706f 6368 206e 756d 6265  hts, epoch numbe
+0001ca00: 722c 206d 6574 7269 6373 2076 616c 7565  r, metrics value
+0001ca10: 7329 0a20 2020 2020 2020 2022 2222 0a20  s).        """. 
+0001ca20: 2020 2020 2020 2073 656c 6563 7469 6f6e         selection
+0001ca30: 5f6d 6574 7269 6320 3d20 7365 6c66 2e5f  _metric = self._
+0001ca40: 6368 6563 6b5f 7365 6c65 6374 696f 6e5f  check_selection_
+0001ca50: 6d65 7472 6963 2873 706c 6974 2c20 7365  metric(split, se
+0001ca60: 6c65 6374 696f 6e5f 6d65 7472 6963 290a  lection_metric).
+0001ca70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001ca80: 6d75 6c74 695f 6e65 7477 6f72 6b3a 0a20  multi_network:. 
+0001ca90: 2020 2020 2020 2020 2020 2069 6620 6e65             if ne
+0001caa0: 7477 6f72 6b20 6973 204e 6f6e 653a 0a20  twork is None:. 
+0001cab0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001cac0: 6169 7365 2043 6c69 6e69 6361 444c 4172  aise ClinicaDLAr
+0001cad0: 6775 6d65 6e74 4572 726f 7228 0a20 2020  gumentError(.   
+0001cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001caf0: 2022 506c 6561 7365 2070 7265 6369 7365   "Please precise
+0001cb00: 2074 6865 206e 6574 776f 726b 206e 756d   the network num
+0001cb10: 6265 7220 7468 6174 206d 7573 7420 6265  ber that must be
+0001cb20: 206c 6f61 6465 642e 220a 2020 2020 2020   loaded.".      
+0001cb30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001cb40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001cb50: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0001cb60: 6465 6c5f 7061 7468 203d 2028 0a20 2020  del_path = (.   
+0001cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb80: 2073 656c 662e 6d61 7073 5f70 6174 680a   self.maps_path.
+0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cba0: 2020 2020 2f20 6622 7b73 656c 662e 7370      / f"{self.sp
+0001cbb0: 6c69 745f 6e61 6d65 7d2d 7b73 706c 6974  lit_name}-{split
+0001cbc0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0001cbd0: 2020 2020 2020 202f 2066 2262 6573 742d         / f"best-
+0001cbe0: 7b73 656c 6563 7469 6f6e 5f6d 6574 7269  {selection_metri
+0001cbf0: 637d 220a 2020 2020 2020 2020 2020 2020  c}".            
+0001cc00: 2020 2020 2020 2020 2f20 6622 6e65 7477          / f"netw
+0001cc10: 6f72 6b2d 7b6e 6574 776f 726b 7d5f 6d6f  ork-{network}_mo
+0001cc20: 6465 6c2e 7074 682e 7461 7222 0a20 2020  del.pth.tar".   
+0001cc30: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0001cc40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001cc50: 2020 2020 2020 2020 206d 6f64 656c 5f70           model_p
+0001cc60: 6174 6820 3d20 280a 2020 2020 2020 2020  ath = (.        
+0001cc70: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
+0001cc80: 735f 7061 7468 0a20 2020 2020 2020 2020  s_path.         
+0001cc90: 2020 2020 2020 202f 2066 227b 7365 6c66         / f"{self
+0001cca0: 2e73 706c 6974 5f6e 616d 657d 2d7b 7370  .split_name}-{sp
+0001ccb0: 6c69 747d 220a 2020 2020 2020 2020 2020  lit}".          
+0001ccc0: 2020 2020 2020 2f20 6622 6265 7374 2d7b        / f"best-{
+0001ccd0: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
+0001cce0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0001ccf0: 2020 202f 2022 6d6f 6465 6c2e 7074 682e     / "model.pth.
+0001cd00: 7461 7222 0a20 2020 2020 2020 2020 2020  tar".           
+0001cd10: 2029 0a0a 2020 2020 2020 2020 6c6f 6767   )..        logg
+0001cd20: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+0001cd30: 2020 2020 2066 224c 6f61 6469 6e67 206d       f"Loading m
+0001cd40: 6f64 656c 2074 7261 696e 6564 2066 6f72  odel trained for
+0001cd50: 2073 706c 6974 207b 7370 6c69 747d 2022   split {split} "
+0001cd60: 0a20 2020 2020 2020 2020 2020 2066 2273  .            f"s
+0001cd70: 656c 6563 7465 6420 6163 636f 7264 696e  elected accordin
+0001cd80: 6720 746f 2062 6573 7420 7661 6c69 6461  g to best valida
+0001cd90: 7469 6f6e 207b 7365 6c65 6374 696f 6e5f  tion {selection_
+0001cda0: 6d65 7472 6963 7d20 220a 2020 2020 2020  metric} ".      
+0001cdb0: 2020 2020 2020 6622 6174 2070 6174 6820        f"at path 
+0001cdc0: 7b6d 6f64 656c 5f70 6174 687d 2e22 0a20  {model_path}.". 
+0001cdd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001cde0: 2072 6574 7572 6e20 746f 7263 682e 6c6f   return torch.lo
+0001cdf0: 6164 286d 6f64 656c 5f70 6174 682c 206d  ad(model_path, m
+0001ce00: 6170 5f6c 6f63 6174 696f 6e3d 6d61 705f  ap_location=map_
+0001ce10: 6c6f 6361 7469 6f6e 290a 0a20 2020 2064  location)..    d
+0001ce20: 6566 2067 6574 5f70 7265 6469 6374 696f  ef get_predictio
+0001ce30: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
+0001ce40: 0a20 2020 2020 2020 2064 6174 615f 6772  .        data_gr
+0001ce50: 6f75 703a 2073 7472 2c0a 2020 2020 2020  oup: str,.      
+0001ce60: 2020 7370 6c69 743a 2069 6e74 203d 2030    split: int = 0
+0001ce70: 2c0a 2020 2020 2020 2020 7365 6c65 6374  ,.        select
+0001ce80: 696f 6e5f 6d65 7472 6963 3a20 4f70 7469  ion_metric: Opti
+0001ce90: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+0001cea0: 2c0a 2020 2020 2020 2020 6d6f 6465 3a20  ,.        mode: 
+0001ceb0: 7374 7220 3d20 2269 6d61 6765 222c 0a20  str = "image",. 
+0001cec0: 2020 2020 2020 2076 6572 626f 7365 3a20         verbose: 
+0001ced0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+0001cee0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+0001cef0: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
+0001cf00: 2069 6e64 6976 6964 7561 6c20 7072 6564   individual pred
+0001cf10: 6963 7469 6f6e 7320 666f 7220 6561 6368  ictions for each
+0001cf20: 2070 6172 7469 6369 7061 6e74 2063 6f72   participant cor
+0001cf30: 7265 7370 6f6e 6469 6e67 2074 6f20 6f6e  responding to on
+0001cf40: 6520 6772 6f75 700a 2020 2020 2020 2020  e group.        
+0001cf50: 6f66 2070 6172 7469 6369 7061 6e74 7320  of participants 
+0001cf60: 6964 656e 7469 6669 6564 2062 7920 6974  identified by it
+0001cf70: 7320 6461 7461 2067 726f 7570 2e0a 0a20  s data group... 
+0001cf80: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0001cf90: 2020 2020 2020 2020 2064 6174 615f 6772           data_gr
+0001cfa0: 6f75 7020 2873 7472 293a 206e 616d 6520  oup (str): name 
+0001cfb0: 6f66 2074 6865 2064 6174 6120 6772 6f75  of the data grou
+0001cfc0: 7020 7573 6564 2066 6f72 2074 6865 2070  p used for the p
+0001cfd0: 7265 6469 6374 696f 6e20 7461 736b 2e0a  rediction task..
+0001cfe0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+0001cff0: 7420 2869 6e74 293a 2049 6e64 6578 206f  t (int): Index o
+0001d000: 6620 7468 6520 7370 6c69 7420 7573 6564  f the split used
+0001d010: 2066 6f72 2074 7261 696e 696e 672e 0a20   for training.. 
+0001d020: 2020 2020 2020 2020 2020 2073 656c 6563             selec
+0001d030: 7469 6f6e 5f6d 6574 7269 6320 2873 7472  tion_metric (str
+0001d040: 293a 204d 6574 7269 6320 7573 6564 2066  ): Metric used f
+0001d050: 6f72 2062 6573 7420 7765 6967 6874 7320  or best weights 
+0001d060: 7365 6c65 6374 696f 6e2e 0a20 2020 2020  selection..     
+0001d070: 2020 2020 2020 206d 6f64 6520 2873 7472         mode (str
+0001d080: 293a 206c 6576 656c 206f 6620 7468 6520  ): level of the 
+0001d090: 7072 6564 6963 7469 6f6e 2e0a 2020 2020  prediction..    
+0001d0a0: 2020 2020 2020 2020 7665 7262 6f73 6520          verbose 
+0001d0b0: 2862 6f6f 6c29 3a20 6966 2054 7275 6520  (bool): if True 
+0001d0c0: 7769 6c6c 2070 7269 6e74 2061 7373 6f63  will print assoc
+0001d0d0: 6961 7465 6420 7072 6564 6963 7469 6f6e  iated prediction
+0001d0e0: 2e6c 6f67 2e0a 2020 2020 2020 2020 5265  .log..        Re
+0001d0f0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+0001d100: 2020 2028 4461 7461 4672 616d 6529 3a20     (DataFrame): 
+0001d110: 5265 7375 6c74 7320 696e 6465 7865 6420  Results indexed 
+0001d120: 6279 2063 6f6c 756d 6e73 2027 7061 7274  by columns 'part
+0001d130: 6963 6970 616e 745f 6964 2720 616e 6420  icipant_id' and 
+0001d140: 2773 6573 7369 6f6e 5f69 6427 2077 6869  'session_id' whi
+0001d150: 6368 0a20 2020 2020 2020 2020 2020 2069  ch.            i
+0001d160: 6465 6e74 6966 6965 7320 7468 6520 696d  dentifies the im
+0001d170: 6167 6520 696e 2074 6865 2042 4944 5320  age in the BIDS 
+0001d180: 2f20 4341 5053 2e0a 2020 2020 2020 2020  / CAPS..        
+0001d190: 2222 220a 2020 2020 2020 2020 7365 6c65  """.        sele
+0001d1a0: 6374 696f 6e5f 6d65 7472 6963 203d 2073  ction_metric = s
+0001d1b0: 656c 662e 5f63 6865 636b 5f73 656c 6563  elf._check_selec
+0001d1c0: 7469 6f6e 5f6d 6574 7269 6328 7370 6c69  tion_metric(spli
+0001d1d0: 742c 2073 656c 6563 7469 6f6e 5f6d 6574  t, selection_met
+0001d1e0: 7269 6329 0a20 2020 2020 2020 2069 6620  ric).        if 
+0001d1f0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0001d200: 2020 2020 2073 656c 662e 5f70 7269 6e74       self._print
+0001d210: 5f64 6573 6372 6970 7469 6f6e 5f6c 6f67  _description_log
+0001d220: 2864 6174 615f 6772 6f75 702c 2073 706c  (data_group, spl
+0001d230: 6974 2c20 7365 6c65 6374 696f 6e5f 6d65  it, selection_me
+0001d240: 7472 6963 290a 2020 2020 2020 2020 7072  tric).        pr
+0001d250: 6564 6963 7469 6f6e 5f64 6972 203d 2028  ediction_dir = (
+0001d260: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001d270: 662e 6d61 7073 5f70 6174 680a 2020 2020  f.maps_path.    
+0001d280: 2020 2020 2020 2020 2f20 6622 7b73 656c          / f"{sel
+0001d290: 662e 7370 6c69 745f 6e61 6d65 7d2d 7b73  f.split_name}-{s
+0001d2a0: 706c 6974 7d22 0a20 2020 2020 2020 2020  plit}".         
+0001d2b0: 2020 202f 2066 2262 6573 742d 7b73 656c     / f"best-{sel
+0001d2c0: 6563 7469 6f6e 5f6d 6574 7269 637d 220a  ection_metric}".
+0001d2d0: 2020 2020 2020 2020 2020 2020 2f20 6461              / da
+0001d2e0: 7461 5f67 726f 7570 0a20 2020 2020 2020  ta_group.       
+0001d2f0: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
+0001d300: 7420 7072 6564 6963 7469 6f6e 5f64 6972  t prediction_dir
+0001d310: 2e69 735f 6469 7228 293a 0a20 2020 2020  .is_dir():.     
+0001d320: 2020 2020 2020 2072 6169 7365 204d 4150         raise MAP
+0001d330: 5345 7272 6f72 280a 2020 2020 2020 2020  SError(.        
+0001d340: 2020 2020 2020 2020 6622 4e6f 2070 7265          f"No pre
+0001d350: 6469 6374 696f 6e20 636f 7272 6573 706f  diction correspo
+0001d360: 6e64 696e 6720 746f 2064 6174 6120 6772  nding to data gr
+0001d370: 6f75 7020 7b64 6174 615f 6772 6f75 707d  oup {data_group}
+0001d380: 2077 6173 2066 6f75 6e64 2e22 0a20 2020   was found.".   
+0001d390: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001d3a0: 2020 2064 6620 3d20 7064 2e72 6561 645f     df = pd.read_
+0001d3b0: 6373 7628 0a20 2020 2020 2020 2020 2020  csv(.           
+0001d3c0: 2070 7265 6469 6374 696f 6e5f 6469 7220   prediction_dir 
+0001d3d0: 2f20 6622 7b64 6174 615f 6772 6f75 707d  / f"{data_group}
+0001d3e0: 5f7b 6d6f 6465 7d5f 6c65 7665 6c5f 7072  _{mode}_level_pr
+0001d3f0: 6564 6963 7469 6f6e 2e74 7376 222c 0a20  ediction.tsv",. 
+0001d400: 2020 2020 2020 2020 2020 2073 6570 3d22             sep="
+0001d410: 5c74 222c 0a20 2020 2020 2020 2029 0a20  \t",.        ). 
+0001d420: 2020 2020 2020 2064 662e 7365 745f 696e         df.set_in
+0001d430: 6465 7828 5b22 7061 7274 6963 6970 616e  dex(["participan
+0001d440: 745f 6964 222c 2022 7365 7373 696f 6e5f  t_id", "session_
+0001d450: 6964 225d 2c20 696e 706c 6163 653d 5472  id"], inplace=Tr
+0001d460: 7565 2c20 6472 6f70 3d54 7275 6529 0a20  ue, drop=True). 
+0001d470: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+0001d480: 0a0a 2020 2020 6465 6620 6765 745f 6d65  ..    def get_me
+0001d490: 7472 6963 7328 0a20 2020 2020 2020 2073  trics(.        s
+0001d4a0: 656c 662c 0a20 2020 2020 2020 2064 6174  elf,.        dat
+0001d4b0: 615f 6772 6f75 703a 2073 7472 2c0a 2020  a_group: str,.  
+0001d4c0: 2020 2020 2020 7370 6c69 743a 2069 6e74        split: int
+0001d4d0: 203d 2030 2c0a 2020 2020 2020 2020 7365   = 0,.        se
+0001d4e0: 6c65 6374 696f 6e5f 6d65 7472 6963 3a20  lection_metric: 
+0001d4f0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+0001d500: 4e6f 6e65 2c0a 2020 2020 2020 2020 6d6f  None,.        mo
+0001d510: 6465 3a20 7374 7220 3d20 2269 6d61 6765  de: str = "image
+0001d520: 222c 0a20 2020 2020 2020 2076 6572 626f  ",.        verbo
+0001d530: 7365 3a20 626f 6f6c 203d 2054 7275 652c  se: bool = True,
+0001d540: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0001d550: 2222 220a 2020 2020 2020 2020 4765 7420  """.        Get 
+0001d560: 7468 6520 6d65 7472 6963 7320 636f 7272  the metrics corr
+0001d570: 6573 706f 6e64 696e 6720 746f 2061 2067  esponding to a g
+0001d580: 726f 7570 206f 6620 7061 7274 6963 6970  roup of particip
+0001d590: 616e 7473 2069 6465 6e74 6966 6965 6420  ants identified 
+0001d5a0: 6279 2069 7473 2064 6174 615f 6772 6f75  by its data_grou
+0001d5b0: 702e 0a0a 2020 2020 2020 2020 4172 6773  p...        Args
+0001d5c0: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
+0001d5d0: 7461 5f67 726f 7570 2028 7374 7229 3a20  ta_group (str): 
+0001d5e0: 6e61 6d65 206f 6620 7468 6520 6461 7461  name of the data
+0001d5f0: 2067 726f 7570 2075 7365 6420 666f 7220   group used for 
+0001d600: 7468 6520 7072 6564 6963 7469 6f6e 2074  the prediction t
+0001d610: 6173 6b2e 0a20 2020 2020 2020 2020 2020  ask..           
+0001d620: 2073 706c 6974 2028 696e 7429 3a20 496e   split (int): In
+0001d630: 6465 7820 6f66 2074 6865 2073 706c 6974  dex of the split
+0001d640: 2075 7365 6420 666f 7220 7472 6169 6e69   used for traini
+0001d650: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0001d660: 7365 6c65 6374 696f 6e5f 6d65 7472 6963  selection_metric
+0001d670: 2028 7374 7229 3a20 4d65 7472 6963 2075   (str): Metric u
+0001d680: 7365 6420 666f 7220 6265 7374 2077 6569  sed for best wei
+0001d690: 6768 7473 2073 656c 6563 7469 6f6e 2e0a  ghts selection..
+0001d6a0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0001d6b0: 2028 7374 7229 3a20 6c65 7665 6c20 6f66   (str): level of
+0001d6c0: 2074 6865 2070 7265 6469 6374 696f 6e0a   the prediction.
+0001d6d0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+0001d6e0: 6f73 6520 2862 6f6f 6c29 3a20 6966 2054  ose (bool): if T
+0001d6f0: 7275 6520 7769 6c6c 2070 7269 6e74 2061  rue will print a
+0001d700: 7373 6f63 6961 7465 6420 7072 6564 6963  ssociated predic
+0001d710: 7469 6f6e 2e6c 6f67 0a20 2020 2020 2020  tion.log.       
+0001d720: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001d730: 2020 2020 2020 2864 6963 745b 7374 723a        (dict[str:
+0001d740: 666c 6f61 745d 293a 2056 616c 7565 7320  float]): Values 
+0001d750: 6f66 2074 6865 206d 6574 7269 6373 0a20  of the metrics. 
+0001d760: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001d770: 2020 2073 656c 6563 7469 6f6e 5f6d 6574     selection_met
+0001d780: 7269 6320 3d20 7365 6c66 2e5f 6368 6563  ric = self._chec
+0001d790: 6b5f 7365 6c65 6374 696f 6e5f 6d65 7472  k_selection_metr
+0001d7a0: 6963 2873 706c 6974 2c20 7365 6c65 6374  ic(split, select
+0001d7b0: 696f 6e5f 6d65 7472 6963 290a 2020 2020  ion_metric).    
+0001d7c0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+0001d7d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001d7e0: 2e5f 7072 696e 745f 6465 7363 7269 7074  ._print_descript
+0001d7f0: 696f 6e5f 6c6f 6728 6461 7461 5f67 726f  ion_log(data_gro
+0001d800: 7570 2c20 7370 6c69 742c 2073 656c 6563  up, split, selec
+0001d810: 7469 6f6e 5f6d 6574 7269 6329 0a20 2020  tion_metric).   
+0001d820: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+0001d830: 6469 7220 3d20 280a 2020 2020 2020 2020  dir = (.        
+0001d840: 2020 2020 7365 6c66 2e6d 6170 735f 7061      self.maps_pa
+0001d850: 7468 0a20 2020 2020 2020 2020 2020 202f  th.            /
+0001d860: 2066 227b 7365 6c66 2e73 706c 6974 5f6e   f"{self.split_n
+0001d870: 616d 657d 2d7b 7370 6c69 747d 220a 2020  ame}-{split}".  
+0001d880: 2020 2020 2020 2020 2020 2f20 6622 6265            / f"be
+0001d890: 7374 2d7b 7365 6c65 6374 696f 6e5f 6d65  st-{selection_me
+0001d8a0: 7472 6963 7d22 0a20 2020 2020 2020 2020  tric}".         
+0001d8b0: 2020 202f 2064 6174 615f 6772 6f75 700a     / data_group.
+0001d8c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001d8d0: 2020 6966 206e 6f74 2070 7265 6469 6374    if not predict
+0001d8e0: 696f 6e5f 6469 722e 6973 5f64 6972 2829  ion_dir.is_dir()
+0001d8f0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0001d900: 6973 6520 4d41 5053 4572 726f 7228 0a20  ise MAPSError(. 
+0001d910: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001d920: 224e 6f20 7072 6564 6963 7469 6f6e 2063  "No prediction c
+0001d930: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+0001d940: 6461 7461 2067 726f 7570 207b 6461 7461  data group {data
+0001d950: 5f67 726f 7570 7d20 7761 7320 666f 756e  _group} was foun
+0001d960: 642e 220a 2020 2020 2020 2020 2020 2020  d.".            
+0001d970: 290a 2020 2020 2020 2020 6466 203d 2070  ).        df = p
+0001d980: 642e 7265 6164 5f63 7376 280a 2020 2020  d.read_csv(.    
+0001d990: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+0001d9a0: 6f6e 5f64 6972 202f 2066 227b 6461 7461  on_dir / f"{data
+0001d9b0: 5f67 726f 7570 7d5f 7b6d 6f64 657d 5f6c  _group}_{mode}_l
+0001d9c0: 6576 656c 5f6d 6574 7269 6373 2e74 7376  evel_metrics.tsv
+0001d9d0: 222c 2073 6570 3d22 5c74 220a 2020 2020  ", sep="\t".    
+0001d9e0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0001d9f0: 7475 726e 2064 662e 746f 5f64 6963 7428  turn df.to_dict(
+0001da00: 2272 6563 6f72 6473 2229 5b30 5d0a 0a20  "records")[0].. 
+0001da10: 2020 2064 6566 2067 6574 5f69 6e74 6572     def get_inter
+0001da20: 7072 6574 6174 696f 6e28 0a20 2020 2020  pretation(.     
+0001da30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0001da40: 2064 6174 615f 6772 6f75 703a 2073 7472   data_group: str
+0001da50: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
+0001da60: 7374 722c 0a20 2020 2020 2020 2073 706c  str,.        spl
+0001da70: 6974 3a20 696e 7420 3d20 302c 0a20 2020  it: int = 0,.   
+0001da80: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
+0001da90: 6574 7269 633a 204f 7074 696f 6e61 6c5b  etric: Optional[
+0001daa0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+0001dab0: 2020 2020 2076 6572 626f 7365 3a20 626f       verbose: bo
+0001dac0: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+0001dad0: 2020 2070 6172 7469 6369 7061 6e74 5f69     participant_i
+0001dae0: 643a 204f 7074 696f 6e61 6c5b 7374 725d  d: Optional[str]
+0001daf0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0001db00: 2073 6573 7369 6f6e 5f69 643a 204f 7074   session_id: Opt
+0001db10: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+0001db20: 652c 0a20 2020 2020 2020 206d 6f64 655f  e,.        mode_
+0001db30: 6964 3a20 696e 7420 3d20 302c 0a20 2020  id: int = 0,.   
+0001db40: 2029 202d 3e20 746f 7263 682e 5465 6e73   ) -> torch.Tens
+0001db50: 6f72 3a0a 2020 2020 2020 2020 2222 220a  or:.        """.
+0001db60: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+0001db70: 696e 6469 7669 6475 616c 2069 6e74 6572  individual inter
+0001db80: 7072 6574 6174 696f 6e20 6d61 7073 2066  pretation maps f
+0001db90: 6f72 206f 6e65 2073 6573 7369 6f6e 2069  or one session i
+0001dba0: 6620 7061 7274 6963 6970 616e 745f 6964  f participant_id
+0001dbb0: 2061 6e64 2073 6573 7369 6f6e 5f69 6420   and session_id 
+0001dbc0: 6172 6520 6669 6c6c 6564 2e0a 2020 2020  are filled..    
+0001dbd0: 2020 2020 456c 7365 206c 6f61 6420 7468      Else load th
+0001dbe0: 6520 6d65 616e 2069 6e74 6572 7072 6574  e mean interpret
+0001dbf0: 6174 696f 6e20 6d61 702e 0a0a 2020 2020  ation map...    
+0001dc00: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001dc10: 2020 2020 2020 6461 7461 5f67 726f 7570        data_group
+0001dc20: 2028 7374 7229 3a20 4e61 6d65 206f 6620   (str): Name of 
+0001dc30: 7468 6520 6461 7461 2067 726f 7570 2075  the data group u
+0001dc40: 7365 6420 666f 7220 7468 6520 696e 7465  sed for the inte
+0001dc50: 7270 7265 7461 7469 6f6e 2074 6173 6b2e  rpretation task.
+0001dc60: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001dc70: 6520 2873 7472 293a 206e 616d 6520 6f66  e (str): name of
+0001dc80: 2074 6865 2069 6e74 6572 7072 6574 6174   the interpretat
+0001dc90: 696f 6e20 7461 736b 2e0a 2020 2020 2020  ion task..      
+0001dca0: 2020 2020 2020 7370 6c69 7420 2869 6e74        split (int
+0001dcb0: 293a 2049 6e64 6578 206f 6620 7468 6520  ): Index of the 
+0001dcc0: 7370 6c69 7420 7573 6564 2066 6f72 2074  split used for t
+0001dcd0: 7261 696e 696e 672e 0a20 2020 2020 2020  raining..       
+0001dce0: 2020 2020 2073 656c 6563 7469 6f6e 5f6d       selection_m
+0001dcf0: 6574 7269 6320 2873 7472 293a 204d 6574  etric (str): Met
+0001dd00: 7269 6320 7573 6564 2066 6f72 2062 6573  ric used for bes
+0001dd10: 7420 7765 6967 6874 7320 7365 6c65 6374  t weights select
+0001dd20: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+0001dd30: 2076 6572 626f 7365 2028 626f 6f6c 293a   verbose (bool):
+0001dd40: 2069 6620 5472 7565 2077 696c 6c20 7072   if True will pr
+0001dd50: 696e 7420 6173 736f 6369 6174 6564 2070  int associated p
+0001dd60: 7265 6469 6374 696f 6e2e 6c6f 672e 0a20  rediction.log.. 
+0001dd70: 2020 2020 2020 2020 2020 2070 6172 7469             parti
+0001dd80: 6369 7061 6e74 5f69 6420 2873 7472 293a  cipant_id (str):
+0001dd90: 2049 4420 6f66 2074 6865 2070 6172 7469   ID of the parti
+0001dda0: 6369 7061 6e74 2028 6966 206e 6f74 2067  cipant (if not g
+0001ddb0: 6976 656e 206c 6f61 6420 6d65 616e 206d  iven load mean m
+0001ddc0: 6170 292e 0a20 2020 2020 2020 2020 2020  ap)..           
+0001ddd0: 2073 6573 7369 6f6e 5f69 6420 2873 7472   session_id (str
+0001dde0: 293a 2049 4420 6f66 2074 6865 2073 6573  ): ID of the ses
+0001ddf0: 7369 6f6e 2028 6966 206e 6f74 2067 6976  sion (if not giv
+0001de00: 6520 6c6f 6164 2074 6865 206d 6561 6e20  e load the mean 
+0001de10: 6d61 7029 2e0a 2020 2020 2020 2020 2020  map)..          
+0001de20: 2020 6d6f 6465 5f69 6420 2869 6e74 293a    mode_id (int):
+0001de30: 2049 6e64 6578 206f 6620 7468 6520 6d6f   Index of the mo
+0001de40: 6465 2075 7365 642e 0a20 2020 2020 2020  de used..       
+0001de50: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001de60: 2020 2020 2020 2874 6f72 6368 2e54 656e        (torch.Ten
+0001de70: 736f 7229 3a20 5465 6e73 6f72 206f 6620  sor): Tensor of 
+0001de80: 7468 6520 696e 7465 7270 7265 7461 6269  the interpretabi
+0001de90: 6c69 7479 206d 6170 2e0a 2020 2020 2020  lity map..      
+0001dea0: 2020 2222 220a 0a20 2020 2020 2020 2073    """..        s
+0001deb0: 656c 6563 7469 6f6e 5f6d 6574 7269 6320  election_metric 
+0001dec0: 3d20 7365 6c66 2e5f 6368 6563 6b5f 7365  = self._check_se
+0001ded0: 6c65 6374 696f 6e5f 6d65 7472 6963 2873  lection_metric(s
+0001dee0: 706c 6974 2c20 7365 6c65 6374 696f 6e5f  plit, selection_
+0001def0: 6d65 7472 6963 290a 2020 2020 2020 2020  metric).        
+0001df00: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0001df10: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
+0001df20: 696e 745f 6465 7363 7269 7074 696f 6e5f  int_description_
+0001df30: 6c6f 6728 6461 7461 5f67 726f 7570 2c20  log(data_group, 
+0001df40: 7370 6c69 742c 2073 656c 6563 7469 6f6e  split, selection
+0001df50: 5f6d 6574 7269 6329 0a20 2020 2020 2020  _metric).       
+0001df60: 206d 6170 5f64 6972 203d 2028 0a20 2020   map_dir = (.   
+0001df70: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+0001df80: 7073 5f70 6174 680a 2020 2020 2020 2020  ps_path.        
+0001df90: 2020 2020 2f20 6622 7b73 656c 662e 7370      / f"{self.sp
+0001dfa0: 6c69 745f 6e61 6d65 7d2d 7b73 706c 6974  lit_name}-{split
+0001dfb0: 7d22 0a20 2020 2020 2020 2020 2020 202f  }".            /
+0001dfc0: 2066 2262 6573 742d 7b73 656c 6563 7469   f"best-{selecti
+0001dfd0: 6f6e 5f6d 6574 7269 637d 220a 2020 2020  on_metric}".    
+0001dfe0: 2020 2020 2020 2020 2f20 6461 7461 5f67          / data_g
+0001dff0: 726f 7570 0a20 2020 2020 2020 2020 2020  roup.           
+0001e000: 202f 2066 2269 6e74 6572 7072 6574 2d7b   / f"interpret-{
+0001e010: 6e61 6d65 7d22 0a20 2020 2020 2020 2029  name}".        )
+0001e020: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001e030: 6d61 705f 6469 722e 6973 5f64 6972 2829  map_dir.is_dir()
+0001e040: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0001e050: 6973 6520 4d41 5053 4572 726f 7228 0a20  ise MAPSError(. 
+0001e060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e070: 224e 6f20 7072 6564 6963 7469 6f6e 2063  "No prediction c
+0001e080: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+0001e090: 6461 7461 2067 726f 7570 207b 6461 7461  data group {data
+0001e0a0: 5f67 726f 7570 7d20 616e 6420 220a 2020  _group} and ".  
+0001e0b0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001e0c0: 696e 7465 7270 7265 7461 7469 6f6e 207b  interpretation {
+0001e0d0: 6e61 6d65 7d20 7761 7320 666f 756e 642e  name} was found.
+0001e0e0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0001e0f0: 2020 2020 2020 2020 6966 2070 6172 7469          if parti
+0001e100: 6369 7061 6e74 5f69 6420 6973 204e 6f6e  cipant_id is Non
+0001e110: 6520 616e 6420 7365 7373 696f 6e5f 6964  e and session_id
+0001e120: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001e130: 2020 2020 2020 6d61 705f 7074 203d 2074        map_pt = t
+0001e140: 6f72 6368 2e6c 6f61 6428 6d61 705f 6469  orch.load(map_di
+0001e150: 7220 2f20 6622 6d65 616e 5f7b 7365 6c66  r / f"mean_{self
+0001e160: 2e6d 6f64 657d 2d7b 6d6f 6465 5f69 647d  .mode}-{mode_id}
+0001e170: 5f6d 6170 2e70 7422 290a 2020 2020 2020  _map.pt").      
+0001e180: 2020 656c 6966 2070 6172 7469 6369 7061    elif participa
+0001e190: 6e74 5f69 6420 6973 204e 6f6e 6520 6f72  nt_id is None or
+0001e1a0: 2073 6573 7369 6f6e 5f69 6420 6973 204e   session_id is N
+0001e1b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001e1c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0001e1d0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001e1e0: 2020 2066 2254 6f20 6c6f 6164 2074 6865     f"To load the
+0001e1f0: 206d 6561 6e20 696e 7465 7270 7265 7461   mean interpreta
+0001e200: 7469 6f6e 206d 6170 2c20 220a 2020 2020  tion map, ".    
+0001e210: 2020 2020 2020 2020 2020 2020 6622 706c              f"pl
+0001e220: 6561 7365 2064 6f20 6e6f 7420 6769 7665  ease do not give
+0001e230: 2061 6e79 2070 6172 7469 6369 7061 6e74   any participant
+0001e240: 5f69 6420 6f72 2073 6573 7369 6f6e 5f69  _id or session_i
+0001e250: 642e 5c6e 2022 0a20 2020 2020 2020 2020  d.\n ".         
+0001e260: 2020 2020 2020 2066 2245 6c73 6520 7370         f"Else sp
+0001e270: 6563 6966 7920 626f 7468 2070 6172 616d  ecify both param
+0001e280: 6574 6572 7322 0a20 2020 2020 2020 2020  eters".         
+0001e290: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+0001e2a0: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
+0001e2b0: 6170 5f70 7420 3d20 746f 7263 682e 6c6f  ap_pt = torch.lo
+0001e2c0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
+0001e2d0: 2020 2020 6d61 705f 6469 7220 2f20 6622      map_dir / f"
+0001e2e0: 7b70 6172 7469 6369 7061 6e74 5f69 647d  {participant_id}
+0001e2f0: 5f7b 7365 7373 696f 6e5f 6964 7d5f 7b73  _{session_id}_{s
+0001e300: 656c 662e 6d6f 6465 7d2d 7b6d 6f64 655f  elf.mode}-{mode_
+0001e310: 6964 7d5f 6d61 702e 7074 220a 2020 2020  id}_map.pt".    
+0001e320: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001e330: 2020 7265 7475 726e 206d 6170 5f70 740a    return map_pt.
+0001e340: 0a20 2020 2064 6566 205f 696e 6974 5f63  .    def _init_c
+0001e350: 616c 6c62 6163 6b73 2873 656c 6629 3a0a  allbacks(self):.
+0001e360: 2020 2020 2020 2020 6672 6f6d 2063 6c69          from cli
+0001e370: 6e69 6361 646c 2e75 7469 6c73 2e63 616c  nicadl.utils.cal
+0001e380: 6c62 6163 6b73 2e63 616c 6c62 6163 6b73  lbacks.callbacks
+0001e390: 2069 6d70 6f72 7420 280a 2020 2020 2020   import (.      
+0001e3a0: 2020 2020 2020 4361 6c6c 6261 636b 2c0a        Callback,.
+0001e3b0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0001e3c0: 6261 636b 7348 616e 646c 6572 2c0a 2020  backsHandler,.  
+0001e3d0: 2020 2020 2020 2020 2020 4c6f 6767 6572            Logger
+0001e3e0: 4361 6c6c 6261 636b 2c0a 2020 2020 2020  Callback,.      
+0001e3f0: 2020 290a 0a20 2020 2020 2020 2023 2069    )..        # i
+0001e400: 6620 7365 6c66 2e63 616c 6c62 6163 6b73  f self.callbacks
+0001e410: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001e420: 2020 2320 2020 2020 7365 6c66 2e63 616c    #     self.cal
+0001e430: 6c62 6163 6b73 203d 205b 4361 6c6c 6261  lbacks = [Callba
+0001e440: 636b 2829 5d0a 0a20 2020 2020 2020 2073  ck()]..        s
+0001e450: 656c 662e 6361 6c6c 6261 636b 5f68 616e  elf.callback_han
+0001e460: 646c 6572 203d 2043 616c 6c62 6163 6b73  dler = Callbacks
+0001e470: 4861 6e64 6c65 7228 2920 2023 2063 616c  Handler()  # cal
+0001e480: 6c62 6163 6b73 3d73 656c 662e 6361 6c6c  lbacks=self.call
+0001e490: 6261 636b 7329 0a0a 2020 2020 2020 2020  backs)..        
+0001e4a0: 6966 2073 656c 662e 7061 7261 6d65 7465  if self.paramete
+0001e4b0: 7273 5b22 656d 6973 7369 6f6e 735f 6361  rs["emissions_ca
+0001e4c0: 6c63 756c 6174 6f72 225d 3a0a 2020 2020  lculator"]:.    
+0001e4d0: 2020 2020 2020 2020 6672 6f6d 2063 6c69          from cli
+0001e4e0: 6e69 6361 646c 2e75 7469 6c73 2e63 616c  nicadl.utils.cal
+0001e4f0: 6c62 6163 6b73 2e63 616c 6c62 6163 6b73  lbacks.callbacks
+0001e500: 2069 6d70 6f72 7420 436f 6465 4361 7262   import CodeCarb
+0001e510: 6f6e 5472 6163 6b65 720a 0a20 2020 2020  onTracker..     
+0001e520: 2020 2020 2020 2073 656c 662e 6361 6c6c         self.call
+0001e530: 6261 636b 5f68 616e 646c 6572 2e61 6464  back_handler.add
+0001e540: 5f63 616c 6c62 6163 6b28 436f 6465 4361  _callback(CodeCa
+0001e550: 7262 6f6e 5472 6163 6b65 7228 2929 0a0a  rbonTracker())..
+0001e560: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001e570: 7061 7261 6d65 7465 7273 5b22 7472 6163  parameters["trac
+0001e580: 6b5f 6578 7022 5d3a 0a20 2020 2020 2020  k_exp"]:.       
+0001e590: 2020 2020 2066 726f 6d20 636c 696e 6963       from clinic
+0001e5a0: 6164 6c2e 7574 696c 732e 6361 6c6c 6261  adl.utils.callba
+0001e5b0: 636b 732e 6361 6c6c 6261 636b 7320 696d  cks.callbacks im
+0001e5c0: 706f 7274 2054 7261 636b 6572 0a0a 2020  port Tracker..  
+0001e5d0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001e5e0: 616c 6c62 6163 6b5f 6861 6e64 6c65 722e  allback_handler.
+0001e5f0: 6164 645f 6361 6c6c 6261 636b 2854 7261  add_callback(Tra
+0001e600: 636b 6572 290a 0a20 2020 2020 2020 2073  cker)..        s
+0001e610: 656c 662e 6361 6c6c 6261 636b 5f68 616e  elf.callback_han
+0001e620: 646c 6572 2e61 6464 5f63 616c 6c62 6163  dler.add_callbac
+0001e630: 6b28 4c6f 6767 6572 4361 6c6c 6261 636b  k(LoggerCallback
+0001e640: 2829 290a 2020 2020 2020 2020 2320 7365  ()).        # se
+0001e650: 6c66 2e63 616c 6c62 6163 6b5f 6861 6e64  lf.callback_hand
+0001e660: 6c65 722e 6164 645f 6361 6c6c 6261 636b  ler.add_callback
+0001e670: 284d 6574 7269 6343 6f6e 736f 6c65 5072  (MetricConsolePr
+0001e680: 696e 7465 7243 616c 6c62 6163 6b28 2929  interCallback())
+0001e690: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0001e6a0: 2020 2020 6465 6620 7374 645f 616d 7028      def std_amp(
+0001e6b0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
+0001e6c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001e6d0: 2020 2052 6574 7572 6e73 2077 6865 7468     Returns wheth
+0001e6e0: 6572 206f 7220 6e6f 7420 7468 6520 7374  er or not the st
+0001e6f0: 616e 6461 7264 2050 7954 6f72 6368 2041  andard PyTorch A
+0001e700: 4d50 2073 686f 756c 6420 6265 2065 6e61  MP should be ena
+0001e710: 626c 6564 2e20 4974 2068 656c 7073 0a20  bled. It helps. 
+0001e720: 2020 2020 2020 2064 6973 7469 6e67 7569         distingui
+0001e730: 7368 696e 6720 7468 6520 6261 7365 2044  shing the base D
+0001e740: 4450 2077 6974 6820 414d 5020 616e 6420  DP with AMP and 
+0001e750: 7468 6520 7573 6167 6520 6f66 2046 5344  the usage of FSD
+0001e760: 5020 7769 7468 2041 4d50 2077 6869 6368  P with AMP which
+0001e770: 0a20 2020 2020 2020 2074 6865 6e20 6361  .        then ca
+0001e780: 6c6c 7320 7468 6520 696e 7465 726e 616c  lls the internal
+0001e790: 2046 5344 5020 414d 5020 6d65 6368 616e   FSDP AMP mechan
+0001e7a0: 6973 6d73 2e0a 2020 2020 2020 2020 2222  isms..        ""
+0001e7b0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0001e7c0: 2073 656c 662e 616d 7020 616e 6420 6e6f   self.amp and no
+0001e7d0: 7420 7365 6c66 2e66 756c 6c79 5f73 6861  t self.fully_sha
+0001e7e0: 7264 6564 5f64 6174 615f 7061 7261 6c6c  rded_data_parall
+0001e7f0: 656c 0a                                  el.
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/maps_manager/maps_manager_utils.py` & `clinicadl-1.6.1/clinicadl/utils/maps_manager/maps_manager_utils.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,31 +1,35 @@
 import json
 from pathlib import Path
 from typing import Any, Dict
 
 import toml
 
 from clinicadl.prepare_data.prepare_data_utils import compute_folder_and_file_type
+from clinicadl.utils.preprocessing import path_decoder, path_encoder
 
 
 def add_default_values(user_dict: Dict[str, Any]) -> Dict[str, Any]:
     """
     Updates the training parameters defined by the user with the default values in missing fields.
 
     Args:
         user_dict: dictionary of training parameters defined by the user.
 
     Returns:
         dictionary of values ready to use for the training process.
     """
     task = user_dict["network_task"]
     # read default values
-    clinicadl_root_dir = (Path(__file__) / "../../..").resolve()
+    clinicadl_root_dir = Path(__file__).parents[2]
     config_path = clinicadl_root_dir / "resources" / "config" / "train_config.toml"
+    # from clinicadl.utils.preprocessing import path_decoder
     config_dict = toml.load(config_path)
+    # config_dict = path_decoder(config_dict)
+    # print(config_dict)
 
     # task dependent
     config_dict = remove_unused_tasks(config_dict, task)
     # Check that TOML file has the same format as the one in resources
     for section_name in config_dict:
         for key in config_dict[section_name]:
             if key not in user_dict:  # Add value if not present in user_dict
@@ -33,57 +37,56 @@
 
     # Hard-coded options
     if user_dict["n_splits"] and user_dict["n_splits"] > 1:
         user_dict["validation"] = "KFoldSplit"
     else:
         user_dict["validation"] = "SingleSplit"
 
+    user_dict = path_decoder(user_dict)
     return user_dict
 
 
 def read_json(json_path: Path) -> Dict[str, Any]:
     """
     Ensures retro-compatibility between the different versions of ClinicaDL.
 
-    Args:
-        json_path: path to the JSON file summing the parameters of a MAPS.
+    Parameters
+    ----------
+    json_path: Path
+        path to the JSON file summing the parameters of a MAPS.
 
-    Returns:
-        dictionary of training parameters.
+    Returns
+    -------
+    A dictionary of training parameters.
     """
-    with json_path.open(mode="r") as f:
-        parameters = json.load(f)
+    from clinicadl.utils.preprocessing import path_decoder
 
+    with json_path.open(mode="r") as f:
+        parameters = json.load(f, object_hook=path_decoder)
     # Types of retro-compatibility
     # Change arg name: ex network --> model
     # Change arg value: ex for preprocessing: mni --> t1-extensive
     # New arg with default hard-coded value --> discarded_slice --> 20
     retro_change_name = {
         "model": "architecture",
         "multi": "multi_network",
         "minmaxnormalization": "normalize",
         "num_workers": "n_proc",
     }
-    retro_change_value = {
-        # "preprocessing": {"mni": "t1-extensive", "linear": "t1-linear"}
-    }
+
     retro_add = {
         "optimizer": "Adam",
         "loss": None,
     }
 
     for old_name, new_name in retro_change_name.items():
         if old_name in parameters:
             parameters[new_name] = parameters[old_name]
             del parameters[old_name]
 
-    for name, change_values in retro_change_value.items():
-        if parameters[name] in change_values:
-            parameters[name] = change_values[parameters[name]]
-
     for name, value in retro_add.items():
         if name not in parameters:
             parameters[name] = value
 
     # Value changes
     if "use_cpu" in parameters:
         parameters["gpu"] = not parameters["use_cpu"]
@@ -166,101 +169,7 @@
 
     # Delete all sections related to other tasks
     for other_task in task_list:
         if other_task.capitalize() in toml_dict:
             del toml_dict[other_task.capitalize()]
 
     return toml_dict
-
-
-def change_str_to_path(
-    toml_dict: Dict[str, Dict[str, Any]]
-) -> Dict[str, Dict[str, Any]]:
-    """
-    For all paths in the dictionnary, it changes the type from str to pathlib.Path.
-
-    Paramaters
-    ----------
-    toml_dict: Dict[str, Dict[str, Any]]
-        Dictionary of options as written in a TOML file, with type(path)=str
-
-    Returns
-    -------
-        Updated TOML dictionary with type(path)=pathlib.Path
-    """
-    for key, value in toml_dict.items():
-        if type(value) == Dict:
-            for key2, value2 in value.items():
-                if (
-                    key2.endswith("tsv")
-                    or key2.endswith("dir")
-                    or key2.endswith("directory")
-                    or key2.endswith("path")
-                    or key2.endswith("json")
-                    or key2.endswith("location")
-                ):
-                    if value2 == "":
-                        toml_dict[value][key2] = False
-                    else:
-                        toml_dict[value][key2] = Path(value2)
-        else:
-            if (
-                key.endswith("tsv")
-                or key.endswith("dir")
-                or key.endswith("directory")
-                or key.endswith("path")
-                or key.endswith("json")
-                or key.endswith("location")
-            ):
-                if value == "":
-                    toml_dict[key] = False
-                else:
-                    toml_dict[key] = Path(value)
-    return toml_dict
-
-
-def change_path_to_str(
-    toml_dict: Dict[str, Dict[str, Any]]
-) -> Dict[str, Dict[str, Any]]:
-    """
-    For all paths in the dictionnary, it changes the type from pathlib.Path to str.
-
-    Paramaters
-    ----------
-    toml_dict: Dict[str, Dict[str, Any]]
-        Dictionary of options as written in a TOML file, with type(path)=pathlib.Path
-
-    Returns
-    -------
-        Updated TOML dictionary with type(path)=str
-    """
-    for key, value in toml_dict.items():
-        if type(value) == Dict:
-            for key2, value2 in value.items():
-                if (
-                    key2.endswith("tsv")
-                    or key2.endswith("dir")
-                    or key2.endswith("directory")
-                    or key2.endswith("path")
-                    or key2.endswith("json")
-                    or key2.endswith("location")
-                ):
-                    if value2 == False:
-                        toml_dict[value][key2] = ""
-                    elif isinstance(value2, Path):
-                        toml_dict[value][key2] = value2.as_posix()
-        else:
-            if (
-                key.endswith("tsv")
-                or key.endswith("dir")
-                or key.endswith("directory")
-                or key.endswith("path")
-                or key.endswith("json")
-                or key.endswith("location")
-            ):
-                if value == False:
-                    toml_dict[key] = ""
-                elif isinstance(value, Path):
-                    toml_dict[key] = value.as_posix()
-        if isinstance(value, Path):
-            toml_dict[key] = value.as_posix()
-    return toml_dict
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/meta_maps/getter.py` & `clinicadl-1.6.1/clinicadl/utils/meta_maps/getter.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/metric_module.py` & `clinicadl-1.6.1/clinicadl/utils/metric_module.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/__init__.py` & `clinicadl-1.6.1/clinicadl/utils/network/__init__.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/autoencoder/cnn_transformer.py` & `clinicadl-1.6.1/clinicadl/utils/network/autoencoder/cnn_transformer.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/autoencoder/models.py` & `clinicadl-1.6.1/clinicadl/utils/network/autoencoder/models.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/cnn/SECNN.py` & `clinicadl-1.6.1/clinicadl/utils/network/cnn/SECNN.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/cnn/models.py` & `clinicadl-1.6.1/clinicadl/utils/network/cnn/models.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/cnn/random.py` & `clinicadl-1.6.1/clinicadl/utils/network/cnn/random.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/cnn/resnet.py` & `clinicadl-1.6.1/clinicadl/utils/network/cnn/resnet.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/cnn/resnet3D.py` & `clinicadl-1.6.1/clinicadl/utils/network/cnn/resnet3D.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/network.py` & `clinicadl-1.6.1/clinicadl/utils/network/network.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,9 @@
 import abc
 from logging import getLogger
-from typing import List
 
 import torch.cuda
 from torch import nn
 
 
 class Network(nn.Module):
     """Abstract Template for all networks used in ClinicaDL."""
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/network_utils.py` & `clinicadl-1.6.1/clinicadl/utils/network/network_utils.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/sub_network.py` & `clinicadl-1.6.1/clinicadl/utils/network/sub_network.py`

 * *Files 4% similar despite different names*

```diff
@@ -120,16 +120,17 @@
         x = self.convolutions(x)
         return self.fc(x)
 
     def predict(self, x):
         return self.forward(x)
 
     def compute_outputs_and_loss(self, input_dict, criterion, use_labels=True):
-        images, labels = input_dict["image"].to(self.device), input_dict["label"].to(
-            self.device
+        images, labels = (
+            input_dict["image"].to(self.device),
+            input_dict["label"].to(self.device),
         )
         train_output = self.forward(images)
         if use_labels:
             loss = criterion(train_output, labels)
         else:
             loss = torch.Tensor([0])
 
@@ -187,16 +188,17 @@
         x_domain = self.fc_domain(x_reverse)
         return x_class_source, x_class_target, x_domain
 
     def predict(self, x):
         return self.forward(x)
 
     def compute_outputs_and_loss_test(self, input_dict, criterion, alpha, target):
-        images, labels = input_dict["image"].to(self.device), input_dict["label"].to(
-            self.device
+        images, labels = (
+            input_dict["image"].to(self.device),
+            input_dict["label"].to(self.device),
         )
         train_output_source, train_output_target, _ = self.forward(images, alpha)
 
         if target:
             out = train_output_target
             loss_bce = criterion(train_output_target, labels)
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/unet/unet.py` & `clinicadl-1.6.1/clinicadl/utils/network/unet/unet.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/advanced_CVAE.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/advanced_CVAE.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/base_vae.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/base_vae.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/convolutional_VAE.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/convolutional_VAE.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,13 @@
-""" Credits to Benoit Sauty de Chalon @bsauty """
+"""Credits to Benoit Sauty de Chalon @bsauty"""
 
 import torch
 import torch.nn as nn
 import torch.nn.functional as F
 
-from clinicadl.utils.exceptions import ClinicaDLArgumentError
 from clinicadl.utils.network.network import Network
 from clinicadl.utils.network.vae.vae_utils import multiply_list
 
 
 class CVAE_3D(Network):
     """
     This is the convolutional autoencoder whose main objective is to project the MRI into a smaller space
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/vae_layers.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/vae_layers.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/vae_utils.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/vae_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -28,15 +28,15 @@
     log_constant = sumlogC(reconstruction)
     return kl_divergence, recon_error, log_constant
 
 
 def sumlogC(x, eps=1e-5):
     """
     Numerically stable implementation of
-    sum of logarithm of Continous Bernoulli
+    sum of logarithm of continuous Bernoulli
     constant C, using Taylor 2nd degree approximation
 
     Parameter
     ----------
     x : Tensor of dimensions (batch_size, dim)
         x takes values in (0,1)
     """
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/network/vae/vanilla_vae.py` & `clinicadl-1.6.1/clinicadl/utils/network/vae/vanilla_vae.py`

 * *Files 1% similar despite different names*

```diff
@@ -74,15 +74,15 @@
     @staticmethod
     def get_task():
         return ["reconstruction"]
 
 
 class VanillaSpatialVAE(BaseVAE):
     """
-    This network is a 3D convolutional variational autoencoder with a spacial latent space.
+    This network is a 3D convolutional variational autoencoder with a spatial latent space.
 
     reference: Diederik P Kingma et al., Auto-Encoding Variational Bayes.
     https://arxiv.org/abs/1312.6114
     """
 
     def __init__(
         self,
@@ -144,15 +144,15 @@
     @staticmethod
     def get_task():
         return ["reconstruction"]
 
 
 class Vanilla3DspacialVAE(BaseVAE):
     """
-    This network is a 3D convolutional variational autoencoder with a spacial latent space.
+    This network is a 3D convolutional variational autoencoder with a spatial latent space.
 
     reference: Diederik P Kingma et al., Auto-Encoding Variational Bayes.
     https://arxiv.org/abs/1312.6114
     """
 
     def __init__(
         self,
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/pytorch_ssim.py` & `clinicadl-1.6.1/clinicadl/utils/pytorch_ssim.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/seed.py` & `clinicadl-1.6.1/clinicadl/utils/seed.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/split_manager/kfold.py` & `clinicadl-1.6.1/clinicadl/utils/split_manager/kfold.py`

 * *Files 7% similar despite different names*

```diff
@@ -7,22 +7,24 @@
     def __init__(
         self,
         caps_directory,
         tsv_path,
         diagnoses,
         n_splits,
         baseline=False,
+        valid_longitudinal=False,
         multi_cohort=False,
         split_list=None,
     ):
         super().__init__(
             caps_directory,
             tsv_path,
             diagnoses,
             baseline,
+            valid_longitudinal,
             multi_cohort,
             split_list,
         )
         self.n_splits = n_splits
 
     def max_length(self) -> int:
         return self.n_splits
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/split_manager/single_split.py` & `clinicadl-1.6.1/clinicadl/utils/split_manager/single_split.py`

 * *Files 9% similar despite different names*

```diff
@@ -6,22 +6,24 @@
 class SingleSplit(SplitManager):
     def __init__(
         self,
         caps_directory,
         tsv_path,
         diagnoses,
         baseline=False,
+        valid_longitudinal=False,
         multi_cohort=False,
         split_list=None,
     ):
         super().__init__(
             caps_directory,
             tsv_path,
             diagnoses,
             baseline,
+            valid_longitudinal,
             multi_cohort,
             split_list,
         )
 
     def max_length(self) -> int:
         return 1
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/split_manager/split_manager.py` & `clinicadl-1.6.1/clinicadl/utils/split_manager/split_manager.py`

 * *Files 10% similar despite different names*

```diff
@@ -17,14 +17,15 @@
 class SplitManager:
     def __init__(
         self,
         caps_directory: Path,
         tsv_path: Path,
         diagnoses,
         baseline=False,
+        valid_longitudinal=False,
         multi_cohort=False,
         split_list=None,
     ):
         """
 
         Parameters
         ----------
@@ -32,24 +33,27 @@
             Path to the caps directory
         tsv_path: str
             Path to the tsv that is going to be split
         diagonoses: List[str]
             List of diagnosis
         baseline: bool
             if True, split only on baseline sessions
+        valid_longitudinal: bool
+            if True, split validation on longitudinal sessions
         multi-cohort: bool
         split_list: List[str]
 
         """
         self._check_tsv_path(tsv_path, multi_cohort)
         self.tsv_path = tsv_path
         self.caps_dict = self._create_caps_dict(caps_directory, multi_cohort)
         self.multi_cohort = multi_cohort
         self.diagnoses = diagnoses
         self.baseline = baseline
+        self.valid_longitudinal = valid_longitudinal
         self.split_list = split_list
 
     @abc.abstractmethod
     def max_length(self) -> int:
         """Maximum number of splits"""
         pass
 
@@ -134,25 +138,26 @@
         logger.debug(f"Validation data loaded at {valid_path}")
         if cohort_diagnoses is None:
             cohort_diagnoses = self.diagnoses
         if self.baseline:
             train_path = train_path / "train_baseline.tsv"
         else:
             train_path = train_path / "train.tsv"
-
-        valid_path = valid_path / "validation_baseline.tsv"
+        if self.valid_longitudinal:
+            valid_path = valid_path / "validation.tsv"
+        else:
+            valid_path = valid_path / "validation_baseline.tsv"
 
         train_df = pd.read_csv(train_path, sep="\t")
         valid_df = pd.read_csv(valid_path, sep="\t")
 
         list_columns = train_df.columns.values
 
         if (
-            "diagnosis"
-            not in list_columns
+            "diagnosis" not in list_columns
             # or "age" not in list_columns
             # or "sex" not in list_columns
         ):
             parents_path = train_path.resolve().parent
             while (
                 not (parents_path / "labels.tsv").is_file()
                 and ((parents_path / "kfold.json").is_file())
@@ -163,21 +168,20 @@
                 labels_df = pd.read_csv(parents_path / "labels.tsv", sep="\t")
                 train_df = pd.merge(
                     train_df,
                     labels_df,
                     how="inner",
                     on=["participant_id", "session_id"],
                 )
-            except:
+            except Exception:
                 pass
 
         list_columns = valid_df.columns.values
         if (
-            "diagnosis"
-            not in list_columns
+            "diagnosis" not in list_columns
             # or "age" not in list_columns
             # or "sex" not in list_columns
         ):
             parents_path = valid_path.resolve().parent
             while (
                 not (parents_path / "labels.tsv").is_file()
                 and ((parents_path / "kfold.json").is_file())
@@ -188,15 +192,15 @@
                 labels_df = pd.read_csv(parents_path / "labels.tsv", sep="\t")
                 valid_df = pd.merge(
                     valid_df,
                     labels_df,
                     how="inner",
                     on=["participant_id", "session_id"],
                 )
-            except:
+            except Exception:
                 pass
         train_df = train_df[
             train_df.diagnosis.isin(cohort_diagnoses)
         ]  # TO MODIFY with train
         valid_df = valid_df[valid_df.diagnosis.isin(cohort_diagnoses)]
 
         train_df.reset_index(inplace=True, drop=True)
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/task_manager/classification.py` & `clinicadl-1.6.1/clinicadl/utils/task_manager/classification.py`

 * *Files 2% similar despite different names*

```diff
@@ -5,17 +5,14 @@
 import torch
 from torch import nn
 from torch.nn.functional import softmax
 from torch.utils.data import sampler
 from torch.utils.data.distributed import DistributedSampler
 
 from clinicadl.utils.exceptions import ClinicaDLArgumentError
-
-logger = getLogger("clinicadl.task_manager")
-
 from clinicadl.utils.task_manager.task_manager import TaskManager
 
 logger = getLogger("clinicadl.task_manager")
 
 
 class ClassificationManager(TaskManager):
     def __init__(
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/task_manager/reconstruction.py` & `clinicadl-1.6.1/clinicadl/utils/task_manager/reconstruction.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/task_manager/regression.py` & `clinicadl-1.6.1/clinicadl/utils/task_manager/regression.py`

 * *Files identical despite different names*

### Comparing `clinicadl-1.6.0/clinicadl/utils/task_manager/task_manager.py` & `clinicadl-1.6.1/clinicadl/utils/task_manager/task_manager.py`

 * *Files 3% similar despite different names*

```diff
@@ -6,14 +6,15 @@
 import torch.distributed as dist
 from torch import Tensor
 from torch.cuda.amp import autocast
 from torch.nn.modules.loss import _Loss
 from torch.utils.data import DataLoader, Sampler
 
 from clinicadl.utils.caps_dataset.data import CapsDataset
+from clinicadl.utils.maps_manager.ddp import cluster
 from clinicadl.utils.metric_module import MetricModule
 from clinicadl.utils.network.network import Network
 
 
 # TODO: add function to check that the output size of the network corresponds to what is expected to
 #  perform the task
 class TaskManager:
@@ -182,22 +183,30 @@
         use_labels: bool = True,
         amp: bool = False,
         report_ci=False,
     ) -> Tuple[pd.DataFrame, Dict[str, float]]:
         """
         Computes the predictions and evaluation metrics.
 
-        Args:
-            model: the model trained.
-            dataloader: wrapper of a CapsDataset.
-            criterion: function to calculate the loss.
-            use_labels: If True the true_label will be written in output DataFrame
-                and metrics dict will be created.
-            amp: If True, enables Pytorch's automatic mixed precision.
-        Returns:
+        Parameters
+        ----------
+        model: Network
+            The model trained.
+        dataloader: DataLoader
+            Wrapper of a CapsDataset.
+        criterion:  _Loss
+            Function to calculate the loss.
+        use_labels: bool
+            If True the true_label will be written in output DataFrame
+            and metrics dict will be created.
+        amp: bool
+            If True, enables Pytorch's automatic mixed precision.
+
+        Returns
+        -------
             the results and metrics on the image level.
         """
         model.eval()
         dataloader.dataset.eval()
 
         results_df = pd.DataFrame(columns=self.columns)
         total_loss = {}
@@ -231,25 +240,25 @@
 
         if not use_labels:
             metrics_dict = None
         else:
             metrics_dict = self.compute_metrics(results_df, report_ci=report_ci)
             for loss_component in total_loss.keys():
                 dist.reduce(total_loss[loss_component], dst=0)
+                loss_value = total_loss[loss_component].item() / cluster.world_size
+
                 if report_ci:
                     metrics_dict["Metric_names"].append(loss_component)
-                    metrics_dict["Metric_values"].append(
-                        total_loss[loss_component].item()
-                    )
+                    metrics_dict["Metric_values"].append(loss_value)
                     metrics_dict["Lower_CI"].append("N/A")
                     metrics_dict["Upper_CI"].append("N/A")
                     metrics_dict["SE"].append("N/A")
 
                 else:
-                    metrics_dict[loss_component] = total_loss[loss_component].item()
+                    metrics_dict[loss_component] = loss_value
 
         torch.cuda.empty_cache()
 
         return results_df, metrics_dict
 
     def test_da(
         self,
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/tracking_exp.py` & `clinicadl-1.6.1/clinicadl/utils/tracking_exp.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""Training Callbacks for training monitoring integrated in `pythae` (inspired from 
+"""Training Callbacks for training monitoring integrated in `pythae` (inspired from
 https://github.com/huggingface/transformers/blob/master/src/transformers/trainer_callback.py)"""
 
 import importlib
 import logging
 from copy import copy
 from pathlib import Path
```

### Comparing `clinicadl-1.6.0/clinicadl/utils/tsvtools_utils.py` & `clinicadl-1.6.1/clinicadl/utils/tsvtools_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,23 +8,26 @@
 import pandas as pd
 
 from clinicadl.utils.exceptions import ClinicaDLTSVError
 
 logger = getLogger("clinicadl")
 
 
-def merged_tsv_reader(merged_tsv_path: Path):
+def merged_tsv_reader(merged_tsv_path: Path) -> pd.DataFrame:
     if not merged_tsv_path.is_file():
         raise ClinicaDLTSVError(f"{merged_tsv_path} file was not found. ")
+
     bids_df = pd.read_csv(merged_tsv_path, sep="\t")
 
-    for i in bids_df.index:
-        session = bids_df["session_id"][i]
-        if len(session) == 7:
-            bids_df.loc[(i), "session_id"] = session[:5] + "0" + session[5:7]
+    # To handle bids with 2 and 3 digits
+    bids_df["session_id"] = bids_df["session_id"].apply(
+        lambda session: (
+            session[:5] + "0" + session[5:7] if len(session) == 7 else session
+        )
+    )
 
     return bids_df
 
 
 def neighbour_session(session, session_list, neighbour):
     if session not in session_list:
         temp_list = session_list + [session]
@@ -81,27 +84,32 @@
         raise IndexError("The argument session is the last session")
 
 
 def extract_baseline(diagnosis_df, set_index=True):
     from copy import deepcopy
 
     if set_index:
-        all_df = diagnosis_df.set_index(["participant_id", "session_id"])
+        all_df = deepcopy(diagnosis_df)
+        all_df.set_index(["participant_id", "session_id"], inplace=True)
     else:
         all_df = deepcopy(diagnosis_df)
 
     result_df = pd.DataFrame()
     for subject, subject_df in all_df.groupby(level=0):
-        baseline = first_session(subject_df)
-        subject_baseline_df = pd.DataFrame(
-            data=[[subject, baseline] + subject_df.loc[(subject, baseline)].tolist()],
-            columns=["participant_id", "session_id"]
-            + subject_df.columns.values.tolist(),
-        )
-        result_df = pd.concat([result_df, subject_baseline_df])
+        if subject != "participant_id":
+            baseline = first_session(subject_df)
+
+            subject_baseline_df = pd.DataFrame(
+                data=[
+                    [subject, baseline] + subject_df.loc[(subject, baseline)].tolist()
+                ],
+                columns=["participant_id", "session_id"]
+                + subject_df.columns.values.tolist(),
+            )
+            result_df = pd.concat([result_df, subject_baseline_df])
 
     result_df.reset_index(inplace=True, drop=True)
     return result_df
 
 
 def chi2(x_test, x_train):
     from scipy.stats import chisquare
@@ -114,15 +122,15 @@
         (x_train == category).sum() / len(x_train) for category in unique_categories
     ]
     T, p = chisquare(f_obs, f_exp)
 
     return T, p
 
 
-def add_demographics(df, demographics_df, diagnosis):
+def add_demographics(df, demographics_df, diagnosis) -> pd.DataFrame:
     out_df = pd.DataFrame()
     tmp_demo_df = copy(demographics_df)
     tmp_demo_df.reset_index(inplace=True)
     for idx in df.index.values:
         participant = df.loc[idx, "participant_id"]
         session = df.loc[idx, "session_id"]
         row_df = tmp_demo_df[
@@ -215,19 +223,22 @@
     return diagnosis_df, supplementary_diagnoses
 
 
 def cleaning_nan_diagnoses(bids_df: pd.DataFrame) -> pd.DataFrame:
     """
     Printing the number of missing diagnoses and filling it partially for ADNI datasets
 
-    Args:
-        bids_df: DataFrame with columns including ['participant_id', 'session_id', 'diagnosis']
+    Parameters
+    ----------
+    bids_df: pd.DataFrame
+        DataFrame with columns including ['participant_id', 'session_id', 'diagnosis']
 
-    Returns:
-        cleaned DataFrame
+    Returns
+    -------
+    A cleaned DataFrame
     """
     bids_copy_df = copy(bids_df)
 
     # Look for the diagnosis in another column in ADNI
     if "adni_diagnosis_change" in bids_df.columns:
         change_dict = {
             1: "CN",
@@ -281,15 +292,15 @@
         Name of the tsv file
     results_path: str (path)
         Path to the folder
     df: DataFrame
         DataFrame you want to write in a TSV file.
         Columns must include ["participant_id", "session_id"].
     baseline: bool
-        If True, ther is only baseline session for each subject.
+        If True, there is only baseline session for each subject.
     """
 
     df.sort_values(by=["participant_id", "session_id"], inplace=True)
     if baseline:
         df.drop_duplicates(subset=["participant_id"], keep="first", inplace=True)
     else:
         df.drop_duplicates(
```

### Comparing `clinicadl-1.6.0/pyproject.toml` & `clinicadl-1.6.1/pyproject.toml`

 * *Files 16% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [tool.poetry]
 name = "clinicadl"
-version = "1.6.0"
+version = "1.6.1"
 description = "Framework for the reproducible processing of neuroimaging data with deep learning methods"
 license = "MIT"
 authors = ["ARAMIS Lab"]
 maintainers = ["Clinica developers <clinica-user@inria.fr>"]
 readme = "README.md"
 homepage = "https://clinicadl.readthedocs.io"
 repository = "https://github.com/aramis-lab/clinicadl.git"
@@ -42,16 +42,14 @@
 pynvml = "*"
 torchio = "^0.18.90"
 urllib3= "<2.0.0"
 nilearn = "^0.9.2"
 
 
 [tool.poetry.group.dev.dependencies]
-black = "*"
-isort = "*"
 pre-commit = "*"
 pytest = "*"
 pytest-timeout = "*"
 pytest-xdist = "*"
 pytest-cov = "^3.0.0"
 
 [tool.poetry.group.tracking]
@@ -72,42 +70,33 @@
 [tool.poetry.scripts]
 clinicadl = "clinicadl.cmdline:cli"
 
 [build-system]
 requires = ["poetry-core>=1.0.0"]
 build-backend = "poetry.core.masonry.api"
 
-[tool.black]
+[tool.ruff]
+target-version = "py38"
 line-length = 88
-target-version = ['py36', 'py37', 'py38']
-include = '\.pyi?$'
-force-exclude = '''
-/(
-    \.eggs
-  | \.git
-  | \.hg
-  | \.mypy_cache
-  | \.tox
-  | \.venv
-  | \.pytest_cache
-  | _build
-  | buck-out
-  | build
-  | dist
-  | docs
-  | README.md
-  | MANIFEST.in
-  | LICENSE.txt
-  | clinicadl/VERSION
-)/
-'''
-exclude = '''
-/(
-    README.md
-  | MANIFEST.in
-  | LICENSE.txt
-  | clinicadl/VERSION
-)/
-'''
 
-[tool.isort]
-profile = "black"
+[tool.ruff.lint]
+select = [
+    "E",
+    "W",
+    "I",
+]
+ignore = ["E203", "E501"]
+
+[tool.ruff.lint.isort]
+known-first-party = ["clinicadl"]
+
+[tool.ruff.format]
+quote-style = "double"
+indent-style = "space"
+skip-magic-trailing-comma = false
+line-ending = "auto"
+
+[tool.codespell]
+summary = ''
+skip = ".git,LICENSE.txt,*.m,clinicadl/resources/config/train_config.toml"
+quiet-level = 3
+ignore-words-list = "nd,fwe,commun,fo,te,artic,ressources"
```

### Comparing `clinicadl-1.6.0/PKG-INFO` & `clinicadl-1.6.1/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: clinicadl
-Version: 1.6.0
+Version: 1.6.1
 Summary: Framework for the reproducible processing of neuroimaging data with deep learning methods
 Home-page: https://clinicadl.readthedocs.io
 License: MIT
 Keywords: bids,image processing,deep learning,neuroimaging,neuroscience
 Author: ARAMIS Lab
 Maintainer: Clinica developers
 Maintainer-email: clinica-user@inria.fr
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: clinicadl Version: 1.6.0 Summary: Framework for the
+Metadata-Version: 2.1 Name: clinicadl Version: 1.6.1 Summary: Framework for the
 reproducible processing of neuroimaging data with deep learning methods Home-
 page: https://clinicadl.readthedocs.io License: MIT Keywords: bids,image
 processing,deep learning,neuroimaging,neuroscience Author: ARAMIS Lab
 Maintainer: Clinica developers Maintainer-email: clinica-user@inria.fr
 Requires-Python: >=3.8,<3.12 Classifier: Development Status :: 4 - Beta
 Classifier: Environment :: Console Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: End Users/Desktop Classifier: License :: OSI
```

